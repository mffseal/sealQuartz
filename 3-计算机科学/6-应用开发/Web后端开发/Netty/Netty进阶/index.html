<!doctype html><html lang=cn><head><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8920808282451934" crossorigin=anonymous></script><div id=cursor-chat-layer><input type=text id=cursor-chat-box></div><script src=https://unpkg.com/cursor-chat></script>
<link rel=stylesheet type=text/css href=https://unpkg.com/cursor-chat/dist/style.css><meta name=baidu-site-verification content="codeva-qMAjqdfVJc"><meta charset=utf-8><meta name=description content="Netty进阶 1. 粘包与半包 1.1 粘包现象 服务端代码
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46  public class HelloWorldServer { static final Logger log = LoggerFactory."><title>Netty进阶</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://harbor.mffseal.top//icon.png><link href=https://harbor.mffseal.top/styles.73cf69c3fd63eaf27dde453f5aa109f7.min.css rel=stylesheet><link href=https://harbor.mffseal.top/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://harbor.mffseal.top/js/darkmode.9841b88d44c115f7419d485ee72d23a2.min.js></script>
<script src=https://harbor.mffseal.top/js/util.9825137f5e7825e8553c68ce39ac9e44.min.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js integrity=sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A crossorigin=anonymous></script>
<script src=https://unpkg.com/@floating-ui/core@0.7.3></script>
<script src=https://unpkg.com/@floating-ui/dom@0.5.4></script>
<script src=https://harbor.mffseal.top/js/popover.53ad9a087e3feeaaa12b63bfd02d923b.min.js></script>
<script src=https://harbor.mffseal.top/js/code-title.b35124ad8db0ba37162b886afb711cbc.min.js></script>
<script src=https://harbor.mffseal.top/js/clipboard.c20857734e53a3fb733b7443879efa61.min.js></script>
<script src=https://harbor.mffseal.top/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const BASE_URL="https://harbor.mffseal.top/",fetchData=Promise.all([fetch("https://harbor.mffseal.top/indices/linkIndex.3d2d03102eda393ed53f6fd9593533e0.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://harbor.mffseal.top/indices/contentIndex.4d3a05c4c5c32394f6cde27b202efda0.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addTitleToCodeBlocks(),addCollapsibleCallouts(),initPopover("https://harbor.mffseal.top",!0,!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!0;drawGraph("https://harbor.mffseal.top",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],macros:{'’':"'"},throwOnError:!1})}</script><script type=module>
    import { attachSPARouting } from "https:\/\/harbor.mffseal.top\/js\/router.9d4974281069e9ebb189f642ae1e3ca2.min.js"
    attachSPARouting(init, render)
  </script></head><script async src="https://www.googletagmanager.com/gtag/js?id=G-NV58SYWRZD"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-NV58SYWRZD",{anonymize_ip:!1})}</script><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=搜索 placeholder=搜一搜...><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://harbor.mffseal.top/js/full-text-search.24827f874defbbc6d529926cbfcfb493.min.js></script><div class=singlePage><header><h1 id=page-title><a href=https://harbor.mffseal.top/>🦭 港湾</a></h1><div class=spacer></div><div id=search-icon><p>搜索</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">搜索图标</title><desc id="desc">打开搜索图标</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>亮色</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>暗色</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><h1>Netty进阶</h1><p class=meta>最后更新
Sep 18, 2022
<a href="obsidian://open?vault=content&file=3-%e8%ae%a1%e7%ae%97%e6%9c%ba%e7%a7%91%e5%ad%a6%2f6-%e5%ba%94%e7%94%a8%e5%bc%80%e5%8f%91%2fWeb%e5%90%8e%e7%ab%af%e5%bc%80%e5%8f%91%2fNetty%2fNetty%e8%bf%9b%e9%98%b6.md" rel=noopener>编辑源</a></p><ul class=tags><li><a href=https://harbor.mffseal.top/tags/article/>Article</a></li></ul><div class=toc-wrapper><div class=mainTOC id=mainTOC><aside><header><h3>Netty进阶</h3></header><nav id=TableOfContents><ol><li><a href=#1-粘包与半包>1. 粘包与半包</a><ol><li><a href=#11-粘包现象>1.1 粘包现象</a></li><li><a href=#12-半包现象>1.2 半包现象</a></li><li><a href=#13-现象分析>💡1.3 现象分析</a></li><li><a href=#14-解决方案>1.4 💡解决方案</a></li></ol></li><li><a href=#2-协议设计与解析>2. 协议设计与解析</a><ol><li><a href=#21-为什么需要协议>2.1 为什么需要协议？</a></li><li><a href=#22-redis-协议举例>2.2 redis 协议举例</a></li><li><a href=#23-http-协议举例>2.3 http 协议举例</a></li><li><a href=#24-自定义协议要素>2.4 自定义协议要素</a></li></ol></li><li><a href=#3-聊天室案例>3. 聊天室案例</a><ol><li><a href=#31-聊天室业务介绍>3.1 聊天室业务介绍</a></li><li><a href=#32-聊天室业务-登录>3.2 聊天室业务-登录</a></li><li><a href=#33-聊天室业务-单聊>3.3 聊天室业务-单聊</a></li><li><a href=#34-聊天室业务-群聊>3.4 聊天室业务-群聊</a></li><li><a href=#35-聊天室业务-退出>3.5 聊天室业务-退出</a></li><li><a href=#36-聊天室业务-空闲检测>3.6 聊天室业务-空闲检测</a></li></ol></li></ol></nav></aside><a href=# id=toc-toggle></a></div></div><a href=#netty进阶><h1 id=netty进阶><span class=hanchor arialabel=Anchor># </span>Netty进阶</h1></a><a href=#1-粘包与半包><h2 id=1-粘包与半包><span class=hanchor arialabel=Anchor># </span>1. 粘包与半包</h2></a><a href=#11-粘包现象><h3 id=11-粘包现象><span class=hanchor arialabel=Anchor># </span>1.1 粘包现象</h3></a><p>服务端代码</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-0-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-1> 1</a>
</span><span class=lnt id=hl-0-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-2> 2</a>
</span><span class=lnt id=hl-0-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-3> 3</a>
</span><span class=lnt id=hl-0-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-4> 4</a>
</span><span class=lnt id=hl-0-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-5> 5</a>
</span><span class=lnt id=hl-0-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-6> 6</a>
</span><span class=lnt id=hl-0-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-7> 7</a>
</span><span class=lnt id=hl-0-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-8> 8</a>
</span><span class=lnt id=hl-0-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-9> 9</a>
</span><span class=lnt id=hl-0-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-10>10</a>
</span><span class=lnt id=hl-0-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-11>11</a>
</span><span class=lnt id=hl-0-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-12>12</a>
</span><span class=lnt id=hl-0-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-13>13</a>
</span><span class=lnt id=hl-0-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-14>14</a>
</span><span class=lnt id=hl-0-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-15>15</a>
</span><span class=lnt id=hl-0-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-16>16</a>
</span><span class=lnt id=hl-0-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-17>17</a>
</span><span class=lnt id=hl-0-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-18>18</a>
</span><span class=lnt id=hl-0-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-19>19</a>
</span><span class=lnt id=hl-0-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-20>20</a>
</span><span class=lnt id=hl-0-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-21>21</a>
</span><span class=lnt id=hl-0-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-22>22</a>
</span><span class=lnt id=hl-0-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-23>23</a>
</span><span class=lnt id=hl-0-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-24>24</a>
</span><span class=lnt id=hl-0-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-25>25</a>
</span><span class=lnt id=hl-0-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-26>26</a>
</span><span class=lnt id=hl-0-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-27>27</a>
</span><span class=lnt id=hl-0-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-28>28</a>
</span><span class=lnt id=hl-0-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-29>29</a>
</span><span class=lnt id=hl-0-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-30>30</a>
</span><span class=lnt id=hl-0-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-31>31</a>
</span><span class=lnt id=hl-0-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-32>32</a>
</span><span class=lnt id=hl-0-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-33>33</a>
</span><span class=lnt id=hl-0-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-34>34</a>
</span><span class=lnt id=hl-0-35><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-35>35</a>
</span><span class=lnt id=hl-0-36><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-36>36</a>
</span><span class=lnt id=hl-0-37><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-37>37</a>
</span><span class=lnt id=hl-0-38><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-38>38</a>
</span><span class=lnt id=hl-0-39><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-39>39</a>
</span><span class=lnt id=hl-0-40><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-40>40</a>
</span><span class=lnt id=hl-0-41><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-41>41</a>
</span><span class=lnt id=hl-0-42><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-42>42</a>
</span><span class=lnt id=hl-0-43><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-43>43</a>
</span><span class=lnt id=hl-0-44><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-44>44</a>
</span><span class=lnt id=hl-0-45><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-45>45</a>
</span><span class=lnt id=hl-0-46><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-46>46</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>HelloWorldServer</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>static</span> <span class=kd>final</span> <span class=n>Logger</span> <span class=n>log</span> <span class=o>=</span> <span class=n>LoggerFactory</span><span class=o>.</span><span class=na>getLogger</span><span class=o>(</span><span class=n>HelloWorldServer</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=nf>start</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>NioEventLoopGroup</span> <span class=n>boss</span> <span class=o>=</span> <span class=k>new</span> <span class=n>NioEventLoopGroup</span><span class=o>(</span><span class=n>1</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>NioEventLoopGroup</span> <span class=n>worker</span> <span class=o>=</span> <span class=k>new</span> <span class=n>NioEventLoopGroup</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>ServerBootstrap</span> <span class=n>serverBootstrap</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ServerBootstrap</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>serverBootstrap</span><span class=o>.</span><span class=na>channel</span><span class=o>(</span><span class=n>NioServerSocketChannel</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>serverBootstrap</span><span class=o>.</span><span class=na>group</span><span class=o>(</span><span class=n>boss</span><span class=o>,</span> <span class=n>worker</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>serverBootstrap</span><span class=o>.</span><span class=na>childHandler</span><span class=o>(</span><span class=k>new</span> <span class=n>ChannelInitializer</span><span class=o>&lt;</span><span class=n>SocketChannel</span><span class=o>&gt;()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>                <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>initChannel</span><span class=o>(</span><span class=n>SocketChannel</span> <span class=n>ch</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>LoggingHandler</span><span class=o>(</span><span class=n>LogLevel</span><span class=o>.</span><span class=na>DEBUG</span><span class=o>));</span>
</span></span><span class=line><span class=cl>                    <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>ChannelInboundHandlerAdapter</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>                        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>channelActive</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                            <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;connected {}&#34;</span><span class=o>,</span> <span class=n>ctx</span><span class=o>.</span><span class=na>channel</span><span class=o>());</span>
</span></span><span class=line><span class=cl>                            <span class=kd>super</span><span class=o>.</span><span class=na>channelActive</span><span class=o>(</span><span class=n>ctx</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>                        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>channelInactive</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                            <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;disconnect {}&#34;</span><span class=o>,</span> <span class=n>ctx</span><span class=o>.</span><span class=na>channel</span><span class=o>());</span>
</span></span><span class=line><span class=cl>                            <span class=kd>super</span><span class=o>.</span><span class=na>channelInactive</span><span class=o>(</span><span class=n>ctx</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                        <span class=o>}</span>
</span></span><span class=line><span class=cl>                    <span class=o>});</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>});</span>
</span></span><span class=line><span class=cl>            <span class=n>ChannelFuture</span> <span class=n>channelFuture</span> <span class=o>=</span> <span class=n>serverBootstrap</span><span class=o>.</span><span class=na>bind</span><span class=o>(</span><span class=n>8080</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;{} binding...&#34;</span><span class=o>,</span> <span class=n>channelFuture</span><span class=o>.</span><span class=na>channel</span><span class=o>());</span>
</span></span><span class=line><span class=cl>            <span class=n>channelFuture</span><span class=o>.</span><span class=na>sync</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;{} bound...&#34;</span><span class=o>,</span> <span class=n>channelFuture</span><span class=o>.</span><span class=na>channel</span><span class=o>());</span>
</span></span><span class=line><span class=cl>            <span class=n>channelFuture</span><span class=o>.</span><span class=na>channel</span><span class=o>().</span><span class=na>closeFuture</span><span class=o>().</span><span class=na>sync</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=o>.</span><span class=na>error</span><span class=o>(</span><span class=s>&#34;server error&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>boss</span><span class=o>.</span><span class=na>shutdownGracefully</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>worker</span><span class=o>.</span><span class=na>shutdownGracefully</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;stoped&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=n>HelloWorldServer</span><span class=o>().</span><span class=na>start</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>客户端代码希望发送 10 个消息，每个消息是 16 字节</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-1-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-1> 1</a>
</span><span class=lnt id=hl-1-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-2> 2</a>
</span><span class=lnt id=hl-1-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-3> 3</a>
</span><span class=lnt id=hl-1-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-4> 4</a>
</span><span class=lnt id=hl-1-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-5> 5</a>
</span><span class=lnt id=hl-1-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-6> 6</a>
</span><span class=lnt id=hl-1-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-7> 7</a>
</span><span class=lnt id=hl-1-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-8> 8</a>
</span><span class=lnt id=hl-1-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-9> 9</a>
</span><span class=lnt id=hl-1-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-10>10</a>
</span><span class=lnt id=hl-1-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-11>11</a>
</span><span class=lnt id=hl-1-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-12>12</a>
</span><span class=lnt id=hl-1-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-13>13</a>
</span><span class=lnt id=hl-1-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-14>14</a>
</span><span class=lnt id=hl-1-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-15>15</a>
</span><span class=lnt id=hl-1-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-16>16</a>
</span><span class=lnt id=hl-1-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-17>17</a>
</span><span class=lnt id=hl-1-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-18>18</a>
</span><span class=lnt id=hl-1-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-19>19</a>
</span><span class=lnt id=hl-1-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-20>20</a>
</span><span class=lnt id=hl-1-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-21>21</a>
</span><span class=lnt id=hl-1-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-22>22</a>
</span><span class=lnt id=hl-1-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-23>23</a>
</span><span class=lnt id=hl-1-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-24>24</a>
</span><span class=lnt id=hl-1-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-25>25</a>
</span><span class=lnt id=hl-1-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-26>26</a>
</span><span class=lnt id=hl-1-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-27>27</a>
</span><span class=lnt id=hl-1-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-28>28</a>
</span><span class=lnt id=hl-1-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-29>29</a>
</span><span class=lnt id=hl-1-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-30>30</a>
</span><span class=lnt id=hl-1-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-31>31</a>
</span><span class=lnt id=hl-1-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-32>32</a>
</span><span class=lnt id=hl-1-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-33>33</a>
</span><span class=lnt id=hl-1-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-34>34</a>
</span><span class=lnt id=hl-1-35><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-35>35</a>
</span><span class=lnt id=hl-1-36><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-36>36</a>
</span><span class=lnt id=hl-1-37><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-37>37</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>HelloWorldClient</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>static</span> <span class=kd>final</span> <span class=n>Logger</span> <span class=n>log</span> <span class=o>=</span> <span class=n>LoggerFactory</span><span class=o>.</span><span class=na>getLogger</span><span class=o>(</span><span class=n>HelloWorldClient</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>NioEventLoopGroup</span> <span class=n>worker</span> <span class=o>=</span> <span class=k>new</span> <span class=n>NioEventLoopGroup</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Bootstrap</span> <span class=n>bootstrap</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Bootstrap</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>bootstrap</span><span class=o>.</span><span class=na>channel</span><span class=o>(</span><span class=n>NioSocketChannel</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>bootstrap</span><span class=o>.</span><span class=na>group</span><span class=o>(</span><span class=n>worker</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>bootstrap</span><span class=o>.</span><span class=na>handler</span><span class=o>(</span><span class=k>new</span> <span class=n>ChannelInitializer</span><span class=o>&lt;</span><span class=n>SocketChannel</span><span class=o>&gt;()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>                <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>initChannel</span><span class=o>(</span><span class=n>SocketChannel</span> <span class=n>ch</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;connetted...&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>ChannelInboundHandlerAdapter</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>                        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>channelActive</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                            <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;sending...&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                            <span class=n>Random</span> <span class=n>r</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Random</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                            <span class=kt>char</span> <span class=n>c</span> <span class=o>=</span> <span class=sc>&#39;a&#39;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                            <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>10</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                                <span class=n>ByteBuf</span> <span class=n>buffer</span> <span class=o>=</span> <span class=n>ctx</span><span class=o>.</span><span class=na>alloc</span><span class=o>().</span><span class=na>buffer</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                                <span class=n>buffer</span><span class=o>.</span><span class=na>writeBytes</span><span class=o>(</span><span class=k>new</span> <span class=kt>byte</span><span class=o>[]{</span><span class=n>0</span><span class=o>,</span> <span class=n>1</span><span class=o>,</span> <span class=n>2</span><span class=o>,</span> <span class=n>3</span><span class=o>,</span> <span class=n>4</span><span class=o>,</span> <span class=n>5</span><span class=o>,</span> <span class=n>6</span><span class=o>,</span> <span class=n>7</span><span class=o>,</span> <span class=n>8</span><span class=o>,</span> <span class=n>9</span><span class=o>,</span> <span class=n>10</span><span class=o>,</span> <span class=n>11</span><span class=o>,</span> <span class=n>12</span><span class=o>,</span> <span class=n>13</span><span class=o>,</span> <span class=n>14</span><span class=o>,</span> <span class=n>15</span><span class=o>});</span>
</span></span><span class=line><span class=cl>                                <span class=n>ctx</span><span class=o>.</span><span class=na>writeAndFlush</span><span class=o>(</span><span class=n>buffer</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                            <span class=o>}</span>
</span></span><span class=line><span class=cl>                        <span class=o>}</span>
</span></span><span class=line><span class=cl>                    <span class=o>});</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>});</span>
</span></span><span class=line><span class=cl>            <span class=n>ChannelFuture</span> <span class=n>channelFuture</span> <span class=o>=</span> <span class=n>bootstrap</span><span class=o>.</span><span class=na>connect</span><span class=o>(</span><span class=s>&#34;127.0.0.1&#34;</span><span class=o>,</span> <span class=n>8080</span><span class=o>).</span><span class=na>sync</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>channelFuture</span><span class=o>.</span><span class=na>channel</span><span class=o>().</span><span class=na>closeFuture</span><span class=o>().</span><span class=na>sync</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=o>.</span><span class=na>error</span><span class=o>(</span><span class=s>&#34;client error&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>worker</span><span class=o>.</span><span class=na>shutdownGracefully</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>服务器端的某次输出，可以看到一次就接收了 160 个字节，而非分 10 次接收</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-2-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-1> 1</a>
</span><span class=lnt id=hl-2-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-2> 2</a>
</span><span class=lnt id=hl-2-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-3> 3</a>
</span><span class=lnt id=hl-2-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-4> 4</a>
</span><span class=lnt id=hl-2-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-5> 5</a>
</span><span class=lnt id=hl-2-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-6> 6</a>
</span><span class=lnt id=hl-2-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-7> 7</a>
</span><span class=lnt id=hl-2-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-8> 8</a>
</span><span class=lnt id=hl-2-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-9> 9</a>
</span><span class=lnt id=hl-2-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-10>10</a>
</span><span class=lnt id=hl-2-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-11>11</a>
</span><span class=lnt id=hl-2-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-12>12</a>
</span><span class=lnt id=hl-2-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-13>13</a>
</span><span class=lnt id=hl-2-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-14>14</a>
</span><span class=lnt id=hl-2-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-15>15</a>
</span><span class=lnt id=hl-2-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-16>16</a>
</span><span class=lnt id=hl-2-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-17>17</a>
</span><span class=lnt id=hl-2-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-18>18</a>
</span><span class=lnt id=hl-2-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-19>19</a>
</span><span class=lnt id=hl-2-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-20>20</a>
</span><span class=lnt id=hl-2-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-21>21</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>08:24:46 [DEBUG] [main] c.i.n.HelloWorldServer - [id: 0x81e0fda5] binding...
</span></span><span class=line><span class=cl>08:24:46 [DEBUG] [main] c.i.n.HelloWorldServer - [id: 0x81e0fda5, L:/0:0:0:0:0:0:0:0:8080] bound...
</span></span><span class=line><span class=cl>08:24:55 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x94132411, L:/127.0.0.1:8080 - R:/127.0.0.1:58177] REGISTERED
</span></span><span class=line><span class=cl>08:24:55 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x94132411, L:/127.0.0.1:8080 - R:/127.0.0.1:58177] ACTIVE
</span></span><span class=line><span class=cl>08:24:55 [DEBUG] [nioEventLoopGroup-3-1] c.i.n.HelloWorldServer - connected [id: 0x94132411, L:/127.0.0.1:8080 - R:/127.0.0.1:58177]
</span></span><span class=line><span class=cl>08:24:55 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x94132411, L:/127.0.0.1:8080 - R:/127.0.0.1:58177] READ: 160B
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f |................|
</span></span><span class=line><span class=cl>|00000010| 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f |................|
</span></span><span class=line><span class=cl>|00000020| 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f |................|
</span></span><span class=line><span class=cl>|00000030| 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f |................|
</span></span><span class=line><span class=cl>|00000040| 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f |................|
</span></span><span class=line><span class=cl>|00000050| 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f |................|
</span></span><span class=line><span class=cl>|00000060| 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f |................|
</span></span><span class=line><span class=cl>|00000070| 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f |................|
</span></span><span class=line><span class=cl>|00000080| 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f |................|
</span></span><span class=line><span class=cl>|00000090| 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f |................|
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>08:24:55 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x94132411, L:/127.0.0.1:8080 - R:/127.0.0.1:58177] READ COMPLETE
</span></span></code></pre></td></tr></table></div></div><a href=#12-半包现象><h3 id=12-半包现象><span class=hanchor arialabel=Anchor># </span>1.2 半包现象</h3></a><p>客户端代码希望发送 1 个消息，这个消息是 160 字节，代码改为</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-3-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-1>1</a>
</span><span class=lnt id=hl-3-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-2>2</a>
</span><span class=lnt id=hl-3-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-3>3</a>
</span><span class=lnt id=hl-3-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-4>4</a>
</span><span class=lnt id=hl-3-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>ByteBuf</span> <span class=n>buffer</span> <span class=o>=</span> <span class=n>ctx</span><span class=o>.</span><span class=na>alloc</span><span class=o>().</span><span class=na>buffer</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>10</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>buffer</span><span class=o>.</span><span class=na>writeBytes</span><span class=o>(</span><span class=k>new</span> <span class=kt>byte</span><span class=o>[]{</span><span class=n>0</span><span class=o>,</span> <span class=n>1</span><span class=o>,</span> <span class=n>2</span><span class=o>,</span> <span class=n>3</span><span class=o>,</span> <span class=n>4</span><span class=o>,</span> <span class=n>5</span><span class=o>,</span> <span class=n>6</span><span class=o>,</span> <span class=n>7</span><span class=o>,</span> <span class=n>8</span><span class=o>,</span> <span class=n>9</span><span class=o>,</span> <span class=n>10</span><span class=o>,</span> <span class=n>11</span><span class=o>,</span> <span class=n>12</span><span class=o>,</span> <span class=n>13</span><span class=o>,</span> <span class=n>14</span><span class=o>,</span> <span class=n>15</span><span class=o>});</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl><span class=n>ctx</span><span class=o>.</span><span class=na>writeAndFlush</span><span class=o>(</span><span class=n>buffer</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><p>为现象明显，服务端修改一下接收缓冲区，其它代码不变</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-4-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>serverBootstrap</span><span class=o>.</span><span class=na>option</span><span class=o>(</span><span class=n>ChannelOption</span><span class=o>.</span><span class=na>SO_RCVBUF</span><span class=o>,</span> <span class=n>10</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><p>服务器端的某次输出，可以看到接收的消息被分为两节，第一次 20 字节，第二次 140 字节</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-5-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-1> 1</a>
</span><span class=lnt id=hl-5-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-2> 2</a>
</span><span class=lnt id=hl-5-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-3> 3</a>
</span><span class=lnt id=hl-5-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-4> 4</a>
</span><span class=lnt id=hl-5-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-5> 5</a>
</span><span class=lnt id=hl-5-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-6> 6</a>
</span><span class=lnt id=hl-5-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-7> 7</a>
</span><span class=lnt id=hl-5-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-8> 8</a>
</span><span class=lnt id=hl-5-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-9> 9</a>
</span><span class=lnt id=hl-5-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-10>10</a>
</span><span class=lnt id=hl-5-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-11>11</a>
</span><span class=lnt id=hl-5-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-12>12</a>
</span><span class=lnt id=hl-5-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-13>13</a>
</span><span class=lnt id=hl-5-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-14>14</a>
</span><span class=lnt id=hl-5-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-15>15</a>
</span><span class=lnt id=hl-5-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-16>16</a>
</span><span class=lnt id=hl-5-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-17>17</a>
</span><span class=lnt id=hl-5-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-18>18</a>
</span><span class=lnt id=hl-5-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-19>19</a>
</span><span class=lnt id=hl-5-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-20>20</a>
</span><span class=lnt id=hl-5-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-21>21</a>
</span><span class=lnt id=hl-5-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-22>22</a>
</span><span class=lnt id=hl-5-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-23>23</a>
</span><span class=lnt id=hl-5-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-24>24</a>
</span><span class=lnt id=hl-5-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-25>25</a>
</span><span class=lnt id=hl-5-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-26>26</a>
</span><span class=lnt id=hl-5-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-27>27</a>
</span><span class=lnt id=hl-5-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-28>28</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>08:43:49 [DEBUG] [main] c.i.n.HelloWorldServer - [id: 0x4d6c6a84] binding...
</span></span><span class=line><span class=cl>08:43:49 [DEBUG] [main] c.i.n.HelloWorldServer - [id: 0x4d6c6a84, L:/0:0:0:0:0:0:0:0:8080] bound...
</span></span><span class=line><span class=cl>08:44:23 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x1719abf7, L:/127.0.0.1:8080 - R:/127.0.0.1:59221] REGISTERED
</span></span><span class=line><span class=cl>08:44:23 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x1719abf7, L:/127.0.0.1:8080 - R:/127.0.0.1:59221] ACTIVE
</span></span><span class=line><span class=cl>08:44:23 [DEBUG] [nioEventLoopGroup-3-1] c.i.n.HelloWorldServer - connected [id: 0x1719abf7, L:/127.0.0.1:8080 - R:/127.0.0.1:59221]
</span></span><span class=line><span class=cl>08:44:24 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x1719abf7, L:/127.0.0.1:8080 - R:/127.0.0.1:59221] READ: 20B
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f |................|
</span></span><span class=line><span class=cl>|00000010| 00 01 02 03                                     |....            |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>08:44:24 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x1719abf7, L:/127.0.0.1:8080 - R:/127.0.0.1:59221] READ COMPLETE
</span></span><span class=line><span class=cl>08:44:24 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x1719abf7, L:/127.0.0.1:8080 - R:/127.0.0.1:59221] READ: 140B
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f 00 01 02 03 |................|
</span></span><span class=line><span class=cl>|00000010| 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f 00 01 02 03 |................|
</span></span><span class=line><span class=cl>|00000020| 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f 00 01 02 03 |................|
</span></span><span class=line><span class=cl>|00000030| 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f 00 01 02 03 |................|
</span></span><span class=line><span class=cl>|00000040| 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f 00 01 02 03 |................|
</span></span><span class=line><span class=cl>|00000050| 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f 00 01 02 03 |................|
</span></span><span class=line><span class=cl>|00000060| 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f 00 01 02 03 |................|
</span></span><span class=line><span class=cl>|00000070| 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f 00 01 02 03 |................|
</span></span><span class=line><span class=cl>|00000080| 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f             |............    |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>08:44:24 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x1719abf7, L:/127.0.0.1:8080 - R:/127.0.0.1:59221] READ COMPLETE
</span></span></code></pre></td></tr></table></div></div><blockquote><p><strong>注意</strong></p><p>serverBootstrap.option(ChannelOption.SO_RCVBUF, 10) 影响的底层接收缓冲区（即滑动窗口）大小，仅决定了 netty 读取的最小单位，netty 实际每次读取的一般是它的整数倍</p></blockquote><a href=#13-现象分析><h3 id=13-现象分析><span class=hanchor arialabel=Anchor># </span>💡1.3 现象分析</h3></a><blockquote><p>总原因：TCP消息没有边界。</p></blockquote><a href=#粘包><h4 id=粘包><span class=hanchor arialabel=Anchor># </span>粘包</h4></a><ul><li>现象，发送 abc def，接收 abcdef</li><li>原因<ul><li><strong>应用层</strong>：接收方 ByteBuf 设置太大（Netty 默认 1024）</li><li><strong>传输层</strong>：TCP：滑动窗口：假设发送方 256 bytes 表示一个完整报文，但由于接收方处理不及时且窗口大小足够大，这 256 bytes 字节就会缓冲在接收方的滑动窗口中，当滑动窗口中缓冲了多个报文就会粘包</li><li><strong>传输层</strong>：TCP：Nagle 算法：会造成粘包</li></ul></li></ul><blockquote><p>Nagle 算法</p><ul><li>糊涂窗口综合征：即使发送1个字节，也需要加入 tcp 头和 ip 头，也就是总字节数会使用 41 bytes（TCP20+IP20+数据1），非常不经济。因此为了提高网络利用率，tcp 希望<strong>尽可能发送足够大的数据</strong>，这就是 Nagle 算法产生的缘由</li><li>该算法是指发送端即使还有应该发送的数据，但如果这部分数据很少的话，则进行延迟发送<ul><li>如果 SO_SNDBUF 的数据达到 MSS，则需要发送</li><li>如果 SO_SNDBUF 中含有 FIN（表示需要连接关闭）这时将剩余数据发送，再关闭</li><li>如果 TCP_NODELAY = true，则需要发送</li><li>已发送的数据都收到 ack 时，则需要发送</li><li>上述条件不满足，但发生超时（一般为 200ms）则需要发送</li><li>除上述情况，延迟发送</li></ul></li></ul></blockquote><a href=#半包><h4 id=半包><span class=hanchor arialabel=Anchor># </span>半包</h4></a><ul><li>现象，发送 abcdef，接收 abc def</li><li>原因<ul><li><strong>应用层</strong>：接收方 ByteBuf 小于实际发送数据量</li><li><strong>传输层</strong>：TCP：滑动窗口：假设接收方的窗口只剩了 128 bytes，发送方的报文大小是 256 bytes，这时放不下了，只能先发送前 128 bytes，等待 ack 后才能发送剩余部分，这就造成了半包</li><li><strong>数据链路层</strong>：MSS 限制：当发送的数据超过 MSS 限制后，会将数据切分发送，就会造成半包<ul><li>↑MSS是<strong>传输层</strong>的报文载荷长度（不包含报头），MTU是<strong>数据链路层</strong>最大载荷长度，其中MTU包含了MSS，MTU减去IP头和TCP头（20+20）就是MSS</li><li>本机回环地址MTU限制很大，65535，难以测试。</li></ul></li></ul></li></ul><p>本质是因为 TCP 是流式协议，消息无边界</p><blockquote><p>滑动窗口</p><ul><li><p>TCP 以一个段（segment）为单位，每发送一个段就需要进行一次确认应答（ack）处理，但如果这么做，缺点是包的往返时间越长性能就越差</p><p><img src="/z-oblib/z2-attachments/0049 1.png" width=auto></p></li></ul><p>为了解决此问题，引入了窗口概念，窗口大小即决定了无需等待应答而可以继续发送的数据最大值</p><p><img src=/z-oblib/z2-attachments/0051.png width=auto></p><ul><li><p>窗口实际就起到一个缓冲区的作用，同时也能起到流量控制的作用</p><ul><li>图中深色的部分即要发送的数据，高亮的部分即窗口</li><li>窗口内的数据才允许被发送，当应答未到达前，窗口必须停止滑动</li><li>如果 1001~2000 这个段的数据 ack 回来了，窗口就可以向前滑动</li><li>接收方也会维护一个窗口，只有落在窗口内的数据才能允许接收</li></ul></li></ul></blockquote><blockquote><p>MSS 限制</p><ul><li><p>链路层对一次能够发送的最大数据有限制，这个限制称之为 MTU（maximum transmission unit），不同的链路设备的 MTU 值也有所不同，例如</p></li><li><p>以太网的 MTU 是 1500</p></li><li><p>FDDI（光纤分布式数据接口）的 MTU 是 4352</p></li><li><p>本地回环地址的 MTU 是 65535 - 本地测试不走网卡</p></li><li><p>MSS 是最大段长度（maximum segment size），它是 MTU 刨去 tcp 头和 ip 头后剩余能够作为数据传输的字节数</p></li><li><p>ipv4 tcp 头占用 20 bytes，ip 头占用 20 bytes，因此以太网 MSS 的值为 1500 - 40 = 1460</p></li><li><p>TCP 在传递大量数据时，会按照 MSS 大小将数据进行分割发送</p></li><li><p>MSS 的值在三次握手时通知对方自己 MSS 的值，然后在两者之间选择一个小值作为 MSS</p></li></ul><p><img src=/z-oblib/z2-attachments/0031.jpg width=auto></p></blockquote><a href=#14-解决方案><h3 id=14-解决方案><span class=hanchor arialabel=Anchor># </span>1.4 💡解决方案</h3></a><ol><li>短链接，发一个包建立一次连接，这样连接建立到连接断开之间就是消息的边界，缺点效率太低</li><li>每一条消息采用固定长度，缺点浪费空间</li><li>每一条消息采用分隔符，例如 \n，缺点需要转义</li><li>每一条消息分为 head 和 body，head 中包含 body 的长度</li></ol><a href=#方法1短链接><h4 id=方法1短链接><span class=hanchor arialabel=Anchor># </span>方法1，短链接</h4></a><p>以解决粘包为例</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-6-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-1> 1</a>
</span><span class=lnt id=hl-6-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-2> 2</a>
</span><span class=lnt id=hl-6-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-3> 3</a>
</span><span class=lnt id=hl-6-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-4> 4</a>
</span><span class=lnt id=hl-6-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-5> 5</a>
</span><span class=lnt id=hl-6-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-6> 6</a>
</span><span class=lnt id=hl-6-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-7> 7</a>
</span><span class=lnt id=hl-6-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-8> 8</a>
</span><span class=lnt id=hl-6-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-9> 9</a>
</span><span class=lnt id=hl-6-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-10>10</a>
</span><span class=lnt id=hl-6-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-11>11</a>
</span><span class=lnt id=hl-6-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-12>12</a>
</span><span class=lnt id=hl-6-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-13>13</a>
</span><span class=lnt id=hl-6-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-14>14</a>
</span><span class=lnt id=hl-6-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-15>15</a>
</span><span class=lnt id=hl-6-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-16>16</a>
</span><span class=lnt id=hl-6-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-17>17</a>
</span><span class=lnt id=hl-6-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-18>18</a>
</span><span class=lnt id=hl-6-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-19>19</a>
</span><span class=lnt id=hl-6-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-20>20</a>
</span><span class=lnt id=hl-6-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-21>21</a>
</span><span class=lnt id=hl-6-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-22>22</a>
</span><span class=lnt id=hl-6-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-23>23</a>
</span><span class=lnt id=hl-6-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-24>24</a>
</span><span class=lnt id=hl-6-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-25>25</a>
</span><span class=lnt id=hl-6-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-26>26</a>
</span><span class=lnt id=hl-6-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-27>27</a>
</span><span class=lnt id=hl-6-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-28>28</a>
</span><span class=lnt id=hl-6-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-29>29</a>
</span><span class=lnt id=hl-6-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-30>30</a>
</span><span class=lnt id=hl-6-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-31>31</a>
</span><span class=lnt id=hl-6-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-32>32</a>
</span><span class=lnt id=hl-6-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-33>33</a>
</span><span class=lnt id=hl-6-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-34>34</a>
</span><span class=lnt id=hl-6-35><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-35>35</a>
</span><span class=lnt id=hl-6-36><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-36>36</a>
</span><span class=lnt id=hl-6-37><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-37>37</a>
</span><span class=lnt id=hl-6-38><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-38>38</a>
</span><span class=lnt id=hl-6-39><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-39>39</a>
</span><span class=lnt id=hl-6-40><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-40>40</a>
</span><span class=lnt id=hl-6-41><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-41>41</a>
</span><span class=lnt id=hl-6-42><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-42>42</a>
</span><span class=lnt id=hl-6-43><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-43>43</a>
</span><span class=lnt id=hl-6-44><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-44>44</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>HelloWorldClient</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>static</span> <span class=kd>final</span> <span class=n>Logger</span> <span class=n>log</span> <span class=o>=</span> <span class=n>LoggerFactory</span><span class=o>.</span><span class=na>getLogger</span><span class=o>(</span><span class=n>HelloWorldClient</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 分 10 次发送
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>10</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>send</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>send</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>NioEventLoopGroup</span> <span class=n>worker</span> <span class=o>=</span> <span class=k>new</span> <span class=n>NioEventLoopGroup</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Bootstrap</span> <span class=n>bootstrap</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Bootstrap</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>bootstrap</span><span class=o>.</span><span class=na>channel</span><span class=o>(</span><span class=n>NioSocketChannel</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>bootstrap</span><span class=o>.</span><span class=na>group</span><span class=o>(</span><span class=n>worker</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>bootstrap</span><span class=o>.</span><span class=na>handler</span><span class=o>(</span><span class=k>new</span> <span class=n>ChannelInitializer</span><span class=o>&lt;</span><span class=n>SocketChannel</span><span class=o>&gt;()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>                <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>initChannel</span><span class=o>(</span><span class=n>SocketChannel</span> <span class=n>ch</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;conneted...&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>LoggingHandler</span><span class=o>(</span><span class=n>LogLevel</span><span class=o>.</span><span class=na>DEBUG</span><span class=o>));</span>
</span></span><span class=line><span class=cl>                    <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>ChannelInboundHandlerAdapter</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>                        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>channelActive</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                            <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;sending...&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                            <span class=n>ByteBuf</span> <span class=n>buffer</span> <span class=o>=</span> <span class=n>ctx</span><span class=o>.</span><span class=na>alloc</span><span class=o>().</span><span class=na>buffer</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                            <span class=n>buffer</span><span class=o>.</span><span class=na>writeBytes</span><span class=o>(</span><span class=k>new</span> <span class=kt>byte</span><span class=o>[]{</span><span class=n>0</span><span class=o>,</span> <span class=n>1</span><span class=o>,</span> <span class=n>2</span><span class=o>,</span> <span class=n>3</span><span class=o>,</span> <span class=n>4</span><span class=o>,</span> <span class=n>5</span><span class=o>,</span> <span class=n>6</span><span class=o>,</span> <span class=n>7</span><span class=o>,</span> <span class=n>8</span><span class=o>,</span> <span class=n>9</span><span class=o>,</span> <span class=n>10</span><span class=o>,</span> <span class=n>11</span><span class=o>,</span> <span class=n>12</span><span class=o>,</span> <span class=n>13</span><span class=o>,</span> <span class=n>14</span><span class=o>,</span> <span class=n>15</span><span class=o>});</span>
</span></span><span class=line><span class=cl>                            <span class=n>ctx</span><span class=o>.</span><span class=na>writeAndFlush</span><span class=o>(</span><span class=n>buffer</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                            <span class=c1>// 发完即关
</span></span></span><span class=line><span class=cl><span class=c1></span>                            <span class=n>ctx</span><span class=o>.</span><span class=na>close</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                        <span class=o>}</span>
</span></span><span class=line><span class=cl>                    <span class=o>});</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>});</span>
</span></span><span class=line><span class=cl>            <span class=n>ChannelFuture</span> <span class=n>channelFuture</span> <span class=o>=</span> <span class=n>bootstrap</span><span class=o>.</span><span class=na>connect</span><span class=o>(</span><span class=s>&#34;localhost&#34;</span><span class=o>,</span> <span class=n>8080</span><span class=o>).</span><span class=na>sync</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>channelFuture</span><span class=o>.</span><span class=na>channel</span><span class=o>().</span><span class=na>closeFuture</span><span class=o>().</span><span class=na>sync</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=o>.</span><span class=na>error</span><span class=o>(</span><span class=s>&#34;client error&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>worker</span><span class=o>.</span><span class=na>shutdownGracefully</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>输出，略</p><a href=#缺点><h5 id=缺点><span class=hanchor arialabel=Anchor># </span>缺点</h5></a><p>半包用这种办法还是不好解决，因为接收方的缓冲区大小是有限的</p><a href=#方法2固定长度><h4 id=方法2固定长度><span class=hanchor arialabel=Anchor># </span>方法2，固定长度</h4></a><p>让所有数据包长度固定（假设长度为 8 字节），服务器端加入</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-7-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>FixedLengthFrameDecoder</span><span class=o>(</span><span class=n>8</span><span class=o>));</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>frame：帧，网络上一条完整的消息</p></blockquote><p>客户端测试代码，注意, 采用这种方法后，客户端什么时候 flush 都可以</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-8-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-1> 1</a>
</span><span class=lnt id=hl-8-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-2> 2</a>
</span><span class=lnt id=hl-8-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-3> 3</a>
</span><span class=lnt id=hl-8-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-4> 4</a>
</span><span class=lnt id=hl-8-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-5> 5</a>
</span><span class=lnt id=hl-8-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-6> 6</a>
</span><span class=lnt id=hl-8-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-7> 7</a>
</span><span class=lnt id=hl-8-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-8> 8</a>
</span><span class=lnt id=hl-8-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-9> 9</a>
</span><span class=lnt id=hl-8-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-10>10</a>
</span><span class=lnt id=hl-8-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-11>11</a>
</span><span class=lnt id=hl-8-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-12>12</a>
</span><span class=lnt id=hl-8-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-13>13</a>
</span><span class=lnt id=hl-8-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-14>14</a>
</span><span class=lnt id=hl-8-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-15>15</a>
</span><span class=lnt id=hl-8-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-16>16</a>
</span><span class=lnt id=hl-8-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-17>17</a>
</span><span class=lnt id=hl-8-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-18>18</a>
</span><span class=lnt id=hl-8-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-19>19</a>
</span><span class=lnt id=hl-8-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-20>20</a>
</span><span class=lnt id=hl-8-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-21>21</a>
</span><span class=lnt id=hl-8-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-22>22</a>
</span><span class=lnt id=hl-8-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-23>23</a>
</span><span class=lnt id=hl-8-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-24>24</a>
</span><span class=lnt id=hl-8-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-25>25</a>
</span><span class=lnt id=hl-8-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-26>26</a>
</span><span class=lnt id=hl-8-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-27>27</a>
</span><span class=lnt id=hl-8-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-28>28</a>
</span><span class=lnt id=hl-8-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-29>29</a>
</span><span class=lnt id=hl-8-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-30>30</a>
</span><span class=lnt id=hl-8-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-31>31</a>
</span><span class=lnt id=hl-8-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-32>32</a>
</span><span class=lnt id=hl-8-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-33>33</a>
</span><span class=lnt id=hl-8-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-34>34</a>
</span><span class=lnt id=hl-8-35><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-35>35</a>
</span><span class=lnt id=hl-8-36><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-36>36</a>
</span><span class=lnt id=hl-8-37><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-37>37</a>
</span><span class=lnt id=hl-8-38><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-38>38</a>
</span><span class=lnt id=hl-8-39><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-39>39</a>
</span><span class=lnt id=hl-8-40><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-40>40</a>
</span><span class=lnt id=hl-8-41><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-41>41</a>
</span><span class=lnt id=hl-8-42><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-42>42</a>
</span><span class=lnt id=hl-8-43><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-43>43</a>
</span><span class=lnt id=hl-8-44><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-44>44</a>
</span><span class=lnt id=hl-8-45><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-45>45</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>HelloWorldClient</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>static</span> <span class=kd>final</span> <span class=n>Logger</span> <span class=n>log</span> <span class=o>=</span> <span class=n>LoggerFactory</span><span class=o>.</span><span class=na>getLogger</span><span class=o>(</span><span class=n>HelloWorldClient</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>NioEventLoopGroup</span> <span class=n>worker</span> <span class=o>=</span> <span class=k>new</span> <span class=n>NioEventLoopGroup</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Bootstrap</span> <span class=n>bootstrap</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Bootstrap</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>bootstrap</span><span class=o>.</span><span class=na>channel</span><span class=o>(</span><span class=n>NioSocketChannel</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>bootstrap</span><span class=o>.</span><span class=na>group</span><span class=o>(</span><span class=n>worker</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>bootstrap</span><span class=o>.</span><span class=na>handler</span><span class=o>(</span><span class=k>new</span> <span class=n>ChannelInitializer</span><span class=o>&lt;</span><span class=n>SocketChannel</span><span class=o>&gt;()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>                <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>initChannel</span><span class=o>(</span><span class=n>SocketChannel</span> <span class=n>ch</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;connetted...&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>LoggingHandler</span><span class=o>(</span><span class=n>LogLevel</span><span class=o>.</span><span class=na>DEBUG</span><span class=o>));</span>
</span></span><span class=line><span class=cl>                    <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>ChannelInboundHandlerAdapter</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>                        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>channelActive</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                            <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;sending...&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                            <span class=c1>// 发送内容随机的数据包
</span></span></span><span class=line><span class=cl><span class=c1></span>                            <span class=n>Random</span> <span class=n>r</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Random</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                            <span class=kt>char</span> <span class=n>c</span> <span class=o>=</span> <span class=sc>&#39;a&#39;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                            <span class=n>ByteBuf</span> <span class=n>buffer</span> <span class=o>=</span> <span class=n>ctx</span><span class=o>.</span><span class=na>alloc</span><span class=o>().</span><span class=na>buffer</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                            <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>10</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                                <span class=kt>byte</span><span class=o>[]</span> <span class=n>bytes</span> <span class=o>=</span> <span class=k>new</span> <span class=kt>byte</span><span class=o>[</span><span class=n>8</span><span class=o>];</span>
</span></span><span class=line><span class=cl>                                <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>j</span> <span class=o>&lt;</span> <span class=n>r</span><span class=o>.</span><span class=na>nextInt</span><span class=o>(</span><span class=n>8</span><span class=o>);</span> <span class=n>j</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                                    <span class=n>bytes</span><span class=o>[</span><span class=n>j</span><span class=o>]</span> <span class=o>=</span> <span class=o>(</span><span class=kt>byte</span><span class=o>)</span> <span class=n>c</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                                <span class=o>}</span>
</span></span><span class=line><span class=cl>                                <span class=n>c</span><span class=o>++;</span>
</span></span><span class=line><span class=cl>                                <span class=n>buffer</span><span class=o>.</span><span class=na>writeBytes</span><span class=o>(</span><span class=n>bytes</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                            <span class=o>}</span>
</span></span><span class=line><span class=cl>                            <span class=n>ctx</span><span class=o>.</span><span class=na>writeAndFlush</span><span class=o>(</span><span class=n>buffer</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                        <span class=o>}</span>
</span></span><span class=line><span class=cl>                    <span class=o>});</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>});</span>
</span></span><span class=line><span class=cl>            <span class=n>ChannelFuture</span> <span class=n>channelFuture</span> <span class=o>=</span> <span class=n>bootstrap</span><span class=o>.</span><span class=na>connect</span><span class=o>(</span><span class=s>&#34;192.168.0.103&#34;</span><span class=o>,</span> <span class=n>9090</span><span class=o>).</span><span class=na>sync</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>channelFuture</span><span class=o>.</span><span class=na>channel</span><span class=o>().</span><span class=na>closeFuture</span><span class=o>().</span><span class=na>sync</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=o>.</span><span class=na>error</span><span class=o>(</span><span class=s>&#34;client error&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>worker</span><span class=o>.</span><span class=na>shutdownGracefully</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>客户端输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-9-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-1> 1</a>
</span><span class=lnt id=hl-9-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-2> 2</a>
</span><span class=lnt id=hl-9-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-3> 3</a>
</span><span class=lnt id=hl-9-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-4> 4</a>
</span><span class=lnt id=hl-9-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-5> 5</a>
</span><span class=lnt id=hl-9-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-6> 6</a>
</span><span class=lnt id=hl-9-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-7> 7</a>
</span><span class=lnt id=hl-9-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-8> 8</a>
</span><span class=lnt id=hl-9-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-9> 9</a>
</span><span class=lnt id=hl-9-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-10>10</a>
</span><span class=lnt id=hl-9-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-11>11</a>
</span><span class=lnt id=hl-9-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-12>12</a>
</span><span class=lnt id=hl-9-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-13>13</a>
</span><span class=lnt id=hl-9-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-14>14</a>
</span><span class=lnt id=hl-9-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-15>15</a>
</span><span class=lnt id=hl-9-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-16>16</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>12:07:00 [DEBUG] [nioEventLoopGroup-2-1] c.i.n.HelloWorldClient - connetted...
</span></span><span class=line><span class=cl>12:07:00 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0x3c2ef3c2] REGISTERED
</span></span><span class=line><span class=cl>12:07:00 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0x3c2ef3c2] CONNECT: /192.168.0.103:9090
</span></span><span class=line><span class=cl>12:07:00 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0x3c2ef3c2, L:/192.168.0.103:53155 - R:/192.168.0.103:9090] ACTIVE
</span></span><span class=line><span class=cl>12:07:00 [DEBUG] [nioEventLoopGroup-2-1] c.i.n.HelloWorldClient - sending...
</span></span><span class=line><span class=cl>12:07:00 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0x3c2ef3c2, L:/192.168.0.103:53155 - R:/192.168.0.103:9090] WRITE: 80B
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 61 61 61 61 00 00 00 00 62 00 00 00 00 00 00 00 |aaaa....b.......|
</span></span><span class=line><span class=cl>|00000010| 63 63 00 00 00 00 00 00 64 00 00 00 00 00 00 00 |cc......d.......|
</span></span><span class=line><span class=cl>|00000020| 00 00 00 00 00 00 00 00 66 66 66 66 00 00 00 00 |........ffff....|
</span></span><span class=line><span class=cl>|00000030| 67 67 67 00 00 00 00 00 68 00 00 00 00 00 00 00 |ggg.....h.......|
</span></span><span class=line><span class=cl>|00000040| 69 69 69 69 69 00 00 00 6a 6a 6a 6a 00 00 00 00 |iiiii...jjjj....|
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>12:07:00 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0x3c2ef3c2, L:/192.168.0.103:53155 - R:/192.168.0.103:9090] FLUSH
</span></span></code></pre></td></tr></table></div></div><p>服务端输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-10-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-1> 1</a>
</span><span class=lnt id=hl-10-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-2> 2</a>
</span><span class=lnt id=hl-10-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-3> 3</a>
</span><span class=lnt id=hl-10-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-4> 4</a>
</span><span class=lnt id=hl-10-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-5> 5</a>
</span><span class=lnt id=hl-10-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-6> 6</a>
</span><span class=lnt id=hl-10-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-7> 7</a>
</span><span class=lnt id=hl-10-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-8> 8</a>
</span><span class=lnt id=hl-10-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-9> 9</a>
</span><span class=lnt id=hl-10-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-10>10</a>
</span><span class=lnt id=hl-10-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-11>11</a>
</span><span class=lnt id=hl-10-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-12>12</a>
</span><span class=lnt id=hl-10-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-13>13</a>
</span><span class=lnt id=hl-10-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-14>14</a>
</span><span class=lnt id=hl-10-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-15>15</a>
</span><span class=lnt id=hl-10-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-16>16</a>
</span><span class=lnt id=hl-10-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-17>17</a>
</span><span class=lnt id=hl-10-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-18>18</a>
</span><span class=lnt id=hl-10-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-19>19</a>
</span><span class=lnt id=hl-10-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-20>20</a>
</span><span class=lnt id=hl-10-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-21>21</a>
</span><span class=lnt id=hl-10-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-22>22</a>
</span><span class=lnt id=hl-10-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-23>23</a>
</span><span class=lnt id=hl-10-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-24>24</a>
</span><span class=lnt id=hl-10-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-25>25</a>
</span><span class=lnt id=hl-10-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-26>26</a>
</span><span class=lnt id=hl-10-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-27>27</a>
</span><span class=lnt id=hl-10-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-28>28</a>
</span><span class=lnt id=hl-10-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-29>29</a>
</span><span class=lnt id=hl-10-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-30>30</a>
</span><span class=lnt id=hl-10-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-31>31</a>
</span><span class=lnt id=hl-10-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-32>32</a>
</span><span class=lnt id=hl-10-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-33>33</a>
</span><span class=lnt id=hl-10-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-34>34</a>
</span><span class=lnt id=hl-10-35><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-35>35</a>
</span><span class=lnt id=hl-10-36><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-36>36</a>
</span><span class=lnt id=hl-10-37><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-37>37</a>
</span><span class=lnt id=hl-10-38><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-38>38</a>
</span><span class=lnt id=hl-10-39><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-39>39</a>
</span><span class=lnt id=hl-10-40><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-40>40</a>
</span><span class=lnt id=hl-10-41><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-41>41</a>
</span><span class=lnt id=hl-10-42><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-42>42</a>
</span><span class=lnt id=hl-10-43><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-43>43</a>
</span><span class=lnt id=hl-10-44><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-44>44</a>
</span><span class=lnt id=hl-10-45><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-45>45</a>
</span><span class=lnt id=hl-10-46><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-46>46</a>
</span><span class=lnt id=hl-10-47><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-47>47</a>
</span><span class=lnt id=hl-10-48><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-48>48</a>
</span><span class=lnt id=hl-10-49><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-49>49</a>
</span><span class=lnt id=hl-10-50><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-50>50</a>
</span><span class=lnt id=hl-10-51><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-51>51</a>
</span><span class=lnt id=hl-10-52><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-52>52</a>
</span><span class=lnt id=hl-10-53><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-53>53</a>
</span><span class=lnt id=hl-10-54><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-54>54</a>
</span><span class=lnt id=hl-10-55><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-55>55</a>
</span><span class=lnt id=hl-10-56><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-56>56</a>
</span><span class=lnt id=hl-10-57><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-57>57</a>
</span><span class=lnt id=hl-10-58><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-58>58</a>
</span><span class=lnt id=hl-10-59><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-59>59</a>
</span><span class=lnt id=hl-10-60><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-60>60</a>
</span><span class=lnt id=hl-10-61><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-61>61</a>
</span><span class=lnt id=hl-10-62><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-62>62</a>
</span><span class=lnt id=hl-10-63><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-63>63</a>
</span><span class=lnt id=hl-10-64><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-64>64</a>
</span><span class=lnt id=hl-10-65><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-65>65</a>
</span><span class=lnt id=hl-10-66><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-66>66</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>12:06:51 [DEBUG] [main] c.i.n.HelloWorldServer - [id: 0xe3d9713f] binding...
</span></span><span class=line><span class=cl>12:06:51 [DEBUG] [main] c.i.n.HelloWorldServer - [id: 0xe3d9713f, L:/192.168.0.103:9090] bound...
</span></span><span class=line><span class=cl>12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155] REGISTERED
</span></span><span class=line><span class=cl>12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155] ACTIVE
</span></span><span class=line><span class=cl>12:07:00 [DEBUG] [nioEventLoopGroup-3-1] c.i.n.HelloWorldServer - connected [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155]
</span></span><span class=line><span class=cl>12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155] READ: 8B
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 61 61 61 61 00 00 00 00                         |aaaa....        |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155] READ: 8B
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 62 00 00 00 00 00 00 00                         |b.......        |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155] READ: 8B
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 63 63 00 00 00 00 00 00                         |cc......        |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155] READ: 8B
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 64 00 00 00 00 00 00 00                         |d.......        |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155] READ: 8B
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 00 00 00 00 00 00 00 00                         |........        |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155] READ: 8B
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 66 66 66 66 00 00 00 00                         |ffff....        |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155] READ: 8B
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 67 67 67 00 00 00 00 00                         |ggg.....        |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155] READ: 8B
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 68 00 00 00 00 00 00 00                         |h.......        |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155] READ: 8B
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 69 69 69 69 69 00 00 00                         |iiiii...        |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155] READ: 8B
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 6a 6a 6a 6a 00 00 00 00                         |jjjj....        |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155] READ COMPLETE
</span></span></code></pre></td></tr></table></div></div><a href=#缺点-1><h5 id=缺点-1><span class=hanchor arialabel=Anchor># </span>缺点</h5></a><p>数据包的大小不好把握</p><ul><li>长度定的太大，浪费</li><li>长度定的太小，对某些数据包又显得不够</li></ul><a href=#方法3固定分隔符><h4 id=方法3固定分隔符><span class=hanchor arialabel=Anchor># </span>方法3，固定分隔符</h4></a><p>服务端加入，默认以 <code>\n</code> 或 <code>\r\n</code> 作为分隔符，必须指定最大长度，如果超出指定长度仍未出现分隔符，则抛出异常</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-11-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>LineBasedFrameDecoder</span><span class=o>(</span><span class=n>1024</span><span class=o>));</span>
</span></span></code></pre></td></tr></table></div></div><p>客户端在每条消息之后，加入 <code>\n</code> 分隔符</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-12-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-1> 1</a>
</span><span class=lnt id=hl-12-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-2> 2</a>
</span><span class=lnt id=hl-12-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-3> 3</a>
</span><span class=lnt id=hl-12-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-4> 4</a>
</span><span class=lnt id=hl-12-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-5> 5</a>
</span><span class=lnt id=hl-12-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-6> 6</a>
</span><span class=lnt id=hl-12-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-7> 7</a>
</span><span class=lnt id=hl-12-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-8> 8</a>
</span><span class=lnt id=hl-12-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-9> 9</a>
</span><span class=lnt id=hl-12-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-10>10</a>
</span><span class=lnt id=hl-12-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-11>11</a>
</span><span class=lnt id=hl-12-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-12>12</a>
</span><span class=lnt id=hl-12-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-13>13</a>
</span><span class=lnt id=hl-12-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-14>14</a>
</span><span class=lnt id=hl-12-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-15>15</a>
</span><span class=lnt id=hl-12-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-16>16</a>
</span><span class=lnt id=hl-12-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-17>17</a>
</span><span class=lnt id=hl-12-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-18>18</a>
</span><span class=lnt id=hl-12-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-19>19</a>
</span><span class=lnt id=hl-12-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-20>20</a>
</span><span class=lnt id=hl-12-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-21>21</a>
</span><span class=lnt id=hl-12-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-22>22</a>
</span><span class=lnt id=hl-12-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-23>23</a>
</span><span class=lnt id=hl-12-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-24>24</a>
</span><span class=lnt id=hl-12-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-25>25</a>
</span><span class=lnt id=hl-12-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-26>26</a>
</span><span class=lnt id=hl-12-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-27>27</a>
</span><span class=lnt id=hl-12-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-28>28</a>
</span><span class=lnt id=hl-12-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-29>29</a>
</span><span class=lnt id=hl-12-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-30>30</a>
</span><span class=lnt id=hl-12-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-31>31</a>
</span><span class=lnt id=hl-12-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-32>32</a>
</span><span class=lnt id=hl-12-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-33>33</a>
</span><span class=lnt id=hl-12-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-34>34</a>
</span><span class=lnt id=hl-12-35><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-35>35</a>
</span><span class=lnt id=hl-12-36><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-36>36</a>
</span><span class=lnt id=hl-12-37><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-37>37</a>
</span><span class=lnt id=hl-12-38><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-38>38</a>
</span><span class=lnt id=hl-12-39><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-39>39</a>
</span><span class=lnt id=hl-12-40><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-40>40</a>
</span><span class=lnt id=hl-12-41><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-41>41</a>
</span><span class=lnt id=hl-12-42><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-42>42</a>
</span><span class=lnt id=hl-12-43><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-43>43</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>HelloWorldClient</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>static</span> <span class=kd>final</span> <span class=n>Logger</span> <span class=n>log</span> <span class=o>=</span> <span class=n>LoggerFactory</span><span class=o>.</span><span class=na>getLogger</span><span class=o>(</span><span class=n>HelloWorldClient</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>NioEventLoopGroup</span> <span class=n>worker</span> <span class=o>=</span> <span class=k>new</span> <span class=n>NioEventLoopGroup</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Bootstrap</span> <span class=n>bootstrap</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Bootstrap</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>bootstrap</span><span class=o>.</span><span class=na>channel</span><span class=o>(</span><span class=n>NioSocketChannel</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>bootstrap</span><span class=o>.</span><span class=na>group</span><span class=o>(</span><span class=n>worker</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>bootstrap</span><span class=o>.</span><span class=na>handler</span><span class=o>(</span><span class=k>new</span> <span class=n>ChannelInitializer</span><span class=o>&lt;</span><span class=n>SocketChannel</span><span class=o>&gt;()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>                <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>initChannel</span><span class=o>(</span><span class=n>SocketChannel</span> <span class=n>ch</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;connetted...&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>LoggingHandler</span><span class=o>(</span><span class=n>LogLevel</span><span class=o>.</span><span class=na>DEBUG</span><span class=o>));</span>
</span></span><span class=line><span class=cl>                    <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>ChannelInboundHandlerAdapter</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>                        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>channelActive</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                            <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;sending...&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                            <span class=n>Random</span> <span class=n>r</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Random</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                            <span class=kt>char</span> <span class=n>c</span> <span class=o>=</span> <span class=sc>&#39;a&#39;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                            <span class=n>ByteBuf</span> <span class=n>buffer</span> <span class=o>=</span> <span class=n>ctx</span><span class=o>.</span><span class=na>alloc</span><span class=o>().</span><span class=na>buffer</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                            <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>10</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                                <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=n>1</span><span class=o>;</span> <span class=n>j</span> <span class=o>&lt;=</span> <span class=n>r</span><span class=o>.</span><span class=na>nextInt</span><span class=o>(</span><span class=n>16</span><span class=o>)+</span><span class=n>1</span><span class=o>;</span> <span class=n>j</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                                    <span class=n>buffer</span><span class=o>.</span><span class=na>writeByte</span><span class=o>((</span><span class=kt>byte</span><span class=o>)</span> <span class=n>c</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                                <span class=o>}</span>
</span></span><span class=line><span class=cl>                                <span class=n>buffer</span><span class=o>.</span><span class=na>writeByte</span><span class=o>(</span><span class=n>10</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                                <span class=n>c</span><span class=o>++;</span>
</span></span><span class=line><span class=cl>                            <span class=o>}</span>
</span></span><span class=line><span class=cl>                            <span class=n>ctx</span><span class=o>.</span><span class=na>writeAndFlush</span><span class=o>(</span><span class=n>buffer</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                        <span class=o>}</span>
</span></span><span class=line><span class=cl>                    <span class=o>});</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>});</span>
</span></span><span class=line><span class=cl>            <span class=n>ChannelFuture</span> <span class=n>channelFuture</span> <span class=o>=</span> <span class=n>bootstrap</span><span class=o>.</span><span class=na>connect</span><span class=o>(</span><span class=s>&#34;192.168.0.103&#34;</span><span class=o>,</span> <span class=n>9090</span><span class=o>).</span><span class=na>sync</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>channelFuture</span><span class=o>.</span><span class=na>channel</span><span class=o>().</span><span class=na>closeFuture</span><span class=o>().</span><span class=na>sync</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=o>.</span><span class=na>error</span><span class=o>(</span><span class=s>&#34;client error&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>worker</span><span class=o>.</span><span class=na>shutdownGracefully</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>客户端输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-13-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-1> 1</a>
</span><span class=lnt id=hl-13-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-2> 2</a>
</span><span class=lnt id=hl-13-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-3> 3</a>
</span><span class=lnt id=hl-13-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-4> 4</a>
</span><span class=lnt id=hl-13-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-5> 5</a>
</span><span class=lnt id=hl-13-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-6> 6</a>
</span><span class=lnt id=hl-13-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-7> 7</a>
</span><span class=lnt id=hl-13-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-8> 8</a>
</span><span class=lnt id=hl-13-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-9> 9</a>
</span><span class=lnt id=hl-13-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-10>10</a>
</span><span class=lnt id=hl-13-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-11>11</a>
</span><span class=lnt id=hl-13-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-12>12</a>
</span><span class=lnt id=hl-13-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-13>13</a>
</span><span class=lnt id=hl-13-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-14>14</a>
</span><span class=lnt id=hl-13-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-15>15</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>14:08:18 [DEBUG] [nioEventLoopGroup-2-1] c.i.n.HelloWorldClient - connetted...
</span></span><span class=line><span class=cl>14:08:18 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0x1282d755] REGISTERED
</span></span><span class=line><span class=cl>14:08:18 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0x1282d755] CONNECT: /192.168.0.103:9090
</span></span><span class=line><span class=cl>14:08:18 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0x1282d755, L:/192.168.0.103:63641 - R:/192.168.0.103:9090] ACTIVE
</span></span><span class=line><span class=cl>14:08:18 [DEBUG] [nioEventLoopGroup-2-1] c.i.n.HelloWorldClient - sending...
</span></span><span class=line><span class=cl>14:08:18 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0x1282d755, L:/192.168.0.103:63641 - R:/192.168.0.103:9090] WRITE: 60B
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 61 0a 62 62 62 0a 63 63 63 0a 64 64 0a 65 65 65 |a.bbb.ccc.dd.eee|
</span></span><span class=line><span class=cl>|00000010| 65 65 65 65 65 65 65 0a 66 66 0a 67 67 67 67 67 |eeeeeee.ff.ggggg|
</span></span><span class=line><span class=cl>|00000020| 67 67 0a 68 68 68 68 0a 69 69 69 69 69 69 69 0a |gg.hhhh.iiiiiii.|
</span></span><span class=line><span class=cl>|00000030| 6a 6a 6a 6a 6a 6a 6a 6a 6a 6a 6a 0a             |jjjjjjjjjjj.    |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>14:08:18 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0x1282d755, L:/192.168.0.103:63641 - R:/192.168.0.103:9090] FLUSH
</span></span></code></pre></td></tr></table></div></div><p>服务端输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-14-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-1> 1</a>
</span><span class=lnt id=hl-14-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-2> 2</a>
</span><span class=lnt id=hl-14-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-3> 3</a>
</span><span class=lnt id=hl-14-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-4> 4</a>
</span><span class=lnt id=hl-14-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-5> 5</a>
</span><span class=lnt id=hl-14-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-6> 6</a>
</span><span class=lnt id=hl-14-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-7> 7</a>
</span><span class=lnt id=hl-14-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-8> 8</a>
</span><span class=lnt id=hl-14-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-9> 9</a>
</span><span class=lnt id=hl-14-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-10>10</a>
</span><span class=lnt id=hl-14-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-11>11</a>
</span><span class=lnt id=hl-14-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-12>12</a>
</span><span class=lnt id=hl-14-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-13>13</a>
</span><span class=lnt id=hl-14-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-14>14</a>
</span><span class=lnt id=hl-14-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-15>15</a>
</span><span class=lnt id=hl-14-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-16>16</a>
</span><span class=lnt id=hl-14-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-17>17</a>
</span><span class=lnt id=hl-14-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-18>18</a>
</span><span class=lnt id=hl-14-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-19>19</a>
</span><span class=lnt id=hl-14-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-20>20</a>
</span><span class=lnt id=hl-14-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-21>21</a>
</span><span class=lnt id=hl-14-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-22>22</a>
</span><span class=lnt id=hl-14-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-23>23</a>
</span><span class=lnt id=hl-14-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-24>24</a>
</span><span class=lnt id=hl-14-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-25>25</a>
</span><span class=lnt id=hl-14-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-26>26</a>
</span><span class=lnt id=hl-14-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-27>27</a>
</span><span class=lnt id=hl-14-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-28>28</a>
</span><span class=lnt id=hl-14-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-29>29</a>
</span><span class=lnt id=hl-14-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-30>30</a>
</span><span class=lnt id=hl-14-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-31>31</a>
</span><span class=lnt id=hl-14-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-32>32</a>
</span><span class=lnt id=hl-14-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-33>33</a>
</span><span class=lnt id=hl-14-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-34>34</a>
</span><span class=lnt id=hl-14-35><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-35>35</a>
</span><span class=lnt id=hl-14-36><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-36>36</a>
</span><span class=lnt id=hl-14-37><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-37>37</a>
</span><span class=lnt id=hl-14-38><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-38>38</a>
</span><span class=lnt id=hl-14-39><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-39>39</a>
</span><span class=lnt id=hl-14-40><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-40>40</a>
</span><span class=lnt id=hl-14-41><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-41>41</a>
</span><span class=lnt id=hl-14-42><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-42>42</a>
</span><span class=lnt id=hl-14-43><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-43>43</a>
</span><span class=lnt id=hl-14-44><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-44>44</a>
</span><span class=lnt id=hl-14-45><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-45>45</a>
</span><span class=lnt id=hl-14-46><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-46>46</a>
</span><span class=lnt id=hl-14-47><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-47>47</a>
</span><span class=lnt id=hl-14-48><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-48>48</a>
</span><span class=lnt id=hl-14-49><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-49>49</a>
</span><span class=lnt id=hl-14-50><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-50>50</a>
</span><span class=lnt id=hl-14-51><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-51>51</a>
</span><span class=lnt id=hl-14-52><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-52>52</a>
</span><span class=lnt id=hl-14-53><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-53>53</a>
</span><span class=lnt id=hl-14-54><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-54>54</a>
</span><span class=lnt id=hl-14-55><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-55>55</a>
</span><span class=lnt id=hl-14-56><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-56>56</a>
</span><span class=lnt id=hl-14-57><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-57>57</a>
</span><span class=lnt id=hl-14-58><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-58>58</a>
</span><span class=lnt id=hl-14-59><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-59>59</a>
</span><span class=lnt id=hl-14-60><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-60>60</a>
</span><span class=lnt id=hl-14-61><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-61>61</a>
</span><span class=lnt id=hl-14-62><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-62>62</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>14:08:18 [DEBUG] [nioEventLoopGroup-3-5] c.i.n.HelloWorldServer - connected [id: 0xa4b3be43, L:/192.168.0.103:9090 - R:/192.168.0.103:63641]
</span></span><span class=line><span class=cl>14:08:18 [DEBUG] [nioEventLoopGroup-3-5] i.n.h.l.LoggingHandler - [id: 0xa4b3be43, L:/192.168.0.103:9090 - R:/192.168.0.103:63641] READ: 1B
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 61                                              |a               |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>14:08:18 [DEBUG] [nioEventLoopGroup-3-5] i.n.h.l.LoggingHandler - [id: 0xa4b3be43, L:/192.168.0.103:9090 - R:/192.168.0.103:63641] READ: 3B
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 62 62 62                                        |bbb             |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>14:08:18 [DEBUG] [nioEventLoopGroup-3-5] i.n.h.l.LoggingHandler - [id: 0xa4b3be43, L:/192.168.0.103:9090 - R:/192.168.0.103:63641] READ: 3B
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 63 63 63                                        |ccc             |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>14:08:18 [DEBUG] [nioEventLoopGroup-3-5] i.n.h.l.LoggingHandler - [id: 0xa4b3be43, L:/192.168.0.103:9090 - R:/192.168.0.103:63641] READ: 2B
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 64 64                                           |dd              |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>14:08:18 [DEBUG] [nioEventLoopGroup-3-5] i.n.h.l.LoggingHandler - [id: 0xa4b3be43, L:/192.168.0.103:9090 - R:/192.168.0.103:63641] READ: 10B
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 65 65 65 65 65 65 65 65 65 65                   |eeeeeeeeee      |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>14:08:18 [DEBUG] [nioEventLoopGroup-3-5] i.n.h.l.LoggingHandler - [id: 0xa4b3be43, L:/192.168.0.103:9090 - R:/192.168.0.103:63641] READ: 2B
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 66 66                                           |ff              |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>14:08:18 [DEBUG] [nioEventLoopGroup-3-5] i.n.h.l.LoggingHandler - [id: 0xa4b3be43, L:/192.168.0.103:9090 - R:/192.168.0.103:63641] READ: 7B
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 67 67 67 67 67 67 67                            |ggggggg         |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>14:08:18 [DEBUG] [nioEventLoopGroup-3-5] i.n.h.l.LoggingHandler - [id: 0xa4b3be43, L:/192.168.0.103:9090 - R:/192.168.0.103:63641] READ: 4B
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 68 68 68 68                                     |hhhh            |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>14:08:18 [DEBUG] [nioEventLoopGroup-3-5] i.n.h.l.LoggingHandler - [id: 0xa4b3be43, L:/192.168.0.103:9090 - R:/192.168.0.103:63641] READ: 7B
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 69 69 69 69 69 69 69                            |iiiiiii         |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>14:08:18 [DEBUG] [nioEventLoopGroup-3-5] i.n.h.l.LoggingHandler - [id: 0xa4b3be43, L:/192.168.0.103:9090 - R:/192.168.0.103:63641] READ: 11B
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 6a 6a 6a 6a 6a 6a 6a 6a 6a 6a 6a                |jjjjjjjjjjj     |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>14:08:18 [DEBUG] [nioEventLoopGroup-3-5] i.n.h.l.LoggingHandler - [id: 0xa4b3be43, L:/192.168.0.103:9090 - R:/192.168.0.103:63641] READ COMPLETE
</span></span></code></pre></td></tr></table></div></div><a href=#缺点-2><h5 id=缺点-2><span class=hanchor arialabel=Anchor># </span>缺点</h5></a><p>处理字符数据比较合适，但如果内容本身包含了分隔符（字节数据常常会有此情况），那么就会解析错误</p><a href=#方法4约定长度><h4 id=方法4约定长度><span class=hanchor arialabel=Anchor># </span>方法4，约定长度</h4></a><blockquote><p>类似http协议的Content-Length。实际上我们就是要设计一个类似http的协议。</p></blockquote><p>在发送消息前，先约定用定长字节表示接下来数据的长度</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-15-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-1>1</a>
</span><span class=lnt id=hl-15-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-2>2</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 最大长度，长度偏移，长度占用字节，长度调整，剥离字节数
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>LengthFieldBasedFrameDecoder</span><span class=o>(</span><span class=n>1024</span><span class=o>,</span> <span class=n>0</span><span class=o>,</span> <span class=n>1</span><span class=o>,</span> <span class=n>0</span><span class=o>,</span> <span class=n>1</span><span class=o>));</span>
</span></span></code></pre></td></tr></table></div></div><p>客户端代码</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-16-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-1> 1</a>
</span><span class=lnt id=hl-16-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-2> 2</a>
</span><span class=lnt id=hl-16-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-3> 3</a>
</span><span class=lnt id=hl-16-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-4> 4</a>
</span><span class=lnt id=hl-16-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-5> 5</a>
</span><span class=lnt id=hl-16-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-6> 6</a>
</span><span class=lnt id=hl-16-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-7> 7</a>
</span><span class=lnt id=hl-16-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-8> 8</a>
</span><span class=lnt id=hl-16-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-9> 9</a>
</span><span class=lnt id=hl-16-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-10>10</a>
</span><span class=lnt id=hl-16-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-11>11</a>
</span><span class=lnt id=hl-16-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-12>12</a>
</span><span class=lnt id=hl-16-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-13>13</a>
</span><span class=lnt id=hl-16-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-14>14</a>
</span><span class=lnt id=hl-16-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-15>15</a>
</span><span class=lnt id=hl-16-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-16>16</a>
</span><span class=lnt id=hl-16-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-17>17</a>
</span><span class=lnt id=hl-16-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-18>18</a>
</span><span class=lnt id=hl-16-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-19>19</a>
</span><span class=lnt id=hl-16-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-20>20</a>
</span><span class=lnt id=hl-16-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-21>21</a>
</span><span class=lnt id=hl-16-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-22>22</a>
</span><span class=lnt id=hl-16-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-23>23</a>
</span><span class=lnt id=hl-16-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-24>24</a>
</span><span class=lnt id=hl-16-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-25>25</a>
</span><span class=lnt id=hl-16-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-26>26</a>
</span><span class=lnt id=hl-16-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-27>27</a>
</span><span class=lnt id=hl-16-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-28>28</a>
</span><span class=lnt id=hl-16-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-29>29</a>
</span><span class=lnt id=hl-16-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-30>30</a>
</span><span class=lnt id=hl-16-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-31>31</a>
</span><span class=lnt id=hl-16-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-32>32</a>
</span><span class=lnt id=hl-16-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-33>33</a>
</span><span class=lnt id=hl-16-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-34>34</a>
</span><span class=lnt id=hl-16-35><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-35>35</a>
</span><span class=lnt id=hl-16-36><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-36>36</a>
</span><span class=lnt id=hl-16-37><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-37>37</a>
</span><span class=lnt id=hl-16-38><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-38>38</a>
</span><span class=lnt id=hl-16-39><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-39>39</a>
</span><span class=lnt id=hl-16-40><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-40>40</a>
</span><span class=lnt id=hl-16-41><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-41>41</a>
</span><span class=lnt id=hl-16-42><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-42>42</a>
</span><span class=lnt id=hl-16-43><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-43>43</a>
</span><span class=lnt id=hl-16-44><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-44>44</a>
</span><span class=lnt id=hl-16-45><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-45>45</a>
</span><span class=lnt id=hl-16-46><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-46>46</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>HelloWorldClient</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>static</span> <span class=kd>final</span> <span class=n>Logger</span> <span class=n>log</span> <span class=o>=</span> <span class=n>LoggerFactory</span><span class=o>.</span><span class=na>getLogger</span><span class=o>(</span><span class=n>HelloWorldClient</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>NioEventLoopGroup</span> <span class=n>worker</span> <span class=o>=</span> <span class=k>new</span> <span class=n>NioEventLoopGroup</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Bootstrap</span> <span class=n>bootstrap</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Bootstrap</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>bootstrap</span><span class=o>.</span><span class=na>channel</span><span class=o>(</span><span class=n>NioSocketChannel</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>bootstrap</span><span class=o>.</span><span class=na>group</span><span class=o>(</span><span class=n>worker</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>bootstrap</span><span class=o>.</span><span class=na>handler</span><span class=o>(</span><span class=k>new</span> <span class=n>ChannelInitializer</span><span class=o>&lt;</span><span class=n>SocketChannel</span><span class=o>&gt;()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>                <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>initChannel</span><span class=o>(</span><span class=n>SocketChannel</span> <span class=n>ch</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;connetted...&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>LoggingHandler</span><span class=o>(</span><span class=n>LogLevel</span><span class=o>.</span><span class=na>DEBUG</span><span class=o>));</span>
</span></span><span class=line><span class=cl>                    <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>ChannelInboundHandlerAdapter</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>                        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>channelActive</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                            <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;sending...&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                            <span class=n>Random</span> <span class=n>r</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Random</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                            <span class=kt>char</span> <span class=n>c</span> <span class=o>=</span> <span class=sc>&#39;a&#39;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                            <span class=n>ByteBuf</span> <span class=n>buffer</span> <span class=o>=</span> <span class=n>ctx</span><span class=o>.</span><span class=na>alloc</span><span class=o>().</span><span class=na>buffer</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                            <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>10</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                                <span class=kt>byte</span> <span class=n>length</span> <span class=o>=</span> <span class=o>(</span><span class=kt>byte</span><span class=o>)</span> <span class=o>(</span><span class=n>r</span><span class=o>.</span><span class=na>nextInt</span><span class=o>(</span><span class=n>16</span><span class=o>)</span> <span class=o>+</span> <span class=n>1</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                                <span class=c1>// 先写入长度
</span></span></span><span class=line><span class=cl><span class=c1></span>                                <span class=n>buffer</span><span class=o>.</span><span class=na>writeByte</span><span class=o>(</span><span class=n>length</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                                <span class=c1>// 再
</span></span></span><span class=line><span class=cl><span class=c1></span>                                <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=n>1</span><span class=o>;</span> <span class=n>j</span> <span class=o>&lt;=</span> <span class=n>length</span><span class=o>;</span> <span class=n>j</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                                    <span class=n>buffer</span><span class=o>.</span><span class=na>writeByte</span><span class=o>((</span><span class=kt>byte</span><span class=o>)</span> <span class=n>c</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                                <span class=o>}</span>
</span></span><span class=line><span class=cl>                                <span class=n>c</span><span class=o>++;</span>
</span></span><span class=line><span class=cl>                            <span class=o>}</span>
</span></span><span class=line><span class=cl>                            <span class=n>ctx</span><span class=o>.</span><span class=na>writeAndFlush</span><span class=o>(</span><span class=n>buffer</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                        <span class=o>}</span>
</span></span><span class=line><span class=cl>                    <span class=o>});</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>});</span>
</span></span><span class=line><span class=cl>            <span class=n>ChannelFuture</span> <span class=n>channelFuture</span> <span class=o>=</span> <span class=n>bootstrap</span><span class=o>.</span><span class=na>connect</span><span class=o>(</span><span class=s>&#34;192.168.0.103&#34;</span><span class=o>,</span> <span class=n>9090</span><span class=o>).</span><span class=na>sync</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>channelFuture</span><span class=o>.</span><span class=na>channel</span><span class=o>().</span><span class=na>closeFuture</span><span class=o>().</span><span class=na>sync</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=o>.</span><span class=na>error</span><span class=o>(</span><span class=s>&#34;client error&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>worker</span><span class=o>.</span><span class=na>shutdownGracefully</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>客户端输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-17-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-1> 1</a>
</span><span class=lnt id=hl-17-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-2> 2</a>
</span><span class=lnt id=hl-17-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-3> 3</a>
</span><span class=lnt id=hl-17-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-4> 4</a>
</span><span class=lnt id=hl-17-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-5> 5</a>
</span><span class=lnt id=hl-17-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-6> 6</a>
</span><span class=lnt id=hl-17-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-7> 7</a>
</span><span class=lnt id=hl-17-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-8> 8</a>
</span><span class=lnt id=hl-17-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-9> 9</a>
</span><span class=lnt id=hl-17-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-10>10</a>
</span><span class=lnt id=hl-17-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-11>11</a>
</span><span class=lnt id=hl-17-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-12>12</a>
</span><span class=lnt id=hl-17-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-13>13</a>
</span><span class=lnt id=hl-17-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-14>14</a>
</span><span class=lnt id=hl-17-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-15>15</a>
</span><span class=lnt id=hl-17-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-16>16</a>
</span><span class=lnt id=hl-17-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-17>17</a>
</span><span class=lnt id=hl-17-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-18>18</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>14:37:10 [DEBUG] [nioEventLoopGroup-2-1] c.i.n.HelloWorldClient - connetted...
</span></span><span class=line><span class=cl>14:37:10 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0xf0f347b8] REGISTERED
</span></span><span class=line><span class=cl>14:37:10 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0xf0f347b8] CONNECT: /192.168.0.103:9090
</span></span><span class=line><span class=cl>14:37:10 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0xf0f347b8, L:/192.168.0.103:49979 - R:/192.168.0.103:9090] ACTIVE
</span></span><span class=line><span class=cl>14:37:10 [DEBUG] [nioEventLoopGroup-2-1] c.i.n.HelloWorldClient - sending...
</span></span><span class=line><span class=cl>14:37:10 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0xf0f347b8, L:/192.168.0.103:49979 - R:/192.168.0.103:9090] WRITE: 97B
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 09 61 61 61 61 61 61 61 61 61 09 62 62 62 62 62 |.aaaaaaaaa.bbbbb|
</span></span><span class=line><span class=cl>|00000010| 62 62 62 62 06 63 63 63 63 63 63 08 64 64 64 64 |bbbb.cccccc.dddd|
</span></span><span class=line><span class=cl>|00000020| 64 64 64 64 0f 65 65 65 65 65 65 65 65 65 65 65 |dddd.eeeeeeeeeee|
</span></span><span class=line><span class=cl>|00000030| 65 65 65 65 0d 66 66 66 66 66 66 66 66 66 66 66 |eeee.fffffffffff|
</span></span><span class=line><span class=cl>|00000040| 66 66 02 67 67 02 68 68 0e 69 69 69 69 69 69 69 |ff.gg.hh.iiiiiii|
</span></span><span class=line><span class=cl>|00000050| 69 69 69 69 69 69 69 09 6a 6a 6a 6a 6a 6a 6a 6a |iiiiiii.jjjjjjjj|
</span></span><span class=line><span class=cl>|00000060| 6a                                              |j               |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>14:37:10 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0xf0f347b8, L:/192.168.0.103:49979 - R:/192.168.0.103:9090] FLUSH
</span></span></code></pre></td></tr></table></div></div><p>服务端输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-18-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-1> 1</a>
</span><span class=lnt id=hl-18-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-2> 2</a>
</span><span class=lnt id=hl-18-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-3> 3</a>
</span><span class=lnt id=hl-18-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-4> 4</a>
</span><span class=lnt id=hl-18-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-5> 5</a>
</span><span class=lnt id=hl-18-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-6> 6</a>
</span><span class=lnt id=hl-18-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-7> 7</a>
</span><span class=lnt id=hl-18-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-8> 8</a>
</span><span class=lnt id=hl-18-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-9> 9</a>
</span><span class=lnt id=hl-18-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-10>10</a>
</span><span class=lnt id=hl-18-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-11>11</a>
</span><span class=lnt id=hl-18-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-12>12</a>
</span><span class=lnt id=hl-18-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-13>13</a>
</span><span class=lnt id=hl-18-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-14>14</a>
</span><span class=lnt id=hl-18-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-15>15</a>
</span><span class=lnt id=hl-18-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-16>16</a>
</span><span class=lnt id=hl-18-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-17>17</a>
</span><span class=lnt id=hl-18-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-18>18</a>
</span><span class=lnt id=hl-18-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-19>19</a>
</span><span class=lnt id=hl-18-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-20>20</a>
</span><span class=lnt id=hl-18-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-21>21</a>
</span><span class=lnt id=hl-18-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-22>22</a>
</span><span class=lnt id=hl-18-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-23>23</a>
</span><span class=lnt id=hl-18-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-24>24</a>
</span><span class=lnt id=hl-18-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-25>25</a>
</span><span class=lnt id=hl-18-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-26>26</a>
</span><span class=lnt id=hl-18-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-27>27</a>
</span><span class=lnt id=hl-18-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-28>28</a>
</span><span class=lnt id=hl-18-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-29>29</a>
</span><span class=lnt id=hl-18-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-30>30</a>
</span><span class=lnt id=hl-18-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-31>31</a>
</span><span class=lnt id=hl-18-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-32>32</a>
</span><span class=lnt id=hl-18-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-33>33</a>
</span><span class=lnt id=hl-18-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-34>34</a>
</span><span class=lnt id=hl-18-35><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-35>35</a>
</span><span class=lnt id=hl-18-36><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-36>36</a>
</span><span class=lnt id=hl-18-37><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-37>37</a>
</span><span class=lnt id=hl-18-38><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-38>38</a>
</span><span class=lnt id=hl-18-39><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-39>39</a>
</span><span class=lnt id=hl-18-40><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-40>40</a>
</span><span class=lnt id=hl-18-41><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-41>41</a>
</span><span class=lnt id=hl-18-42><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-42>42</a>
</span><span class=lnt id=hl-18-43><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-43>43</a>
</span><span class=lnt id=hl-18-44><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-44>44</a>
</span><span class=lnt id=hl-18-45><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-45>45</a>
</span><span class=lnt id=hl-18-46><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-46>46</a>
</span><span class=lnt id=hl-18-47><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-47>47</a>
</span><span class=lnt id=hl-18-48><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-48>48</a>
</span><span class=lnt id=hl-18-49><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-49>49</a>
</span><span class=lnt id=hl-18-50><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-50>50</a>
</span><span class=lnt id=hl-18-51><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-51>51</a>
</span><span class=lnt id=hl-18-52><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-52>52</a>
</span><span class=lnt id=hl-18-53><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-53>53</a>
</span><span class=lnt id=hl-18-54><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-54>54</a>
</span><span class=lnt id=hl-18-55><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-55>55</a>
</span><span class=lnt id=hl-18-56><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-56>56</a>
</span><span class=lnt id=hl-18-57><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-57>57</a>
</span><span class=lnt id=hl-18-58><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-58>58</a>
</span><span class=lnt id=hl-18-59><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-59>59</a>
</span><span class=lnt id=hl-18-60><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-60>60</a>
</span><span class=lnt id=hl-18-61><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-61>61</a>
</span><span class=lnt id=hl-18-62><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-62>62</a>
</span><span class=lnt id=hl-18-63><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-63>63</a>
</span><span class=lnt id=hl-18-64><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-64>64</a>
</span><span class=lnt id=hl-18-65><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-65>65</a>
</span><span class=lnt id=hl-18-66><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-66>66</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>14:36:50 [DEBUG] [main] c.i.n.HelloWorldServer - [id: 0xdff439d3] binding...
</span></span><span class=line><span class=cl>14:36:51 [DEBUG] [main] c.i.n.HelloWorldServer - [id: 0xdff439d3, L:/192.168.0.103:9090] bound...
</span></span><span class=line><span class=cl>14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979] REGISTERED
</span></span><span class=line><span class=cl>14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979] ACTIVE
</span></span><span class=line><span class=cl>14:37:10 [DEBUG] [nioEventLoopGroup-3-1] c.i.n.HelloWorldServer - connected [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979]
</span></span><span class=line><span class=cl>14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979] READ: 9B
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 61 61 61 61 61 61 61 61 61                      |aaaaaaaaa       |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979] READ: 9B
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 62 62 62 62 62 62 62 62 62                      |bbbbbbbbb       |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979] READ: 6B
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 63 63 63 63 63 63                               |cccccc          |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979] READ: 8B
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 64 64 64 64 64 64 64 64                         |dddddddd        |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979] READ: 15B
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 65 65 65 65 65 65 65 65 65 65 65 65 65 65 65    |eeeeeeeeeeeeeee |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979] READ: 13B
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 66 66 66 66 66 66 66 66 66 66 66 66 66          |fffffffffffff   |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979] READ: 2B
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 67 67                                           |gg              |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979] READ: 2B
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 68 68                                           |hh              |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979] READ: 14B
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 69 69 69 69 69 69 69 69 69 69 69 69 69 69       |iiiiiiiiiiiiii  |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979] READ: 9B
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 6a 6a 6a 6a 6a 6a 6a 6a 6a                      |jjjjjjjjj       |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979] READ COMPLETE
</span></span></code></pre></td></tr></table></div></div><a href=#2-协议设计与解析><h2 id=2-协议设计与解析><span class=hanchor arialabel=Anchor># </span>2. 协议设计与解析</h2></a><a href=#21-为什么需要协议><h3 id=21-为什么需要协议><span class=hanchor arialabel=Anchor># </span>2.1 为什么需要协议？</h3></a><blockquote><p>TCP/IP 中消息传输基于<strong>流</strong>的方式，<strong>没有边界</strong>。</p></blockquote><p>协议的目的就是划定消息的边界，制定通信双方要共同遵守的通信规则</p><p>例如：在网络上传输</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-19-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>下雨天留客天留我不留
</span></span></code></pre></td></tr></table></div></div><p>是中文一句著名的无标点符号句子，在没有标点符号情况下，这句话有数种拆解方式，而意思却是完全不同，所以常被用作讲述标点符号的重要性</p><p>一种解读</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-20-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-20-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>下雨天留客，天留，我不留
</span></span></code></pre></td></tr></table></div></div><p>另一种解读</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-21-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-21-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>下雨天，留客天，留我不？留
</span></span></code></pre></td></tr></table></div></div><p>如何设计协议呢？其实就是给网络传输的信息加上“标点符号”。但通过分隔符来断句不是很好，因为分隔符本身如果用于传输，那么必须加以区分。因此，下面一种协议较为常用</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-22-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-22-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>定长字节表示内容长度 + 实际内容
</span></span></code></pre></td></tr></table></div></div><p>例如，假设一个中文字符长度为 3，按照上述协议的规则，发送信息方式如下，就不会被接收方弄错意思了</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-23-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>0f下雨天留客06天留09我不留
</span></span></code></pre></td></tr></table></div></div><blockquote><p>小故事</p><p>很久很久以前，一位私塾先生到一家任教。双方签订了一纸协议：“无鸡鸭亦可无鱼肉亦可白菜豆腐不可少不得束修金”。此后，私塾先生虽然认真教课，但主人家则总是给私塾先生以白菜豆腐为菜，丝毫未见鸡鸭鱼肉的款待。私塾先生先是很不解，可是后来也就想通了：主人把鸡鸭鱼肉的钱都会换为束修金的，也罢。至此双方相安无事。</p><p>年关将至，一个学年段亦告结束。私塾先生临行时，也不见主人家为他交付束修金，遂与主家理论。然主家亦振振有词：“有协议为证——无鸡鸭亦可，无鱼肉亦可，白菜豆腐不可少，不得束修金。这白纸黑字明摆着的，你有什么要说的呢？”</p><p>私塾先生据理力争：“协议是这样的——无鸡，鸭亦可；无鱼，肉亦可；白菜豆腐不可，少不得束修金。”</p><p>双方唇枪舌战，你来我往，真个是不亦乐乎！</p><p>这里的束修金，也作“束脩”，应当是泛指教师应当得到的报酬</p></blockquote><a href=#22-redis-协议举例><h3 id=22-redis-协议举例><span class=hanchor arialabel=Anchor># </span>2.2 redis 协议举例</h3></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-24-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-1> 1</a>
</span><span class=lnt id=hl-24-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-2> 2</a>
</span><span class=lnt id=hl-24-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-3> 3</a>
</span><span class=lnt id=hl-24-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-4> 4</a>
</span><span class=lnt id=hl-24-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-5> 5</a>
</span><span class=lnt id=hl-24-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-6> 6</a>
</span><span class=lnt id=hl-24-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-7> 7</a>
</span><span class=lnt id=hl-24-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-8> 8</a>
</span><span class=lnt id=hl-24-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-9> 9</a>
</span><span class=lnt id=hl-24-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-10>10</a>
</span><span class=lnt id=hl-24-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-11>11</a>
</span><span class=lnt id=hl-24-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-12>12</a>
</span><span class=lnt id=hl-24-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-13>13</a>
</span><span class=lnt id=hl-24-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-14>14</a>
</span><span class=lnt id=hl-24-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-15>15</a>
</span><span class=lnt id=hl-24-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-16>16</a>
</span><span class=lnt id=hl-24-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-17>17</a>
</span><span class=lnt id=hl-24-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-18>18</a>
</span><span class=lnt id=hl-24-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-19>19</a>
</span><span class=lnt id=hl-24-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-20>20</a>
</span><span class=lnt id=hl-24-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-21>21</a>
</span><span class=lnt id=hl-24-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-22>22</a>
</span><span class=lnt id=hl-24-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-23>23</a>
</span><span class=lnt id=hl-24-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-24>24</a>
</span><span class=lnt id=hl-24-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-25>25</a>
</span><span class=lnt id=hl-24-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-26>26</a>
</span><span class=lnt id=hl-24-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-27>27</a>
</span><span class=lnt id=hl-24-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-28>28</a>
</span><span class=lnt id=hl-24-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-29>29</a>
</span><span class=lnt id=hl-24-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-30>30</a>
</span><span class=lnt id=hl-24-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-31>31</a>
</span><span class=lnt id=hl-24-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-32>32</a>
</span><span class=lnt id=hl-24-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-33>33</a>
</span><span class=lnt id=hl-24-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-34>34</a>
</span><span class=lnt id=hl-24-35><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-35>35</a>
</span><span class=lnt id=hl-24-36><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-36>36</a>
</span><span class=lnt id=hl-24-37><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-37>37</a>
</span><span class=lnt id=hl-24-38><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-38>38</a>
</span><span class=lnt id=hl-24-39><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-39>39</a>
</span><span class=lnt id=hl-24-40><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-40>40</a>
</span><span class=lnt id=hl-24-41><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-41>41</a>
</span><span class=lnt id=hl-24-42><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-42>42</a>
</span><span class=lnt id=hl-24-43><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-43>43</a>
</span><span class=lnt id=hl-24-44><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-44>44</a>
</span><span class=lnt id=hl-24-45><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-45>45</a>
</span><span class=lnt id=hl-24-46><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-46>46</a>
</span><span class=lnt id=hl-24-47><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-47>47</a>
</span><span class=lnt id=hl-24-48><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-48>48</a>
</span><span class=lnt id=hl-24-49><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-49>49</a>
</span><span class=lnt id=hl-24-50><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-50>50</a>
</span><span class=lnt id=hl-24-51><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-51>51</a>
</span><span class=lnt id=hl-24-52><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-52>52</a>
</span><span class=lnt id=hl-24-53><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-53>53</a>
</span><span class=lnt id=hl-24-54><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-54>54</a>
</span><span class=lnt id=hl-24-55><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-55>55</a>
</span><span class=lnt id=hl-24-56><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-56>56</a>
</span><span class=lnt id=hl-24-57><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-57>57</a>
</span><span class=lnt id=hl-24-58><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-58>58</a>
</span><span class=lnt id=hl-24-59><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-59>59</a>
</span><span class=lnt id=hl-24-60><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-60>60</a>
</span><span class=lnt id=hl-24-61><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-61>61</a>
</span><span class=lnt id=hl-24-62><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-62>62</a>
</span><span class=lnt id=hl-24-63><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-63>63</a>
</span><span class=lnt id=hl-24-64><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-64>64</a>
</span><span class=lnt id=hl-24-65><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-65>65</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>NioEventLoopGroup</span> <span class=n>worker</span> <span class=o>=</span> <span class=k>new</span> <span class=n>NioEventLoopGroup</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=kt>byte</span><span class=o>[]</span> <span class=n>LINE</span> <span class=o>=</span> <span class=o>{</span><span class=n>13</span><span class=o>,</span> <span class=n>10</span><span class=o>};</span>
</span></span><span class=line><span class=cl><span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Bootstrap</span> <span class=n>bootstrap</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Bootstrap</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>bootstrap</span><span class=o>.</span><span class=na>channel</span><span class=o>(</span><span class=n>NioSocketChannel</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>bootstrap</span><span class=o>.</span><span class=na>group</span><span class=o>(</span><span class=n>worker</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>bootstrap</span><span class=o>.</span><span class=na>handler</span><span class=o>(</span><span class=k>new</span> <span class=n>ChannelInitializer</span><span class=o>&lt;</span><span class=n>SocketChannel</span><span class=o>&gt;()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>initChannel</span><span class=o>(</span><span class=n>SocketChannel</span> <span class=n>ch</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>LoggingHandler</span><span class=o>());</span>
</span></span><span class=line><span class=cl>            <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>ChannelInboundHandlerAdapter</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 会在连接 channel 建立成功后，会触发 active 事件
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>                <span class=kd>public</span> <span class=kt>void</span> <span class=nf>channelActive</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>set</span><span class=o>(</span><span class=n>ctx</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>get</span><span class=o>(</span><span class=n>ctx</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=kd>private</span> <span class=kt>void</span> <span class=nf>get</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>ByteBuf</span> <span class=n>buf</span> <span class=o>=</span> <span class=n>ctx</span><span class=o>.</span><span class=na>alloc</span><span class=o>().</span><span class=na>buffer</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                    <span class=n>buf</span><span class=o>.</span><span class=na>writeBytes</span><span class=o>(</span><span class=s>&#34;*2&#34;</span><span class=o>.</span><span class=na>getBytes</span><span class=o>());</span>
</span></span><span class=line><span class=cl>                    <span class=n>buf</span><span class=o>.</span><span class=na>writeBytes</span><span class=o>(</span><span class=n>LINE</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>buf</span><span class=o>.</span><span class=na>writeBytes</span><span class=o>(</span><span class=s>&#34;$3&#34;</span><span class=o>.</span><span class=na>getBytes</span><span class=o>());</span>
</span></span><span class=line><span class=cl>                    <span class=n>buf</span><span class=o>.</span><span class=na>writeBytes</span><span class=o>(</span><span class=n>LINE</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>buf</span><span class=o>.</span><span class=na>writeBytes</span><span class=o>(</span><span class=s>&#34;get&#34;</span><span class=o>.</span><span class=na>getBytes</span><span class=o>());</span>
</span></span><span class=line><span class=cl>                    <span class=n>buf</span><span class=o>.</span><span class=na>writeBytes</span><span class=o>(</span><span class=n>LINE</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>buf</span><span class=o>.</span><span class=na>writeBytes</span><span class=o>(</span><span class=s>&#34;$3&#34;</span><span class=o>.</span><span class=na>getBytes</span><span class=o>());</span>
</span></span><span class=line><span class=cl>                    <span class=n>buf</span><span class=o>.</span><span class=na>writeBytes</span><span class=o>(</span><span class=n>LINE</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>buf</span><span class=o>.</span><span class=na>writeBytes</span><span class=o>(</span><span class=s>&#34;aaa&#34;</span><span class=o>.</span><span class=na>getBytes</span><span class=o>());</span>
</span></span><span class=line><span class=cl>                    <span class=n>buf</span><span class=o>.</span><span class=na>writeBytes</span><span class=o>(</span><span class=n>LINE</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>ctx</span><span class=o>.</span><span class=na>writeAndFlush</span><span class=o>(</span><span class=n>buf</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=kd>private</span> <span class=kt>void</span> <span class=nf>set</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>ByteBuf</span> <span class=n>buf</span> <span class=o>=</span> <span class=n>ctx</span><span class=o>.</span><span class=na>alloc</span><span class=o>().</span><span class=na>buffer</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                    <span class=n>buf</span><span class=o>.</span><span class=na>writeBytes</span><span class=o>(</span><span class=s>&#34;*3&#34;</span><span class=o>.</span><span class=na>getBytes</span><span class=o>());</span>
</span></span><span class=line><span class=cl>                    <span class=n>buf</span><span class=o>.</span><span class=na>writeBytes</span><span class=o>(</span><span class=n>LINE</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>buf</span><span class=o>.</span><span class=na>writeBytes</span><span class=o>(</span><span class=s>&#34;$3&#34;</span><span class=o>.</span><span class=na>getBytes</span><span class=o>());</span>
</span></span><span class=line><span class=cl>                    <span class=n>buf</span><span class=o>.</span><span class=na>writeBytes</span><span class=o>(</span><span class=n>LINE</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>buf</span><span class=o>.</span><span class=na>writeBytes</span><span class=o>(</span><span class=s>&#34;set&#34;</span><span class=o>.</span><span class=na>getBytes</span><span class=o>());</span>
</span></span><span class=line><span class=cl>                    <span class=n>buf</span><span class=o>.</span><span class=na>writeBytes</span><span class=o>(</span><span class=n>LINE</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>buf</span><span class=o>.</span><span class=na>writeBytes</span><span class=o>(</span><span class=s>&#34;$3&#34;</span><span class=o>.</span><span class=na>getBytes</span><span class=o>());</span>
</span></span><span class=line><span class=cl>                    <span class=n>buf</span><span class=o>.</span><span class=na>writeBytes</span><span class=o>(</span><span class=n>LINE</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>buf</span><span class=o>.</span><span class=na>writeBytes</span><span class=o>(</span><span class=s>&#34;aaa&#34;</span><span class=o>.</span><span class=na>getBytes</span><span class=o>());</span>
</span></span><span class=line><span class=cl>                    <span class=n>buf</span><span class=o>.</span><span class=na>writeBytes</span><span class=o>(</span><span class=n>LINE</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>buf</span><span class=o>.</span><span class=na>writeBytes</span><span class=o>(</span><span class=s>&#34;$3&#34;</span><span class=o>.</span><span class=na>getBytes</span><span class=o>());</span>
</span></span><span class=line><span class=cl>                    <span class=n>buf</span><span class=o>.</span><span class=na>writeBytes</span><span class=o>(</span><span class=n>LINE</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>buf</span><span class=o>.</span><span class=na>writeBytes</span><span class=o>(</span><span class=s>&#34;bbb&#34;</span><span class=o>.</span><span class=na>getBytes</span><span class=o>());</span>
</span></span><span class=line><span class=cl>                    <span class=n>buf</span><span class=o>.</span><span class=na>writeBytes</span><span class=o>(</span><span class=n>LINE</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>ctx</span><span class=o>.</span><span class=na>writeAndFlush</span><span class=o>(</span><span class=n>buf</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>                <span class=kd>public</span> <span class=kt>void</span> <span class=nf>channelRead</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>,</span> <span class=n>Object</span> <span class=n>msg</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>ByteBuf</span> <span class=n>buf</span> <span class=o>=</span> <span class=o>(</span><span class=n>ByteBuf</span><span class=o>)</span> <span class=n>msg</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>buf</span><span class=o>.</span><span class=na>toString</span><span class=o>(</span><span class=n>Charset</span><span class=o>.</span><span class=na>defaultCharset</span><span class=o>()));</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>});</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>});</span>
</span></span><span class=line><span class=cl>    <span class=n>ChannelFuture</span> <span class=n>channelFuture</span> <span class=o>=</span> <span class=n>bootstrap</span><span class=o>.</span><span class=na>connect</span><span class=o>(</span><span class=s>&#34;localhost&#34;</span><span class=o>,</span> <span class=n>6379</span><span class=o>).</span><span class=na>sync</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>channelFuture</span><span class=o>.</span><span class=na>channel</span><span class=o>().</span><span class=na>closeFuture</span><span class=o>().</span><span class=na>sync</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>log</span><span class=o>.</span><span class=na>error</span><span class=o>(</span><span class=s>&#34;client error&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>worker</span><span class=o>.</span><span class=na>shutdownGracefully</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#23-http-协议举例><h3 id=23-http-协议举例><span class=hanchor arialabel=Anchor># </span>2.3 http 协议举例</h3></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-25-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-1> 1</a>
</span><span class=lnt id=hl-25-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-2> 2</a>
</span><span class=lnt id=hl-25-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-3> 3</a>
</span><span class=lnt id=hl-25-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-4> 4</a>
</span><span class=lnt id=hl-25-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-5> 5</a>
</span><span class=lnt id=hl-25-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-6> 6</a>
</span><span class=lnt id=hl-25-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-7> 7</a>
</span><span class=lnt id=hl-25-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-8> 8</a>
</span><span class=lnt id=hl-25-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-9> 9</a>
</span><span class=lnt id=hl-25-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-10>10</a>
</span><span class=lnt id=hl-25-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-11>11</a>
</span><span class=lnt id=hl-25-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-12>12</a>
</span><span class=lnt id=hl-25-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-13>13</a>
</span><span class=lnt id=hl-25-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-14>14</a>
</span><span class=lnt id=hl-25-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-15>15</a>
</span><span class=lnt id=hl-25-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-16>16</a>
</span><span class=lnt id=hl-25-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-17>17</a>
</span><span class=lnt id=hl-25-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-18>18</a>
</span><span class=lnt id=hl-25-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-19>19</a>
</span><span class=lnt id=hl-25-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-20>20</a>
</span><span class=lnt id=hl-25-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-21>21</a>
</span><span class=lnt id=hl-25-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-22>22</a>
</span><span class=lnt id=hl-25-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-23>23</a>
</span><span class=lnt id=hl-25-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-24>24</a>
</span><span class=lnt id=hl-25-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-25>25</a>
</span><span class=lnt id=hl-25-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-26>26</a>
</span><span class=lnt id=hl-25-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-27>27</a>
</span><span class=lnt id=hl-25-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-28>28</a>
</span><span class=lnt id=hl-25-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-29>29</a>
</span><span class=lnt id=hl-25-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-30>30</a>
</span><span class=lnt id=hl-25-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-31>31</a>
</span><span class=lnt id=hl-25-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-32>32</a>
</span><span class=lnt id=hl-25-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-33>33</a>
</span><span class=lnt id=hl-25-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-34>34</a>
</span><span class=lnt id=hl-25-35><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-35>35</a>
</span><span class=lnt id=hl-25-36><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-36>36</a>
</span><span class=lnt id=hl-25-37><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-37>37</a>
</span><span class=lnt id=hl-25-38><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-38>38</a>
</span><span class=lnt id=hl-25-39><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-39>39</a>
</span><span class=lnt id=hl-25-40><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-40>40</a>
</span><span class=lnt id=hl-25-41><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-41>41</a>
</span><span class=lnt id=hl-25-42><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-42>42</a>
</span><span class=lnt id=hl-25-43><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-43>43</a>
</span><span class=lnt id=hl-25-44><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-44>44</a>
</span><span class=lnt id=hl-25-45><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-45>45</a>
</span><span class=lnt id=hl-25-46><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-46>46</a>
</span><span class=lnt id=hl-25-47><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-47>47</a>
</span><span class=lnt id=hl-25-48><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-48>48</a>
</span><span class=lnt id=hl-25-49><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-49>49</a>
</span><span class=lnt id=hl-25-50><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-50>50</a>
</span><span class=lnt id=hl-25-51><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-51>51</a>
</span><span class=lnt id=hl-25-52><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-52>52</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>NioEventLoopGroup</span> <span class=n>boss</span> <span class=o>=</span> <span class=k>new</span> <span class=n>NioEventLoopGroup</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=n>NioEventLoopGroup</span> <span class=n>worker</span> <span class=o>=</span> <span class=k>new</span> <span class=n>NioEventLoopGroup</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ServerBootstrap</span> <span class=n>serverBootstrap</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ServerBootstrap</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>serverBootstrap</span><span class=o>.</span><span class=na>channel</span><span class=o>(</span><span class=n>NioServerSocketChannel</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>serverBootstrap</span><span class=o>.</span><span class=na>group</span><span class=o>(</span><span class=n>boss</span><span class=o>,</span> <span class=n>worker</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>serverBootstrap</span><span class=o>.</span><span class=na>childHandler</span><span class=o>(</span><span class=k>new</span> <span class=n>ChannelInitializer</span><span class=o>&lt;</span><span class=n>SocketChannel</span><span class=o>&gt;()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>initChannel</span><span class=o>(</span><span class=n>SocketChannel</span> <span class=n>ch</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>LoggingHandler</span><span class=o>(</span><span class=n>LogLevel</span><span class=o>.</span><span class=na>DEBUG</span><span class=o>));</span>
</span></span><span class=line><span class=cl>            <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>HttpServerCodec</span><span class=o>());</span>
</span></span><span class=line><span class=cl>            <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>SimpleChannelInboundHandler</span><span class=o>&lt;</span><span class=n>HttpRequest</span><span class=o>&gt;()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>                <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>channelRead0</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>,</span> <span class=n>HttpRequest</span> <span class=n>msg</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=c1>// 获取请求
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=n>msg</span><span class=o>.</span><span class=na>uri</span><span class=o>());</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                    <span class=c1>// 返回响应
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=n>DefaultFullHttpResponse</span> <span class=n>response</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>                            <span class=k>new</span> <span class=n>DefaultFullHttpResponse</span><span class=o>(</span><span class=n>msg</span><span class=o>.</span><span class=na>protocolVersion</span><span class=o>(),</span> <span class=n>HttpResponseStatus</span><span class=o>.</span><span class=na>OK</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                    <span class=kt>byte</span><span class=o>[]</span> <span class=n>bytes</span> <span class=o>=</span> <span class=s>&#34;&lt;h1&gt;Hello, world!&lt;/h1&gt;&#34;</span><span class=o>.</span><span class=na>getBytes</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                    <span class=n>response</span><span class=o>.</span><span class=na>headers</span><span class=o>().</span><span class=na>setInt</span><span class=o>(</span><span class=n>CONTENT_LENGTH</span><span class=o>,</span> <span class=n>bytes</span><span class=o>.</span><span class=na>length</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>response</span><span class=o>.</span><span class=na>content</span><span class=o>().</span><span class=na>writeBytes</span><span class=o>(</span><span class=n>bytes</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                    <span class=c1>// 写回响应
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=n>ctx</span><span class=o>.</span><span class=na>writeAndFlush</span><span class=o>(</span><span class=n>response</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>});</span>
</span></span><span class=line><span class=cl>            <span class=cm>/*ch.pipeline().addLast(new ChannelInboundHandlerAdapter() {
</span></span></span><span class=line><span class=cl><span class=cm>                @Override
</span></span></span><span class=line><span class=cl><span class=cm>                public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception {
</span></span></span><span class=line><span class=cl><span class=cm>                    log.debug(&#34;{}&#34;, msg.getClass());
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>                    if (msg instanceof HttpRequest) { // 请求行，请求头
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>                    } else if (msg instanceof HttpContent) { //请求体
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>                    }
</span></span></span><span class=line><span class=cl><span class=cm>                }
</span></span></span><span class=line><span class=cl><span class=cm>            });*/</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>});</span>
</span></span><span class=line><span class=cl>    <span class=n>ChannelFuture</span> <span class=n>channelFuture</span> <span class=o>=</span> <span class=n>serverBootstrap</span><span class=o>.</span><span class=na>bind</span><span class=o>(</span><span class=n>8080</span><span class=o>).</span><span class=na>sync</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>channelFuture</span><span class=o>.</span><span class=na>channel</span><span class=o>().</span><span class=na>closeFuture</span><span class=o>().</span><span class=na>sync</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>log</span><span class=o>.</span><span class=na>error</span><span class=o>(</span><span class=s>&#34;server error&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>boss</span><span class=o>.</span><span class=na>shutdownGracefully</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>worker</span><span class=o>.</span><span class=na>shutdownGracefully</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#24-自定义协议要素><h3 id=24-自定义协议要素><span class=hanchor arialabel=Anchor># </span>2.4 自定义协议要素</h3></a><ul><li>魔数，用来在第一时间判定是否是无效数据包</li><li>版本号，可以支持协议的升级</li><li>序列化算法，消息正文到底采用哪种序列化反序列化方式，可以由此扩展，例如：json、protobuf、hessian、jdk（性能差、非跨平台）</li><li>指令类型，是登录、注册、单聊、群聊&mldr; 跟业务相关</li><li>请求序号，为了双工通信，</li><li>正文长度</li><li>消息正文</li></ul><a href=#编解码器><h4 id=编解码器><span class=hanchor arialabel=Anchor># </span>编解码器</h4></a><p>根据上面的要素，设计一个登录请求消息和登录响应消息，并使用 Netty 完成收发</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-26-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-1> 1</a>
</span><span class=lnt id=hl-26-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-2> 2</a>
</span><span class=lnt id=hl-26-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-3> 3</a>
</span><span class=lnt id=hl-26-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-4> 4</a>
</span><span class=lnt id=hl-26-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-5> 5</a>
</span><span class=lnt id=hl-26-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-6> 6</a>
</span><span class=lnt id=hl-26-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-7> 7</a>
</span><span class=lnt id=hl-26-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-8> 8</a>
</span><span class=lnt id=hl-26-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-9> 9</a>
</span><span class=lnt id=hl-26-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-10>10</a>
</span><span class=lnt id=hl-26-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-11>11</a>
</span><span class=lnt id=hl-26-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-12>12</a>
</span><span class=lnt id=hl-26-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-13>13</a>
</span><span class=lnt id=hl-26-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-14>14</a>
</span><span class=lnt id=hl-26-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-15>15</a>
</span><span class=lnt id=hl-26-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-16>16</a>
</span><span class=lnt id=hl-26-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-17>17</a>
</span><span class=lnt id=hl-26-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-18>18</a>
</span><span class=lnt id=hl-26-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-19>19</a>
</span><span class=lnt id=hl-26-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-20>20</a>
</span><span class=lnt id=hl-26-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-21>21</a>
</span><span class=lnt id=hl-26-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-22>22</a>
</span><span class=lnt id=hl-26-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-23>23</a>
</span><span class=lnt id=hl-26-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-24>24</a>
</span><span class=lnt id=hl-26-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-25>25</a>
</span><span class=lnt id=hl-26-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-26>26</a>
</span><span class=lnt id=hl-26-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-27>27</a>
</span><span class=lnt id=hl-26-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-28>28</a>
</span><span class=lnt id=hl-26-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-29>29</a>
</span><span class=lnt id=hl-26-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-30>30</a>
</span><span class=lnt id=hl-26-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-31>31</a>
</span><span class=lnt id=hl-26-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-32>32</a>
</span><span class=lnt id=hl-26-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-33>33</a>
</span><span class=lnt id=hl-26-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-34>34</a>
</span><span class=lnt id=hl-26-35><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-35>35</a>
</span><span class=lnt id=hl-26-36><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-36>36</a>
</span><span class=lnt id=hl-26-37><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-37>37</a>
</span><span class=lnt id=hl-26-38><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-38>38</a>
</span><span class=lnt id=hl-26-39><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-39>39</a>
</span><span class=lnt id=hl-26-40><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-40>40</a>
</span><span class=lnt id=hl-26-41><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-41>41</a>
</span><span class=lnt id=hl-26-42><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-42>42</a>
</span><span class=lnt id=hl-26-43><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-43>43</a>
</span><span class=lnt id=hl-26-44><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-44>44</a>
</span><span class=lnt id=hl-26-45><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-45>45</a>
</span><span class=lnt id=hl-26-46><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-46>46</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>MessageCodec</span> <span class=kd>extends</span> <span class=n>ByteToMessageCodec</span><span class=o>&lt;</span><span class=n>Message</span><span class=o>&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>encode</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>,</span> <span class=n>Message</span> <span class=n>msg</span><span class=o>,</span> <span class=n>ByteBuf</span> <span class=n>out</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 1. 4 字节的魔数
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>out</span><span class=o>.</span><span class=na>writeBytes</span><span class=o>(</span><span class=k>new</span> <span class=kt>byte</span><span class=o>[]{</span><span class=n>1</span><span class=o>,</span> <span class=n>2</span><span class=o>,</span> <span class=n>3</span><span class=o>,</span> <span class=n>4</span><span class=o>});</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 2. 1 字节的版本,
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>out</span><span class=o>.</span><span class=na>writeByte</span><span class=o>(</span><span class=n>1</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 3. 1 字节的序列化方式 jdk 0 , json 1
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>out</span><span class=o>.</span><span class=na>writeByte</span><span class=o>(</span><span class=n>0</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 4. 1 字节的指令类型
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>out</span><span class=o>.</span><span class=na>writeByte</span><span class=o>(</span><span class=n>msg</span><span class=o>.</span><span class=na>getMessageType</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 5. 4 个字节
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>out</span><span class=o>.</span><span class=na>writeInt</span><span class=o>(</span><span class=n>msg</span><span class=o>.</span><span class=na>getSequenceId</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 无意义，对齐填充
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>out</span><span class=o>.</span><span class=na>writeByte</span><span class=o>(</span><span class=n>0xff</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 6. 获取内容的字节数组
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>ByteArrayOutputStream</span> <span class=n>bos</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ByteArrayOutputStream</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>ObjectOutputStream</span> <span class=n>oos</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ObjectOutputStream</span><span class=o>(</span><span class=n>bos</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>oos</span><span class=o>.</span><span class=na>writeObject</span><span class=o>(</span><span class=n>msg</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=kt>byte</span><span class=o>[]</span> <span class=n>bytes</span> <span class=o>=</span> <span class=n>bos</span><span class=o>.</span><span class=na>toByteArray</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 7. 长度
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>out</span><span class=o>.</span><span class=na>writeInt</span><span class=o>(</span><span class=n>bytes</span><span class=o>.</span><span class=na>length</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 8. 写入内容
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>out</span><span class=o>.</span><span class=na>writeBytes</span><span class=o>(</span><span class=n>bytes</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>decode</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>,</span> <span class=n>ByteBuf</span> <span class=n>in</span><span class=o>,</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span> <span class=n>out</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>magicNum</span> <span class=o>=</span> <span class=n>in</span><span class=o>.</span><span class=na>readInt</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=kt>byte</span> <span class=n>version</span> <span class=o>=</span> <span class=n>in</span><span class=o>.</span><span class=na>readByte</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=kt>byte</span> <span class=n>serializerType</span> <span class=o>=</span> <span class=n>in</span><span class=o>.</span><span class=na>readByte</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=kt>byte</span> <span class=n>messageType</span> <span class=o>=</span> <span class=n>in</span><span class=o>.</span><span class=na>readByte</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>sequenceId</span> <span class=o>=</span> <span class=n>in</span><span class=o>.</span><span class=na>readInt</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>in</span><span class=o>.</span><span class=na>readByte</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>length</span> <span class=o>=</span> <span class=n>in</span><span class=o>.</span><span class=na>readInt</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=kt>byte</span><span class=o>[]</span> <span class=n>bytes</span> <span class=o>=</span> <span class=k>new</span> <span class=kt>byte</span><span class=o>[</span><span class=n>length</span><span class=o>];</span>
</span></span><span class=line><span class=cl>        <span class=n>in</span><span class=o>.</span><span class=na>readBytes</span><span class=o>(</span><span class=n>bytes</span><span class=o>,</span> <span class=n>0</span><span class=o>,</span> <span class=n>length</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>ObjectInputStream</span> <span class=n>ois</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ObjectInputStream</span><span class=o>(</span><span class=k>new</span> <span class=n>ByteArrayInputStream</span><span class=o>(</span><span class=n>bytes</span><span class=o>));</span>
</span></span><span class=line><span class=cl>        <span class=n>Message</span> <span class=n>message</span> <span class=o>=</span> <span class=o>(</span><span class=n>Message</span><span class=o>)</span> <span class=n>ois</span><span class=o>.</span><span class=na>readObject</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;{}, {}, {}, {}, {}, {}&#34;</span><span class=o>,</span> <span class=n>magicNum</span><span class=o>,</span> <span class=n>version</span><span class=o>,</span> <span class=n>serializerType</span><span class=o>,</span> <span class=n>messageType</span><span class=o>,</span> <span class=n>sequenceId</span><span class=o>,</span> <span class=n>length</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;{}&#34;</span><span class=o>,</span> <span class=n>message</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>out</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>message</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>测试</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-27-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-27-1> 1</a>
</span><span class=lnt id=hl-27-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-27-2> 2</a>
</span><span class=lnt id=hl-27-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-27-3> 3</a>
</span><span class=lnt id=hl-27-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-27-4> 4</a>
</span><span class=lnt id=hl-27-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-27-5> 5</a>
</span><span class=lnt id=hl-27-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-27-6> 6</a>
</span><span class=lnt id=hl-27-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-27-7> 7</a>
</span><span class=lnt id=hl-27-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-27-8> 8</a>
</span><span class=lnt id=hl-27-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-27-9> 9</a>
</span><span class=lnt id=hl-27-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-27-10>10</a>
</span><span class=lnt id=hl-27-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-27-11>11</a>
</span><span class=lnt id=hl-27-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-27-12>12</a>
</span><span class=lnt id=hl-27-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-27-13>13</a>
</span><span class=lnt id=hl-27-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-27-14>14</a>
</span><span class=lnt id=hl-27-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-27-15>15</a>
</span><span class=lnt id=hl-27-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-27-16>16</a>
</span><span class=lnt id=hl-27-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-27-17>17</a>
</span><span class=lnt id=hl-27-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-27-18>18</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>EmbeddedChannel</span> <span class=n>channel</span> <span class=o>=</span> <span class=k>new</span> <span class=n>EmbeddedChannel</span><span class=o>(</span>
</span></span><span class=line><span class=cl>    <span class=k>new</span> <span class=n>LoggingHandler</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>    <span class=k>new</span> <span class=n>LengthFieldBasedFrameDecoder</span><span class=o>(</span>
</span></span><span class=line><span class=cl>        <span class=n>1024</span><span class=o>,</span> <span class=n>12</span><span class=o>,</span> <span class=n>4</span><span class=o>,</span> <span class=n>0</span><span class=o>,</span> <span class=n>0</span><span class=o>),</span>
</span></span><span class=line><span class=cl>    <span class=k>new</span> <span class=n>MessageCodec</span><span class=o>()</span>
</span></span><span class=line><span class=cl><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=c1>// encode
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>LoginRequestMessage</span> <span class=n>message</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LoginRequestMessage</span><span class=o>(</span><span class=s>&#34;zhangsan&#34;</span><span class=o>,</span> <span class=s>&#34;123&#34;</span><span class=o>,</span> <span class=s>&#34;张三&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=c1>//        channel.writeOutbound(message);
</span></span></span><span class=line><span class=cl><span class=c1>// decode
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>ByteBuf</span> <span class=n>buf</span> <span class=o>=</span> <span class=n>ByteBufAllocator</span><span class=o>.</span><span class=na>DEFAULT</span><span class=o>.</span><span class=na>buffer</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=k>new</span> <span class=n>MessageCodec</span><span class=o>().</span><span class=na>encode</span><span class=o>(</span><span class=kc>null</span><span class=o>,</span> <span class=n>message</span><span class=o>,</span> <span class=n>buf</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ByteBuf</span> <span class=n>s1</span> <span class=o>=</span> <span class=n>buf</span><span class=o>.</span><span class=na>slice</span><span class=o>(</span><span class=n>0</span><span class=o>,</span> <span class=n>100</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>ByteBuf</span> <span class=n>s2</span> <span class=o>=</span> <span class=n>buf</span><span class=o>.</span><span class=na>slice</span><span class=o>(</span><span class=n>100</span><span class=o>,</span> <span class=n>buf</span><span class=o>.</span><span class=na>readableBytes</span><span class=o>()</span> <span class=o>-</span> <span class=n>100</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>s1</span><span class=o>.</span><span class=na>retain</span><span class=o>();</span> <span class=c1>// 引用计数 2
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>channel</span><span class=o>.</span><span class=na>writeInbound</span><span class=o>(</span><span class=n>s1</span><span class=o>);</span> <span class=c1>// release 1
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>channel</span><span class=o>.</span><span class=na>writeInbound</span><span class=o>(</span><span class=n>s2</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><p>解读</p><p><img src=/z-oblib/z2-attachments/0013.png width=auto></p><a href=#注意半包><h5 id=注意半包><span class=hanchor arialabel=Anchor># </span>注意半包</h5></a><p>虽然协议指定了数据长度，可以解决粘包问题，但是半包问题还要注意：
如果半包了，那么handler就不应该继续往下处理，因为此时反序列化会失败（实际长度小于指定长度，越界读）。
需要先用帧解码器包装包的完整性。</p><a href=#-什么时候可以加-sharable><h4 id=-什么时候可以加-sharable><span class=hanchor arialabel=Anchor># </span>💡 什么时候可以加 @Sharable</h4></a><ul><li>当 handler <strong>不保存状态</strong>（成员变量）时，就可以安全地在多线程下被共享（例如LoggingHandler可以共享，LengthFieldBasedFrameDecoder不能共享）。</li><li>但要注意对于编解码器类，不能继承 ByteToMessageCodec 或 CombinedChannelDuplexHandler 父类，他们的构造方法对 @Sharable 有限制<ul><li>netty认为你如果继承了这两个父类，那么你就应该是会保存状态的（不管你实际上是否这么做了）</li></ul></li><li>如果能确保编解码器<strong>不会</strong>保存状态，可以继承 MessageToMessageCodec 父类</li></ul><blockquote><p>Byte代表raw的数据，可能不完整，Message代表是一条完整的消息了。</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-28-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-1> 1</a>
</span><span class=lnt id=hl-28-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-2> 2</a>
</span><span class=lnt id=hl-28-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-3> 3</a>
</span><span class=lnt id=hl-28-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-4> 4</a>
</span><span class=lnt id=hl-28-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-5> 5</a>
</span><span class=lnt id=hl-28-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-6> 6</a>
</span><span class=lnt id=hl-28-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-7> 7</a>
</span><span class=lnt id=hl-28-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-8> 8</a>
</span><span class=lnt id=hl-28-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-9> 9</a>
</span><span class=lnt id=hl-28-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-10>10</a>
</span><span class=lnt id=hl-28-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-11>11</a>
</span><span class=lnt id=hl-28-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-12>12</a>
</span><span class=lnt id=hl-28-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-13>13</a>
</span><span class=lnt id=hl-28-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-14>14</a>
</span><span class=lnt id=hl-28-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-15>15</a>
</span><span class=lnt id=hl-28-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-16>16</a>
</span><span class=lnt id=hl-28-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-17>17</a>
</span><span class=lnt id=hl-28-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-18>18</a>
</span><span class=lnt id=hl-28-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-19>19</a>
</span><span class=lnt id=hl-28-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-20>20</a>
</span><span class=lnt id=hl-28-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-21>21</a>
</span><span class=lnt id=hl-28-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-22>22</a>
</span><span class=lnt id=hl-28-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-23>23</a>
</span><span class=lnt id=hl-28-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-24>24</a>
</span><span class=lnt id=hl-28-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-25>25</a>
</span><span class=lnt id=hl-28-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-26>26</a>
</span><span class=lnt id=hl-28-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-27>27</a>
</span><span class=lnt id=hl-28-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-28>28</a>
</span><span class=lnt id=hl-28-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-29>29</a>
</span><span class=lnt id=hl-28-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-30>30</a>
</span><span class=lnt id=hl-28-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-31>31</a>
</span><span class=lnt id=hl-28-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-32>32</a>
</span><span class=lnt id=hl-28-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-33>33</a>
</span><span class=lnt id=hl-28-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-34>34</a>
</span><span class=lnt id=hl-28-35><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-35>35</a>
</span><span class=lnt id=hl-28-36><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-36>36</a>
</span><span class=lnt id=hl-28-37><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-37>37</a>
</span><span class=lnt id=hl-28-38><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-38>38</a>
</span><span class=lnt id=hl-28-39><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-39>39</a>
</span><span class=lnt id=hl-28-40><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-40>40</a>
</span><span class=lnt id=hl-28-41><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-41>41</a>
</span><span class=lnt id=hl-28-42><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-42>42</a>
</span><span class=lnt id=hl-28-43><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-43>43</a>
</span><span class=lnt id=hl-28-44><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-44>44</a>
</span><span class=lnt id=hl-28-45><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-45>45</a>
</span><span class=lnt id=hl-28-46><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-46>46</a>
</span><span class=lnt id=hl-28-47><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-47>47</a>
</span><span class=lnt id=hl-28-48><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-48>48</a>
</span><span class=lnt id=hl-28-49><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-49>49</a>
</span><span class=lnt id=hl-28-50><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-50>50</a>
</span><span class=lnt id=hl-28-51><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-51>51</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span>
</span></span><span class=line><span class=cl><span class=nd>@ChannelHandler.Sharable</span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * 必须和 LengthFieldBasedFrameDecoder 一起使用，确保接到的 ByteBuf 消息是完整的
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>MessageCodecSharable</span> <span class=kd>extends</span> <span class=n>MessageToMessageCodec</span><span class=o>&lt;</span><span class=n>ByteBuf</span><span class=o>,</span> <span class=n>Message</span><span class=o>&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>encode</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>,</span> <span class=n>Message</span> <span class=n>msg</span><span class=o>,</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span> <span class=n>outList</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ByteBuf</span> <span class=n>out</span> <span class=o>=</span> <span class=n>ctx</span><span class=o>.</span><span class=na>alloc</span><span class=o>().</span><span class=na>buffer</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 1. 4 字节的魔数
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>out</span><span class=o>.</span><span class=na>writeBytes</span><span class=o>(</span><span class=k>new</span> <span class=kt>byte</span><span class=o>[]{</span><span class=n>1</span><span class=o>,</span> <span class=n>2</span><span class=o>,</span> <span class=n>3</span><span class=o>,</span> <span class=n>4</span><span class=o>});</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 2. 1 字节的版本,
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>out</span><span class=o>.</span><span class=na>writeByte</span><span class=o>(</span><span class=n>1</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 3. 1 字节的序列化方式 jdk 0 , json 1
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>out</span><span class=o>.</span><span class=na>writeByte</span><span class=o>(</span><span class=n>0</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 4. 1 字节的指令类型
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>out</span><span class=o>.</span><span class=na>writeByte</span><span class=o>(</span><span class=n>msg</span><span class=o>.</span><span class=na>getMessageType</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 5. 4 个字节
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>out</span><span class=o>.</span><span class=na>writeInt</span><span class=o>(</span><span class=n>msg</span><span class=o>.</span><span class=na>getSequenceId</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 无意义，对齐填充
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>out</span><span class=o>.</span><span class=na>writeByte</span><span class=o>(</span><span class=n>0xff</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 6. 获取内容的字节数组
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>ByteArrayOutputStream</span> <span class=n>bos</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ByteArrayOutputStream</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>ObjectOutputStream</span> <span class=n>oos</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ObjectOutputStream</span><span class=o>(</span><span class=n>bos</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>oos</span><span class=o>.</span><span class=na>writeObject</span><span class=o>(</span><span class=n>msg</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=kt>byte</span><span class=o>[]</span> <span class=n>bytes</span> <span class=o>=</span> <span class=n>bos</span><span class=o>.</span><span class=na>toByteArray</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 7. 长度
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>out</span><span class=o>.</span><span class=na>writeInt</span><span class=o>(</span><span class=n>bytes</span><span class=o>.</span><span class=na>length</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 8. 写入内容
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>out</span><span class=o>.</span><span class=na>writeBytes</span><span class=o>(</span><span class=n>bytes</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>outList</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>out</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>decode</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>,</span> <span class=n>ByteBuf</span> <span class=n>in</span><span class=o>,</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span> <span class=n>out</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>magicNum</span> <span class=o>=</span> <span class=n>in</span><span class=o>.</span><span class=na>readInt</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=kt>byte</span> <span class=n>version</span> <span class=o>=</span> <span class=n>in</span><span class=o>.</span><span class=na>readByte</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=kt>byte</span> <span class=n>serializerType</span> <span class=o>=</span> <span class=n>in</span><span class=o>.</span><span class=na>readByte</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=kt>byte</span> <span class=n>messageType</span> <span class=o>=</span> <span class=n>in</span><span class=o>.</span><span class=na>readByte</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>sequenceId</span> <span class=o>=</span> <span class=n>in</span><span class=o>.</span><span class=na>readInt</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>in</span><span class=o>.</span><span class=na>readByte</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>length</span> <span class=o>=</span> <span class=n>in</span><span class=o>.</span><span class=na>readInt</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=kt>byte</span><span class=o>[]</span> <span class=n>bytes</span> <span class=o>=</span> <span class=k>new</span> <span class=kt>byte</span><span class=o>[</span><span class=n>length</span><span class=o>];</span>
</span></span><span class=line><span class=cl>        <span class=n>in</span><span class=o>.</span><span class=na>readBytes</span><span class=o>(</span><span class=n>bytes</span><span class=o>,</span> <span class=n>0</span><span class=o>,</span> <span class=n>length</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>ObjectInputStream</span> <span class=n>ois</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ObjectInputStream</span><span class=o>(</span><span class=k>new</span> <span class=n>ByteArrayInputStream</span><span class=o>(</span><span class=n>bytes</span><span class=o>));</span>
</span></span><span class=line><span class=cl>        <span class=n>Message</span> <span class=n>message</span> <span class=o>=</span> <span class=o>(</span><span class=n>Message</span><span class=o>)</span> <span class=n>ois</span><span class=o>.</span><span class=na>readObject</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;{}, {}, {}, {}, {}, {}&#34;</span><span class=o>,</span> <span class=n>magicNum</span><span class=o>,</span> <span class=n>version</span><span class=o>,</span> <span class=n>serializerType</span><span class=o>,</span> <span class=n>messageType</span><span class=o>,</span> <span class=n>sequenceId</span><span class=o>,</span> <span class=n>length</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;{}&#34;</span><span class=o>,</span> <span class=n>message</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>out</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>message</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#3-聊天室案例><h2 id=3-聊天室案例><span class=hanchor arialabel=Anchor># </span>3. 聊天室案例</h2></a><a href=#31-聊天室业务介绍><h3 id=31-聊天室业务介绍><span class=hanchor arialabel=Anchor># </span>3.1 聊天室业务介绍</h3></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-29-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-29-1> 1</a>
</span><span class=lnt id=hl-29-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-29-2> 2</a>
</span><span class=lnt id=hl-29-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-29-3> 3</a>
</span><span class=lnt id=hl-29-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-29-4> 4</a>
</span><span class=lnt id=hl-29-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-29-5> 5</a>
</span><span class=lnt id=hl-29-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-29-6> 6</a>
</span><span class=lnt id=hl-29-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-29-7> 7</a>
</span><span class=lnt id=hl-29-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-29-8> 8</a>
</span><span class=lnt id=hl-29-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-29-9> 9</a>
</span><span class=lnt id=hl-29-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-29-10>10</a>
</span><span class=lnt id=hl-29-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-29-11>11</a>
</span><span class=lnt id=hl-29-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-29-12>12</a>
</span><span class=lnt id=hl-29-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-29-13>13</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * 用户管理接口
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>interface</span> <span class=nc>UserService</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 登录
</span></span></span><span class=line><span class=cl><span class=cm>     * @param username 用户名
</span></span></span><span class=line><span class=cl><span class=cm>     * @param password 密码
</span></span></span><span class=line><span class=cl><span class=cm>     * @return 登录成功返回 true, 否则返回 false
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kt>boolean</span> <span class=nf>login</span><span class=o>(</span><span class=n>String</span> <span class=n>username</span><span class=o>,</span> <span class=n>String</span> <span class=n>password</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-30-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-1> 1</a>
</span><span class=lnt id=hl-30-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-2> 2</a>
</span><span class=lnt id=hl-30-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-3> 3</a>
</span><span class=lnt id=hl-30-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-4> 4</a>
</span><span class=lnt id=hl-30-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-5> 5</a>
</span><span class=lnt id=hl-30-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-6> 6</a>
</span><span class=lnt id=hl-30-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-7> 7</a>
</span><span class=lnt id=hl-30-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-8> 8</a>
</span><span class=lnt id=hl-30-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-9> 9</a>
</span><span class=lnt id=hl-30-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-10>10</a>
</span><span class=lnt id=hl-30-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-11>11</a>
</span><span class=lnt id=hl-30-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-12>12</a>
</span><span class=lnt id=hl-30-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-13>13</a>
</span><span class=lnt id=hl-30-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-14>14</a>
</span><span class=lnt id=hl-30-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-15>15</a>
</span><span class=lnt id=hl-30-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-16>16</a>
</span><span class=lnt id=hl-30-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-17>17</a>
</span><span class=lnt id=hl-30-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-18>18</a>
</span><span class=lnt id=hl-30-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-19>19</a>
</span><span class=lnt id=hl-30-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-20>20</a>
</span><span class=lnt id=hl-30-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-21>21</a>
</span><span class=lnt id=hl-30-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-22>22</a>
</span><span class=lnt id=hl-30-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-23>23</a>
</span><span class=lnt id=hl-30-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-24>24</a>
</span><span class=lnt id=hl-30-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-25>25</a>
</span><span class=lnt id=hl-30-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-26>26</a>
</span><span class=lnt id=hl-30-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-27>27</a>
</span><span class=lnt id=hl-30-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-28>28</a>
</span><span class=lnt id=hl-30-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-29>29</a>
</span><span class=lnt id=hl-30-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-30>30</a>
</span><span class=lnt id=hl-30-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-31>31</a>
</span><span class=lnt id=hl-30-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-32>32</a>
</span><span class=lnt id=hl-30-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-33>33</a>
</span><span class=lnt id=hl-30-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-34>34</a>
</span><span class=lnt id=hl-30-35><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-35>35</a>
</span><span class=lnt id=hl-30-36><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-36>36</a>
</span><span class=lnt id=hl-30-37><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-37>37</a>
</span><span class=lnt id=hl-30-38><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-38>38</a>
</span><span class=lnt id=hl-30-39><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-39>39</a>
</span><span class=lnt id=hl-30-40><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-40>40</a>
</span><span class=lnt id=hl-30-41><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-41>41</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * 会话管理接口
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>interface</span> <span class=nc>Session</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 绑定会话
</span></span></span><span class=line><span class=cl><span class=cm>     * @param channel 哪个 channel 要绑定会话
</span></span></span><span class=line><span class=cl><span class=cm>     * @param username 会话绑定用户
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=nf>bind</span><span class=o>(</span><span class=n>Channel</span> <span class=n>channel</span><span class=o>,</span> <span class=n>String</span> <span class=n>username</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 解绑会话
</span></span></span><span class=line><span class=cl><span class=cm>     * @param channel 哪个 channel 要解绑会话
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=nf>unbind</span><span class=o>(</span><span class=n>Channel</span> <span class=n>channel</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 获取属性
</span></span></span><span class=line><span class=cl><span class=cm>     * @param channel 哪个 channel
</span></span></span><span class=line><span class=cl><span class=cm>     * @param name 属性名
</span></span></span><span class=line><span class=cl><span class=cm>     * @return 属性值
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=n>Object</span> <span class=nf>getAttribute</span><span class=o>(</span><span class=n>Channel</span> <span class=n>channel</span><span class=o>,</span> <span class=n>String</span> <span class=n>name</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 设置属性
</span></span></span><span class=line><span class=cl><span class=cm>     * @param channel 哪个 channel
</span></span></span><span class=line><span class=cl><span class=cm>     * @param name 属性名
</span></span></span><span class=line><span class=cl><span class=cm>     * @param value 属性值
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=nf>setAttribute</span><span class=o>(</span><span class=n>Channel</span> <span class=n>channel</span><span class=o>,</span> <span class=n>String</span> <span class=n>name</span><span class=o>,</span> <span class=n>Object</span> <span class=n>value</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 根据用户名获取 channel
</span></span></span><span class=line><span class=cl><span class=cm>     * @param username 用户名
</span></span></span><span class=line><span class=cl><span class=cm>     * @return channel
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=n>Channel</span> <span class=nf>getChannel</span><span class=o>(</span><span class=n>String</span> <span class=n>username</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-31-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-31-1> 1</a>
</span><span class=lnt id=hl-31-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-31-2> 2</a>
</span><span class=lnt id=hl-31-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-31-3> 3</a>
</span><span class=lnt id=hl-31-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-31-4> 4</a>
</span><span class=lnt id=hl-31-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-31-5> 5</a>
</span><span class=lnt id=hl-31-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-31-6> 6</a>
</span><span class=lnt id=hl-31-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-31-7> 7</a>
</span><span class=lnt id=hl-31-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-31-8> 8</a>
</span><span class=lnt id=hl-31-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-31-9> 9</a>
</span><span class=lnt id=hl-31-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-31-10>10</a>
</span><span class=lnt id=hl-31-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-31-11>11</a>
</span><span class=lnt id=hl-31-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-31-12>12</a>
</span><span class=lnt id=hl-31-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-31-13>13</a>
</span><span class=lnt id=hl-31-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-31-14>14</a>
</span><span class=lnt id=hl-31-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-31-15>15</a>
</span><span class=lnt id=hl-31-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-31-16>16</a>
</span><span class=lnt id=hl-31-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-31-17>17</a>
</span><span class=lnt id=hl-31-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-31-18>18</a>
</span><span class=lnt id=hl-31-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-31-19>19</a>
</span><span class=lnt id=hl-31-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-31-20>20</a>
</span><span class=lnt id=hl-31-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-31-21>21</a>
</span><span class=lnt id=hl-31-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-31-22>22</a>
</span><span class=lnt id=hl-31-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-31-23>23</a>
</span><span class=lnt id=hl-31-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-31-24>24</a>
</span><span class=lnt id=hl-31-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-31-25>25</a>
</span><span class=lnt id=hl-31-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-31-26>26</a>
</span><span class=lnt id=hl-31-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-31-27>27</a>
</span><span class=lnt id=hl-31-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-31-28>28</a>
</span><span class=lnt id=hl-31-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-31-29>29</a>
</span><span class=lnt id=hl-31-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-31-30>30</a>
</span><span class=lnt id=hl-31-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-31-31>31</a>
</span><span class=lnt id=hl-31-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-31-32>32</a>
</span><span class=lnt id=hl-31-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-31-33>33</a>
</span><span class=lnt id=hl-31-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-31-34>34</a>
</span><span class=lnt id=hl-31-35><a style=outline:none;text-decoration:none;color:inherit href=#hl-31-35>35</a>
</span><span class=lnt id=hl-31-36><a style=outline:none;text-decoration:none;color:inherit href=#hl-31-36>36</a>
</span><span class=lnt id=hl-31-37><a style=outline:none;text-decoration:none;color:inherit href=#hl-31-37>37</a>
</span><span class=lnt id=hl-31-38><a style=outline:none;text-decoration:none;color:inherit href=#hl-31-38>38</a>
</span><span class=lnt id=hl-31-39><a style=outline:none;text-decoration:none;color:inherit href=#hl-31-39>39</a>
</span><span class=lnt id=hl-31-40><a style=outline:none;text-decoration:none;color:inherit href=#hl-31-40>40</a>
</span><span class=lnt id=hl-31-41><a style=outline:none;text-decoration:none;color:inherit href=#hl-31-41>41</a>
</span><span class=lnt id=hl-31-42><a style=outline:none;text-decoration:none;color:inherit href=#hl-31-42>42</a>
</span><span class=lnt id=hl-31-43><a style=outline:none;text-decoration:none;color:inherit href=#hl-31-43>43</a>
</span><span class=lnt id=hl-31-44><a style=outline:none;text-decoration:none;color:inherit href=#hl-31-44>44</a>
</span><span class=lnt id=hl-31-45><a style=outline:none;text-decoration:none;color:inherit href=#hl-31-45>45</a>
</span><span class=lnt id=hl-31-46><a style=outline:none;text-decoration:none;color:inherit href=#hl-31-46>46</a>
</span><span class=lnt id=hl-31-47><a style=outline:none;text-decoration:none;color:inherit href=#hl-31-47>47</a>
</span><span class=lnt id=hl-31-48><a style=outline:none;text-decoration:none;color:inherit href=#hl-31-48>48</a>
</span><span class=lnt id=hl-31-49><a style=outline:none;text-decoration:none;color:inherit href=#hl-31-49>49</a>
</span><span class=lnt id=hl-31-50><a style=outline:none;text-decoration:none;color:inherit href=#hl-31-50>50</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * 聊天组会话管理接口
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>interface</span> <span class=nc>GroupSession</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 创建一个聊天组, 如果不存在才能创建成功, 否则返回 null
</span></span></span><span class=line><span class=cl><span class=cm>     * @param name 组名
</span></span></span><span class=line><span class=cl><span class=cm>     * @param members 成员
</span></span></span><span class=line><span class=cl><span class=cm>     * @return 成功时返回组对象, 失败返回 null
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=n>Group</span> <span class=nf>createGroup</span><span class=o>(</span><span class=n>String</span> <span class=n>name</span><span class=o>,</span> <span class=n>Set</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>members</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 加入聊天组
</span></span></span><span class=line><span class=cl><span class=cm>     * @param name 组名
</span></span></span><span class=line><span class=cl><span class=cm>     * @param member 成员名
</span></span></span><span class=line><span class=cl><span class=cm>     * @return 如果组不存在返回 null, 否则返回组对象
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=n>Group</span> <span class=nf>joinMember</span><span class=o>(</span><span class=n>String</span> <span class=n>name</span><span class=o>,</span> <span class=n>String</span> <span class=n>member</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 移除组成员
</span></span></span><span class=line><span class=cl><span class=cm>     * @param name 组名
</span></span></span><span class=line><span class=cl><span class=cm>     * @param member 成员名
</span></span></span><span class=line><span class=cl><span class=cm>     * @return 如果组不存在返回 null, 否则返回组对象
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=n>Group</span> <span class=nf>removeMember</span><span class=o>(</span><span class=n>String</span> <span class=n>name</span><span class=o>,</span> <span class=n>String</span> <span class=n>member</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 移除聊天组
</span></span></span><span class=line><span class=cl><span class=cm>     * @param name 组名
</span></span></span><span class=line><span class=cl><span class=cm>     * @return 如果组不存在返回 null, 否则返回组对象
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=n>Group</span> <span class=nf>removeGroup</span><span class=o>(</span><span class=n>String</span> <span class=n>name</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 获取组成员
</span></span></span><span class=line><span class=cl><span class=cm>     * @param name 组名
</span></span></span><span class=line><span class=cl><span class=cm>     * @return 成员集合, 没有成员会返回 empty set
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=n>Set</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=nf>getMembers</span><span class=o>(</span><span class=n>String</span> <span class=n>name</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 获取组成员的 channel 集合, 只有在线的 channel 才会返回
</span></span></span><span class=line><span class=cl><span class=cm>     * @param name 组名
</span></span></span><span class=line><span class=cl><span class=cm>     * @return 成员 channel 集合
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=n>List</span><span class=o>&lt;</span><span class=n>Channel</span><span class=o>&gt;</span> <span class=nf>getMembersChannel</span><span class=o>(</span><span class=n>String</span> <span class=n>name</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#32-聊天室业务-登录><h3 id=32-聊天室业务-登录><span class=hanchor arialabel=Anchor># </span>3.2 聊天室业务-登录</h3></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-32-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-32-1> 1</a>
</span><span class=lnt id=hl-32-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-32-2> 2</a>
</span><span class=lnt id=hl-32-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-32-3> 3</a>
</span><span class=lnt id=hl-32-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-32-4> 4</a>
</span><span class=lnt id=hl-32-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-32-5> 5</a>
</span><span class=lnt id=hl-32-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-32-6> 6</a>
</span><span class=lnt id=hl-32-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-32-7> 7</a>
</span><span class=lnt id=hl-32-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-32-8> 8</a>
</span><span class=lnt id=hl-32-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-32-9> 9</a>
</span><span class=lnt id=hl-32-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-32-10>10</a>
</span><span class=lnt id=hl-32-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-32-11>11</a>
</span><span class=lnt id=hl-32-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-32-12>12</a>
</span><span class=lnt id=hl-32-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-32-13>13</a>
</span><span class=lnt id=hl-32-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-32-14>14</a>
</span><span class=lnt id=hl-32-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-32-15>15</a>
</span><span class=lnt id=hl-32-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-32-16>16</a>
</span><span class=lnt id=hl-32-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-32-17>17</a>
</span><span class=lnt id=hl-32-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-32-18>18</a>
</span><span class=lnt id=hl-32-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-32-19>19</a>
</span><span class=lnt id=hl-32-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-32-20>20</a>
</span><span class=lnt id=hl-32-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-32-21>21</a>
</span><span class=lnt id=hl-32-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-32-22>22</a>
</span><span class=lnt id=hl-32-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-32-23>23</a>
</span><span class=lnt id=hl-32-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-32-24>24</a>
</span><span class=lnt id=hl-32-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-32-25>25</a>
</span><span class=lnt id=hl-32-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-32-26>26</a>
</span><span class=lnt id=hl-32-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-32-27>27</a>
</span><span class=lnt id=hl-32-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-32-28>28</a>
</span><span class=lnt id=hl-32-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-32-29>29</a>
</span><span class=lnt id=hl-32-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-32-30>30</a>
</span><span class=lnt id=hl-32-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-32-31>31</a>
</span><span class=lnt id=hl-32-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-32-32>32</a>
</span><span class=lnt id=hl-32-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-32-33>33</a>
</span><span class=lnt id=hl-32-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-32-34>34</a>
</span><span class=lnt id=hl-32-35><a style=outline:none;text-decoration:none;color:inherit href=#hl-32-35>35</a>
</span><span class=lnt id=hl-32-36><a style=outline:none;text-decoration:none;color:inherit href=#hl-32-36>36</a>
</span><span class=lnt id=hl-32-37><a style=outline:none;text-decoration:none;color:inherit href=#hl-32-37>37</a>
</span><span class=lnt id=hl-32-38><a style=outline:none;text-decoration:none;color:inherit href=#hl-32-38>38</a>
</span><span class=lnt id=hl-32-39><a style=outline:none;text-decoration:none;color:inherit href=#hl-32-39>39</a>
</span><span class=lnt id=hl-32-40><a style=outline:none;text-decoration:none;color:inherit href=#hl-32-40>40</a>
</span><span class=lnt id=hl-32-41><a style=outline:none;text-decoration:none;color:inherit href=#hl-32-41>41</a>
</span><span class=lnt id=hl-32-42><a style=outline:none;text-decoration:none;color:inherit href=#hl-32-42>42</a>
</span><span class=lnt id=hl-32-43><a style=outline:none;text-decoration:none;color:inherit href=#hl-32-43>43</a>
</span><span class=lnt id=hl-32-44><a style=outline:none;text-decoration:none;color:inherit href=#hl-32-44>44</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>ChatServer</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>NioEventLoopGroup</span> <span class=n>boss</span> <span class=o>=</span> <span class=k>new</span> <span class=n>NioEventLoopGroup</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>NioEventLoopGroup</span> <span class=n>worker</span> <span class=o>=</span> <span class=k>new</span> <span class=n>NioEventLoopGroup</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>LoggingHandler</span> <span class=n>LOGGING_HANDLER</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LoggingHandler</span><span class=o>(</span><span class=n>LogLevel</span><span class=o>.</span><span class=na>DEBUG</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>MessageCodecSharable</span> <span class=n>MESSAGE_CODEC</span> <span class=o>=</span> <span class=k>new</span> <span class=n>MessageCodecSharable</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>ServerBootstrap</span> <span class=n>serverBootstrap</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ServerBootstrap</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>serverBootstrap</span><span class=o>.</span><span class=na>channel</span><span class=o>(</span><span class=n>NioServerSocketChannel</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>serverBootstrap</span><span class=o>.</span><span class=na>group</span><span class=o>(</span><span class=n>boss</span><span class=o>,</span> <span class=n>worker</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>serverBootstrap</span><span class=o>.</span><span class=na>childHandler</span><span class=o>(</span><span class=k>new</span> <span class=n>ChannelInitializer</span><span class=o>&lt;</span><span class=n>SocketChannel</span><span class=o>&gt;()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>                <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>initChannel</span><span class=o>(</span><span class=n>SocketChannel</span> <span class=n>ch</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>ProcotolFrameDecoder</span><span class=o>());</span>
</span></span><span class=line><span class=cl>                    <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=n>LOGGING_HANDLER</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=n>MESSAGE_CODEC</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>SimpleChannelInboundHandler</span><span class=o>&lt;</span><span class=n>LoginRequestMessage</span><span class=o>&gt;()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>                        <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>channelRead0</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>,</span> <span class=n>LoginRequestMessage</span> <span class=n>msg</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                            <span class=n>String</span> <span class=n>username</span> <span class=o>=</span> <span class=n>msg</span><span class=o>.</span><span class=na>getUsername</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                            <span class=n>String</span> <span class=n>password</span> <span class=o>=</span> <span class=n>msg</span><span class=o>.</span><span class=na>getPassword</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                            <span class=kt>boolean</span> <span class=n>login</span> <span class=o>=</span> <span class=n>UserServiceFactory</span><span class=o>.</span><span class=na>getUserService</span><span class=o>().</span><span class=na>login</span><span class=o>(</span><span class=n>username</span><span class=o>,</span> <span class=n>password</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                            <span class=n>LoginResponseMessage</span> <span class=n>message</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                            <span class=k>if</span><span class=o>(</span><span class=n>login</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                                <span class=n>message</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LoginResponseMessage</span><span class=o>(</span><span class=kc>true</span><span class=o>,</span> <span class=s>&#34;登录成功&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                            <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                                <span class=n>message</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LoginResponseMessage</span><span class=o>(</span><span class=kc>false</span><span class=o>,</span> <span class=s>&#34;用户名或密码不正确&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                            <span class=o>}</span>
</span></span><span class=line><span class=cl>                            <span class=n>ctx</span><span class=o>.</span><span class=na>writeAndFlush</span><span class=o>(</span><span class=n>message</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                        <span class=o>}</span>
</span></span><span class=line><span class=cl>                    <span class=o>});</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>});</span>
</span></span><span class=line><span class=cl>            <span class=n>Channel</span> <span class=n>channel</span> <span class=o>=</span> <span class=n>serverBootstrap</span><span class=o>.</span><span class=na>bind</span><span class=o>(</span><span class=n>8080</span><span class=o>).</span><span class=na>sync</span><span class=o>().</span><span class=na>channel</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>channel</span><span class=o>.</span><span class=na>closeFuture</span><span class=o>().</span><span class=na>sync</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=o>.</span><span class=na>error</span><span class=o>(</span><span class=s>&#34;server error&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>boss</span><span class=o>.</span><span class=na>shutdownGracefully</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>worker</span><span class=o>.</span><span class=na>shutdownGracefully</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-33-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-1>  1</a>
</span><span class=lnt id=hl-33-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-2>  2</a>
</span><span class=lnt id=hl-33-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-3>  3</a>
</span><span class=lnt id=hl-33-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-4>  4</a>
</span><span class=lnt id=hl-33-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-5>  5</a>
</span><span class=lnt id=hl-33-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-6>  6</a>
</span><span class=lnt id=hl-33-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-7>  7</a>
</span><span class=lnt id=hl-33-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-8>  8</a>
</span><span class=lnt id=hl-33-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-9>  9</a>
</span><span class=lnt id=hl-33-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-10> 10</a>
</span><span class=lnt id=hl-33-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-11> 11</a>
</span><span class=lnt id=hl-33-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-12> 12</a>
</span><span class=lnt id=hl-33-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-13> 13</a>
</span><span class=lnt id=hl-33-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-14> 14</a>
</span><span class=lnt id=hl-33-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-15> 15</a>
</span><span class=lnt id=hl-33-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-16> 16</a>
</span><span class=lnt id=hl-33-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-17> 17</a>
</span><span class=lnt id=hl-33-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-18> 18</a>
</span><span class=lnt id=hl-33-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-19> 19</a>
</span><span class=lnt id=hl-33-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-20> 20</a>
</span><span class=lnt id=hl-33-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-21> 21</a>
</span><span class=lnt id=hl-33-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-22> 22</a>
</span><span class=lnt id=hl-33-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-23> 23</a>
</span><span class=lnt id=hl-33-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-24> 24</a>
</span><span class=lnt id=hl-33-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-25> 25</a>
</span><span class=lnt id=hl-33-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-26> 26</a>
</span><span class=lnt id=hl-33-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-27> 27</a>
</span><span class=lnt id=hl-33-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-28> 28</a>
</span><span class=lnt id=hl-33-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-29> 29</a>
</span><span class=lnt id=hl-33-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-30> 30</a>
</span><span class=lnt id=hl-33-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-31> 31</a>
</span><span class=lnt id=hl-33-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-32> 32</a>
</span><span class=lnt id=hl-33-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-33> 33</a>
</span><span class=lnt id=hl-33-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-34> 34</a>
</span><span class=lnt id=hl-33-35><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-35> 35</a>
</span><span class=lnt id=hl-33-36><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-36> 36</a>
</span><span class=lnt id=hl-33-37><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-37> 37</a>
</span><span class=lnt id=hl-33-38><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-38> 38</a>
</span><span class=lnt id=hl-33-39><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-39> 39</a>
</span><span class=lnt id=hl-33-40><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-40> 40</a>
</span><span class=lnt id=hl-33-41><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-41> 41</a>
</span><span class=lnt id=hl-33-42><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-42> 42</a>
</span><span class=lnt id=hl-33-43><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-43> 43</a>
</span><span class=lnt id=hl-33-44><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-44> 44</a>
</span><span class=lnt id=hl-33-45><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-45> 45</a>
</span><span class=lnt id=hl-33-46><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-46> 46</a>
</span><span class=lnt id=hl-33-47><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-47> 47</a>
</span><span class=lnt id=hl-33-48><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-48> 48</a>
</span><span class=lnt id=hl-33-49><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-49> 49</a>
</span><span class=lnt id=hl-33-50><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-50> 50</a>
</span><span class=lnt id=hl-33-51><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-51> 51</a>
</span><span class=lnt id=hl-33-52><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-52> 52</a>
</span><span class=lnt id=hl-33-53><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-53> 53</a>
</span><span class=lnt id=hl-33-54><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-54> 54</a>
</span><span class=lnt id=hl-33-55><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-55> 55</a>
</span><span class=lnt id=hl-33-56><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-56> 56</a>
</span><span class=lnt id=hl-33-57><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-57> 57</a>
</span><span class=lnt id=hl-33-58><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-58> 58</a>
</span><span class=lnt id=hl-33-59><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-59> 59</a>
</span><span class=lnt id=hl-33-60><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-60> 60</a>
</span><span class=lnt id=hl-33-61><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-61> 61</a>
</span><span class=lnt id=hl-33-62><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-62> 62</a>
</span><span class=lnt id=hl-33-63><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-63> 63</a>
</span><span class=lnt id=hl-33-64><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-64> 64</a>
</span><span class=lnt id=hl-33-65><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-65> 65</a>
</span><span class=lnt id=hl-33-66><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-66> 66</a>
</span><span class=lnt id=hl-33-67><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-67> 67</a>
</span><span class=lnt id=hl-33-68><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-68> 68</a>
</span><span class=lnt id=hl-33-69><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-69> 69</a>
</span><span class=lnt id=hl-33-70><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-70> 70</a>
</span><span class=lnt id=hl-33-71><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-71> 71</a>
</span><span class=lnt id=hl-33-72><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-72> 72</a>
</span><span class=lnt id=hl-33-73><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-73> 73</a>
</span><span class=lnt id=hl-33-74><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-74> 74</a>
</span><span class=lnt id=hl-33-75><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-75> 75</a>
</span><span class=lnt id=hl-33-76><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-76> 76</a>
</span><span class=lnt id=hl-33-77><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-77> 77</a>
</span><span class=lnt id=hl-33-78><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-78> 78</a>
</span><span class=lnt id=hl-33-79><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-79> 79</a>
</span><span class=lnt id=hl-33-80><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-80> 80</a>
</span><span class=lnt id=hl-33-81><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-81> 81</a>
</span><span class=lnt id=hl-33-82><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-82> 82</a>
</span><span class=lnt id=hl-33-83><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-83> 83</a>
</span><span class=lnt id=hl-33-84><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-84> 84</a>
</span><span class=lnt id=hl-33-85><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-85> 85</a>
</span><span class=lnt id=hl-33-86><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-86> 86</a>
</span><span class=lnt id=hl-33-87><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-87> 87</a>
</span><span class=lnt id=hl-33-88><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-88> 88</a>
</span><span class=lnt id=hl-33-89><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-89> 89</a>
</span><span class=lnt id=hl-33-90><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-90> 90</a>
</span><span class=lnt id=hl-33-91><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-91> 91</a>
</span><span class=lnt id=hl-33-92><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-92> 92</a>
</span><span class=lnt id=hl-33-93><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-93> 93</a>
</span><span class=lnt id=hl-33-94><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-94> 94</a>
</span><span class=lnt id=hl-33-95><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-95> 95</a>
</span><span class=lnt id=hl-33-96><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-96> 96</a>
</span><span class=lnt id=hl-33-97><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-97> 97</a>
</span><span class=lnt id=hl-33-98><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-98> 98</a>
</span><span class=lnt id=hl-33-99><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-99> 99</a>
</span><span class=lnt id=hl-33-100><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-100>100</a>
</span><span class=lnt id=hl-33-101><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-101>101</a>
</span><span class=lnt id=hl-33-102><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-102>102</a>
</span><span class=lnt id=hl-33-103><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-103>103</a>
</span><span class=lnt id=hl-33-104><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-104>104</a>
</span><span class=lnt id=hl-33-105><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-105>105</a>
</span><span class=lnt id=hl-33-106><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-106>106</a>
</span><span class=lnt id=hl-33-107><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-107>107</a>
</span><span class=lnt id=hl-33-108><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-108>108</a>
</span><span class=lnt id=hl-33-109><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-109>109</a>
</span><span class=lnt id=hl-33-110><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-110>110</a>
</span><span class=lnt id=hl-33-111><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-111>111</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>ChatClient</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>NioEventLoopGroup</span> <span class=n>group</span> <span class=o>=</span> <span class=k>new</span> <span class=n>NioEventLoopGroup</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>LoggingHandler</span> <span class=n>LOGGING_HANDLER</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LoggingHandler</span><span class=o>(</span><span class=n>LogLevel</span><span class=o>.</span><span class=na>DEBUG</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>MessageCodecSharable</span> <span class=n>MESSAGE_CODEC</span> <span class=o>=</span> <span class=k>new</span> <span class=n>MessageCodecSharable</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>CountDownLatch</span> <span class=n>WAIT_FOR_LOGIN</span> <span class=o>=</span> <span class=k>new</span> <span class=n>CountDownLatch</span><span class=o>(</span><span class=n>1</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>AtomicBoolean</span> <span class=n>LOGIN</span> <span class=o>=</span> <span class=k>new</span> <span class=n>AtomicBoolean</span><span class=o>(</span><span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Bootstrap</span> <span class=n>bootstrap</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Bootstrap</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>bootstrap</span><span class=o>.</span><span class=na>channel</span><span class=o>(</span><span class=n>NioSocketChannel</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>bootstrap</span><span class=o>.</span><span class=na>group</span><span class=o>(</span><span class=n>group</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>bootstrap</span><span class=o>.</span><span class=na>handler</span><span class=o>(</span><span class=k>new</span> <span class=n>ChannelInitializer</span><span class=o>&lt;</span><span class=n>SocketChannel</span><span class=o>&gt;()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>                <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>initChannel</span><span class=o>(</span><span class=n>SocketChannel</span> <span class=n>ch</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>ProcotolFrameDecoder</span><span class=o>());</span>
</span></span><span class=line><span class=cl><span class=c1>//                    ch.pipeline().addLast(LOGGING_HANDLER);
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=n>MESSAGE_CODEC</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=s>&#34;client handler&#34;</span><span class=o>,</span> <span class=k>new</span> <span class=n>ChannelInboundHandlerAdapter</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=c1>// 接收响应消息
</span></span></span><span class=line><span class=cl><span class=c1></span>                        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>                        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>channelRead</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>,</span> <span class=n>Object</span> <span class=n>msg</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                            <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;msg: {}&#34;</span><span class=o>,</span> <span class=n>msg</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                            <span class=k>if</span> <span class=o>((</span><span class=n>msg</span> <span class=k>instanceof</span> <span class=n>LoginResponseMessage</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                                <span class=n>LoginResponseMessage</span> <span class=n>response</span> <span class=o>=</span> <span class=o>(</span><span class=n>LoginResponseMessage</span><span class=o>)</span> <span class=n>msg</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                                <span class=k>if</span> <span class=o>(</span><span class=n>response</span><span class=o>.</span><span class=na>isSuccess</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                                    <span class=c1>// 如果登录成功
</span></span></span><span class=line><span class=cl><span class=c1></span>                                    <span class=n>LOGIN</span><span class=o>.</span><span class=na>set</span><span class=o>(</span><span class=kc>true</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                                <span class=o>}</span>
</span></span><span class=line><span class=cl>                                <span class=c1>// 唤醒 system in 线程
</span></span></span><span class=line><span class=cl><span class=c1></span>                                <span class=n>WAIT_FOR_LOGIN</span><span class=o>.</span><span class=na>countDown</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                            <span class=o>}</span>
</span></span><span class=line><span class=cl>                        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                        <span class=c1>// 在连接建立后触发 active 事件
</span></span></span><span class=line><span class=cl><span class=c1></span>                        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>                        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>channelActive</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                            <span class=c1>// 负责接收用户在控制台的输入，负责向服务器发送各种消息
</span></span></span><span class=line><span class=cl><span class=c1></span>                            <span class=k>new</span> <span class=n>Thread</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                                <span class=n>Scanner</span> <span class=n>scanner</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Scanner</span><span class=o>(</span><span class=n>System</span><span class=o>.</span><span class=na>in</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                                <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;请输入用户名:&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                                <span class=n>String</span> <span class=n>username</span> <span class=o>=</span> <span class=n>scanner</span><span class=o>.</span><span class=na>nextLine</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                                <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;请输入密码:&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                                <span class=n>String</span> <span class=n>password</span> <span class=o>=</span> <span class=n>scanner</span><span class=o>.</span><span class=na>nextLine</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                                <span class=c1>// 构造消息对象
</span></span></span><span class=line><span class=cl><span class=c1></span>                                <span class=n>LoginRequestMessage</span> <span class=n>message</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LoginRequestMessage</span><span class=o>(</span><span class=n>username</span><span class=o>,</span> <span class=n>password</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                                <span class=c1>// 发送消息
</span></span></span><span class=line><span class=cl><span class=c1></span>                                <span class=n>ctx</span><span class=o>.</span><span class=na>writeAndFlush</span><span class=o>(</span><span class=n>message</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                                <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;等待后续操作...&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                                <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                                    <span class=n>WAIT_FOR_LOGIN</span><span class=o>.</span><span class=na>await</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                                <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                                    <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                                <span class=o>}</span>
</span></span><span class=line><span class=cl>                                <span class=c1>// 如果登录失败
</span></span></span><span class=line><span class=cl><span class=c1></span>                                <span class=k>if</span> <span class=o>(!</span><span class=n>LOGIN</span><span class=o>.</span><span class=na>get</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                                    <span class=n>ctx</span><span class=o>.</span><span class=na>channel</span><span class=o>().</span><span class=na>close</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                                    <span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                                <span class=o>}</span>
</span></span><span class=line><span class=cl>                                <span class=k>while</span> <span class=o>(</span><span class=kc>true</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                                    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;==================================&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                                    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;send [username] [content]&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                                    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;gsend [group name] [content]&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                                    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;gcreate [group name] [m1,m2,m3...]&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                                    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;gmembers [group name]&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                                    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;gjoin [group name]&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                                    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;gquit [group name]&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                                    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;quit&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                                    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;==================================&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                                    <span class=n>String</span> <span class=n>command</span> <span class=o>=</span> <span class=n>scanner</span><span class=o>.</span><span class=na>nextLine</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                                    <span class=n>String</span><span class=o>[]</span> <span class=n>s</span> <span class=o>=</span> <span class=n>command</span><span class=o>.</span><span class=na>split</span><span class=o>(</span><span class=s>&#34; &#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                                    <span class=k>switch</span> <span class=o>(</span><span class=n>s</span><span class=o>[</span><span class=n>0</span><span class=o>]){</span>
</span></span><span class=line><span class=cl>                                        <span class=k>case</span> <span class=s>&#34;send&#34;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                                            <span class=n>ctx</span><span class=o>.</span><span class=na>writeAndFlush</span><span class=o>(</span><span class=k>new</span> <span class=n>ChatRequestMessage</span><span class=o>(</span><span class=n>username</span><span class=o>,</span> <span class=n>s</span><span class=o>[</span><span class=n>1</span><span class=o>],</span> <span class=n>s</span><span class=o>[</span><span class=n>2</span><span class=o>]));</span>
</span></span><span class=line><span class=cl>                                            <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                                        <span class=k>case</span> <span class=s>&#34;gsend&#34;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                                            <span class=n>ctx</span><span class=o>.</span><span class=na>writeAndFlush</span><span class=o>(</span><span class=k>new</span> <span class=n>GroupChatRequestMessage</span><span class=o>(</span><span class=n>username</span><span class=o>,</span> <span class=n>s</span><span class=o>[</span><span class=n>1</span><span class=o>],</span> <span class=n>s</span><span class=o>[</span><span class=n>2</span><span class=o>]));</span>
</span></span><span class=line><span class=cl>                                            <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                                        <span class=k>case</span> <span class=s>&#34;gcreate&#34;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                                            <span class=n>Set</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>set</span> <span class=o>=</span> <span class=k>new</span> <span class=n>HashSet</span><span class=o>&lt;&gt;(</span><span class=n>Arrays</span><span class=o>.</span><span class=na>asList</span><span class=o>(</span><span class=n>s</span><span class=o>[</span><span class=n>2</span><span class=o>].</span><span class=na>split</span><span class=o>(</span><span class=s>&#34;,&#34;</span><span class=o>)));</span>
</span></span><span class=line><span class=cl>                                            <span class=n>set</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>username</span><span class=o>);</span> <span class=c1>// 加入自己
</span></span></span><span class=line><span class=cl><span class=c1></span>                                            <span class=n>ctx</span><span class=o>.</span><span class=na>writeAndFlush</span><span class=o>(</span><span class=k>new</span> <span class=n>GroupCreateRequestMessage</span><span class=o>(</span><span class=n>s</span><span class=o>[</span><span class=n>1</span><span class=o>],</span> <span class=n>set</span><span class=o>));</span>
</span></span><span class=line><span class=cl>                                            <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                                        <span class=k>case</span> <span class=s>&#34;gmembers&#34;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                                            <span class=n>ctx</span><span class=o>.</span><span class=na>writeAndFlush</span><span class=o>(</span><span class=k>new</span> <span class=n>GroupMembersRequestMessage</span><span class=o>(</span><span class=n>s</span><span class=o>[</span><span class=n>1</span><span class=o>]));</span>
</span></span><span class=line><span class=cl>                                            <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                                        <span class=k>case</span> <span class=s>&#34;gjoin&#34;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                                            <span class=n>ctx</span><span class=o>.</span><span class=na>writeAndFlush</span><span class=o>(</span><span class=k>new</span> <span class=n>GroupJoinRequestMessage</span><span class=o>(</span><span class=n>username</span><span class=o>,</span> <span class=n>s</span><span class=o>[</span><span class=n>1</span><span class=o>]));</span>
</span></span><span class=line><span class=cl>                                            <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                                        <span class=k>case</span> <span class=s>&#34;gquit&#34;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                                            <span class=n>ctx</span><span class=o>.</span><span class=na>writeAndFlush</span><span class=o>(</span><span class=k>new</span> <span class=n>GroupQuitRequestMessage</span><span class=o>(</span><span class=n>username</span><span class=o>,</span> <span class=n>s</span><span class=o>[</span><span class=n>1</span><span class=o>]));</span>
</span></span><span class=line><span class=cl>                                            <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                                        <span class=k>case</span> <span class=s>&#34;quit&#34;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                                            <span class=n>ctx</span><span class=o>.</span><span class=na>channel</span><span class=o>().</span><span class=na>close</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                                            <span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                                    <span class=o>}</span>
</span></span><span class=line><span class=cl>                                <span class=o>}</span>
</span></span><span class=line><span class=cl>                            <span class=o>},</span> <span class=s>&#34;system in&#34;</span><span class=o>).</span><span class=na>start</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                        <span class=o>}</span>
</span></span><span class=line><span class=cl>                    <span class=o>});</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>});</span>
</span></span><span class=line><span class=cl>            <span class=n>Channel</span> <span class=n>channel</span> <span class=o>=</span> <span class=n>bootstrap</span><span class=o>.</span><span class=na>connect</span><span class=o>(</span><span class=s>&#34;localhost&#34;</span><span class=o>,</span> <span class=n>8080</span><span class=o>).</span><span class=na>sync</span><span class=o>().</span><span class=na>channel</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>channel</span><span class=o>.</span><span class=na>closeFuture</span><span class=o>().</span><span class=na>sync</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Exception</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=o>.</span><span class=na>error</span><span class=o>(</span><span class=s>&#34;client error&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>group</span><span class=o>.</span><span class=na>shutdownGracefully</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#33-聊天室业务-单聊><h3 id=33-聊天室业务-单聊><span class=hanchor arialabel=Anchor># </span>3.3 聊天室业务-单聊</h3></a><p>服务器端将 handler 独立出来</p><p>登录 handler</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-34-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-34-1> 1</a>
</span><span class=lnt id=hl-34-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-34-2> 2</a>
</span><span class=lnt id=hl-34-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-34-3> 3</a>
</span><span class=lnt id=hl-34-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-34-4> 4</a>
</span><span class=lnt id=hl-34-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-34-5> 5</a>
</span><span class=lnt id=hl-34-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-34-6> 6</a>
</span><span class=lnt id=hl-34-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-34-7> 7</a>
</span><span class=lnt id=hl-34-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-34-8> 8</a>
</span><span class=lnt id=hl-34-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-34-9> 9</a>
</span><span class=lnt id=hl-34-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-34-10>10</a>
</span><span class=lnt id=hl-34-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-34-11>11</a>
</span><span class=lnt id=hl-34-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-34-12>12</a>
</span><span class=lnt id=hl-34-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-34-13>13</a>
</span><span class=lnt id=hl-34-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-34-14>14</a>
</span><span class=lnt id=hl-34-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-34-15>15</a>
</span><span class=lnt id=hl-34-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-34-16>16</a>
</span><span class=lnt id=hl-34-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-34-17>17</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@ChannelHandler.Sharable</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>LoginRequestMessageHandler</span> <span class=kd>extends</span> <span class=n>SimpleChannelInboundHandler</span><span class=o>&lt;</span><span class=n>LoginRequestMessage</span><span class=o>&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>channelRead0</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>,</span> <span class=n>LoginRequestMessage</span> <span class=n>msg</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>String</span> <span class=n>username</span> <span class=o>=</span> <span class=n>msg</span><span class=o>.</span><span class=na>getUsername</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>String</span> <span class=n>password</span> <span class=o>=</span> <span class=n>msg</span><span class=o>.</span><span class=na>getPassword</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=kt>boolean</span> <span class=n>login</span> <span class=o>=</span> <span class=n>UserServiceFactory</span><span class=o>.</span><span class=na>getUserService</span><span class=o>().</span><span class=na>login</span><span class=o>(</span><span class=n>username</span><span class=o>,</span> <span class=n>password</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>LoginResponseMessage</span> <span class=n>message</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=o>(</span><span class=n>login</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>SessionFactory</span><span class=o>.</span><span class=na>getSession</span><span class=o>().</span><span class=na>bind</span><span class=o>(</span><span class=n>ctx</span><span class=o>.</span><span class=na>channel</span><span class=o>(),</span> <span class=n>username</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>message</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LoginResponseMessage</span><span class=o>(</span><span class=kc>true</span><span class=o>,</span> <span class=s>&#34;登录成功&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>message</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LoginResponseMessage</span><span class=o>(</span><span class=kc>false</span><span class=o>,</span> <span class=s>&#34;用户名或密码不正确&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=n>ctx</span><span class=o>.</span><span class=na>writeAndFlush</span><span class=o>(</span><span class=n>message</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>单聊 handler</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-35-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-35-1> 1</a>
</span><span class=lnt id=hl-35-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-35-2> 2</a>
</span><span class=lnt id=hl-35-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-35-3> 3</a>
</span><span class=lnt id=hl-35-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-35-4> 4</a>
</span><span class=lnt id=hl-35-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-35-5> 5</a>
</span><span class=lnt id=hl-35-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-35-6> 6</a>
</span><span class=lnt id=hl-35-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-35-7> 7</a>
</span><span class=lnt id=hl-35-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-35-8> 8</a>
</span><span class=lnt id=hl-35-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-35-9> 9</a>
</span><span class=lnt id=hl-35-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-35-10>10</a>
</span><span class=lnt id=hl-35-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-35-11>11</a>
</span><span class=lnt id=hl-35-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-35-12>12</a>
</span><span class=lnt id=hl-35-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-35-13>13</a>
</span><span class=lnt id=hl-35-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-35-14>14</a>
</span><span class=lnt id=hl-35-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-35-15>15</a>
</span><span class=lnt id=hl-35-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-35-16>16</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@ChannelHandler.Sharable</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>ChatRequestMessageHandler</span> <span class=kd>extends</span> <span class=n>SimpleChannelInboundHandler</span><span class=o>&lt;</span><span class=n>ChatRequestMessage</span><span class=o>&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>channelRead0</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>,</span> <span class=n>ChatRequestMessage</span> <span class=n>msg</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>String</span> <span class=n>to</span> <span class=o>=</span> <span class=n>msg</span><span class=o>.</span><span class=na>getTo</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>Channel</span> <span class=n>channel</span> <span class=o>=</span> <span class=n>SessionFactory</span><span class=o>.</span><span class=na>getSession</span><span class=o>().</span><span class=na>getChannel</span><span class=o>(</span><span class=n>to</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 在线
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span><span class=o>(</span><span class=n>channel</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>channel</span><span class=o>.</span><span class=na>writeAndFlush</span><span class=o>(</span><span class=k>new</span> <span class=n>ChatResponseMessage</span><span class=o>(</span><span class=n>msg</span><span class=o>.</span><span class=na>getFrom</span><span class=o>(),</span> <span class=n>msg</span><span class=o>.</span><span class=na>getContent</span><span class=o>()));</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 不在线
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>ctx</span><span class=o>.</span><span class=na>writeAndFlush</span><span class=o>(</span><span class=k>new</span> <span class=n>ChatResponseMessage</span><span class=o>(</span><span class=kc>false</span><span class=o>,</span> <span class=s>&#34;对方用户不存在或者不在线&#34;</span><span class=o>));</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#34-聊天室业务-群聊><h3 id=34-聊天室业务-群聊><span class=hanchor arialabel=Anchor># </span>3.4 聊天室业务-群聊</h3></a><p>创建群聊</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-36-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-36-1> 1</a>
</span><span class=lnt id=hl-36-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-36-2> 2</a>
</span><span class=lnt id=hl-36-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-36-3> 3</a>
</span><span class=lnt id=hl-36-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-36-4> 4</a>
</span><span class=lnt id=hl-36-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-36-5> 5</a>
</span><span class=lnt id=hl-36-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-36-6> 6</a>
</span><span class=lnt id=hl-36-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-36-7> 7</a>
</span><span class=lnt id=hl-36-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-36-8> 8</a>
</span><span class=lnt id=hl-36-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-36-9> 9</a>
</span><span class=lnt id=hl-36-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-36-10>10</a>
</span><span class=lnt id=hl-36-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-36-11>11</a>
</span><span class=lnt id=hl-36-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-36-12>12</a>
</span><span class=lnt id=hl-36-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-36-13>13</a>
</span><span class=lnt id=hl-36-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-36-14>14</a>
</span><span class=lnt id=hl-36-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-36-15>15</a>
</span><span class=lnt id=hl-36-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-36-16>16</a>
</span><span class=lnt id=hl-36-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-36-17>17</a>
</span><span class=lnt id=hl-36-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-36-18>18</a>
</span><span class=lnt id=hl-36-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-36-19>19</a>
</span><span class=lnt id=hl-36-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-36-20>20</a>
</span><span class=lnt id=hl-36-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-36-21>21</a>
</span><span class=lnt id=hl-36-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-36-22>22</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@ChannelHandler.Sharable</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>GroupCreateRequestMessageHandler</span> <span class=kd>extends</span> <span class=n>SimpleChannelInboundHandler</span><span class=o>&lt;</span><span class=n>GroupCreateRequestMessage</span><span class=o>&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>channelRead0</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>,</span> <span class=n>GroupCreateRequestMessage</span> <span class=n>msg</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>String</span> <span class=n>groupName</span> <span class=o>=</span> <span class=n>msg</span><span class=o>.</span><span class=na>getGroupName</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>Set</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>members</span> <span class=o>=</span> <span class=n>msg</span><span class=o>.</span><span class=na>getMembers</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 群管理器
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>GroupSession</span> <span class=n>groupSession</span> <span class=o>=</span> <span class=n>GroupSessionFactory</span><span class=o>.</span><span class=na>getGroupSession</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>Group</span> <span class=n>group</span> <span class=o>=</span> <span class=n>groupSession</span><span class=o>.</span><span class=na>createGroup</span><span class=o>(</span><span class=n>groupName</span><span class=o>,</span> <span class=n>members</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>group</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 发生成功消息
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>ctx</span><span class=o>.</span><span class=na>writeAndFlush</span><span class=o>(</span><span class=k>new</span> <span class=n>GroupCreateResponseMessage</span><span class=o>(</span><span class=kc>true</span><span class=o>,</span> <span class=n>groupName</span> <span class=o>+</span> <span class=s>&#34;创建成功&#34;</span><span class=o>));</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 发送拉群消息
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>List</span><span class=o>&lt;</span><span class=n>Channel</span><span class=o>&gt;</span> <span class=n>channels</span> <span class=o>=</span> <span class=n>groupSession</span><span class=o>.</span><span class=na>getMembersChannel</span><span class=o>(</span><span class=n>groupName</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=o>(</span><span class=n>Channel</span> <span class=n>channel</span> <span class=o>:</span> <span class=n>channels</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>channel</span><span class=o>.</span><span class=na>writeAndFlush</span><span class=o>(</span><span class=k>new</span> <span class=n>GroupCreateResponseMessage</span><span class=o>(</span><span class=kc>true</span><span class=o>,</span> <span class=s>&#34;您已被拉入&#34;</span> <span class=o>+</span> <span class=n>groupName</span><span class=o>));</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>ctx</span><span class=o>.</span><span class=na>writeAndFlush</span><span class=o>(</span><span class=k>new</span> <span class=n>GroupCreateResponseMessage</span><span class=o>(</span><span class=kc>false</span><span class=o>,</span> <span class=n>groupName</span> <span class=o>+</span> <span class=s>&#34;已经存在&#34;</span><span class=o>));</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>群聊</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-37-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-37-1> 1</a>
</span><span class=lnt id=hl-37-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-37-2> 2</a>
</span><span class=lnt id=hl-37-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-37-3> 3</a>
</span><span class=lnt id=hl-37-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-37-4> 4</a>
</span><span class=lnt id=hl-37-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-37-5> 5</a>
</span><span class=lnt id=hl-37-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-37-6> 6</a>
</span><span class=lnt id=hl-37-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-37-7> 7</a>
</span><span class=lnt id=hl-37-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-37-8> 8</a>
</span><span class=lnt id=hl-37-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-37-9> 9</a>
</span><span class=lnt id=hl-37-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-37-10>10</a>
</span><span class=lnt id=hl-37-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-37-11>11</a>
</span><span class=lnt id=hl-37-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-37-12>12</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@ChannelHandler.Sharable</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>GroupChatRequestMessageHandler</span> <span class=kd>extends</span> <span class=n>SimpleChannelInboundHandler</span><span class=o>&lt;</span><span class=n>GroupChatRequestMessage</span><span class=o>&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>channelRead0</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>,</span> <span class=n>GroupChatRequestMessage</span> <span class=n>msg</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>List</span><span class=o>&lt;</span><span class=n>Channel</span><span class=o>&gt;</span> <span class=n>channels</span> <span class=o>=</span> <span class=n>GroupSessionFactory</span><span class=o>.</span><span class=na>getGroupSession</span><span class=o>()</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>getMembersChannel</span><span class=o>(</span><span class=n>msg</span><span class=o>.</span><span class=na>getGroupName</span><span class=o>());</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=o>(</span><span class=n>Channel</span> <span class=n>channel</span> <span class=o>:</span> <span class=n>channels</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>channel</span><span class=o>.</span><span class=na>writeAndFlush</span><span class=o>(</span><span class=k>new</span> <span class=n>GroupChatResponseMessage</span><span class=o>(</span><span class=n>msg</span><span class=o>.</span><span class=na>getFrom</span><span class=o>(),</span> <span class=n>msg</span><span class=o>.</span><span class=na>getContent</span><span class=o>()));</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>加入群聊</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-38-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-38-1> 1</a>
</span><span class=lnt id=hl-38-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-38-2> 2</a>
</span><span class=lnt id=hl-38-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-38-3> 3</a>
</span><span class=lnt id=hl-38-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-38-4> 4</a>
</span><span class=lnt id=hl-38-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-38-5> 5</a>
</span><span class=lnt id=hl-38-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-38-6> 6</a>
</span><span class=lnt id=hl-38-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-38-7> 7</a>
</span><span class=lnt id=hl-38-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-38-8> 8</a>
</span><span class=lnt id=hl-38-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-38-9> 9</a>
</span><span class=lnt id=hl-38-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-38-10>10</a>
</span><span class=lnt id=hl-38-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-38-11>11</a>
</span><span class=lnt id=hl-38-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-38-12>12</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@ChannelHandler.Sharable</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>GroupJoinRequestMessageHandler</span> <span class=kd>extends</span> <span class=n>SimpleChannelInboundHandler</span><span class=o>&lt;</span><span class=n>GroupJoinRequestMessage</span><span class=o>&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>channelRead0</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>,</span> <span class=n>GroupJoinRequestMessage</span> <span class=n>msg</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Group</span> <span class=n>group</span> <span class=o>=</span> <span class=n>GroupSessionFactory</span><span class=o>.</span><span class=na>getGroupSession</span><span class=o>().</span><span class=na>joinMember</span><span class=o>(</span><span class=n>msg</span><span class=o>.</span><span class=na>getGroupName</span><span class=o>(),</span> <span class=n>msg</span><span class=o>.</span><span class=na>getUsername</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>group</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>ctx</span><span class=o>.</span><span class=na>writeAndFlush</span><span class=o>(</span><span class=k>new</span> <span class=n>GroupJoinResponseMessage</span><span class=o>(</span><span class=kc>true</span><span class=o>,</span> <span class=n>msg</span><span class=o>.</span><span class=na>getGroupName</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;群加入成功&#34;</span><span class=o>));</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>ctx</span><span class=o>.</span><span class=na>writeAndFlush</span><span class=o>(</span><span class=k>new</span> <span class=n>GroupJoinResponseMessage</span><span class=o>(</span><span class=kc>true</span><span class=o>,</span> <span class=n>msg</span><span class=o>.</span><span class=na>getGroupName</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;群不存在&#34;</span><span class=o>));</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>退出群聊</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-39-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-39-1> 1</a>
</span><span class=lnt id=hl-39-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-39-2> 2</a>
</span><span class=lnt id=hl-39-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-39-3> 3</a>
</span><span class=lnt id=hl-39-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-39-4> 4</a>
</span><span class=lnt id=hl-39-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-39-5> 5</a>
</span><span class=lnt id=hl-39-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-39-6> 6</a>
</span><span class=lnt id=hl-39-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-39-7> 7</a>
</span><span class=lnt id=hl-39-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-39-8> 8</a>
</span><span class=lnt id=hl-39-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-39-9> 9</a>
</span><span class=lnt id=hl-39-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-39-10>10</a>
</span><span class=lnt id=hl-39-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-39-11>11</a>
</span><span class=lnt id=hl-39-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-39-12>12</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@ChannelHandler.Sharable</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>GroupQuitRequestMessageHandler</span> <span class=kd>extends</span> <span class=n>SimpleChannelInboundHandler</span><span class=o>&lt;</span><span class=n>GroupQuitRequestMessage</span><span class=o>&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>channelRead0</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>,</span> <span class=n>GroupQuitRequestMessage</span> <span class=n>msg</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Group</span> <span class=n>group</span> <span class=o>=</span> <span class=n>GroupSessionFactory</span><span class=o>.</span><span class=na>getGroupSession</span><span class=o>().</span><span class=na>removeMember</span><span class=o>(</span><span class=n>msg</span><span class=o>.</span><span class=na>getGroupName</span><span class=o>(),</span> <span class=n>msg</span><span class=o>.</span><span class=na>getUsername</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>group</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>ctx</span><span class=o>.</span><span class=na>writeAndFlush</span><span class=o>(</span><span class=k>new</span> <span class=n>GroupJoinResponseMessage</span><span class=o>(</span><span class=kc>true</span><span class=o>,</span> <span class=s>&#34;已退出群&#34;</span> <span class=o>+</span> <span class=n>msg</span><span class=o>.</span><span class=na>getGroupName</span><span class=o>()));</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>ctx</span><span class=o>.</span><span class=na>writeAndFlush</span><span class=o>(</span><span class=k>new</span> <span class=n>GroupJoinResponseMessage</span><span class=o>(</span><span class=kc>true</span><span class=o>,</span> <span class=n>msg</span><span class=o>.</span><span class=na>getGroupName</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;群不存在&#34;</span><span class=o>));</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>查看成员</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-40-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-40-1>1</a>
</span><span class=lnt id=hl-40-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-40-2>2</a>
</span><span class=lnt id=hl-40-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-40-3>3</a>
</span><span class=lnt id=hl-40-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-40-4>4</a>
</span><span class=lnt id=hl-40-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-40-5>5</a>
</span><span class=lnt id=hl-40-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-40-6>6</a>
</span><span class=lnt id=hl-40-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-40-7>7</a>
</span><span class=lnt id=hl-40-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-40-8>8</a>
</span><span class=lnt id=hl-40-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-40-9>9</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@ChannelHandler.Sharable</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>GroupMembersRequestMessageHandler</span> <span class=kd>extends</span> <span class=n>SimpleChannelInboundHandler</span><span class=o>&lt;</span><span class=n>GroupMembersRequestMessage</span><span class=o>&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>channelRead0</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>,</span> <span class=n>GroupMembersRequestMessage</span> <span class=n>msg</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Set</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>members</span> <span class=o>=</span> <span class=n>GroupSessionFactory</span><span class=o>.</span><span class=na>getGroupSession</span><span class=o>()</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>getMembers</span><span class=o>(</span><span class=n>msg</span><span class=o>.</span><span class=na>getGroupName</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=n>ctx</span><span class=o>.</span><span class=na>writeAndFlush</span><span class=o>(</span><span class=k>new</span> <span class=n>GroupMembersResponseMessage</span><span class=o>(</span><span class=n>members</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#35-聊天室业务-退出><h3 id=35-聊天室业务-退出><span class=hanchor arialabel=Anchor># </span>3.5 聊天室业务-退出</h3></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-41-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-41-1> 1</a>
</span><span class=lnt id=hl-41-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-41-2> 2</a>
</span><span class=lnt id=hl-41-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-41-3> 3</a>
</span><span class=lnt id=hl-41-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-41-4> 4</a>
</span><span class=lnt id=hl-41-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-41-5> 5</a>
</span><span class=lnt id=hl-41-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-41-6> 6</a>
</span><span class=lnt id=hl-41-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-41-7> 7</a>
</span><span class=lnt id=hl-41-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-41-8> 8</a>
</span><span class=lnt id=hl-41-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-41-9> 9</a>
</span><span class=lnt id=hl-41-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-41-10>10</a>
</span><span class=lnt id=hl-41-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-41-11>11</a>
</span><span class=lnt id=hl-41-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-41-12>12</a>
</span><span class=lnt id=hl-41-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-41-13>13</a>
</span><span class=lnt id=hl-41-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-41-14>14</a>
</span><span class=lnt id=hl-41-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-41-15>15</a>
</span><span class=lnt id=hl-41-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-41-16>16</a>
</span><span class=lnt id=hl-41-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-41-17>17</a>
</span><span class=lnt id=hl-41-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-41-18>18</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>@Slf4j
</span></span><span class=line><span class=cl>@ChannelHandler.Sharable
</span></span><span class=line><span class=cl>public class QuitHandler extends ChannelInboundHandlerAdapter {
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    // 当连接断开时触发 inactive 事件
</span></span><span class=line><span class=cl>    @Override
</span></span><span class=line><span class=cl>    public void channelInactive(ChannelHandlerContext ctx) throws Exception {
</span></span><span class=line><span class=cl>        SessionFactory.getSession().unbind(ctx.channel());
</span></span><span class=line><span class=cl>        log.debug(&#34;{} 已经断开&#34;, ctx.channel());
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	// 当出现异常时触发
</span></span><span class=line><span class=cl>    @Override
</span></span><span class=line><span class=cl>    public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) throws Exception {
</span></span><span class=line><span class=cl>        SessionFactory.getSession().unbind(ctx.channel());
</span></span><span class=line><span class=cl>        log.debug(&#34;{} 已经异常断开 异常是{}&#34;, ctx.channel(), cause.getMessage());
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><a href=#36-聊天室业务-空闲检测><h3 id=36-聊天室业务-空闲检测><span class=hanchor arialabel=Anchor># </span>3.6 聊天室业务-空闲检测</h3></a><a href=#连接假死><h4 id=连接假死><span class=hanchor arialabel=Anchor># </span>连接假死</h4></a><a href=#原因><h5 id=原因><span class=hanchor arialabel=Anchor># </span>原因</h5></a><ul><li>网络设备出现故障，例如网卡，机房等，底层的 TCP 连接已经断开了，但应用<strong>程序没有感知</strong>到，仍然占用着资源。</li><li>公网网络不稳定，出现丢包。如果连续出现丢包，这时现象就是客户端数据发不出去，服务端也一直收不到数据，就这么一直耗着</li><li>应用程序线程阻塞，无法进行数据读写</li></ul><a href=#问题><h5 id=问题><span class=hanchor arialabel=Anchor># </span>问题</h5></a><ul><li>假死的连接占用的资源不能自动释放</li><li>向假死的连接发送数据，得到的反馈是发送超时</li></ul><a href=#服务器端解决><h5 id=服务器端解决><span class=hanchor arialabel=Anchor># </span>服务器端解决</h5></a><ul><li>怎么判断客户端连接是否假死呢？如果能收到客户端数据，说明没有假死。因此策略就可以定为，每隔一段时间就检查这段时间内是否接收到客户端数据，没有就可以判定为连接假死</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-42-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-1> 1</a>
</span><span class=lnt id=hl-42-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-2> 2</a>
</span><span class=lnt id=hl-42-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-3> 3</a>
</span><span class=lnt id=hl-42-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-4> 4</a>
</span><span class=lnt id=hl-42-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-5> 5</a>
</span><span class=lnt id=hl-42-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-6> 6</a>
</span><span class=lnt id=hl-42-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-7> 7</a>
</span><span class=lnt id=hl-42-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-8> 8</a>
</span><span class=lnt id=hl-42-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-9> 9</a>
</span><span class=lnt id=hl-42-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-10>10</a>
</span><span class=lnt id=hl-42-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-11>11</a>
</span><span class=lnt id=hl-42-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-12>12</a>
</span><span class=lnt id=hl-42-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-13>13</a>
</span><span class=lnt id=hl-42-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-14>14</a>
</span><span class=lnt id=hl-42-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-15>15</a>
</span><span class=lnt id=hl-42-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-16>16</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 用来判断是不是 读空闲时间过长，或 写空闲时间过长
</span></span></span><span class=line><span class=cl><span class=c1>// 5s 内如果没有收到 channel 的数据，会触发一个 IdleState#READER_IDLE 事件
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>IdleStateHandler</span><span class=o>(</span><span class=n>5</span><span class=o>,</span> <span class=n>0</span><span class=o>,</span> <span class=n>0</span><span class=o>));</span>
</span></span><span class=line><span class=cl><span class=c1>// ChannelDuplexHandler 可以同时作为入站和出站处理器
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>ChannelDuplexHandler</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 用来触发特殊事件
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>userEventTriggered</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>,</span> <span class=n>Object</span> <span class=n>evt</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span><span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>IdleStateEvent</span> <span class=n>event</span> <span class=o>=</span> <span class=o>(</span><span class=n>IdleStateEvent</span><span class=o>)</span> <span class=n>evt</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 触发了读空闲事件
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=o>(</span><span class=n>event</span><span class=o>.</span><span class=na>state</span><span class=o>()</span> <span class=o>==</span> <span class=n>IdleState</span><span class=o>.</span><span class=na>READER_IDLE</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;已经 5s 没有读到数据了&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>ctx</span><span class=o>.</span><span class=na>channel</span><span class=o>().</span><span class=na>close</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>});</span>
</span></span></code></pre></td></tr></table></div></div><a href=#客户端定时心跳><h5 id=客户端定时心跳><span class=hanchor arialabel=Anchor># </span>客户端定时心跳</h5></a><ul><li>客户端可以定时向服务器端发送数据，只要这个时间间隔小于服务器定义的空闲检测的时间间隔，那么就能防止前面提到的误判，客户端可以定义如下心跳处理器</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-43-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-1> 1</a>
</span><span class=lnt id=hl-43-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-2> 2</a>
</span><span class=lnt id=hl-43-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-3> 3</a>
</span><span class=lnt id=hl-43-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-4> 4</a>
</span><span class=lnt id=hl-43-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-5> 5</a>
</span><span class=lnt id=hl-43-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-6> 6</a>
</span><span class=lnt id=hl-43-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-7> 7</a>
</span><span class=lnt id=hl-43-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-8> 8</a>
</span><span class=lnt id=hl-43-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-9> 9</a>
</span><span class=lnt id=hl-43-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-10>10</a>
</span><span class=lnt id=hl-43-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-11>11</a>
</span><span class=lnt id=hl-43-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-12>12</a>
</span><span class=lnt id=hl-43-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-13>13</a>
</span><span class=lnt id=hl-43-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-14>14</a>
</span><span class=lnt id=hl-43-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-15>15</a>
</span><span class=lnt id=hl-43-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-16>16</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 用来判断是不是 读空闲时间过长，或 写空闲时间过长
</span></span></span><span class=line><span class=cl><span class=c1>// 3s 内如果没有向服务器写数据，会触发一个 IdleState#WRITER_IDLE 事件
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>IdleStateHandler</span><span class=o>(</span><span class=n>0</span><span class=o>,</span> <span class=n>3</span><span class=o>,</span> <span class=n>0</span><span class=o>));</span>
</span></span><span class=line><span class=cl><span class=c1>// ChannelDuplexHandler 可以同时作为入站和出站处理器
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>ChannelDuplexHandler</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 用来触发特殊事件
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>userEventTriggered</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>,</span> <span class=n>Object</span> <span class=n>evt</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span><span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>IdleStateEvent</span> <span class=n>event</span> <span class=o>=</span> <span class=o>(</span><span class=n>IdleStateEvent</span><span class=o>)</span> <span class=n>evt</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 触发了写空闲事件
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=o>(</span><span class=n>event</span><span class=o>.</span><span class=na>state</span><span class=o>()</span> <span class=o>==</span> <span class=n>IdleState</span><span class=o>.</span><span class=na>WRITER_IDLE</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>//                                log.debug(&#34;3s 没有写数据了，发送一个心跳包&#34;);
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>ctx</span><span class=o>.</span><span class=na>writeAndFlush</span><span class=o>(</span><span class=k>new</span> <span class=n>PingMessage</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>});</span>
</span></span></code></pre></td></tr></table></div></div></article><hr><div class=page-end id=footer><div class=backlinks-container><h3>反向链接</h3><ul class=backlinks><li>无反向链接</li></ul></div><div><script src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>湾区地图</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://harbor.mffseal.top/js/graph.abd4bc2af3869a96524d7d23b76152c7.js></script></div></div><div id=contact_buttons><footer><p><a rel=license href=http://creativecommons.org/licenses/by-nc/4.0/><img alt="Creative Commons Licence" style=border-width:0 src=https://i.creativecommons.org/l/by-nc/4.0/88x31.png></a><br>本博客的博主原创文章均遵循 <a rel=license href=http://creativecommons.org/licenses/by-nc/4.0/>CC BY-NC(署名-非商业性使用) 4.0 国际协议</a><br>转载请附上原文出处链接及本声明</p><p>由 mffseal 使用 <a href=https://github.com/jackyzha0/quartz>Quartz</a> 开发, © 2023</p><ul><li><a href=https://harbor.mffseal.top/>港口</a></li><li><a href=https://github.com/mffseal>Github</a></li></ul></footer></div></div></body></html>