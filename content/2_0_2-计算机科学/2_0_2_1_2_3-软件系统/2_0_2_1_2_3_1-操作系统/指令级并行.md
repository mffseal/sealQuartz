---
title: 指令级并行
created: 2022-05-30 23:34:39
updated: 2022-05-31 00:58:32
tags: 
- atom
---
# 指令级并行

## 名词解释

### Clock Cycle Time 
主频的概念大家接触的比较多，而 CPU 的 Clock Cycle Time（时钟周期时间），等于主频的倒数，意思是 CPU 能够识别的最小时间单位，比如说 4G 主频的 CPU 的 Clock Cycle Time 就是 0.25 ns，作为对比，我们墙上挂钟的Cycle Time 是 1s。
例如，运行一条加法指令一般需要一个时钟周期时间。
### CPI 
有的指令需要更多的时钟周期时间，所以引出了 CPI （Cycles Per Instruction）指令平均时钟周期数。
### IPC 
IPC（Instruction Per Clock Cycle） 即 CPI 的倒数，表示每个时钟周期能够运行的指令数。
### CPU 执行时间 
程序的 CPU 执行时间，即我们前面提到的 user + system 时间，可以用下面的公式来表示。
程序 CPU 执行时间 = 指令数 * CPI * Clock Cycle Time
## 鱼罐头的故事

加工一条鱼需要 50 分钟，只能一条鱼、一条鱼顺序加工...
![[z-oblib/z2-attachments/Pasted image 20220531001400.png]]

可以将每个鱼罐头的加工流程细分为 5 个步骤：
- 去鳞清洗 10分钟
- 蒸煮沥水 10分钟
- 加注汤料 10分钟
- 杀菌出锅 10分钟
- 真空封罐 10分钟

![[z-oblib/z2-attachments/Pasted image 20220531001700.png]]

即使只有一个工人，最理想的情况是：他能够在 10 分钟内同时做好这 5 件事，因为对第一条鱼的真空装罐，不会影响对第二条鱼的杀菌出锅...

## 指令重排序优化

事实上，现代处理器会设计为一个时钟周期完成一条执行时间最长的 CPU 指令。为什么这么做呢？可以想到指令还可以再划分成一个个更小的阶段，例如，每条指令都可以分为： 取指令 - 指令译码 - 执行指令 - 内存访问 - 数据写回 这 5 个阶段。

```java
// 可以重排的例子
int a = 10; // 指令1
int b = 20; // 指令2
System.out.println( a + b );
 
// 不能重排的例子
int a = 10; // 指令1
int b = a - 5; // 指令2
```

现代 CPU 支持多级指令流水线，例如支持同时执行 取指令 - 指令译码 - 执行指令 - 内存访问 - 数据写回 的处理器，就可以称之为五级指令流水线。这时 CPU 可以在一个时钟周期内，同时运行五条指令的不同阶段（相当于一条执行时间最长的复杂指令），IPC = 1，本质上，流水线技术并不能缩短单条指令的执行时间，但它变相地提高了指令地吞吐率。

![[z-oblib/z2-attachments/Pasted image 20220531005822.png]]
优化为
![[z-oblib/z2-attachments/Pasted image 20220531005812.png]]

