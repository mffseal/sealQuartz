---
title: Mark Word
created: 2022-04-28 15:19:34
updated: 2022-05-27 19:14:03
tags: 
- atom
---
# Mark Word

用于存储对象自身的运行时数据，如哈希码（HashCode）、GC分代年龄、锁状态标志、[[3-计算机科学/2-计算机组成原理/线程|线程]]持有的锁、偏向线程ID、偏向时间戳等等。

Mark Word在32位JVM中的长度是32bit，在64位JVM中长度是64bit。我们打开[openjdk的源码包](https://download.java.net/openjdk/jdk8/promoted/b132/openjdk-8-src-b132-03_mar_2014.zip)，对应路径`/openjdk/hotspot/src/share/vm/oops`，Mark Word对应到C++的代码`markOop.hpp`，可以从注释中看到它们的组成，本文所有代码是基于Jdk1.8。

Mark Word在不同的锁状态下存储的内容不同，在32位JVM中是这么存的：

![[z-oblib/z2-attachments/1162587-20200918154115022-312986152.png]]

在64位JVM中是这么存的：

![[z-oblib/z2-attachments/1162587-20200918154125385-1537793659.png]]

虽然它们在不同位数的JVM中长度不一样，但是基本组成内容是一致的。

> 注意上述结构不是每一行都同时存在，而是根据锁标志位来决定当前行的状态。
> 例如在重量级锁状态下，当对象获取到Mointer的时，会先复制并暂存无锁态对应的信息，将信息覆写为Mointer地址。当释放锁后，会恢复无锁态对应数据。

- **锁标志位（lock）**：区分锁状态，11时表示对象待GC回收状态, 只有最后2位锁标识(11)有效。
- **biased_lock**：是否[[3-计算机科学/6-应用开发/0-软件语言/Java/2-并发编程/偏向锁|偏向锁]]，由于无锁和偏向锁的锁标识都是 01，没办法区分，这里引入一位的偏向锁标识位。
- **分代年龄（age）**：表示对象被GC的次数，当该次数到达阈值的时候，对象就会转移到老年代。
- **对象的hashcode（hash）**：运行期间调用System.identityHashCode()来计算，延迟计算，并把结果赋值到这里。当对象加锁后，计算的结果31位不够表示，在偏向锁，轻量锁，重量锁，hashcode会被转移到Monitor中。
- **偏向锁的线程ID（JavaThread）**：偏向模式的时候，当某个线程持有对象的时候，对象这里就会被置为该线程的ID。 在后面的操作中，就无需再进行尝试获取锁的动作。
- **epoch**：偏向锁在CAS锁操作过程中，偏向性标识，表示对象更偏向哪个锁。
- **ptr_to_lock_record**：[[3-计算机科学/6-应用开发/0-软件语言/Java/2-并发编程/轻量级锁|轻量级锁]]状态下，指向栈中锁记录的指针。当锁获取是无竞争的时，JVM使用原子操作而不是OS互斥。这种技术称为轻量级锁定。在轻量级锁定的情况下，JVM通过[[3-计算机科学/6-应用开发/0-软件语言/Java/2-并发编程/CAS|CAS]]操作在对象的标题字中设置指向锁记录的指针。
- **ptr_to_heavyweight_monitor**：[[3-计算机科学/6-应用开发/0-软件语言/Java/2-并发编程/重量级锁|重量级锁]]状态下，指向对象监视器[[3-计算机科学/6-应用开发/0-软件语言/Java/2-并发编程/monitor|Monitor]]的指针。如果两个不同的线程同时在同一个对象上竞争，则必须将轻量级锁定升级到Monitor以管理等待的线程。在重量级锁定的情况下，JVM在对象的ptr_to_heavyweight_monitor设置指向Monitor的指针。