---
title: JVM的栈帧
created: 2022-05-26 10:53:10
updated: 2022-10-02 21:19:57
tags: 
- atom
---

# JVM的栈帧

栈帧（Stack [Frame](https://so.csdn.net/so/search?q=Frame&spm=1001.2101.3001.7020)）是用于支持虚拟机进行方法调用和方法执行的数据结构。它是虚拟机**运行时**数据区中的虚拟机栈的栈元素。

栈帧存储了方法的局部变量表、操作数栈、动态连接和方法返回地址等信息。

每一个方法从调用开始至执行完成的过程，都对应着一个栈帧在[虚拟机](https://so.csdn.net/so/search?q=%E8%99%9A%E6%8B%9F%E6%9C%BA&spm=1001.2101.3001.7020)里面从入栈到出栈的过程。

> 在编译程序代码的时候，栈帧中需要多大的局部变量表，多深的操作数栈都已经完全确定了。
> 
> 因此一**个栈帧需要分配多少内存，不会受到程序运行期变量数据的影响**，而仅仅取决于具体的虚拟机实现。

## 局部变量表

局部变量表（Local Variable Table）是一组变量值存储空间，用于存放**方法参数**和方法内部定义的**局部变量**。并且在Java编译为Class文件时，就已经确定了该方法所需要分配的局部变量表的最大容量。

## 动态连接

每个栈帧都包含一个指向运行时常量池中该栈帧所属方法的引用，持有这个引用是为了支付方法调用过程中的动态连接（Dynamic Linking）。

在类加载阶段中的解析阶段会将符号引用转为直接引用，这种转化也称为静态解析。另外的一部分将在每一次运行时期转化为直接引用。这部分称为动态连接。

## 返回地址

当一个方法开始执行后，只有2种方式可以退出这个方法 ：

- 方法返回指令 ： 执行引擎遇到一个方法返回的字节码指令，这时候有可能会有返回值传递给上层的方法调用者，这种退出方式称为正常完成出口。
- 异常退出 ： 在方法执行过程中遇到了异常，并且没有处理这个异常，就会导致方法退出。


无论采用任何退出方式，在方法退出之后，都需要返回到方法被调用的位置，程序才能继续执行，方法返回时可能需要在栈帧中保存一些信息。

> 一般来说，方法正常退出时，**调用者**的PC计数器的值可以作为返回地址，栈帧中会保存这个计数器值。
> 而方法异常退出时，返回地址是要通过异常处理器表来确定的，栈帧中一般不会保存这部分信息。

## 操作数栈

操作数栈主要用于保存计算过程的中间结果。

操作数栈和局部变量表一样，在编译时期就已经确定了该方法所需要分配的局部变量表的最大容量。

操作数栈的每一个元素可用是任意的Java数据类型，包括long和double。32位数据类型所占的栈容量为1，64位数据类型占用的栈容量为2。
