---
title: 文件指针
created: 2022-08-02 23:18:40
updated: 2022-08-02 23:36:02
tags: 
- atom
---
# 文件指针

> [2、文件指针与文件描述符 - 孤情剑客 - 博客园 (cnblogs.com)](https://www.cnblogs.com/The-explosion/articles/12246297.html)

"文件指针(file pointer)"指向进程用户区中的一个被称为FILE结构的数据结构。FILE结构包括一个缓冲区和一个文件描述符值。而文件描述符值是文件描述符表中的一个索引。从某种意义上说文件指针就是句柄的句柄。
每个被使用的文件都在内存中开辟了一个区域，用来存放文件的有关信息，这些信息是保存在一个结构体类型的变量中，该结构体类型是由系统定义的，取名为FILE。



```c
/*FILE结构体*/
#ifndef _FILE_DEFINED
struct _iobuf 
{
    char *_ptr;       //文件输入的下一个位置 
    int  _cnt;        //当前缓冲区的相对位置 
    char *_base;      //指基础位置(即是文件的其始位置) 
    int  _flag;       //文件标志 
    int  _file;       //文件的有效性验证 
    int  _charbuf;    //检查缓冲区状况,如果无缓冲区则不读取 
    int  _bufsiz;     //缓冲区大小 
    char *_tmpfname;  //临时文件名
};
typedef struct _iobuf FILE;
```

实际上，FILE结构是间接地操作系统的文件控制块 (FCB)来实现对文件的操作的，如下图：

![[z-oblib/z2-attachments/Pasted image 20220802233104.png]]

上面图中的_file实际上是一个描述符，作为进入打开文件表索引的整数。

文件是存放在物理磁盘上的，包括文件控制块(FCB)和数据块。文件控制块通常包括文件权限、日期（创建、读取、修改）、拥有者、文件大小、数据块信息。数据块用来存储实际的内容。对于打开的文件，操作系统是这样管理的：系统维护了两张表，一张是系统级打开文件表【指向i节点】，一张是进程级打开文件表（每个进程有一个）【指向FILE结构体】。系统级打开文件表复制了文件控制块的信息等；进程级打开文件表保存了指向系统级文件表的指针及其他信息。

系统级文件表每一项都保存一个计数器，即该文件打开的次数。我们初次打开一个文件时，系统首先查看该文件是否已在系统级文件表中，如果不在，则创建该项信息，否则，计数器加1。当我们关闭一个文件时，相应的计数也会减1，当减到0时，系统将系统级文件表中的项删除。 

进程打开一个文件时，会在进程级文件表中添加一项。每项的信息包括当前文件偏移量（读写文件的位置）、存取权限、和**一个指向系统级文件表中对应文件项的指针**。系统级文件表中的每一项通过文件描述符（一个非负整数）来标识。

通过上面所讲述的可以发现：FILE结构体中的_file成员应该是指向进程级打开文件表，然后，**通过进程级打开文件表可以找到系统级打开文件表**，进而可以通过FCB操作物理磁盘上面的文件。