<!doctype html><html lang=en><head><meta charset=utf-8><meta name=description content="Nettyå…¥é—¨ 1. æ¦‚è¿° 1.1 Netty æ˜¯ä»€ä¹ˆï¼Ÿ 1 2  Netty is an asynchronous event-driven network application framework for rapid development of maintainable high performance protocol servers & clients.   Netty æ˜¯ä¸€ä¸ªå¼‚æ­¥çš„ã€åŸºäºäº‹ä»¶é©±åŠ¨çš„ç½‘ç»œåº”ç”¨æ¡†æ¶ï¼Œç”¨äºå¿«é€Ÿå¼€å‘å¯ç»´æŠ¤ã€é«˜æ€§èƒ½çš„ç½‘ç»œæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯
1.2 Netty çš„ä½œè€… ![[z-oblib/z2-attachments/64fc67105d460cb23e0bcc014ba4c21f.png]]
ä»–è¿˜æ˜¯å¦ä¸€ä¸ªè‘—åç½‘ç»œåº”ç”¨æ¡†æ¶ Mina çš„é‡è¦è´¡çŒ®è€…
1.3 Netty çš„åœ°ä½ Netty åœ¨ Java ç½‘ç»œåº”ç”¨æ¡†æ¶ä¸­çš„åœ°ä½å°±å¥½æ¯”ï¼šSpring æ¡†æ¶åœ¨ JavaEE å¼€å‘ä¸­çš„åœ°ä½
ä»¥ä¸‹çš„æ¡†æ¶éƒ½ä½¿ç”¨äº† Nettyï¼Œå› ä¸ºå®ƒä»¬æœ‰ç½‘ç»œé€šä¿¡éœ€æ±‚ï¼
 Cassandra - nosql æ•°æ®åº“ Spark - å¤§æ•°æ®åˆ†å¸ƒå¼è®¡ç®—æ¡†æ¶ Hadoop - å¤§æ•°æ®åˆ†å¸ƒå¼å­˜å‚¨æ¡†æ¶ RocketMQ - ali å¼€æºçš„æ¶ˆæ¯é˜Ÿåˆ— ElasticSearch - æœç´¢å¼•æ“ gRPC - rpc æ¡†æ¶ Dubbo - rpc æ¡†æ¶ Spring 5."><title>Nettyå…¥é—¨</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://harbor.mffseal.top//icon.png><link href=https://harbor.mffseal.top/styles.7153093e4d1bbb584a28469cadfa3f88.min.css rel=stylesheet><link href=https://harbor.mffseal.top/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://harbor.mffseal.top/js/darkmode.9841b88d44c115f7419d485ee72d23a2.min.js></script>
<script src=https://harbor.mffseal.top/js/util.9825137f5e7825e8553c68ce39ac9e44.min.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js integrity=sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A crossorigin=anonymous></script>
<script src=https://unpkg.com/@floating-ui/core@0.7.3></script>
<script src=https://unpkg.com/@floating-ui/dom@0.5.4></script>
<script src=https://harbor.mffseal.top/js/popover.53ad9a087e3feeaaa12b63bfd02d923b.min.js></script>
<script src=https://harbor.mffseal.top/js/code-title.b35124ad8db0ba37162b886afb711cbc.min.js></script>
<script src=https://harbor.mffseal.top/js/clipboard.c20857734e53a3fb733b7443879efa61.min.js></script>
<script src=https://harbor.mffseal.top/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const BASE_URL="https://harbor.mffseal.top/",fetchData=Promise.all([fetch("https://harbor.mffseal.top/indices/linkIndex.50149d4f06f7f6d699f2eab42c3848b3.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://harbor.mffseal.top/indices/contentIndex.2f776d63de615717fa30f0bbaae8b3d2.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addTitleToCodeBlocks(),addCollapsibleCallouts(),initPopover("https://harbor.mffseal.top",!0,!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!1;drawGraph("https://harbor.mffseal.top",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],macros:{'â€™':"'"},throwOnError:!1})}</script><script type=module>
    import { attachSPARouting } from "https:\/\/harbor.mffseal.top\/js\/router.9d4974281069e9ebb189f642ae1e3ca2.min.js"
    attachSPARouting(init, render)
  </script></head><script async src="https://www.googletagmanager.com/gtag/js?id=G-NV58SYWRZD"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-NV58SYWRZD",{anonymize_ip:!1})}</script><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://harbor.mffseal.top/js/full-text-search.24827f874defbbc6d529926cbfcfb493.min.js></script><div class=singlePage><header><h1 id=page-title><a href=https://harbor.mffseal.top/>ğŸ¦­ æ¸¯æ¹¾</a></h1><div class=spacer></div><div id=search-icon><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><h1>Nettyå…¥é—¨</h1><p class=meta>Last updated
Jun 21, 2022
<a href=https://github.com/mffseal/2_0_2-%e8%ae%a1%e7%ae%97%e6%9c%ba%e7%a7%91%e5%ad%a6/2_0_2_2_1_0-web%e5%90%8e%e7%ab%af/Netty/Netty%e5%85%a5%e9%97%a8.md rel=noopener>Edit Source</a></p><ul class=tags></ul><aside class=mainTOC><details><summary>Table of Contents</summary><nav id=TableOfContents><ol><li><a href=#1-æ¦‚è¿°>1. æ¦‚è¿°</a><ol><li><a href=#11-netty-æ˜¯ä»€ä¹ˆ>1.1 Netty æ˜¯ä»€ä¹ˆï¼Ÿ</a></li><li><a href=#12-netty-çš„ä½œè€…>1.2 Netty çš„ä½œè€…</a></li><li><a href=#13-netty-çš„åœ°ä½>1.3 Netty çš„åœ°ä½</a></li><li><a href=#14-netty-çš„ä¼˜åŠ¿>1.4 Netty çš„ä¼˜åŠ¿</a></li></ol></li><li><a href=#2-hello-world>2. Hello World</a><ol><li><a href=#21-ç›®æ ‡>2.1 ç›®æ ‡</a></li><li><a href=#22-æœåŠ¡å™¨ç«¯>2.2 æœåŠ¡å™¨ç«¯</a></li><li><a href=#23-å®¢æˆ·ç«¯>2.3 å®¢æˆ·ç«¯</a></li><li><a href=#24-æµç¨‹æ¢³ç†>2.4 æµç¨‹æ¢³ç†</a></li></ol></li><li><a href=#3-ç»„ä»¶>3. ç»„ä»¶</a><ol><li><a href=#31-eventloop>3.1 EventLoop</a></li><li><a href=#32-channel>3.2 Channel</a></li><li><a href=#33-future--promise>3.3 Future & Promise</a></li><li><a href=#34-handler--pipeline>3.4 Handler & Pipeline</a></li><li><a href=#35-bytebuf>3.5 ByteBuf</a></li></ol></li><li><a href=#4-åŒå‘é€šä¿¡>4. åŒå‘é€šä¿¡</a><ol><li><a href=#41-ç»ƒä¹ >4.1 ç»ƒä¹ </a></li><li><a href=#-è¯»å’Œå†™çš„è¯¯è§£>ğŸ’¡ è¯»å’Œå†™çš„è¯¯è§£</a></li></ol></li></ol></nav></details></aside><a href=#nettyå…¥é—¨><h1 id=nettyå…¥é—¨><span class=hanchor arialabel=Anchor># </span>Nettyå…¥é—¨</h1></a><a href=#1-æ¦‚è¿°><h2 id=1-æ¦‚è¿°><span class=hanchor arialabel=Anchor># </span>1. æ¦‚è¿°</h2></a><a href=#11-netty-æ˜¯ä»€ä¹ˆ><h3 id=11-netty-æ˜¯ä»€ä¹ˆ><span class=hanchor arialabel=Anchor># </span>1.1 Netty æ˜¯ä»€ä¹ˆï¼Ÿ</h3></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Netty is an asynchronous event-driven network application framework
</span></span><span class=line><span class=cl>for rapid development of maintainable high performance protocol servers &amp; clients.
</span></span></code></pre></td></tr></table></div></div><p>Netty æ˜¯ä¸€ä¸ªå¼‚æ­¥çš„ã€åŸºäºäº‹ä»¶é©±åŠ¨çš„ç½‘ç»œåº”ç”¨æ¡†æ¶ï¼Œç”¨äºå¿«é€Ÿå¼€å‘å¯ç»´æŠ¤ã€é«˜æ€§èƒ½çš„ç½‘ç»œæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯</p><a href=#12-netty-çš„ä½œè€…><h3 id=12-netty-çš„ä½œè€…><span class=hanchor arialabel=Anchor># </span>1.2 Netty çš„ä½œè€…</h3></a><p><img src=/z-oblib/z2-attachments/64fc67105d460cb23e0bcc014ba4c21f.png width=auto></p><p>ä»–è¿˜æ˜¯å¦ä¸€ä¸ªè‘—åç½‘ç»œåº”ç”¨æ¡†æ¶ Mina çš„é‡è¦è´¡çŒ®è€…</p><a href=#13-netty-çš„åœ°ä½><h3 id=13-netty-çš„åœ°ä½><span class=hanchor arialabel=Anchor># </span>1.3 Netty çš„åœ°ä½</h3></a><p>Netty åœ¨ Java ç½‘ç»œåº”ç”¨æ¡†æ¶ä¸­çš„åœ°ä½å°±å¥½æ¯”ï¼šSpring æ¡†æ¶åœ¨ JavaEE å¼€å‘ä¸­çš„åœ°ä½</p><p>ä»¥ä¸‹çš„æ¡†æ¶éƒ½ä½¿ç”¨äº† Nettyï¼Œå› ä¸ºå®ƒä»¬æœ‰ç½‘ç»œé€šä¿¡éœ€æ±‚ï¼</p><ul><li>Cassandra - nosql æ•°æ®åº“</li><li>Spark - å¤§æ•°æ®åˆ†å¸ƒå¼è®¡ç®—æ¡†æ¶</li><li>Hadoop - å¤§æ•°æ®åˆ†å¸ƒå¼å­˜å‚¨æ¡†æ¶</li><li>RocketMQ - ali å¼€æºçš„æ¶ˆæ¯é˜Ÿåˆ—</li><li>ElasticSearch - æœç´¢å¼•æ“</li><li>gRPC - rpc æ¡†æ¶</li><li>Dubbo - rpc æ¡†æ¶</li><li>Spring 5.x - flux api å®Œå…¨æŠ›å¼ƒäº† tomcat ï¼Œä½¿ç”¨ netty ä½œä¸ºæœåŠ¡å™¨ç«¯</li><li>Zookeeper - åˆ†å¸ƒå¼åè°ƒæ¡†æ¶</li></ul><a href=#14-netty-çš„ä¼˜åŠ¿><h3 id=14-netty-çš„ä¼˜åŠ¿><span class=hanchor arialabel=Anchor># </span>1.4 Netty çš„ä¼˜åŠ¿</h3></a><ul><li>Netty vs NIOï¼Œå·¥ä½œé‡å¤§ï¼Œbug å¤š<ul><li>éœ€è¦è‡ªå·±æ„å»ºåè®®</li><li>è§£å†³ TCP ä¼ è¾“é—®é¢˜ï¼Œå¦‚ç²˜åŒ…ã€åŠåŒ…</li><li>epoll ç©ºè½®è¯¢å¯¼è‡´ CPU 100%</li><li>å¯¹ API è¿›è¡Œå¢å¼ºï¼Œä½¿ä¹‹æ›´æ˜“ç”¨ï¼Œå¦‚ FastThreadLocal => ThreadLocalï¼ŒByteBuf => ByteBuffer</li></ul></li><li>Netty vs å…¶å®ƒç½‘ç»œåº”ç”¨æ¡†æ¶<ul><li>Mina ç”± apache ç»´æŠ¤ï¼Œå°†æ¥ 3.x ç‰ˆæœ¬å¯èƒ½ä¼šæœ‰è¾ƒå¤§é‡æ„ï¼Œç ´å API å‘ä¸‹å…¼å®¹æ€§ï¼ŒNetty çš„å¼€å‘è¿­ä»£æ›´è¿…é€Ÿï¼ŒAPI æ›´ç®€æ´ã€æ–‡æ¡£æ›´ä¼˜ç§€</li><li>ä¹…ç»è€ƒéªŒï¼Œ16å¹´ï¼ŒNetty ç‰ˆæœ¬<ul><li>2.x 2004</li><li>3.x 2008</li><li>4.x 2013</li><li>5.x å·²åºŸå¼ƒï¼ˆæ²¡æœ‰æ˜æ˜¾çš„æ€§èƒ½æå‡ï¼Œç»´æŠ¤æˆæœ¬é«˜ï¼‰</li></ul></li></ul></li></ul><a href=#2-hello-world><h2 id=2-hello-world><span class=hanchor arialabel=Anchor># </span>2. Hello World</h2></a><a href=#21-ç›®æ ‡><h3 id=21-ç›®æ ‡><span class=hanchor arialabel=Anchor># </span>2.1 ç›®æ ‡</h3></a><p>å¼€å‘ä¸€ä¸ªç®€å•çš„æœåŠ¡å™¨ç«¯å’Œå®¢æˆ·ç«¯</p><ul><li>å®¢æˆ·ç«¯å‘æœåŠ¡å™¨ç«¯å‘é€ hello, world</li><li>æœåŠ¡å™¨ä»…æ¥æ”¶ï¼Œä¸è¿”å›</li></ul><p>åŠ å…¥ä¾èµ–</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;groupId&gt;</span>io.netty<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;artifactId&gt;</span>netty-all<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;version&gt;</span>4.1.39.Final<span class=nt>&lt;/version&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table></div></div><a href=#22-æœåŠ¡å™¨ç«¯><h3 id=22-æœåŠ¡å™¨ç«¯><span class=hanchor arialabel=Anchor># </span>2.2 æœåŠ¡å™¨ç«¯</h3></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// æœåŠ¡å™¨ç«¯çš„å¯åŠ¨å™¨ï¼Œè´Ÿè´£ç»„è£…nattyç»„ä»¶ï¼Œåè°ƒå·¥ä½œå¹¶å¯åŠ¨ã€‚
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>new</span> <span class=n>ServerBootstrap</span><span class=o>()</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>group</span><span class=o>(</span><span class=k>new</span> <span class=n>NioEventLoopGroup</span><span class=o>())</span> <span class=c1>// 1
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>.</span><span class=na>channel</span><span class=o>(</span><span class=n>NioServerSocketChannel</span><span class=o>.</span><span class=na>class</span><span class=o>)</span> <span class=c1>// 2
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>.</span><span class=na>childHandler</span><span class=o>(</span><span class=k>new</span> <span class=n>ChannelInitializer</span><span class=o>&lt;</span><span class=n>NioSocketChannel</span><span class=o>&gt;()</span> <span class=o>{</span> <span class=c1>// 3
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>initChannel</span><span class=o>(</span><span class=n>NioSocketChannel</span> <span class=n>ch</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>StringDecoder</span><span class=o>());</span> <span class=c1>// 5
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>SimpleChannelInboundHandler</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;()</span> <span class=o>{</span> <span class=c1>// 6
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>                <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>channelRead0</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>,</span> <span class=n>String</span> <span class=n>msg</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>msg</span><span class=o>);</span>  <span class=c1>// æ‰“å°ä¸Šä¸€æ­¥è½¬æ¢å¥½çš„å­—ç¬¦ä¸²
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>});</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>})</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>bind</span><span class=o>(</span><span class=n>8080</span><span class=o>);</span> <span class=c1>// 4
</span></span></span></code></pre></td></tr></table></div></div><p>ä»£ç è§£è¯»</p><ul><li><p>1 å¤„ï¼Œåˆ›å»º NioEventLoopGroupï¼Œå¯ä»¥ç®€å•ç†è§£ä¸º <code>çº¿ç¨‹æ±  + Selector</code> ï¼ŒåŒ…å«<a href=/2_0_2-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/2_0_2_1_2_0-%E8%BD%AF%E4%BB%B6%E8%AF%AD%E8%A8%80/Java/NIO/NIO%E5%9F%BA%E7%A1%80#-%e5%88%a9%e7%94%a8%e5%a4%9a%e7%ba%bf%e7%a8%8b%e4%bc%98%e5%8c%96 rel=noopener class=internal-link data-src=/2_0_2-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/2_0_2_1_2_0-%E8%BD%AF%E4%BB%B6%E8%AF%AD%E8%A8%80/Java/NIO/NIO%E5%9F%BA%E7%A1%80>NIO</a>éƒ¨åˆ†çš„Bosså’ŒWorkerä¸¤ä¸ªé€‰æ‹©å™¨åŠå¯¹åº”çš„çº¿ç¨‹ç­‰ã€‚</p></li><li><p>2 å¤„ï¼Œé€‰æ‹©æœåŠ¡ Scoket å®ç°ç±»ï¼Œå…¶ä¸­ NioServerSocketChannel è¡¨ç¤ºåŸºäº NIO çš„æœåŠ¡å™¨ç«¯å®ç°ï¼Œå…¶å®ƒå®ç°è¿˜æœ‰</p></li></ul><p><img src=/z-oblib/z2-attachments/e96dc3fa309784d125c72bc9f1dcbb3f.png width=auto></p><ul><li><p>3 å¤„ï¼Œæ·»åŠ çš„å¤„ç†å™¨éƒ½æ˜¯ç»™ SocketChannel ç”¨çš„ï¼Œä¹Ÿå°±æ˜¯å‘Šè¯‰workerå¦‚ä½•å»å¤„ç†ç½‘ç»œä¸­çš„æ•°æ®ï¼ˆç¼–è§£ç ã€ä¸šåŠ¡å¤„ç†&mldr;ï¼‰ã€‚ChannelInitializer å¤„ç†å™¨ï¼ˆä»…æ‰§è¡Œä¸€æ¬¡ï¼‰ï¼Œå®ƒçš„ä½œç”¨æ˜¯å¾…å®¢æˆ·ç«¯ SocketChannel å»ºç«‹è¿æ¥åï¼Œæ‰§è¡Œ initChannel ä»¥ä¾¿æ·»åŠ æ›´å¤šçš„å¤„ç†å™¨ï¼Œè¿™é‡Œæ·»åŠ äº† 5 6ä¸¤ä¸ªå¤„ç†å™¨ã€‚</p></li><li><p>4 å¤„ï¼ŒServerSocketChannel ç»‘å®šçš„ç›‘å¬ç«¯å£ã€‚</p></li><li><p>5 å¤„ï¼ŒSocketChannel çš„å¤„ç†å™¨ï¼Œè§£ç  ByteBuf => Stringã€‚</p></li><li><p>6 å¤„ï¼Œè‡ªå®šä¹‰çš„SocketChannel çš„ä¸šåŠ¡å¤„ç†å™¨ï¼Œæ¥å—çš„æ¶ˆæ¯æ˜¯ä¸Šä¸€ä¸ªå¤„ç†å™¨çš„å¤„ç†ç»“æœã€‚</p></li></ul><a href=#23-å®¢æˆ·ç«¯><h3 id=23-å®¢æˆ·ç«¯><span class=hanchor arialabel=Anchor># </span>2.3 å®¢æˆ·ç«¯</h3></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>new</span> <span class=n>Bootstrap</span><span class=o>()</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>group</span><span class=o>(</span><span class=k>new</span> <span class=n>NioEventLoopGroup</span><span class=o>())</span> <span class=c1>// 1
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>.</span><span class=na>channel</span><span class=o>(</span><span class=n>NioSocketChannel</span><span class=o>.</span><span class=na>class</span><span class=o>)</span> <span class=c1>// 2
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>.</span><span class=na>handler</span><span class=o>(</span><span class=k>new</span> <span class=n>ChannelInitializer</span><span class=o>&lt;</span><span class=n>Channel</span><span class=o>&gt;()</span> <span class=o>{</span> <span class=c1>// 3
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>initChannel</span><span class=o>(</span><span class=n>Channel</span> <span class=n>ch</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>StringEncoder</span><span class=o>());</span> <span class=c1>// 8
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>})</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>connect</span><span class=o>(</span><span class=s>&#34;127.0.0.1&#34;</span><span class=o>,</span> <span class=n>8080</span><span class=o>)</span> <span class=c1>// 4
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>.</span><span class=na>sync</span><span class=o>()</span> <span class=c1>// 5
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>.</span><span class=na>channel</span><span class=o>()</span> <span class=c1>// 6
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>.</span><span class=na>writeAndFlush</span><span class=o>(</span><span class=k>new</span> <span class=n>Date</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;: hello world!&#34;</span><span class=o>);</span> <span class=c1>// 7
</span></span></span></code></pre></td></tr></table></div></div><p>ä»£ç è§£è¯»</p><ul><li><p>1 å¤„ï¼Œåˆ›å»º NioEventLoopGroupï¼ŒåŒ Server</p></li><li><p>2 å¤„ï¼Œé€‰æ‹©å®¢æˆ· Socket å®ç°ç±»ï¼ŒNioSocketChannel è¡¨ç¤ºåŸºäº NIO çš„å®¢æˆ·ç«¯å®ç°ï¼Œå…¶å®ƒå®ç°è¿˜æœ‰</p></li></ul><p><img src=/z-oblib/z2-attachments/10eac7273abe4f354a285f9b498a2825.png width=auto></p><ul><li>3 å¤„ï¼Œæ·»åŠ  SocketChannel çš„å¤„ç†å™¨ï¼ŒChannelInitializer å¤„ç†å™¨ï¼ˆä»…æ‰§è¡Œä¸€æ¬¡ï¼‰ï¼Œå®ƒçš„ä½œç”¨æ˜¯å¾…å®¢æˆ·ç«¯ SocketChannel å»ºç«‹è¿æ¥åï¼Œæ‰§è¡Œ initChannel ä»¥ä¾¿æ·»åŠ æ›´å¤šçš„å¤„ç†å™¨</li><li>4 å¤„ï¼ŒæŒ‡å®šè¦è¿æ¥çš„æœåŠ¡å™¨å’Œç«¯å£</li><li>5 å¤„ï¼Œsyncæ˜¯ä¸€ä¸ªåŒæ­¥ï¼ˆé˜»å¡ï¼‰æ–¹æ³•ã€‚Netty ä¸­å¾ˆå¤šæ–¹æ³•éƒ½æ˜¯å¼‚æ­¥çš„ï¼Œå¦‚ connectï¼Œè¿™æ—¶éœ€è¦ä½¿ç”¨ sync æ–¹æ³•ç­‰å¾… connect å»ºç«‹è¿æ¥å®Œæ¯•</li><li>6 å¤„ï¼Œè·å– channel å¯¹è±¡ï¼Œå®ƒå³ä¸ºé€šé“æŠ½è±¡ï¼Œå¯ä»¥è¿›è¡Œæ•°æ®è¯»å†™æ“ä½œ</li><li>7 å¤„ï¼Œå†™å…¥æ¶ˆæ¯å¹¶æ¸…ç©ºç¼“å†²åŒº</li><li>8 å¤„ï¼Œæ¶ˆæ¯ä¼šç»è¿‡é€šé“ handler å¤„ç†ï¼Œè¿™é‡Œæ˜¯å°† String => ByteBuf å‘å‡º</li><li>æ•°æ®ç»è¿‡ç½‘ç»œä¼ è¾“ï¼Œåˆ°è¾¾æœåŠ¡å™¨ç«¯ï¼ŒæœåŠ¡å™¨ç«¯ 5 å’Œ 6 å¤„çš„ handler å…ˆåè¢«è§¦å‘ï¼Œèµ°å®Œä¸€ä¸ªæµç¨‹</li></ul><a href=#24-æµç¨‹æ¢³ç†><h3 id=24-æµç¨‹æ¢³ç†><span class=hanchor arialabel=Anchor># </span>2.4 æµç¨‹æ¢³ç†</h3></a><p><img src=/z-oblib/z2-attachments/adea72dac7ceb3d0f0158cd3d7acdd57.png width=auto></p><a href=#-æç¤º><h4 id=-æç¤º><span class=hanchor arialabel=Anchor># </span>ğŸ’¡ æç¤º</h4></a><blockquote><p>ä¸€å¼€å§‹éœ€è¦æ ‘ç«‹æ­£ç¡®çš„è§‚å¿µ</p><ul><li>æŠŠ channel ç†è§£ä¸ºæ•°æ®çš„é€šé“</li><li>æŠŠ msg ç†è§£ä¸ºæµåŠ¨çš„æ•°æ®ï¼Œæœ€å¼€å§‹è¾“å…¥æ˜¯ ByteBufï¼Œä½†ç»è¿‡ pipeline çš„åŠ å·¥ï¼Œä¼šå˜æˆå…¶å®ƒç±»å‹å¯¹è±¡ï¼Œæœ€åè¾“å‡ºåˆå˜æˆ ByteBuf</li><li>æŠŠ handler ç†è§£ä¸ºæ•°æ®çš„å¤„ç†å·¥åº<ul><li>å·¥åºæœ‰å¤šé“ï¼Œåˆåœ¨ä¸€èµ·å°±æ˜¯ pipelineï¼Œpipeline è´Ÿè´£å‘å¸ƒäº‹ä»¶ï¼ˆè¯»ã€è¯»å–å®Œæˆ&mldr;ï¼‰ä¼ æ’­ç»™æ¯ä¸ª handlerï¼Œ handler å¯¹è‡ªå·±æ„Ÿå…´è¶£çš„äº‹ä»¶è¿›è¡Œå¤„ç†ï¼ˆé‡å†™äº†ç›¸åº”äº‹ä»¶å¤„ç†æ–¹æ³•ï¼‰</li><li>handler åˆ† Inbound å’Œ Outbound ä¸¤ç±»</li></ul></li><li>æŠŠ eventLoop ç†è§£ä¸ºå¤„ç†æ•°æ®çš„å·¥äºº<ul><li>å·¥äººå¯ä»¥ç®¡ç†å¤šä¸ª channel çš„ io æ“ä½œï¼Œå¹¶ä¸”ä¸€æ—¦å·¥äººè´Ÿè´£äº†æŸä¸ª channelï¼Œå°±è¦è´Ÿè´£åˆ°åº•ï¼ˆç»‘å®šï¼‰</li><li>å·¥äººæ—¢å¯ä»¥æ‰§è¡Œ io æ“ä½œï¼Œä¹Ÿå¯ä»¥è¿›è¡Œä»»åŠ¡å¤„ç†ï¼Œæ¯ä½å·¥äººæœ‰ä»»åŠ¡é˜Ÿåˆ—ï¼Œé˜Ÿåˆ—é‡Œå¯ä»¥å †æ”¾å¤šä¸ª channel çš„å¾…å¤„ç†ä»»åŠ¡ï¼Œä»»åŠ¡åˆ†ä¸ºæ™®é€šä»»åŠ¡ã€å®šæ—¶ä»»åŠ¡</li><li>å·¥äººæŒ‰ç…§ pipeline é¡ºåºï¼Œä¾æ¬¡æŒ‰ç…§ handler çš„è§„åˆ’ï¼ˆä»£ç ï¼‰å¤„ç†æ•°æ®ï¼Œå¯ä»¥ä¸ºæ¯é“å·¥åºæŒ‡å®šä¸åŒçš„å·¥äºº</li></ul></li></ul></blockquote><a href=#3-ç»„ä»¶><h2 id=3-ç»„ä»¶><span class=hanchor arialabel=Anchor># </span>3. ç»„ä»¶</h2></a><a href=#31-eventloop><h3 id=31-eventloop><span class=hanchor arialabel=Anchor># </span>3.1 EventLoop</h3></a><blockquote><p>ä¸€ä¸ªEventLoopåªæœ‰ä¸€ä¸ªçº¿ç¨‹ã€‚</p></blockquote><p>äº‹ä»¶å¾ªç¯å¯¹è±¡</p><p>EventLoop æœ¬è´¨æ˜¯ä¸€ä¸ªå•çº¿ç¨‹æ‰§è¡Œå™¨ï¼ˆåŒæ—¶ç»´æŠ¤äº†ä¸€ä¸ª Selectorï¼‰ï¼Œé‡Œé¢æœ‰ run æ–¹æ³•å¤„ç† Channel ä¸Šæºæºä¸æ–­çš„ io äº‹ä»¶ã€‚</p><p>å®ƒçš„ç»§æ‰¿å…³ç³»æ¯”è¾ƒå¤æ‚ï¼ˆä¸¤æ¡çº¿ï¼‰ï¼š</p><ul><li>ä¸€æ¡çº¿æ˜¯ç»§æ‰¿è‡ª j.u.c.ScheduledExecutorService å› æ­¤åŒ…å«äº†çº¿ç¨‹æ± ä¸­æ‰€æœ‰çš„æ–¹æ³•</li><li>å¦ä¸€æ¡çº¿æ˜¯ç»§æ‰¿è‡ª netty è‡ªå·±çš„ OrderedEventExecutorï¼Œ<ul><li>æä¾›äº† boolean inEventLoop(Thread thread) æ–¹æ³•åˆ¤æ–­ä¸€ä¸ªçº¿ç¨‹æ˜¯å¦å±äºæ­¤ EventLoop</li><li>æä¾›äº† parent æ–¹æ³•æ¥çœ‹çœ‹è‡ªå·±å±äºå“ªä¸ª EventLoopGroup</li></ul></li></ul><p>äº‹ä»¶å¾ªç¯ç»„</p><p>EventLoopGroup æ˜¯ä¸€ç»„ EventLoopï¼ŒChannel ä¸€èˆ¬ä¼šè°ƒç”¨ EventLoopGroup çš„ register æ–¹æ³•æ¥<strong>ç»‘å®š</strong>å…¶ä¸­ä¸€ä¸ª EventLoopï¼Œåç»­è¿™ä¸ª Channel ä¸Šçš„ io äº‹ä»¶éƒ½ç”±æ­¤ EventLoop æ¥å¤„ç†ï¼ˆä¿è¯äº† io äº‹ä»¶å¤„ç†æ—¶çš„çº¿ç¨‹å®‰å…¨ï¼‰</p><ul><li>ç»§æ‰¿è‡ª netty è‡ªå·±çš„ EventExecutorGroup<ul><li>å®ç°äº† Iterable æ¥å£æä¾›éå† EventLoop çš„èƒ½åŠ›</li><li>å¦æœ‰ next æ–¹æ³•è·å–é›†åˆä¸­ä¸‹ä¸€ä¸ª EventLoop</li></ul></li></ul><p>ä»¥ä¸€ä¸ªç®€å•çš„å®ç°ä¸ºä¾‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// å†…éƒ¨åˆ›å»ºäº†ä¸¤ä¸ª EventLoop, æ¯ä¸ª EventLoop ç»´æŠ¤ä¸€ä¸ªçº¿ç¨‹
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>DefaultEventLoopGroup</span> <span class=n>group</span> <span class=o>=</span> <span class=k>new</span> <span class=n>DefaultEventLoopGroup</span><span class=o>(</span><span class=n>2</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>group</span><span class=o>.</span><span class=na>next</span><span class=o>());</span>
</span></span><span class=line><span class=cl><span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>group</span><span class=o>.</span><span class=na>next</span><span class=o>());</span>
</span></span><span class=line><span class=cl><span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>group</span><span class=o>.</span><span class=na>next</span><span class=o>());</span>
</span></span></code></pre></td></tr></table></div></div><p>è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>io.netty.channel.DefaultEventLoop@60f82f98
</span></span><span class=line><span class=cl>io.netty.channel.DefaultEventLoop@35f983a6
</span></span><span class=line><span class=cl>io.netty.channel.DefaultEventLoop@60f82f98
</span></span></code></pre></td></tr></table></div></div><p>ä¹Ÿå¯ä»¥ä½¿ç”¨ for å¾ªç¯</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>DefaultEventLoopGroup</span> <span class=n>group</span> <span class=o>=</span> <span class=k>new</span> <span class=n>DefaultEventLoopGroup</span><span class=o>(</span><span class=n>2</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=o>(</span><span class=n>EventExecutor</span> <span class=n>eventLoop</span> <span class=o>:</span> <span class=n>group</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>eventLoop</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>io.netty.channel.DefaultEventLoop@60f82f98
</span></span><span class=line><span class=cl>io.netty.channel.DefaultEventLoop@35f983a6
</span></span></code></pre></td></tr></table></div></div><a href=#-ä¼˜é›…å…³é—­><h4 id=-ä¼˜é›…å…³é—­><span class=hanchor arialabel=Anchor># </span>ğŸ’¡ ä¼˜é›…å…³é—­</h4></a><p>ä¼˜é›…å…³é—­ <code>shutdownGracefully</code> æ–¹æ³•ã€‚è¯¥æ–¹æ³•ä¼šé¦–å…ˆåˆ‡æ¢ <code>EventLoopGroup</code> åˆ°å…³é—­çŠ¶æ€ä»è€Œæ‹’ç»æ–°çš„ä»»åŠ¡çš„åŠ å…¥ï¼Œç„¶ååœ¨ä»»åŠ¡é˜Ÿåˆ—çš„ä»»åŠ¡éƒ½å¤„ç†å®Œæˆåï¼Œåœæ­¢çº¿ç¨‹çš„è¿è¡Œã€‚ä»è€Œç¡®ä¿æ•´ä½“åº”ç”¨æ˜¯åœ¨æ­£å¸¸æœ‰åºçš„çŠ¶æ€ä¸‹é€€å‡ºçš„</p><a href=#æ¼”ç¤º-nioeventloop-å¤„ç†-io-äº‹ä»¶><h4 id=æ¼”ç¤º-nioeventloop-å¤„ç†-io-äº‹ä»¶><span class=hanchor arialabel=Anchor># </span>æ¼”ç¤º NioEventLoop å¤„ç† io äº‹ä»¶</h4></a><p>æœåŠ¡å™¨ç«¯ä¸¤ä¸ª nio worker å·¥äºº</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>new</span> <span class=n>ServerBootstrap</span><span class=o>()</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>group</span><span class=o>(</span><span class=k>new</span> <span class=n>NioEventLoopGroup</span><span class=o>(</span><span class=n>1</span><span class=o>),</span> <span class=k>new</span> <span class=n>NioEventLoopGroup</span><span class=o>(</span><span class=n>2</span><span class=o>))</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>channel</span><span class=o>(</span><span class=n>NioServerSocketChannel</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>childHandler</span><span class=o>(</span><span class=k>new</span> <span class=n>ChannelInitializer</span><span class=o>&lt;</span><span class=n>NioSocketChannel</span><span class=o>&gt;()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>initChannel</span><span class=o>(</span><span class=n>NioSocketChannel</span> <span class=n>ch</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>ChannelInboundHandlerAdapter</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>                <span class=kd>public</span> <span class=kt>void</span> <span class=nf>channelRead</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>,</span> <span class=n>Object</span> <span class=n>msg</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>ByteBuf</span> <span class=n>byteBuf</span> <span class=o>=</span> <span class=n>msg</span> <span class=k>instanceof</span> <span class=n>ByteBuf</span> <span class=o>?</span> <span class=o>((</span><span class=n>ByteBuf</span><span class=o>)</span> <span class=n>msg</span><span class=o>)</span> <span class=o>:</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=o>(</span><span class=n>byteBuf</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=kt>byte</span><span class=o>[]</span> <span class=n>buf</span> <span class=o>=</span> <span class=k>new</span> <span class=kt>byte</span><span class=o>[</span><span class=n>16</span><span class=o>];</span>
</span></span><span class=line><span class=cl>                        <span class=n>ByteBuf</span> <span class=n>len</span> <span class=o>=</span> <span class=n>byteBuf</span><span class=o>.</span><span class=na>readBytes</span><span class=o>(</span><span class=n>buf</span><span class=o>,</span> <span class=n>0</span><span class=o>,</span> <span class=n>byteBuf</span><span class=o>.</span><span class=na>readableBytes</span><span class=o>());</span>
</span></span><span class=line><span class=cl>                        <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=k>new</span> <span class=n>String</span><span class=o>(</span><span class=n>buf</span><span class=o>));</span>
</span></span><span class=line><span class=cl>                    <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>});</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}).</span><span class=na>bind</span><span class=o>(</span><span class=n>8080</span><span class=o>).</span><span class=na>sync</span><span class=o>();</span>
</span></span></code></pre></td></tr></table></div></div><p>å®¢æˆ·ç«¯ï¼Œå¯åŠ¨ä¸‰æ¬¡ï¼Œåˆ†åˆ«ä¿®æ”¹å‘é€å­—ç¬¦ä¸²ä¸º zhangsanï¼ˆç¬¬ä¸€æ¬¡ï¼‰ï¼Œlisiï¼ˆç¬¬äºŒæ¬¡ï¼‰ï¼Œwangwuï¼ˆç¬¬ä¸‰æ¬¡ï¼‰</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>InterruptedException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Channel</span> <span class=n>channel</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Bootstrap</span><span class=o>()</span>
</span></span><span class=line><span class=cl>            <span class=o>.</span><span class=na>group</span><span class=o>(</span><span class=k>new</span> <span class=n>NioEventLoopGroup</span><span class=o>(</span><span class=n>1</span><span class=o>))</span>
</span></span><span class=line><span class=cl>            <span class=o>.</span><span class=na>handler</span><span class=o>(</span><span class=k>new</span> <span class=n>ChannelInitializer</span><span class=o>&lt;</span><span class=n>NioSocketChannel</span><span class=o>&gt;()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>                <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>initChannel</span><span class=o>(</span><span class=n>NioSocketChannel</span> <span class=n>ch</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;init...&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>LoggingHandler</span><span class=o>(</span><span class=n>LogLevel</span><span class=o>.</span><span class=na>DEBUG</span><span class=o>));</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>})</span>
</span></span><span class=line><span class=cl>            <span class=o>.</span><span class=na>channel</span><span class=o>(</span><span class=n>NioSocketChannel</span><span class=o>.</span><span class=na>class</span><span class=o>).</span><span class=na>connect</span><span class=o>(</span><span class=s>&#34;localhost&#34;</span><span class=o>,</span> <span class=n>8080</span><span class=o>)</span>
</span></span><span class=line><span class=cl>            <span class=o>.</span><span class=na>sync</span><span class=o>()</span>
</span></span><span class=line><span class=cl>            <span class=o>.</span><span class=na>channel</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>channel</span><span class=o>.</span><span class=na>writeAndFlush</span><span class=o>(</span><span class=n>ByteBufAllocator</span><span class=o>.</span><span class=na>DEFAULT</span><span class=o>.</span><span class=na>buffer</span><span class=o>().</span><span class=na>writeBytes</span><span class=o>(</span><span class=s>&#34;wangwu&#34;</span><span class=o>.</span><span class=na>getBytes</span><span class=o>()));</span>
</span></span><span class=line><span class=cl>    <span class=n>Thread</span><span class=o>.</span><span class=na>sleep</span><span class=o>(</span><span class=n>2000</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>channel</span><span class=o>.</span><span class=na>writeAndFlush</span><span class=o>(</span><span class=n>ByteBufAllocator</span><span class=o>.</span><span class=na>DEFAULT</span><span class=o>.</span><span class=na>buffer</span><span class=o>().</span><span class=na>writeBytes</span><span class=o>(</span><span class=s>&#34;wangwu&#34;</span><span class=o>.</span><span class=na>getBytes</span><span class=o>()));</span>
</span></span></code></pre></td></tr></table></div></div><p>æœ€åè¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>22:03:34 [DEBUG] [nioEventLoopGroup-3-1] c.i.o.EventLoopTest - zhangsan       
</span></span><span class=line><span class=cl>22:03:36 [DEBUG] [nioEventLoopGroup-3-1] c.i.o.EventLoopTest - zhangsan       
</span></span><span class=line><span class=cl>22:05:36 [DEBUG] [nioEventLoopGroup-3-2] c.i.o.EventLoopTest - lisi           
</span></span><span class=line><span class=cl>22:05:38 [DEBUG] [nioEventLoopGroup-3-2] c.i.o.EventLoopTest - lisi           
</span></span><span class=line><span class=cl>22:06:09 [DEBUG] [nioEventLoopGroup-3-1] c.i.o.EventLoopTest - wangwu        
</span></span><span class=line><span class=cl>22:06:11 [DEBUG] [nioEventLoopGroup-3-1] c.i.o.EventLoopTest - wangwu         
</span></span></code></pre></td></tr></table></div></div><p>å¯ä»¥çœ‹åˆ°ä¸¤ä¸ªå·¥äººè½®æµå¤„ç† channelï¼Œä½†å·¥äººä¸ channel ä¹‹é—´è¿›è¡Œäº†<strong>ç»‘å®š</strong></p><p><img src=/z-oblib/z2-attachments/5481d330648f7aac4452dbfb01920fd3.png width=auto></p><p>å†å¢åŠ ä¸¤ä¸ªé nio å·¥äºº</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>DefaultEventLoopGroup</span> <span class=n>normalWorkers</span> <span class=o>=</span> <span class=k>new</span> <span class=n>DefaultEventLoopGroup</span><span class=o>(</span><span class=n>2</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=k>new</span> <span class=n>ServerBootstrap</span><span class=o>()</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>group</span><span class=o>(</span><span class=k>new</span> <span class=n>NioEventLoopGroup</span><span class=o>(</span><span class=n>1</span><span class=o>),</span> <span class=k>new</span> <span class=n>NioEventLoopGroup</span><span class=o>(</span><span class=n>2</span><span class=o>))</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>channel</span><span class=o>(</span><span class=n>NioServerSocketChannel</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>childHandler</span><span class=o>(</span><span class=k>new</span> <span class=n>ChannelInitializer</span><span class=o>&lt;</span><span class=n>NioSocketChannel</span><span class=o>&gt;()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>initChannel</span><span class=o>(</span><span class=n>NioSocketChannel</span> <span class=n>ch</span><span class=o>)</span>  <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>LoggingHandler</span><span class=o>(</span><span class=n>LogLevel</span><span class=o>.</span><span class=na>DEBUG</span><span class=o>));</span>
</span></span><span class=line><span class=cl>            <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=n>normalWorkers</span><span class=o>,</span><span class=s>&#34;myhandler&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>              <span class=k>new</span> <span class=n>ChannelInboundHandlerAdapter</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>                <span class=kd>public</span> <span class=kt>void</span> <span class=nf>channelRead</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>,</span> <span class=n>Object</span> <span class=n>msg</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>ByteBuf</span> <span class=n>byteBuf</span> <span class=o>=</span> <span class=n>msg</span> <span class=k>instanceof</span> <span class=n>ByteBuf</span> <span class=o>?</span> <span class=o>((</span><span class=n>ByteBuf</span><span class=o>)</span> <span class=n>msg</span><span class=o>)</span> <span class=o>:</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=o>(</span><span class=n>byteBuf</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=kt>byte</span><span class=o>[]</span> <span class=n>buf</span> <span class=o>=</span> <span class=k>new</span> <span class=kt>byte</span><span class=o>[</span><span class=n>16</span><span class=o>];</span>
</span></span><span class=line><span class=cl>                        <span class=n>ByteBuf</span> <span class=n>len</span> <span class=o>=</span> <span class=n>byteBuf</span><span class=o>.</span><span class=na>readBytes</span><span class=o>(</span><span class=n>buf</span><span class=o>,</span> <span class=n>0</span><span class=o>,</span> <span class=n>byteBuf</span><span class=o>.</span><span class=na>readableBytes</span><span class=o>());</span>
</span></span><span class=line><span class=cl>                        <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=k>new</span> <span class=n>String</span><span class=o>(</span><span class=n>buf</span><span class=o>));</span>
</span></span><span class=line><span class=cl>                    <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>});</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}).</span><span class=na>bind</span><span class=o>(</span><span class=n>8080</span><span class=o>).</span><span class=na>sync</span><span class=o>();</span>
</span></span></code></pre></td></tr></table></div></div><p>å®¢æˆ·ç«¯ä»£ç ä¸å˜ï¼Œå¯åŠ¨ä¸‰æ¬¡ï¼Œåˆ†åˆ«ä¿®æ”¹å‘é€å­—ç¬¦ä¸²ä¸º zhangsanï¼ˆç¬¬ä¸€æ¬¡ï¼‰ï¼Œlisiï¼ˆç¬¬äºŒæ¬¡ï¼‰ï¼Œwangwuï¼ˆç¬¬ä¸‰æ¬¡ï¼‰</p><p>è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>22:19:48 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x251562d5, L:/127.0.0.1:8080 - R:/127.0.0.1:52588] REGISTERED
</span></span><span class=line><span class=cl>22:19:48 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x251562d5, L:/127.0.0.1:8080 - R:/127.0.0.1:52588] ACTIVE
</span></span><span class=line><span class=cl>22:19:48 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x251562d5, L:/127.0.0.1:8080 - R:/127.0.0.1:52588] READ: 8B
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 7a 68 61 6e 67 73 61 6e                         |zhangsan        |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>22:19:48 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x251562d5, L:/127.0.0.1:8080 - R:/127.0.0.1:52588] READ COMPLETE
</span></span><span class=line><span class=cl>22:19:48 [DEBUG] [defaultEventLoopGroup-2-1] c.i.o.EventLoopTest - zhangsan        
</span></span><span class=line><span class=cl>22:19:50 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x251562d5, L:/127.0.0.1:8080 - R:/127.0.0.1:52588] READ: 8B
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 7a 68 61 6e 67 73 61 6e                         |zhangsan        |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>22:19:50 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x251562d5, L:/127.0.0.1:8080 - R:/127.0.0.1:52588] READ COMPLETE
</span></span><span class=line><span class=cl>22:19:50 [DEBUG] [defaultEventLoopGroup-2-1] c.i.o.EventLoopTest - zhangsan        
</span></span><span class=line><span class=cl>22:20:24 [DEBUG] [nioEventLoopGroup-4-2] i.n.h.l.LoggingHandler - [id: 0x94b2a840, L:/127.0.0.1:8080 - R:/127.0.0.1:52612] REGISTERED
</span></span><span class=line><span class=cl>22:20:24 [DEBUG] [nioEventLoopGroup-4-2] i.n.h.l.LoggingHandler - [id: 0x94b2a840, L:/127.0.0.1:8080 - R:/127.0.0.1:52612] ACTIVE
</span></span><span class=line><span class=cl>22:20:25 [DEBUG] [nioEventLoopGroup-4-2] i.n.h.l.LoggingHandler - [id: 0x94b2a840, L:/127.0.0.1:8080 - R:/127.0.0.1:52612] READ: 4B
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 6c 69 73 69                                     |lisi            |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>22:20:25 [DEBUG] [nioEventLoopGroup-4-2] i.n.h.l.LoggingHandler - [id: 0x94b2a840, L:/127.0.0.1:8080 - R:/127.0.0.1:52612] READ COMPLETE
</span></span><span class=line><span class=cl>22:20:25 [DEBUG] [defaultEventLoopGroup-2-2] c.i.o.EventLoopTest - lisi            
</span></span><span class=line><span class=cl>22:20:27 [DEBUG] [nioEventLoopGroup-4-2] i.n.h.l.LoggingHandler - [id: 0x94b2a840, L:/127.0.0.1:8080 - R:/127.0.0.1:52612] READ: 4B
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 6c 69 73 69                                     |lisi            |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>22:20:27 [DEBUG] [nioEventLoopGroup-4-2] i.n.h.l.LoggingHandler - [id: 0x94b2a840, L:/127.0.0.1:8080 - R:/127.0.0.1:52612] READ COMPLETE
</span></span><span class=line><span class=cl>22:20:27 [DEBUG] [defaultEventLoopGroup-2-2] c.i.o.EventLoopTest - lisi            
</span></span><span class=line><span class=cl>22:20:38 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x79a26af9, L:/127.0.0.1:8080 - R:/127.0.0.1:52625] REGISTERED
</span></span><span class=line><span class=cl>22:20:38 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x79a26af9, L:/127.0.0.1:8080 - R:/127.0.0.1:52625] ACTIVE
</span></span><span class=line><span class=cl>22:20:38 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x79a26af9, L:/127.0.0.1:8080 - R:/127.0.0.1:52625] READ: 6B
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 77 61 6e 67 77 75                               |wangwu          |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>22:20:38 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x79a26af9, L:/127.0.0.1:8080 - R:/127.0.0.1:52625] READ COMPLETE
</span></span><span class=line><span class=cl>22:20:38 [DEBUG] [defaultEventLoopGroup-2-1] c.i.o.EventLoopTest - wangwu          
</span></span><span class=line><span class=cl>22:20:40 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x79a26af9, L:/127.0.0.1:8080 - R:/127.0.0.1:52625] READ: 6B
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 77 61 6e 67 77 75                               |wangwu          |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>22:20:40 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x79a26af9, L:/127.0.0.1:8080 - R:/127.0.0.1:52625] READ COMPLETE
</span></span><span class=line><span class=cl>22:20:40 [DEBUG] [defaultEventLoopGroup-2-1] c.i.o.EventLoopTest - wangwu          
</span></span></code></pre></td></tr></table></div></div><p>å¯ä»¥çœ‹åˆ°ï¼Œnio å·¥äººå’Œ é nio å·¥äººä¹Ÿåˆ†åˆ«ç»‘å®šäº† channelï¼ˆLoggingHandler ç”± nio å·¥äººæ‰§è¡Œï¼Œè€Œæˆ‘ä»¬è‡ªå·±çš„ handler ç”±é nio å·¥äººæ‰§è¡Œï¼‰</p><p><img src=/z-oblib/z2-attachments/7de561abc15cda8879ac2cf85700066b.png width=auto></p><a href=#-handler-æ‰§è¡Œä¸­å¦‚ä½•æ¢äºº><h4 id=-handler-æ‰§è¡Œä¸­å¦‚ä½•æ¢äºº><span class=hanchor arialabel=Anchor># </span>ğŸ’¡ handler æ‰§è¡Œä¸­å¦‚ä½•æ¢äººï¼Ÿ</h4></a><blockquote><p>piplineä¸­çš„çº¿ç¨‹åˆ‡æ¢ã€‚</p></blockquote><p>å…³é”®ä»£ç  <code>io.netty.channel.AbstractChannelHandlerContext#invokeChannelRead()</code></p><blockquote><p>å¯¹æ¯”ä¸€ä¸‹ä¸¤ä¸ªhandlerç»‘å®šçš„æ˜¯ä¸æ˜¯åŒä¸€ä¸ªçº¿ç¨‹æ± ï¼Œå¦‚æœæ˜¯å°±ç›´æ¥çº¿æ€§è°ƒç”¨ï¼›å¦‚æœä¸æ˜¯å°±æŠŠæ¥ä¸‹æ¥çš„ä»»åŠ¡åŒ…è£…æˆRunnableæ‰”ç»™ä¸‹ä¸€ä¸ªhandlerå¯¹åº”çš„çº¿ç¨‹æ± ã€‚</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span> <span class=kt>void</span> <span class=nf>invokeChannelRead</span><span class=o>(</span><span class=kd>final</span> <span class=n>AbstractChannelHandlerContext</span> <span class=n>next</span><span class=o>,</span> <span class=n>Object</span> <span class=n>msg</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=n>Object</span> <span class=n>m</span> <span class=o>=</span> <span class=n>next</span><span class=o>.</span><span class=na>pipeline</span><span class=o>.</span><span class=na>touch</span><span class=o>(</span><span class=n>ObjectUtil</span><span class=o>.</span><span class=na>checkNotNull</span><span class=o>(</span><span class=n>msg</span><span class=o>,</span> <span class=s>&#34;msg&#34;</span><span class=o>),</span> <span class=n>next</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ä¸‹ä¸€ä¸ª handler çš„äº‹ä»¶å¾ªç¯æ˜¯å¦ä¸å½“å‰çš„äº‹ä»¶å¾ªç¯æ˜¯åŒä¸€ä¸ªçº¿ç¨‹
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>EventExecutor</span> <span class=n>executor</span> <span class=o>=</span> <span class=n>next</span><span class=o>.</span><span class=na>executor</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// æ˜¯ï¼Œç›´æ¥è°ƒç”¨
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>(</span><span class=n>executor</span><span class=o>.</span><span class=na>inEventLoop</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>next</span><span class=o>.</span><span class=na>invokeChannelRead</span><span class=o>(</span><span class=n>m</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> 
</span></span><span class=line><span class=cl>    <span class=c1>// ä¸æ˜¯ï¼Œå°†è¦æ‰§è¡Œçš„ä»£ç ä½œä¸ºä»»åŠ¡æäº¤ç»™ä¸‹ä¸€ä¸ªäº‹ä»¶å¾ªç¯å¤„ç†ï¼ˆæ¢äººï¼‰
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>	    <span class=c1>// executorå½“å‰å¯ä»¥çœ‹ä½œæ˜¯ä¸€ä¸ªçº¿ç¨‹æ± ï¼Œæ˜¯ä¸‹ä¸€ä¸ªhandler
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>executor</span><span class=o>.</span><span class=na>execute</span><span class=o>(</span><span class=k>new</span> <span class=n>Runnable</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>            <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>next</span><span class=o>.</span><span class=na>invokeChannelRead</span><span class=o>(</span><span class=n>m</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>});</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>å¦‚æœä¸¤ä¸ª handler ç»‘å®šçš„æ˜¯åŒä¸€ä¸ªçº¿ç¨‹ï¼Œé‚£ä¹ˆå°±ç›´æ¥è°ƒç”¨</li><li>å¦åˆ™ï¼ŒæŠŠè¦è°ƒç”¨çš„ä»£ç å°è£…ä¸ºä¸€ä¸ªä»»åŠ¡å¯¹è±¡ï¼Œç”±ä¸‹ä¸€ä¸ª handler çš„çº¿ç¨‹æ¥è°ƒç”¨</li></ul><a href=#æ¼”ç¤º-nioeventloop-å¤„ç†æ™®é€šä»»åŠ¡><h4 id=æ¼”ç¤º-nioeventloop-å¤„ç†æ™®é€šä»»åŠ¡><span class=hanchor arialabel=Anchor># </span>æ¼”ç¤º NioEventLoop å¤„ç†æ™®é€šä»»åŠ¡</h4></a><p>NioEventLoop é™¤äº†å¯ä»¥å¤„ç† io äº‹ä»¶ï¼ŒåŒæ ·å¯ä»¥å‘å®ƒæäº¤æ™®é€šä»»åŠ¡</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>NioEventLoopGroup</span> <span class=n>nioWorkers</span> <span class=o>=</span> <span class=k>new</span> <span class=n>NioEventLoopGroup</span><span class=o>(</span><span class=n>2</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;server start...&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>Thread</span><span class=o>.</span><span class=na>sleep</span><span class=o>(</span><span class=n>2000</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>nioWorkers</span><span class=o>.</span><span class=na>execute</span><span class=o>(()-&gt;{</span>
</span></span><span class=line><span class=cl>    <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;normal task...&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>});</span>
</span></span></code></pre></td></tr></table></div></div><p>è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>22:30:36 [DEBUG] [main] c.i.o.EventLoopTest2 - server start...
</span></span><span class=line><span class=cl>22:30:38 [DEBUG] [nioEventLoopGroup-2-1] c.i.o.EventLoopTest2 - normal task...
</span></span></code></pre></td></tr></table></div></div><blockquote><p>å¯ä»¥ç”¨æ¥æ‰§è¡Œè€—æ—¶è¾ƒé•¿çš„ä»»åŠ¡</p></blockquote><a href=#æ¼”ç¤º-nioeventloop-å¤„ç†å®šæ—¶ä»»åŠ¡><h4 id=æ¼”ç¤º-nioeventloop-å¤„ç†å®šæ—¶ä»»åŠ¡><span class=hanchor arialabel=Anchor># </span>æ¼”ç¤º NioEventLoop å¤„ç†å®šæ—¶ä»»åŠ¡</h4></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>NioEventLoopGroup</span> <span class=n>nioWorkers</span> <span class=o>=</span> <span class=k>new</span> <span class=n>NioEventLoopGroup</span><span class=o>(</span><span class=n>2</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;server start...&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>Thread</span><span class=o>.</span><span class=na>sleep</span><span class=o>(</span><span class=n>2000</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>nioWorkers</span><span class=o>.</span><span class=na>scheduleAtFixedRate</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;running...&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>},</span> <span class=n>0</span><span class=o>,</span> <span class=n>1</span><span class=o>,</span> <span class=n>TimeUnit</span><span class=o>.</span><span class=na>SECONDS</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><p>è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>22:35:15 [DEBUG] [main] c.i.o.EventLoopTest2 - server start...
</span></span><span class=line><span class=cl>22:35:17 [DEBUG] [nioEventLoopGroup-2-1] c.i.o.EventLoopTest2 - running...
</span></span><span class=line><span class=cl>22:35:18 [DEBUG] [nioEventLoopGroup-2-1] c.i.o.EventLoopTest2 - running...
</span></span><span class=line><span class=cl>22:35:19 [DEBUG] [nioEventLoopGroup-2-1] c.i.o.EventLoopTest2 - running...
</span></span><span class=line><span class=cl>22:35:20 [DEBUG] [nioEventLoopGroup-2-1] c.i.o.EventLoopTest2 - running...
</span></span><span class=line><span class=cl>...
</span></span></code></pre></td></tr></table></div></div><blockquote><p>å¯ä»¥ç”¨æ¥æ‰§è¡Œå®šæ—¶ä»»åŠ¡</p></blockquote><a href=#32-channel><h3 id=32-channel><span class=hanchor arialabel=Anchor># </span>3.2 Channel</h3></a><p>channel çš„ä¸»è¦ä½œç”¨</p><ul><li>close() å¯ä»¥ç”¨æ¥å…³é—­ channel</li><li>closeFuture() ç”¨æ¥å¤„ç† channel çš„å…³é—­<ul><li>sync æ–¹æ³•ä½œç”¨æ˜¯åŒæ­¥ç­‰å¾… channel å…³é—­</li><li>è€Œ addListener æ–¹æ³•æ˜¯å¼‚æ­¥ç­‰å¾… channel å…³é—­</li></ul></li><li>pipeline() æ–¹æ³•æ·»åŠ å¤„ç†å™¨</li><li>write() æ–¹æ³•å°†æ•°æ®å†™å…¥</li><li>writeAndFlush() æ–¹æ³•å°†æ•°æ®å†™å…¥å¹¶åˆ·å‡º</li></ul><a href=#channelfuture><h4 id=channelfuture><span class=hanchor arialabel=Anchor># </span>ChannelFuture</h4></a><p>è¿™æ—¶åˆšæ‰çš„å®¢æˆ·ç«¯ä»£ç </p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>new</span> <span class=n>Bootstrap</span><span class=o>()</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>group</span><span class=o>(</span><span class=k>new</span> <span class=n>NioEventLoopGroup</span><span class=o>())</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>channel</span><span class=o>(</span><span class=n>NioSocketChannel</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>handler</span><span class=o>(</span><span class=k>new</span> <span class=n>ChannelInitializer</span><span class=o>&lt;</span><span class=n>Channel</span><span class=o>&gt;()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>initChannel</span><span class=o>(</span><span class=n>Channel</span> <span class=n>ch</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>StringEncoder</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>})</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>connect</span><span class=o>(</span><span class=s>&#34;127.0.0.1&#34;</span><span class=o>,</span> <span class=n>8080</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>sync</span><span class=o>()</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>channel</span><span class=o>()</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>writeAndFlush</span><span class=o>(</span><span class=k>new</span> <span class=n>Date</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;: hello world!&#34;</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><p>ç°åœ¨æŠŠå®ƒæ‹†å¼€æ¥çœ‹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>ChannelFuture</span> <span class=n>channelFuture</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Bootstrap</span><span class=o>()</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>group</span><span class=o>(</span><span class=k>new</span> <span class=n>NioEventLoopGroup</span><span class=o>())</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>channel</span><span class=o>(</span><span class=n>NioSocketChannel</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>handler</span><span class=o>(</span><span class=k>new</span> <span class=n>ChannelInitializer</span><span class=o>&lt;</span><span class=n>Channel</span><span class=o>&gt;()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>initChannel</span><span class=o>(</span><span class=n>Channel</span> <span class=n>ch</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>StringEncoder</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>})</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>connect</span><span class=o>(</span><span class=s>&#34;127.0.0.1&#34;</span><span class=o>,</span> <span class=n>8080</span><span class=o>);</span> <span class=c1>// 1
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=n>channelFuture</span><span class=o>.</span><span class=na>sync</span><span class=o>().</span><span class=na>channel</span><span class=o>().</span><span class=na>writeAndFlush</span><span class=o>(</span><span class=k>new</span> <span class=n>Date</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;: hello world!&#34;</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>1 å¤„è¿”å›çš„æ˜¯ ChannelFuture å¯¹è±¡ï¼Œå®ƒçš„ä½œç”¨æ˜¯åˆ©ç”¨ channel() æ–¹æ³•æ¥è·å– Channel å¯¹è±¡</li></ul><p><strong>æ³¨æ„</strong> connect æ–¹æ³•æ˜¯å¼‚æ­¥çš„ï¼Œæ„å‘³ç€ä¸ç­‰è¿æ¥å»ºç«‹ï¼Œæ–¹æ³•æ‰§è¡Œå°±è¿”å›äº†ã€‚å› æ­¤ channelFuture å¯¹è±¡ä¸­ä¸èƒ½ã€ç«‹åˆ»ã€‘è·å¾—åˆ°æ­£ç¡®çš„ Channel å¯¹è±¡</p><p>å®éªŒå¦‚ä¸‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>ChannelFuture</span> <span class=n>channelFuture</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Bootstrap</span><span class=o>()</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>group</span><span class=o>(</span><span class=k>new</span> <span class=n>NioEventLoopGroup</span><span class=o>())</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>channel</span><span class=o>(</span><span class=n>NioSocketChannel</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>handler</span><span class=o>(</span><span class=k>new</span> <span class=n>ChannelInitializer</span><span class=o>&lt;</span><span class=n>Channel</span><span class=o>&gt;()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>initChannel</span><span class=o>(</span><span class=n>Channel</span> <span class=n>ch</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>StringEncoder</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>})</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>connect</span><span class=o>(</span><span class=s>&#34;127.0.0.1&#34;</span><span class=o>,</span> <span class=n>8080</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>channelFuture</span><span class=o>.</span><span class=na>channel</span><span class=o>());</span> <span class=c1>// 1
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>channelFuture</span><span class=o>.</span><span class=na>sync</span><span class=o>();</span> <span class=c1>// 2
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>channelFuture</span><span class=o>.</span><span class=na>channel</span><span class=o>());</span> <span class=c1>// 3
</span></span></span></code></pre></td></tr></table></div></div><ul><li>æ‰§è¡Œåˆ° 1 æ—¶ï¼Œè¿æ¥æœªå»ºç«‹ï¼Œæ‰“å° <code>[id: 0x2e1884dd]</code></li><li>æ‰§è¡Œåˆ° 2 æ—¶ï¼Œsync æ–¹æ³•æ˜¯åŒæ­¥ç­‰å¾…è¿æ¥å»ºç«‹å®Œæˆ</li><li>æ‰§è¡Œåˆ° 3 æ—¶ï¼Œè¿æ¥è‚¯å®šå»ºç«‹äº†ï¼Œæ‰“å° <code>[id: 0x2e1884dd, L:/127.0.0.1:57191 - R:/127.0.0.1:8080]</code></li></ul><p>é™¤äº†ç”¨ sync æ–¹æ³•å¯ä»¥è®©å¼‚æ­¥æ“ä½œåŒæ­¥ä»¥å¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨å›è°ƒçš„æ–¹å¼ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>ChannelFuture</span> <span class=n>channelFuture</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Bootstrap</span><span class=o>()</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>group</span><span class=o>(</span><span class=k>new</span> <span class=n>NioEventLoopGroup</span><span class=o>())</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>channel</span><span class=o>(</span><span class=n>NioSocketChannel</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>handler</span><span class=o>(</span><span class=k>new</span> <span class=n>ChannelInitializer</span><span class=o>&lt;</span><span class=n>Channel</span><span class=o>&gt;()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>initChannel</span><span class=o>(</span><span class=n>Channel</span> <span class=n>ch</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>StringEncoder</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>})</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>connect</span><span class=o>(</span><span class=s>&#34;127.0.0.1&#34;</span><span class=o>,</span> <span class=n>8080</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>channelFuture</span><span class=o>.</span><span class=na>channel</span><span class=o>());</span> <span class=c1>// 1
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>channelFuture</span><span class=o>.</span><span class=na>addListener</span><span class=o>((</span><span class=n>ChannelFutureListener</span><span class=o>)</span> <span class=n>future</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>future</span><span class=o>.</span><span class=na>channel</span><span class=o>());</span> <span class=c1>// 2
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>});</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>æ‰§è¡Œåˆ° 1 æ—¶ï¼Œè¿æ¥æœªå»ºç«‹ï¼Œæ‰“å° <code>[id: 0x749124ba]</code></li><li>ChannelFutureListener ä¼šåœ¨è¿æ¥å»ºç«‹æ—¶è¢«è°ƒç”¨ï¼ˆå…¶ä¸­ operationComplete æ–¹æ³•ï¼‰ï¼Œå› æ­¤æ‰§è¡Œåˆ° 2 æ—¶ï¼Œè¿æ¥è‚¯å®šå»ºç«‹äº†ï¼Œæ‰“å° <code>[id: 0x749124ba, L:/127.0.0.1:57351 - R:/127.0.0.1:8080]</code></li></ul><a href=#æ€»ç»“><h5 id=æ€»ç»“><span class=hanchor arialabel=Anchor># </span>æ€»ç»“</h5></a><p>syncï¼šè°å‘èµ·è°ƒç”¨ï¼Œè°é˜»å¡å¼ç­‰å¾…ç»“æœã€‚
<a href=/2_0_2-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/2_0_2_1_2_3-%E8%BD%AF%E4%BB%B6%E7%B3%BB%E7%BB%9F/2_0_2_1_2_3_1-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E5%9B%9E%E8%B0%83 rel=noopener class=internal-link data-src=/2_0_2-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/2_0_2_1_2_3-%E8%BD%AF%E4%BB%B6%E7%B3%BB%E7%BB%9F/2_0_2_1_2_3_1-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E5%9B%9E%E8%B0%83>å›è°ƒ</a>ï¼šæ‰§è¡ŒåŠ¨ä½œå’Œç­‰å¾…ç»“æœéƒ½äº¤ç»™å…¶å®ƒçº¿ç¨‹å¤„ç†ï¼Œæœ¬çº¿ç¨‹ä¸é˜»å¡ç­‰å¾…ã€‚</p><a href=#closefuture><h4 id=closefuture><span class=hanchor arialabel=Anchor># </span>CloseFuture</h4></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>CloseFutureClient</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>InterruptedException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// groupéœ€è¦æå‡ºæ¥ï¼Œå¦åˆ™åç»­å…³é—­çš„æ—¶å€™æ— æ³•å¼•ç”¨åˆ°ï¼ˆåŒ¿åå¯¹è±¡æ— æ³•å¼•ç”¨ï¼‰
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>NioEventLoopGroup</span> <span class=n>group</span> <span class=k>new</span> <span class=nf>NioEventLoopGroup</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>ChannelFuture</span> <span class=n>channelFuture</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Bootstrap</span><span class=o>()</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>group</span><span class=o>(</span><span class=n>group</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>channel</span><span class=o>(</span><span class=n>NioSocketChannel</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>handler</span><span class=o>(</span><span class=k>new</span> <span class=n>ChannelInitializer</span><span class=o>&lt;</span><span class=n>NioSocketChannel</span><span class=o>&gt;()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=nd>@Override</span> <span class=c1>// åœ¨è¿æ¥å»ºç«‹åè¢«è°ƒç”¨
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>initChannel</span><span class=o>(</span><span class=n>NioSocketChannel</span> <span class=n>ch</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>LoggingHandler</span><span class=o>(</span><span class=n>LogLevel</span><span class=o>.</span><span class=na>DEBUG</span><span class=o>));</span>
</span></span><span class=line><span class=cl>                        <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>StringEncoder</span><span class=o>());</span>
</span></span><span class=line><span class=cl>                    <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=o>})</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>connect</span><span class=o>(</span><span class=k>new</span> <span class=n>InetSocketAddress</span><span class=o>(</span><span class=s>&#34;localhost&#34;</span><span class=o>,</span> <span class=n>8080</span><span class=o>));</span>
</span></span><span class=line><span class=cl>        <span class=n>Channel</span> <span class=n>channel</span> <span class=o>=</span> <span class=n>channelFuture</span><span class=o>.</span><span class=na>sync</span><span class=o>().</span><span class=na>channel</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;{}&#34;</span><span class=o>,</span> <span class=n>channel</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=n>Thread</span><span class=o>(()-&gt;{</span>
</span></span><span class=line><span class=cl>            <span class=n>Scanner</span> <span class=n>scanner</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Scanner</span><span class=o>(</span><span class=n>System</span><span class=o>.</span><span class=na>in</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=k>while</span> <span class=o>(</span><span class=kc>true</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>String</span> <span class=n>line</span> <span class=o>=</span> <span class=n>scanner</span><span class=o>.</span><span class=na>nextLine</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=s>&#34;q&#34;</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>line</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>channel</span><span class=o>.</span><span class=na>close</span><span class=o>();</span> <span class=c1>// close å¼‚æ­¥æ“ä½œ 1s ä¹‹å
</span></span></span><span class=line><span class=cl><span class=c1>//                    log.debug(&#34;å¤„ç†å…³é—­ä¹‹åçš„æ“ä½œ&#34;); // ä¸èƒ½åœ¨è¿™é‡Œå–„å
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=n>channel</span><span class=o>.</span><span class=na>writeAndFlush</span><span class=o>(</span><span class=n>line</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>},</span> <span class=s>&#34;input&#34;</span><span class=o>).</span><span class=na>start</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// è·å– CloseFuture å¯¹è±¡ï¼Œ 1) åŒæ­¥å¤„ç†å…³é—­ï¼Œ 2) å¼‚æ­¥å¤„ç†å…³é—­
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>ChannelFuture</span> <span class=n>closeFuture</span> <span class=o>=</span> <span class=n>channel</span><span class=o>.</span><span class=na>closeFuture</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=cm>/*log.debug(&#34;waiting close...&#34;);
</span></span></span><span class=line><span class=cl><span class=cm>        closeFuture.sync();
</span></span></span><span class=line><span class=cl><span class=cm>        log.debug(&#34;å¤„ç†å…³é—­ä¹‹åçš„æ“ä½œ&#34;);*/</span>
</span></span><span class=line><span class=cl>        <span class=n>closeFuture</span><span class=o>.</span><span class=na>addListener</span><span class=o>(</span><span class=k>new</span> <span class=n>ChannelFutureListener</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>            <span class=kd>public</span> <span class=kt>void</span> <span class=nf>operationComplete</span><span class=o>(</span><span class=n>ChannelFuture</span> <span class=n>future</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;å¤„ç†å…³é—­ä¹‹åçš„æ“ä½œ&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=c1>// groupçš„çº¿ç¨‹éƒ½è¦ç»“æŸï¼Œæ‰èƒ½å®Œå…¨ç»“æŸ
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>group</span><span class=o>.</span><span class=na>shutdownGracefully</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>});</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#-å¼‚æ­¥æå‡çš„æ˜¯ä»€ä¹ˆ><h4 id=-å¼‚æ­¥æå‡çš„æ˜¯ä»€ä¹ˆ><span class=hanchor arialabel=Anchor># </span>ğŸ’¡ å¼‚æ­¥æå‡çš„æ˜¯ä»€ä¹ˆ</h4></a><ul><li><p>æœ‰äº›åŒå­¦çœ‹åˆ°è¿™é‡Œä¼šæœ‰ç–‘é—®ï¼šä¸ºä»€ä¹ˆä¸åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­å»æ‰§è¡Œå»ºç«‹è¿æ¥ã€å»æ‰§è¡Œå…³é—­ channelï¼Œé‚£æ ·ä¸æ˜¯ä¹Ÿå¯ä»¥å—ï¼Ÿéè¦ç”¨è¿™ä¹ˆå¤æ‚çš„å¼‚æ­¥æ–¹å¼ï¼šæ¯”å¦‚ä¸€ä¸ªçº¿ç¨‹å‘èµ·å»ºç«‹è¿æ¥ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹å»çœŸæ­£å»ºç«‹è¿æ¥</p></li><li><p>è¿˜æœ‰åŒå­¦ä¼šç¬¼ç»Ÿåœ°å›ç­”ï¼Œå› ä¸º netty å¼‚æ­¥æ–¹å¼ç”¨äº†å¤šçº¿ç¨‹ã€å¤šçº¿ç¨‹å°±æ•ˆç‡é«˜ã€‚å…¶å®è¿™äº›è®¤è¯†éƒ½æ¯”è¾ƒç‰‡é¢ï¼Œå¤šçº¿ç¨‹å’Œå¼‚æ­¥æ‰€æå‡çš„æ•ˆç‡å¹¶ä¸æ˜¯æ‰€è®¤ä¸ºçš„</p></li></ul><p>æ€è€ƒä¸‹é¢çš„åœºæ™¯ï¼Œ4 ä¸ªåŒ»ç”Ÿç»™äººçœ‹ç—…ï¼Œæ¯ä¸ªç—…äººèŠ±è´¹ 20 åˆ†é’Ÿï¼Œè€Œä¸”åŒ»ç”Ÿçœ‹ç—…çš„è¿‡ç¨‹ä¸­æ˜¯ä»¥ç—…äººä¸ºå•ä½çš„ï¼Œä¸€ä¸ªç—…äººçœ‹å®Œäº†ï¼Œæ‰èƒ½çœ‹ä¸‹ä¸€ä¸ªç—…äººã€‚å‡è®¾ç—…äººæºæºä¸æ–­åœ°æ¥ï¼Œå¯ä»¥è®¡ç®—ä¸€ä¸‹ 4 ä¸ªåŒ»ç”Ÿä¸€å¤©å·¥ä½œ 8 å°æ—¶ï¼Œå¤„ç†çš„ç—…äººæ€»æ•°æ˜¯ï¼š<code>4 * 8 * 3 = 96</code></p><p><img src=/z-oblib/z2-attachments/6a10c9dad3ac38a87f514c18b0324711.png width=auto></p><p>ç»ç ”ç©¶å‘ç°ï¼Œçœ‹ç—…å¯ä»¥ç»†åˆ†ä¸ºå››ä¸ªæ­¥éª¤ï¼Œç»æ‹†åˆ†åæ¯ä¸ªæ­¥éª¤éœ€è¦ 5 åˆ†é’Ÿï¼Œå¦‚ä¸‹</p><p><img src=/z-oblib/z2-attachments/6a10c9dad3ac38a87f514c18b0324711.png width=auto></p><p>å› æ­¤å¯ä»¥åšå¦‚ä¸‹ä¼˜åŒ–ï¼Œåªæœ‰ä¸€å¼€å§‹ï¼ŒåŒ»ç”Ÿ 2ã€3ã€4 åˆ†åˆ«è¦ç­‰å¾… 5ã€10ã€15 åˆ†é’Ÿæ‰èƒ½æ‰§è¡Œå·¥ä½œï¼Œä½†åªè¦åç»­ç—…äººæºæºä¸æ–­åœ°æ¥ï¼Œä»–ä»¬å°±èƒ½å¤Ÿæ»¡è´Ÿè·å·¥ä½œï¼Œå¹¶ä¸”å¤„ç†ç—…äººçš„èƒ½åŠ›æé«˜åˆ°äº† <code>4 * 8 * 12</code> æ•ˆç‡å‡ ä¹æ˜¯åŸæ¥çš„å››å€</p><p><img src=/z-oblib/z2-attachments/a694740c598213c9bdeba1a223382696.png width=auto></p><a href=#è¦ç‚¹><h5 id=è¦ç‚¹><span class=hanchor arialabel=Anchor># </span>è¦ç‚¹</h5></a><blockquote><p>æå‡çš„æ€è·¯ç±»ä¼¼CPUçš„æµæ°´çº¿è®¾è®¡ï¼Œå°†å¤§ä»»åŠ¡ç»†åˆ†ï¼Œæ‹†ç»™ä¸åŒäººåšã€‚ï¼ˆä¸è¿‡CPUé‡æ’æå‡æ•ˆç‡çš„éƒ¨åˆ†åŸå› æ˜¯ä¸€äº›æ‰§è¡Œå¯ä»¥å¹¶è¡Œæ‰§è¡Œï¼Œè€Œè¿™é‡Œåœ¨çº¿ç¨‹æ•°é‡ä¸å˜çš„æƒ…å†µä¸‹ï¼Œæ€»å¤„ç†äº‹ä»¶ä¸ä¼šç¼©çŸ­ï¼‰ï¼›
é™ä½äº†å•ä¸€è¿æ¥çš„å“åº”é€Ÿåº¦ï¼ˆçº¿ç¨‹åˆ‡æ¢é¢å¤–å¼€é”€ï¼‰ï¼Œæå‡äº†ååé‡ï¼ˆå•ä½æ—¶é—´å¤„ç†è¯·æ±‚çš„ä¸ªæ•°ï¼‰ã€‚
å•ä¸ªè¿æ¥çš„å¤„ç†æ—¶é—´è¿˜æ˜¯å’ŒåŸæ¥ä¸€æ ·ï¼Œä½†æ˜¯ä¸ä¼šå› ä¸ºå…¶å®ƒè¿æ¥å ç”¨çº¿ç¨‹è€Œè¢«é˜»å¡äº†ã€‚
ä¸Šé¢çš„ä¾‹å­å¦‚æœä¸å¼‚æ­¥ï¼Œä¾‹å¦‚æœ‰çš„ç—…äººéœ€è¦åŠ¨æ‰‹æœ¯ï¼Œè€—è´¹å¤§é‡æ—¶é—´ï¼Œä¼šå¯¼è‡´å…¶å®ƒç—…äººæ²¡æ³•è¿›æ¥çœ‹ç—…ã€‚</p></blockquote><ul><li>å•çº¿ç¨‹æ²¡æ³•å¼‚æ­¥æé«˜æ•ˆç‡ï¼Œå¿…é¡»é…åˆå¤šçº¿ç¨‹ã€å¤šæ ¸ cpu æ‰èƒ½å‘æŒ¥å¼‚æ­¥çš„ä¼˜åŠ¿</li><li>å¼‚æ­¥å¹¶<strong>æ²¡æœ‰</strong>ç¼©çŸ­å“åº”æ—¶é—´ï¼Œåè€Œæœ‰æ‰€å¢åŠ </li><li>åˆç†è¿›è¡Œä»»åŠ¡æ‹†åˆ†ï¼Œä¹Ÿæ˜¯åˆ©ç”¨å¼‚æ­¥çš„å…³é”®</li></ul><a href=#33-future--promise><h3 id=33-future--promise><span class=hanchor arialabel=Anchor># </span>3.3 Future & Promise</h3></a><p>åœ¨å¼‚æ­¥å¤„ç†æ—¶ï¼Œç»å¸¸ç”¨åˆ°è¿™ä¸¤ä¸ªæ¥å£</p><p>é¦–å…ˆè¦è¯´æ˜ netty ä¸­çš„ Future ä¸ jdk ä¸­çš„ <a href=/2_0_2-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/2_0_2_1_2_0-%E8%BD%AF%E4%BB%B6%E8%AF%AD%E8%A8%80/Java/2-%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/FutureTask rel=noopener class=internal-link data-src=/2_0_2-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/2_0_2_1_2_0-%E8%BD%AF%E4%BB%B6%E8%AF%AD%E8%A8%80/Java/2-%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/FutureTask>Future</a> åŒåï¼Œä½†æ˜¯æ˜¯ä¸¤ä¸ªæ¥å£ï¼Œnetty çš„ Future ç»§æ‰¿è‡ª jdk çš„ Futureï¼Œè€Œ Promise åˆå¯¹ netty Future è¿›è¡Œäº†æ‰©å±•</p><ul><li>jdk Future åªèƒ½åŒæ­¥ç­‰å¾…ä»»åŠ¡ç»“æŸï¼ˆæˆ–æˆåŠŸã€æˆ–å¤±è´¥ï¼‰æ‰èƒ½å¾—åˆ°ç»“æœ</li><li>netty Future å¯ä»¥åŒæ­¥ç­‰å¾…ä»»åŠ¡ç»“æŸå¾—åˆ°ç»“æœï¼Œä¹Ÿå¯ä»¥å¼‚æ­¥æ–¹å¼å¾—åˆ°ç»“æœï¼Œä½†éƒ½æ˜¯è¦ç­‰ä»»åŠ¡ç»“æŸ</li><li>netty Promise ä¸ä»…æœ‰ netty Future çš„åŠŸèƒ½ï¼Œè€Œä¸”è„±ç¦»äº†ä»»åŠ¡ç‹¬ç«‹å­˜åœ¨ï¼Œåªä½œä¸ºä¸¤ä¸ªçº¿ç¨‹é—´ä¼ é€’ç»“æœçš„å®¹å™¨ï¼ˆå•å‘å˜åŒå‘ï¼‰</li></ul><table><thead><tr><th>åŠŸèƒ½/åç§°</th><th>jdk Future</th><th>netty Future</th><th>Promise</th></tr></thead><tbody><tr><td>cancel</td><td>å–æ¶ˆä»»åŠ¡</td><td>-</td><td>-</td></tr><tr><td>isCanceled</td><td>ä»»åŠ¡æ˜¯å¦å–æ¶ˆ</td><td>-</td><td>-</td></tr><tr><td>isDone</td><td>ä»»åŠ¡æ˜¯å¦å®Œæˆï¼Œä¸èƒ½åŒºåˆ†æˆåŠŸå¤±è´¥</td><td>-</td><td>-</td></tr><tr><td>get</td><td>è·å–ä»»åŠ¡ç»“æœï¼Œé˜»å¡ç­‰å¾…</td><td>-</td><td>-</td></tr><tr><td>getNow</td><td>-</td><td>è·å–ä»»åŠ¡ç»“æœï¼Œéé˜»å¡ï¼Œè¿˜æœªäº§ç”Ÿç»“æœæ—¶è¿”å› null</td><td>-</td></tr><tr><td>await</td><td>-</td><td>ç­‰å¾…ä»»åŠ¡ç»“æŸï¼Œå¦‚æœä»»åŠ¡å¤±è´¥ï¼Œä¸ä¼šæŠ›å¼‚å¸¸ï¼Œè€Œæ˜¯é€šè¿‡ isSuccess åˆ¤æ–­</td><td>-</td></tr><tr><td>sync</td><td>-</td><td>ç­‰å¾…ä»»åŠ¡ç»“æŸï¼Œå¦‚æœä»»åŠ¡å¤±è´¥ï¼ŒæŠ›å‡ºå¼‚å¸¸</td><td>-</td></tr><tr><td>isSuccess</td><td>-</td><td>åˆ¤æ–­ä»»åŠ¡æ˜¯å¦æˆåŠŸ</td><td>-</td></tr><tr><td>cause</td><td>-</td><td>è·å–å¤±è´¥ä¿¡æ¯ï¼Œéé˜»å¡ï¼Œå¦‚æœæ²¡æœ‰å¤±è´¥ï¼Œè¿”å›null</td><td>-</td></tr><tr><td>addLinstener</td><td>-</td><td>æ·»åŠ å›è°ƒï¼Œå¼‚æ­¥æ¥æ”¶ç»“æœ</td><td>-</td></tr><tr><td>setSuccess</td><td>-</td><td>-</td><td>è®¾ç½®æˆåŠŸç»“æœ</td></tr><tr><td>setFailure</td><td>-</td><td>-</td><td>è®¾ç½®å¤±è´¥ç»“æœ</td></tr></tbody></table><a href=#ä¾‹1><h4 id=ä¾‹1><span class=hanchor arialabel=Anchor># </span>ä¾‹1</h4></a><p>åŒæ­¥å¤„ç†ä»»åŠ¡æˆåŠŸ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>DefaultEventLoop</span> <span class=n>eventExecutors</span> <span class=o>=</span> <span class=k>new</span> <span class=n>DefaultEventLoop</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=n>DefaultPromise</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span> <span class=n>promise</span> <span class=o>=</span> <span class=k>new</span> <span class=n>DefaultPromise</span><span class=o>&lt;&gt;(</span><span class=n>eventExecutors</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>eventExecutors</span><span class=o>.</span><span class=na>execute</span><span class=o>(()-&gt;{</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Thread</span><span class=o>.</span><span class=na>sleep</span><span class=o>(</span><span class=n>1000</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;set success, {}&#34;</span><span class=o>,</span><span class=n>10</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>promise</span><span class=o>.</span><span class=na>setSuccess</span><span class=o>(</span><span class=n>10</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;start...&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;{}&#34;</span><span class=o>,</span><span class=n>promise</span><span class=o>.</span><span class=na>getNow</span><span class=o>());</span> <span class=c1>// è¿˜æ²¡æœ‰ç»“æœ
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;{}&#34;</span><span class=o>,</span><span class=n>promise</span><span class=o>.</span><span class=na>get</span><span class=o>());</span>
</span></span></code></pre></td></tr></table></div></div><p>è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>11:51:53 [DEBUG] [main] c.i.o.DefaultPromiseTest2 - start...
</span></span><span class=line><span class=cl>11:51:53 [DEBUG] [main] c.i.o.DefaultPromiseTest2 - null
</span></span><span class=line><span class=cl>11:51:54 [DEBUG] [defaultEventLoop-1-1] c.i.o.DefaultPromiseTest2 - set success, 10
</span></span><span class=line><span class=cl>11:51:54 [DEBUG] [main] c.i.o.DefaultPromiseTest2 - 10
</span></span></code></pre></td></tr></table></div></div><a href=#ä¾‹2><h4 id=ä¾‹2><span class=hanchor arialabel=Anchor># </span>ä¾‹2</h4></a><p>å¼‚æ­¥å¤„ç†ä»»åŠ¡æˆåŠŸ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>DefaultEventLoop</span> <span class=n>eventExecutors</span> <span class=o>=</span> <span class=k>new</span> <span class=n>DefaultEventLoop</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=n>DefaultPromise</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span> <span class=n>promise</span> <span class=o>=</span> <span class=k>new</span> <span class=n>DefaultPromise</span><span class=o>&lt;&gt;(</span><span class=n>eventExecutors</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// è®¾ç½®å›è°ƒï¼Œå¼‚æ­¥æ¥æ”¶ç»“æœ
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>promise</span><span class=o>.</span><span class=na>addListener</span><span class=o>(</span><span class=n>future</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// è¿™é‡Œçš„ future å°±æ˜¯ä¸Šé¢çš„ promise
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;{}&#34;</span><span class=o>,</span><span class=n>future</span><span class=o>.</span><span class=na>getNow</span><span class=o>());</span>
</span></span><span class=line><span class=cl><span class=o>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// ç­‰å¾… 1000 åè®¾ç½®æˆåŠŸç»“æœ
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>eventExecutors</span><span class=o>.</span><span class=na>execute</span><span class=o>(()-&gt;{</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Thread</span><span class=o>.</span><span class=na>sleep</span><span class=o>(</span><span class=n>1000</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;set success, {}&#34;</span><span class=o>,</span><span class=n>10</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>promise</span><span class=o>.</span><span class=na>setSuccess</span><span class=o>(</span><span class=n>10</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;start...&#34;</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><p>è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>11:49:30 [DEBUG] [main] c.i.o.DefaultPromiseTest2 - start...
</span></span><span class=line><span class=cl>11:49:31 [DEBUG] [defaultEventLoop-1-1] c.i.o.DefaultPromiseTest2 - set success, 10
</span></span><span class=line><span class=cl>11:49:31 [DEBUG] [defaultEventLoop-1-1] c.i.o.DefaultPromiseTest2 - 10
</span></span></code></pre></td></tr></table></div></div><a href=#ä¾‹3><h4 id=ä¾‹3><span class=hanchor arialabel=Anchor># </span>ä¾‹3</h4></a><p>åŒæ­¥å¤„ç†ä»»åŠ¡å¤±è´¥ - sync & get</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>DefaultEventLoop</span> <span class=n>eventExecutors</span> <span class=o>=</span> <span class=k>new</span> <span class=n>DefaultEventLoop</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>DefaultPromise</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span> <span class=n>promise</span> <span class=o>=</span> <span class=k>new</span> <span class=n>DefaultPromise</span><span class=o>&lt;&gt;(</span><span class=n>eventExecutors</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>eventExecutors</span><span class=o>.</span><span class=na>execute</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>Thread</span><span class=o>.</span><span class=na>sleep</span><span class=o>(</span><span class=n>1000</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=n>RuntimeException</span> <span class=n>e</span> <span class=o>=</span> <span class=k>new</span> <span class=n>RuntimeException</span><span class=o>(</span><span class=s>&#34;error...&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;set failure, {}&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>.</span><span class=na>toString</span><span class=o>());</span>
</span></span><span class=line><span class=cl>            <span class=n>promise</span><span class=o>.</span><span class=na>setFailure</span><span class=o>(</span><span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;start...&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;{}&#34;</span><span class=o>,</span> <span class=n>promise</span><span class=o>.</span><span class=na>getNow</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=n>promise</span><span class=o>.</span><span class=na>get</span><span class=o>();</span> <span class=c1>// sync() ä¹Ÿä¼šå‡ºç°å¼‚å¸¸ï¼Œåªæ˜¯ get ä¼šå†ç”¨ ExecutionException åŒ…ä¸€å±‚å¼‚å¸¸
</span></span></span></code></pre></td></tr></table></div></div><p>è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>12:11:07 [DEBUG] [main] c.i.o.DefaultPromiseTest2 - start...
</span></span><span class=line><span class=cl>12:11:07 [DEBUG] [main] c.i.o.DefaultPromiseTest2 - null
</span></span><span class=line><span class=cl>12:11:08 [DEBUG] [defaultEventLoop-1-1] c.i.o.DefaultPromiseTest2 - set failure, java.lang.RuntimeException: error...
</span></span><span class=line><span class=cl>Exception in thread &#34;main&#34; java.util.concurrent.ExecutionException: java.lang.RuntimeException: error...
</span></span><span class=line><span class=cl>	at io.netty.util.concurrent.AbstractFuture.get(AbstractFuture.java:41)
</span></span><span class=line><span class=cl>	at com.itcast.oio.DefaultPromiseTest2.main(DefaultPromiseTest2.java:34)
</span></span><span class=line><span class=cl>Caused by: java.lang.RuntimeException: error...
</span></span><span class=line><span class=cl>	at com.itcast.oio.DefaultPromiseTest2.lambda$main$0(DefaultPromiseTest2.java:27)
</span></span><span class=line><span class=cl>	at io.netty.channel.DefaultEventLoop.run(DefaultEventLoop.java:54)
</span></span><span class=line><span class=cl>	at io.netty.util.concurrent.SingleThreadEventExecutor$5.run(SingleThreadEventExecutor.java:918)
</span></span><span class=line><span class=cl>	at io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)
</span></span><span class=line><span class=cl>	at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
</span></span><span class=line><span class=cl>	at java.lang.Thread.run(Thread.java:745)
</span></span></code></pre></td></tr></table></div></div><a href=#ä¾‹4><h4 id=ä¾‹4><span class=hanchor arialabel=Anchor># </span>ä¾‹4</h4></a><p>åŒæ­¥å¤„ç†ä»»åŠ¡å¤±è´¥ - await</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>DefaultEventLoop</span> <span class=n>eventExecutors</span> <span class=o>=</span> <span class=k>new</span> <span class=n>DefaultEventLoop</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=n>DefaultPromise</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span> <span class=n>promise</span> <span class=o>=</span> <span class=k>new</span> <span class=n>DefaultPromise</span><span class=o>&lt;&gt;(</span><span class=n>eventExecutors</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>eventExecutors</span><span class=o>.</span><span class=na>execute</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Thread</span><span class=o>.</span><span class=na>sleep</span><span class=o>(</span><span class=n>1000</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=n>RuntimeException</span> <span class=n>e</span> <span class=o>=</span> <span class=k>new</span> <span class=n>RuntimeException</span><span class=o>(</span><span class=s>&#34;error...&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;set failure, {}&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>.</span><span class=na>toString</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=n>promise</span><span class=o>.</span><span class=na>setFailure</span><span class=o>(</span><span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;start...&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;{}&#34;</span><span class=o>,</span> <span class=n>promise</span><span class=o>.</span><span class=na>getNow</span><span class=o>());</span>
</span></span><span class=line><span class=cl><span class=n>promise</span><span class=o>.</span><span class=na>await</span><span class=o>();</span> <span class=c1>// ä¸ sync å’Œ get åŒºåˆ«åœ¨äºï¼Œä¸ä¼šæŠ›å¼‚å¸¸
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;result {}&#34;</span><span class=o>,</span> <span class=o>(</span><span class=n>promise</span><span class=o>.</span><span class=na>isSuccess</span><span class=o>()</span> <span class=o>?</span> <span class=n>promise</span><span class=o>.</span><span class=na>getNow</span><span class=o>()</span> <span class=o>:</span> <span class=n>promise</span><span class=o>.</span><span class=na>cause</span><span class=o>()).</span><span class=na>toString</span><span class=o>());</span>
</span></span></code></pre></td></tr></table></div></div><p>è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>12:18:53 [DEBUG] [main] c.i.o.DefaultPromiseTest2 - start...
</span></span><span class=line><span class=cl>12:18:53 [DEBUG] [main] c.i.o.DefaultPromiseTest2 - null
</span></span><span class=line><span class=cl>12:18:54 [DEBUG] [defaultEventLoop-1-1] c.i.o.DefaultPromiseTest2 - set failure, java.lang.RuntimeException: error...
</span></span><span class=line><span class=cl>12:18:54 [DEBUG] [main] c.i.o.DefaultPromiseTest2 - result java.lang.RuntimeException: error...
</span></span></code></pre></td></tr></table></div></div><a href=#ä¾‹5><h4 id=ä¾‹5><span class=hanchor arialabel=Anchor># </span>ä¾‹5</h4></a><p>å¼‚æ­¥å¤„ç†ä»»åŠ¡å¤±è´¥</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>DefaultEventLoop</span> <span class=n>eventExecutors</span> <span class=o>=</span> <span class=k>new</span> <span class=n>DefaultEventLoop</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=n>DefaultPromise</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span> <span class=n>promise</span> <span class=o>=</span> <span class=k>new</span> <span class=n>DefaultPromise</span><span class=o>&lt;&gt;(</span><span class=n>eventExecutors</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>promise</span><span class=o>.</span><span class=na>addListener</span><span class=o>(</span><span class=n>future</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;result {}&#34;</span><span class=o>,</span> <span class=o>(</span><span class=n>promise</span><span class=o>.</span><span class=na>isSuccess</span><span class=o>()</span> <span class=o>?</span> <span class=n>promise</span><span class=o>.</span><span class=na>getNow</span><span class=o>()</span> <span class=o>:</span> <span class=n>promise</span><span class=o>.</span><span class=na>cause</span><span class=o>()).</span><span class=na>toString</span><span class=o>());</span>
</span></span><span class=line><span class=cl><span class=o>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>eventExecutors</span><span class=o>.</span><span class=na>execute</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Thread</span><span class=o>.</span><span class=na>sleep</span><span class=o>(</span><span class=n>1000</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=n>RuntimeException</span> <span class=n>e</span> <span class=o>=</span> <span class=k>new</span> <span class=n>RuntimeException</span><span class=o>(</span><span class=s>&#34;error...&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;set failure, {}&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>.</span><span class=na>toString</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=n>promise</span><span class=o>.</span><span class=na>setFailure</span><span class=o>(</span><span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;start...&#34;</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><p>è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>12:04:57 [DEBUG] [main] c.i.o.DefaultPromiseTest2 - start...
</span></span><span class=line><span class=cl>12:04:58 [DEBUG] [defaultEventLoop-1-1] c.i.o.DefaultPromiseTest2 - set failure, java.lang.RuntimeException: error...
</span></span><span class=line><span class=cl>12:04:58 [DEBUG] [defaultEventLoop-1-1] c.i.o.DefaultPromiseTest2 - result java.lang.RuntimeException: error...
</span></span></code></pre></td></tr></table></div></div><a href=#ä¾‹6><h4 id=ä¾‹6><span class=hanchor arialabel=Anchor># </span>ä¾‹6</h4></a><p>await æ­»é”æ£€æŸ¥</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>DefaultEventLoop</span> <span class=n>eventExecutors</span> <span class=o>=</span> <span class=k>new</span> <span class=n>DefaultEventLoop</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=n>DefaultPromise</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span> <span class=n>promise</span> <span class=o>=</span> <span class=k>new</span> <span class=n>DefaultPromise</span><span class=o>&lt;&gt;(</span><span class=n>eventExecutors</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>eventExecutors</span><span class=o>.</span><span class=na>submit</span><span class=o>(()-&gt;{</span>
</span></span><span class=line><span class=cl>    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;1&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>promise</span><span class=o>.</span><span class=na>await</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=c1>// æ³¨æ„ä¸èƒ½ä»…æ•è· InterruptedException å¼‚å¸¸
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// å¦åˆ™ æ­»é”æ£€æŸ¥æŠ›å‡ºçš„ BlockingOperationException ä¼šç»§ç»­å‘ä¸Šä¼ æ’­
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// è€Œæäº¤çš„ä»»åŠ¡ä¼šè¢«åŒ…è£…ä¸º PromiseTaskï¼Œå®ƒçš„ run æ–¹æ³•ä¸­ä¼š catch æ‰€æœ‰å¼‚å¸¸ç„¶åè®¾ç½®ä¸º Promise çš„å¤±è´¥ç»“æœè€Œä¸ä¼šæŠ›å‡º
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Exception</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span> 
</span></span><span class=line><span class=cl>        <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;2&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>});</span>
</span></span><span class=line><span class=cl><span class=n>eventExecutors</span><span class=o>.</span><span class=na>submit</span><span class=o>(()-&gt;{</span>
</span></span><span class=line><span class=cl>    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;3&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>promise</span><span class=o>.</span><span class=na>await</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Exception</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;4&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>});</span>
</span></span></code></pre></td></tr></table></div></div><p>è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>1
</span></span><span class=line><span class=cl>2
</span></span><span class=line><span class=cl>3
</span></span><span class=line><span class=cl>4
</span></span><span class=line><span class=cl>io.netty.util.concurrent.BlockingOperationException: DefaultPromise@47499c2a(incomplete)
</span></span><span class=line><span class=cl>	at io.netty.util.concurrent.DefaultPromise.checkDeadLock(DefaultPromise.java:384)
</span></span><span class=line><span class=cl>	at io.netty.util.concurrent.DefaultPromise.await(DefaultPromise.java:212)
</span></span><span class=line><span class=cl>	at com.itcast.oio.DefaultPromiseTest.lambda$main$0(DefaultPromiseTest.java:27)
</span></span><span class=line><span class=cl>	at io.netty.util.concurrent.PromiseTask$RunnableAdapter.call(PromiseTask.java:38)
</span></span><span class=line><span class=cl>	at io.netty.util.concurrent.PromiseTask.run(PromiseTask.java:73)
</span></span><span class=line><span class=cl>	at io.netty.channel.DefaultEventLoop.run(DefaultEventLoop.java:54)
</span></span><span class=line><span class=cl>	at io.netty.util.concurrent.SingleThreadEventExecutor$5.run(SingleThreadEventExecutor.java:918)
</span></span><span class=line><span class=cl>	at io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)
</span></span><span class=line><span class=cl>	at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
</span></span><span class=line><span class=cl>	at java.lang.Thread.run(Thread.java:745)
</span></span><span class=line><span class=cl>io.netty.util.concurrent.BlockingOperationException: DefaultPromise@47499c2a(incomplete)
</span></span><span class=line><span class=cl>	at io.netty.util.concurrent.DefaultPromise.checkDeadLock(DefaultPromise.java:384)
</span></span><span class=line><span class=cl>	at io.netty.util.concurrent.DefaultPromise.await(DefaultPromise.java:212)
</span></span><span class=line><span class=cl>	at com.itcast.oio.DefaultPromiseTest.lambda$main$1(DefaultPromiseTest.java:36)
</span></span><span class=line><span class=cl>	at io.netty.util.concurrent.PromiseTask$RunnableAdapter.call(PromiseTask.java:38)
</span></span><span class=line><span class=cl>	at io.netty.util.concurrent.PromiseTask.run(PromiseTask.java:73)
</span></span><span class=line><span class=cl>	at io.netty.channel.DefaultEventLoop.run(DefaultEventLoop.java:54)
</span></span><span class=line><span class=cl>	at io.netty.util.concurrent.SingleThreadEventExecutor$5.run(SingleThreadEventExecutor.java:918)
</span></span><span class=line><span class=cl>	at io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)
</span></span><span class=line><span class=cl>	at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
</span></span><span class=line><span class=cl>	at java.lang.Thread.run(Thread.java:745)
</span></span></code></pre></td></tr></table></div></div><a href=#34-handler--pipeline><h3 id=34-handler--pipeline><span class=hanchor arialabel=Anchor># </span>3.4 Handler & Pipeline</h3></a><p>ChannelHandler ç”¨æ¥å¤„ç† Channel ä¸Šçš„å„ç§äº‹ä»¶ï¼Œåˆ†ä¸º<strong>å…¥</strong>ç«™ï¼ˆå®¢æˆ·ç«¯ä¾§ï¼‰ã€<strong>å‡º</strong>ç«™ï¼ˆæœåŠ¡å™¨ä¾§ï¼‰ä¸¤ç§ã€‚æ‰€æœ‰ ChannelHandler è¢«è¿æˆä¸€ä¸²ï¼Œå°±æ˜¯ Pipeline</p><ul><li>å…¥ç«™å¤„ç†å™¨é€šå¸¸æ˜¯ ChannelInboundHandlerAdapter çš„å­ç±»ï¼Œä¸»è¦ç”¨æ¥è¯»å–å®¢æˆ·ç«¯æ•°æ®ï¼Œå†™å›ç»“æœ</li><li>å‡ºç«™å¤„ç†å™¨é€šå¸¸æ˜¯ ChannelOutboundHandlerAdapter çš„å­ç±»ï¼Œä¸»è¦å¯¹å†™å›ç»“æœè¿›è¡ŒåŠ å·¥</li></ul><p>æ‰“ä¸ªæ¯”å–»ï¼Œæ¯ä¸ª Channel æ˜¯ä¸€ä¸ªäº§å“çš„åŠ å·¥è½¦é—´ï¼ŒPipeline æ˜¯è½¦é—´ä¸­çš„æµæ°´çº¿ï¼ŒChannelHandler å°±æ˜¯æµæ°´çº¿ä¸Šçš„å„é“å·¥åºï¼Œè€Œåé¢è¦è®²çš„ ByteBuf æ˜¯åŸææ–™ï¼Œç»è¿‡å¾ˆå¤šå·¥åºçš„åŠ å·¥ï¼šå…ˆç»è¿‡ä¸€é“é“å…¥ç«™å·¥åºï¼Œå†ç»è¿‡ä¸€é“é“å‡ºç«™å·¥åºæœ€ç»ˆå˜æˆäº§å“</p><p>å…ˆææ¸…æ¥šé¡ºåºï¼ŒæœåŠ¡ç«¯</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>new</span> <span class=n>ServerBootstrap</span><span class=o>()</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>group</span><span class=o>(</span><span class=k>new</span> <span class=n>NioEventLoopGroup</span><span class=o>())</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>channel</span><span class=o>(</span><span class=n>NioServerSocketChannel</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>childHandler</span><span class=o>(</span><span class=k>new</span> <span class=n>ChannelInitializer</span><span class=o>&lt;</span><span class=n>NioSocketChannel</span><span class=o>&gt;()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>initChannel</span><span class=o>(</span><span class=n>NioSocketChannel</span> <span class=n>ch</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>ChannelInboundHandlerAdapter</span><span class=o>(){</span>
</span></span><span class=line><span class=cl>                <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>                <span class=kd>public</span> <span class=kt>void</span> <span class=nf>channelRead</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>,</span> <span class=n>Object</span> <span class=n>msg</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>1</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>ctx</span><span class=o>.</span><span class=na>fireChannelRead</span><span class=o>(</span><span class=n>msg</span><span class=o>);</span> <span class=c1>// 1
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>});</span>
</span></span><span class=line><span class=cl>            <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>ChannelInboundHandlerAdapter</span><span class=o>(){</span>
</span></span><span class=line><span class=cl>                <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>                <span class=kd>public</span> <span class=kt>void</span> <span class=nf>channelRead</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>,</span> <span class=n>Object</span> <span class=n>msg</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>2</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>ctx</span><span class=o>.</span><span class=na>fireChannelRead</span><span class=o>(</span><span class=n>msg</span><span class=o>);</span> <span class=c1>// 2
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>});</span>
</span></span><span class=line><span class=cl>            <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>ChannelInboundHandlerAdapter</span><span class=o>(){</span>
</span></span><span class=line><span class=cl>                <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>                <span class=kd>public</span> <span class=kt>void</span> <span class=nf>channelRead</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>,</span> <span class=n>Object</span> <span class=n>msg</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>3</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>ctx</span><span class=o>.</span><span class=na>channel</span><span class=o>().</span><span class=na>write</span><span class=o>(</span><span class=n>msg</span><span class=o>);</span> <span class=c1>// 3
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>});</span>
</span></span><span class=line><span class=cl>            <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>ChannelOutboundHandlerAdapter</span><span class=o>(){</span>
</span></span><span class=line><span class=cl>                <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>                <span class=kd>public</span> <span class=kt>void</span> <span class=nf>write</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>,</span> <span class=n>Object</span> <span class=n>msg</span><span class=o>,</span> 
</span></span><span class=line><span class=cl>                                  <span class=n>ChannelPromise</span> <span class=n>promise</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>4</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>ctx</span><span class=o>.</span><span class=na>write</span><span class=o>(</span><span class=n>msg</span><span class=o>,</span> <span class=n>promise</span><span class=o>);</span> <span class=c1>// 4
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>});</span>
</span></span><span class=line><span class=cl>            <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>ChannelOutboundHandlerAdapter</span><span class=o>(){</span>
</span></span><span class=line><span class=cl>                <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>                <span class=kd>public</span> <span class=kt>void</span> <span class=nf>write</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>,</span> <span class=n>Object</span> <span class=n>msg</span><span class=o>,</span> 
</span></span><span class=line><span class=cl>                                  <span class=n>ChannelPromise</span> <span class=n>promise</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>5</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>ctx</span><span class=o>.</span><span class=na>write</span><span class=o>(</span><span class=n>msg</span><span class=o>,</span> <span class=n>promise</span><span class=o>);</span> <span class=c1>// 5
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>});</span>
</span></span><span class=line><span class=cl>            <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>ChannelOutboundHandlerAdapter</span><span class=o>(){</span>
</span></span><span class=line><span class=cl>                <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>                <span class=kd>public</span> <span class=kt>void</span> <span class=nf>write</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>,</span> <span class=n>Object</span> <span class=n>msg</span><span class=o>,</span> 
</span></span><span class=line><span class=cl>                                  <span class=n>ChannelPromise</span> <span class=n>promise</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>6</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>ctx</span><span class=o>.</span><span class=na>write</span><span class=o>(</span><span class=n>msg</span><span class=o>,</span> <span class=n>promise</span><span class=o>);</span> <span class=c1>// 6
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>});</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>})</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>bind</span><span class=o>(</span><span class=n>8080</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><p>å®¢æˆ·ç«¯</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>new</span> <span class=n>Bootstrap</span><span class=o>()</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>group</span><span class=o>(</span><span class=k>new</span> <span class=n>NioEventLoopGroup</span><span class=o>())</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>channel</span><span class=o>(</span><span class=n>NioSocketChannel</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>handler</span><span class=o>(</span><span class=k>new</span> <span class=n>ChannelInitializer</span><span class=o>&lt;</span><span class=n>Channel</span><span class=o>&gt;()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>initChannel</span><span class=o>(</span><span class=n>Channel</span> <span class=n>ch</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>StringEncoder</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>})</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>connect</span><span class=o>(</span><span class=s>&#34;127.0.0.1&#34;</span><span class=o>,</span> <span class=n>8080</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>addListener</span><span class=o>((</span><span class=n>ChannelFutureListener</span><span class=o>)</span> <span class=n>future</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>future</span><span class=o>.</span><span class=na>channel</span><span class=o>().</span><span class=na>writeAndFlush</span><span class=o>(</span><span class=s>&#34;hello,world&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>});</span>
</span></span></code></pre></td></tr></table></div></div><p>æœåŠ¡å™¨ç«¯æ‰“å°ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>1
</span></span><span class=line><span class=cl>2
</span></span><span class=line><span class=cl>3
</span></span><span class=line><span class=cl>6
</span></span><span class=line><span class=cl>5
</span></span><span class=line><span class=cl>4
</span></span></code></pre></td></tr></table></div></div><p>å¯ä»¥çœ‹åˆ°ï¼ŒChannelInboundHandlerAdapter æ˜¯æŒ‰ç…§ addLast çš„é¡ºåºæ‰§è¡Œçš„ï¼Œè€Œ ChannelOutboundHandlerAdapter æ˜¯æŒ‰ç…§ addLast çš„é€†åºæ‰§è¡Œçš„ã€‚ChannelPipeline çš„å®ç°æ˜¯ä¸€ä¸ª ChannelHandlerContextï¼ˆåŒ…è£…äº† ChannelHandlerï¼‰ ç»„æˆçš„åŒå‘é“¾è¡¨</p><p><img src=/z-oblib/z2-attachments/9f1815805bdefed71b1f6f5e5c0627ee.png width=auto></p><ul><li>å…¥ç«™å¤„ç†å™¨ä¸­ï¼Œctx.fireChannelRead(msg) æ˜¯ <strong>è°ƒç”¨ä¸‹ä¸€ä¸ªå…¥ç«™å¤„ç†å™¨</strong><ul><li>å¦‚æœæ³¨é‡Šæ‰ 1 å¤„ä»£ç ï¼Œåˆ™ä»…ä¼šæ‰“å° 1</li><li>å¦‚æœæ³¨é‡Šæ‰ 2 å¤„ä»£ç ï¼Œåˆ™ä»…ä¼šæ‰“å° 1 2</li></ul></li><li>3 å¤„çš„ ctx.channel().write(msg) ä¼š <strong>ä»å°¾éƒ¨å¼€å§‹è§¦å‘</strong> åç»­å‡ºç«™å¤„ç†å™¨çš„æ‰§è¡Œ<ul><li>å¦‚æœæ³¨é‡Šæ‰ 3 å¤„ä»£ç ï¼Œåˆ™ä»…ä¼šæ‰“å° 1 2 3</li></ul></li><li>ç±»ä¼¼çš„ï¼Œå‡ºç«™å¤„ç†å™¨ä¸­ï¼Œctx.write(msg, promise) çš„è°ƒç”¨ä¹Ÿä¼š <strong>è§¦å‘ä¸Šä¸€ä¸ªå‡ºç«™å¤„ç†å™¨</strong><ul><li>å¦‚æœæ³¨é‡Šæ‰ 6 å¤„ä»£ç ï¼Œåˆ™ä»…ä¼šæ‰“å° 1 2 3 6</li></ul></li><li>ctx.channel().write(msg) vs ctx.write(msg)<ul><li>éƒ½æ˜¯è§¦å‘å‡ºç«™å¤„ç†å™¨çš„æ‰§è¡Œ</li><li>ctx.channel().write(msg) ä»å°¾éƒ¨å¼€å§‹æŸ¥æ‰¾å‡ºç«™å¤„ç†å™¨</li><li>ctx.write(msg) æ˜¯ä»<strong>å½“å‰</strong>èŠ‚ç‚¹æ‰¾ä¸Šä¸€ä¸ªå‡ºç«™å¤„ç†å™¨</li><li>3 å¤„çš„ ctx.channel().write(msg) å¦‚æœæ”¹ä¸º ctx.write(msg) ä»…ä¼šæ‰“å° 1 2 3ï¼Œå› ä¸ºèŠ‚ç‚¹3 ä¹‹å‰æ²¡æœ‰å…¶å®ƒå‡ºç«™å¤„ç†å™¨äº†</li><li>6 å¤„çš„ ctx.write(msg, promise) å¦‚æœæ”¹ä¸º ctx.channel().write(msg) ä¼šæ‰“å° 1 2 3 6 6 6&mldr; å› ä¸º ctx.channel().write() æ˜¯ä»å°¾éƒ¨å¼€å§‹æŸ¥æ‰¾ï¼Œç»“æœåˆæ˜¯èŠ‚ç‚¹6 è‡ªå·±</li></ul></li></ul><blockquote><p>ctx.writeæ˜¯ä»å½“å‰èŠ‚ç‚¹æ‰¾ä¸‹ä¸€ä¸ªå‡ºç«™å¤„ç†å™¨
channel.writeæ˜¯ä»å°¾èŠ‚ç‚¹å¼€å§‹æ‰¾ä¸‹ä¸€ä¸ªå‡ºç«™å¤„ç†å™¨</p></blockquote><p>å›¾1 - æœåŠ¡ç«¯ pipeline è§¦å‘çš„åŸå§‹æµç¨‹ï¼Œå›¾ä¸­æ•°å­—ä»£è¡¨äº†å¤„ç†æ­¥éª¤çš„å…ˆåæ¬¡åº</p><p><img src=/z-oblib/z2-attachments/56d3381368d498b7fbe7e6b775fcbdd1.png width=auto></p><blockquote><p>æä¾›ä»å½“å‰èŠ‚ç‚¹ç›´æ¥æŸ¥æ‰¾çš„ç›®çš„æ˜¯æ–¹ä¾¿å°†å¤šä¸ªè¯»å†™æ“ä½œä¸²èµ·æ¥æ‰§è¡Œã€‚</p></blockquote><a href=#embeddedchannel><h4 id=embeddedchannel><span class=hanchor arialabel=Anchor># </span>EmbeddedChannel</h4></a><blockquote><p>handleræµ‹è¯•å·¥å…·ç±»ï¼Œä¸ç”¨å€ŸåŠ©æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯çš„å®ç°å°±èƒ½æ¨¡æ‹Ÿè¾“å…¥è¾“å‡ºæµ‹è¯•handlerã€‚</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span>  
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>TestEmbeddedChannel</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>        <span class=n>ChannelInboundHandlerAdapter</span> <span class=n>h1</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ChannelInboundHandlerAdapter</span><span class=o>(){</span>  
</span></span><span class=line><span class=cl>            <span class=nd>@Override</span>  
</span></span><span class=line><span class=cl>            <span class=kd>public</span> <span class=kt>void</span> <span class=nf>channelRead</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>,</span> <span class=n>Object</span> <span class=n>msg</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>                <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;1&#34;</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>                <span class=kd>super</span><span class=o>.</span><span class=na>channelRead</span><span class=o>(</span><span class=n>ctx</span><span class=o>,</span> <span class=n>msg</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>            <span class=o>}</span>  
</span></span><span class=line><span class=cl>        <span class=o>};</span>  
</span></span><span class=line><span class=cl>        <span class=n>ChannelInboundHandlerAdapter</span> <span class=n>h2</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ChannelInboundHandlerAdapter</span><span class=o>(){</span>  
</span></span><span class=line><span class=cl>            <span class=nd>@Override</span>  
</span></span><span class=line><span class=cl>            <span class=kd>public</span> <span class=kt>void</span> <span class=nf>channelRead</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>,</span> <span class=n>Object</span> <span class=n>msg</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>                <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;2&#34;</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>                <span class=kd>super</span><span class=o>.</span><span class=na>channelRead</span><span class=o>(</span><span class=n>ctx</span><span class=o>,</span> <span class=n>msg</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>            <span class=o>}</span>  
</span></span><span class=line><span class=cl>        <span class=o>};</span>  
</span></span><span class=line><span class=cl>        <span class=n>ChannelOutboundHandlerAdapter</span> <span class=n>h3</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ChannelOutboundHandlerAdapter</span><span class=o>()</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>            <span class=nd>@Override</span>  
</span></span><span class=line><span class=cl>            <span class=kd>public</span> <span class=kt>void</span> <span class=nf>write</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>,</span> <span class=n>Object</span> <span class=n>msg</span><span class=o>,</span> <span class=n>ChannelPromise</span> <span class=n>promise</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>                <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;3&#34;</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>                <span class=kd>super</span><span class=o>.</span><span class=na>write</span><span class=o>(</span><span class=n>ctx</span><span class=o>,</span> <span class=n>msg</span><span class=o>,</span> <span class=n>promise</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>            <span class=o>}</span>  
</span></span><span class=line><span class=cl>        <span class=o>};</span>  
</span></span><span class=line><span class=cl>        <span class=n>ChannelOutboundHandlerAdapter</span> <span class=n>h4</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ChannelOutboundHandlerAdapter</span><span class=o>()</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>            <span class=nd>@Override</span>  
</span></span><span class=line><span class=cl>            <span class=kd>public</span> <span class=kt>void</span> <span class=nf>write</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>,</span> <span class=n>Object</span> <span class=n>msg</span><span class=o>,</span> <span class=n>ChannelPromise</span> <span class=n>promise</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>                <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;4&#34;</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>                <span class=kd>super</span><span class=o>.</span><span class=na>write</span><span class=o>(</span><span class=n>ctx</span><span class=o>,</span> <span class=n>msg</span><span class=o>,</span> <span class=n>promise</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>            <span class=o>}</span>  
</span></span><span class=line><span class=cl>        <span class=o>};</span>  
</span></span><span class=line><span class=cl>        <span class=n>EmbeddedChannel</span> <span class=n>channel</span> <span class=o>=</span> <span class=k>new</span> <span class=n>EmbeddedChannel</span><span class=o>(</span><span class=n>h1</span><span class=o>,</span> <span class=n>h2</span><span class=o>,</span> <span class=n>h3</span><span class=o>,</span> <span class=n>h4</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>        <span class=c1>// æ¨¡æ‹Ÿå…¥ç«™  
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>channel</span><span class=o>.</span><span class=na>writeInbound</span><span class=o>(</span><span class=n>ByteBufAllocator</span><span class=o>.</span><span class=na>DEFAULT</span><span class=o>.</span><span class=na>buffer</span><span class=o>().</span><span class=na>writeBytes</span><span class=o>(</span><span class=s>&#34;Hello&#34;</span><span class=o>.</span><span class=na>getBytes</span><span class=o>()));</span>  
</span></span><span class=line><span class=cl>        <span class=c1>// æ¨¡æ‹Ÿå‡ºç«™  
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>channel</span><span class=o>.</span><span class=na>writeOutbound</span><span class=o>(</span><span class=n>ByteBufAllocator</span><span class=o>.</span><span class=na>DEFAULT</span><span class=o>.</span><span class=na>buffer</span><span class=o>().</span><span class=na>writeBytes</span><span class=o>(</span><span class=s>&#34;World&#34;</span><span class=o>.</span><span class=na>getBytes</span><span class=o>()));</span>  
</span></span><span class=line><span class=cl>    <span class=o>}</span>  
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#35-bytebuf><h3 id=35-bytebuf><span class=hanchor arialabel=Anchor># </span>3.5 ByteBuf</h3></a><p>æ˜¯å¯¹å­—èŠ‚æ•°æ®çš„å°è£…</p><blockquote><p>é»˜è®¤å¤§å°256ï¼Œå¯åŠ¨æ€æ‰©å®¹ï¼Œè€ŒNIOçš„ByteBufferä¸æ”¯æŒåŠ¨æ€æ‰©å®¹ã€‚</p></blockquote><a href=#1åˆ›å»º><h4 id=1åˆ›å»º><span class=hanchor arialabel=Anchor># </span>1ï¼‰åˆ›å»º</h4></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>ByteBuf</span> <span class=n>buffer</span> <span class=o>=</span> <span class=n>ByteBufAllocator</span><span class=o>.</span><span class=na>DEFAULT</span><span class=o>.</span><span class=na>buffer</span><span class=o>(</span><span class=n>10</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>log</span><span class=o>(</span><span class=n>buffer</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>DEFAULTæ˜¯ä¸€ä¸ªé»˜è®¤æ–¹æ³•å®ç°ã€‚</p></blockquote><p>ä¸Šé¢ä»£ç åˆ›å»ºäº†ä¸€ä¸ªé»˜è®¤çš„ ByteBufï¼ˆæ± åŒ–åŸºäºç›´æ¥å†…å­˜çš„ ByteBufï¼‰ï¼Œåˆå§‹å®¹é‡æ˜¯ 10</p><p>è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>read index:0 write index:0 capacity:10
</span></span></code></pre></td></tr></table></div></div><p>å…¶ä¸­ log æ–¹æ³•å‚è€ƒå¦‚ä¸‹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>log</span><span class=o>(</span><span class=n>ByteBuf</span> <span class=n>buffer</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>length</span> <span class=o>=</span> <span class=n>buffer</span><span class=o>.</span><span class=na>readableBytes</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>rows</span> <span class=o>=</span> <span class=n>length</span> <span class=o>/</span> <span class=n>16</span> <span class=o>+</span> <span class=o>(</span><span class=n>length</span> <span class=o>%</span> <span class=n>15</span> <span class=o>==</span> <span class=n>0</span> <span class=o>?</span> <span class=n>0</span> <span class=o>:</span> <span class=n>1</span><span class=o>)</span> <span class=o>+</span> <span class=n>4</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>StringBuilder</span> <span class=n>buf</span> <span class=o>=</span> <span class=k>new</span> <span class=n>StringBuilder</span><span class=o>(</span><span class=n>rows</span> <span class=o>*</span> <span class=n>80</span> <span class=o>*</span> <span class=n>2</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=na>append</span><span class=o>(</span><span class=s>&#34;read index:&#34;</span><span class=o>).</span><span class=na>append</span><span class=o>(</span><span class=n>buffer</span><span class=o>.</span><span class=na>readerIndex</span><span class=o>())</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=na>append</span><span class=o>(</span><span class=s>&#34; write index:&#34;</span><span class=o>).</span><span class=na>append</span><span class=o>(</span><span class=n>buffer</span><span class=o>.</span><span class=na>writerIndex</span><span class=o>())</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=na>append</span><span class=o>(</span><span class=s>&#34; capacity:&#34;</span><span class=o>).</span><span class=na>append</span><span class=o>(</span><span class=n>buffer</span><span class=o>.</span><span class=na>capacity</span><span class=o>())</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=na>append</span><span class=o>(</span><span class=n>NEWLINE</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>appendPrettyHexDump</span><span class=o>(</span><span class=n>buf</span><span class=o>,</span> <span class=n>buffer</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>buf</span><span class=o>.</span><span class=na>toString</span><span class=o>());</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#2ç›´æ¥å†…å­˜-vs-å †å†…å­˜><h4 id=2ç›´æ¥å†…å­˜-vs-å †å†…å­˜><span class=hanchor arialabel=Anchor># </span>2ï¼‰ç›´æ¥å†…å­˜ vs å †å†…å­˜</h4></a><p>å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„ä»£ç æ¥åˆ›å»ºæ± åŒ–åŸºäºå †çš„ ByteBuf</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>ByteBuf</span> <span class=n>buffer</span> <span class=o>=</span> <span class=n>ByteBufAllocator</span><span class=o>.</span><span class=na>DEFAULT</span><span class=o>.</span><span class=na>heapBuffer</span><span class=o>(</span><span class=n>10</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><p>ä¹Ÿå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„ä»£ç æ¥åˆ›å»ºæ± åŒ–åŸºäºç›´æ¥å†…å­˜çš„ ByteBuf</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>ByteBuf</span> <span class=n>buffer</span> <span class=o>=</span> <span class=n>ByteBufAllocator</span><span class=o>.</span><span class=na>DEFAULT</span><span class=o>.</span><span class=na>directBuffer</span><span class=o>(</span><span class=n>10</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>ç›´æ¥å†…å­˜åˆ›å»ºå’Œé”€æ¯çš„ä»£ä»·æ˜‚è´µï¼Œä½†è¯»å†™æ€§èƒ½é«˜ï¼ˆå°‘ä¸€æ¬¡å†…å­˜å¤åˆ¶ï¼‰ï¼Œé€‚åˆé…åˆæ± åŒ–åŠŸèƒ½ä¸€èµ·ç”¨</li><li>ç›´æ¥å†…å­˜å¯¹ GC å‹åŠ›å°ï¼Œå› ä¸ºè¿™éƒ¨åˆ†å†…å­˜ä¸å— JVM åƒåœ¾å›æ”¶çš„ç®¡ç†ï¼Œä½†ä¹Ÿè¦æ³¨æ„åŠæ—¶<strong>ä¸»åŠ¨</strong>é‡Šæ”¾</li></ul><blockquote><p>gcå¯èƒ½ä¼šå¯¹å †å†…å­˜ä¸­çš„æ•°æ®è¿›è¡Œæ¬è¿ã€å¤åˆ¶ç­‰æ“ä½œã€‚</p></blockquote><a href=#3æ± åŒ–-vs-éæ± åŒ–><h4 id=3æ± åŒ–-vs-éæ± åŒ–><span class=hanchor arialabel=Anchor># </span>3ï¼‰æ± åŒ– vs éæ± åŒ–</h4></a><blockquote><p><a href=/2_0_2-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/2_0_2_1_2_1-%E8%BD%AF%E4%BB%B6%E6%96%B9%E6%B3%95%E5%AD%A6/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E4%BA%AB%E5%85%83%E6%A8%A1%E5%BC%8F rel=noopener class=internal-link data-src=/2_0_2-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/2_0_2_1_2_1-%E8%BD%AF%E4%BB%B6%E6%96%B9%E6%B3%95%E5%AD%A6/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E4%BA%AB%E5%85%83%E6%A8%A1%E5%BC%8F>äº«å…ƒæ¨¡å¼</a>ã€‚</p></blockquote><p>æ± åŒ–çš„æœ€å¤§æ„ä¹‰åœ¨äºå¯ä»¥é‡ç”¨ ByteBufï¼Œä¼˜ç‚¹æœ‰</p><ul><li>æ²¡æœ‰æ± åŒ–ï¼Œåˆ™æ¯æ¬¡éƒ½å¾—åˆ›å»ºæ–°çš„ ByteBuf å®ä¾‹ï¼Œè¿™ä¸ªæ“ä½œå¯¹ç›´æ¥å†…å­˜ä»£ä»·æ˜‚è´µï¼Œå°±ç®—æ˜¯å †å†…å­˜ï¼Œä¹Ÿä¼šå¢åŠ  GC å‹åŠ›</li><li>æœ‰äº†æ± åŒ–ï¼Œåˆ™å¯ä»¥é‡ç”¨æ± ä¸­ ByteBuf å®ä¾‹ï¼Œå¹¶ä¸”é‡‡ç”¨äº†ä¸ jemalloc ç±»ä¼¼çš„å†…å­˜åˆ†é…ç®—æ³•æå‡åˆ†é…æ•ˆç‡</li><li>é«˜å¹¶å‘æ—¶ï¼Œæ± åŒ–åŠŸèƒ½æ›´<strong>èŠ‚çº¦å†…å­˜</strong>ï¼Œå‡å°‘å†…å­˜æº¢å‡ºçš„å¯èƒ½</li></ul><p>æ± åŒ–åŠŸèƒ½æ˜¯å¦å¼€å¯ï¼Œå¯ä»¥é€šè¿‡ä¸‹é¢çš„ç³»ç»Ÿç¯å¢ƒå˜é‡æ¥è®¾ç½®</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=o>-</span><span class=n>Dio</span><span class=o>.</span><span class=na>netty</span><span class=o>.</span><span class=na>allocator</span><span class=o>.</span><span class=na>type</span><span class=o>={</span><span class=n>unpooled</span><span class=o>|</span><span class=n>pooled</span><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>åœ¨VM optionsä¸­é…ç½®ï¼š
<img src="/z-oblib/z2-attachments/Pasted image 20220621203238.png" width=auto></p><ul><li>4.1 ä»¥åï¼Œé Android å¹³å°é»˜è®¤å¯ç”¨æ± åŒ–å®ç°ï¼ŒAndroid å¹³å°å¯ç”¨éæ± åŒ–å®ç°</li><li>4.1 ä¹‹å‰ï¼Œæ± åŒ–åŠŸèƒ½è¿˜ä¸æˆç†Ÿï¼Œé»˜è®¤æ˜¯éæ± åŒ–å®ç°</li></ul><a href=#4ç»„æˆ><h4 id=4ç»„æˆ><span class=hanchor arialabel=Anchor># </span>4ï¼‰ç»„æˆ</h4></a><p>ByteBuf ç”±å››éƒ¨åˆ†ç»„æˆ</p><p><img src=/z-oblib/z2-attachments/cba17278034a053c70930947343310aa.png width=auto></p><p>æœ€å¼€å§‹è¯»å†™æŒ‡é’ˆéƒ½åœ¨ 0 ä½ç½®
æœ€å¤§å®¹é‡é»˜è®¤æ˜¯Iterator.MAX_VALUE</p><blockquote><p>å’ŒNIOç›¸æ¯”ï¼Œä¸¤æ¡æŒ‡é’ˆä¸ç”¨flipè¿›è¡Œè¯»å†™åˆ‡æ¢äº†ã€‚</p></blockquote><a href=#5å†™å…¥><h4 id=5å†™å…¥><span class=hanchor arialabel=Anchor># </span>5ï¼‰å†™å…¥</h4></a><p>æ–¹æ³•åˆ—è¡¨ï¼Œçœç•¥ä¸€äº›ä¸é‡è¦çš„æ–¹æ³•</p><table><thead><tr><th>æ–¹æ³•ç­¾å</th><th>å«ä¹‰</th><th>å¤‡æ³¨</th></tr></thead><tbody><tr><td>writeBoolean(boolean value)</td><td>å†™å…¥ boolean å€¼</td><td>ç”¨ä¸€å­—èŠ‚ 01|00 ä»£è¡¨ true|false</td></tr><tr><td>writeByte(int value)</td><td>å†™å…¥ byte å€¼</td><td></td></tr><tr><td>writeShort(int value)</td><td>å†™å…¥ short å€¼</td><td></td></tr><tr><td>writeInt(int value)</td><td>å†™å…¥ int å€¼</td><td>Big Endianï¼Œå³ 0x250ï¼Œå†™å…¥å 00 00 02 50</td></tr><tr><td>writeIntLE(int value)</td><td>å†™å…¥ int å€¼</td><td>Little Endianï¼Œå³ 0x250ï¼Œå†™å…¥å 50 02 00 00</td></tr><tr><td>writeLong(long value)</td><td>å†™å…¥ long å€¼</td><td></td></tr><tr><td>writeChar(int value)</td><td>å†™å…¥ char å€¼</td><td></td></tr><tr><td>writeFloat(float value)</td><td>å†™å…¥ float å€¼</td><td></td></tr><tr><td>writeDouble(double value)</td><td>å†™å…¥ double å€¼</td><td></td></tr><tr><td>writeBytes(ByteBuf src)</td><td>å†™å…¥ netty çš„ ByteBuf</td><td></td></tr><tr><td>writeBytes(byte[] src)</td><td>å†™å…¥ byte[]</td><td></td></tr><tr><td>writeBytes(ByteBuffer src)</td><td>å†™å…¥ nio çš„ ByteBuffer</td><td></td></tr><tr><td>int writeCharSequence(CharSequence sequence, Charset charset)</td><td>å†™å…¥å­—ç¬¦ä¸²</td><td></td></tr></tbody></table><blockquote><p>æ³¨æ„</p><p>è¿™äº›æ–¹æ³•çš„æœªæŒ‡æ˜è¿”å›å€¼çš„ï¼Œå…¶è¿”å›å€¼éƒ½æ˜¯ ByteBufï¼Œæ„å‘³ç€å¯ä»¥é“¾å¼è°ƒç”¨
ç½‘ç»œä¼ è¾“ï¼Œé»˜è®¤ä¹ æƒ¯æ˜¯ Big Endian</p></blockquote><p>å…ˆå†™å…¥ 4 ä¸ªå­—èŠ‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>buffer</span><span class=o>.</span><span class=na>writeBytes</span><span class=o>(</span><span class=k>new</span> <span class=kt>byte</span><span class=o>[]{</span><span class=n>1</span><span class=o>,</span> <span class=n>2</span><span class=o>,</span> <span class=n>3</span><span class=o>,</span> <span class=n>4</span><span class=o>});</span>
</span></span><span class=line><span class=cl><span class=n>log</span><span class=o>(</span><span class=n>buffer</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><p>ç»“æœæ˜¯</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>read index:0 write index:4 capacity:10
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 01 02 03 04                                     |....            |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span></code></pre></td></tr></table></div></div><p>å†å†™å…¥ä¸€ä¸ª int æ•´æ•°ï¼Œä¹Ÿæ˜¯ 4 ä¸ªå­—èŠ‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>buffer</span><span class=o>.</span><span class=na>writeInt</span><span class=o>(</span><span class=n>5</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>log</span><span class=o>(</span><span class=n>buffer</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><p>ç»“æœæ˜¯</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>read index:0 write index:8 capacity:10
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 01 02 03 04 00 00 00 05                         |........        |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span></code></pre></td></tr></table></div></div><p>è¿˜æœ‰ä¸€ç±»æ–¹æ³•æ˜¯ set å¼€å¤´çš„ä¸€ç³»åˆ—æ–¹æ³•ï¼Œä¹Ÿå¯ä»¥å†™å…¥æ•°æ®ï¼Œä½†ä¸ä¼šæ”¹å˜å†™æŒ‡é’ˆä½ç½®</p><a href=#6æ‰©å®¹><h4 id=6æ‰©å®¹><span class=hanchor arialabel=Anchor># </span>6ï¼‰æ‰©å®¹</h4></a><p>å†å†™å…¥ä¸€ä¸ª int æ•´æ•°æ—¶ï¼Œå®¹é‡ä¸å¤Ÿäº†ï¼ˆåˆå§‹å®¹é‡æ˜¯ 10ï¼‰ï¼Œè¿™æ—¶ä¼šå¼•å‘æ‰©å®¹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>buffer</span><span class=o>.</span><span class=na>writeInt</span><span class=o>(</span><span class=n>6</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>log</span><span class=o>(</span><span class=n>buffer</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><p>æ‰©å®¹è§„åˆ™æ˜¯</p><ul><li>å¦‚ä½•å†™å…¥åæ•°æ®å¤§å°æœªè¶…è¿‡ 512ï¼Œåˆ™é€‰æ‹©ä¸‹ä¸€ä¸ª 16 çš„æ•´æ•°å€ï¼Œä¾‹å¦‚å†™å…¥åå¤§å°ä¸º 12 ï¼Œåˆ™æ‰©å®¹å capacity æ˜¯ 16</li><li>å¦‚æœå†™å…¥åæ•°æ®å¤§å°è¶…è¿‡ 512ï¼Œåˆ™é€‰æ‹©ä¸‹ä¸€ä¸ª 2^nï¼Œä¾‹å¦‚å†™å…¥åå¤§å°ä¸º 513ï¼Œåˆ™æ‰©å®¹å capacity æ˜¯ 2^10=1024ï¼ˆ2^9=512 å·²ç»ä¸å¤Ÿäº†ï¼‰</li><li>æ‰©å®¹ä¸èƒ½è¶…è¿‡ max capacity ä¼šæŠ¥é”™</li></ul><p>ç»“æœæ˜¯</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>read index:0 write index:12 capacity:16
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 01 02 03 04 00 00 00 05 00 00 00 06             |............    |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span></code></pre></td></tr></table></div></div><a href=#7è¯»å–><h4 id=7è¯»å–><span class=hanchor arialabel=Anchor># </span>7ï¼‰è¯»å–</h4></a><p>ä¾‹å¦‚è¯»äº† 4 æ¬¡ï¼Œæ¯æ¬¡ä¸€ä¸ªå­—èŠ‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>buffer</span><span class=o>.</span><span class=na>readByte</span><span class=o>());</span>
</span></span><span class=line><span class=cl><span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>buffer</span><span class=o>.</span><span class=na>readByte</span><span class=o>());</span>
</span></span><span class=line><span class=cl><span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>buffer</span><span class=o>.</span><span class=na>readByte</span><span class=o>());</span>
</span></span><span class=line><span class=cl><span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>buffer</span><span class=o>.</span><span class=na>readByte</span><span class=o>());</span>
</span></span><span class=line><span class=cl><span class=n>log</span><span class=o>(</span><span class=n>buffer</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><p>è¯»è¿‡çš„å†…å®¹ï¼Œå°±å±äºåºŸå¼ƒéƒ¨åˆ†äº†ï¼Œå†è¯»åªèƒ½è¯»é‚£äº›å°šæœªè¯»å–çš„éƒ¨åˆ†</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>1
</span></span><span class=line><span class=cl>2
</span></span><span class=line><span class=cl>3
</span></span><span class=line><span class=cl>4
</span></span><span class=line><span class=cl>read index:4 write index:12 capacity:16
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 00 00 00 05 00 00 00 06                         |........        |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span></code></pre></td></tr></table></div></div><p>å¦‚æœéœ€è¦é‡å¤è¯»å– int æ•´æ•° 5ï¼Œæ€ä¹ˆåŠï¼Ÿ</p><p>å¯ä»¥åœ¨ read å‰å…ˆåšä¸ª<strong>è¯»æŒ‡é’ˆ</strong>çš„æ ‡è®° mark</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>buffer</span><span class=o>.</span><span class=na>markReaderIndex</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>buffer</span><span class=o>.</span><span class=na>readInt</span><span class=o>());</span>
</span></span><span class=line><span class=cl><span class=n>log</span><span class=o>(</span><span class=n>buffer</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><p>ç»“æœ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>5
</span></span><span class=line><span class=cl>read index:8 write index:12 capacity:16
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 00 00 00 06                                     |....            |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span></code></pre></td></tr></table></div></div><p>è¿™æ—¶è¦é‡å¤è¯»å–çš„è¯ï¼Œè¯»æŒ‡é’ˆé‡ç½®åˆ°æ ‡è®°ä½ç½® reset</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>buffer</span><span class=o>.</span><span class=na>resetReaderIndex</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=n>log</span><span class=o>(</span><span class=n>buffer</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><p>è¿™æ—¶</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>read index:4 write index:12 capacity:16
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 00 00 00 05 00 00 00 06                         |........        |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span></code></pre></td></tr></table></div></div><p>è¿˜æœ‰ç§åŠæ³•æ˜¯é‡‡ç”¨ get å¼€å¤´çš„ä¸€ç³»åˆ—æ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•ä¸ä¼šæ”¹å˜ read index</p><a href=#8retain--release><h4 id=8retain--release><span class=hanchor arialabel=Anchor># </span>8ï¼‰retain & release</h4></a><p>ç”±äº Netty ä¸­æœ‰å †å¤–å†…å­˜çš„ ByteBuf å®ç°ï¼Œå †å¤–å†…å­˜æœ€å¥½æ˜¯æ‰‹åŠ¨æ¥é‡Šæ”¾ï¼Œè€Œä¸æ˜¯ç­‰ GC åƒåœ¾å›æ”¶ã€‚</p><ul><li>UnpooledHeapByteBuf ä½¿ç”¨çš„æ˜¯ JVM å†…å­˜ï¼Œåªéœ€ç­‰ GC å›æ”¶å†…å­˜å³å¯</li><li>UnpooledDirectByteBuf ä½¿ç”¨çš„å°±æ˜¯ç›´æ¥å†…å­˜äº†ï¼Œéœ€è¦ç‰¹æ®Šçš„æ–¹æ³•æ¥å›æ”¶å†…å­˜</li><li>PooledByteBuf å’Œå®ƒçš„å­ç±»ä½¿ç”¨äº†æ± åŒ–æœºåˆ¶ï¼Œéœ€è¦æ›´å¤æ‚çš„è§„åˆ™æ¥å›æ”¶å†…å­˜</li></ul><blockquote><p>å›æ”¶å†…å­˜çš„æºç å®ç°ï¼Œè¯·å…³æ³¨ä¸‹é¢æ–¹æ³•çš„ä¸åŒå®ç°
<code>protected abstract void deallocate()</code></p></blockquote><p>Netty è¿™é‡Œé‡‡ç”¨äº†å¼•ç”¨è®¡æ•°æ³•æ¥æ§åˆ¶å›æ”¶å†…å­˜ï¼Œæ¯ä¸ª ByteBuf éƒ½å®ç°äº† ReferenceCounted æ¥å£</p><ul><li>æ¯ä¸ª ByteBuf å¯¹è±¡çš„åˆå§‹è®¡æ•°ä¸º 1</li><li>è°ƒç”¨ release æ–¹æ³•è®¡æ•°å‡ 1ï¼Œå¦‚æœè®¡æ•°ä¸º 0ï¼ŒByteBuf å†…å­˜è¢«å›æ”¶</li><li>è°ƒç”¨ retain æ–¹æ³•è®¡æ•°åŠ  1ï¼Œè¡¨ç¤ºè°ƒç”¨è€…æ²¡ç”¨å®Œä¹‹å‰ï¼Œå…¶å®ƒ handler å³ä½¿è°ƒç”¨äº† release ä¹Ÿä¸ä¼šé€ æˆå›æ”¶</li><li>å½“è®¡æ•°ä¸º 0 æ—¶ï¼Œåº•å±‚å†…å­˜ä¼šè¢«å›æ”¶ï¼Œè¿™æ—¶å³ä½¿ ByteBuf å¯¹è±¡è¿˜åœ¨ï¼Œå…¶å„ä¸ªæ–¹æ³•å‡æ— æ³•æ­£å¸¸ä½¿ç”¨</li></ul><p>è°æ¥è´Ÿè´£ release å‘¢ï¼Ÿ</p><p>ä¸æ˜¯æˆ‘ä»¬æƒ³è±¡çš„ï¼ˆä¸€èˆ¬æƒ…å†µä¸‹ï¼‰</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>ByteBuf</span> <span class=n>buf</span> <span class=o>=</span> <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>buf</span><span class=o>.</span><span class=na>release</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>è¯·æ€è€ƒï¼Œå› ä¸º pipeline çš„å­˜åœ¨ï¼Œä¸€èˆ¬éœ€è¦å°† ByteBuf ä¼ é€’ç»™ä¸‹ä¸€ä¸ª ChannelHandlerï¼Œå¦‚æœåœ¨ finally ä¸­ release äº†ï¼Œå°±å¤±å»äº†ä¼ é€’æ€§ï¼ˆå½“ç„¶ï¼Œå¦‚æœåœ¨è¿™ä¸ª ChannelHandler å†…è¿™ä¸ª ByteBuf å·²å®Œæˆäº†å®ƒçš„ä½¿å‘½ï¼Œé‚£ä¹ˆä¾¿æ— é¡»å†ä¼ é€’ï¼‰</p><p>åŸºæœ¬è§„åˆ™æ˜¯ï¼Œ<strong>è°æ˜¯æœ€åä½¿ç”¨è€…ï¼Œè°è´Ÿè´£ release</strong>ï¼Œè¯¦ç»†åˆ†æå¦‚ä¸‹</p><ul><li>èµ·ç‚¹ï¼Œå¯¹äº NIO å®ç°æ¥è®²ï¼Œåœ¨ <code>io.netty.channel.nio.AbstractNioByteChannel.NioByteUnsafe#read</code> æ–¹æ³•ä¸­é¦–æ¬¡åˆ›å»º ByteBuf æ”¾å…¥ pipelineï¼ˆline 163 pipeline.fireChannelRead(byteBuf)ï¼‰</li><li>å…¥ç«™ ByteBuf å¤„ç†åŸåˆ™<ul><li>å¯¹åŸå§‹ ByteBuf ä¸åšå¤„ç†ï¼Œè°ƒç”¨ <code>ctx.fireChannelRead(msg)</code> å‘åä¼ é€’ï¼Œè¿™æ—¶æ— é¡» release</li><li>å°†åŸå§‹ ByteBuf è½¬æ¢ä¸ºå…¶å®ƒç±»å‹çš„ Java å¯¹è±¡ï¼Œè¿™æ—¶ ByteBuf å°±æ²¡ç”¨äº†ï¼Œå¿…é¡» release</li><li><strong>å¦‚æœä¸è°ƒç”¨ <code>ctx.fireChannelRead(msg)</code> å‘åä¼ é€’ï¼Œé‚£ä¹ˆä¹Ÿå¿…é¡» release</strong></li><li>æ³¨æ„å„ç§å¼‚å¸¸ï¼Œå¦‚æœ ByteBuf æ²¡æœ‰æˆåŠŸä¼ é€’åˆ°ä¸‹ä¸€ä¸ª ChannelHandlerï¼Œå¿…é¡» release</li><li>å‡è®¾æ¶ˆæ¯ä¸€ç›´å‘åä¼ ï¼Œé‚£ä¹ˆ <strong>TailContext ä¼šè´Ÿè´£é‡Šæ”¾æœªå¤„ç†æ¶ˆæ¯</strong>ï¼ˆåŸå§‹çš„ ByteBufï¼‰</li></ul></li><li>å‡ºç«™ ByteBuf å¤„ç†åŸåˆ™<ul><li>å‡ºç«™æ¶ˆæ¯æœ€ç»ˆéƒ½ä¼šè½¬ä¸º ByteBuf è¾“å‡ºï¼Œä¸€ç›´å‘å‰ä¼ ï¼Œç”± <strong>HeadContext flush å release</strong></li></ul></li><li>å¼‚å¸¸å¤„ç†åŸåˆ™<ul><li>æœ‰æ—¶å€™ä¸æ¸…æ¥š ByteBuf è¢«å¼•ç”¨äº†å¤šå°‘æ¬¡ï¼Œä½†åˆå¿…é¡»å½»åº•é‡Šæ”¾ï¼Œå¯ä»¥<strong>å¾ªç¯è°ƒç”¨ release</strong> ç›´åˆ°è¿”å› true</li></ul></li></ul><p>TailContext é‡Šæ”¾æœªå¤„ç†æ¶ˆæ¯é€»è¾‘</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// io.netty.channel.DefaultChannelPipeline#onUnhandledInboundMessage(java.lang.Object)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>protected</span> <span class=kt>void</span> <span class=nf>onUnhandledInboundMessage</span><span class=o>(</span><span class=n>Object</span> <span class=n>msg</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;Discarded inbound message {} that reached at the tail of the pipeline. &#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;Please check your pipeline configuration.&#34;</span><span class=o>,</span> <span class=n>msg</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ReferenceCountUtil</span><span class=o>.</span><span class=na>release</span><span class=o>(</span><span class=n>msg</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å…·ä½“ä»£ç </p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// io.netty.util.ReferenceCountUtil#release(java.lang.Object)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>public</span> <span class=kd>static</span> <span class=kt>boolean</span> <span class=nf>release</span><span class=o>(</span><span class=n>Object</span> <span class=n>msg</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>msg</span> <span class=k>instanceof</span> <span class=n>ReferenceCounted</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=o>((</span><span class=n>ReferenceCounted</span><span class=o>)</span> <span class=n>msg</span><span class=o>).</span><span class=na>release</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ä¸æ˜¯ByteBufç±»å‹ä¹Ÿä¸ç”¨å¤„ç†
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#9slice><h4 id=9slice><span class=hanchor arialabel=Anchor># </span>9ï¼‰slice</h4></a><p><strong>é›¶æ‹·è´</strong>çš„ä½“ç°ä¹‹ä¸€ï¼Œå¯¹åŸå§‹ ByteBuf è¿›è¡Œåˆ‡ç‰‡æˆå¤šä¸ª ByteBufï¼Œåˆ‡ç‰‡åçš„ ByteBuf å¹¶<strong>æ²¡æœ‰</strong>å‘ç”Ÿå†…å­˜å¤åˆ¶ï¼Œè¿˜æ˜¯ä½¿ç”¨åŸå§‹ ByteBuf çš„å†…å­˜ï¼Œåˆ‡ç‰‡åçš„ ByteBuf ç»´æŠ¤ç‹¬ç«‹çš„ readï¼Œwrite æŒ‡é’ˆ</p><p><img src=/z-oblib/z2-attachments/ae0b62ba4b5935c66674cb603da6bbc4.png width=auto></p><p>ä¾‹ï¼ŒåŸå§‹ ByteBuf è¿›è¡Œä¸€äº›åˆå§‹æ“ä½œ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>ByteBuf</span> <span class=n>origin</span> <span class=o>=</span> <span class=n>ByteBufAllocator</span><span class=o>.</span><span class=na>DEFAULT</span><span class=o>.</span><span class=na>buffer</span><span class=o>(</span><span class=n>10</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>origin</span><span class=o>.</span><span class=na>writeBytes</span><span class=o>(</span><span class=k>new</span> <span class=kt>byte</span><span class=o>[]{</span><span class=n>1</span><span class=o>,</span> <span class=n>2</span><span class=o>,</span> <span class=n>3</span><span class=o>,</span> <span class=n>4</span><span class=o>});</span>
</span></span><span class=line><span class=cl><span class=n>origin</span><span class=o>.</span><span class=na>readByte</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>ByteBufUtil</span><span class=o>.</span><span class=na>prettyHexDump</span><span class=o>(</span><span class=n>origin</span><span class=o>));</span>
</span></span></code></pre></td></tr></table></div></div><p>è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 02 03 04                                        |...             |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span></code></pre></td></tr></table></div></div><p>è¿™æ—¶è°ƒç”¨ slice è¿›è¡Œåˆ‡ç‰‡ï¼Œæ— å‚ slice æ˜¯ä»åŸå§‹ ByteBuf çš„ read index åˆ° write index ä¹‹é—´çš„å†…å®¹è¿›è¡Œåˆ‡ç‰‡ï¼Œåˆ‡ç‰‡åçš„ max capacity è¢«å›ºå®šä¸ºè¿™ä¸ªåŒºé—´çš„å¤§å°ï¼Œå› æ­¤<strong>ä¸èƒ½</strong>è¿½åŠ  write</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>ByteBuf</span> <span class=n>slice</span> <span class=o>=</span> <span class=n>origin</span><span class=o>.</span><span class=na>slice</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>ByteBufUtil</span><span class=o>.</span><span class=na>prettyHexDump</span><span class=o>(</span><span class=n>slice</span><span class=o>));</span>
</span></span><span class=line><span class=cl><span class=c1>// slice.writeByte(5); å¦‚æœæ‰§è¡Œï¼Œä¼šæŠ¥ IndexOutOfBoundsException å¼‚å¸¸
</span></span></span></code></pre></td></tr></table></div></div><p>è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 02 03 04                                        |...             |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span></code></pre></td></tr></table></div></div><p>å¦‚æœåŸå§‹ ByteBuf å†æ¬¡è¯»æ“ä½œï¼ˆåˆè¯»äº†ä¸€ä¸ªå­—èŠ‚ï¼‰</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>origin</span><span class=o>.</span><span class=na>readByte</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>ByteBufUtil</span><span class=o>.</span><span class=na>prettyHexDump</span><span class=o>(</span><span class=n>origin</span><span class=o>));</span>
</span></span></code></pre></td></tr></table></div></div><p>è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 03 04                                           |..              |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span></code></pre></td></tr></table></div></div><p>è¿™æ—¶çš„ slice ä¸å—å½±å“ï¼Œå› ä¸ºå®ƒæœ‰ç‹¬ç«‹çš„è¯»å†™æŒ‡é’ˆ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>ByteBufUtil</span><span class=o>.</span><span class=na>prettyHexDump</span><span class=o>(</span><span class=n>slice</span><span class=o>));</span>
</span></span></code></pre></td></tr></table></div></div><p>è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 02 03 04                                        |...             |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span></code></pre></td></tr></table></div></div><p>å¦‚æœ slice çš„å†…å®¹å‘ç”Ÿäº†æ›´æ”¹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>slice</span><span class=o>.</span><span class=na>setByte</span><span class=o>(</span><span class=n>2</span><span class=o>,</span> <span class=n>5</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>ByteBufUtil</span><span class=o>.</span><span class=na>prettyHexDump</span><span class=o>(</span><span class=n>slice</span><span class=o>));</span>
</span></span></code></pre></td></tr></table></div></div><p>è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 02 03 05                                        |...             |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span></code></pre></td></tr></table></div></div><p>è¿™æ—¶ï¼ŒåŸå§‹ ByteBuf ä¹Ÿä¼šå—å½±å“ï¼Œå› ä¸ºåº•å±‚éƒ½æ˜¯åŒä¸€å—å†…å­˜</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>System.out.println(ByteBufUtil.prettyHexDump(origin));
</span></span></code></pre></td></tr></table></div></div><p>è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 03 05                                           |..              |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span></code></pre></td></tr></table></div></div><a href=#10duplicate><h4 id=10duplicate><span class=hanchor arialabel=Anchor># </span>10ï¼‰duplicate</h4></a><p>ã€é›¶æ‹·è´ã€‘çš„ä½“ç°ä¹‹ä¸€ï¼Œå°±å¥½æ¯”æˆªå–äº†åŸå§‹ ByteBuf æ‰€æœ‰å†…å®¹ï¼Œå¹¶ä¸”æ²¡æœ‰ max capacity çš„é™åˆ¶ï¼Œä¹Ÿæ˜¯ä¸åŸå§‹ ByteBuf ä½¿ç”¨åŒä¸€å—åº•å±‚å†…å­˜ï¼Œåªæ˜¯<strong>è¯»å†™æŒ‡é’ˆ</strong>æ˜¯ç‹¬ç«‹çš„</p><p><img src=/z-oblib/z2-attachments/dc2294119a7fdc68f77855060844c978.png width=auto></p><a href=#11copy><h4 id=11copy><span class=hanchor arialabel=Anchor># </span>11ï¼‰copy</h4></a><p>ä¼šå°†åº•å±‚å†…å­˜æ•°æ®è¿›è¡Œ<strong>æ·±æ‹·è´</strong>ï¼Œå› æ­¤æ— è®ºè¯»å†™ï¼Œéƒ½ä¸åŸå§‹ ByteBuf æ— å…³</p><a href=#12compositebytebuf><h4 id=12compositebytebuf><span class=hanchor arialabel=Anchor># </span>12ï¼‰CompositeByteBuf</h4></a><p>ã€é›¶æ‹·è´ã€‘çš„ä½“ç°ä¹‹ä¸€ï¼Œå¯ä»¥å°†å¤šä¸ª ByteBuf <strong>åˆå¹¶</strong>ä¸ºä¸€ä¸ªé€»è¾‘ä¸Šçš„ ByteBufï¼Œé¿å…æ‹·è´</p><p>æœ‰ä¸¤ä¸ª ByteBuf å¦‚ä¸‹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>ByteBuf</span> <span class=n>buf1</span> <span class=o>=</span> <span class=n>ByteBufAllocator</span><span class=o>.</span><span class=na>DEFAULT</span><span class=o>.</span><span class=na>buffer</span><span class=o>(</span><span class=n>5</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>buf1</span><span class=o>.</span><span class=na>writeBytes</span><span class=o>(</span><span class=k>new</span> <span class=kt>byte</span><span class=o>[]{</span><span class=n>1</span><span class=o>,</span> <span class=n>2</span><span class=o>,</span> <span class=n>3</span><span class=o>,</span> <span class=n>4</span><span class=o>,</span> <span class=n>5</span><span class=o>});</span>
</span></span><span class=line><span class=cl><span class=n>ByteBuf</span> <span class=n>buf2</span> <span class=o>=</span> <span class=n>ByteBufAllocator</span><span class=o>.</span><span class=na>DEFAULT</span><span class=o>.</span><span class=na>buffer</span><span class=o>(</span><span class=n>5</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>buf2</span><span class=o>.</span><span class=na>writeBytes</span><span class=o>(</span><span class=k>new</span> <span class=kt>byte</span><span class=o>[]{</span><span class=n>6</span><span class=o>,</span> <span class=n>7</span><span class=o>,</span> <span class=n>8</span><span class=o>,</span> <span class=n>9</span><span class=o>,</span> <span class=n>10</span><span class=o>});</span>
</span></span><span class=line><span class=cl><span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>ByteBufUtil</span><span class=o>.</span><span class=na>prettyHexDump</span><span class=o>(</span><span class=n>buf1</span><span class=o>));</span>
</span></span><span class=line><span class=cl><span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>ByteBufUtil</span><span class=o>.</span><span class=na>prettyHexDump</span><span class=o>(</span><span class=n>buf2</span><span class=o>));</span>
</span></span></code></pre></td></tr></table></div></div><p>è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 01 02 03 04 05                                  |.....           |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 06 07 08 09 0a                                  |.....           |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span></code></pre></td></tr></table></div></div><p>ç°åœ¨éœ€è¦ä¸€ä¸ªæ–°çš„ ByteBufï¼Œå†…å®¹æ¥è‡ªäºåˆšæ‰çš„ buf1 å’Œ buf2ï¼Œå¦‚ä½•å®ç°ï¼Ÿ</p><p>æ–¹æ³•1ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>ByteBuf</span> <span class=n>buf3</span> <span class=o>=</span> <span class=n>ByteBufAllocator</span><span class=o>.</span><span class=na>DEFAULT</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>buffer</span><span class=o>(</span><span class=n>buf1</span><span class=o>.</span><span class=na>readableBytes</span><span class=o>()+</span><span class=n>buf2</span><span class=o>.</span><span class=na>readableBytes</span><span class=o>());</span>
</span></span><span class=line><span class=cl><span class=n>buf3</span><span class=o>.</span><span class=na>writeBytes</span><span class=o>(</span><span class=n>buf1</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>buf3</span><span class=o>.</span><span class=na>writeBytes</span><span class=o>(</span><span class=n>buf2</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>ByteBufUtil</span><span class=o>.</span><span class=na>prettyHexDump</span><span class=o>(</span><span class=n>buf3</span><span class=o>));</span>
</span></span></code></pre></td></tr></table></div></div><p>ç»“æœ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 01 02 03 04 05 06 07 08 09 0a                   |..........      |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span></code></pre></td></tr></table></div></div><p>è¿™ç§æ–¹æ³•å¥½ä¸å¥½ï¼Ÿå›ç­”æ˜¯ä¸å¤ªå¥½ï¼Œå› ä¸ºè¿›è¡Œäº†æ•°æ®çš„å†…å­˜å¤åˆ¶æ“ä½œ</p><p>æ–¹æ³•2ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>CompositeByteBuf</span> <span class=n>buf3</span> <span class=o>=</span> <span class=n>ByteBufAllocator</span><span class=o>.</span><span class=na>DEFAULT</span><span class=o>.</span><span class=na>compositeBuffer</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=c1>// true è¡¨ç¤ºå¢åŠ æ–°çš„ ByteBuf è‡ªåŠ¨é€’å¢ write index, å¦åˆ™ write index ä¼šå§‹ç»ˆä¸º 0
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>buf3</span><span class=o>.</span><span class=na>addComponents</span><span class=o>(</span><span class=kc>true</span><span class=o>,</span> <span class=n>buf1</span><span class=o>,</span> <span class=n>buf2</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><p>ç»“æœæ˜¯ä¸€æ ·çš„</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 01 02 03 04 05 06 07 08 09 0a                   |..........      |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span></code></pre></td></tr></table></div></div><p>CompositeByteBuf æ˜¯ä¸€ä¸ªç»„åˆçš„ ByteBufï¼Œå®ƒå†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ª Component <strong>æ•°ç»„</strong>ï¼Œæ¯ä¸ª Component ç®¡ç†ä¸€ä¸ª ByteBufï¼Œè®°å½•äº†è¿™ä¸ª ByteBuf ç›¸å¯¹äºæ•´ä½“<strong>åç§»é‡</strong>ç­‰ä¿¡æ¯ï¼Œä»£è¡¨ç€æ•´ä½“ä¸­æŸä¸€æ®µçš„æ•°æ®ã€‚</p><ul><li>ä¼˜ç‚¹ï¼Œå¯¹å¤–æ˜¯ä¸€ä¸ªè™šæ‹Ÿè§†å›¾ï¼Œç»„åˆè¿™äº› ByteBuf ä¸ä¼šäº§ç”Ÿå†…å­˜å¤åˆ¶</li><li>ç¼ºç‚¹ï¼Œå¤æ‚äº†å¾ˆå¤šï¼Œå¤šæ¬¡æ“ä½œä¼šå¸¦æ¥æ€§èƒ½çš„æŸè€—</li></ul><a href=#13unpooled><h4 id=13unpooled><span class=hanchor arialabel=Anchor># </span>13ï¼‰Unpooled</h4></a><p>Unpooled æ˜¯ä¸€ä¸ªå·¥å…·ç±»ï¼Œç±»å¦‚å…¶åï¼Œæä¾›äº†<strong>éæ± åŒ–</strong>çš„ ByteBuf åˆ›å»ºã€ç»„åˆã€å¤åˆ¶ç­‰æ“ä½œ</p><p>è¿™é‡Œä»…ä»‹ç»å…¶è·Ÿã€é›¶æ‹·è´ã€‘ç›¸å…³çš„ wrappedBuffer æ–¹æ³•ï¼Œå¯ä»¥ç”¨æ¥åŒ…è£… ByteBuf</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>ByteBuf</span> <span class=n>buf1</span> <span class=o>=</span> <span class=n>ByteBufAllocator</span><span class=o>.</span><span class=na>DEFAULT</span><span class=o>.</span><span class=na>buffer</span><span class=o>(</span><span class=n>5</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>buf1</span><span class=o>.</span><span class=na>writeBytes</span><span class=o>(</span><span class=k>new</span> <span class=kt>byte</span><span class=o>[]{</span><span class=n>1</span><span class=o>,</span> <span class=n>2</span><span class=o>,</span> <span class=n>3</span><span class=o>,</span> <span class=n>4</span><span class=o>,</span> <span class=n>5</span><span class=o>});</span>
</span></span><span class=line><span class=cl><span class=n>ByteBuf</span> <span class=n>buf2</span> <span class=o>=</span> <span class=n>ByteBufAllocator</span><span class=o>.</span><span class=na>DEFAULT</span><span class=o>.</span><span class=na>buffer</span><span class=o>(</span><span class=n>5</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>buf2</span><span class=o>.</span><span class=na>writeBytes</span><span class=o>(</span><span class=k>new</span> <span class=kt>byte</span><span class=o>[]{</span><span class=n>6</span><span class=o>,</span> <span class=n>7</span><span class=o>,</span> <span class=n>8</span><span class=o>,</span> <span class=n>9</span><span class=o>,</span> <span class=n>10</span><span class=o>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// å½“åŒ…è£… ByteBuf ä¸ªæ•°è¶…è¿‡ä¸€ä¸ªæ—¶, åº•å±‚ä½¿ç”¨äº† CompositeByteBuf
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>ByteBuf</span> <span class=n>buf3</span> <span class=o>=</span> <span class=n>Unpooled</span><span class=o>.</span><span class=na>wrappedBuffer</span><span class=o>(</span><span class=n>buf1</span><span class=o>,</span> <span class=n>buf2</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>ByteBufUtil</span><span class=o>.</span><span class=na>prettyHexDump</span><span class=o>(</span><span class=n>buf3</span><span class=o>));</span>
</span></span></code></pre></td></tr></table></div></div><p>è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 01 02 03 04 05 06 07 08 09 0a                   |..........      |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span></code></pre></td></tr></table></div></div><p>ä¹Ÿå¯ä»¥ç”¨æ¥åŒ…è£…æ™®é€šå­—èŠ‚æ•°ç»„ï¼Œåº•å±‚ä¹Ÿä¸ä¼šæœ‰æ‹·è´æ“ä½œ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>ByteBuf</span> <span class=n>buf4</span> <span class=o>=</span> <span class=n>Unpooled</span><span class=o>.</span><span class=na>wrappedBuffer</span><span class=o>(</span><span class=k>new</span> <span class=kt>byte</span><span class=o>[]{</span><span class=n>1</span><span class=o>,</span> <span class=n>2</span><span class=o>,</span> <span class=n>3</span><span class=o>},</span> <span class=k>new</span> <span class=kt>byte</span><span class=o>[]{</span><span class=n>4</span><span class=o>,</span> <span class=n>5</span><span class=o>,</span> <span class=n>6</span><span class=o>});</span>
</span></span><span class=line><span class=cl><span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>buf4</span><span class=o>.</span><span class=na>getClass</span><span class=o>());</span>
</span></span><span class=line><span class=cl><span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>ByteBufUtil</span><span class=o>.</span><span class=na>prettyHexDump</span><span class=o>(</span><span class=n>buf4</span><span class=o>));</span>
</span></span></code></pre></td></tr></table></div></div><p>è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>class io.netty.buffer.CompositeByteBuf
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 01 02 03 04 05 06                               |......          |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span></code></pre></td></tr></table></div></div><a href=#-bytebuf-ä¼˜åŠ¿><h4 id=-bytebuf-ä¼˜åŠ¿><span class=hanchor arialabel=Anchor># </span>ğŸ’¡ ByteBuf ä¼˜åŠ¿</h4></a><ul><li><strong>æ± åŒ–</strong> - å¯ä»¥é‡ç”¨æ± ä¸­ ByteBuf å®ä¾‹ï¼Œæ›´èŠ‚çº¦å†…å­˜ï¼Œå‡å°‘å†…å­˜æº¢å‡ºçš„å¯èƒ½</li><li><strong>è¯»å†™æŒ‡é’ˆåˆ†ç¦»</strong>ï¼Œä¸éœ€è¦åƒ ByteBuffer ä¸€æ ·åˆ‡æ¢è¯»å†™æ¨¡å¼</li><li>å¯ä»¥<strong>è‡ªåŠ¨æ‰©å®¹</strong></li><li>æ”¯æŒ<strong>é“¾å¼è°ƒç”¨</strong>ï¼Œä½¿ç”¨æ›´æµç•…</li><li>å¾ˆå¤šåœ°æ–¹ä½“ç°<strong>é›¶æ‹·è´</strong>ï¼Œä¾‹å¦‚ sliceã€duplicateã€CompositeByteBuf</li></ul><a href=#4-åŒå‘é€šä¿¡><h2 id=4-åŒå‘é€šä¿¡><span class=hanchor arialabel=Anchor># </span>4. åŒå‘é€šä¿¡</h2></a><a href=#41-ç»ƒä¹ ><h3 id=41-ç»ƒä¹ ><span class=hanchor arialabel=Anchor># </span>4.1 ç»ƒä¹ </h3></a><p>å®ç°ä¸€ä¸ª echo server</p><p>ç¼–å†™ server</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>new</span> <span class=n>ServerBootstrap</span><span class=o>()</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>group</span><span class=o>(</span><span class=k>new</span> <span class=n>NioEventLoopGroup</span><span class=o>())</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>channel</span><span class=o>(</span><span class=n>NioServerSocketChannel</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>childHandler</span><span class=o>(</span><span class=k>new</span> <span class=n>ChannelInitializer</span><span class=o>&lt;</span><span class=n>NioSocketChannel</span><span class=o>&gt;()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>initChannel</span><span class=o>(</span><span class=n>NioSocketChannel</span> <span class=n>ch</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>ChannelInboundHandlerAdapter</span><span class=o>(){</span>
</span></span><span class=line><span class=cl>                <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>                <span class=kd>public</span> <span class=kt>void</span> <span class=nf>channelRead</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>,</span> <span class=n>Object</span> <span class=n>msg</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>ByteBuf</span> <span class=n>buffer</span> <span class=o>=</span> <span class=o>(</span><span class=n>ByteBuf</span><span class=o>)</span> <span class=n>msg</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>buffer</span><span class=o>.</span><span class=na>toString</span><span class=o>(</span><span class=n>Charset</span><span class=o>.</span><span class=na>defaultCharset</span><span class=o>()));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                    <span class=c1>// å»ºè®®ä½¿ç”¨ ctx.alloc() åˆ›å»º ByteBuf
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=n>ByteBuf</span> <span class=n>response</span> <span class=o>=</span> <span class=n>ctx</span><span class=o>.</span><span class=na>alloc</span><span class=o>().</span><span class=na>buffer</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                    <span class=n>response</span><span class=o>.</span><span class=na>writeBytes</span><span class=o>(</span><span class=n>buffer</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>ctx</span><span class=o>.</span><span class=na>writeAndFlush</span><span class=o>(</span><span class=n>response</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                    <span class=c1>// æ€è€ƒï¼šéœ€è¦é‡Šæ”¾ buffer å—
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=c1>// æ€è€ƒï¼šéœ€è¦é‡Šæ”¾ response å—
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>});</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}).</span><span class=na>bind</span><span class=o>(</span><span class=n>8080</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><p>ç¼–å†™ client</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>NioEventLoopGroup</span> <span class=n>group</span> <span class=o>=</span> <span class=k>new</span> <span class=n>NioEventLoopGroup</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=n>Channel</span> <span class=n>channel</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Bootstrap</span><span class=o>()</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>group</span><span class=o>(</span><span class=n>group</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>channel</span><span class=o>(</span><span class=n>NioSocketChannel</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>handler</span><span class=o>(</span><span class=k>new</span> <span class=n>ChannelInitializer</span><span class=o>&lt;</span><span class=n>NioSocketChannel</span><span class=o>&gt;()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>initChannel</span><span class=o>(</span><span class=n>NioSocketChannel</span> <span class=n>ch</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>StringEncoder</span><span class=o>());</span>
</span></span><span class=line><span class=cl>            <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>ChannelInboundHandlerAdapter</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>                <span class=kd>public</span> <span class=kt>void</span> <span class=nf>channelRead</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>,</span> <span class=n>Object</span> <span class=n>msg</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>ByteBuf</span> <span class=n>buffer</span> <span class=o>=</span> <span class=o>(</span><span class=n>ByteBuf</span><span class=o>)</span> <span class=n>msg</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>buffer</span><span class=o>.</span><span class=na>toString</span><span class=o>(</span><span class=n>Charset</span><span class=o>.</span><span class=na>defaultCharset</span><span class=o>()));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                    <span class=c1>// æ€è€ƒï¼šéœ€è¦é‡Šæ”¾ buffer å—
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>});</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}).</span><span class=na>connect</span><span class=o>(</span><span class=s>&#34;127.0.0.1&#34;</span><span class=o>,</span> <span class=n>8080</span><span class=o>).</span><span class=na>sync</span><span class=o>().</span><span class=na>channel</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>channel</span><span class=o>.</span><span class=na>closeFuture</span><span class=o>().</span><span class=na>addListener</span><span class=o>(</span><span class=n>future</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>group</span><span class=o>.</span><span class=na>shutdownGracefully</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>new</span> <span class=n>Thread</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Scanner</span> <span class=n>scanner</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Scanner</span><span class=o>(</span><span class=n>System</span><span class=o>.</span><span class=na>in</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=o>(</span><span class=kc>true</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>String</span> <span class=n>line</span> <span class=o>=</span> <span class=n>scanner</span><span class=o>.</span><span class=na>nextLine</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=s>&#34;q&#34;</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>line</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>channel</span><span class=o>.</span><span class=na>close</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=n>channel</span><span class=o>.</span><span class=na>writeAndFlush</span><span class=o>(</span><span class=n>line</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}).</span><span class=na>start</span><span class=o>();</span>
</span></span></code></pre></td></tr></table></div></div><a href=#-è¯»å’Œå†™çš„è¯¯è§£><h3 id=-è¯»å’Œå†™çš„è¯¯è§£><span class=hanchor arialabel=Anchor># </span>ğŸ’¡ è¯»å’Œå†™çš„è¯¯è§£</h3></a><p>æˆ‘æœ€åˆåœ¨è®¤è¯†ä¸Šæœ‰è¿™æ ·çš„è¯¯åŒºï¼Œè®¤ä¸ºåªæœ‰åœ¨ nettyï¼Œnio è¿™æ ·çš„å¤šè·¯å¤ç”¨ IO æ¨¡å‹æ—¶ï¼Œè¯»å†™æ‰ä¸ä¼šç›¸äº’é˜»å¡ï¼Œæ‰å¯ä»¥å®ç°é«˜æ•ˆçš„åŒå‘é€šä¿¡ï¼Œä½†å®é™…ä¸Šï¼ŒJava Socket æ˜¯å…¨åŒå·¥çš„ï¼šåœ¨ä»»æ„æ—¶åˆ»ï¼Œçº¿è·¯ä¸Šå­˜åœ¨<code>A åˆ° B</code> å’Œ <code>B åˆ° A</code> çš„åŒå‘ä¿¡å·ä¼ è¾“ã€‚å³ä½¿æ˜¯é˜»å¡ IOï¼Œè¯»å’Œå†™æ˜¯å¯ä»¥åŒæ—¶è¿›è¡Œçš„ï¼Œåªè¦åˆ†åˆ«é‡‡ç”¨è¯»çº¿ç¨‹å’Œå†™çº¿ç¨‹å³å¯ï¼Œè¯»ä¸ä¼šé˜»å¡å†™ã€å†™ä¹Ÿä¸ä¼šé˜»å¡è¯»</p><p>ä¾‹å¦‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>TestServer</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ServerSocket</span> <span class=n>ss</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ServerSocket</span><span class=o>(</span><span class=n>8888</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>Socket</span> <span class=n>s</span> <span class=o>=</span> <span class=n>ss</span><span class=o>.</span><span class=na>accept</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=n>Thread</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>BufferedReader</span> <span class=n>reader</span> <span class=o>=</span> <span class=k>new</span> <span class=n>BufferedReader</span><span class=o>(</span><span class=k>new</span> <span class=n>InputStreamReader</span><span class=o>(</span><span class=n>s</span><span class=o>.</span><span class=na>getInputStream</span><span class=o>()));</span>
</span></span><span class=line><span class=cl>                <span class=k>while</span> <span class=o>(</span><span class=kc>true</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>reader</span><span class=o>.</span><span class=na>readLine</span><span class=o>());</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}).</span><span class=na>start</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=n>Thread</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>BufferedWriter</span> <span class=n>writer</span> <span class=o>=</span> <span class=k>new</span> <span class=n>BufferedWriter</span><span class=o>(</span><span class=k>new</span> <span class=n>OutputStreamWriter</span><span class=o>(</span><span class=n>s</span><span class=o>.</span><span class=na>getOutputStream</span><span class=o>()));</span>
</span></span><span class=line><span class=cl>                <span class=c1>// ä¾‹å¦‚åœ¨è¿™ä¸ªä½ç½®åŠ å…¥ thread çº§åˆ«æ–­ç‚¹ï¼Œå¯ä»¥å‘ç°å³ä½¿ä¸å†™å…¥æ•°æ®ï¼Œä¹Ÿä¸å¦¨ç¢å‰é¢çº¿ç¨‹è¯»å–å®¢æˆ·ç«¯æ•°æ®
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>100</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>writer</span><span class=o>.</span><span class=na>write</span><span class=o>(</span><span class=n>String</span><span class=o>.</span><span class=na>valueOf</span><span class=o>(</span><span class=n>i</span><span class=o>));</span>
</span></span><span class=line><span class=cl>                    <span class=n>writer</span><span class=o>.</span><span class=na>newLine</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                    <span class=n>writer</span><span class=o>.</span><span class=na>flush</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}).</span><span class=na>start</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å®¢æˆ·ç«¯</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>TestClient</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Socket</span> <span class=n>s</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Socket</span><span class=o>(</span><span class=s>&#34;localhost&#34;</span><span class=o>,</span> <span class=n>8888</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=n>Thread</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>BufferedReader</span> <span class=n>reader</span> <span class=o>=</span> <span class=k>new</span> <span class=n>BufferedReader</span><span class=o>(</span><span class=k>new</span> <span class=n>InputStreamReader</span><span class=o>(</span><span class=n>s</span><span class=o>.</span><span class=na>getInputStream</span><span class=o>()));</span>
</span></span><span class=line><span class=cl>                <span class=k>while</span> <span class=o>(</span><span class=kc>true</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>reader</span><span class=o>.</span><span class=na>readLine</span><span class=o>());</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}).</span><span class=na>start</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=n>Thread</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>BufferedWriter</span> <span class=n>writer</span> <span class=o>=</span> <span class=k>new</span> <span class=n>BufferedWriter</span><span class=o>(</span><span class=k>new</span> <span class=n>OutputStreamWriter</span><span class=o>(</span><span class=n>s</span><span class=o>.</span><span class=na>getOutputStream</span><span class=o>()));</span>
</span></span><span class=line><span class=cl>                <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>100</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>writer</span><span class=o>.</span><span class=na>write</span><span class=o>(</span><span class=n>String</span><span class=o>.</span><span class=na>valueOf</span><span class=o>(</span><span class=n>i</span><span class=o>));</span>
</span></span><span class=line><span class=cl>                    <span class=n>writer</span><span class=o>.</span><span class=na>newLine</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                    <span class=n>writer</span><span class=o>.</span><span class=na>flush</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}).</span><span class=na>start</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div></article><hr><div class=page-end id=footer><div class=backlinks-container><h3>Backlinks</h3><ul class=backlinks><li>No backlinks found</li></ul></div><div><script src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>Interactive Graph</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://harbor.mffseal.top/js/graph.abd4bc2af3869a96524d7d23b76152c7.js></script></div></div><div id=contact_buttons><footer><p>Made by mffseal using <a href=https://github.com/jackyzha0/quartz>Quartz</a>, Â© 2022</p><ul><li><a href=https://harbor.mffseal.top/>Home</a></li><li><a href=https://github.com/mffseal>Github</a></li></ul></footer></div></div></body></html>