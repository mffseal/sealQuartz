<!doctype html><html lang=en><head><meta charset=utf-8><meta name=description content="Nettyè¿›é˜¶ 1. ç²˜åŒ…ä¸åŠåŒ… 1.1 ç²˜åŒ…ç°è±¡ æœåŠ¡ç«¯ä»£ç 
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46  public class HelloWorldServer { static final Logger log = LoggerFactory.getLogger(HelloWorldServer.class); void start() { NioEventLoopGroup boss = new NioEventLoopGroup(1); NioEventLoopGroup worker = new NioEventLoopGroup(); try { ServerBootstrap serverBootstrap = new ServerBootstrap(); serverBootstrap."><title>Nettyè¿›é˜¶</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://harbor.mffseal.top//icon.png><link href=https://harbor.mffseal.top/styles.7153093e4d1bbb584a28469cadfa3f88.min.css rel=stylesheet><link href=https://harbor.mffseal.top/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://harbor.mffseal.top/js/darkmode.9841b88d44c115f7419d485ee72d23a2.min.js></script>
<script src=https://harbor.mffseal.top/js/util.9825137f5e7825e8553c68ce39ac9e44.min.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js integrity=sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A crossorigin=anonymous></script>
<script src=https://unpkg.com/@floating-ui/core@0.7.3></script>
<script src=https://unpkg.com/@floating-ui/dom@0.5.4></script>
<script src=https://harbor.mffseal.top/js/popover.53ad9a087e3feeaaa12b63bfd02d923b.min.js></script>
<script src=https://harbor.mffseal.top/js/code-title.b35124ad8db0ba37162b886afb711cbc.min.js></script>
<script src=https://harbor.mffseal.top/js/clipboard.c20857734e53a3fb733b7443879efa61.min.js></script>
<script src=https://harbor.mffseal.top/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const BASE_URL="https://harbor.mffseal.top/",fetchData=Promise.all([fetch("https://harbor.mffseal.top/indices/linkIndex.50149d4f06f7f6d699f2eab42c3848b3.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://harbor.mffseal.top/indices/contentIndex.2f776d63de615717fa30f0bbaae8b3d2.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addTitleToCodeBlocks(),addCollapsibleCallouts(),initPopover("https://harbor.mffseal.top",!0,!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!1;drawGraph("https://harbor.mffseal.top",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],macros:{'â€™':"'"},throwOnError:!1})}</script><script type=module>
    import { attachSPARouting } from "https:\/\/harbor.mffseal.top\/js\/router.9d4974281069e9ebb189f642ae1e3ca2.min.js"
    attachSPARouting(init, render)
  </script></head><script async src="https://www.googletagmanager.com/gtag/js?id=G-NV58SYWRZD"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-NV58SYWRZD",{anonymize_ip:!1})}</script><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://harbor.mffseal.top/js/full-text-search.24827f874defbbc6d529926cbfcfb493.min.js></script><div class=singlePage><header><h1 id=page-title><a href=https://harbor.mffseal.top/>ğŸ¦­ æ¸¯æ¹¾</a></h1><div class=spacer></div><div id=search-icon><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><h1>Nettyè¿›é˜¶</h1><p class=meta>Last updated
Jun 23, 2022
<a href=https://github.com/mffseal/2_0_2-%e8%ae%a1%e7%ae%97%e6%9c%ba%e7%a7%91%e5%ad%a6/2_0_2_2_1_0-web%e5%90%8e%e7%ab%af/Netty/Netty%e8%bf%9b%e9%98%b6.md rel=noopener>Edit Source</a></p><ul class=tags></ul><aside class=mainTOC><details><summary>Table of Contents</summary><nav id=TableOfContents><ol><li><a href=#1-ç²˜åŒ…ä¸åŠåŒ…>1. ç²˜åŒ…ä¸åŠåŒ…</a><ol><li><a href=#11-ç²˜åŒ…ç°è±¡>1.1 ç²˜åŒ…ç°è±¡</a></li><li><a href=#12-åŠåŒ…ç°è±¡>1.2 åŠåŒ…ç°è±¡</a></li><li><a href=#13-ç°è±¡åˆ†æ>ğŸ’¡1.3 ç°è±¡åˆ†æ</a></li><li><a href=#14-è§£å†³æ–¹æ¡ˆ>1.4 ğŸ’¡è§£å†³æ–¹æ¡ˆ</a></li></ol></li><li><a href=#2-åè®®è®¾è®¡ä¸è§£æ>2. åè®®è®¾è®¡ä¸è§£æ</a><ol><li><a href=#21-ä¸ºä»€ä¹ˆéœ€è¦åè®®>2.1 ä¸ºä»€ä¹ˆéœ€è¦åè®®ï¼Ÿ</a></li><li><a href=#22-redis-åè®®ä¸¾ä¾‹>2.2 redis åè®®ä¸¾ä¾‹</a></li><li><a href=#23-http-åè®®ä¸¾ä¾‹>2.3 http åè®®ä¸¾ä¾‹</a></li><li><a href=#24-è‡ªå®šä¹‰åè®®è¦ç´ >2.4 è‡ªå®šä¹‰åè®®è¦ç´ </a></li></ol></li><li><a href=#3-èŠå¤©å®¤æ¡ˆä¾‹>3. èŠå¤©å®¤æ¡ˆä¾‹</a><ol><li><a href=#31-èŠå¤©å®¤ä¸šåŠ¡ä»‹ç»>3.1 èŠå¤©å®¤ä¸šåŠ¡ä»‹ç»</a></li><li><a href=#32-èŠå¤©å®¤ä¸šåŠ¡-ç™»å½•>3.2 èŠå¤©å®¤ä¸šåŠ¡-ç™»å½•</a></li><li><a href=#33-èŠå¤©å®¤ä¸šåŠ¡-å•èŠ>3.3 èŠå¤©å®¤ä¸šåŠ¡-å•èŠ</a></li><li><a href=#34-èŠå¤©å®¤ä¸šåŠ¡-ç¾¤èŠ>3.4 èŠå¤©å®¤ä¸šåŠ¡-ç¾¤èŠ</a></li><li><a href=#35-èŠå¤©å®¤ä¸šåŠ¡-é€€å‡º>3.5 èŠå¤©å®¤ä¸šåŠ¡-é€€å‡º</a></li><li><a href=#36-èŠå¤©å®¤ä¸šåŠ¡-ç©ºé—²æ£€æµ‹>3.6 èŠå¤©å®¤ä¸šåŠ¡-ç©ºé—²æ£€æµ‹</a></li></ol></li></ol></nav></details></aside><a href=#nettyè¿›é˜¶><h1 id=nettyè¿›é˜¶><span class=hanchor arialabel=Anchor># </span>Nettyè¿›é˜¶</h1></a><a href=#1-ç²˜åŒ…ä¸åŠåŒ…><h2 id=1-ç²˜åŒ…ä¸åŠåŒ…><span class=hanchor arialabel=Anchor># </span>1. ç²˜åŒ…ä¸åŠåŒ…</h2></a><a href=#11-ç²˜åŒ…ç°è±¡><h3 id=11-ç²˜åŒ…ç°è±¡><span class=hanchor arialabel=Anchor># </span>1.1 ç²˜åŒ…ç°è±¡</h3></a><p>æœåŠ¡ç«¯ä»£ç </p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>HelloWorldServer</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>static</span> <span class=kd>final</span> <span class=n>Logger</span> <span class=n>log</span> <span class=o>=</span> <span class=n>LoggerFactory</span><span class=o>.</span><span class=na>getLogger</span><span class=o>(</span><span class=n>HelloWorldServer</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=nf>start</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>NioEventLoopGroup</span> <span class=n>boss</span> <span class=o>=</span> <span class=k>new</span> <span class=n>NioEventLoopGroup</span><span class=o>(</span><span class=n>1</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>NioEventLoopGroup</span> <span class=n>worker</span> <span class=o>=</span> <span class=k>new</span> <span class=n>NioEventLoopGroup</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>ServerBootstrap</span> <span class=n>serverBootstrap</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ServerBootstrap</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>serverBootstrap</span><span class=o>.</span><span class=na>channel</span><span class=o>(</span><span class=n>NioServerSocketChannel</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>serverBootstrap</span><span class=o>.</span><span class=na>group</span><span class=o>(</span><span class=n>boss</span><span class=o>,</span> <span class=n>worker</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>serverBootstrap</span><span class=o>.</span><span class=na>childHandler</span><span class=o>(</span><span class=k>new</span> <span class=n>ChannelInitializer</span><span class=o>&lt;</span><span class=n>SocketChannel</span><span class=o>&gt;()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>                <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>initChannel</span><span class=o>(</span><span class=n>SocketChannel</span> <span class=n>ch</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>LoggingHandler</span><span class=o>(</span><span class=n>LogLevel</span><span class=o>.</span><span class=na>DEBUG</span><span class=o>));</span>
</span></span><span class=line><span class=cl>                    <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>ChannelInboundHandlerAdapter</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>                        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>channelActive</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                            <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;connected {}&#34;</span><span class=o>,</span> <span class=n>ctx</span><span class=o>.</span><span class=na>channel</span><span class=o>());</span>
</span></span><span class=line><span class=cl>                            <span class=kd>super</span><span class=o>.</span><span class=na>channelActive</span><span class=o>(</span><span class=n>ctx</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>                        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>channelInactive</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                            <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;disconnect {}&#34;</span><span class=o>,</span> <span class=n>ctx</span><span class=o>.</span><span class=na>channel</span><span class=o>());</span>
</span></span><span class=line><span class=cl>                            <span class=kd>super</span><span class=o>.</span><span class=na>channelInactive</span><span class=o>(</span><span class=n>ctx</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                        <span class=o>}</span>
</span></span><span class=line><span class=cl>                    <span class=o>});</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>});</span>
</span></span><span class=line><span class=cl>            <span class=n>ChannelFuture</span> <span class=n>channelFuture</span> <span class=o>=</span> <span class=n>serverBootstrap</span><span class=o>.</span><span class=na>bind</span><span class=o>(</span><span class=n>8080</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;{} binding...&#34;</span><span class=o>,</span> <span class=n>channelFuture</span><span class=o>.</span><span class=na>channel</span><span class=o>());</span>
</span></span><span class=line><span class=cl>            <span class=n>channelFuture</span><span class=o>.</span><span class=na>sync</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;{} bound...&#34;</span><span class=o>,</span> <span class=n>channelFuture</span><span class=o>.</span><span class=na>channel</span><span class=o>());</span>
</span></span><span class=line><span class=cl>            <span class=n>channelFuture</span><span class=o>.</span><span class=na>channel</span><span class=o>().</span><span class=na>closeFuture</span><span class=o>().</span><span class=na>sync</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=o>.</span><span class=na>error</span><span class=o>(</span><span class=s>&#34;server error&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>boss</span><span class=o>.</span><span class=na>shutdownGracefully</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>worker</span><span class=o>.</span><span class=na>shutdownGracefully</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;stoped&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=n>HelloWorldServer</span><span class=o>().</span><span class=na>start</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å®¢æˆ·ç«¯ä»£ç å¸Œæœ›å‘é€ 10 ä¸ªæ¶ˆæ¯ï¼Œæ¯ä¸ªæ¶ˆæ¯æ˜¯ 16 å­—èŠ‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>HelloWorldClient</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>static</span> <span class=kd>final</span> <span class=n>Logger</span> <span class=n>log</span> <span class=o>=</span> <span class=n>LoggerFactory</span><span class=o>.</span><span class=na>getLogger</span><span class=o>(</span><span class=n>HelloWorldClient</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>NioEventLoopGroup</span> <span class=n>worker</span> <span class=o>=</span> <span class=k>new</span> <span class=n>NioEventLoopGroup</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Bootstrap</span> <span class=n>bootstrap</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Bootstrap</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>bootstrap</span><span class=o>.</span><span class=na>channel</span><span class=o>(</span><span class=n>NioSocketChannel</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>bootstrap</span><span class=o>.</span><span class=na>group</span><span class=o>(</span><span class=n>worker</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>bootstrap</span><span class=o>.</span><span class=na>handler</span><span class=o>(</span><span class=k>new</span> <span class=n>ChannelInitializer</span><span class=o>&lt;</span><span class=n>SocketChannel</span><span class=o>&gt;()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>                <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>initChannel</span><span class=o>(</span><span class=n>SocketChannel</span> <span class=n>ch</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;connetted...&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>ChannelInboundHandlerAdapter</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>                        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>channelActive</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                            <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;sending...&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                            <span class=n>Random</span> <span class=n>r</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Random</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                            <span class=kt>char</span> <span class=n>c</span> <span class=o>=</span> <span class=sc>&#39;a&#39;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                            <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>10</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                                <span class=n>ByteBuf</span> <span class=n>buffer</span> <span class=o>=</span> <span class=n>ctx</span><span class=o>.</span><span class=na>alloc</span><span class=o>().</span><span class=na>buffer</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                                <span class=n>buffer</span><span class=o>.</span><span class=na>writeBytes</span><span class=o>(</span><span class=k>new</span> <span class=kt>byte</span><span class=o>[]{</span><span class=n>0</span><span class=o>,</span> <span class=n>1</span><span class=o>,</span> <span class=n>2</span><span class=o>,</span> <span class=n>3</span><span class=o>,</span> <span class=n>4</span><span class=o>,</span> <span class=n>5</span><span class=o>,</span> <span class=n>6</span><span class=o>,</span> <span class=n>7</span><span class=o>,</span> <span class=n>8</span><span class=o>,</span> <span class=n>9</span><span class=o>,</span> <span class=n>10</span><span class=o>,</span> <span class=n>11</span><span class=o>,</span> <span class=n>12</span><span class=o>,</span> <span class=n>13</span><span class=o>,</span> <span class=n>14</span><span class=o>,</span> <span class=n>15</span><span class=o>});</span>
</span></span><span class=line><span class=cl>                                <span class=n>ctx</span><span class=o>.</span><span class=na>writeAndFlush</span><span class=o>(</span><span class=n>buffer</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                            <span class=o>}</span>
</span></span><span class=line><span class=cl>                        <span class=o>}</span>
</span></span><span class=line><span class=cl>                    <span class=o>});</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>});</span>
</span></span><span class=line><span class=cl>            <span class=n>ChannelFuture</span> <span class=n>channelFuture</span> <span class=o>=</span> <span class=n>bootstrap</span><span class=o>.</span><span class=na>connect</span><span class=o>(</span><span class=s>&#34;127.0.0.1&#34;</span><span class=o>,</span> <span class=n>8080</span><span class=o>).</span><span class=na>sync</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>channelFuture</span><span class=o>.</span><span class=na>channel</span><span class=o>().</span><span class=na>closeFuture</span><span class=o>().</span><span class=na>sync</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=o>.</span><span class=na>error</span><span class=o>(</span><span class=s>&#34;client error&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>worker</span><span class=o>.</span><span class=na>shutdownGracefully</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>æœåŠ¡å™¨ç«¯çš„æŸæ¬¡è¾“å‡ºï¼Œå¯ä»¥çœ‹åˆ°ä¸€æ¬¡å°±æ¥æ”¶äº† 160 ä¸ªå­—èŠ‚ï¼Œè€Œéåˆ† 10 æ¬¡æ¥æ”¶</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>08:24:46 [DEBUG] [main] c.i.n.HelloWorldServer - [id: 0x81e0fda5] binding...
</span></span><span class=line><span class=cl>08:24:46 [DEBUG] [main] c.i.n.HelloWorldServer - [id: 0x81e0fda5, L:/0:0:0:0:0:0:0:0:8080] bound...
</span></span><span class=line><span class=cl>08:24:55 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x94132411, L:/127.0.0.1:8080 - R:/127.0.0.1:58177] REGISTERED
</span></span><span class=line><span class=cl>08:24:55 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x94132411, L:/127.0.0.1:8080 - R:/127.0.0.1:58177] ACTIVE
</span></span><span class=line><span class=cl>08:24:55 [DEBUG] [nioEventLoopGroup-3-1] c.i.n.HelloWorldServer - connected [id: 0x94132411, L:/127.0.0.1:8080 - R:/127.0.0.1:58177]
</span></span><span class=line><span class=cl>08:24:55 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x94132411, L:/127.0.0.1:8080 - R:/127.0.0.1:58177] READ: 160B
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f |................|
</span></span><span class=line><span class=cl>|00000010| 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f |................|
</span></span><span class=line><span class=cl>|00000020| 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f |................|
</span></span><span class=line><span class=cl>|00000030| 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f |................|
</span></span><span class=line><span class=cl>|00000040| 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f |................|
</span></span><span class=line><span class=cl>|00000050| 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f |................|
</span></span><span class=line><span class=cl>|00000060| 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f |................|
</span></span><span class=line><span class=cl>|00000070| 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f |................|
</span></span><span class=line><span class=cl>|00000080| 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f |................|
</span></span><span class=line><span class=cl>|00000090| 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f |................|
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>08:24:55 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x94132411, L:/127.0.0.1:8080 - R:/127.0.0.1:58177] READ COMPLETE
</span></span></code></pre></td></tr></table></div></div><a href=#12-åŠåŒ…ç°è±¡><h3 id=12-åŠåŒ…ç°è±¡><span class=hanchor arialabel=Anchor># </span>1.2 åŠåŒ…ç°è±¡</h3></a><p>å®¢æˆ·ç«¯ä»£ç å¸Œæœ›å‘é€ 1 ä¸ªæ¶ˆæ¯ï¼Œè¿™ä¸ªæ¶ˆæ¯æ˜¯ 160 å­—èŠ‚ï¼Œä»£ç æ”¹ä¸º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>ByteBuf</span> <span class=n>buffer</span> <span class=o>=</span> <span class=n>ctx</span><span class=o>.</span><span class=na>alloc</span><span class=o>().</span><span class=na>buffer</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>10</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>buffer</span><span class=o>.</span><span class=na>writeBytes</span><span class=o>(</span><span class=k>new</span> <span class=kt>byte</span><span class=o>[]{</span><span class=n>0</span><span class=o>,</span> <span class=n>1</span><span class=o>,</span> <span class=n>2</span><span class=o>,</span> <span class=n>3</span><span class=o>,</span> <span class=n>4</span><span class=o>,</span> <span class=n>5</span><span class=o>,</span> <span class=n>6</span><span class=o>,</span> <span class=n>7</span><span class=o>,</span> <span class=n>8</span><span class=o>,</span> <span class=n>9</span><span class=o>,</span> <span class=n>10</span><span class=o>,</span> <span class=n>11</span><span class=o>,</span> <span class=n>12</span><span class=o>,</span> <span class=n>13</span><span class=o>,</span> <span class=n>14</span><span class=o>,</span> <span class=n>15</span><span class=o>});</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl><span class=n>ctx</span><span class=o>.</span><span class=na>writeAndFlush</span><span class=o>(</span><span class=n>buffer</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><p>ä¸ºç°è±¡æ˜æ˜¾ï¼ŒæœåŠ¡ç«¯ä¿®æ”¹ä¸€ä¸‹æ¥æ”¶ç¼“å†²åŒºï¼Œå…¶å®ƒä»£ç ä¸å˜</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>serverBootstrap</span><span class=o>.</span><span class=na>option</span><span class=o>(</span><span class=n>ChannelOption</span><span class=o>.</span><span class=na>SO_RCVBUF</span><span class=o>,</span> <span class=n>10</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><p>æœåŠ¡å™¨ç«¯çš„æŸæ¬¡è¾“å‡ºï¼Œå¯ä»¥çœ‹åˆ°æ¥æ”¶çš„æ¶ˆæ¯è¢«åˆ†ä¸ºä¸¤èŠ‚ï¼Œç¬¬ä¸€æ¬¡ 20 å­—èŠ‚ï¼Œç¬¬äºŒæ¬¡ 140 å­—èŠ‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>08:43:49 [DEBUG] [main] c.i.n.HelloWorldServer - [id: 0x4d6c6a84] binding...
</span></span><span class=line><span class=cl>08:43:49 [DEBUG] [main] c.i.n.HelloWorldServer - [id: 0x4d6c6a84, L:/0:0:0:0:0:0:0:0:8080] bound...
</span></span><span class=line><span class=cl>08:44:23 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x1719abf7, L:/127.0.0.1:8080 - R:/127.0.0.1:59221] REGISTERED
</span></span><span class=line><span class=cl>08:44:23 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x1719abf7, L:/127.0.0.1:8080 - R:/127.0.0.1:59221] ACTIVE
</span></span><span class=line><span class=cl>08:44:23 [DEBUG] [nioEventLoopGroup-3-1] c.i.n.HelloWorldServer - connected [id: 0x1719abf7, L:/127.0.0.1:8080 - R:/127.0.0.1:59221]
</span></span><span class=line><span class=cl>08:44:24 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x1719abf7, L:/127.0.0.1:8080 - R:/127.0.0.1:59221] READ: 20B
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f |................|
</span></span><span class=line><span class=cl>|00000010| 00 01 02 03                                     |....            |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>08:44:24 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x1719abf7, L:/127.0.0.1:8080 - R:/127.0.0.1:59221] READ COMPLETE
</span></span><span class=line><span class=cl>08:44:24 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x1719abf7, L:/127.0.0.1:8080 - R:/127.0.0.1:59221] READ: 140B
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f 00 01 02 03 |................|
</span></span><span class=line><span class=cl>|00000010| 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f 00 01 02 03 |................|
</span></span><span class=line><span class=cl>|00000020| 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f 00 01 02 03 |................|
</span></span><span class=line><span class=cl>|00000030| 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f 00 01 02 03 |................|
</span></span><span class=line><span class=cl>|00000040| 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f 00 01 02 03 |................|
</span></span><span class=line><span class=cl>|00000050| 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f 00 01 02 03 |................|
</span></span><span class=line><span class=cl>|00000060| 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f 00 01 02 03 |................|
</span></span><span class=line><span class=cl>|00000070| 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f 00 01 02 03 |................|
</span></span><span class=line><span class=cl>|00000080| 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f             |............    |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>08:44:24 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x1719abf7, L:/127.0.0.1:8080 - R:/127.0.0.1:59221] READ COMPLETE
</span></span></code></pre></td></tr></table></div></div><blockquote><p><strong>æ³¨æ„</strong></p><p>serverBootstrap.option(ChannelOption.SO_RCVBUF, 10) å½±å“çš„åº•å±‚æ¥æ”¶ç¼“å†²åŒºï¼ˆå³æ»‘åŠ¨çª—å£ï¼‰å¤§å°ï¼Œä»…å†³å®šäº† netty è¯»å–çš„æœ€å°å•ä½ï¼Œnetty å®é™…æ¯æ¬¡è¯»å–çš„ä¸€èˆ¬æ˜¯å®ƒçš„æ•´æ•°å€</p></blockquote><a href=#13-ç°è±¡åˆ†æ><h3 id=13-ç°è±¡åˆ†æ><span class=hanchor arialabel=Anchor># </span>ğŸ’¡1.3 ç°è±¡åˆ†æ</h3></a><blockquote><p>æ€»åŸå› ï¼šTCPæ¶ˆæ¯æ²¡æœ‰è¾¹ç•Œã€‚</p></blockquote><a href=#ç²˜åŒ…><h4 id=ç²˜åŒ…><span class=hanchor arialabel=Anchor># </span>ç²˜åŒ…</h4></a><ul><li>ç°è±¡ï¼Œå‘é€ abc defï¼Œæ¥æ”¶ abcdef</li><li>åŸå› <ul><li><strong>åº”ç”¨å±‚</strong>ï¼šæ¥æ”¶æ–¹ ByteBuf è®¾ç½®å¤ªå¤§ï¼ˆNetty é»˜è®¤ 1024ï¼‰</li><li><strong>ä¼ è¾“å±‚</strong>ï¼šTCPï¼šæ»‘åŠ¨çª—å£ï¼šå‡è®¾å‘é€æ–¹ 256 bytes è¡¨ç¤ºä¸€ä¸ªå®Œæ•´æŠ¥æ–‡ï¼Œä½†ç”±äºæ¥æ”¶æ–¹å¤„ç†ä¸åŠæ—¶ä¸”çª—å£å¤§å°è¶³å¤Ÿå¤§ï¼Œè¿™ 256 bytes å­—èŠ‚å°±ä¼šç¼“å†²åœ¨æ¥æ”¶æ–¹çš„æ»‘åŠ¨çª—å£ä¸­ï¼Œå½“æ»‘åŠ¨çª—å£ä¸­ç¼“å†²äº†å¤šä¸ªæŠ¥æ–‡å°±ä¼šç²˜åŒ…</li><li><strong>ä¼ è¾“å±‚</strong>ï¼šTCPï¼šNagle ç®—æ³•ï¼šä¼šé€ æˆç²˜åŒ…</li></ul></li></ul><blockquote><p>Nagle ç®—æ³•</p><ul><li>ç³Šæ¶‚çª—å£ç»¼åˆå¾ï¼šå³ä½¿å‘é€1ä¸ªå­—èŠ‚ï¼Œä¹Ÿéœ€è¦åŠ å…¥ tcp å¤´å’Œ ip å¤´ï¼Œä¹Ÿå°±æ˜¯æ€»å­—èŠ‚æ•°ä¼šä½¿ç”¨ 41 bytesï¼ˆTCP20+IP20+æ•°æ®1ï¼‰ï¼Œéå¸¸ä¸ç»æµã€‚å› æ­¤ä¸ºäº†æé«˜ç½‘ç»œåˆ©ç”¨ç‡ï¼Œtcp å¸Œæœ›<strong>å°½å¯èƒ½å‘é€è¶³å¤Ÿå¤§çš„æ•°æ®</strong>ï¼Œè¿™å°±æ˜¯ Nagle ç®—æ³•äº§ç”Ÿçš„ç¼˜ç”±</li><li>è¯¥ç®—æ³•æ˜¯æŒ‡å‘é€ç«¯å³ä½¿è¿˜æœ‰åº”è¯¥å‘é€çš„æ•°æ®ï¼Œä½†å¦‚æœè¿™éƒ¨åˆ†æ•°æ®å¾ˆå°‘çš„è¯ï¼Œåˆ™è¿›è¡Œå»¶è¿Ÿå‘é€<ul><li>å¦‚æœ SO_SNDBUF çš„æ•°æ®è¾¾åˆ° MSSï¼Œåˆ™éœ€è¦å‘é€</li><li>å¦‚æœ SO_SNDBUF ä¸­å«æœ‰ FINï¼ˆè¡¨ç¤ºéœ€è¦è¿æ¥å…³é—­ï¼‰è¿™æ—¶å°†å‰©ä½™æ•°æ®å‘é€ï¼Œå†å…³é—­</li><li>å¦‚æœ TCP_NODELAY = trueï¼Œåˆ™éœ€è¦å‘é€</li><li>å·²å‘é€çš„æ•°æ®éƒ½æ”¶åˆ° ack æ—¶ï¼Œåˆ™éœ€è¦å‘é€</li><li>ä¸Šè¿°æ¡ä»¶ä¸æ»¡è¶³ï¼Œä½†å‘ç”Ÿè¶…æ—¶ï¼ˆä¸€èˆ¬ä¸º 200msï¼‰åˆ™éœ€è¦å‘é€</li><li>é™¤ä¸Šè¿°æƒ…å†µï¼Œå»¶è¿Ÿå‘é€</li></ul></li></ul></blockquote><a href=#åŠåŒ…><h4 id=åŠåŒ…><span class=hanchor arialabel=Anchor># </span>åŠåŒ…</h4></a><ul><li>ç°è±¡ï¼Œå‘é€ abcdefï¼Œæ¥æ”¶ abc def</li><li>åŸå› <ul><li><strong>åº”ç”¨å±‚</strong>ï¼šæ¥æ”¶æ–¹ ByteBuf å°äºå®é™…å‘é€æ•°æ®é‡</li><li><strong>ä¼ è¾“å±‚</strong>ï¼šTCPï¼šæ»‘åŠ¨çª—å£ï¼šå‡è®¾æ¥æ”¶æ–¹çš„çª—å£åªå‰©äº† 128 bytesï¼Œå‘é€æ–¹çš„æŠ¥æ–‡å¤§å°æ˜¯ 256 bytesï¼Œè¿™æ—¶æ”¾ä¸ä¸‹äº†ï¼Œåªèƒ½å…ˆå‘é€å‰ 128 bytesï¼Œç­‰å¾… ack åæ‰èƒ½å‘é€å‰©ä½™éƒ¨åˆ†ï¼Œè¿™å°±é€ æˆäº†åŠåŒ…</li><li><strong>æ•°æ®é“¾è·¯å±‚</strong>ï¼šMSS é™åˆ¶ï¼šå½“å‘é€çš„æ•°æ®è¶…è¿‡ MSS é™åˆ¶åï¼Œä¼šå°†æ•°æ®åˆ‡åˆ†å‘é€ï¼Œå°±ä¼šé€ æˆåŠåŒ…<ul><li>â†‘MSSæ˜¯<strong>ä¼ è¾“å±‚</strong>çš„æŠ¥æ–‡è½½è·é•¿åº¦ï¼ˆä¸åŒ…å«æŠ¥å¤´ï¼‰ï¼ŒMTUæ˜¯<strong>æ•°æ®é“¾è·¯å±‚</strong>æœ€å¤§è½½è·é•¿åº¦ï¼Œå…¶ä¸­MTUåŒ…å«äº†MSSï¼ŒMTUå‡å»IPå¤´å’ŒTCPå¤´ï¼ˆ20+20ï¼‰å°±æ˜¯MSS</li><li>æœ¬æœºå›ç¯åœ°å€MTUé™åˆ¶å¾ˆå¤§ï¼Œ65535ï¼Œéš¾ä»¥æµ‹è¯•ã€‚</li></ul></li></ul></li></ul><p>æœ¬è´¨æ˜¯å› ä¸º TCP æ˜¯æµå¼åè®®ï¼Œæ¶ˆæ¯æ— è¾¹ç•Œ</p><blockquote><p>æ»‘åŠ¨çª—å£</p><ul><li><p>TCP ä»¥ä¸€ä¸ªæ®µï¼ˆsegmentï¼‰ä¸ºå•ä½ï¼Œæ¯å‘é€ä¸€ä¸ªæ®µå°±éœ€è¦è¿›è¡Œä¸€æ¬¡ç¡®è®¤åº”ç­”ï¼ˆackï¼‰å¤„ç†ï¼Œä½†å¦‚æœè¿™ä¹ˆåšï¼Œç¼ºç‚¹æ˜¯åŒ…çš„å¾€è¿”æ—¶é—´è¶Šé•¿æ€§èƒ½å°±è¶Šå·®</p><p><img src="/z-oblib/z2-attachments/0049 1.png" width=auto></p></li></ul><p>ä¸ºäº†è§£å†³æ­¤é—®é¢˜ï¼Œå¼•å…¥äº†çª—å£æ¦‚å¿µï¼Œçª—å£å¤§å°å³å†³å®šäº†æ— éœ€ç­‰å¾…åº”ç­”è€Œå¯ä»¥ç»§ç»­å‘é€çš„æ•°æ®æœ€å¤§å€¼</p><p><img src=/z-oblib/z2-attachments/0051.png width=auto></p><ul><li><p>çª—å£å®é™…å°±èµ·åˆ°ä¸€ä¸ªç¼“å†²åŒºçš„ä½œç”¨ï¼ŒåŒæ—¶ä¹Ÿèƒ½èµ·åˆ°æµé‡æ§åˆ¶çš„ä½œç”¨</p><ul><li>å›¾ä¸­æ·±è‰²çš„éƒ¨åˆ†å³è¦å‘é€çš„æ•°æ®ï¼Œé«˜äº®çš„éƒ¨åˆ†å³çª—å£</li><li>çª—å£å†…çš„æ•°æ®æ‰å…è®¸è¢«å‘é€ï¼Œå½“åº”ç­”æœªåˆ°è¾¾å‰ï¼Œçª—å£å¿…é¡»åœæ­¢æ»‘åŠ¨</li><li>å¦‚æœ 1001~2000 è¿™ä¸ªæ®µçš„æ•°æ® ack å›æ¥äº†ï¼Œçª—å£å°±å¯ä»¥å‘å‰æ»‘åŠ¨</li><li>æ¥æ”¶æ–¹ä¹Ÿä¼šç»´æŠ¤ä¸€ä¸ªçª—å£ï¼Œåªæœ‰è½åœ¨çª—å£å†…çš„æ•°æ®æ‰èƒ½å…è®¸æ¥æ”¶</li></ul></li></ul></blockquote><blockquote><p>MSS é™åˆ¶</p><ul><li><p>é“¾è·¯å±‚å¯¹ä¸€æ¬¡èƒ½å¤Ÿå‘é€çš„æœ€å¤§æ•°æ®æœ‰é™åˆ¶ï¼Œè¿™ä¸ªé™åˆ¶ç§°ä¹‹ä¸º MTUï¼ˆmaximum transmission unitï¼‰ï¼Œä¸åŒçš„é“¾è·¯è®¾å¤‡çš„ MTU å€¼ä¹Ÿæœ‰æ‰€ä¸åŒï¼Œä¾‹å¦‚</p></li><li><p>ä»¥å¤ªç½‘çš„ MTU æ˜¯ 1500</p></li><li><p>FDDIï¼ˆå…‰çº¤åˆ†å¸ƒå¼æ•°æ®æ¥å£ï¼‰çš„ MTU æ˜¯ 4352</p></li><li><p>æœ¬åœ°å›ç¯åœ°å€çš„ MTU æ˜¯ 65535 - æœ¬åœ°æµ‹è¯•ä¸èµ°ç½‘å¡</p></li><li><p>MSS æ˜¯æœ€å¤§æ®µé•¿åº¦ï¼ˆmaximum segment sizeï¼‰ï¼Œå®ƒæ˜¯ MTU åˆ¨å» tcp å¤´å’Œ ip å¤´åå‰©ä½™èƒ½å¤Ÿä½œä¸ºæ•°æ®ä¼ è¾“çš„å­—èŠ‚æ•°</p></li><li><p>ipv4 tcp å¤´å ç”¨ 20 bytesï¼Œip å¤´å ç”¨ 20 bytesï¼Œå› æ­¤ä»¥å¤ªç½‘ MSS çš„å€¼ä¸º 1500 - 40 = 1460</p></li><li><p>TCP åœ¨ä¼ é€’å¤§é‡æ•°æ®æ—¶ï¼Œä¼šæŒ‰ç…§ MSS å¤§å°å°†æ•°æ®è¿›è¡Œåˆ†å‰²å‘é€</p></li><li><p>MSS çš„å€¼åœ¨ä¸‰æ¬¡æ¡æ‰‹æ—¶é€šçŸ¥å¯¹æ–¹è‡ªå·± MSS çš„å€¼ï¼Œç„¶ååœ¨ä¸¤è€…ä¹‹é—´é€‰æ‹©ä¸€ä¸ªå°å€¼ä½œä¸º MSS</p></li></ul><p><img src=/z-oblib/z2-attachments/0031.jpg width=auto></p></blockquote><a href=#14-è§£å†³æ–¹æ¡ˆ><h3 id=14-è§£å†³æ–¹æ¡ˆ><span class=hanchor arialabel=Anchor># </span>1.4 ğŸ’¡è§£å†³æ–¹æ¡ˆ</h3></a><ol><li>çŸ­é“¾æ¥ï¼Œå‘ä¸€ä¸ªåŒ…å»ºç«‹ä¸€æ¬¡è¿æ¥ï¼Œè¿™æ ·è¿æ¥å»ºç«‹åˆ°è¿æ¥æ–­å¼€ä¹‹é—´å°±æ˜¯æ¶ˆæ¯çš„è¾¹ç•Œï¼Œç¼ºç‚¹æ•ˆç‡å¤ªä½</li><li>æ¯ä¸€æ¡æ¶ˆæ¯é‡‡ç”¨å›ºå®šé•¿åº¦ï¼Œç¼ºç‚¹æµªè´¹ç©ºé—´</li><li>æ¯ä¸€æ¡æ¶ˆæ¯é‡‡ç”¨åˆ†éš”ç¬¦ï¼Œä¾‹å¦‚ \nï¼Œç¼ºç‚¹éœ€è¦è½¬ä¹‰</li><li>æ¯ä¸€æ¡æ¶ˆæ¯åˆ†ä¸º head å’Œ bodyï¼Œhead ä¸­åŒ…å« body çš„é•¿åº¦</li></ol><a href=#æ–¹æ³•1çŸ­é“¾æ¥><h4 id=æ–¹æ³•1çŸ­é“¾æ¥><span class=hanchor arialabel=Anchor># </span>æ–¹æ³•1ï¼ŒçŸ­é“¾æ¥</h4></a><p>ä»¥è§£å†³ç²˜åŒ…ä¸ºä¾‹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>HelloWorldClient</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>static</span> <span class=kd>final</span> <span class=n>Logger</span> <span class=n>log</span> <span class=o>=</span> <span class=n>LoggerFactory</span><span class=o>.</span><span class=na>getLogger</span><span class=o>(</span><span class=n>HelloWorldClient</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// åˆ† 10 æ¬¡å‘é€
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>10</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>send</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>send</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>NioEventLoopGroup</span> <span class=n>worker</span> <span class=o>=</span> <span class=k>new</span> <span class=n>NioEventLoopGroup</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Bootstrap</span> <span class=n>bootstrap</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Bootstrap</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>bootstrap</span><span class=o>.</span><span class=na>channel</span><span class=o>(</span><span class=n>NioSocketChannel</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>bootstrap</span><span class=o>.</span><span class=na>group</span><span class=o>(</span><span class=n>worker</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>bootstrap</span><span class=o>.</span><span class=na>handler</span><span class=o>(</span><span class=k>new</span> <span class=n>ChannelInitializer</span><span class=o>&lt;</span><span class=n>SocketChannel</span><span class=o>&gt;()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>                <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>initChannel</span><span class=o>(</span><span class=n>SocketChannel</span> <span class=n>ch</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;conneted...&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>LoggingHandler</span><span class=o>(</span><span class=n>LogLevel</span><span class=o>.</span><span class=na>DEBUG</span><span class=o>));</span>
</span></span><span class=line><span class=cl>                    <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>ChannelInboundHandlerAdapter</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>                        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>channelActive</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                            <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;sending...&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                            <span class=n>ByteBuf</span> <span class=n>buffer</span> <span class=o>=</span> <span class=n>ctx</span><span class=o>.</span><span class=na>alloc</span><span class=o>().</span><span class=na>buffer</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                            <span class=n>buffer</span><span class=o>.</span><span class=na>writeBytes</span><span class=o>(</span><span class=k>new</span> <span class=kt>byte</span><span class=o>[]{</span><span class=n>0</span><span class=o>,</span> <span class=n>1</span><span class=o>,</span> <span class=n>2</span><span class=o>,</span> <span class=n>3</span><span class=o>,</span> <span class=n>4</span><span class=o>,</span> <span class=n>5</span><span class=o>,</span> <span class=n>6</span><span class=o>,</span> <span class=n>7</span><span class=o>,</span> <span class=n>8</span><span class=o>,</span> <span class=n>9</span><span class=o>,</span> <span class=n>10</span><span class=o>,</span> <span class=n>11</span><span class=o>,</span> <span class=n>12</span><span class=o>,</span> <span class=n>13</span><span class=o>,</span> <span class=n>14</span><span class=o>,</span> <span class=n>15</span><span class=o>});</span>
</span></span><span class=line><span class=cl>                            <span class=n>ctx</span><span class=o>.</span><span class=na>writeAndFlush</span><span class=o>(</span><span class=n>buffer</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                            <span class=c1>// å‘å®Œå³å…³
</span></span></span><span class=line><span class=cl><span class=c1></span>                            <span class=n>ctx</span><span class=o>.</span><span class=na>close</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                        <span class=o>}</span>
</span></span><span class=line><span class=cl>                    <span class=o>});</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>});</span>
</span></span><span class=line><span class=cl>            <span class=n>ChannelFuture</span> <span class=n>channelFuture</span> <span class=o>=</span> <span class=n>bootstrap</span><span class=o>.</span><span class=na>connect</span><span class=o>(</span><span class=s>&#34;localhost&#34;</span><span class=o>,</span> <span class=n>8080</span><span class=o>).</span><span class=na>sync</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>channelFuture</span><span class=o>.</span><span class=na>channel</span><span class=o>().</span><span class=na>closeFuture</span><span class=o>().</span><span class=na>sync</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=o>.</span><span class=na>error</span><span class=o>(</span><span class=s>&#34;client error&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>worker</span><span class=o>.</span><span class=na>shutdownGracefully</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>è¾“å‡ºï¼Œç•¥</p><a href=#ç¼ºç‚¹><h5 id=ç¼ºç‚¹><span class=hanchor arialabel=Anchor># </span>ç¼ºç‚¹</h5></a><p>åŠåŒ…ç”¨è¿™ç§åŠæ³•è¿˜æ˜¯ä¸å¥½è§£å†³ï¼Œå› ä¸ºæ¥æ”¶æ–¹çš„ç¼“å†²åŒºå¤§å°æ˜¯æœ‰é™çš„</p><a href=#æ–¹æ³•2å›ºå®šé•¿åº¦><h4 id=æ–¹æ³•2å›ºå®šé•¿åº¦><span class=hanchor arialabel=Anchor># </span>æ–¹æ³•2ï¼Œå›ºå®šé•¿åº¦</h4></a><p>è®©æ‰€æœ‰æ•°æ®åŒ…é•¿åº¦å›ºå®šï¼ˆå‡è®¾é•¿åº¦ä¸º 8 å­—èŠ‚ï¼‰ï¼ŒæœåŠ¡å™¨ç«¯åŠ å…¥</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>FixedLengthFrameDecoder</span><span class=o>(</span><span class=n>8</span><span class=o>));</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>frameï¼šå¸§ï¼Œç½‘ç»œä¸Šä¸€æ¡å®Œæ•´çš„æ¶ˆæ¯</p></blockquote><p>å®¢æˆ·ç«¯æµ‹è¯•ä»£ç ï¼Œæ³¨æ„, é‡‡ç”¨è¿™ç§æ–¹æ³•åï¼Œå®¢æˆ·ç«¯ä»€ä¹ˆæ—¶å€™ flush éƒ½å¯ä»¥</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>HelloWorldClient</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>static</span> <span class=kd>final</span> <span class=n>Logger</span> <span class=n>log</span> <span class=o>=</span> <span class=n>LoggerFactory</span><span class=o>.</span><span class=na>getLogger</span><span class=o>(</span><span class=n>HelloWorldClient</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>NioEventLoopGroup</span> <span class=n>worker</span> <span class=o>=</span> <span class=k>new</span> <span class=n>NioEventLoopGroup</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Bootstrap</span> <span class=n>bootstrap</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Bootstrap</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>bootstrap</span><span class=o>.</span><span class=na>channel</span><span class=o>(</span><span class=n>NioSocketChannel</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>bootstrap</span><span class=o>.</span><span class=na>group</span><span class=o>(</span><span class=n>worker</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>bootstrap</span><span class=o>.</span><span class=na>handler</span><span class=o>(</span><span class=k>new</span> <span class=n>ChannelInitializer</span><span class=o>&lt;</span><span class=n>SocketChannel</span><span class=o>&gt;()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>                <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>initChannel</span><span class=o>(</span><span class=n>SocketChannel</span> <span class=n>ch</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;connetted...&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>LoggingHandler</span><span class=o>(</span><span class=n>LogLevel</span><span class=o>.</span><span class=na>DEBUG</span><span class=o>));</span>
</span></span><span class=line><span class=cl>                    <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>ChannelInboundHandlerAdapter</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>                        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>channelActive</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                            <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;sending...&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                            <span class=c1>// å‘é€å†…å®¹éšæœºçš„æ•°æ®åŒ…
</span></span></span><span class=line><span class=cl><span class=c1></span>                            <span class=n>Random</span> <span class=n>r</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Random</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                            <span class=kt>char</span> <span class=n>c</span> <span class=o>=</span> <span class=sc>&#39;a&#39;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                            <span class=n>ByteBuf</span> <span class=n>buffer</span> <span class=o>=</span> <span class=n>ctx</span><span class=o>.</span><span class=na>alloc</span><span class=o>().</span><span class=na>buffer</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                            <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>10</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                                <span class=kt>byte</span><span class=o>[]</span> <span class=n>bytes</span> <span class=o>=</span> <span class=k>new</span> <span class=kt>byte</span><span class=o>[</span><span class=n>8</span><span class=o>];</span>
</span></span><span class=line><span class=cl>                                <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>j</span> <span class=o>&lt;</span> <span class=n>r</span><span class=o>.</span><span class=na>nextInt</span><span class=o>(</span><span class=n>8</span><span class=o>);</span> <span class=n>j</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                                    <span class=n>bytes</span><span class=o>[</span><span class=n>j</span><span class=o>]</span> <span class=o>=</span> <span class=o>(</span><span class=kt>byte</span><span class=o>)</span> <span class=n>c</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                                <span class=o>}</span>
</span></span><span class=line><span class=cl>                                <span class=n>c</span><span class=o>++;</span>
</span></span><span class=line><span class=cl>                                <span class=n>buffer</span><span class=o>.</span><span class=na>writeBytes</span><span class=o>(</span><span class=n>bytes</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                            <span class=o>}</span>
</span></span><span class=line><span class=cl>                            <span class=n>ctx</span><span class=o>.</span><span class=na>writeAndFlush</span><span class=o>(</span><span class=n>buffer</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                        <span class=o>}</span>
</span></span><span class=line><span class=cl>                    <span class=o>});</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>});</span>
</span></span><span class=line><span class=cl>            <span class=n>ChannelFuture</span> <span class=n>channelFuture</span> <span class=o>=</span> <span class=n>bootstrap</span><span class=o>.</span><span class=na>connect</span><span class=o>(</span><span class=s>&#34;192.168.0.103&#34;</span><span class=o>,</span> <span class=n>9090</span><span class=o>).</span><span class=na>sync</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>channelFuture</span><span class=o>.</span><span class=na>channel</span><span class=o>().</span><span class=na>closeFuture</span><span class=o>().</span><span class=na>sync</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=o>.</span><span class=na>error</span><span class=o>(</span><span class=s>&#34;client error&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>worker</span><span class=o>.</span><span class=na>shutdownGracefully</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å®¢æˆ·ç«¯è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>12:07:00 [DEBUG] [nioEventLoopGroup-2-1] c.i.n.HelloWorldClient - connetted...
</span></span><span class=line><span class=cl>12:07:00 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0x3c2ef3c2] REGISTERED
</span></span><span class=line><span class=cl>12:07:00 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0x3c2ef3c2] CONNECT: /192.168.0.103:9090
</span></span><span class=line><span class=cl>12:07:00 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0x3c2ef3c2, L:/192.168.0.103:53155 - R:/192.168.0.103:9090] ACTIVE
</span></span><span class=line><span class=cl>12:07:00 [DEBUG] [nioEventLoopGroup-2-1] c.i.n.HelloWorldClient - sending...
</span></span><span class=line><span class=cl>12:07:00 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0x3c2ef3c2, L:/192.168.0.103:53155 - R:/192.168.0.103:9090] WRITE: 80B
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 61 61 61 61 00 00 00 00 62 00 00 00 00 00 00 00 |aaaa....b.......|
</span></span><span class=line><span class=cl>|00000010| 63 63 00 00 00 00 00 00 64 00 00 00 00 00 00 00 |cc......d.......|
</span></span><span class=line><span class=cl>|00000020| 00 00 00 00 00 00 00 00 66 66 66 66 00 00 00 00 |........ffff....|
</span></span><span class=line><span class=cl>|00000030| 67 67 67 00 00 00 00 00 68 00 00 00 00 00 00 00 |ggg.....h.......|
</span></span><span class=line><span class=cl>|00000040| 69 69 69 69 69 00 00 00 6a 6a 6a 6a 00 00 00 00 |iiiii...jjjj....|
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>12:07:00 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0x3c2ef3c2, L:/192.168.0.103:53155 - R:/192.168.0.103:9090] FLUSH
</span></span></code></pre></td></tr></table></div></div><p>æœåŠ¡ç«¯è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>12:06:51 [DEBUG] [main] c.i.n.HelloWorldServer - [id: 0xe3d9713f] binding...
</span></span><span class=line><span class=cl>12:06:51 [DEBUG] [main] c.i.n.HelloWorldServer - [id: 0xe3d9713f, L:/192.168.0.103:9090] bound...
</span></span><span class=line><span class=cl>12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155] REGISTERED
</span></span><span class=line><span class=cl>12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155] ACTIVE
</span></span><span class=line><span class=cl>12:07:00 [DEBUG] [nioEventLoopGroup-3-1] c.i.n.HelloWorldServer - connected [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155]
</span></span><span class=line><span class=cl>12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155] READ: 8B
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 61 61 61 61 00 00 00 00                         |aaaa....        |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155] READ: 8B
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 62 00 00 00 00 00 00 00                         |b.......        |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155] READ: 8B
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 63 63 00 00 00 00 00 00                         |cc......        |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155] READ: 8B
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 64 00 00 00 00 00 00 00                         |d.......        |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155] READ: 8B
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 00 00 00 00 00 00 00 00                         |........        |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155] READ: 8B
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 66 66 66 66 00 00 00 00                         |ffff....        |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155] READ: 8B
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 67 67 67 00 00 00 00 00                         |ggg.....        |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155] READ: 8B
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 68 00 00 00 00 00 00 00                         |h.......        |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155] READ: 8B
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 69 69 69 69 69 00 00 00                         |iiiii...        |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155] READ: 8B
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 6a 6a 6a 6a 00 00 00 00                         |jjjj....        |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155] READ COMPLETE
</span></span></code></pre></td></tr></table></div></div><a href=#ç¼ºç‚¹-1><h5 id=ç¼ºç‚¹-1><span class=hanchor arialabel=Anchor># </span>ç¼ºç‚¹</h5></a><p>æ•°æ®åŒ…çš„å¤§å°ä¸å¥½æŠŠæ¡</p><ul><li>é•¿åº¦å®šçš„å¤ªå¤§ï¼Œæµªè´¹</li><li>é•¿åº¦å®šçš„å¤ªå°ï¼Œå¯¹æŸäº›æ•°æ®åŒ…åˆæ˜¾å¾—ä¸å¤Ÿ</li></ul><a href=#æ–¹æ³•3å›ºå®šåˆ†éš”ç¬¦><h4 id=æ–¹æ³•3å›ºå®šåˆ†éš”ç¬¦><span class=hanchor arialabel=Anchor># </span>æ–¹æ³•3ï¼Œå›ºå®šåˆ†éš”ç¬¦</h4></a><p>æœåŠ¡ç«¯åŠ å…¥ï¼Œé»˜è®¤ä»¥ <code>\n</code> æˆ– <code>\r\n</code> ä½œä¸ºåˆ†éš”ç¬¦ï¼Œå¿…é¡»æŒ‡å®šæœ€å¤§é•¿åº¦ï¼Œå¦‚æœè¶…å‡ºæŒ‡å®šé•¿åº¦ä»æœªå‡ºç°åˆ†éš”ç¬¦ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>LineBasedFrameDecoder</span><span class=o>(</span><span class=n>1024</span><span class=o>));</span>
</span></span></code></pre></td></tr></table></div></div><p>å®¢æˆ·ç«¯åœ¨æ¯æ¡æ¶ˆæ¯ä¹‹åï¼ŒåŠ å…¥ <code>\n</code> åˆ†éš”ç¬¦</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>HelloWorldClient</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>static</span> <span class=kd>final</span> <span class=n>Logger</span> <span class=n>log</span> <span class=o>=</span> <span class=n>LoggerFactory</span><span class=o>.</span><span class=na>getLogger</span><span class=o>(</span><span class=n>HelloWorldClient</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>NioEventLoopGroup</span> <span class=n>worker</span> <span class=o>=</span> <span class=k>new</span> <span class=n>NioEventLoopGroup</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Bootstrap</span> <span class=n>bootstrap</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Bootstrap</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>bootstrap</span><span class=o>.</span><span class=na>channel</span><span class=o>(</span><span class=n>NioSocketChannel</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>bootstrap</span><span class=o>.</span><span class=na>group</span><span class=o>(</span><span class=n>worker</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>bootstrap</span><span class=o>.</span><span class=na>handler</span><span class=o>(</span><span class=k>new</span> <span class=n>ChannelInitializer</span><span class=o>&lt;</span><span class=n>SocketChannel</span><span class=o>&gt;()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>                <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>initChannel</span><span class=o>(</span><span class=n>SocketChannel</span> <span class=n>ch</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;connetted...&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>LoggingHandler</span><span class=o>(</span><span class=n>LogLevel</span><span class=o>.</span><span class=na>DEBUG</span><span class=o>));</span>
</span></span><span class=line><span class=cl>                    <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>ChannelInboundHandlerAdapter</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>                        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>channelActive</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                            <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;sending...&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                            <span class=n>Random</span> <span class=n>r</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Random</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                            <span class=kt>char</span> <span class=n>c</span> <span class=o>=</span> <span class=sc>&#39;a&#39;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                            <span class=n>ByteBuf</span> <span class=n>buffer</span> <span class=o>=</span> <span class=n>ctx</span><span class=o>.</span><span class=na>alloc</span><span class=o>().</span><span class=na>buffer</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                            <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>10</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                                <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=n>1</span><span class=o>;</span> <span class=n>j</span> <span class=o>&lt;=</span> <span class=n>r</span><span class=o>.</span><span class=na>nextInt</span><span class=o>(</span><span class=n>16</span><span class=o>)+</span><span class=n>1</span><span class=o>;</span> <span class=n>j</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                                    <span class=n>buffer</span><span class=o>.</span><span class=na>writeByte</span><span class=o>((</span><span class=kt>byte</span><span class=o>)</span> <span class=n>c</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                                <span class=o>}</span>
</span></span><span class=line><span class=cl>                                <span class=n>buffer</span><span class=o>.</span><span class=na>writeByte</span><span class=o>(</span><span class=n>10</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                                <span class=n>c</span><span class=o>++;</span>
</span></span><span class=line><span class=cl>                            <span class=o>}</span>
</span></span><span class=line><span class=cl>                            <span class=n>ctx</span><span class=o>.</span><span class=na>writeAndFlush</span><span class=o>(</span><span class=n>buffer</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                        <span class=o>}</span>
</span></span><span class=line><span class=cl>                    <span class=o>});</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>});</span>
</span></span><span class=line><span class=cl>            <span class=n>ChannelFuture</span> <span class=n>channelFuture</span> <span class=o>=</span> <span class=n>bootstrap</span><span class=o>.</span><span class=na>connect</span><span class=o>(</span><span class=s>&#34;192.168.0.103&#34;</span><span class=o>,</span> <span class=n>9090</span><span class=o>).</span><span class=na>sync</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>channelFuture</span><span class=o>.</span><span class=na>channel</span><span class=o>().</span><span class=na>closeFuture</span><span class=o>().</span><span class=na>sync</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=o>.</span><span class=na>error</span><span class=o>(</span><span class=s>&#34;client error&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>worker</span><span class=o>.</span><span class=na>shutdownGracefully</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å®¢æˆ·ç«¯è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>14:08:18 [DEBUG] [nioEventLoopGroup-2-1] c.i.n.HelloWorldClient - connetted...
</span></span><span class=line><span class=cl>14:08:18 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0x1282d755] REGISTERED
</span></span><span class=line><span class=cl>14:08:18 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0x1282d755] CONNECT: /192.168.0.103:9090
</span></span><span class=line><span class=cl>14:08:18 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0x1282d755, L:/192.168.0.103:63641 - R:/192.168.0.103:9090] ACTIVE
</span></span><span class=line><span class=cl>14:08:18 [DEBUG] [nioEventLoopGroup-2-1] c.i.n.HelloWorldClient - sending...
</span></span><span class=line><span class=cl>14:08:18 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0x1282d755, L:/192.168.0.103:63641 - R:/192.168.0.103:9090] WRITE: 60B
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 61 0a 62 62 62 0a 63 63 63 0a 64 64 0a 65 65 65 |a.bbb.ccc.dd.eee|
</span></span><span class=line><span class=cl>|00000010| 65 65 65 65 65 65 65 0a 66 66 0a 67 67 67 67 67 |eeeeeee.ff.ggggg|
</span></span><span class=line><span class=cl>|00000020| 67 67 0a 68 68 68 68 0a 69 69 69 69 69 69 69 0a |gg.hhhh.iiiiiii.|
</span></span><span class=line><span class=cl>|00000030| 6a 6a 6a 6a 6a 6a 6a 6a 6a 6a 6a 0a             |jjjjjjjjjjj.    |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>14:08:18 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0x1282d755, L:/192.168.0.103:63641 - R:/192.168.0.103:9090] FLUSH
</span></span></code></pre></td></tr></table></div></div><p>æœåŠ¡ç«¯è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>14:08:18 [DEBUG] [nioEventLoopGroup-3-5] c.i.n.HelloWorldServer - connected [id: 0xa4b3be43, L:/192.168.0.103:9090 - R:/192.168.0.103:63641]
</span></span><span class=line><span class=cl>14:08:18 [DEBUG] [nioEventLoopGroup-3-5] i.n.h.l.LoggingHandler - [id: 0xa4b3be43, L:/192.168.0.103:9090 - R:/192.168.0.103:63641] READ: 1B
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 61                                              |a               |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>14:08:18 [DEBUG] [nioEventLoopGroup-3-5] i.n.h.l.LoggingHandler - [id: 0xa4b3be43, L:/192.168.0.103:9090 - R:/192.168.0.103:63641] READ: 3B
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 62 62 62                                        |bbb             |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>14:08:18 [DEBUG] [nioEventLoopGroup-3-5] i.n.h.l.LoggingHandler - [id: 0xa4b3be43, L:/192.168.0.103:9090 - R:/192.168.0.103:63641] READ: 3B
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 63 63 63                                        |ccc             |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>14:08:18 [DEBUG] [nioEventLoopGroup-3-5] i.n.h.l.LoggingHandler - [id: 0xa4b3be43, L:/192.168.0.103:9090 - R:/192.168.0.103:63641] READ: 2B
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 64 64                                           |dd              |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>14:08:18 [DEBUG] [nioEventLoopGroup-3-5] i.n.h.l.LoggingHandler - [id: 0xa4b3be43, L:/192.168.0.103:9090 - R:/192.168.0.103:63641] READ: 10B
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 65 65 65 65 65 65 65 65 65 65                   |eeeeeeeeee      |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>14:08:18 [DEBUG] [nioEventLoopGroup-3-5] i.n.h.l.LoggingHandler - [id: 0xa4b3be43, L:/192.168.0.103:9090 - R:/192.168.0.103:63641] READ: 2B
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 66 66                                           |ff              |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>14:08:18 [DEBUG] [nioEventLoopGroup-3-5] i.n.h.l.LoggingHandler - [id: 0xa4b3be43, L:/192.168.0.103:9090 - R:/192.168.0.103:63641] READ: 7B
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 67 67 67 67 67 67 67                            |ggggggg         |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>14:08:18 [DEBUG] [nioEventLoopGroup-3-5] i.n.h.l.LoggingHandler - [id: 0xa4b3be43, L:/192.168.0.103:9090 - R:/192.168.0.103:63641] READ: 4B
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 68 68 68 68                                     |hhhh            |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>14:08:18 [DEBUG] [nioEventLoopGroup-3-5] i.n.h.l.LoggingHandler - [id: 0xa4b3be43, L:/192.168.0.103:9090 - R:/192.168.0.103:63641] READ: 7B
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 69 69 69 69 69 69 69                            |iiiiiii         |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>14:08:18 [DEBUG] [nioEventLoopGroup-3-5] i.n.h.l.LoggingHandler - [id: 0xa4b3be43, L:/192.168.0.103:9090 - R:/192.168.0.103:63641] READ: 11B
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 6a 6a 6a 6a 6a 6a 6a 6a 6a 6a 6a                |jjjjjjjjjjj     |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>14:08:18 [DEBUG] [nioEventLoopGroup-3-5] i.n.h.l.LoggingHandler - [id: 0xa4b3be43, L:/192.168.0.103:9090 - R:/192.168.0.103:63641] READ COMPLETE
</span></span></code></pre></td></tr></table></div></div><a href=#ç¼ºç‚¹-2><h5 id=ç¼ºç‚¹-2><span class=hanchor arialabel=Anchor># </span>ç¼ºç‚¹</h5></a><p>å¤„ç†å­—ç¬¦æ•°æ®æ¯”è¾ƒåˆé€‚ï¼Œä½†å¦‚æœå†…å®¹æœ¬èº«åŒ…å«äº†åˆ†éš”ç¬¦ï¼ˆå­—èŠ‚æ•°æ®å¸¸å¸¸ä¼šæœ‰æ­¤æƒ…å†µï¼‰ï¼Œé‚£ä¹ˆå°±ä¼šè§£æé”™è¯¯</p><a href=#æ–¹æ³•4çº¦å®šé•¿åº¦><h4 id=æ–¹æ³•4çº¦å®šé•¿åº¦><span class=hanchor arialabel=Anchor># </span>æ–¹æ³•4ï¼Œçº¦å®šé•¿åº¦</h4></a><blockquote><p>ç±»ä¼¼httpåè®®çš„Content-Lengthã€‚å®é™…ä¸Šæˆ‘ä»¬å°±æ˜¯è¦è®¾è®¡ä¸€ä¸ªç±»ä¼¼httpçš„åè®®ã€‚</p></blockquote><p>åœ¨å‘é€æ¶ˆæ¯å‰ï¼Œå…ˆçº¦å®šç”¨å®šé•¿å­—èŠ‚è¡¨ç¤ºæ¥ä¸‹æ¥æ•°æ®çš„é•¿åº¦</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// æœ€å¤§é•¿åº¦ï¼Œé•¿åº¦åç§»ï¼Œé•¿åº¦å ç”¨å­—èŠ‚ï¼Œé•¿åº¦è°ƒæ•´ï¼Œå‰¥ç¦»å­—èŠ‚æ•°
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>LengthFieldBasedFrameDecoder</span><span class=o>(</span><span class=n>1024</span><span class=o>,</span> <span class=n>0</span><span class=o>,</span> <span class=n>1</span><span class=o>,</span> <span class=n>0</span><span class=o>,</span> <span class=n>1</span><span class=o>));</span>
</span></span></code></pre></td></tr></table></div></div><p>å®¢æˆ·ç«¯ä»£ç </p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>HelloWorldClient</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>static</span> <span class=kd>final</span> <span class=n>Logger</span> <span class=n>log</span> <span class=o>=</span> <span class=n>LoggerFactory</span><span class=o>.</span><span class=na>getLogger</span><span class=o>(</span><span class=n>HelloWorldClient</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>NioEventLoopGroup</span> <span class=n>worker</span> <span class=o>=</span> <span class=k>new</span> <span class=n>NioEventLoopGroup</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Bootstrap</span> <span class=n>bootstrap</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Bootstrap</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>bootstrap</span><span class=o>.</span><span class=na>channel</span><span class=o>(</span><span class=n>NioSocketChannel</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>bootstrap</span><span class=o>.</span><span class=na>group</span><span class=o>(</span><span class=n>worker</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>bootstrap</span><span class=o>.</span><span class=na>handler</span><span class=o>(</span><span class=k>new</span> <span class=n>ChannelInitializer</span><span class=o>&lt;</span><span class=n>SocketChannel</span><span class=o>&gt;()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>                <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>initChannel</span><span class=o>(</span><span class=n>SocketChannel</span> <span class=n>ch</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;connetted...&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>LoggingHandler</span><span class=o>(</span><span class=n>LogLevel</span><span class=o>.</span><span class=na>DEBUG</span><span class=o>));</span>
</span></span><span class=line><span class=cl>                    <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>ChannelInboundHandlerAdapter</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>                        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>channelActive</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                            <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;sending...&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                            <span class=n>Random</span> <span class=n>r</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Random</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                            <span class=kt>char</span> <span class=n>c</span> <span class=o>=</span> <span class=sc>&#39;a&#39;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                            <span class=n>ByteBuf</span> <span class=n>buffer</span> <span class=o>=</span> <span class=n>ctx</span><span class=o>.</span><span class=na>alloc</span><span class=o>().</span><span class=na>buffer</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                            <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>10</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                                <span class=kt>byte</span> <span class=n>length</span> <span class=o>=</span> <span class=o>(</span><span class=kt>byte</span><span class=o>)</span> <span class=o>(</span><span class=n>r</span><span class=o>.</span><span class=na>nextInt</span><span class=o>(</span><span class=n>16</span><span class=o>)</span> <span class=o>+</span> <span class=n>1</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                                <span class=c1>// å…ˆå†™å…¥é•¿åº¦
</span></span></span><span class=line><span class=cl><span class=c1></span>                                <span class=n>buffer</span><span class=o>.</span><span class=na>writeByte</span><span class=o>(</span><span class=n>length</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                                <span class=c1>// å†
</span></span></span><span class=line><span class=cl><span class=c1></span>                                <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=n>1</span><span class=o>;</span> <span class=n>j</span> <span class=o>&lt;=</span> <span class=n>length</span><span class=o>;</span> <span class=n>j</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                                    <span class=n>buffer</span><span class=o>.</span><span class=na>writeByte</span><span class=o>((</span><span class=kt>byte</span><span class=o>)</span> <span class=n>c</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                                <span class=o>}</span>
</span></span><span class=line><span class=cl>                                <span class=n>c</span><span class=o>++;</span>
</span></span><span class=line><span class=cl>                            <span class=o>}</span>
</span></span><span class=line><span class=cl>                            <span class=n>ctx</span><span class=o>.</span><span class=na>writeAndFlush</span><span class=o>(</span><span class=n>buffer</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                        <span class=o>}</span>
</span></span><span class=line><span class=cl>                    <span class=o>});</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>});</span>
</span></span><span class=line><span class=cl>            <span class=n>ChannelFuture</span> <span class=n>channelFuture</span> <span class=o>=</span> <span class=n>bootstrap</span><span class=o>.</span><span class=na>connect</span><span class=o>(</span><span class=s>&#34;192.168.0.103&#34;</span><span class=o>,</span> <span class=n>9090</span><span class=o>).</span><span class=na>sync</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>channelFuture</span><span class=o>.</span><span class=na>channel</span><span class=o>().</span><span class=na>closeFuture</span><span class=o>().</span><span class=na>sync</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=o>.</span><span class=na>error</span><span class=o>(</span><span class=s>&#34;client error&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>worker</span><span class=o>.</span><span class=na>shutdownGracefully</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å®¢æˆ·ç«¯è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>14:37:10 [DEBUG] [nioEventLoopGroup-2-1] c.i.n.HelloWorldClient - connetted...
</span></span><span class=line><span class=cl>14:37:10 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0xf0f347b8] REGISTERED
</span></span><span class=line><span class=cl>14:37:10 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0xf0f347b8] CONNECT: /192.168.0.103:9090
</span></span><span class=line><span class=cl>14:37:10 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0xf0f347b8, L:/192.168.0.103:49979 - R:/192.168.0.103:9090] ACTIVE
</span></span><span class=line><span class=cl>14:37:10 [DEBUG] [nioEventLoopGroup-2-1] c.i.n.HelloWorldClient - sending...
</span></span><span class=line><span class=cl>14:37:10 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0xf0f347b8, L:/192.168.0.103:49979 - R:/192.168.0.103:9090] WRITE: 97B
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 09 61 61 61 61 61 61 61 61 61 09 62 62 62 62 62 |.aaaaaaaaa.bbbbb|
</span></span><span class=line><span class=cl>|00000010| 62 62 62 62 06 63 63 63 63 63 63 08 64 64 64 64 |bbbb.cccccc.dddd|
</span></span><span class=line><span class=cl>|00000020| 64 64 64 64 0f 65 65 65 65 65 65 65 65 65 65 65 |dddd.eeeeeeeeeee|
</span></span><span class=line><span class=cl>|00000030| 65 65 65 65 0d 66 66 66 66 66 66 66 66 66 66 66 |eeee.fffffffffff|
</span></span><span class=line><span class=cl>|00000040| 66 66 02 67 67 02 68 68 0e 69 69 69 69 69 69 69 |ff.gg.hh.iiiiiii|
</span></span><span class=line><span class=cl>|00000050| 69 69 69 69 69 69 69 09 6a 6a 6a 6a 6a 6a 6a 6a |iiiiiii.jjjjjjjj|
</span></span><span class=line><span class=cl>|00000060| 6a                                              |j               |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>14:37:10 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0xf0f347b8, L:/192.168.0.103:49979 - R:/192.168.0.103:9090] FLUSH
</span></span></code></pre></td></tr></table></div></div><p>æœåŠ¡ç«¯è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>14:36:50 [DEBUG] [main] c.i.n.HelloWorldServer - [id: 0xdff439d3] binding...
</span></span><span class=line><span class=cl>14:36:51 [DEBUG] [main] c.i.n.HelloWorldServer - [id: 0xdff439d3, L:/192.168.0.103:9090] bound...
</span></span><span class=line><span class=cl>14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979] REGISTERED
</span></span><span class=line><span class=cl>14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979] ACTIVE
</span></span><span class=line><span class=cl>14:37:10 [DEBUG] [nioEventLoopGroup-3-1] c.i.n.HelloWorldServer - connected [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979]
</span></span><span class=line><span class=cl>14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979] READ: 9B
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 61 61 61 61 61 61 61 61 61                      |aaaaaaaaa       |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979] READ: 9B
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 62 62 62 62 62 62 62 62 62                      |bbbbbbbbb       |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979] READ: 6B
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 63 63 63 63 63 63                               |cccccc          |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979] READ: 8B
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 64 64 64 64 64 64 64 64                         |dddddddd        |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979] READ: 15B
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 65 65 65 65 65 65 65 65 65 65 65 65 65 65 65    |eeeeeeeeeeeeeee |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979] READ: 13B
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 66 66 66 66 66 66 66 66 66 66 66 66 66          |fffffffffffff   |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979] READ: 2B
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 67 67                                           |gg              |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979] READ: 2B
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 68 68                                           |hh              |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979] READ: 14B
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 69 69 69 69 69 69 69 69 69 69 69 69 69 69       |iiiiiiiiiiiiii  |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979] READ: 9B
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 6a 6a 6a 6a 6a 6a 6a 6a 6a                      |jjjjjjjjj       |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979] READ COMPLETE
</span></span></code></pre></td></tr></table></div></div><a href=#2-åè®®è®¾è®¡ä¸è§£æ><h2 id=2-åè®®è®¾è®¡ä¸è§£æ><span class=hanchor arialabel=Anchor># </span>2. åè®®è®¾è®¡ä¸è§£æ</h2></a><a href=#21-ä¸ºä»€ä¹ˆéœ€è¦åè®®><h3 id=21-ä¸ºä»€ä¹ˆéœ€è¦åè®®><span class=hanchor arialabel=Anchor># </span>2.1 ä¸ºä»€ä¹ˆéœ€è¦åè®®ï¼Ÿ</h3></a><blockquote><p>TCP/IP ä¸­æ¶ˆæ¯ä¼ è¾“åŸºäº<strong>æµ</strong>çš„æ–¹å¼ï¼Œ<strong>æ²¡æœ‰è¾¹ç•Œ</strong>ã€‚</p></blockquote><p>åè®®çš„ç›®çš„å°±æ˜¯åˆ’å®šæ¶ˆæ¯çš„è¾¹ç•Œï¼Œåˆ¶å®šé€šä¿¡åŒæ–¹è¦å…±åŒéµå®ˆçš„é€šä¿¡è§„åˆ™</p><p>ä¾‹å¦‚ï¼šåœ¨ç½‘ç»œä¸Šä¼ è¾“</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>ä¸‹é›¨å¤©ç•™å®¢å¤©ç•™æˆ‘ä¸ç•™
</span></span></code></pre></td></tr></table></div></div><p>æ˜¯ä¸­æ–‡ä¸€å¥è‘—åçš„æ— æ ‡ç‚¹ç¬¦å·å¥å­ï¼Œåœ¨æ²¡æœ‰æ ‡ç‚¹ç¬¦å·æƒ…å†µä¸‹ï¼Œè¿™å¥è¯æœ‰æ•°ç§æ‹†è§£æ–¹å¼ï¼Œè€Œæ„æ€å´æ˜¯å®Œå…¨ä¸åŒï¼Œæ‰€ä»¥å¸¸è¢«ç”¨ä½œè®²è¿°æ ‡ç‚¹ç¬¦å·çš„é‡è¦æ€§</p><p>ä¸€ç§è§£è¯»</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>ä¸‹é›¨å¤©ç•™å®¢ï¼Œå¤©ç•™ï¼Œæˆ‘ä¸ç•™
</span></span></code></pre></td></tr></table></div></div><p>å¦ä¸€ç§è§£è¯»</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>ä¸‹é›¨å¤©ï¼Œç•™å®¢å¤©ï¼Œç•™æˆ‘ä¸ï¼Ÿç•™
</span></span></code></pre></td></tr></table></div></div><p>å¦‚ä½•è®¾è®¡åè®®å‘¢ï¼Ÿå…¶å®å°±æ˜¯ç»™ç½‘ç»œä¼ è¾“çš„ä¿¡æ¯åŠ ä¸Šâ€œæ ‡ç‚¹ç¬¦å·â€ã€‚ä½†é€šè¿‡åˆ†éš”ç¬¦æ¥æ–­å¥ä¸æ˜¯å¾ˆå¥½ï¼Œå› ä¸ºåˆ†éš”ç¬¦æœ¬èº«å¦‚æœç”¨äºä¼ è¾“ï¼Œé‚£ä¹ˆå¿…é¡»åŠ ä»¥åŒºåˆ†ã€‚å› æ­¤ï¼Œä¸‹é¢ä¸€ç§åè®®è¾ƒä¸ºå¸¸ç”¨</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>å®šé•¿å­—èŠ‚è¡¨ç¤ºå†…å®¹é•¿åº¦ + å®é™…å†…å®¹
</span></span></code></pre></td></tr></table></div></div><p>ä¾‹å¦‚ï¼Œå‡è®¾ä¸€ä¸ªä¸­æ–‡å­—ç¬¦é•¿åº¦ä¸º 3ï¼ŒæŒ‰ç…§ä¸Šè¿°åè®®çš„è§„åˆ™ï¼Œå‘é€ä¿¡æ¯æ–¹å¼å¦‚ä¸‹ï¼Œå°±ä¸ä¼šè¢«æ¥æ”¶æ–¹å¼„é”™æ„æ€äº†</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>0fä¸‹é›¨å¤©ç•™å®¢06å¤©ç•™09æˆ‘ä¸ç•™
</span></span></code></pre></td></tr></table></div></div><blockquote><p>å°æ•…äº‹</p><p>å¾ˆä¹…å¾ˆä¹…ä»¥å‰ï¼Œä¸€ä½ç§å¡¾å…ˆç”Ÿåˆ°ä¸€å®¶ä»»æ•™ã€‚åŒæ–¹ç­¾è®¢äº†ä¸€çº¸åè®®ï¼šâ€œæ— é¸¡é¸­äº¦å¯æ— é±¼è‚‰äº¦å¯ç™½èœè±†è…ä¸å¯å°‘ä¸å¾—æŸä¿®é‡‘â€ã€‚æ­¤åï¼Œç§å¡¾å…ˆç”Ÿè™½ç„¶è®¤çœŸæ•™è¯¾ï¼Œä½†ä¸»äººå®¶åˆ™æ€»æ˜¯ç»™ç§å¡¾å…ˆç”Ÿä»¥ç™½èœè±†è…ä¸ºèœï¼Œä¸æ¯«æœªè§é¸¡é¸­é±¼è‚‰çš„æ¬¾å¾…ã€‚ç§å¡¾å…ˆç”Ÿå…ˆæ˜¯å¾ˆä¸è§£ï¼Œå¯æ˜¯åæ¥ä¹Ÿå°±æƒ³é€šäº†ï¼šä¸»äººæŠŠé¸¡é¸­é±¼è‚‰çš„é’±éƒ½ä¼šæ¢ä¸ºæŸä¿®é‡‘çš„ï¼Œä¹Ÿç½¢ã€‚è‡³æ­¤åŒæ–¹ç›¸å®‰æ— äº‹ã€‚</p><p>å¹´å…³å°†è‡³ï¼Œä¸€ä¸ªå­¦å¹´æ®µäº¦å‘Šç»“æŸã€‚ç§å¡¾å…ˆç”Ÿä¸´è¡Œæ—¶ï¼Œä¹Ÿä¸è§ä¸»äººå®¶ä¸ºä»–äº¤ä»˜æŸä¿®é‡‘ï¼Œé‚ä¸ä¸»å®¶ç†è®ºã€‚ç„¶ä¸»å®¶äº¦æŒ¯æŒ¯æœ‰è¯ï¼šâ€œæœ‰åè®®ä¸ºè¯â€”â€”æ— é¸¡é¸­äº¦å¯ï¼Œæ— é±¼è‚‰äº¦å¯ï¼Œç™½èœè±†è…ä¸å¯å°‘ï¼Œä¸å¾—æŸä¿®é‡‘ã€‚è¿™ç™½çº¸é»‘å­—æ˜æ‘†ç€çš„ï¼Œä½ æœ‰ä»€ä¹ˆè¦è¯´çš„å‘¢ï¼Ÿâ€</p><p>ç§å¡¾å…ˆç”Ÿæ®ç†åŠ›äº‰ï¼šâ€œåè®®æ˜¯è¿™æ ·çš„â€”â€”æ— é¸¡ï¼Œé¸­äº¦å¯ï¼›æ— é±¼ï¼Œè‚‰äº¦å¯ï¼›ç™½èœè±†è…ä¸å¯ï¼Œå°‘ä¸å¾—æŸä¿®é‡‘ã€‚â€</p><p>åŒæ–¹å”‡æªèˆŒæˆ˜ï¼Œä½ æ¥æˆ‘å¾€ï¼ŒçœŸä¸ªæ˜¯ä¸äº¦ä¹ä¹ï¼</p><p>è¿™é‡Œçš„æŸä¿®é‡‘ï¼Œä¹Ÿä½œâ€œæŸè„©â€ï¼Œåº”å½“æ˜¯æ³›æŒ‡æ•™å¸ˆåº”å½“å¾—åˆ°çš„æŠ¥é…¬</p></blockquote><a href=#22-redis-åè®®ä¸¾ä¾‹><h3 id=22-redis-åè®®ä¸¾ä¾‹><span class=hanchor arialabel=Anchor># </span>2.2 redis åè®®ä¸¾ä¾‹</h3></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>NioEventLoopGroup</span> <span class=n>worker</span> <span class=o>=</span> <span class=k>new</span> <span class=n>NioEventLoopGroup</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=kt>byte</span><span class=o>[]</span> <span class=n>LINE</span> <span class=o>=</span> <span class=o>{</span><span class=n>13</span><span class=o>,</span> <span class=n>10</span><span class=o>};</span>
</span></span><span class=line><span class=cl><span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Bootstrap</span> <span class=n>bootstrap</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Bootstrap</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>bootstrap</span><span class=o>.</span><span class=na>channel</span><span class=o>(</span><span class=n>NioSocketChannel</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>bootstrap</span><span class=o>.</span><span class=na>group</span><span class=o>(</span><span class=n>worker</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>bootstrap</span><span class=o>.</span><span class=na>handler</span><span class=o>(</span><span class=k>new</span> <span class=n>ChannelInitializer</span><span class=o>&lt;</span><span class=n>SocketChannel</span><span class=o>&gt;()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>initChannel</span><span class=o>(</span><span class=n>SocketChannel</span> <span class=n>ch</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>LoggingHandler</span><span class=o>());</span>
</span></span><span class=line><span class=cl>            <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>ChannelInboundHandlerAdapter</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// ä¼šåœ¨è¿æ¥ channel å»ºç«‹æˆåŠŸåï¼Œä¼šè§¦å‘ active äº‹ä»¶
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>                <span class=kd>public</span> <span class=kt>void</span> <span class=nf>channelActive</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>set</span><span class=o>(</span><span class=n>ctx</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>get</span><span class=o>(</span><span class=n>ctx</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=kd>private</span> <span class=kt>void</span> <span class=nf>get</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>ByteBuf</span> <span class=n>buf</span> <span class=o>=</span> <span class=n>ctx</span><span class=o>.</span><span class=na>alloc</span><span class=o>().</span><span class=na>buffer</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                    <span class=n>buf</span><span class=o>.</span><span class=na>writeBytes</span><span class=o>(</span><span class=s>&#34;*2&#34;</span><span class=o>.</span><span class=na>getBytes</span><span class=o>());</span>
</span></span><span class=line><span class=cl>                    <span class=n>buf</span><span class=o>.</span><span class=na>writeBytes</span><span class=o>(</span><span class=n>LINE</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>buf</span><span class=o>.</span><span class=na>writeBytes</span><span class=o>(</span><span class=s>&#34;$3&#34;</span><span class=o>.</span><span class=na>getBytes</span><span class=o>());</span>
</span></span><span class=line><span class=cl>                    <span class=n>buf</span><span class=o>.</span><span class=na>writeBytes</span><span class=o>(</span><span class=n>LINE</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>buf</span><span class=o>.</span><span class=na>writeBytes</span><span class=o>(</span><span class=s>&#34;get&#34;</span><span class=o>.</span><span class=na>getBytes</span><span class=o>());</span>
</span></span><span class=line><span class=cl>                    <span class=n>buf</span><span class=o>.</span><span class=na>writeBytes</span><span class=o>(</span><span class=n>LINE</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>buf</span><span class=o>.</span><span class=na>writeBytes</span><span class=o>(</span><span class=s>&#34;$3&#34;</span><span class=o>.</span><span class=na>getBytes</span><span class=o>());</span>
</span></span><span class=line><span class=cl>                    <span class=n>buf</span><span class=o>.</span><span class=na>writeBytes</span><span class=o>(</span><span class=n>LINE</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>buf</span><span class=o>.</span><span class=na>writeBytes</span><span class=o>(</span><span class=s>&#34;aaa&#34;</span><span class=o>.</span><span class=na>getBytes</span><span class=o>());</span>
</span></span><span class=line><span class=cl>                    <span class=n>buf</span><span class=o>.</span><span class=na>writeBytes</span><span class=o>(</span><span class=n>LINE</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>ctx</span><span class=o>.</span><span class=na>writeAndFlush</span><span class=o>(</span><span class=n>buf</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=kd>private</span> <span class=kt>void</span> <span class=nf>set</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>ByteBuf</span> <span class=n>buf</span> <span class=o>=</span> <span class=n>ctx</span><span class=o>.</span><span class=na>alloc</span><span class=o>().</span><span class=na>buffer</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                    <span class=n>buf</span><span class=o>.</span><span class=na>writeBytes</span><span class=o>(</span><span class=s>&#34;*3&#34;</span><span class=o>.</span><span class=na>getBytes</span><span class=o>());</span>
</span></span><span class=line><span class=cl>                    <span class=n>buf</span><span class=o>.</span><span class=na>writeBytes</span><span class=o>(</span><span class=n>LINE</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>buf</span><span class=o>.</span><span class=na>writeBytes</span><span class=o>(</span><span class=s>&#34;$3&#34;</span><span class=o>.</span><span class=na>getBytes</span><span class=o>());</span>
</span></span><span class=line><span class=cl>                    <span class=n>buf</span><span class=o>.</span><span class=na>writeBytes</span><span class=o>(</span><span class=n>LINE</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>buf</span><span class=o>.</span><span class=na>writeBytes</span><span class=o>(</span><span class=s>&#34;set&#34;</span><span class=o>.</span><span class=na>getBytes</span><span class=o>());</span>
</span></span><span class=line><span class=cl>                    <span class=n>buf</span><span class=o>.</span><span class=na>writeBytes</span><span class=o>(</span><span class=n>LINE</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>buf</span><span class=o>.</span><span class=na>writeBytes</span><span class=o>(</span><span class=s>&#34;$3&#34;</span><span class=o>.</span><span class=na>getBytes</span><span class=o>());</span>
</span></span><span class=line><span class=cl>                    <span class=n>buf</span><span class=o>.</span><span class=na>writeBytes</span><span class=o>(</span><span class=n>LINE</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>buf</span><span class=o>.</span><span class=na>writeBytes</span><span class=o>(</span><span class=s>&#34;aaa&#34;</span><span class=o>.</span><span class=na>getBytes</span><span class=o>());</span>
</span></span><span class=line><span class=cl>                    <span class=n>buf</span><span class=o>.</span><span class=na>writeBytes</span><span class=o>(</span><span class=n>LINE</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>buf</span><span class=o>.</span><span class=na>writeBytes</span><span class=o>(</span><span class=s>&#34;$3&#34;</span><span class=o>.</span><span class=na>getBytes</span><span class=o>());</span>
</span></span><span class=line><span class=cl>                    <span class=n>buf</span><span class=o>.</span><span class=na>writeBytes</span><span class=o>(</span><span class=n>LINE</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>buf</span><span class=o>.</span><span class=na>writeBytes</span><span class=o>(</span><span class=s>&#34;bbb&#34;</span><span class=o>.</span><span class=na>getBytes</span><span class=o>());</span>
</span></span><span class=line><span class=cl>                    <span class=n>buf</span><span class=o>.</span><span class=na>writeBytes</span><span class=o>(</span><span class=n>LINE</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>ctx</span><span class=o>.</span><span class=na>writeAndFlush</span><span class=o>(</span><span class=n>buf</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>                <span class=kd>public</span> <span class=kt>void</span> <span class=nf>channelRead</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>,</span> <span class=n>Object</span> <span class=n>msg</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>ByteBuf</span> <span class=n>buf</span> <span class=o>=</span> <span class=o>(</span><span class=n>ByteBuf</span><span class=o>)</span> <span class=n>msg</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>buf</span><span class=o>.</span><span class=na>toString</span><span class=o>(</span><span class=n>Charset</span><span class=o>.</span><span class=na>defaultCharset</span><span class=o>()));</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>});</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>});</span>
</span></span><span class=line><span class=cl>    <span class=n>ChannelFuture</span> <span class=n>channelFuture</span> <span class=o>=</span> <span class=n>bootstrap</span><span class=o>.</span><span class=na>connect</span><span class=o>(</span><span class=s>&#34;localhost&#34;</span><span class=o>,</span> <span class=n>6379</span><span class=o>).</span><span class=na>sync</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>channelFuture</span><span class=o>.</span><span class=na>channel</span><span class=o>().</span><span class=na>closeFuture</span><span class=o>().</span><span class=na>sync</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>log</span><span class=o>.</span><span class=na>error</span><span class=o>(</span><span class=s>&#34;client error&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>worker</span><span class=o>.</span><span class=na>shutdownGracefully</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#23-http-åè®®ä¸¾ä¾‹><h3 id=23-http-åè®®ä¸¾ä¾‹><span class=hanchor arialabel=Anchor># </span>2.3 http åè®®ä¸¾ä¾‹</h3></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>NioEventLoopGroup</span> <span class=n>boss</span> <span class=o>=</span> <span class=k>new</span> <span class=n>NioEventLoopGroup</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=n>NioEventLoopGroup</span> <span class=n>worker</span> <span class=o>=</span> <span class=k>new</span> <span class=n>NioEventLoopGroup</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ServerBootstrap</span> <span class=n>serverBootstrap</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ServerBootstrap</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>serverBootstrap</span><span class=o>.</span><span class=na>channel</span><span class=o>(</span><span class=n>NioServerSocketChannel</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>serverBootstrap</span><span class=o>.</span><span class=na>group</span><span class=o>(</span><span class=n>boss</span><span class=o>,</span> <span class=n>worker</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>serverBootstrap</span><span class=o>.</span><span class=na>childHandler</span><span class=o>(</span><span class=k>new</span> <span class=n>ChannelInitializer</span><span class=o>&lt;</span><span class=n>SocketChannel</span><span class=o>&gt;()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>initChannel</span><span class=o>(</span><span class=n>SocketChannel</span> <span class=n>ch</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>LoggingHandler</span><span class=o>(</span><span class=n>LogLevel</span><span class=o>.</span><span class=na>DEBUG</span><span class=o>));</span>
</span></span><span class=line><span class=cl>            <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>HttpServerCodec</span><span class=o>());</span>
</span></span><span class=line><span class=cl>            <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>SimpleChannelInboundHandler</span><span class=o>&lt;</span><span class=n>HttpRequest</span><span class=o>&gt;()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>                <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>channelRead0</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>,</span> <span class=n>HttpRequest</span> <span class=n>msg</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=c1>// è·å–è¯·æ±‚
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=n>msg</span><span class=o>.</span><span class=na>uri</span><span class=o>());</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                    <span class=c1>// è¿”å›å“åº”
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=n>DefaultFullHttpResponse</span> <span class=n>response</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>                            <span class=k>new</span> <span class=n>DefaultFullHttpResponse</span><span class=o>(</span><span class=n>msg</span><span class=o>.</span><span class=na>protocolVersion</span><span class=o>(),</span> <span class=n>HttpResponseStatus</span><span class=o>.</span><span class=na>OK</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                    <span class=kt>byte</span><span class=o>[]</span> <span class=n>bytes</span> <span class=o>=</span> <span class=s>&#34;&lt;h1&gt;Hello, world!&lt;/h1&gt;&#34;</span><span class=o>.</span><span class=na>getBytes</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                    <span class=n>response</span><span class=o>.</span><span class=na>headers</span><span class=o>().</span><span class=na>setInt</span><span class=o>(</span><span class=n>CONTENT_LENGTH</span><span class=o>,</span> <span class=n>bytes</span><span class=o>.</span><span class=na>length</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>response</span><span class=o>.</span><span class=na>content</span><span class=o>().</span><span class=na>writeBytes</span><span class=o>(</span><span class=n>bytes</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                    <span class=c1>// å†™å›å“åº”
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=n>ctx</span><span class=o>.</span><span class=na>writeAndFlush</span><span class=o>(</span><span class=n>response</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>});</span>
</span></span><span class=line><span class=cl>            <span class=cm>/*ch.pipeline().addLast(new ChannelInboundHandlerAdapter() {
</span></span></span><span class=line><span class=cl><span class=cm>                @Override
</span></span></span><span class=line><span class=cl><span class=cm>                public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception {
</span></span></span><span class=line><span class=cl><span class=cm>                    log.debug(&#34;{}&#34;, msg.getClass());
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>                    if (msg instanceof HttpRequest) { // è¯·æ±‚è¡Œï¼Œè¯·æ±‚å¤´
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>                    } else if (msg instanceof HttpContent) { //è¯·æ±‚ä½“
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>                    }
</span></span></span><span class=line><span class=cl><span class=cm>                }
</span></span></span><span class=line><span class=cl><span class=cm>            });*/</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>});</span>
</span></span><span class=line><span class=cl>    <span class=n>ChannelFuture</span> <span class=n>channelFuture</span> <span class=o>=</span> <span class=n>serverBootstrap</span><span class=o>.</span><span class=na>bind</span><span class=o>(</span><span class=n>8080</span><span class=o>).</span><span class=na>sync</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>channelFuture</span><span class=o>.</span><span class=na>channel</span><span class=o>().</span><span class=na>closeFuture</span><span class=o>().</span><span class=na>sync</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>log</span><span class=o>.</span><span class=na>error</span><span class=o>(</span><span class=s>&#34;server error&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>boss</span><span class=o>.</span><span class=na>shutdownGracefully</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>worker</span><span class=o>.</span><span class=na>shutdownGracefully</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#24-è‡ªå®šä¹‰åè®®è¦ç´ ><h3 id=24-è‡ªå®šä¹‰åè®®è¦ç´ ><span class=hanchor arialabel=Anchor># </span>2.4 è‡ªå®šä¹‰åè®®è¦ç´ </h3></a><ul><li>é­”æ•°ï¼Œç”¨æ¥åœ¨ç¬¬ä¸€æ—¶é—´åˆ¤å®šæ˜¯å¦æ˜¯æ— æ•ˆæ•°æ®åŒ…</li><li>ç‰ˆæœ¬å·ï¼Œå¯ä»¥æ”¯æŒåè®®çš„å‡çº§</li><li>åºåˆ—åŒ–ç®—æ³•ï¼Œæ¶ˆæ¯æ­£æ–‡åˆ°åº•é‡‡ç”¨å“ªç§åºåˆ—åŒ–ååºåˆ—åŒ–æ–¹å¼ï¼Œå¯ä»¥ç”±æ­¤æ‰©å±•ï¼Œä¾‹å¦‚ï¼šjsonã€protobufã€hessianã€jdkï¼ˆæ€§èƒ½å·®ã€éè·¨å¹³å°ï¼‰</li><li>æŒ‡ä»¤ç±»å‹ï¼Œæ˜¯ç™»å½•ã€æ³¨å†Œã€å•èŠã€ç¾¤èŠ&mldr; è·Ÿä¸šåŠ¡ç›¸å…³</li><li>è¯·æ±‚åºå·ï¼Œä¸ºäº†åŒå·¥é€šä¿¡ï¼Œ</li><li>æ­£æ–‡é•¿åº¦</li><li>æ¶ˆæ¯æ­£æ–‡</li></ul><a href=#ç¼–è§£ç å™¨><h4 id=ç¼–è§£ç å™¨><span class=hanchor arialabel=Anchor># </span>ç¼–è§£ç å™¨</h4></a><p>æ ¹æ®ä¸Šé¢çš„è¦ç´ ï¼Œè®¾è®¡ä¸€ä¸ªç™»å½•è¯·æ±‚æ¶ˆæ¯å’Œç™»å½•å“åº”æ¶ˆæ¯ï¼Œå¹¶ä½¿ç”¨ Netty å®Œæˆæ”¶å‘</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>MessageCodec</span> <span class=kd>extends</span> <span class=n>ByteToMessageCodec</span><span class=o>&lt;</span><span class=n>Message</span><span class=o>&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>encode</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>,</span> <span class=n>Message</span> <span class=n>msg</span><span class=o>,</span> <span class=n>ByteBuf</span> <span class=n>out</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 1. 4 å­—èŠ‚çš„é­”æ•°
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>out</span><span class=o>.</span><span class=na>writeBytes</span><span class=o>(</span><span class=k>new</span> <span class=kt>byte</span><span class=o>[]{</span><span class=n>1</span><span class=o>,</span> <span class=n>2</span><span class=o>,</span> <span class=n>3</span><span class=o>,</span> <span class=n>4</span><span class=o>});</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 2. 1 å­—èŠ‚çš„ç‰ˆæœ¬,
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>out</span><span class=o>.</span><span class=na>writeByte</span><span class=o>(</span><span class=n>1</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 3. 1 å­—èŠ‚çš„åºåˆ—åŒ–æ–¹å¼ jdk 0 , json 1
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>out</span><span class=o>.</span><span class=na>writeByte</span><span class=o>(</span><span class=n>0</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 4. 1 å­—èŠ‚çš„æŒ‡ä»¤ç±»å‹
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>out</span><span class=o>.</span><span class=na>writeByte</span><span class=o>(</span><span class=n>msg</span><span class=o>.</span><span class=na>getMessageType</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 5. 4 ä¸ªå­—èŠ‚
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>out</span><span class=o>.</span><span class=na>writeInt</span><span class=o>(</span><span class=n>msg</span><span class=o>.</span><span class=na>getSequenceId</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=c1>// æ— æ„ä¹‰ï¼Œå¯¹é½å¡«å……
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>out</span><span class=o>.</span><span class=na>writeByte</span><span class=o>(</span><span class=n>0xff</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 6. è·å–å†…å®¹çš„å­—èŠ‚æ•°ç»„
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>ByteArrayOutputStream</span> <span class=n>bos</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ByteArrayOutputStream</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>ObjectOutputStream</span> <span class=n>oos</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ObjectOutputStream</span><span class=o>(</span><span class=n>bos</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>oos</span><span class=o>.</span><span class=na>writeObject</span><span class=o>(</span><span class=n>msg</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=kt>byte</span><span class=o>[]</span> <span class=n>bytes</span> <span class=o>=</span> <span class=n>bos</span><span class=o>.</span><span class=na>toByteArray</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 7. é•¿åº¦
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>out</span><span class=o>.</span><span class=na>writeInt</span><span class=o>(</span><span class=n>bytes</span><span class=o>.</span><span class=na>length</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 8. å†™å…¥å†…å®¹
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>out</span><span class=o>.</span><span class=na>writeBytes</span><span class=o>(</span><span class=n>bytes</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>decode</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>,</span> <span class=n>ByteBuf</span> <span class=n>in</span><span class=o>,</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span> <span class=n>out</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>magicNum</span> <span class=o>=</span> <span class=n>in</span><span class=o>.</span><span class=na>readInt</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=kt>byte</span> <span class=n>version</span> <span class=o>=</span> <span class=n>in</span><span class=o>.</span><span class=na>readByte</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=kt>byte</span> <span class=n>serializerType</span> <span class=o>=</span> <span class=n>in</span><span class=o>.</span><span class=na>readByte</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=kt>byte</span> <span class=n>messageType</span> <span class=o>=</span> <span class=n>in</span><span class=o>.</span><span class=na>readByte</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>sequenceId</span> <span class=o>=</span> <span class=n>in</span><span class=o>.</span><span class=na>readInt</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>in</span><span class=o>.</span><span class=na>readByte</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>length</span> <span class=o>=</span> <span class=n>in</span><span class=o>.</span><span class=na>readInt</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=kt>byte</span><span class=o>[]</span> <span class=n>bytes</span> <span class=o>=</span> <span class=k>new</span> <span class=kt>byte</span><span class=o>[</span><span class=n>length</span><span class=o>];</span>
</span></span><span class=line><span class=cl>        <span class=n>in</span><span class=o>.</span><span class=na>readBytes</span><span class=o>(</span><span class=n>bytes</span><span class=o>,</span> <span class=n>0</span><span class=o>,</span> <span class=n>length</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>ObjectInputStream</span> <span class=n>ois</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ObjectInputStream</span><span class=o>(</span><span class=k>new</span> <span class=n>ByteArrayInputStream</span><span class=o>(</span><span class=n>bytes</span><span class=o>));</span>
</span></span><span class=line><span class=cl>        <span class=n>Message</span> <span class=n>message</span> <span class=o>=</span> <span class=o>(</span><span class=n>Message</span><span class=o>)</span> <span class=n>ois</span><span class=o>.</span><span class=na>readObject</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;{}, {}, {}, {}, {}, {}&#34;</span><span class=o>,</span> <span class=n>magicNum</span><span class=o>,</span> <span class=n>version</span><span class=o>,</span> <span class=n>serializerType</span><span class=o>,</span> <span class=n>messageType</span><span class=o>,</span> <span class=n>sequenceId</span><span class=o>,</span> <span class=n>length</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;{}&#34;</span><span class=o>,</span> <span class=n>message</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>out</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>message</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>æµ‹è¯•</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>EmbeddedChannel</span> <span class=n>channel</span> <span class=o>=</span> <span class=k>new</span> <span class=n>EmbeddedChannel</span><span class=o>(</span>
</span></span><span class=line><span class=cl>    <span class=k>new</span> <span class=n>LoggingHandler</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>    <span class=k>new</span> <span class=n>LengthFieldBasedFrameDecoder</span><span class=o>(</span>
</span></span><span class=line><span class=cl>        <span class=n>1024</span><span class=o>,</span> <span class=n>12</span><span class=o>,</span> <span class=n>4</span><span class=o>,</span> <span class=n>0</span><span class=o>,</span> <span class=n>0</span><span class=o>),</span>
</span></span><span class=line><span class=cl>    <span class=k>new</span> <span class=n>MessageCodec</span><span class=o>()</span>
</span></span><span class=line><span class=cl><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=c1>// encode
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>LoginRequestMessage</span> <span class=n>message</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LoginRequestMessage</span><span class=o>(</span><span class=s>&#34;zhangsan&#34;</span><span class=o>,</span> <span class=s>&#34;123&#34;</span><span class=o>,</span> <span class=s>&#34;å¼ ä¸‰&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=c1>//        channel.writeOutbound(message);
</span></span></span><span class=line><span class=cl><span class=c1>// decode
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>ByteBuf</span> <span class=n>buf</span> <span class=o>=</span> <span class=n>ByteBufAllocator</span><span class=o>.</span><span class=na>DEFAULT</span><span class=o>.</span><span class=na>buffer</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=k>new</span> <span class=n>MessageCodec</span><span class=o>().</span><span class=na>encode</span><span class=o>(</span><span class=kc>null</span><span class=o>,</span> <span class=n>message</span><span class=o>,</span> <span class=n>buf</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ByteBuf</span> <span class=n>s1</span> <span class=o>=</span> <span class=n>buf</span><span class=o>.</span><span class=na>slice</span><span class=o>(</span><span class=n>0</span><span class=o>,</span> <span class=n>100</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>ByteBuf</span> <span class=n>s2</span> <span class=o>=</span> <span class=n>buf</span><span class=o>.</span><span class=na>slice</span><span class=o>(</span><span class=n>100</span><span class=o>,</span> <span class=n>buf</span><span class=o>.</span><span class=na>readableBytes</span><span class=o>()</span> <span class=o>-</span> <span class=n>100</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>s1</span><span class=o>.</span><span class=na>retain</span><span class=o>();</span> <span class=c1>// å¼•ç”¨è®¡æ•° 2
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>channel</span><span class=o>.</span><span class=na>writeInbound</span><span class=o>(</span><span class=n>s1</span><span class=o>);</span> <span class=c1>// release 1
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>channel</span><span class=o>.</span><span class=na>writeInbound</span><span class=o>(</span><span class=n>s2</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><p>è§£è¯»</p><p><img src=/z-oblib/z2-attachments/0013.png width=auto></p><a href=#æ³¨æ„åŠåŒ…><h5 id=æ³¨æ„åŠåŒ…><span class=hanchor arialabel=Anchor># </span>æ³¨æ„åŠåŒ…</h5></a><p>è™½ç„¶åè®®æŒ‡å®šäº†æ•°æ®é•¿åº¦ï¼Œå¯ä»¥è§£å†³ç²˜åŒ…é—®é¢˜ï¼Œä½†æ˜¯åŠåŒ…é—®é¢˜è¿˜è¦æ³¨æ„ï¼š
å¦‚æœåŠåŒ…äº†ï¼Œé‚£ä¹ˆhandlerå°±ä¸åº”è¯¥ç»§ç»­å¾€ä¸‹å¤„ç†ï¼Œå› ä¸ºæ­¤æ—¶ååºåˆ—åŒ–ä¼šå¤±è´¥ï¼ˆå®é™…é•¿åº¦å°äºæŒ‡å®šé•¿åº¦ï¼Œè¶Šç•Œè¯»ï¼‰ã€‚
éœ€è¦å…ˆç”¨å¸§è§£ç å™¨åŒ…è£…åŒ…çš„å®Œæ•´æ€§ã€‚</p><a href=#-ä»€ä¹ˆæ—¶å€™å¯ä»¥åŠ -sharable><h4 id=-ä»€ä¹ˆæ—¶å€™å¯ä»¥åŠ -sharable><span class=hanchor arialabel=Anchor># </span>ğŸ’¡ ä»€ä¹ˆæ—¶å€™å¯ä»¥åŠ  @Sharable</h4></a><ul><li>å½“ handler <strong>ä¸ä¿å­˜çŠ¶æ€</strong>ï¼ˆæˆå‘˜å˜é‡ï¼‰æ—¶ï¼Œå°±å¯ä»¥å®‰å…¨åœ°åœ¨å¤šçº¿ç¨‹ä¸‹è¢«å…±äº«ï¼ˆä¾‹å¦‚LoggingHandlerå¯ä»¥å…±äº«ï¼ŒLengthFieldBasedFrameDecoderä¸èƒ½å…±äº«ï¼‰ã€‚</li><li>ä½†è¦æ³¨æ„å¯¹äºç¼–è§£ç å™¨ç±»ï¼Œä¸èƒ½ç»§æ‰¿ ByteToMessageCodec æˆ– CombinedChannelDuplexHandler çˆ¶ç±»ï¼Œä»–ä»¬çš„æ„é€ æ–¹æ³•å¯¹ @Sharable æœ‰é™åˆ¶<ul><li>nettyè®¤ä¸ºä½ å¦‚æœç»§æ‰¿äº†è¿™ä¸¤ä¸ªçˆ¶ç±»ï¼Œé‚£ä¹ˆä½ å°±åº”è¯¥æ˜¯ä¼šä¿å­˜çŠ¶æ€çš„ï¼ˆä¸ç®¡ä½ å®é™…ä¸Šæ˜¯å¦è¿™ä¹ˆåšäº†ï¼‰</li></ul></li><li>å¦‚æœèƒ½ç¡®ä¿ç¼–è§£ç å™¨<strong>ä¸ä¼š</strong>ä¿å­˜çŠ¶æ€ï¼Œå¯ä»¥ç»§æ‰¿ MessageToMessageCodec çˆ¶ç±»</li></ul><blockquote><p>Byteä»£è¡¨rawçš„æ•°æ®ï¼Œå¯èƒ½ä¸å®Œæ•´ï¼ŒMessageä»£è¡¨æ˜¯ä¸€æ¡å®Œæ•´çš„æ¶ˆæ¯äº†ã€‚</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span>
</span></span><span class=line><span class=cl><span class=nd>@ChannelHandler.Sharable</span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * å¿…é¡»å’Œ LengthFieldBasedFrameDecoder ä¸€èµ·ä½¿ç”¨ï¼Œç¡®ä¿æ¥åˆ°çš„ ByteBuf æ¶ˆæ¯æ˜¯å®Œæ•´çš„
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>MessageCodecSharable</span> <span class=kd>extends</span> <span class=n>MessageToMessageCodec</span><span class=o>&lt;</span><span class=n>ByteBuf</span><span class=o>,</span> <span class=n>Message</span><span class=o>&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>encode</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>,</span> <span class=n>Message</span> <span class=n>msg</span><span class=o>,</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span> <span class=n>outList</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ByteBuf</span> <span class=n>out</span> <span class=o>=</span> <span class=n>ctx</span><span class=o>.</span><span class=na>alloc</span><span class=o>().</span><span class=na>buffer</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 1. 4 å­—èŠ‚çš„é­”æ•°
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>out</span><span class=o>.</span><span class=na>writeBytes</span><span class=o>(</span><span class=k>new</span> <span class=kt>byte</span><span class=o>[]{</span><span class=n>1</span><span class=o>,</span> <span class=n>2</span><span class=o>,</span> <span class=n>3</span><span class=o>,</span> <span class=n>4</span><span class=o>});</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 2. 1 å­—èŠ‚çš„ç‰ˆæœ¬,
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>out</span><span class=o>.</span><span class=na>writeByte</span><span class=o>(</span><span class=n>1</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 3. 1 å­—èŠ‚çš„åºåˆ—åŒ–æ–¹å¼ jdk 0 , json 1
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>out</span><span class=o>.</span><span class=na>writeByte</span><span class=o>(</span><span class=n>0</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 4. 1 å­—èŠ‚çš„æŒ‡ä»¤ç±»å‹
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>out</span><span class=o>.</span><span class=na>writeByte</span><span class=o>(</span><span class=n>msg</span><span class=o>.</span><span class=na>getMessageType</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 5. 4 ä¸ªå­—èŠ‚
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>out</span><span class=o>.</span><span class=na>writeInt</span><span class=o>(</span><span class=n>msg</span><span class=o>.</span><span class=na>getSequenceId</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=c1>// æ— æ„ä¹‰ï¼Œå¯¹é½å¡«å……
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>out</span><span class=o>.</span><span class=na>writeByte</span><span class=o>(</span><span class=n>0xff</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 6. è·å–å†…å®¹çš„å­—èŠ‚æ•°ç»„
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>ByteArrayOutputStream</span> <span class=n>bos</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ByteArrayOutputStream</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>ObjectOutputStream</span> <span class=n>oos</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ObjectOutputStream</span><span class=o>(</span><span class=n>bos</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>oos</span><span class=o>.</span><span class=na>writeObject</span><span class=o>(</span><span class=n>msg</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=kt>byte</span><span class=o>[]</span> <span class=n>bytes</span> <span class=o>=</span> <span class=n>bos</span><span class=o>.</span><span class=na>toByteArray</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 7. é•¿åº¦
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>out</span><span class=o>.</span><span class=na>writeInt</span><span class=o>(</span><span class=n>bytes</span><span class=o>.</span><span class=na>length</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 8. å†™å…¥å†…å®¹
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>out</span><span class=o>.</span><span class=na>writeBytes</span><span class=o>(</span><span class=n>bytes</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>outList</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>out</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>decode</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>,</span> <span class=n>ByteBuf</span> <span class=n>in</span><span class=o>,</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span> <span class=n>out</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>magicNum</span> <span class=o>=</span> <span class=n>in</span><span class=o>.</span><span class=na>readInt</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=kt>byte</span> <span class=n>version</span> <span class=o>=</span> <span class=n>in</span><span class=o>.</span><span class=na>readByte</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=kt>byte</span> <span class=n>serializerType</span> <span class=o>=</span> <span class=n>in</span><span class=o>.</span><span class=na>readByte</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=kt>byte</span> <span class=n>messageType</span> <span class=o>=</span> <span class=n>in</span><span class=o>.</span><span class=na>readByte</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>sequenceId</span> <span class=o>=</span> <span class=n>in</span><span class=o>.</span><span class=na>readInt</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>in</span><span class=o>.</span><span class=na>readByte</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>length</span> <span class=o>=</span> <span class=n>in</span><span class=o>.</span><span class=na>readInt</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=kt>byte</span><span class=o>[]</span> <span class=n>bytes</span> <span class=o>=</span> <span class=k>new</span> <span class=kt>byte</span><span class=o>[</span><span class=n>length</span><span class=o>];</span>
</span></span><span class=line><span class=cl>        <span class=n>in</span><span class=o>.</span><span class=na>readBytes</span><span class=o>(</span><span class=n>bytes</span><span class=o>,</span> <span class=n>0</span><span class=o>,</span> <span class=n>length</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>ObjectInputStream</span> <span class=n>ois</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ObjectInputStream</span><span class=o>(</span><span class=k>new</span> <span class=n>ByteArrayInputStream</span><span class=o>(</span><span class=n>bytes</span><span class=o>));</span>
</span></span><span class=line><span class=cl>        <span class=n>Message</span> <span class=n>message</span> <span class=o>=</span> <span class=o>(</span><span class=n>Message</span><span class=o>)</span> <span class=n>ois</span><span class=o>.</span><span class=na>readObject</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;{}, {}, {}, {}, {}, {}&#34;</span><span class=o>,</span> <span class=n>magicNum</span><span class=o>,</span> <span class=n>version</span><span class=o>,</span> <span class=n>serializerType</span><span class=o>,</span> <span class=n>messageType</span><span class=o>,</span> <span class=n>sequenceId</span><span class=o>,</span> <span class=n>length</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;{}&#34;</span><span class=o>,</span> <span class=n>message</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>out</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>message</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#3-èŠå¤©å®¤æ¡ˆä¾‹><h2 id=3-èŠå¤©å®¤æ¡ˆä¾‹><span class=hanchor arialabel=Anchor># </span>3. èŠå¤©å®¤æ¡ˆä¾‹</h2></a><a href=#31-èŠå¤©å®¤ä¸šåŠ¡ä»‹ç»><h3 id=31-èŠå¤©å®¤ä¸šåŠ¡ä»‹ç»><span class=hanchor arialabel=Anchor># </span>3.1 èŠå¤©å®¤ä¸šåŠ¡ä»‹ç»</h3></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * ç”¨æˆ·ç®¡ç†æ¥å£
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>interface</span> <span class=nc>UserService</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * ç™»å½•
</span></span></span><span class=line><span class=cl><span class=cm>     * @param username ç”¨æˆ·å
</span></span></span><span class=line><span class=cl><span class=cm>     * @param password å¯†ç 
</span></span></span><span class=line><span class=cl><span class=cm>     * @return ç™»å½•æˆåŠŸè¿”å› true, å¦åˆ™è¿”å› false
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kt>boolean</span> <span class=nf>login</span><span class=o>(</span><span class=n>String</span> <span class=n>username</span><span class=o>,</span> <span class=n>String</span> <span class=n>password</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * ä¼šè¯ç®¡ç†æ¥å£
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>interface</span> <span class=nc>Session</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * ç»‘å®šä¼šè¯
</span></span></span><span class=line><span class=cl><span class=cm>     * @param channel å“ªä¸ª channel è¦ç»‘å®šä¼šè¯
</span></span></span><span class=line><span class=cl><span class=cm>     * @param username ä¼šè¯ç»‘å®šç”¨æˆ·
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=nf>bind</span><span class=o>(</span><span class=n>Channel</span> <span class=n>channel</span><span class=o>,</span> <span class=n>String</span> <span class=n>username</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * è§£ç»‘ä¼šè¯
</span></span></span><span class=line><span class=cl><span class=cm>     * @param channel å“ªä¸ª channel è¦è§£ç»‘ä¼šè¯
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=nf>unbind</span><span class=o>(</span><span class=n>Channel</span> <span class=n>channel</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * è·å–å±æ€§
</span></span></span><span class=line><span class=cl><span class=cm>     * @param channel å“ªä¸ª channel
</span></span></span><span class=line><span class=cl><span class=cm>     * @param name å±æ€§å
</span></span></span><span class=line><span class=cl><span class=cm>     * @return å±æ€§å€¼
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=n>Object</span> <span class=nf>getAttribute</span><span class=o>(</span><span class=n>Channel</span> <span class=n>channel</span><span class=o>,</span> <span class=n>String</span> <span class=n>name</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * è®¾ç½®å±æ€§
</span></span></span><span class=line><span class=cl><span class=cm>     * @param channel å“ªä¸ª channel
</span></span></span><span class=line><span class=cl><span class=cm>     * @param name å±æ€§å
</span></span></span><span class=line><span class=cl><span class=cm>     * @param value å±æ€§å€¼
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=nf>setAttribute</span><span class=o>(</span><span class=n>Channel</span> <span class=n>channel</span><span class=o>,</span> <span class=n>String</span> <span class=n>name</span><span class=o>,</span> <span class=n>Object</span> <span class=n>value</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * æ ¹æ®ç”¨æˆ·åè·å– channel
</span></span></span><span class=line><span class=cl><span class=cm>     * @param username ç”¨æˆ·å
</span></span></span><span class=line><span class=cl><span class=cm>     * @return channel
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=n>Channel</span> <span class=nf>getChannel</span><span class=o>(</span><span class=n>String</span> <span class=n>username</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * èŠå¤©ç»„ä¼šè¯ç®¡ç†æ¥å£
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>interface</span> <span class=nc>GroupSession</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * åˆ›å»ºä¸€ä¸ªèŠå¤©ç»„, å¦‚æœä¸å­˜åœ¨æ‰èƒ½åˆ›å»ºæˆåŠŸ, å¦åˆ™è¿”å› null
</span></span></span><span class=line><span class=cl><span class=cm>     * @param name ç»„å
</span></span></span><span class=line><span class=cl><span class=cm>     * @param members æˆå‘˜
</span></span></span><span class=line><span class=cl><span class=cm>     * @return æˆåŠŸæ—¶è¿”å›ç»„å¯¹è±¡, å¤±è´¥è¿”å› null
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=n>Group</span> <span class=nf>createGroup</span><span class=o>(</span><span class=n>String</span> <span class=n>name</span><span class=o>,</span> <span class=n>Set</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>members</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * åŠ å…¥èŠå¤©ç»„
</span></span></span><span class=line><span class=cl><span class=cm>     * @param name ç»„å
</span></span></span><span class=line><span class=cl><span class=cm>     * @param member æˆå‘˜å
</span></span></span><span class=line><span class=cl><span class=cm>     * @return å¦‚æœç»„ä¸å­˜åœ¨è¿”å› null, å¦åˆ™è¿”å›ç»„å¯¹è±¡
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=n>Group</span> <span class=nf>joinMember</span><span class=o>(</span><span class=n>String</span> <span class=n>name</span><span class=o>,</span> <span class=n>String</span> <span class=n>member</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * ç§»é™¤ç»„æˆå‘˜
</span></span></span><span class=line><span class=cl><span class=cm>     * @param name ç»„å
</span></span></span><span class=line><span class=cl><span class=cm>     * @param member æˆå‘˜å
</span></span></span><span class=line><span class=cl><span class=cm>     * @return å¦‚æœç»„ä¸å­˜åœ¨è¿”å› null, å¦åˆ™è¿”å›ç»„å¯¹è±¡
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=n>Group</span> <span class=nf>removeMember</span><span class=o>(</span><span class=n>String</span> <span class=n>name</span><span class=o>,</span> <span class=n>String</span> <span class=n>member</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * ç§»é™¤èŠå¤©ç»„
</span></span></span><span class=line><span class=cl><span class=cm>     * @param name ç»„å
</span></span></span><span class=line><span class=cl><span class=cm>     * @return å¦‚æœç»„ä¸å­˜åœ¨è¿”å› null, å¦åˆ™è¿”å›ç»„å¯¹è±¡
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=n>Group</span> <span class=nf>removeGroup</span><span class=o>(</span><span class=n>String</span> <span class=n>name</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * è·å–ç»„æˆå‘˜
</span></span></span><span class=line><span class=cl><span class=cm>     * @param name ç»„å
</span></span></span><span class=line><span class=cl><span class=cm>     * @return æˆå‘˜é›†åˆ, æ²¡æœ‰æˆå‘˜ä¼šè¿”å› empty set
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=n>Set</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=nf>getMembers</span><span class=o>(</span><span class=n>String</span> <span class=n>name</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * è·å–ç»„æˆå‘˜çš„ channel é›†åˆ, åªæœ‰åœ¨çº¿çš„ channel æ‰ä¼šè¿”å›
</span></span></span><span class=line><span class=cl><span class=cm>     * @param name ç»„å
</span></span></span><span class=line><span class=cl><span class=cm>     * @return æˆå‘˜ channel é›†åˆ
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=n>List</span><span class=o>&lt;</span><span class=n>Channel</span><span class=o>&gt;</span> <span class=nf>getMembersChannel</span><span class=o>(</span><span class=n>String</span> <span class=n>name</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#32-èŠå¤©å®¤ä¸šåŠ¡-ç™»å½•><h3 id=32-èŠå¤©å®¤ä¸šåŠ¡-ç™»å½•><span class=hanchor arialabel=Anchor># </span>3.2 èŠå¤©å®¤ä¸šåŠ¡-ç™»å½•</h3></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>ChatServer</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>NioEventLoopGroup</span> <span class=n>boss</span> <span class=o>=</span> <span class=k>new</span> <span class=n>NioEventLoopGroup</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>NioEventLoopGroup</span> <span class=n>worker</span> <span class=o>=</span> <span class=k>new</span> <span class=n>NioEventLoopGroup</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>LoggingHandler</span> <span class=n>LOGGING_HANDLER</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LoggingHandler</span><span class=o>(</span><span class=n>LogLevel</span><span class=o>.</span><span class=na>DEBUG</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>MessageCodecSharable</span> <span class=n>MESSAGE_CODEC</span> <span class=o>=</span> <span class=k>new</span> <span class=n>MessageCodecSharable</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>ServerBootstrap</span> <span class=n>serverBootstrap</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ServerBootstrap</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>serverBootstrap</span><span class=o>.</span><span class=na>channel</span><span class=o>(</span><span class=n>NioServerSocketChannel</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>serverBootstrap</span><span class=o>.</span><span class=na>group</span><span class=o>(</span><span class=n>boss</span><span class=o>,</span> <span class=n>worker</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>serverBootstrap</span><span class=o>.</span><span class=na>childHandler</span><span class=o>(</span><span class=k>new</span> <span class=n>ChannelInitializer</span><span class=o>&lt;</span><span class=n>SocketChannel</span><span class=o>&gt;()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>                <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>initChannel</span><span class=o>(</span><span class=n>SocketChannel</span> <span class=n>ch</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>ProcotolFrameDecoder</span><span class=o>());</span>
</span></span><span class=line><span class=cl>                    <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=n>LOGGING_HANDLER</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=n>MESSAGE_CODEC</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>SimpleChannelInboundHandler</span><span class=o>&lt;</span><span class=n>LoginRequestMessage</span><span class=o>&gt;()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>                        <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>channelRead0</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>,</span> <span class=n>LoginRequestMessage</span> <span class=n>msg</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                            <span class=n>String</span> <span class=n>username</span> <span class=o>=</span> <span class=n>msg</span><span class=o>.</span><span class=na>getUsername</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                            <span class=n>String</span> <span class=n>password</span> <span class=o>=</span> <span class=n>msg</span><span class=o>.</span><span class=na>getPassword</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                            <span class=kt>boolean</span> <span class=n>login</span> <span class=o>=</span> <span class=n>UserServiceFactory</span><span class=o>.</span><span class=na>getUserService</span><span class=o>().</span><span class=na>login</span><span class=o>(</span><span class=n>username</span><span class=o>,</span> <span class=n>password</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                            <span class=n>LoginResponseMessage</span> <span class=n>message</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                            <span class=k>if</span><span class=o>(</span><span class=n>login</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                                <span class=n>message</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LoginResponseMessage</span><span class=o>(</span><span class=kc>true</span><span class=o>,</span> <span class=s>&#34;ç™»å½•æˆåŠŸ&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                            <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                                <span class=n>message</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LoginResponseMessage</span><span class=o>(</span><span class=kc>false</span><span class=o>,</span> <span class=s>&#34;ç”¨æˆ·åæˆ–å¯†ç ä¸æ­£ç¡®&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                            <span class=o>}</span>
</span></span><span class=line><span class=cl>                            <span class=n>ctx</span><span class=o>.</span><span class=na>writeAndFlush</span><span class=o>(</span><span class=n>message</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                        <span class=o>}</span>
</span></span><span class=line><span class=cl>                    <span class=o>});</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>});</span>
</span></span><span class=line><span class=cl>            <span class=n>Channel</span> <span class=n>channel</span> <span class=o>=</span> <span class=n>serverBootstrap</span><span class=o>.</span><span class=na>bind</span><span class=o>(</span><span class=n>8080</span><span class=o>).</span><span class=na>sync</span><span class=o>().</span><span class=na>channel</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>channel</span><span class=o>.</span><span class=na>closeFuture</span><span class=o>().</span><span class=na>sync</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=o>.</span><span class=na>error</span><span class=o>(</span><span class=s>&#34;server error&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>boss</span><span class=o>.</span><span class=na>shutdownGracefully</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>worker</span><span class=o>.</span><span class=na>shutdownGracefully</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>ChatClient</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>NioEventLoopGroup</span> <span class=n>group</span> <span class=o>=</span> <span class=k>new</span> <span class=n>NioEventLoopGroup</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>LoggingHandler</span> <span class=n>LOGGING_HANDLER</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LoggingHandler</span><span class=o>(</span><span class=n>LogLevel</span><span class=o>.</span><span class=na>DEBUG</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>MessageCodecSharable</span> <span class=n>MESSAGE_CODEC</span> <span class=o>=</span> <span class=k>new</span> <span class=n>MessageCodecSharable</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>CountDownLatch</span> <span class=n>WAIT_FOR_LOGIN</span> <span class=o>=</span> <span class=k>new</span> <span class=n>CountDownLatch</span><span class=o>(</span><span class=n>1</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>AtomicBoolean</span> <span class=n>LOGIN</span> <span class=o>=</span> <span class=k>new</span> <span class=n>AtomicBoolean</span><span class=o>(</span><span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Bootstrap</span> <span class=n>bootstrap</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Bootstrap</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>bootstrap</span><span class=o>.</span><span class=na>channel</span><span class=o>(</span><span class=n>NioSocketChannel</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>bootstrap</span><span class=o>.</span><span class=na>group</span><span class=o>(</span><span class=n>group</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>bootstrap</span><span class=o>.</span><span class=na>handler</span><span class=o>(</span><span class=k>new</span> <span class=n>ChannelInitializer</span><span class=o>&lt;</span><span class=n>SocketChannel</span><span class=o>&gt;()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>                <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>initChannel</span><span class=o>(</span><span class=n>SocketChannel</span> <span class=n>ch</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>ProcotolFrameDecoder</span><span class=o>());</span>
</span></span><span class=line><span class=cl><span class=c1>//                    ch.pipeline().addLast(LOGGING_HANDLER);
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=n>MESSAGE_CODEC</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=s>&#34;client handler&#34;</span><span class=o>,</span> <span class=k>new</span> <span class=n>ChannelInboundHandlerAdapter</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=c1>// æ¥æ”¶å“åº”æ¶ˆæ¯
</span></span></span><span class=line><span class=cl><span class=c1></span>                        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>                        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>channelRead</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>,</span> <span class=n>Object</span> <span class=n>msg</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                            <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;msg: {}&#34;</span><span class=o>,</span> <span class=n>msg</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                            <span class=k>if</span> <span class=o>((</span><span class=n>msg</span> <span class=k>instanceof</span> <span class=n>LoginResponseMessage</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                                <span class=n>LoginResponseMessage</span> <span class=n>response</span> <span class=o>=</span> <span class=o>(</span><span class=n>LoginResponseMessage</span><span class=o>)</span> <span class=n>msg</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                                <span class=k>if</span> <span class=o>(</span><span class=n>response</span><span class=o>.</span><span class=na>isSuccess</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                                    <span class=c1>// å¦‚æœç™»å½•æˆåŠŸ
</span></span></span><span class=line><span class=cl><span class=c1></span>                                    <span class=n>LOGIN</span><span class=o>.</span><span class=na>set</span><span class=o>(</span><span class=kc>true</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                                <span class=o>}</span>
</span></span><span class=line><span class=cl>                                <span class=c1>// å”¤é†’ system in çº¿ç¨‹
</span></span></span><span class=line><span class=cl><span class=c1></span>                                <span class=n>WAIT_FOR_LOGIN</span><span class=o>.</span><span class=na>countDown</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                            <span class=o>}</span>
</span></span><span class=line><span class=cl>                        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                        <span class=c1>// åœ¨è¿æ¥å»ºç«‹åè§¦å‘ active äº‹ä»¶
</span></span></span><span class=line><span class=cl><span class=c1></span>                        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>                        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>channelActive</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                            <span class=c1>// è´Ÿè´£æ¥æ”¶ç”¨æˆ·åœ¨æ§åˆ¶å°çš„è¾“å…¥ï¼Œè´Ÿè´£å‘æœåŠ¡å™¨å‘é€å„ç§æ¶ˆæ¯
</span></span></span><span class=line><span class=cl><span class=c1></span>                            <span class=k>new</span> <span class=n>Thread</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                                <span class=n>Scanner</span> <span class=n>scanner</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Scanner</span><span class=o>(</span><span class=n>System</span><span class=o>.</span><span class=na>in</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                                <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;è¯·è¾“å…¥ç”¨æˆ·å:&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                                <span class=n>String</span> <span class=n>username</span> <span class=o>=</span> <span class=n>scanner</span><span class=o>.</span><span class=na>nextLine</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                                <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;è¯·è¾“å…¥å¯†ç :&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                                <span class=n>String</span> <span class=n>password</span> <span class=o>=</span> <span class=n>scanner</span><span class=o>.</span><span class=na>nextLine</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                                <span class=c1>// æ„é€ æ¶ˆæ¯å¯¹è±¡
</span></span></span><span class=line><span class=cl><span class=c1></span>                                <span class=n>LoginRequestMessage</span> <span class=n>message</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LoginRequestMessage</span><span class=o>(</span><span class=n>username</span><span class=o>,</span> <span class=n>password</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                                <span class=c1>// å‘é€æ¶ˆæ¯
</span></span></span><span class=line><span class=cl><span class=c1></span>                                <span class=n>ctx</span><span class=o>.</span><span class=na>writeAndFlush</span><span class=o>(</span><span class=n>message</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                                <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;ç­‰å¾…åç»­æ“ä½œ...&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                                <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                                    <span class=n>WAIT_FOR_LOGIN</span><span class=o>.</span><span class=na>await</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                                <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                                    <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                                <span class=o>}</span>
</span></span><span class=line><span class=cl>                                <span class=c1>// å¦‚æœç™»å½•å¤±è´¥
</span></span></span><span class=line><span class=cl><span class=c1></span>                                <span class=k>if</span> <span class=o>(!</span><span class=n>LOGIN</span><span class=o>.</span><span class=na>get</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                                    <span class=n>ctx</span><span class=o>.</span><span class=na>channel</span><span class=o>().</span><span class=na>close</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                                    <span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                                <span class=o>}</span>
</span></span><span class=line><span class=cl>                                <span class=k>while</span> <span class=o>(</span><span class=kc>true</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                                    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;==================================&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                                    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;send [username] [content]&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                                    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;gsend [group name] [content]&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                                    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;gcreate [group name] [m1,m2,m3...]&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                                    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;gmembers [group name]&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                                    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;gjoin [group name]&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                                    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;gquit [group name]&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                                    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;quit&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                                    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;==================================&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                                    <span class=n>String</span> <span class=n>command</span> <span class=o>=</span> <span class=n>scanner</span><span class=o>.</span><span class=na>nextLine</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                                    <span class=n>String</span><span class=o>[]</span> <span class=n>s</span> <span class=o>=</span> <span class=n>command</span><span class=o>.</span><span class=na>split</span><span class=o>(</span><span class=s>&#34; &#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                                    <span class=k>switch</span> <span class=o>(</span><span class=n>s</span><span class=o>[</span><span class=n>0</span><span class=o>]){</span>
</span></span><span class=line><span class=cl>                                        <span class=k>case</span> <span class=s>&#34;send&#34;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                                            <span class=n>ctx</span><span class=o>.</span><span class=na>writeAndFlush</span><span class=o>(</span><span class=k>new</span> <span class=n>ChatRequestMessage</span><span class=o>(</span><span class=n>username</span><span class=o>,</span> <span class=n>s</span><span class=o>[</span><span class=n>1</span><span class=o>],</span> <span class=n>s</span><span class=o>[</span><span class=n>2</span><span class=o>]));</span>
</span></span><span class=line><span class=cl>                                            <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                                        <span class=k>case</span> <span class=s>&#34;gsend&#34;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                                            <span class=n>ctx</span><span class=o>.</span><span class=na>writeAndFlush</span><span class=o>(</span><span class=k>new</span> <span class=n>GroupChatRequestMessage</span><span class=o>(</span><span class=n>username</span><span class=o>,</span> <span class=n>s</span><span class=o>[</span><span class=n>1</span><span class=o>],</span> <span class=n>s</span><span class=o>[</span><span class=n>2</span><span class=o>]));</span>
</span></span><span class=line><span class=cl>                                            <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                                        <span class=k>case</span> <span class=s>&#34;gcreate&#34;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                                            <span class=n>Set</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>set</span> <span class=o>=</span> <span class=k>new</span> <span class=n>HashSet</span><span class=o>&lt;&gt;(</span><span class=n>Arrays</span><span class=o>.</span><span class=na>asList</span><span class=o>(</span><span class=n>s</span><span class=o>[</span><span class=n>2</span><span class=o>].</span><span class=na>split</span><span class=o>(</span><span class=s>&#34;,&#34;</span><span class=o>)));</span>
</span></span><span class=line><span class=cl>                                            <span class=n>set</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>username</span><span class=o>);</span> <span class=c1>// åŠ å…¥è‡ªå·±
</span></span></span><span class=line><span class=cl><span class=c1></span>                                            <span class=n>ctx</span><span class=o>.</span><span class=na>writeAndFlush</span><span class=o>(</span><span class=k>new</span> <span class=n>GroupCreateRequestMessage</span><span class=o>(</span><span class=n>s</span><span class=o>[</span><span class=n>1</span><span class=o>],</span> <span class=n>set</span><span class=o>));</span>
</span></span><span class=line><span class=cl>                                            <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                                        <span class=k>case</span> <span class=s>&#34;gmembers&#34;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                                            <span class=n>ctx</span><span class=o>.</span><span class=na>writeAndFlush</span><span class=o>(</span><span class=k>new</span> <span class=n>GroupMembersRequestMessage</span><span class=o>(</span><span class=n>s</span><span class=o>[</span><span class=n>1</span><span class=o>]));</span>
</span></span><span class=line><span class=cl>                                            <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                                        <span class=k>case</span> <span class=s>&#34;gjoin&#34;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                                            <span class=n>ctx</span><span class=o>.</span><span class=na>writeAndFlush</span><span class=o>(</span><span class=k>new</span> <span class=n>GroupJoinRequestMessage</span><span class=o>(</span><span class=n>username</span><span class=o>,</span> <span class=n>s</span><span class=o>[</span><span class=n>1</span><span class=o>]));</span>
</span></span><span class=line><span class=cl>                                            <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                                        <span class=k>case</span> <span class=s>&#34;gquit&#34;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                                            <span class=n>ctx</span><span class=o>.</span><span class=na>writeAndFlush</span><span class=o>(</span><span class=k>new</span> <span class=n>GroupQuitRequestMessage</span><span class=o>(</span><span class=n>username</span><span class=o>,</span> <span class=n>s</span><span class=o>[</span><span class=n>1</span><span class=o>]));</span>
</span></span><span class=line><span class=cl>                                            <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                                        <span class=k>case</span> <span class=s>&#34;quit&#34;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                                            <span class=n>ctx</span><span class=o>.</span><span class=na>channel</span><span class=o>().</span><span class=na>close</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                                            <span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                                    <span class=o>}</span>
</span></span><span class=line><span class=cl>                                <span class=o>}</span>
</span></span><span class=line><span class=cl>                            <span class=o>},</span> <span class=s>&#34;system in&#34;</span><span class=o>).</span><span class=na>start</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                        <span class=o>}</span>
</span></span><span class=line><span class=cl>                    <span class=o>});</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>});</span>
</span></span><span class=line><span class=cl>            <span class=n>Channel</span> <span class=n>channel</span> <span class=o>=</span> <span class=n>bootstrap</span><span class=o>.</span><span class=na>connect</span><span class=o>(</span><span class=s>&#34;localhost&#34;</span><span class=o>,</span> <span class=n>8080</span><span class=o>).</span><span class=na>sync</span><span class=o>().</span><span class=na>channel</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>channel</span><span class=o>.</span><span class=na>closeFuture</span><span class=o>().</span><span class=na>sync</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Exception</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=o>.</span><span class=na>error</span><span class=o>(</span><span class=s>&#34;client error&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>group</span><span class=o>.</span><span class=na>shutdownGracefully</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#33-èŠå¤©å®¤ä¸šåŠ¡-å•èŠ><h3 id=33-èŠå¤©å®¤ä¸šåŠ¡-å•èŠ><span class=hanchor arialabel=Anchor># </span>3.3 èŠå¤©å®¤ä¸šåŠ¡-å•èŠ</h3></a><p>æœåŠ¡å™¨ç«¯å°† handler ç‹¬ç«‹å‡ºæ¥</p><p>ç™»å½• handler</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@ChannelHandler.Sharable</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>LoginRequestMessageHandler</span> <span class=kd>extends</span> <span class=n>SimpleChannelInboundHandler</span><span class=o>&lt;</span><span class=n>LoginRequestMessage</span><span class=o>&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>channelRead0</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>,</span> <span class=n>LoginRequestMessage</span> <span class=n>msg</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>String</span> <span class=n>username</span> <span class=o>=</span> <span class=n>msg</span><span class=o>.</span><span class=na>getUsername</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>String</span> <span class=n>password</span> <span class=o>=</span> <span class=n>msg</span><span class=o>.</span><span class=na>getPassword</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=kt>boolean</span> <span class=n>login</span> <span class=o>=</span> <span class=n>UserServiceFactory</span><span class=o>.</span><span class=na>getUserService</span><span class=o>().</span><span class=na>login</span><span class=o>(</span><span class=n>username</span><span class=o>,</span> <span class=n>password</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>LoginResponseMessage</span> <span class=n>message</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=o>(</span><span class=n>login</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>SessionFactory</span><span class=o>.</span><span class=na>getSession</span><span class=o>().</span><span class=na>bind</span><span class=o>(</span><span class=n>ctx</span><span class=o>.</span><span class=na>channel</span><span class=o>(),</span> <span class=n>username</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>message</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LoginResponseMessage</span><span class=o>(</span><span class=kc>true</span><span class=o>,</span> <span class=s>&#34;ç™»å½•æˆåŠŸ&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>message</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LoginResponseMessage</span><span class=o>(</span><span class=kc>false</span><span class=o>,</span> <span class=s>&#34;ç”¨æˆ·åæˆ–å¯†ç ä¸æ­£ç¡®&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=n>ctx</span><span class=o>.</span><span class=na>writeAndFlush</span><span class=o>(</span><span class=n>message</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å•èŠ handler</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@ChannelHandler.Sharable</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>ChatRequestMessageHandler</span> <span class=kd>extends</span> <span class=n>SimpleChannelInboundHandler</span><span class=o>&lt;</span><span class=n>ChatRequestMessage</span><span class=o>&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>channelRead0</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>,</span> <span class=n>ChatRequestMessage</span> <span class=n>msg</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>String</span> <span class=n>to</span> <span class=o>=</span> <span class=n>msg</span><span class=o>.</span><span class=na>getTo</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>Channel</span> <span class=n>channel</span> <span class=o>=</span> <span class=n>SessionFactory</span><span class=o>.</span><span class=na>getSession</span><span class=o>().</span><span class=na>getChannel</span><span class=o>(</span><span class=n>to</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// åœ¨çº¿
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span><span class=o>(</span><span class=n>channel</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>channel</span><span class=o>.</span><span class=na>writeAndFlush</span><span class=o>(</span><span class=k>new</span> <span class=n>ChatResponseMessage</span><span class=o>(</span><span class=n>msg</span><span class=o>.</span><span class=na>getFrom</span><span class=o>(),</span> <span class=n>msg</span><span class=o>.</span><span class=na>getContent</span><span class=o>()));</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>// ä¸åœ¨çº¿
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>ctx</span><span class=o>.</span><span class=na>writeAndFlush</span><span class=o>(</span><span class=k>new</span> <span class=n>ChatResponseMessage</span><span class=o>(</span><span class=kc>false</span><span class=o>,</span> <span class=s>&#34;å¯¹æ–¹ç”¨æˆ·ä¸å­˜åœ¨æˆ–è€…ä¸åœ¨çº¿&#34;</span><span class=o>));</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#34-èŠå¤©å®¤ä¸šåŠ¡-ç¾¤èŠ><h3 id=34-èŠå¤©å®¤ä¸šåŠ¡-ç¾¤èŠ><span class=hanchor arialabel=Anchor># </span>3.4 èŠå¤©å®¤ä¸šåŠ¡-ç¾¤èŠ</h3></a><p>åˆ›å»ºç¾¤èŠ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@ChannelHandler.Sharable</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>GroupCreateRequestMessageHandler</span> <span class=kd>extends</span> <span class=n>SimpleChannelInboundHandler</span><span class=o>&lt;</span><span class=n>GroupCreateRequestMessage</span><span class=o>&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>channelRead0</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>,</span> <span class=n>GroupCreateRequestMessage</span> <span class=n>msg</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>String</span> <span class=n>groupName</span> <span class=o>=</span> <span class=n>msg</span><span class=o>.</span><span class=na>getGroupName</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>Set</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>members</span> <span class=o>=</span> <span class=n>msg</span><span class=o>.</span><span class=na>getMembers</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=c1>// ç¾¤ç®¡ç†å™¨
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>GroupSession</span> <span class=n>groupSession</span> <span class=o>=</span> <span class=n>GroupSessionFactory</span><span class=o>.</span><span class=na>getGroupSession</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>Group</span> <span class=n>group</span> <span class=o>=</span> <span class=n>groupSession</span><span class=o>.</span><span class=na>createGroup</span><span class=o>(</span><span class=n>groupName</span><span class=o>,</span> <span class=n>members</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>group</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// å‘ç”ŸæˆåŠŸæ¶ˆæ¯
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>ctx</span><span class=o>.</span><span class=na>writeAndFlush</span><span class=o>(</span><span class=k>new</span> <span class=n>GroupCreateResponseMessage</span><span class=o>(</span><span class=kc>true</span><span class=o>,</span> <span class=n>groupName</span> <span class=o>+</span> <span class=s>&#34;åˆ›å»ºæˆåŠŸ&#34;</span><span class=o>));</span>
</span></span><span class=line><span class=cl>            <span class=c1>// å‘é€æ‹‰ç¾¤æ¶ˆæ¯
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>List</span><span class=o>&lt;</span><span class=n>Channel</span><span class=o>&gt;</span> <span class=n>channels</span> <span class=o>=</span> <span class=n>groupSession</span><span class=o>.</span><span class=na>getMembersChannel</span><span class=o>(</span><span class=n>groupName</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=o>(</span><span class=n>Channel</span> <span class=n>channel</span> <span class=o>:</span> <span class=n>channels</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>channel</span><span class=o>.</span><span class=na>writeAndFlush</span><span class=o>(</span><span class=k>new</span> <span class=n>GroupCreateResponseMessage</span><span class=o>(</span><span class=kc>true</span><span class=o>,</span> <span class=s>&#34;æ‚¨å·²è¢«æ‹‰å…¥&#34;</span> <span class=o>+</span> <span class=n>groupName</span><span class=o>));</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>ctx</span><span class=o>.</span><span class=na>writeAndFlush</span><span class=o>(</span><span class=k>new</span> <span class=n>GroupCreateResponseMessage</span><span class=o>(</span><span class=kc>false</span><span class=o>,</span> <span class=n>groupName</span> <span class=o>+</span> <span class=s>&#34;å·²ç»å­˜åœ¨&#34;</span><span class=o>));</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>ç¾¤èŠ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@ChannelHandler.Sharable</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>GroupChatRequestMessageHandler</span> <span class=kd>extends</span> <span class=n>SimpleChannelInboundHandler</span><span class=o>&lt;</span><span class=n>GroupChatRequestMessage</span><span class=o>&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>channelRead0</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>,</span> <span class=n>GroupChatRequestMessage</span> <span class=n>msg</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>List</span><span class=o>&lt;</span><span class=n>Channel</span><span class=o>&gt;</span> <span class=n>channels</span> <span class=o>=</span> <span class=n>GroupSessionFactory</span><span class=o>.</span><span class=na>getGroupSession</span><span class=o>()</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>getMembersChannel</span><span class=o>(</span><span class=n>msg</span><span class=o>.</span><span class=na>getGroupName</span><span class=o>());</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=o>(</span><span class=n>Channel</span> <span class=n>channel</span> <span class=o>:</span> <span class=n>channels</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>channel</span><span class=o>.</span><span class=na>writeAndFlush</span><span class=o>(</span><span class=k>new</span> <span class=n>GroupChatResponseMessage</span><span class=o>(</span><span class=n>msg</span><span class=o>.</span><span class=na>getFrom</span><span class=o>(),</span> <span class=n>msg</span><span class=o>.</span><span class=na>getContent</span><span class=o>()));</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>åŠ å…¥ç¾¤èŠ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@ChannelHandler.Sharable</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>GroupJoinRequestMessageHandler</span> <span class=kd>extends</span> <span class=n>SimpleChannelInboundHandler</span><span class=o>&lt;</span><span class=n>GroupJoinRequestMessage</span><span class=o>&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>channelRead0</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>,</span> <span class=n>GroupJoinRequestMessage</span> <span class=n>msg</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Group</span> <span class=n>group</span> <span class=o>=</span> <span class=n>GroupSessionFactory</span><span class=o>.</span><span class=na>getGroupSession</span><span class=o>().</span><span class=na>joinMember</span><span class=o>(</span><span class=n>msg</span><span class=o>.</span><span class=na>getGroupName</span><span class=o>(),</span> <span class=n>msg</span><span class=o>.</span><span class=na>getUsername</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>group</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>ctx</span><span class=o>.</span><span class=na>writeAndFlush</span><span class=o>(</span><span class=k>new</span> <span class=n>GroupJoinResponseMessage</span><span class=o>(</span><span class=kc>true</span><span class=o>,</span> <span class=n>msg</span><span class=o>.</span><span class=na>getGroupName</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;ç¾¤åŠ å…¥æˆåŠŸ&#34;</span><span class=o>));</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>ctx</span><span class=o>.</span><span class=na>writeAndFlush</span><span class=o>(</span><span class=k>new</span> <span class=n>GroupJoinResponseMessage</span><span class=o>(</span><span class=kc>true</span><span class=o>,</span> <span class=n>msg</span><span class=o>.</span><span class=na>getGroupName</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;ç¾¤ä¸å­˜åœ¨&#34;</span><span class=o>));</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>é€€å‡ºç¾¤èŠ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@ChannelHandler.Sharable</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>GroupQuitRequestMessageHandler</span> <span class=kd>extends</span> <span class=n>SimpleChannelInboundHandler</span><span class=o>&lt;</span><span class=n>GroupQuitRequestMessage</span><span class=o>&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>channelRead0</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>,</span> <span class=n>GroupQuitRequestMessage</span> <span class=n>msg</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Group</span> <span class=n>group</span> <span class=o>=</span> <span class=n>GroupSessionFactory</span><span class=o>.</span><span class=na>getGroupSession</span><span class=o>().</span><span class=na>removeMember</span><span class=o>(</span><span class=n>msg</span><span class=o>.</span><span class=na>getGroupName</span><span class=o>(),</span> <span class=n>msg</span><span class=o>.</span><span class=na>getUsername</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>group</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>ctx</span><span class=o>.</span><span class=na>writeAndFlush</span><span class=o>(</span><span class=k>new</span> <span class=n>GroupJoinResponseMessage</span><span class=o>(</span><span class=kc>true</span><span class=o>,</span> <span class=s>&#34;å·²é€€å‡ºç¾¤&#34;</span> <span class=o>+</span> <span class=n>msg</span><span class=o>.</span><span class=na>getGroupName</span><span class=o>()));</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>ctx</span><span class=o>.</span><span class=na>writeAndFlush</span><span class=o>(</span><span class=k>new</span> <span class=n>GroupJoinResponseMessage</span><span class=o>(</span><span class=kc>true</span><span class=o>,</span> <span class=n>msg</span><span class=o>.</span><span class=na>getGroupName</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;ç¾¤ä¸å­˜åœ¨&#34;</span><span class=o>));</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>æŸ¥çœ‹æˆå‘˜</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@ChannelHandler.Sharable</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>GroupMembersRequestMessageHandler</span> <span class=kd>extends</span> <span class=n>SimpleChannelInboundHandler</span><span class=o>&lt;</span><span class=n>GroupMembersRequestMessage</span><span class=o>&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>channelRead0</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>,</span> <span class=n>GroupMembersRequestMessage</span> <span class=n>msg</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Set</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>members</span> <span class=o>=</span> <span class=n>GroupSessionFactory</span><span class=o>.</span><span class=na>getGroupSession</span><span class=o>()</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>getMembers</span><span class=o>(</span><span class=n>msg</span><span class=o>.</span><span class=na>getGroupName</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=n>ctx</span><span class=o>.</span><span class=na>writeAndFlush</span><span class=o>(</span><span class=k>new</span> <span class=n>GroupMembersResponseMessage</span><span class=o>(</span><span class=n>members</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#35-èŠå¤©å®¤ä¸šåŠ¡-é€€å‡º><h3 id=35-èŠå¤©å®¤ä¸šåŠ¡-é€€å‡º><span class=hanchor arialabel=Anchor># </span>3.5 èŠå¤©å®¤ä¸šåŠ¡-é€€å‡º</h3></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>@Slf4j
</span></span><span class=line><span class=cl>@ChannelHandler.Sharable
</span></span><span class=line><span class=cl>public class QuitHandler extends ChannelInboundHandlerAdapter {
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    // å½“è¿æ¥æ–­å¼€æ—¶è§¦å‘ inactive äº‹ä»¶
</span></span><span class=line><span class=cl>    @Override
</span></span><span class=line><span class=cl>    public void channelInactive(ChannelHandlerContext ctx) throws Exception {
</span></span><span class=line><span class=cl>        SessionFactory.getSession().unbind(ctx.channel());
</span></span><span class=line><span class=cl>        log.debug(&#34;{} å·²ç»æ–­å¼€&#34;, ctx.channel());
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	// å½“å‡ºç°å¼‚å¸¸æ—¶è§¦å‘
</span></span><span class=line><span class=cl>    @Override
</span></span><span class=line><span class=cl>    public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) throws Exception {
</span></span><span class=line><span class=cl>        SessionFactory.getSession().unbind(ctx.channel());
</span></span><span class=line><span class=cl>        log.debug(&#34;{} å·²ç»å¼‚å¸¸æ–­å¼€ å¼‚å¸¸æ˜¯{}&#34;, ctx.channel(), cause.getMessage());
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><a href=#36-èŠå¤©å®¤ä¸šåŠ¡-ç©ºé—²æ£€æµ‹><h3 id=36-èŠå¤©å®¤ä¸šåŠ¡-ç©ºé—²æ£€æµ‹><span class=hanchor arialabel=Anchor># </span>3.6 èŠå¤©å®¤ä¸šåŠ¡-ç©ºé—²æ£€æµ‹</h3></a><a href=#è¿æ¥å‡æ­»><h4 id=è¿æ¥å‡æ­»><span class=hanchor arialabel=Anchor># </span>è¿æ¥å‡æ­»</h4></a><a href=#åŸå› ><h5 id=åŸå› ><span class=hanchor arialabel=Anchor># </span>åŸå› </h5></a><ul><li>ç½‘ç»œè®¾å¤‡å‡ºç°æ•…éšœï¼Œä¾‹å¦‚ç½‘å¡ï¼Œæœºæˆ¿ç­‰ï¼Œåº•å±‚çš„ TCP è¿æ¥å·²ç»æ–­å¼€äº†ï¼Œä½†åº”ç”¨<strong>ç¨‹åºæ²¡æœ‰æ„ŸçŸ¥</strong>åˆ°ï¼Œä»ç„¶å ç”¨ç€èµ„æºã€‚</li><li>å…¬ç½‘ç½‘ç»œä¸ç¨³å®šï¼Œå‡ºç°ä¸¢åŒ…ã€‚å¦‚æœè¿ç»­å‡ºç°ä¸¢åŒ…ï¼Œè¿™æ—¶ç°è±¡å°±æ˜¯å®¢æˆ·ç«¯æ•°æ®å‘ä¸å‡ºå»ï¼ŒæœåŠ¡ç«¯ä¹Ÿä¸€ç›´æ”¶ä¸åˆ°æ•°æ®ï¼Œå°±è¿™ä¹ˆä¸€ç›´è€—ç€</li><li>åº”ç”¨ç¨‹åºçº¿ç¨‹é˜»å¡ï¼Œæ— æ³•è¿›è¡Œæ•°æ®è¯»å†™</li></ul><a href=#é—®é¢˜><h5 id=é—®é¢˜><span class=hanchor arialabel=Anchor># </span>é—®é¢˜</h5></a><ul><li>å‡æ­»çš„è¿æ¥å ç”¨çš„èµ„æºä¸èƒ½è‡ªåŠ¨é‡Šæ”¾</li><li>å‘å‡æ­»çš„è¿æ¥å‘é€æ•°æ®ï¼Œå¾—åˆ°çš„åé¦ˆæ˜¯å‘é€è¶…æ—¶</li></ul><a href=#æœåŠ¡å™¨ç«¯è§£å†³><h5 id=æœåŠ¡å™¨ç«¯è§£å†³><span class=hanchor arialabel=Anchor># </span>æœåŠ¡å™¨ç«¯è§£å†³</h5></a><ul><li>æ€ä¹ˆåˆ¤æ–­å®¢æˆ·ç«¯è¿æ¥æ˜¯å¦å‡æ­»å‘¢ï¼Ÿå¦‚æœèƒ½æ”¶åˆ°å®¢æˆ·ç«¯æ•°æ®ï¼Œè¯´æ˜æ²¡æœ‰å‡æ­»ã€‚å› æ­¤ç­–ç•¥å°±å¯ä»¥å®šä¸ºï¼Œæ¯éš”ä¸€æ®µæ—¶é—´å°±æ£€æŸ¥è¿™æ®µæ—¶é—´å†…æ˜¯å¦æ¥æ”¶åˆ°å®¢æˆ·ç«¯æ•°æ®ï¼Œæ²¡æœ‰å°±å¯ä»¥åˆ¤å®šä¸ºè¿æ¥å‡æ­»</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// ç”¨æ¥åˆ¤æ–­æ˜¯ä¸æ˜¯ è¯»ç©ºé—²æ—¶é—´è¿‡é•¿ï¼Œæˆ– å†™ç©ºé—²æ—¶é—´è¿‡é•¿
</span></span></span><span class=line><span class=cl><span class=c1>// 5s å†…å¦‚æœæ²¡æœ‰æ”¶åˆ° channel çš„æ•°æ®ï¼Œä¼šè§¦å‘ä¸€ä¸ª IdleState#READER_IDLE äº‹ä»¶
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>IdleStateHandler</span><span class=o>(</span><span class=n>5</span><span class=o>,</span> <span class=n>0</span><span class=o>,</span> <span class=n>0</span><span class=o>));</span>
</span></span><span class=line><span class=cl><span class=c1>// ChannelDuplexHandler å¯ä»¥åŒæ—¶ä½œä¸ºå…¥ç«™å’Œå‡ºç«™å¤„ç†å™¨
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>ChannelDuplexHandler</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ç”¨æ¥è§¦å‘ç‰¹æ®Šäº‹ä»¶
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>userEventTriggered</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>,</span> <span class=n>Object</span> <span class=n>evt</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span><span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>IdleStateEvent</span> <span class=n>event</span> <span class=o>=</span> <span class=o>(</span><span class=n>IdleStateEvent</span><span class=o>)</span> <span class=n>evt</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=c1>// è§¦å‘äº†è¯»ç©ºé—²äº‹ä»¶
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=o>(</span><span class=n>event</span><span class=o>.</span><span class=na>state</span><span class=o>()</span> <span class=o>==</span> <span class=n>IdleState</span><span class=o>.</span><span class=na>READER_IDLE</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;å·²ç» 5s æ²¡æœ‰è¯»åˆ°æ•°æ®äº†&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>ctx</span><span class=o>.</span><span class=na>channel</span><span class=o>().</span><span class=na>close</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>});</span>
</span></span></code></pre></td></tr></table></div></div><a href=#å®¢æˆ·ç«¯å®šæ—¶å¿ƒè·³><h5 id=å®¢æˆ·ç«¯å®šæ—¶å¿ƒè·³><span class=hanchor arialabel=Anchor># </span>å®¢æˆ·ç«¯å®šæ—¶å¿ƒè·³</h5></a><ul><li>å®¢æˆ·ç«¯å¯ä»¥å®šæ—¶å‘æœåŠ¡å™¨ç«¯å‘é€æ•°æ®ï¼Œåªè¦è¿™ä¸ªæ—¶é—´é—´éš”å°äºæœåŠ¡å™¨å®šä¹‰çš„ç©ºé—²æ£€æµ‹çš„æ—¶é—´é—´éš”ï¼Œé‚£ä¹ˆå°±èƒ½é˜²æ­¢å‰é¢æåˆ°çš„è¯¯åˆ¤ï¼Œå®¢æˆ·ç«¯å¯ä»¥å®šä¹‰å¦‚ä¸‹å¿ƒè·³å¤„ç†å™¨</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// ç”¨æ¥åˆ¤æ–­æ˜¯ä¸æ˜¯ è¯»ç©ºé—²æ—¶é—´è¿‡é•¿ï¼Œæˆ– å†™ç©ºé—²æ—¶é—´è¿‡é•¿
</span></span></span><span class=line><span class=cl><span class=c1>// 3s å†…å¦‚æœæ²¡æœ‰å‘æœåŠ¡å™¨å†™æ•°æ®ï¼Œä¼šè§¦å‘ä¸€ä¸ª IdleState#WRITER_IDLE äº‹ä»¶
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>IdleStateHandler</span><span class=o>(</span><span class=n>0</span><span class=o>,</span> <span class=n>3</span><span class=o>,</span> <span class=n>0</span><span class=o>));</span>
</span></span><span class=line><span class=cl><span class=c1>// ChannelDuplexHandler å¯ä»¥åŒæ—¶ä½œä¸ºå…¥ç«™å’Œå‡ºç«™å¤„ç†å™¨
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>ChannelDuplexHandler</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ç”¨æ¥è§¦å‘ç‰¹æ®Šäº‹ä»¶
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>userEventTriggered</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>,</span> <span class=n>Object</span> <span class=n>evt</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span><span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>IdleStateEvent</span> <span class=n>event</span> <span class=o>=</span> <span class=o>(</span><span class=n>IdleStateEvent</span><span class=o>)</span> <span class=n>evt</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=c1>// è§¦å‘äº†å†™ç©ºé—²äº‹ä»¶
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=o>(</span><span class=n>event</span><span class=o>.</span><span class=na>state</span><span class=o>()</span> <span class=o>==</span> <span class=n>IdleState</span><span class=o>.</span><span class=na>WRITER_IDLE</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>//                                log.debug(&#34;3s æ²¡æœ‰å†™æ•°æ®äº†ï¼Œå‘é€ä¸€ä¸ªå¿ƒè·³åŒ…&#34;);
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>ctx</span><span class=o>.</span><span class=na>writeAndFlush</span><span class=o>(</span><span class=k>new</span> <span class=n>PingMessage</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>});</span>
</span></span></code></pre></td></tr></table></div></div></article><hr><div class=page-end id=footer><div class=backlinks-container><h3>Backlinks</h3><ul class=backlinks><li>No backlinks found</li></ul></div><div><script src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>Interactive Graph</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://harbor.mffseal.top/js/graph.abd4bc2af3869a96524d7d23b76152c7.js></script></div></div><div id=contact_buttons><footer><p>Made by mffseal using <a href=https://github.com/jackyzha0/quartz>Quartz</a>, Â© 2022</p><ul><li><a href=https://harbor.mffseal.top/>Home</a></li><li><a href=https://github.com/mffseal>Github</a></li></ul></footer></div></div></body></html>