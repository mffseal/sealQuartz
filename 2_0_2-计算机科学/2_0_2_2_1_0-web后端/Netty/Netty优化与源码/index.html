<!doctype html><html lang=en><head><meta charset=utf-8><meta name=description content="Netty优化与源码 1. 优化 1.1 扩展序列化算法 序列化，反序列化主要用在消息正文的转换上
 序列化时，需要将 Java 对象变为要传输的数据（可以是 byte[]，或 json 等，最终都需要变成 byte[]） 反序列化时，需要将传入的正文数据还原成 Java 对象，便于处理  目前的代码仅支持 Java 自带的序列化，反序列化机制，核心代码如下"><title>Netty优化与源码</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://harbor.mffseal.top//icon.png><link href=https://harbor.mffseal.top/styles.7153093e4d1bbb584a28469cadfa3f88.min.css rel=stylesheet><link href=https://harbor.mffseal.top/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://harbor.mffseal.top/js/darkmode.9841b88d44c115f7419d485ee72d23a2.min.js></script>
<script src=https://harbor.mffseal.top/js/util.9825137f5e7825e8553c68ce39ac9e44.min.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js integrity=sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A crossorigin=anonymous></script>
<script src=https://unpkg.com/@floating-ui/core@0.7.3></script>
<script src=https://unpkg.com/@floating-ui/dom@0.5.4></script>
<script src=https://harbor.mffseal.top/js/popover.53ad9a087e3feeaaa12b63bfd02d923b.min.js></script>
<script src=https://harbor.mffseal.top/js/code-title.b35124ad8db0ba37162b886afb711cbc.min.js></script>
<script src=https://harbor.mffseal.top/js/clipboard.c20857734e53a3fb733b7443879efa61.min.js></script>
<script src=https://harbor.mffseal.top/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const BASE_URL="https://harbor.mffseal.top/",fetchData=Promise.all([fetch("https://harbor.mffseal.top/indices/linkIndex.ec6b7a4b9710e839c3949572ac2dcac8.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://harbor.mffseal.top/indices/contentIndex.fbe7f53f0a2c073793edc87749d25bfe.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addTitleToCodeBlocks(),addCollapsibleCallouts(),initPopover("https://harbor.mffseal.top",!0,!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!1;drawGraph("https://harbor.mffseal.top",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],macros:{'’':"'"},throwOnError:!1})}</script><script type=module>
    import { attachSPARouting } from "https:\/\/harbor.mffseal.top\/js\/router.9d4974281069e9ebb189f642ae1e3ca2.min.js"
    attachSPARouting(init, render)
  </script></head><script async src="https://www.googletagmanager.com/gtag/js?id=G-NV58SYWRZD"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-NV58SYWRZD",{anonymize_ip:!1})}</script><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://harbor.mffseal.top/js/full-text-search.24827f874defbbc6d529926cbfcfb493.min.js></script><div class=singlePage><header><h1 id=page-title><a href=https://harbor.mffseal.top/>🦭 港湾</a></h1><div class=spacer></div><div id=search-icon><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><h1>Netty优化与源码</h1><p class=meta>Last updated
Jun 28, 2022
<a href=https://github.com/mffseal/2_0_2-%e8%ae%a1%e7%ae%97%e6%9c%ba%e7%a7%91%e5%ad%a6/2_0_2_2_1_0-web%e5%90%8e%e7%ab%af/Netty/Netty%e4%bc%98%e5%8c%96%e4%b8%8e%e6%ba%90%e7%a0%81.md rel=noopener>Edit Source</a></p><ul class=tags></ul><aside class=mainTOC><details><summary>Table of Contents</summary><nav id=TableOfContents><ol><li><a href=#1-优化>1. 优化</a><ol><li><a href=#11-扩展序列化算法>1.1 扩展序列化算法</a></li><li><a href=#12-参数调优>1.2 参数调优</a></li><li><a href=#13-rpc-框架>1.3 RPC 框架</a></li></ol></li><li><a href=#2-源码分析>2. 源码分析</a><ol><li><a href=#21-启动剖析>2.1 启动剖析</a></li><li><a href=#22-nioeventloop-剖析>2.2 NioEventLoop 剖析</a></li><li><a href=#23-accept-剖析>2.3 accept 剖析</a></li><li><a href=#24-read-剖析>2.4 read 剖析</a></li></ol></li></ol></nav></details></aside><a href=#netty优化与源码><h1 id=netty优化与源码><span class=hanchor arialabel=Anchor># </span>Netty优化与源码</h1></a><a href=#1-优化><h2 id=1-优化><span class=hanchor arialabel=Anchor># </span>1. 优化</h2></a><a href=#11-扩展序列化算法><h3 id=11-扩展序列化算法><span class=hanchor arialabel=Anchor># </span>1.1 扩展序列化算法</h3></a><p>序列化，反序列化主要用在消息正文的转换上</p><ul><li>序列化时，需要将 Java 对象变为要传输的数据（可以是 byte[]，或 json 等，<strong>最终都需要变成 byte[]</strong>）</li><li>反序列化时，需要将传入的正文数据还原成 Java 对象，便于处理</li></ul><p>目前的代码仅支持 Java 自带的序列化，反序列化机制，核心代码如下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 反序列化
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>byte</span><span class=o>[]</span> <span class=n>body</span> <span class=o>=</span> <span class=k>new</span> <span class=kt>byte</span><span class=o>[</span><span class=n>bodyLength</span><span class=o>];</span>
</span></span><span class=line><span class=cl><span class=n>byteByf</span><span class=o>.</span><span class=na>readBytes</span><span class=o>(</span><span class=n>body</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>ObjectInputStream</span> <span class=n>in</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ObjectInputStream</span><span class=o>(</span><span class=k>new</span> <span class=n>ByteArrayInputStream</span><span class=o>(</span><span class=n>body</span><span class=o>));</span>
</span></span><span class=line><span class=cl><span class=n>Message</span> <span class=n>message</span> <span class=o>=</span> <span class=o>(</span><span class=n>Message</span><span class=o>)</span> <span class=n>in</span><span class=o>.</span><span class=na>readObject</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=n>message</span><span class=o>.</span><span class=na>setSequenceId</span><span class=o>(</span><span class=n>sequenceId</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 序列化
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>ByteArrayOutputStream</span> <span class=n>out</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ByteArrayOutputStream</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=k>new</span> <span class=n>ObjectOutputStream</span><span class=o>(</span><span class=n>out</span><span class=o>).</span><span class=na>writeObject</span><span class=o>(</span><span class=n>message</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=kt>byte</span><span class=o>[]</span> <span class=n>bytes</span> <span class=o>=</span> <span class=n>out</span><span class=o>.</span><span class=na>toByteArray</span><span class=o>();</span>
</span></span></code></pre></td></tr></table></div></div><p>为了支持更多序列化算法，抽象一个 Serializer 接口</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>interface</span> <span class=nc>Serializer</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 反序列化方法
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>T</span> <span class=nf>deserialize</span><span class=o>(</span><span class=n>Class</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>clazz</span><span class=o>,</span> <span class=kt>byte</span><span class=o>[]</span> <span class=n>bytes</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 序列化方法
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=kt>byte</span><span class=o>[]</span> <span class=nf>serialize</span><span class=o>(</span><span class=n>T</span> <span class=n>object</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>提供两个实现，我这里直接将实现加入了枚举类 Serializer.Algorithm 中</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>enum</span> <span class=n>SerializerAlgorithm</span> <span class=kd>implements</span> <span class=n>Serializer</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Java 实现
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>Java</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>T</span> <span class=nf>deserialize</span><span class=o>(</span><span class=n>Class</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>clazz</span><span class=o>,</span> <span class=kt>byte</span><span class=o>[]</span> <span class=n>bytes</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>ObjectInputStream</span> <span class=n>in</span> <span class=o>=</span> 
</span></span><span class=line><span class=cl>                    <span class=k>new</span> <span class=n>ObjectInputStream</span><span class=o>(</span><span class=k>new</span> <span class=n>ByteArrayInputStream</span><span class=o>(</span><span class=n>bytes</span><span class=o>));</span>
</span></span><span class=line><span class=cl>                <span class=n>Object</span> <span class=n>object</span> <span class=o>=</span> <span class=n>in</span><span class=o>.</span><span class=na>readObject</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=o>(</span><span class=n>T</span><span class=o>)</span> <span class=n>object</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=o>|</span> <span class=n>ClassNotFoundException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>throw</span> <span class=k>new</span> <span class=n>RuntimeException</span><span class=o>(</span><span class=s>&#34;SerializerAlgorithm.Java 反序列化错误&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=kt>byte</span><span class=o>[]</span> <span class=nf>serialize</span><span class=o>(</span><span class=n>T</span> <span class=n>object</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>ByteArrayOutputStream</span> <span class=n>out</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ByteArrayOutputStream</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=k>new</span> <span class=n>ObjectOutputStream</span><span class=o>(</span><span class=n>out</span><span class=o>).</span><span class=na>writeObject</span><span class=o>(</span><span class=n>object</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>out</span><span class=o>.</span><span class=na>toByteArray</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>throw</span> <span class=k>new</span> <span class=n>RuntimeException</span><span class=o>(</span><span class=s>&#34;SerializerAlgorithm.Java 序列化错误&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>},</span> 
</span></span><span class=line><span class=cl>    <span class=c1>// Json 实现(引入了 Gson 依赖)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>Json</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>T</span> <span class=nf>deserialize</span><span class=o>(</span><span class=n>Class</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>clazz</span><span class=o>,</span> <span class=kt>byte</span><span class=o>[]</span> <span class=n>bytes</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=k>new</span> <span class=n>Gson</span><span class=o>().</span><span class=na>fromJson</span><span class=o>(</span><span class=k>new</span> <span class=n>String</span><span class=o>(</span><span class=n>bytes</span><span class=o>,</span> <span class=n>StandardCharsets</span><span class=o>.</span><span class=na>UTF_8</span><span class=o>),</span> <span class=n>clazz</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=kt>byte</span><span class=o>[]</span> <span class=nf>serialize</span><span class=o>(</span><span class=n>T</span> <span class=n>object</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=k>new</span> <span class=n>Gson</span><span class=o>().</span><span class=na>toJson</span><span class=o>(</span><span class=n>object</span><span class=o>).</span><span class=na>getBytes</span><span class=o>(</span><span class=n>StandardCharsets</span><span class=o>.</span><span class=na>UTF_8</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 需要从协议的字节中得到是哪种序列化算法
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>public</span> <span class=kd>static</span> <span class=n>SerializerAlgorithm</span> <span class=nf>getByInt</span><span class=o>(</span><span class=kt>int</span> <span class=n>type</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>SerializerAlgorithm</span><span class=o>[]</span> <span class=n>array</span> <span class=o>=</span> <span class=n>SerializerAlgorithm</span><span class=o>.</span><span class=na>values</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>type</span> <span class=o>&lt;</span> <span class=n>0</span> <span class=o>||</span> <span class=n>type</span> <span class=o>&gt;</span> <span class=n>array</span><span class=o>.</span><span class=na>length</span> <span class=o>-</span> <span class=n>1</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=o>(</span><span class=s>&#34;超过 SerializerAlgorithm 范围&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>array</span><span class=o>[</span><span class=n>type</span><span class=o>];</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>增加配置类和配置文件</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>abstract</span> <span class=kd>class</span> <span class=nc>Config</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>static</span> <span class=n>Properties</span> <span class=n>properties</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>static</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>(</span><span class=n>InputStream</span> <span class=n>in</span> <span class=o>=</span> <span class=n>Config</span><span class=o>.</span><span class=na>class</span><span class=o>.</span><span class=na>getResourceAsStream</span><span class=o>(</span><span class=s>&#34;/application.properties&#34;</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>properties</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Properties</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>properties</span><span class=o>.</span><span class=na>load</span><span class=o>(</span><span class=n>in</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>ExceptionInInitializerError</span><span class=o>(</span><span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>int</span> <span class=nf>getServerPort</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>String</span> <span class=n>value</span> <span class=o>=</span> <span class=n>properties</span><span class=o>.</span><span class=na>getProperty</span><span class=o>(</span><span class=s>&#34;server.port&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=o>(</span><span class=n>value</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>8080</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>Integer</span><span class=o>.</span><span class=na>parseInt</span><span class=o>(</span><span class=n>value</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=n>Serializer</span><span class=o>.</span><span class=na>Algorithm</span> <span class=nf>getSerializerAlgorithm</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>String</span> <span class=n>value</span> <span class=o>=</span> <span class=n>properties</span><span class=o>.</span><span class=na>getProperty</span><span class=o>(</span><span class=s>&#34;serializer.algorithm&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=o>(</span><span class=n>value</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>Serializer</span><span class=o>.</span><span class=na>Algorithm</span><span class=o>.</span><span class=na>Java</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>Serializer</span><span class=o>.</span><span class=na>Algorithm</span><span class=o>.</span><span class=na>valueOf</span><span class=o>(</span><span class=n>value</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>配置文件</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>serializer.algorithm=Json
</span></span></code></pre></td></tr></table></div></div><p>修改编解码器</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * 必须和 LengthFieldBasedFrameDecoder 一起使用，确保接到的 ByteBuf 消息是完整的
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>MessageCodecSharable</span> <span class=kd>extends</span> <span class=n>MessageToMessageCodec</span><span class=o>&lt;</span><span class=n>ByteBuf</span><span class=o>,</span> <span class=n>Message</span><span class=o>&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>encode</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>,</span> <span class=n>Message</span> <span class=n>msg</span><span class=o>,</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span> <span class=n>outList</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ByteBuf</span> <span class=n>out</span> <span class=o>=</span> <span class=n>ctx</span><span class=o>.</span><span class=na>alloc</span><span class=o>().</span><span class=na>buffer</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 1. 4 字节的魔数
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>out</span><span class=o>.</span><span class=na>writeBytes</span><span class=o>(</span><span class=k>new</span> <span class=kt>byte</span><span class=o>[]{</span><span class=n>1</span><span class=o>,</span> <span class=n>2</span><span class=o>,</span> <span class=n>3</span><span class=o>,</span> <span class=n>4</span><span class=o>});</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 2. 1 字节的版本,
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>out</span><span class=o>.</span><span class=na>writeByte</span><span class=o>(</span><span class=n>1</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 3. 1 字节的序列化方式 jdk 0 , json 1
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>out</span><span class=o>.</span><span class=na>writeByte</span><span class=o>(</span><span class=n>Config</span><span class=o>.</span><span class=na>getSerializerAlgorithm</span><span class=o>().</span><span class=na>ordinal</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 4. 1 字节的指令类型
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>out</span><span class=o>.</span><span class=na>writeByte</span><span class=o>(</span><span class=n>msg</span><span class=o>.</span><span class=na>getMessageType</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 5. 4 个字节
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>out</span><span class=o>.</span><span class=na>writeInt</span><span class=o>(</span><span class=n>msg</span><span class=o>.</span><span class=na>getSequenceId</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 无意义，对齐填充
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>out</span><span class=o>.</span><span class=na>writeByte</span><span class=o>(</span><span class=n>0xff</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 6. 获取内容的字节数组
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kt>byte</span><span class=o>[]</span> <span class=n>bytes</span> <span class=o>=</span> <span class=n>Config</span><span class=o>.</span><span class=na>getSerializerAlgorithm</span><span class=o>().</span><span class=na>serialize</span><span class=o>(</span><span class=n>msg</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 7. 长度
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>out</span><span class=o>.</span><span class=na>writeInt</span><span class=o>(</span><span class=n>bytes</span><span class=o>.</span><span class=na>length</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 8. 写入内容
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>out</span><span class=o>.</span><span class=na>writeBytes</span><span class=o>(</span><span class=n>bytes</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>outList</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>out</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>decode</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>,</span> <span class=n>ByteBuf</span> <span class=n>in</span><span class=o>,</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span> <span class=n>out</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>magicNum</span> <span class=o>=</span> <span class=n>in</span><span class=o>.</span><span class=na>readInt</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=kt>byte</span> <span class=n>version</span> <span class=o>=</span> <span class=n>in</span><span class=o>.</span><span class=na>readByte</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=kt>byte</span> <span class=n>serializerAlgorithm</span> <span class=o>=</span> <span class=n>in</span><span class=o>.</span><span class=na>readByte</span><span class=o>();</span> <span class=c1>// 0 或 1
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kt>byte</span> <span class=n>messageType</span> <span class=o>=</span> <span class=n>in</span><span class=o>.</span><span class=na>readByte</span><span class=o>();</span> <span class=c1>// 0,1,2...
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kt>int</span> <span class=n>sequenceId</span> <span class=o>=</span> <span class=n>in</span><span class=o>.</span><span class=na>readInt</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>in</span><span class=o>.</span><span class=na>readByte</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>length</span> <span class=o>=</span> <span class=n>in</span><span class=o>.</span><span class=na>readInt</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=kt>byte</span><span class=o>[]</span> <span class=n>bytes</span> <span class=o>=</span> <span class=k>new</span> <span class=kt>byte</span><span class=o>[</span><span class=n>length</span><span class=o>];</span>
</span></span><span class=line><span class=cl>        <span class=n>in</span><span class=o>.</span><span class=na>readBytes</span><span class=o>(</span><span class=n>bytes</span><span class=o>,</span> <span class=n>0</span><span class=o>,</span> <span class=n>length</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// 找到反序列化算法
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>Serializer</span><span class=o>.</span><span class=na>Algorithm</span> <span class=n>algorithm</span> <span class=o>=</span> <span class=n>Serializer</span><span class=o>.</span><span class=na>Algorithm</span><span class=o>.</span><span class=na>values</span><span class=o>()[</span><span class=n>serializerAlgorithm</span><span class=o>];</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 确定具体消息类型
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>Class</span><span class=o>&lt;?</span> <span class=kd>extends</span> <span class=n>Message</span><span class=o>&gt;</span> <span class=n>messageClass</span> <span class=o>=</span> <span class=n>Message</span><span class=o>.</span><span class=na>getMessageClass</span><span class=o>(</span><span class=n>messageType</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>Message</span> <span class=n>message</span> <span class=o>=</span> <span class=n>algorithm</span><span class=o>.</span><span class=na>deserialize</span><span class=o>(</span><span class=n>messageClass</span><span class=o>,</span> <span class=n>bytes</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=c1>//        log.debug(&#34;{}, {}, {}, {}, {}, {}&#34;, magicNum, version, serializerType, messageType, sequenceId, length);
</span></span></span><span class=line><span class=cl><span class=c1>//        log.debug(&#34;{}&#34;, message);
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>out</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>message</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>其中确定具体消息类型，可以根据 <code>消息类型字节</code> 获取到对应的 <code>消息 class</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Data</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>abstract</span> <span class=kd>class</span> <span class=nc>Message</span> <span class=kd>implements</span> <span class=n>Serializable</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 根据消息类型字节，获得对应的消息 class
</span></span></span><span class=line><span class=cl><span class=cm>     * @param messageType 消息类型字节
</span></span></span><span class=line><span class=cl><span class=cm>     * @return 消息 class
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=n>Class</span><span class=o>&lt;?</span> <span class=kd>extends</span> <span class=n>Message</span><span class=o>&gt;</span> <span class=nf>getMessageClass</span><span class=o>(</span><span class=kt>int</span> <span class=n>messageType</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>messageClasses</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>messageType</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kt>int</span> <span class=n>sequenceId</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kt>int</span> <span class=n>messageType</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>abstract</span> <span class=kt>int</span> <span class=nf>getMessageType</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>LoginRequestMessage</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>LoginResponseMessage</span> <span class=o>=</span> <span class=n>1</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>ChatRequestMessage</span> <span class=o>=</span> <span class=n>2</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>ChatResponseMessage</span> <span class=o>=</span> <span class=n>3</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>GroupCreateRequestMessage</span> <span class=o>=</span> <span class=n>4</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>GroupCreateResponseMessage</span> <span class=o>=</span> <span class=n>5</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>GroupJoinRequestMessage</span> <span class=o>=</span> <span class=n>6</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>GroupJoinResponseMessage</span> <span class=o>=</span> <span class=n>7</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>GroupQuitRequestMessage</span> <span class=o>=</span> <span class=n>8</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>GroupQuitResponseMessage</span> <span class=o>=</span> <span class=n>9</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>GroupChatRequestMessage</span> <span class=o>=</span> <span class=n>10</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>GroupChatResponseMessage</span> <span class=o>=</span> <span class=n>11</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>GroupMembersRequestMessage</span> <span class=o>=</span> <span class=n>12</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>GroupMembersResponseMessage</span> <span class=o>=</span> <span class=n>13</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>PingMessage</span> <span class=o>=</span> <span class=n>14</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>PongMessage</span> <span class=o>=</span> <span class=n>15</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>,</span> <span class=n>Class</span><span class=o>&lt;?</span> <span class=kd>extends</span> <span class=n>Message</span><span class=o>&gt;&gt;</span> <span class=n>messageClasses</span> <span class=o>=</span> <span class=k>new</span> <span class=n>HashMap</span><span class=o>&lt;&gt;();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>static</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>messageClasses</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>LoginRequestMessage</span><span class=o>,</span> <span class=n>LoginRequestMessage</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>messageClasses</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>LoginResponseMessage</span><span class=o>,</span> <span class=n>LoginResponseMessage</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>messageClasses</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>ChatRequestMessage</span><span class=o>,</span> <span class=n>ChatRequestMessage</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>messageClasses</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>ChatResponseMessage</span><span class=o>,</span> <span class=n>ChatResponseMessage</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>messageClasses</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>GroupCreateRequestMessage</span><span class=o>,</span> <span class=n>GroupCreateRequestMessage</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>messageClasses</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>GroupCreateResponseMessage</span><span class=o>,</span> <span class=n>GroupCreateResponseMessage</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>messageClasses</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>GroupJoinRequestMessage</span><span class=o>,</span> <span class=n>GroupJoinRequestMessage</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>messageClasses</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>GroupJoinResponseMessage</span><span class=o>,</span> <span class=n>GroupJoinResponseMessage</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>messageClasses</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>GroupQuitRequestMessage</span><span class=o>,</span> <span class=n>GroupQuitRequestMessage</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>messageClasses</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>GroupQuitResponseMessage</span><span class=o>,</span> <span class=n>GroupQuitResponseMessage</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>messageClasses</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>GroupChatRequestMessage</span><span class=o>,</span> <span class=n>GroupChatRequestMessage</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>messageClasses</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>GroupChatResponseMessage</span><span class=o>,</span> <span class=n>GroupChatResponseMessage</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>messageClasses</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>GroupMembersRequestMessage</span><span class=o>,</span> <span class=n>GroupMembersRequestMessage</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>messageClasses</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>GroupMembersResponseMessage</span><span class=o>,</span> <span class=n>GroupMembersResponseMessage</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#12-参数调优><h3 id=12-参数调优><span class=hanchor arialabel=Anchor># </span>1.2 参数调优</h3></a><p>客户端直接调用 Bootstrap().option(xxx)
服务器端：
ServerBootstrap().option(xxx)是给ServerSocketChannel配置参数
ServerBootstrap().childOption(xxx)是给SocketChannel配置参数</p><a href=#1connect_timeout_millis><h4 id=1connect_timeout_millis><span class=hanchor arialabel=Anchor># </span>1）CONNECT_TIMEOUT_MILLIS</h4></a><ul><li><p>属于 SocketChannal 参数</p></li><li><p>用在客户端建立连接时，如果在指定毫秒内无法连接，会抛出 timeout 异常</p></li><li><p>SO_TIMEOUT 主要用在阻塞 IO，阻塞 IO 中 accept，read 等都是无限等待的，如果不希望永远阻塞，使用它调整超时时间</p></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>TestConnectionTimeout</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>NioEventLoopGroup</span> <span class=n>group</span> <span class=o>=</span> <span class=k>new</span> <span class=n>NioEventLoopGroup</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Bootstrap</span> <span class=n>bootstrap</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Bootstrap</span><span class=o>()</span>
</span></span><span class=line><span class=cl>                    <span class=o>.</span><span class=na>group</span><span class=o>(</span><span class=n>group</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                    <span class=c1>// 配置参数
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=o>.</span><span class=na>option</span><span class=o>(</span><span class=n>ChannelOption</span><span class=o>.</span><span class=na>CONNECT_TIMEOUT_MILLIS</span><span class=o>,</span> <span class=n>300</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                    <span class=o>.</span><span class=na>channel</span><span class=o>(</span><span class=n>NioSocketChannel</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                    <span class=o>.</span><span class=na>handler</span><span class=o>(</span><span class=k>new</span> <span class=n>LoggingHandler</span><span class=o>());</span>
</span></span><span class=line><span class=cl>            <span class=n>ChannelFuture</span> <span class=n>future</span> <span class=o>=</span> <span class=n>bootstrap</span><span class=o>.</span><span class=na>connect</span><span class=o>(</span><span class=s>&#34;127.0.0.1&#34;</span><span class=o>,</span> <span class=n>8080</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>future</span><span class=o>.</span><span class=na>sync</span><span class=o>().</span><span class=na>channel</span><span class=o>().</span><span class=na>closeFuture</span><span class=o>().</span><span class=na>sync</span><span class=o>();</span> <span class=c1>// 断点1
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Exception</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;timeout&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>group</span><span class=o>.</span><span class=na>shutdownGracefully</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>另外源码部分 <code>io.netty.channel.nio.AbstractNioChannel.AbstractNioUnsafe#connect</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>final</span> <span class=kt>void</span> <span class=nf>connect</span><span class=o>(</span>
</span></span><span class=line><span class=cl>        <span class=kd>final</span> <span class=n>SocketAddress</span> <span class=n>remoteAddress</span><span class=o>,</span> <span class=kd>final</span> <span class=n>SocketAddress</span> <span class=n>localAddress</span><span class=o>,</span> <span class=kd>final</span> <span class=n>ChannelPromise</span> <span class=n>promise</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// Schedule connect timeout.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>int</span> <span class=n>connectTimeoutMillis</span> <span class=o>=</span> <span class=n>config</span><span class=o>().</span><span class=na>getConnectTimeoutMillis</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>connectTimeoutMillis</span> <span class=o>&gt;</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>connectTimeoutFuture</span> <span class=o>=</span> <span class=n>eventLoop</span><span class=o>().</span><span class=na>schedule</span><span class=o>(</span><span class=k>new</span> <span class=n>Runnable</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>            <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>                
</span></span><span class=line><span class=cl>                <span class=n>ChannelPromise</span> <span class=n>connectPromise</span> <span class=o>=</span> <span class=n>AbstractNioChannel</span><span class=o>.</span><span class=na>this</span><span class=o>.</span><span class=na>connectPromise</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=n>ConnectTimeoutException</span> <span class=n>cause</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>                    <span class=k>new</span> <span class=n>ConnectTimeoutException</span><span class=o>(</span><span class=s>&#34;connection timed out: &#34;</span> <span class=o>+</span> <span class=n>remoteAddress</span><span class=o>);</span> <span class=c1>// 断点2
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=k>if</span> <span class=o>(</span><span class=n>connectPromise</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>connectPromise</span><span class=o>.</span><span class=na>tryFailure</span><span class=o>(</span><span class=n>cause</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>close</span><span class=o>(</span><span class=n>voidPromise</span><span class=o>());</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>},</span> <span class=n>connectTimeoutMillis</span><span class=o>,</span> <span class=n>TimeUnit</span><span class=o>.</span><span class=na>MILLISECONDS</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#2so_backlog><h4 id=2so_backlog><span class=hanchor arialabel=Anchor># </span>2）SO_BACKLOG</h4></a><ul><li>属于 ServerSocketChannal 参数</li></ul><p>三次握手的过程：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>sequenceDiagram
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>participant c as client
</span></span><span class=line><span class=cl>participant s as server
</span></span><span class=line><span class=cl>participant sq as syns queue
</span></span><span class=line><span class=cl>participant aq as accept queue
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>s -&gt;&gt; s : bind()
</span></span><span class=line><span class=cl>s -&gt;&gt; s : listen()
</span></span><span class=line><span class=cl>c -&gt;&gt; c : connect()
</span></span><span class=line><span class=cl>c -&gt;&gt; s : 1. SYN
</span></span><span class=line><span class=cl>Note left of c : SYN_SEND
</span></span><span class=line><span class=cl>s -&gt;&gt; sq : put
</span></span><span class=line><span class=cl>Note right of s : SYN_RCVD
</span></span><span class=line><span class=cl>s -&gt;&gt; c : 2. SYN + ACK
</span></span><span class=line><span class=cl>Note left of c : ESTABLISHED
</span></span><span class=line><span class=cl>c -&gt;&gt; s : 3. ACK
</span></span><span class=line><span class=cl>sq -&gt;&gt; aq : put
</span></span><span class=line><span class=cl>Note right of s : ESTABLISHED
</span></span><span class=line><span class=cl>aq --&gt;&gt; s : 
</span></span><span class=line><span class=cl>s -&gt;&gt; s : accept()
</span></span></code></pre></td></tr></table></div></div><blockquote><p>sync queue：半连接队列：还未完成三次握手的连接放入
accept queue：全连接队列：完成三次握手的连接放入</p></blockquote><blockquote><p>服务器先放入accept queue的原因是：服务器处理accept()的能力有限，如果大量客户端连接可能造成负载过高，所以先放入队列。
三次握手发生在accept()之前。</p></blockquote><ol><li>第一次握手，client 发送 SYN 到 server，状态修改为 SYN_SEND，server 收到，状态改变为 SYN_REVD，并将该请求放入 sync queue 队列</li><li>第二次握手，server 回复 SYN + ACK 给 client，client 收到，状态改变为 ESTABLISHED，并发送 ACK 给 server</li><li>第三次握手，server 收到 ACK，状态改变为 ESTABLISHED，将该请求从 sync queue 放入 accept queue</li></ol><p>其中</p><ul><li><p>在 linux 2.2 之前，backlog 大小包括了两个队列的大小，在 2.2 之后，分别用下面两个参数来控制</p></li><li><p>sync queue - 半连接队列</p><ul><li>大小通过 /proc/sys/net/ipv4/tcp_max_syn_backlog 指定，在 <code>syncookies</code> 启用的情况下，逻辑上没有最大值限制，这个设置便被忽略</li></ul></li><li><p>accept queue - 全连接队列</p><ul><li>其大小通过 /proc/sys/net/core/somaxconn 指定，在使用 listen 函数时，内核会根据传入的 backlog 参数与系统参数，取<strong>二者的较小值</strong></li><li><strong>如果 accpet queue 队列满了，server 将发送一个拒绝连接的错误信息到 client</strong></li></ul></li></ul><p>netty 中</p><p>可以通过 option(ChannelOption.SO_BACKLOG, 值) 来设置全连接队列大小</p><p>可以通过下面源码查看默认大小</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>DefaultServerSocketChannelConfig</span> <span class=kd>extends</span> <span class=n>DefaultChannelConfig</span>
</span></span><span class=line><span class=cl>                                              <span class=kd>implements</span> <span class=n>ServerSocketChannelConfig</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>volatile</span> <span class=kt>int</span> <span class=n>backlog</span> <span class=o>=</span> <span class=n>NetUtil</span><span class=o>.</span><span class=na>SOMAXCONN</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>课堂调试关键断点为：<code>io.netty.channel.nio.NioEventLoop#processSelectedKey</code></p><p>oio 中更容易说明，不用 debug 模式</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>Server</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ServerSocket</span> <span class=n>ss</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ServerSocket</span><span class=o>(</span><span class=n>8888</span><span class=o>,</span> <span class=n>2</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>Socket</span> <span class=n>accept</span> <span class=o>=</span> <span class=n>ss</span><span class=o>.</span><span class=na>accept</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>accept</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>in</span><span class=o>.</span><span class=na>read</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>客户端启动 4 个</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>Client</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Socket</span> <span class=n>s</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Socket</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=k>new</span> <span class=n>Date</span><span class=o>()+</span><span class=s>&#34; connecting...&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>s</span><span class=o>.</span><span class=na>connect</span><span class=o>(</span><span class=k>new</span> <span class=n>InetSocketAddress</span><span class=o>(</span><span class=s>&#34;localhost&#34;</span><span class=o>,</span> <span class=n>8888</span><span class=o>),</span><span class=n>1000</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=k>new</span> <span class=n>Date</span><span class=o>()+</span><span class=s>&#34; connected...&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>s</span><span class=o>.</span><span class=na>getOutputStream</span><span class=o>().</span><span class=na>write</span><span class=o>(</span><span class=n>1</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>System</span><span class=o>.</span><span class=na>in</span><span class=o>.</span><span class=na>read</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=k>new</span> <span class=n>Date</span><span class=o>()+</span><span class=s>&#34; connecting timeout...&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>第 1，2，3 个客户端都打印，但除了第一个处于 accpet 外，其它两个都处于 accept queue 中</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Tue</span> <span class=n>Apr</span> <span class=n>21</span> <span class=n>20</span><span class=o>:</span><span class=n>30</span><span class=o>:</span><span class=n>28</span> <span class=n>CST</span> <span class=n>2020</span> <span class=n>connecting</span><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=n>Tue</span> <span class=n>Apr</span> <span class=n>21</span> <span class=n>20</span><span class=o>:</span><span class=n>30</span><span class=o>:</span><span class=n>28</span> <span class=n>CST</span> <span class=n>2020</span> <span class=n>connected</span><span class=o>...</span>
</span></span></code></pre></td></tr></table></div></div><p>第 4 个客户端连接时</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Tue Apr 21 20:53:58 CST 2020 connecting...
</span></span><span class=line><span class=cl>Tue Apr 21 20:53:59 CST 2020 connecting timeout...
</span></span><span class=line><span class=cl>java.net.SocketTimeoutException: connect timed out
</span></span></code></pre></td></tr></table></div></div><a href=#3ulimit--n><h4 id=3ulimit--n><span class=hanchor arialabel=Anchor># </span>3）ulimit -n</h4></a><ul><li>属于操作系统参数</li></ul><p>限制进程能同时打开的文件描述符数量。</p><blockquote><p>Linux 的普通文件和socket都是用文件描述符来代表。
属于系统的临时调整，建议放在启动脚本。</p></blockquote><a href=#4tcp_nodelay><h4 id=4tcp_nodelay><span class=hanchor arialabel=Anchor># </span>4）TCP_NODELAY</h4></a><ul><li>属于 SocketChannal 参数，需要childOption设置。</li></ul><blockquote><p>默认值是false，代表开启nagle算法。
设为true关闭nagle算法。</p></blockquote><a href=#5so_sndbuf--so_rcvbuf><h4 id=5so_sndbuf--so_rcvbuf><span class=hanchor arialabel=Anchor># </span>5）SO_SNDBUF & SO_RCVBUF</h4></a><ul><li>SO_SNDBUF 属于 SocketChannal 参数</li><li>SO_RCVBUF 既可用于 SocketChannal 参数，也可以用于 ServerSocketChannal 参数（建议设置到 ServerSocketChannal 上）</li></ul><blockquote><p>不建议调整该参数，操作系统拥塞控制会自动调整。</p></blockquote><a href=#6allocator><h4 id=6allocator><span class=hanchor arialabel=Anchor># </span>6）ALLOCATOR</h4></a><ul><li>属于 SocketChannal 参数</li><li>用来分配 ByteBuf， ctx.alloc()</li><li>控制分配出来的ByteBuf是池化/非池化，直接内存/堆内存<ul><li>默认是池化 直接内存</li></ul></li></ul><blockquote><p>调用ctx.alloc()拿到的就是该分配器对象。</p></blockquote><a href=#7rcvbuf_allocator><h4 id=7rcvbuf_allocator><span class=hanchor arialabel=Anchor># </span>7）RCVBUF_ALLOCATOR</h4></a><ul><li>属于 SocketChannal 参数</li><li>控制 netty <strong>接收</strong>缓冲区大小</li><li>负责入站数据的分配，决定入站缓冲区的大小（并可动态调整），<strong>统一采用 direct 直接内存</strong>，具体池化还是非池化由 allocator 决定</li></ul><blockquote><p>ALLOCATOR 和 RCVBUF_ALLOCATOR 共同协作完成ByteBuf的初始分配。</p></blockquote><a href=#13-rpc-框架><h3 id=13-rpc-框架><span class=hanchor arialabel=Anchor># </span>1.3 RPC 框架</h3></a><a href=#1准备工作><h4 id=1准备工作><span class=hanchor arialabel=Anchor># </span>1）准备工作</h4></a><p>这些代码可以认为是现成的，无需从头编写练习</p><p>为了简化起见，在原来聊天项目的基础上新增 Rpc 请求和响应消息</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Data</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>abstract</span> <span class=kd>class</span> <span class=nc>Message</span> <span class=kd>implements</span> <span class=n>Serializable</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 省略旧的代码
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>RPC_MESSAGE_TYPE_REQUEST</span> <span class=o>=</span> <span class=n>101</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span>  <span class=n>RPC_MESSAGE_TYPE_RESPONSE</span> <span class=o>=</span> <span class=n>102</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>static</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>messageClasses</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>RPC_MESSAGE_TYPE_REQUEST</span><span class=o>,</span> <span class=n>RpcRequestMessage</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>messageClasses</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>RPC_MESSAGE_TYPE_RESPONSE</span><span class=o>,</span> <span class=n>RpcResponseMessage</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>请求消息</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Getter</span>
</span></span><span class=line><span class=cl><span class=nd>@ToString</span><span class=o>(</span><span class=n>callSuper</span> <span class=o>=</span> <span class=kc>true</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>RpcRequestMessage</span> <span class=kd>extends</span> <span class=n>Message</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 调用的接口全限定名，服务端根据它找到实现
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>String</span> <span class=n>interfaceName</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 调用接口中的方法名
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>String</span> <span class=n>methodName</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 方法返回类型
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>returnType</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 方法参数类型数组
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>Class</span><span class=o>[]</span> <span class=n>parameterTypes</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 方法参数值数组
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>Object</span><span class=o>[]</span> <span class=n>parameterValue</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=nf>RpcRequestMessage</span><span class=o>(</span><span class=kt>int</span> <span class=n>sequenceId</span><span class=o>,</span> <span class=n>String</span> <span class=n>interfaceName</span><span class=o>,</span> <span class=n>String</span> <span class=n>methodName</span><span class=o>,</span> <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>returnType</span><span class=o>,</span> <span class=n>Class</span><span class=o>[]</span> <span class=n>parameterTypes</span><span class=o>,</span> <span class=n>Object</span><span class=o>[]</span> <span class=n>parameterValue</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>super</span><span class=o>.</span><span class=na>setSequenceId</span><span class=o>(</span><span class=n>sequenceId</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>interfaceName</span> <span class=o>=</span> <span class=n>interfaceName</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>methodName</span> <span class=o>=</span> <span class=n>methodName</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>returnType</span> <span class=o>=</span> <span class=n>returnType</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>parameterTypes</span> <span class=o>=</span> <span class=n>parameterTypes</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>parameterValue</span> <span class=o>=</span> <span class=n>parameterValue</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>int</span> <span class=nf>getMessageType</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>RPC_MESSAGE_TYPE_REQUEST</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>响应消息</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Data</span>
</span></span><span class=line><span class=cl><span class=nd>@ToString</span><span class=o>(</span><span class=n>callSuper</span> <span class=o>=</span> <span class=kc>true</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>RpcResponseMessage</span> <span class=kd>extends</span> <span class=n>Message</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 返回值
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>Object</span> <span class=n>returnValue</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 异常值
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>Exception</span> <span class=n>exceptionValue</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>int</span> <span class=nf>getMessageType</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>RPC_MESSAGE_TYPE_RESPONSE</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>服务器架子</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>RpcServer</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>NioEventLoopGroup</span> <span class=n>boss</span> <span class=o>=</span> <span class=k>new</span> <span class=n>NioEventLoopGroup</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>NioEventLoopGroup</span> <span class=n>worker</span> <span class=o>=</span> <span class=k>new</span> <span class=n>NioEventLoopGroup</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>LoggingHandler</span> <span class=n>LOGGING_HANDLER</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LoggingHandler</span><span class=o>(</span><span class=n>LogLevel</span><span class=o>.</span><span class=na>DEBUG</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>MessageCodecSharable</span> <span class=n>MESSAGE_CODEC</span> <span class=o>=</span> <span class=k>new</span> <span class=n>MessageCodecSharable</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1>// rpc 请求消息处理器，待实现
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>RpcRequestMessageHandler</span> <span class=n>RPC_HANDLER</span> <span class=o>=</span> <span class=k>new</span> <span class=n>RpcRequestMessageHandler</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>ServerBootstrap</span> <span class=n>serverBootstrap</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ServerBootstrap</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>serverBootstrap</span><span class=o>.</span><span class=na>channel</span><span class=o>(</span><span class=n>NioServerSocketChannel</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>serverBootstrap</span><span class=o>.</span><span class=na>group</span><span class=o>(</span><span class=n>boss</span><span class=o>,</span> <span class=n>worker</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>serverBootstrap</span><span class=o>.</span><span class=na>childHandler</span><span class=o>(</span><span class=k>new</span> <span class=n>ChannelInitializer</span><span class=o>&lt;</span><span class=n>SocketChannel</span><span class=o>&gt;()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>                <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>initChannel</span><span class=o>(</span><span class=n>SocketChannel</span> <span class=n>ch</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>ProcotolFrameDecoder</span><span class=o>());</span>
</span></span><span class=line><span class=cl>                    <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=n>LOGGING_HANDLER</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=n>MESSAGE_CODEC</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=n>RPC_HANDLER</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>});</span>
</span></span><span class=line><span class=cl>            <span class=n>Channel</span> <span class=n>channel</span> <span class=o>=</span> <span class=n>serverBootstrap</span><span class=o>.</span><span class=na>bind</span><span class=o>(</span><span class=n>8080</span><span class=o>).</span><span class=na>sync</span><span class=o>().</span><span class=na>channel</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>channel</span><span class=o>.</span><span class=na>closeFuture</span><span class=o>().</span><span class=na>sync</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=o>.</span><span class=na>error</span><span class=o>(</span><span class=s>&#34;server error&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>boss</span><span class=o>.</span><span class=na>shutdownGracefully</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>worker</span><span class=o>.</span><span class=na>shutdownGracefully</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>客户端架子</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>RpcClient</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>NioEventLoopGroup</span> <span class=n>group</span> <span class=o>=</span> <span class=k>new</span> <span class=n>NioEventLoopGroup</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>LoggingHandler</span> <span class=n>LOGGING_HANDLER</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LoggingHandler</span><span class=o>(</span><span class=n>LogLevel</span><span class=o>.</span><span class=na>DEBUG</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>MessageCodecSharable</span> <span class=n>MESSAGE_CODEC</span> <span class=o>=</span> <span class=k>new</span> <span class=n>MessageCodecSharable</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1>// rpc 响应消息处理器，待实现
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>RpcResponseMessageHandler</span> <span class=n>RPC_HANDLER</span> <span class=o>=</span> <span class=k>new</span> <span class=n>RpcResponseMessageHandler</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Bootstrap</span> <span class=n>bootstrap</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Bootstrap</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>bootstrap</span><span class=o>.</span><span class=na>channel</span><span class=o>(</span><span class=n>NioSocketChannel</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>bootstrap</span><span class=o>.</span><span class=na>group</span><span class=o>(</span><span class=n>group</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>bootstrap</span><span class=o>.</span><span class=na>handler</span><span class=o>(</span><span class=k>new</span> <span class=n>ChannelInitializer</span><span class=o>&lt;</span><span class=n>SocketChannel</span><span class=o>&gt;()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>                <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>initChannel</span><span class=o>(</span><span class=n>SocketChannel</span> <span class=n>ch</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>ProcotolFrameDecoder</span><span class=o>());</span>
</span></span><span class=line><span class=cl>                    <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=n>LOGGING_HANDLER</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=n>MESSAGE_CODEC</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=n>RPC_HANDLER</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>});</span>
</span></span><span class=line><span class=cl>            <span class=n>Channel</span> <span class=n>channel</span> <span class=o>=</span> <span class=n>bootstrap</span><span class=o>.</span><span class=na>connect</span><span class=o>(</span><span class=s>&#34;localhost&#34;</span><span class=o>,</span> <span class=n>8080</span><span class=o>).</span><span class=na>sync</span><span class=o>().</span><span class=na>channel</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>channel</span><span class=o>.</span><span class=na>closeFuture</span><span class=o>().</span><span class=na>sync</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Exception</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=o>.</span><span class=na>error</span><span class=o>(</span><span class=s>&#34;client error&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>group</span><span class=o>.</span><span class=na>shutdownGracefully</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>服务器端的 service 获取</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>ServicesFactory</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>static</span> <span class=n>Properties</span> <span class=n>properties</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>static</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;?&gt;,</span> <span class=n>Object</span><span class=o>&gt;</span> <span class=n>map</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ConcurrentHashMap</span><span class=o>&lt;&gt;();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>static</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>(</span><span class=n>InputStream</span> <span class=n>in</span> <span class=o>=</span> <span class=n>Config</span><span class=o>.</span><span class=na>class</span><span class=o>.</span><span class=na>getResourceAsStream</span><span class=o>(</span><span class=s>&#34;/application.properties&#34;</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>properties</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Properties</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>properties</span><span class=o>.</span><span class=na>load</span><span class=o>(</span><span class=n>in</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>Set</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>names</span> <span class=o>=</span> <span class=n>properties</span><span class=o>.</span><span class=na>stringPropertyNames</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=o>(</span><span class=n>String</span> <span class=n>name</span> <span class=o>:</span> <span class=n>names</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>name</span><span class=o>.</span><span class=na>endsWith</span><span class=o>(</span><span class=s>&#34;Service&#34;</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>interfaceClass</span> <span class=o>=</span> <span class=n>Class</span><span class=o>.</span><span class=na>forName</span><span class=o>(</span><span class=n>name</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>instanceClass</span> <span class=o>=</span> <span class=n>Class</span><span class=o>.</span><span class=na>forName</span><span class=o>(</span><span class=n>properties</span><span class=o>.</span><span class=na>getProperty</span><span class=o>(</span><span class=n>name</span><span class=o>));</span>
</span></span><span class=line><span class=cl>                    <span class=n>map</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>interfaceClass</span><span class=o>,</span> <span class=n>instanceClass</span><span class=o>.</span><span class=na>newInstance</span><span class=o>());</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=o>|</span> <span class=n>ClassNotFoundException</span> <span class=o>|</span> <span class=n>InstantiationException</span> <span class=o>|</span> <span class=n>IllegalAccessException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>ExceptionInInitializerError</span><span class=o>(</span><span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>T</span> <span class=nf>getService</span><span class=o>(</span><span class=n>Class</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>interfaceClass</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=o>(</span><span class=n>T</span><span class=o>)</span> <span class=n>map</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>interfaceClass</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>相关配置 application.properties</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>serializer.algorithm=Json
</span></span><span class=line><span class=cl>cn.itcast.server.service.HelloService=cn.itcast.server.service.HelloServiceImpl
</span></span></code></pre></td></tr></table></div></div><a href=#2服务器-handler><h4 id=2服务器-handler><span class=hanchor arialabel=Anchor># </span>2）服务器 handler</h4></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span>
</span></span><span class=line><span class=cl><span class=nd>@ChannelHandler.Sharable</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>RpcRequestMessageHandler</span> <span class=kd>extends</span> <span class=n>SimpleChannelInboundHandler</span><span class=o>&lt;</span><span class=n>RpcRequestMessage</span><span class=o>&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>channelRead0</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>,</span> <span class=n>RpcRequestMessage</span> <span class=n>message</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>RpcResponseMessage</span> <span class=n>response</span> <span class=o>=</span> <span class=k>new</span> <span class=n>RpcResponseMessage</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span><span class=o>.</span><span class=na>setSequenceId</span><span class=o>(</span><span class=n>message</span><span class=o>.</span><span class=na>getSequenceId</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 获取真正的实现对象
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>HelloService</span> <span class=n>service</span> <span class=o>=</span> <span class=o>(</span><span class=n>HelloService</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                    <span class=n>ServicesFactory</span><span class=o>.</span><span class=na>getService</span><span class=o>(</span><span class=n>Class</span><span class=o>.</span><span class=na>forName</span><span class=o>(</span><span class=n>message</span><span class=o>.</span><span class=na>getInterfaceName</span><span class=o>()));</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1>// 获取要调用的方法
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>Method</span> <span class=n>method</span> <span class=o>=</span> <span class=n>service</span><span class=o>.</span><span class=na>getClass</span><span class=o>().</span><span class=na>getMethod</span><span class=o>(</span><span class=n>message</span><span class=o>.</span><span class=na>getMethodName</span><span class=o>(),</span> <span class=n>message</span><span class=o>.</span><span class=na>getParameterTypes</span><span class=o>());</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1>// 调用方法
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>Object</span> <span class=n>invoke</span> <span class=o>=</span> <span class=n>method</span><span class=o>.</span><span class=na>invoke</span><span class=o>(</span><span class=n>service</span><span class=o>,</span> <span class=n>message</span><span class=o>.</span><span class=na>getParameterValue</span><span class=o>());</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 调用成功
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>response</span><span class=o>.</span><span class=na>setReturnValue</span><span class=o>(</span><span class=n>invoke</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Exception</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 调用异常
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>response</span><span class=o>.</span><span class=na>setExceptionValue</span><span class=o>(</span><span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 返回结果
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>ctx</span><span class=o>.</span><span class=na>writeAndFlush</span><span class=o>(</span><span class=n>response</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#3客户端代码第一版><h4 id=3客户端代码第一版><span class=hanchor arialabel=Anchor># </span>3）客户端代码第一版</h4></a><p>只发消息</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>RpcClient</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>NioEventLoopGroup</span> <span class=n>group</span> <span class=o>=</span> <span class=k>new</span> <span class=n>NioEventLoopGroup</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>LoggingHandler</span> <span class=n>LOGGING_HANDLER</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LoggingHandler</span><span class=o>(</span><span class=n>LogLevel</span><span class=o>.</span><span class=na>DEBUG</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>MessageCodecSharable</span> <span class=n>MESSAGE_CODEC</span> <span class=o>=</span> <span class=k>new</span> <span class=n>MessageCodecSharable</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>RpcResponseMessageHandler</span> <span class=n>RPC_HANDLER</span> <span class=o>=</span> <span class=k>new</span> <span class=n>RpcResponseMessageHandler</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Bootstrap</span> <span class=n>bootstrap</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Bootstrap</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>bootstrap</span><span class=o>.</span><span class=na>channel</span><span class=o>(</span><span class=n>NioSocketChannel</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>bootstrap</span><span class=o>.</span><span class=na>group</span><span class=o>(</span><span class=n>group</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>bootstrap</span><span class=o>.</span><span class=na>handler</span><span class=o>(</span><span class=k>new</span> <span class=n>ChannelInitializer</span><span class=o>&lt;</span><span class=n>SocketChannel</span><span class=o>&gt;()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>                <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>initChannel</span><span class=o>(</span><span class=n>SocketChannel</span> <span class=n>ch</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>ProcotolFrameDecoder</span><span class=o>());</span>
</span></span><span class=line><span class=cl>                    <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=n>LOGGING_HANDLER</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=n>MESSAGE_CODEC</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=n>RPC_HANDLER</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>});</span>
</span></span><span class=line><span class=cl>            <span class=n>Channel</span> <span class=n>channel</span> <span class=o>=</span> <span class=n>bootstrap</span><span class=o>.</span><span class=na>connect</span><span class=o>(</span><span class=s>&#34;localhost&#34;</span><span class=o>,</span> <span class=n>8080</span><span class=o>).</span><span class=na>sync</span><span class=o>().</span><span class=na>channel</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>ChannelFuture</span> <span class=n>future</span> <span class=o>=</span> <span class=n>channel</span><span class=o>.</span><span class=na>writeAndFlush</span><span class=o>(</span><span class=k>new</span> <span class=n>RpcRequestMessage</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                    <span class=n>1</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                    <span class=s>&#34;cn.itcast.server.service.HelloService&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                    <span class=s>&#34;sayHello&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>String</span><span class=o>.</span><span class=na>class</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                    <span class=k>new</span> <span class=n>Class</span><span class=o>[]{</span><span class=n>String</span><span class=o>.</span><span class=na>class</span><span class=o>},</span>
</span></span><span class=line><span class=cl>                    <span class=k>new</span> <span class=n>Object</span><span class=o>[]{</span><span class=s>&#34;张三&#34;</span><span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>)).</span><span class=na>addListener</span><span class=o>(</span><span class=n>promise</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(!</span><span class=n>promise</span><span class=o>.</span><span class=na>isSuccess</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>Throwable</span> <span class=n>cause</span> <span class=o>=</span> <span class=n>promise</span><span class=o>.</span><span class=na>cause</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                    <span class=n>log</span><span class=o>.</span><span class=na>error</span><span class=o>(</span><span class=s>&#34;error&#34;</span><span class=o>,</span> <span class=n>cause</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>channel</span><span class=o>.</span><span class=na>closeFuture</span><span class=o>().</span><span class=na>sync</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Exception</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=o>.</span><span class=na>error</span><span class=o>(</span><span class=s>&#34;client error&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>group</span><span class=o>.</span><span class=na>shutdownGracefully</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#4客户端-handler-第一版><h4 id=4客户端-handler-第一版><span class=hanchor arialabel=Anchor># </span>4）客户端 handler 第一版</h4></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span>
</span></span><span class=line><span class=cl><span class=nd>@ChannelHandler.Sharable</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>RpcResponseMessageHandler</span> <span class=kd>extends</span> <span class=n>SimpleChannelInboundHandler</span><span class=o>&lt;</span><span class=n>RpcResponseMessage</span><span class=o>&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>channelRead0</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>,</span> <span class=n>RpcResponseMessage</span> <span class=n>msg</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;{}&#34;</span><span class=o>,</span> <span class=n>msg</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#5客户端代码-第二版><h4 id=5客户端代码-第二版><span class=hanchor arialabel=Anchor># </span>5）客户端代码 第二版</h4></a><p>包括 channel 管理，代理，接收结果</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span><span class=lnt>92
</span><span class=lnt>93
</span><span class=lnt>94
</span><span class=lnt>95
</span><span class=lnt>96
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>RpcClientManager</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>HelloService</span> <span class=n>service</span> <span class=o>=</span> <span class=n>getProxyService</span><span class=o>(</span><span class=n>HelloService</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>service</span><span class=o>.</span><span class=na>sayHello</span><span class=o>(</span><span class=s>&#34;zhangsan&#34;</span><span class=o>));</span>
</span></span><span class=line><span class=cl><span class=c1>//        System.out.println(service.sayHello(&#34;lisi&#34;));
</span></span></span><span class=line><span class=cl><span class=c1>//        System.out.println(service.sayHello(&#34;wangwu&#34;));
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 创建代理类
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>public</span> <span class=kd>static</span> <span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>T</span> <span class=nf>getProxyService</span><span class=o>(</span><span class=n>Class</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>serviceClass</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ClassLoader</span> <span class=n>loader</span> <span class=o>=</span> <span class=n>serviceClass</span><span class=o>.</span><span class=na>getClassLoader</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>Class</span><span class=o>&lt;?&gt;[]</span> <span class=n>interfaces</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Class</span><span class=o>[]{</span><span class=n>serviceClass</span><span class=o>};</span>
</span></span><span class=line><span class=cl>        <span class=c1>//                                                            sayHello  &#34;张三&#34;
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>Object</span> <span class=n>o</span> <span class=o>=</span> <span class=n>Proxy</span><span class=o>.</span><span class=na>newProxyInstance</span><span class=o>(</span><span class=n>loader</span><span class=o>,</span> <span class=n>interfaces</span><span class=o>,</span> <span class=o>(</span><span class=n>proxy</span><span class=o>,</span> <span class=n>method</span><span class=o>,</span> <span class=n>args</span><span class=o>)</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 1. 将方法调用转换为 消息对象
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=kt>int</span> <span class=n>sequenceId</span> <span class=o>=</span> <span class=n>SequenceIdGenerator</span><span class=o>.</span><span class=na>nextId</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>RpcRequestMessage</span> <span class=n>msg</span> <span class=o>=</span> <span class=k>new</span> <span class=n>RpcRequestMessage</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                    <span class=n>sequenceId</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>serviceClass</span><span class=o>.</span><span class=na>getName</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>                    <span class=n>method</span><span class=o>.</span><span class=na>getName</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>                    <span class=n>method</span><span class=o>.</span><span class=na>getReturnType</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>                    <span class=n>method</span><span class=o>.</span><span class=na>getParameterTypes</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>                    <span class=n>args</span>
</span></span><span class=line><span class=cl>            <span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 2. 将消息对象发送出去
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>getChannel</span><span class=o>().</span><span class=na>writeAndFlush</span><span class=o>(</span><span class=n>msg</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1>// 3. 准备一个空 Promise 对象，来接收结果             指定 promise 对象异步接收结果线程
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>DefaultPromise</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span> <span class=n>promise</span> <span class=o>=</span> <span class=k>new</span> <span class=n>DefaultPromise</span><span class=o>&lt;&gt;(</span><span class=n>getChannel</span><span class=o>().</span><span class=na>eventLoop</span><span class=o>());</span>
</span></span><span class=line><span class=cl>            <span class=n>RpcResponseMessageHandler</span><span class=o>.</span><span class=na>PROMISES</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>sequenceId</span><span class=o>,</span> <span class=n>promise</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//            promise.addListener(future -&gt; {
</span></span></span><span class=line><span class=cl><span class=c1>//                // 线程
</span></span></span><span class=line><span class=cl><span class=c1>//            });
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>            <span class=c1>// 4. 等待 promise 结果
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>promise</span><span class=o>.</span><span class=na>await</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span><span class=o>(</span><span class=n>promise</span><span class=o>.</span><span class=na>isSuccess</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 调用正常
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=k>return</span> <span class=n>promise</span><span class=o>.</span><span class=na>getNow</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 调用失败
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=k>throw</span> <span class=k>new</span> <span class=n>RuntimeException</span><span class=o>(</span><span class=n>promise</span><span class=o>.</span><span class=na>cause</span><span class=o>());</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>});</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=o>(</span><span class=n>T</span><span class=o>)</span> <span class=n>o</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=n>Channel</span> <span class=n>channel</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>Object</span> <span class=n>LOCK</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Object</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 获取唯一的 channel 对象
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>public</span> <span class=kd>static</span> <span class=n>Channel</span> <span class=nf>getChannel</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>channel</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>channel</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=kd>synchronized</span> <span class=o>(</span><span class=n>LOCK</span><span class=o>)</span> <span class=o>{</span> <span class=c1>//  t2
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>if</span> <span class=o>(</span><span class=n>channel</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span> <span class=c1>// t1
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=k>return</span> <span class=n>channel</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=n>initChannel</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>channel</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 初始化 channel 方法
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>private</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>initChannel</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>NioEventLoopGroup</span> <span class=n>group</span> <span class=o>=</span> <span class=k>new</span> <span class=n>NioEventLoopGroup</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>LoggingHandler</span> <span class=n>LOGGING_HANDLER</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LoggingHandler</span><span class=o>(</span><span class=n>LogLevel</span><span class=o>.</span><span class=na>DEBUG</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>MessageCodecSharable</span> <span class=n>MESSAGE_CODEC</span> <span class=o>=</span> <span class=k>new</span> <span class=n>MessageCodecSharable</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>RpcResponseMessageHandler</span> <span class=n>RPC_HANDLER</span> <span class=o>=</span> <span class=k>new</span> <span class=n>RpcResponseMessageHandler</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>Bootstrap</span> <span class=n>bootstrap</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Bootstrap</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>bootstrap</span><span class=o>.</span><span class=na>channel</span><span class=o>(</span><span class=n>NioSocketChannel</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>bootstrap</span><span class=o>.</span><span class=na>group</span><span class=o>(</span><span class=n>group</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>bootstrap</span><span class=o>.</span><span class=na>handler</span><span class=o>(</span><span class=k>new</span> <span class=n>ChannelInitializer</span><span class=o>&lt;</span><span class=n>SocketChannel</span><span class=o>&gt;()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>            <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>initChannel</span><span class=o>(</span><span class=n>SocketChannel</span> <span class=n>ch</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>ProcotolFrameDecoder</span><span class=o>());</span>
</span></span><span class=line><span class=cl>                <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=n>LOGGING_HANDLER</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=n>MESSAGE_CODEC</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=n>RPC_HANDLER</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>});</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>channel</span> <span class=o>=</span> <span class=n>bootstrap</span><span class=o>.</span><span class=na>connect</span><span class=o>(</span><span class=s>&#34;localhost&#34;</span><span class=o>,</span> <span class=n>8080</span><span class=o>).</span><span class=na>sync</span><span class=o>().</span><span class=na>channel</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>channel</span><span class=o>.</span><span class=na>closeFuture</span><span class=o>().</span><span class=na>addListener</span><span class=o>(</span><span class=n>future</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>group</span><span class=o>.</span><span class=na>shutdownGracefully</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>});</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Exception</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=o>.</span><span class=na>error</span><span class=o>(</span><span class=s>&#34;client error&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#6客户端-handler-第二版><h4 id=6客户端-handler-第二版><span class=hanchor arialabel=Anchor># </span>6）客户端 handler 第二版</h4></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span>
</span></span><span class=line><span class=cl><span class=nd>@ChannelHandler.Sharable</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>RpcResponseMessageHandler</span> <span class=kd>extends</span> <span class=n>SimpleChannelInboundHandler</span><span class=o>&lt;</span><span class=n>RpcResponseMessage</span><span class=o>&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//                       序号      用来接收结果的 promise 对象
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>,</span> <span class=n>Promise</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;&gt;</span> <span class=n>PROMISES</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ConcurrentHashMap</span><span class=o>&lt;&gt;();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>channelRead0</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>,</span> <span class=n>RpcResponseMessage</span> <span class=n>msg</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;{}&#34;</span><span class=o>,</span> <span class=n>msg</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 拿到空的 promise
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>Promise</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span> <span class=n>promise</span> <span class=o>=</span> <span class=n>PROMISES</span><span class=o>.</span><span class=na>remove</span><span class=o>(</span><span class=n>msg</span><span class=o>.</span><span class=na>getSequenceId</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>promise</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Object</span> <span class=n>returnValue</span> <span class=o>=</span> <span class=n>msg</span><span class=o>.</span><span class=na>getReturnValue</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>Exception</span> <span class=n>exceptionValue</span> <span class=o>=</span> <span class=n>msg</span><span class=o>.</span><span class=na>getExceptionValue</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span><span class=o>(</span><span class=n>exceptionValue</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>promise</span><span class=o>.</span><span class=na>setFailure</span><span class=o>(</span><span class=n>exceptionValue</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>promise</span><span class=o>.</span><span class=na>setSuccess</span><span class=o>(</span><span class=n>returnValue</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p><img src="/z-oblib/z2-attachments/Pasted image 20220624192123.png" width=auto></p><a href=#2-源码分析><h2 id=2-源码分析><span class=hanchor arialabel=Anchor># </span>2. 源码分析</h2></a><a href=#21-启动剖析><h3 id=21-启动剖析><span class=hanchor arialabel=Anchor># </span>2.1 启动剖析</h3></a><p>主要步骤：</p><ol><li>打开select</li><li>打开ssc</li><li>channel绑定到select上</li><li>通过selectionKey关注accept事件</li></ol><p><img src="/z-oblib/z2-attachments/Pasted image 20220624213014.png" width=auto></p><p>我们就来看看 netty 中对下面的代码是怎样进行处理的</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>//1 netty 中使用 NioEventLoopGroup （简称 nio boss 线程）来封装线程和 selector
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>Selector</span> <span class=n>selector</span> <span class=o>=</span> <span class=n>Selector</span><span class=o>.</span><span class=na>open</span><span class=o>();</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//2 创建 NioServerSocketChannel，同时会初始化它关联的 handler，以及为原生 ssc 存储 config
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>NioServerSocketChannel</span> <span class=n>attachment</span> <span class=o>=</span> <span class=k>new</span> <span class=n>NioServerSocketChannel</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//3 创建 NioServerSocketChannel 时，创建了 java 原生的 ServerSocketChannel
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>ServerSocketChannel</span> <span class=n>serverSocketChannel</span> <span class=o>=</span> <span class=n>ServerSocketChannel</span><span class=o>.</span><span class=na>open</span><span class=o>();</span> 
</span></span><span class=line><span class=cl><span class=n>serverSocketChannel</span><span class=o>.</span><span class=na>configureBlocking</span><span class=o>(</span><span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//4 启动 nio boss 线程执行接下来的操作
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>//5 注册（仅关联 selector 和 NioServerSocketChannel），未关注事件
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>SelectionKey</span> <span class=n>selectionKey</span> <span class=o>=</span> <span class=n>serverSocketChannel</span><span class=o>.</span><span class=na>register</span><span class=o>(</span><span class=n>selector</span><span class=o>,</span> <span class=n>0</span><span class=o>,</span> <span class=n>attachment</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//6 head -&gt; 初始化器 -&gt; ServerBootstrapAcceptor -&gt; tail，初始化器是一次性的，只为添加 acceptor
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>//7 绑定端口
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>serverSocketChannel</span><span class=o>.</span><span class=na>bind</span><span class=o>(</span><span class=k>new</span> <span class=n>InetSocketAddress</span><span class=o>(</span><span class=n>8080</span><span class=o>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//8 触发 channel active 事件，在 head 中关注 op_accept 事件
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>selectionKey</span><span class=o>.</span><span class=na>interestOps</span><span class=o>(</span><span class=n>SelectionKey</span><span class=o>.</span><span class=na>OP_ACCEPT</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><p>入口 <code>io.netty.bootstrap.ServerBootstrap#bind</code></p><p>关键代码 <code>io.netty.bootstrap.AbstractBootstrap#doBind</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=n>ChannelFuture</span> <span class=nf>doBind</span><span class=o>(</span><span class=kd>final</span> <span class=n>SocketAddress</span> <span class=n>localAddress</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 1. 执行初始化和注册 regFuture 会由 initAndRegister 设置其是否完成，从而回调 3.2 处代码
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>final</span> <span class=n>ChannelFuture</span> <span class=n>regFuture</span> <span class=o>=</span> <span class=n>initAndRegister</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=n>Channel</span> <span class=n>channel</span> <span class=o>=</span> <span class=n>regFuture</span><span class=o>.</span><span class=na>channel</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>regFuture</span><span class=o>.</span><span class=na>cause</span><span class=o>()</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>regFuture</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 2. 因为是 initAndRegister 异步执行，需要分两种情况来看，调试时也需要通过 suspend 断点类型加以区分
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 2.1 如果已经完成
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>(</span><span class=n>regFuture</span><span class=o>.</span><span class=na>isDone</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ChannelPromise</span> <span class=n>promise</span> <span class=o>=</span> <span class=n>channel</span><span class=o>.</span><span class=na>newPromise</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 3.1 立刻调用 doBind0
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>doBind0</span><span class=o>(</span><span class=n>regFuture</span><span class=o>,</span> <span class=n>channel</span><span class=o>,</span> <span class=n>localAddress</span><span class=o>,</span> <span class=n>promise</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>promise</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> 
</span></span><span class=line><span class=cl>    <span class=c1>// 2.2 还没有完成
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>final</span> <span class=n>PendingRegistrationPromise</span> <span class=n>promise</span> <span class=o>=</span> <span class=k>new</span> <span class=n>PendingRegistrationPromise</span><span class=o>(</span><span class=n>channel</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 3.2 回调 doBind0
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>regFuture</span><span class=o>.</span><span class=na>addListener</span><span class=o>(</span><span class=k>new</span> <span class=n>ChannelFutureListener</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>            <span class=kd>public</span> <span class=kt>void</span> <span class=nf>operationComplete</span><span class=o>(</span><span class=n>ChannelFuture</span> <span class=n>future</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>Throwable</span> <span class=n>cause</span> <span class=o>=</span> <span class=n>future</span><span class=o>.</span><span class=na>cause</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>cause</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=c1>// 处理异常...
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=n>promise</span><span class=o>.</span><span class=na>setFailure</span><span class=o>(</span><span class=n>cause</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>promise</span><span class=o>.</span><span class=na>registered</span><span class=o>();</span>
</span></span><span class=line><span class=cl>					<span class=c1>// 3. 由注册线程去执行 doBind0
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=n>doBind0</span><span class=o>(</span><span class=n>regFuture</span><span class=o>,</span> <span class=n>channel</span><span class=o>,</span> <span class=n>localAddress</span><span class=o>,</span> <span class=n>promise</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>});</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>promise</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>关键代码 <code>io.netty.bootstrap.AbstractBootstrap#initAndRegister</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>final</span> <span class=n>ChannelFuture</span> <span class=nf>initAndRegister</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Channel</span> <span class=n>channel</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>channel</span> <span class=o>=</span> <span class=n>channelFactory</span><span class=o>.</span><span class=na>newChannel</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 1.1 初始化 - 做的事就是添加一个初始化器 ChannelInitializer
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>init</span><span class=o>(</span><span class=n>channel</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Throwable</span> <span class=n>t</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 处理异常...
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>return</span> <span class=k>new</span> <span class=n>DefaultChannelPromise</span><span class=o>(</span><span class=k>new</span> <span class=n>FailedChannel</span><span class=o>(),</span> <span class=n>GlobalEventExecutor</span><span class=o>.</span><span class=na>INSTANCE</span><span class=o>).</span><span class=na>setFailure</span><span class=o>(</span><span class=n>t</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 1.2 注册 - 做的事就是将原生 channel 注册到 selector 上
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>ChannelFuture</span> <span class=n>regFuture</span> <span class=o>=</span> <span class=n>config</span><span class=o>().</span><span class=na>group</span><span class=o>().</span><span class=na>register</span><span class=o>(</span><span class=n>channel</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>regFuture</span><span class=o>.</span><span class=na>cause</span><span class=o>()</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 处理异常...
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>regFuture</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>关键代码 <code>io.netty.bootstrap.ServerBootstrap#init</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 这里 channel 实际上是 NioServerSocketChannel
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span> <span class=nf>init</span><span class=o>(</span><span class=n>Channel</span> <span class=n>channel</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>ChannelOption</span><span class=o>&lt;?&gt;,</span> <span class=n>Object</span><span class=o>&gt;</span> <span class=n>options</span> <span class=o>=</span> <span class=n>options0</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=kd>synchronized</span> <span class=o>(</span><span class=n>options</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>setChannelOptions</span><span class=o>(</span><span class=n>channel</span><span class=o>,</span> <span class=n>options</span><span class=o>,</span> <span class=n>logger</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>AttributeKey</span><span class=o>&lt;?&gt;,</span> <span class=n>Object</span><span class=o>&gt;</span> <span class=n>attrs</span> <span class=o>=</span> <span class=n>attrs0</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=kd>synchronized</span> <span class=o>(</span><span class=n>attrs</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=o>(</span><span class=n>Entry</span><span class=o>&lt;</span><span class=n>AttributeKey</span><span class=o>&lt;?&gt;,</span> <span class=n>Object</span><span class=o>&gt;</span> <span class=n>e</span><span class=o>:</span> <span class=n>attrs</span><span class=o>.</span><span class=na>entrySet</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=nd>@SuppressWarnings</span><span class=o>(</span><span class=s>&#34;unchecked&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>            <span class=n>AttributeKey</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span> <span class=n>key</span> <span class=o>=</span> <span class=o>(</span><span class=n>AttributeKey</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;)</span> <span class=n>e</span><span class=o>.</span><span class=na>getKey</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>channel</span><span class=o>.</span><span class=na>attr</span><span class=o>(</span><span class=n>key</span><span class=o>).</span><span class=na>set</span><span class=o>(</span><span class=n>e</span><span class=o>.</span><span class=na>getValue</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>ChannelPipeline</span> <span class=n>p</span> <span class=o>=</span> <span class=n>channel</span><span class=o>.</span><span class=na>pipeline</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=n>EventLoopGroup</span> <span class=n>currentChildGroup</span> <span class=o>=</span> <span class=n>childGroup</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=n>ChannelHandler</span> <span class=n>currentChildHandler</span> <span class=o>=</span> <span class=n>childHandler</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=n>Entry</span><span class=o>&lt;</span><span class=n>ChannelOption</span><span class=o>&lt;?&gt;,</span> <span class=n>Object</span><span class=o>&gt;[]</span> <span class=n>currentChildOptions</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=n>Entry</span><span class=o>&lt;</span><span class=n>AttributeKey</span><span class=o>&lt;?&gt;,</span> <span class=n>Object</span><span class=o>&gt;[]</span> <span class=n>currentChildAttrs</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>synchronized</span> <span class=o>(</span><span class=n>childOptions</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>currentChildOptions</span> <span class=o>=</span> <span class=n>childOptions</span><span class=o>.</span><span class=na>entrySet</span><span class=o>().</span><span class=na>toArray</span><span class=o>(</span><span class=n>newOptionArray</span><span class=o>(</span><span class=n>0</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=kd>synchronized</span> <span class=o>(</span><span class=n>childAttrs</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>currentChildAttrs</span> <span class=o>=</span> <span class=n>childAttrs</span><span class=o>.</span><span class=na>entrySet</span><span class=o>().</span><span class=na>toArray</span><span class=o>(</span><span class=n>newAttrArray</span><span class=o>(</span><span class=n>0</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>    <span class=c1>// 为 NioServerSocketChannel 添加初始化器
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>p</span><span class=o>.</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>ChannelInitializer</span><span class=o>&lt;</span><span class=n>Channel</span><span class=o>&gt;()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>initChannel</span><span class=o>(</span><span class=kd>final</span> <span class=n>Channel</span> <span class=n>ch</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=kd>final</span> <span class=n>ChannelPipeline</span> <span class=n>pipeline</span> <span class=o>=</span> <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>ChannelHandler</span> <span class=n>handler</span> <span class=o>=</span> <span class=n>config</span><span class=o>.</span><span class=na>handler</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>handler</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>pipeline</span><span class=o>.</span><span class=na>addLast</span><span class=o>(</span><span class=n>handler</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1>// 初始化器的职责是将 ServerBootstrapAcceptor 加入至 NioServerSocketChannel
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>ch</span><span class=o>.</span><span class=na>eventLoop</span><span class=o>().</span><span class=na>execute</span><span class=o>(</span><span class=k>new</span> <span class=n>Runnable</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>                <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>pipeline</span><span class=o>.</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>ServerBootstrapAcceptor</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                            <span class=n>ch</span><span class=o>,</span> <span class=n>currentChildGroup</span><span class=o>,</span> <span class=n>currentChildHandler</span><span class=o>,</span> <span class=n>currentChildOptions</span><span class=o>,</span> <span class=n>currentChildAttrs</span><span class=o>));</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>});</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>});</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>关键代码 <code>io.netty.channel.AbstractChannel.AbstractUnsafe#register</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>final</span> <span class=kt>void</span> <span class=nf>register</span><span class=o>(</span><span class=n>EventLoop</span> <span class=n>eventLoop</span><span class=o>,</span> <span class=kd>final</span> <span class=n>ChannelPromise</span> <span class=n>promise</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 一些检查，略...
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=n>AbstractChannel</span><span class=o>.</span><span class=na>this</span><span class=o>.</span><span class=na>eventLoop</span> <span class=o>=</span> <span class=n>eventLoop</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>eventLoop</span><span class=o>.</span><span class=na>inEventLoop</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>register0</span><span class=o>(</span><span class=n>promise</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 首次执行 execute 方法时，会启动 nio 线程，之后注册等操作在 nio 线程上执行
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// 因为只有一个 NioServerSocketChannel 因此，也只会有一个 boss nio 线程
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// 这行代码完成的事实是 main -&gt; nio boss 线程的切换
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>eventLoop</span><span class=o>.</span><span class=na>execute</span><span class=o>(</span><span class=k>new</span> <span class=n>Runnable</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>                <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>register0</span><span class=o>(</span><span class=n>promise</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>});</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Throwable</span> <span class=n>t</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 日志记录...
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>closeForcibly</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>closeFuture</span><span class=o>.</span><span class=na>setClosed</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>safeSetFailure</span><span class=o>(</span><span class=n>promise</span><span class=o>,</span> <span class=n>t</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>io.netty.channel.AbstractChannel.AbstractUnsafe#register0</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kt>void</span> <span class=nf>register0</span><span class=o>(</span><span class=n>ChannelPromise</span> <span class=n>promise</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(!</span><span class=n>promise</span><span class=o>.</span><span class=na>setUncancellable</span><span class=o>()</span> <span class=o>||</span> <span class=o>!</span><span class=n>ensureOpen</span><span class=o>(</span><span class=n>promise</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=kt>boolean</span> <span class=n>firstRegistration</span> <span class=o>=</span> <span class=n>neverRegistered</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 1.2.1 原生的 nio channel 绑定到 selector 上，注意此时没有注册 selector 关注事件，附件为 NioServerSocketChannel
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>doRegister</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>neverRegistered</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>registered</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// 1.2.2 执行 NioServerSocketChannel 初始化器的 initChannel
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>pipeline</span><span class=o>.</span><span class=na>invokeHandlerAddedIfNeeded</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// 回调 3.2 io.netty.bootstrap.AbstractBootstrap#doBind0
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>safeSetSuccess</span><span class=o>(</span><span class=n>promise</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>pipeline</span><span class=o>.</span><span class=na>fireChannelRegistered</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1>// 对应 server socket channel 还未绑定，isActive 为 false
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=o>(</span><span class=n>isActive</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>firstRegistration</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>pipeline</span><span class=o>.</span><span class=na>fireChannelActive</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>config</span><span class=o>().</span><span class=na>isAutoRead</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>beginRead</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Throwable</span> <span class=n>t</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Close the channel directly to avoid FD leak.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>closeForcibly</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>closeFuture</span><span class=o>.</span><span class=na>setClosed</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>safeSetFailure</span><span class=o>(</span><span class=n>promise</span><span class=o>,</span> <span class=n>t</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>关键代码 <code>io.netty.channel.ChannelInitializer#initChannel</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kt>boolean</span> <span class=nf>initChannel</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>initMap</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>ctx</span><span class=o>))</span> <span class=o>{</span> <span class=c1>// Guard against re-entrance.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 1.2.2.1 执行初始化
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>initChannel</span><span class=o>((</span><span class=n>C</span><span class=o>)</span> <span class=n>ctx</span><span class=o>.</span><span class=na>channel</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Throwable</span> <span class=n>cause</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>exceptionCaught</span><span class=o>(</span><span class=n>ctx</span><span class=o>,</span> <span class=n>cause</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 1.2.2.2 移除初始化器
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>ChannelPipeline</span> <span class=n>pipeline</span> <span class=o>=</span> <span class=n>ctx</span><span class=o>.</span><span class=na>pipeline</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>pipeline</span><span class=o>.</span><span class=na>context</span><span class=o>(</span><span class=k>this</span><span class=o>)</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>pipeline</span><span class=o>.</span><span class=na>remove</span><span class=o>(</span><span class=k>this</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>关键代码 <code>io.netty.bootstrap.AbstractBootstrap#doBind0</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 3.1 或 3.2 执行 doBind0
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>private</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>doBind0</span><span class=o>(</span>
</span></span><span class=line><span class=cl>        <span class=kd>final</span> <span class=n>ChannelFuture</span> <span class=n>regFuture</span><span class=o>,</span> <span class=kd>final</span> <span class=n>Channel</span> <span class=n>channel</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=kd>final</span> <span class=n>SocketAddress</span> <span class=n>localAddress</span><span class=o>,</span> <span class=kd>final</span> <span class=n>ChannelPromise</span> <span class=n>promise</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>channel</span><span class=o>.</span><span class=na>eventLoop</span><span class=o>().</span><span class=na>execute</span><span class=o>(</span><span class=k>new</span> <span class=n>Runnable</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>regFuture</span><span class=o>.</span><span class=na>isSuccess</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>channel</span><span class=o>.</span><span class=na>bind</span><span class=o>(</span><span class=n>localAddress</span><span class=o>,</span> <span class=n>promise</span><span class=o>).</span><span class=na>addListener</span><span class=o>(</span><span class=n>ChannelFutureListener</span><span class=o>.</span><span class=na>CLOSE_ON_FAILURE</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>promise</span><span class=o>.</span><span class=na>setFailure</span><span class=o>(</span><span class=n>regFuture</span><span class=o>.</span><span class=na>cause</span><span class=o>());</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>});</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>关键代码 <code>io.netty.channel.AbstractChannel.AbstractUnsafe#bind</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>final</span> <span class=kt>void</span> <span class=nf>bind</span><span class=o>(</span><span class=kd>final</span> <span class=n>SocketAddress</span> <span class=n>localAddress</span><span class=o>,</span> <span class=kd>final</span> <span class=n>ChannelPromise</span> <span class=n>promise</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>assertEventLoop</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(!</span><span class=n>promise</span><span class=o>.</span><span class=na>setUncancellable</span><span class=o>()</span> <span class=o>||</span> <span class=o>!</span><span class=n>ensureOpen</span><span class=o>(</span><span class=n>promise</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>Boolean</span><span class=o>.</span><span class=na>TRUE</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>config</span><span class=o>().</span><span class=na>getOption</span><span class=o>(</span><span class=n>ChannelOption</span><span class=o>.</span><span class=na>SO_BROADCAST</span><span class=o>))</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>        <span class=n>localAddress</span> <span class=k>instanceof</span> <span class=n>InetSocketAddress</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>        <span class=o>!((</span><span class=n>InetSocketAddress</span><span class=o>)</span> <span class=n>localAddress</span><span class=o>).</span><span class=na>getAddress</span><span class=o>().</span><span class=na>isAnyLocalAddress</span><span class=o>()</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>        <span class=o>!</span><span class=n>PlatformDependent</span><span class=o>.</span><span class=na>isWindows</span><span class=o>()</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>PlatformDependent</span><span class=o>.</span><span class=na>maybeSuperUser</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 记录日志...
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>boolean</span> <span class=n>wasActive</span> <span class=o>=</span> <span class=n>isActive</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 3.3 执行端口绑定
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>doBind</span><span class=o>(</span><span class=n>localAddress</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Throwable</span> <span class=n>t</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>safeSetFailure</span><span class=o>(</span><span class=n>promise</span><span class=o>,</span> <span class=n>t</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>closeIfClosed</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(!</span><span class=n>wasActive</span> <span class=o>&amp;&amp;</span> <span class=n>isActive</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>invokeLater</span><span class=o>(</span><span class=k>new</span> <span class=n>Runnable</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>            <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 3.4 触发 active 事件
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>pipeline</span><span class=o>.</span><span class=na>fireChannelActive</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>});</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>safeSetSuccess</span><span class=o>(</span><span class=n>promise</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>3.3 关键代码 <code>io.netty.channel.socket.nio.NioServerSocketChannel#doBind</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>protected</span> <span class=kt>void</span> <span class=nf>doBind</span><span class=o>(</span><span class=n>SocketAddress</span> <span class=n>localAddress</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>PlatformDependent</span><span class=o>.</span><span class=na>javaVersion</span><span class=o>()</span> <span class=o>&gt;=</span> <span class=n>7</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>javaChannel</span><span class=o>().</span><span class=na>bind</span><span class=o>(</span><span class=n>localAddress</span><span class=o>,</span> <span class=n>config</span><span class=o>.</span><span class=na>getBacklog</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>javaChannel</span><span class=o>().</span><span class=na>socket</span><span class=o>().</span><span class=na>bind</span><span class=o>(</span><span class=n>localAddress</span><span class=o>,</span> <span class=n>config</span><span class=o>.</span><span class=na>getBacklog</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>3.4 关键代码 <code>io.netty.channel.DefaultChannelPipeline.HeadContext#channelActive</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>channelActive</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ctx</span><span class=o>.</span><span class=na>fireChannelActive</span><span class=o>();</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 触发 read (NioServerSocketChannel 上的 read 不是读取数据，只是为了触发 channel 的事件注册)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>readIfIsAutoRead</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>关键代码 <code>io.netty.channel.nio.AbstractNioChannel#doBeginRead</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>protected</span> <span class=kt>void</span> <span class=nf>doBeginRead</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Channel.read() or ChannelHandlerContext.read() was called
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>final</span> <span class=n>SelectionKey</span> <span class=n>selectionKey</span> <span class=o>=</span> <span class=k>this</span><span class=o>.</span><span class=na>selectionKey</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(!</span><span class=n>selectionKey</span><span class=o>.</span><span class=na>isValid</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>readPending</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=kt>int</span> <span class=n>interestOps</span> <span class=o>=</span> <span class=n>selectionKey</span><span class=o>.</span><span class=na>interestOps</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=c1>// readInterestOp 取值是 16，在 NioServerSocketChannel 创建时初始化好，代表关注 accept 事件
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>((</span><span class=n>interestOps</span> <span class=o>&amp;</span> <span class=n>readInterestOp</span><span class=o>)</span> <span class=o>==</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>selectionKey</span><span class=o>.</span><span class=na>interestOps</span><span class=o>(</span><span class=n>interestOps</span> <span class=o>|</span> <span class=n>readInterestOp</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#22-nioeventloop-剖析><h3 id=22-nioeventloop-剖析><span class=hanchor arialabel=Anchor># </span>2.2 NioEventLoop 剖析</h3></a><p><img src="/z-oblib/z2-attachments/Pasted image 20220624231611.png" width=auto></p><p>NioEventLoop 线程不仅要处理 IO 事件，还要处理 Task（包括普通任务和定时任务），</p><p>提交任务代码 <code>io.netty.util.concurrent.SingleThreadEventExecutor#execute</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>execute</span><span class=o>(</span><span class=n>Runnable</span> <span class=n>task</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>task</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=k>new</span> <span class=n>NullPointerException</span><span class=o>(</span><span class=s>&#34;task&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>boolean</span> <span class=n>inEventLoop</span> <span class=o>=</span> <span class=n>inEventLoop</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 添加任务，其中队列使用了 jctools 提供的 mpsc 无锁队列
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>addTask</span><span class=o>(</span><span class=n>task</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(!</span><span class=n>inEventLoop</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// inEventLoop 如果为 false 表示由其它线程来调用 execute，即首次调用，这时需要向 eventLoop 提交首个任务，启动死循环，会执行到下面的 doStartThread
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>startThread</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>isShutdown</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 如果已经 shutdown，做拒绝逻辑，代码略...
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(!</span><span class=n>addTaskWakesUp</span> <span class=o>&amp;&amp;</span> <span class=n>wakesUpForTask</span><span class=o>(</span><span class=n>task</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 如果线程由于 IO select 阻塞了，添加的任务的线程需要负责唤醒 NioEventLoop 线程
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>wakeup</span><span class=o>(</span><span class=n>inEventLoop</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>唤醒 select 阻塞线程<code>io.netty.channel.nio.NioEventLoop#wakeup</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>protected</span> <span class=kt>void</span> <span class=nf>wakeup</span><span class=o>(</span><span class=kt>boolean</span> <span class=n>inEventLoop</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(!</span><span class=n>inEventLoop</span> <span class=o>&amp;&amp;</span> <span class=n>wakenUp</span><span class=o>.</span><span class=na>compareAndSet</span><span class=o>(</span><span class=kc>false</span><span class=o>,</span> <span class=kc>true</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>selector</span><span class=o>.</span><span class=na>wakeup</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>启动 EventLoop 主循环 <code>io.netty.util.concurrent.SingleThreadEventExecutor#doStartThread</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kt>void</span> <span class=nf>doStartThread</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>thread</span> <span class=o>==</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>executor</span><span class=o>.</span><span class=na>execute</span><span class=o>(</span><span class=k>new</span> <span class=n>Runnable</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 将线程池的当前线程保存在成员变量中，以便后续使用
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>thread</span> <span class=o>=</span> <span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>interrupted</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>thread</span><span class=o>.</span><span class=na>interrupt</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=kt>boolean</span> <span class=n>success</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>updateLastExecutionTime</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 调用外部类 SingleThreadEventExecutor 的 run 方法，进入死循环，run 方法见下
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>SingleThreadEventExecutor</span><span class=o>.</span><span class=na>this</span><span class=o>.</span><span class=na>run</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=n>success</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Throwable</span> <span class=n>t</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>logger</span><span class=o>.</span><span class=na>warn</span><span class=o>(</span><span class=s>&#34;Unexpected exception from an event executor: &#34;</span><span class=o>,</span> <span class=n>t</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>				<span class=c1>// 清理工作，代码略...
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>});</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>io.netty.channel.nio.NioEventLoop#run</code> 主要任务是执行死循环，不断看有没有新任务，有没有 IO 事件</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>protected</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=o>(;;)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// calculateStrategy 的逻辑如下：
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=c1>// 有任务，会执行一次 selectNow，清除上一次的 wakeup 结果，无论有没有 IO 事件，都会跳过 switch
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=c1>// 没有任务，会匹配 SelectStrategy.SELECT，看是否应当阻塞
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=k>switch</span> <span class=o>(</span><span class=n>selectStrategy</span><span class=o>.</span><span class=na>calculateStrategy</span><span class=o>(</span><span class=n>selectNowSupplier</span><span class=o>,</span> <span class=n>hasTasks</span><span class=o>()))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>case</span> <span class=n>SelectStrategy</span><span class=o>.</span><span class=na>CONTINUE</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                        <span class=k>continue</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                    <span class=k>case</span> <span class=n>SelectStrategy</span><span class=o>.</span><span class=na>BUSY_WAIT</span><span class=o>:</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                    <span class=k>case</span> <span class=n>SelectStrategy</span><span class=o>.</span><span class=na>SELECT</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                        <span class=c1>// 因为 IO 线程和提交任务线程都有可能执行 wakeup，而 wakeup 属于比较昂贵的操作，因此使用了一个原子布尔对象 wakenUp，它取值为 true 时，表示该由当前线程唤醒
</span></span></span><span class=line><span class=cl><span class=c1></span>                        <span class=c1>// 进行 select 阻塞，并设置唤醒状态为 false
</span></span></span><span class=line><span class=cl><span class=c1></span>                        <span class=kt>boolean</span> <span class=n>oldWakenUp</span> <span class=o>=</span> <span class=n>wakenUp</span><span class=o>.</span><span class=na>getAndSet</span><span class=o>(</span><span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                        
</span></span><span class=line><span class=cl>                        <span class=c1>// 如果在这个位置，非 EventLoop 线程抢先将 wakenUp 置为 true，并 wakeup
</span></span></span><span class=line><span class=cl><span class=c1></span>                        <span class=c1>// 下面的 select 方法不会阻塞
</span></span></span><span class=line><span class=cl><span class=c1></span>                        <span class=c1>// 等 runAllTasks 处理完成后，到再循环进来这个阶段新增的任务会不会及时执行呢?
</span></span></span><span class=line><span class=cl><span class=c1></span>                        <span class=c1>// 因为 oldWakenUp 为 true，因此下面的 select 方法就会阻塞，直到超时
</span></span></span><span class=line><span class=cl><span class=c1></span>                        <span class=c1>// 才能执行，让 select 方法无谓阻塞
</span></span></span><span class=line><span class=cl><span class=c1></span>                        <span class=n>select</span><span class=o>(</span><span class=n>oldWakenUp</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                        <span class=k>if</span> <span class=o>(</span><span class=n>wakenUp</span><span class=o>.</span><span class=na>get</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                            <span class=n>selector</span><span class=o>.</span><span class=na>wakeup</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                        <span class=o>}</span>
</span></span><span class=line><span class=cl>                    <span class=k>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>rebuildSelector0</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=n>handleLoopException</span><span class=o>(</span><span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=k>continue</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>cancelledKeys</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>needsToSelectAgain</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=c1>// ioRatio 默认是 50
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=kd>final</span> <span class=kt>int</span> <span class=n>ioRatio</span> <span class=o>=</span> <span class=k>this</span><span class=o>.</span><span class=na>ioRatio</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>ioRatio</span> <span class=o>==</span> <span class=n>100</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>processSelectedKeys</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=c1>// ioRatio 为 100 时，总是运行完所有非 IO 任务
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=n>runAllTasks</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>                
</span></span><span class=line><span class=cl>                <span class=kd>final</span> <span class=kt>long</span> <span class=n>ioStartTime</span> <span class=o>=</span> <span class=n>System</span><span class=o>.</span><span class=na>nanoTime</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>processSelectedKeys</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=c1>// 记录 io 事件处理耗时
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=kd>final</span> <span class=kt>long</span> <span class=n>ioTime</span> <span class=o>=</span> <span class=n>System</span><span class=o>.</span><span class=na>nanoTime</span><span class=o>()</span> <span class=o>-</span> <span class=n>ioStartTime</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                    <span class=c1>// 运行非 IO 任务，一旦超时会退出 runAllTasks
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=n>runAllTasks</span><span class=o>(</span><span class=n>ioTime</span> <span class=o>*</span> <span class=o>(</span><span class=n>100</span> <span class=o>-</span> <span class=n>ioRatio</span><span class=o>)</span> <span class=o>/</span> <span class=n>ioRatio</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Throwable</span> <span class=n>t</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>handleLoopException</span><span class=o>(</span><span class=n>t</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>isShuttingDown</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>closeAll</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>confirmShutdown</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Throwable</span> <span class=n>t</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>handleLoopException</span><span class=o>(</span><span class=n>t</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#-注意><h4 id=-注意><span class=hanchor arialabel=Anchor># </span>⚠️ 注意</h4></a><blockquote><p>这里有个费解的地方就是 wakeup，它既可以由提交任务的线程来调用（比较好理解），也可以由 EventLoop 线程来调用（比较费解），这里要知道 wakeup 方法的效果：</p><ul><li>由非 EventLoop 线程调用，会唤醒当前在执行 select 阻塞的 EventLoop 线程</li><li>由 EventLoop 自己调用，会本次的 wakeup 会取消下一次的 select 操作</li></ul></blockquote><p>参考下图</p><p><img src=/z-oblib/z2-attachments/0032.png width=auto></p><p><code>io.netty.channel.nio.NioEventLoop#select</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kt>void</span> <span class=nf>select</span><span class=o>(</span><span class=kt>boolean</span> <span class=n>oldWakenUp</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Selector</span> <span class=n>selector</span> <span class=o>=</span> <span class=k>this</span><span class=o>.</span><span class=na>selector</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>selectCnt</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=kt>long</span> <span class=n>currentTimeNanos</span> <span class=o>=</span> <span class=n>System</span><span class=o>.</span><span class=na>nanoTime</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 计算等待时间
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// * 没有 scheduledTask，超时时间为 1s
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// * 有 scheduledTask，超时时间为 `下一个定时任务执行时间 - 当前时间`
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kt>long</span> <span class=n>selectDeadLineNanos</span> <span class=o>=</span> <span class=n>currentTimeNanos</span> <span class=o>+</span> <span class=n>delayNanos</span><span class=o>(</span><span class=n>currentTimeNanos</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=o>(;;)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=kt>long</span> <span class=n>timeoutMillis</span> <span class=o>=</span> <span class=o>(</span><span class=n>selectDeadLineNanos</span> <span class=o>-</span> <span class=n>currentTimeNanos</span> <span class=o>+</span> <span class=n>500000L</span><span class=o>)</span> <span class=o>/</span> <span class=n>1000000L</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 如果超时，退出循环
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>if</span> <span class=o>(</span><span class=n>timeoutMillis</span> <span class=o>&lt;=</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>selectCnt</span> <span class=o>==</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>selector</span><span class=o>.</span><span class=na>selectNow</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                    <span class=n>selectCnt</span> <span class=o>=</span> <span class=n>1</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1>// 如果期间又有 task 退出循环，如果没这个判断，那么任务就会等到下次 select 超时时才能被执行
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// wakenUp.compareAndSet(false, true) 是让非 NioEventLoop 不必再执行 wakeup
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>if</span> <span class=o>(</span><span class=n>hasTasks</span><span class=o>()</span> <span class=o>&amp;&amp;</span> <span class=n>wakenUp</span><span class=o>.</span><span class=na>compareAndSet</span><span class=o>(</span><span class=kc>false</span><span class=o>,</span> <span class=kc>true</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>selector</span><span class=o>.</span><span class=na>selectNow</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=n>selectCnt</span> <span class=o>=</span> <span class=n>1</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1>// select 有限时阻塞
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// 注意 nio 有 bug，当 bug 出现时，select 方法即使没有时间发生，也不会阻塞住，导致不断空轮询，cpu 占用 100%
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=kt>int</span> <span class=n>selectedKeys</span> <span class=o>=</span> <span class=n>selector</span><span class=o>.</span><span class=na>select</span><span class=o>(</span><span class=n>timeoutMillis</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 计数加 1
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>selectCnt</span> <span class=o>++;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1>// 醒来后，如果有 IO 事件、或是由非 EventLoop 线程唤醒，或者有任务，退出循环
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>if</span> <span class=o>(</span><span class=n>selectedKeys</span> <span class=o>!=</span> <span class=n>0</span> <span class=o>||</span> <span class=n>oldWakenUp</span> <span class=o>||</span> <span class=n>wakenUp</span><span class=o>.</span><span class=na>get</span><span class=o>()</span> <span class=o>||</span> <span class=n>hasTasks</span><span class=o>()</span> <span class=o>||</span> <span class=n>hasScheduledTasks</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>Thread</span><span class=o>.</span><span class=na>interrupted</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>               	<span class=c1>// 线程被打断，退出循环
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=c1>// 记录日志
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>selectCnt</span> <span class=o>=</span> <span class=n>1</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=kt>long</span> <span class=n>time</span> <span class=o>=</span> <span class=n>System</span><span class=o>.</span><span class=na>nanoTime</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>time</span> <span class=o>-</span> <span class=n>TimeUnit</span><span class=o>.</span><span class=na>MILLISECONDS</span><span class=o>.</span><span class=na>toNanos</span><span class=o>(</span><span class=n>timeoutMillis</span><span class=o>)</span> <span class=o>&gt;=</span> <span class=n>currentTimeNanos</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 如果超时，计数重置为 1，下次循环就会 break
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>selectCnt</span> <span class=o>=</span> <span class=n>1</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> 
</span></span><span class=line><span class=cl>            <span class=c1>// 计数超过阈值，由 io.netty.selectorAutoRebuildThreshold 指定，默认 512
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// 这是为了解决 nio 空轮询 bug
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>SELECTOR_AUTO_REBUILD_THRESHOLD</span> <span class=o>&gt;</span> <span class=n>0</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>                    <span class=n>selectCnt</span> <span class=o>&gt;=</span> <span class=n>SELECTOR_AUTO_REBUILD_THRESHOLD</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 重建 selector
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>selector</span> <span class=o>=</span> <span class=n>selectRebuildSelector</span><span class=o>(</span><span class=n>selectCnt</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=n>selectCnt</span> <span class=o>=</span> <span class=n>1</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>currentTimeNanos</span> <span class=o>=</span> <span class=n>time</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>selectCnt</span> <span class=o>&gt;</span> <span class=n>MIN_PREMATURE_SELECTOR_RETURNS</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 记录日志
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>CancelledKeyException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 记录日志
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>处理 keys <code>io.netty.channel.nio.NioEventLoop#processSelectedKeys</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kt>void</span> <span class=nf>processSelectedKeys</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>selectedKeys</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 通过反射将 Selector 实现类中的就绪事件集合替换为 SelectedSelectionKeySet 
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// SelectedSelectionKeySet 底层为数组实现，可以提高遍历性能（原本为 HashSet）
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>processSelectedKeysOptimized</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>processSelectedKeysPlain</span><span class=o>(</span><span class=n>selector</span><span class=o>.</span><span class=na>selectedKeys</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>io.netty.channel.nio.NioEventLoop#processSelectedKey</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kt>void</span> <span class=nf>processSelectedKey</span><span class=o>(</span><span class=n>SelectionKey</span> <span class=n>k</span><span class=o>,</span> <span class=n>AbstractNioChannel</span> <span class=n>ch</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=n>AbstractNioChannel</span><span class=o>.</span><span class=na>NioUnsafe</span> <span class=n>unsafe</span> <span class=o>=</span> <span class=n>ch</span><span class=o>.</span><span class=na>unsafe</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 当 key 取消或关闭时会导致这个 key 无效
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>(!</span><span class=n>k</span><span class=o>.</span><span class=na>isValid</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 无效时处理...
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>readyOps</span> <span class=o>=</span> <span class=n>k</span><span class=o>.</span><span class=na>readyOps</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 连接事件
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=o>((</span><span class=n>readyOps</span> <span class=o>&amp;</span> <span class=n>SelectionKey</span><span class=o>.</span><span class=na>OP_CONNECT</span><span class=o>)</span> <span class=o>!=</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=kt>int</span> <span class=n>ops</span> <span class=o>=</span> <span class=n>k</span><span class=o>.</span><span class=na>interestOps</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>ops</span> <span class=o>&amp;=</span> <span class=o>~</span><span class=n>SelectionKey</span><span class=o>.</span><span class=na>OP_CONNECT</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>k</span><span class=o>.</span><span class=na>interestOps</span><span class=o>(</span><span class=n>ops</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>unsafe</span><span class=o>.</span><span class=na>finishConnect</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// 可写事件
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=o>((</span><span class=n>readyOps</span> <span class=o>&amp;</span> <span class=n>SelectionKey</span><span class=o>.</span><span class=na>OP_WRITE</span><span class=o>)</span> <span class=o>!=</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>ch</span><span class=o>.</span><span class=na>unsafe</span><span class=o>().</span><span class=na>forceFlush</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// 可读或可接入事件
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=o>((</span><span class=n>readyOps</span> <span class=o>&amp;</span> <span class=o>(</span><span class=n>SelectionKey</span><span class=o>.</span><span class=na>OP_READ</span> <span class=o>|</span> <span class=n>SelectionKey</span><span class=o>.</span><span class=na>OP_ACCEPT</span><span class=o>))</span> <span class=o>!=</span> <span class=n>0</span> <span class=o>||</span> <span class=n>readyOps</span> <span class=o>==</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 如果是可接入 io.netty.channel.nio.AbstractNioMessageChannel.NioMessageUnsafe#read
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// 如果是可读 io.netty.channel.nio.AbstractNioByteChannel.NioByteUnsafe#read
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>unsafe</span><span class=o>.</span><span class=na>read</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>CancelledKeyException</span> <span class=n>ignored</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>unsafe</span><span class=o>.</span><span class=na>close</span><span class=o>(</span><span class=n>unsafe</span><span class=o>.</span><span class=na>voidPromise</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#23-accept-剖析><h3 id=23-accept-剖析><span class=hanchor arialabel=Anchor># </span>2.3 accept 剖析</h3></a><p>nio 中如下代码，在 netty 中的流程</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>//1 阻塞直到事件发生
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>selector</span><span class=o>.</span><span class=na>select</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Iterator</span><span class=o>&lt;</span><span class=n>SelectionKey</span><span class=o>&gt;</span> <span class=n>iter</span> <span class=o>=</span> <span class=n>selector</span><span class=o>.</span><span class=na>selectedKeys</span><span class=o>().</span><span class=na>iterator</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=k>while</span> <span class=o>(</span><span class=n>iter</span><span class=o>.</span><span class=na>hasNext</span><span class=o>())</span> <span class=o>{</span>    
</span></span><span class=line><span class=cl>    <span class=c1>//2 拿到一个事件
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>SelectionKey</span> <span class=n>key</span> <span class=o>=</span> <span class=n>iter</span><span class=o>.</span><span class=na>next</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>//3 如果是 accept 事件
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>(</span><span class=n>key</span><span class=o>.</span><span class=na>isAcceptable</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1>//4 执行 accept
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>SocketChannel</span> <span class=n>channel</span> <span class=o>=</span> <span class=n>serverSocketChannel</span><span class=o>.</span><span class=na>accept</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>channel</span><span class=o>.</span><span class=na>configureBlocking</span><span class=o>(</span><span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1>//5 关注 read 事件
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>channel</span><span class=o>.</span><span class=na>register</span><span class=o>(</span><span class=n>selector</span><span class=o>,</span> <span class=n>SelectionKey</span><span class=o>.</span><span class=na>OP_READ</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>先来看可接入事件处理（accept）</p><p><code>io.netty.channel.nio.AbstractNioMessageChannel.NioMessageUnsafe#read</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>read</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>eventLoop</span><span class=o>().</span><span class=na>inEventLoop</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=n>ChannelConfig</span> <span class=n>config</span> <span class=o>=</span> <span class=n>config</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=n>ChannelPipeline</span> <span class=n>pipeline</span> <span class=o>=</span> <span class=n>pipeline</span><span class=o>();</span>    
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=n>RecvByteBufAllocator</span><span class=o>.</span><span class=na>Handle</span> <span class=n>allocHandle</span> <span class=o>=</span> <span class=n>unsafe</span><span class=o>().</span><span class=na>recvBufAllocHandle</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>allocHandle</span><span class=o>.</span><span class=na>reset</span><span class=o>(</span><span class=n>config</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>boolean</span> <span class=n>closed</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>Throwable</span> <span class=n>exception</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>do</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>				<span class=c1>// doReadMessages 中执行了 accept 并创建 NioSocketChannel 作为消息放入 readBuf
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=c1>// readBuf 是一个 ArrayList 用来缓存消息
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=kt>int</span> <span class=n>localRead</span> <span class=o>=</span> <span class=n>doReadMessages</span><span class=o>(</span><span class=n>readBuf</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>localRead</span> <span class=o>==</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>localRead</span> <span class=o>&lt;</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>closed</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                    <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>				<span class=c1>// localRead 为 1，就一条消息，即接收一个客户端连接
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>allocHandle</span><span class=o>.</span><span class=na>incMessagesRead</span><span class=o>(</span><span class=n>localRead</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>while</span> <span class=o>(</span><span class=n>allocHandle</span><span class=o>.</span><span class=na>continueReading</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Throwable</span> <span class=n>t</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>exception</span> <span class=o>=</span> <span class=n>t</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>size</span> <span class=o>=</span> <span class=n>readBuf</span><span class=o>.</span><span class=na>size</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>size</span><span class=o>;</span> <span class=n>i</span> <span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>readPending</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 触发 read 事件，让 pipeline 上的 handler 处理，这时是处理
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// io.netty.bootstrap.ServerBootstrap.ServerBootstrapAcceptor#channelRead
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>pipeline</span><span class=o>.</span><span class=na>fireChannelRead</span><span class=o>(</span><span class=n>readBuf</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>i</span><span class=o>));</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=n>readBuf</span><span class=o>.</span><span class=na>clear</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>allocHandle</span><span class=o>.</span><span class=na>readComplete</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>pipeline</span><span class=o>.</span><span class=na>fireChannelReadComplete</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>exception</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>closed</span> <span class=o>=</span> <span class=n>closeOnReadError</span><span class=o>(</span><span class=n>exception</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>pipeline</span><span class=o>.</span><span class=na>fireExceptionCaught</span><span class=o>(</span><span class=n>exception</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>closed</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>inputShutdown</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>isOpen</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>close</span><span class=o>(</span><span class=n>voidPromise</span><span class=o>());</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(!</span><span class=n>readPending</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>config</span><span class=o>.</span><span class=na>isAutoRead</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>removeReadOp</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>关键代码 <code>io.netty.bootstrap.ServerBootstrap.ServerBootstrapAcceptor#channelRead</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>channelRead</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>,</span> <span class=n>Object</span> <span class=n>msg</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 这时的 msg 是 NioSocketChannel
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>final</span> <span class=n>Channel</span> <span class=n>child</span> <span class=o>=</span> <span class=o>(</span><span class=n>Channel</span><span class=o>)</span> <span class=n>msg</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// NioSocketChannel 添加  childHandler 即初始化器
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>child</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=n>childHandler</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 设置选项
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>setChannelOptions</span><span class=o>(</span><span class=n>child</span><span class=o>,</span> <span class=n>childOptions</span><span class=o>,</span> <span class=n>logger</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=o>(</span><span class=n>Entry</span><span class=o>&lt;</span><span class=n>AttributeKey</span><span class=o>&lt;?&gt;,</span> <span class=n>Object</span><span class=o>&gt;</span> <span class=n>e</span><span class=o>:</span> <span class=n>childAttrs</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>child</span><span class=o>.</span><span class=na>attr</span><span class=o>((</span><span class=n>AttributeKey</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;)</span> <span class=n>e</span><span class=o>.</span><span class=na>getKey</span><span class=o>()).</span><span class=na>set</span><span class=o>(</span><span class=n>e</span><span class=o>.</span><span class=na>getValue</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 注册 NioSocketChannel 到 nio worker 线程，接下来的处理也移交至 nio worker 线程
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>childGroup</span><span class=o>.</span><span class=na>register</span><span class=o>(</span><span class=n>child</span><span class=o>).</span><span class=na>addListener</span><span class=o>(</span><span class=k>new</span> <span class=n>ChannelFutureListener</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>            <span class=kd>public</span> <span class=kt>void</span> <span class=nf>operationComplete</span><span class=o>(</span><span class=n>ChannelFuture</span> <span class=n>future</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(!</span><span class=n>future</span><span class=o>.</span><span class=na>isSuccess</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>forceClose</span><span class=o>(</span><span class=n>child</span><span class=o>,</span> <span class=n>future</span><span class=o>.</span><span class=na>cause</span><span class=o>());</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>});</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Throwable</span> <span class=n>t</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>forceClose</span><span class=o>(</span><span class=n>child</span><span class=o>,</span> <span class=n>t</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>又回到了熟悉的 <code>io.netty.channel.AbstractChannel.AbstractUnsafe#register</code> 方法</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>final</span> <span class=kt>void</span> <span class=nf>register</span><span class=o>(</span><span class=n>EventLoop</span> <span class=n>eventLoop</span><span class=o>,</span> <span class=kd>final</span> <span class=n>ChannelPromise</span> <span class=n>promise</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 一些检查，略...
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=n>AbstractChannel</span><span class=o>.</span><span class=na>this</span><span class=o>.</span><span class=na>eventLoop</span> <span class=o>=</span> <span class=n>eventLoop</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>eventLoop</span><span class=o>.</span><span class=na>inEventLoop</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>register0</span><span class=o>(</span><span class=n>promise</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 这行代码完成的事实是 nio boss -&gt; nio worker 线程的切换
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>eventLoop</span><span class=o>.</span><span class=na>execute</span><span class=o>(</span><span class=k>new</span> <span class=n>Runnable</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>                <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>register0</span><span class=o>(</span><span class=n>promise</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>});</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Throwable</span> <span class=n>t</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 日志记录...
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>closeForcibly</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>closeFuture</span><span class=o>.</span><span class=na>setClosed</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>safeSetFailure</span><span class=o>(</span><span class=n>promise</span><span class=o>,</span> <span class=n>t</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>io.netty.channel.AbstractChannel.AbstractUnsafe#register0</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kt>void</span> <span class=nf>register0</span><span class=o>(</span><span class=n>ChannelPromise</span> <span class=n>promise</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(!</span><span class=n>promise</span><span class=o>.</span><span class=na>setUncancellable</span><span class=o>()</span> <span class=o>||</span> <span class=o>!</span><span class=n>ensureOpen</span><span class=o>(</span><span class=n>promise</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=kt>boolean</span> <span class=n>firstRegistration</span> <span class=o>=</span> <span class=n>neverRegistered</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>doRegister</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>neverRegistered</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>registered</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>		
</span></span><span class=line><span class=cl>        <span class=c1>// 执行初始化器，执行前 pipeline 中只有 head -&gt; 初始化器 -&gt; tail
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>pipeline</span><span class=o>.</span><span class=na>invokeHandlerAddedIfNeeded</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 执行后就是 head -&gt; logging handler -&gt; my handler -&gt; tail
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>        <span class=n>safeSetSuccess</span><span class=o>(</span><span class=n>promise</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>pipeline</span><span class=o>.</span><span class=na>fireChannelRegistered</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>isActive</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>firstRegistration</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 触发 pipeline 上 active 事件
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>pipeline</span><span class=o>.</span><span class=na>fireChannelActive</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>config</span><span class=o>().</span><span class=na>isAutoRead</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>beginRead</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Throwable</span> <span class=n>t</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>closeForcibly</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>closeFuture</span><span class=o>.</span><span class=na>setClosed</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>safeSetFailure</span><span class=o>(</span><span class=n>promise</span><span class=o>,</span> <span class=n>t</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>回到了熟悉的代码 <code>io.netty.channel.DefaultChannelPipeline.HeadContext#channelActive</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>channelActive</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ctx</span><span class=o>.</span><span class=na>fireChannelActive</span><span class=o>();</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 触发 read (NioSocketChannel 这里 read，只是为了触发 channel 的事件注册，还未涉及数据读取)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>readIfIsAutoRead</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>io.netty.channel.nio.AbstractNioChannel#doBeginRead</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>protected</span> <span class=kt>void</span> <span class=nf>doBeginRead</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Channel.read() or ChannelHandlerContext.read() was called
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>final</span> <span class=n>SelectionKey</span> <span class=n>selectionKey</span> <span class=o>=</span> <span class=k>this</span><span class=o>.</span><span class=na>selectionKey</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(!</span><span class=n>selectionKey</span><span class=o>.</span><span class=na>isValid</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>readPending</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 这时候 interestOps 是 0
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>final</span> <span class=kt>int</span> <span class=n>interestOps</span> <span class=o>=</span> <span class=n>selectionKey</span><span class=o>.</span><span class=na>interestOps</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>((</span><span class=n>interestOps</span> <span class=o>&amp;</span> <span class=n>readInterestOp</span><span class=o>)</span> <span class=o>==</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 关注 read 事件
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>selectionKey</span><span class=o>.</span><span class=na>interestOps</span><span class=o>(</span><span class=n>interestOps</span> <span class=o>|</span> <span class=n>readInterestOp</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#24-read-剖析><h3 id=24-read-剖析><span class=hanchor arialabel=Anchor># </span>2.4 read 剖析</h3></a><p>再来看可读事件 <code>io.netty.channel.nio.AbstractNioByteChannel.NioByteUnsafe#read</code>，注意发送的数据未必能够一次读完，因此会触发多次 nio read 事件，一次事件内会触发多次 pipeline read，一次事件会触发一次 pipeline read complete</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>final</span> <span class=kt>void</span> <span class=nf>read</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=n>ChannelConfig</span> <span class=n>config</span> <span class=o>=</span> <span class=n>config</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>shouldBreakReadReady</span><span class=o>(</span><span class=n>config</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>clearReadPending</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=n>ChannelPipeline</span> <span class=n>pipeline</span> <span class=o>=</span> <span class=n>pipeline</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=c1>// io.netty.allocator.type 决定 allocator 的实现
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>final</span> <span class=n>ByteBufAllocator</span> <span class=n>allocator</span> <span class=o>=</span> <span class=n>config</span><span class=o>.</span><span class=na>getAllocator</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 用来分配 byteBuf，确定单次读取大小
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>final</span> <span class=n>RecvByteBufAllocator</span><span class=o>.</span><span class=na>Handle</span> <span class=n>allocHandle</span> <span class=o>=</span> <span class=n>recvBufAllocHandle</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>allocHandle</span><span class=o>.</span><span class=na>reset</span><span class=o>(</span><span class=n>config</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>ByteBuf</span> <span class=n>byteBuf</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>boolean</span> <span class=n>close</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>do</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>byteBuf</span> <span class=o>=</span> <span class=n>allocHandle</span><span class=o>.</span><span class=na>allocate</span><span class=o>(</span><span class=n>allocator</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 读取
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>allocHandle</span><span class=o>.</span><span class=na>lastBytesRead</span><span class=o>(</span><span class=n>doReadBytes</span><span class=o>(</span><span class=n>byteBuf</span><span class=o>));</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>allocHandle</span><span class=o>.</span><span class=na>lastBytesRead</span><span class=o>()</span> <span class=o>&lt;=</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>byteBuf</span><span class=o>.</span><span class=na>release</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=n>byteBuf</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=n>close</span> <span class=o>=</span> <span class=n>allocHandle</span><span class=o>.</span><span class=na>lastBytesRead</span><span class=o>()</span> <span class=o>&lt;</span> <span class=n>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>close</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>readPending</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>allocHandle</span><span class=o>.</span><span class=na>incMessagesRead</span><span class=o>(</span><span class=n>1</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>readPending</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 触发 read 事件，让 pipeline 上的 handler 处理，这时是处理 NioSocketChannel 上的 handler
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>pipeline</span><span class=o>.</span><span class=na>fireChannelRead</span><span class=o>(</span><span class=n>byteBuf</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>byteBuf</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> 
</span></span><span class=line><span class=cl>        <span class=c1>// 是否要继续循环
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>while</span> <span class=o>(</span><span class=n>allocHandle</span><span class=o>.</span><span class=na>continueReading</span><span class=o>());</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>allocHandle</span><span class=o>.</span><span class=na>readComplete</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 触发 read complete 事件
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>pipeline</span><span class=o>.</span><span class=na>fireChannelReadComplete</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>close</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>closeOnRead</span><span class=o>(</span><span class=n>pipeline</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Throwable</span> <span class=n>t</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>handleReadException</span><span class=o>(</span><span class=n>pipeline</span><span class=o>,</span> <span class=n>byteBuf</span><span class=o>,</span> <span class=n>t</span><span class=o>,</span> <span class=n>close</span><span class=o>,</span> <span class=n>allocHandle</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(!</span><span class=n>readPending</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>config</span><span class=o>.</span><span class=na>isAutoRead</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>removeReadOp</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>io.netty.channel.DefaultMaxMessagesRecvByteBufAllocator.MaxMessageHandle#continueReading(io.netty.util.UncheckedBooleanSupplier)</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>continueReading</span><span class=o>(</span><span class=n>UncheckedBooleanSupplier</span> <span class=n>maybeMoreDataSupplier</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> 
</span></span><span class=line><span class=cl>           <span class=c1>// 一般为 true
</span></span></span><span class=line><span class=cl><span class=c1></span>           <span class=n>config</span><span class=o>.</span><span class=na>isAutoRead</span><span class=o>()</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>           <span class=c1>// respectMaybeMoreData 默认为 true
</span></span></span><span class=line><span class=cl><span class=c1></span>           <span class=c1>// maybeMoreDataSupplier 的逻辑是如果预期读取字节与实际读取字节相等，返回 true
</span></span></span><span class=line><span class=cl><span class=c1></span>           <span class=o>(!</span><span class=n>respectMaybeMoreData</span> <span class=o>||</span> <span class=n>maybeMoreDataSupplier</span><span class=o>.</span><span class=na>get</span><span class=o>())</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>           <span class=c1>// 小于最大次数，maxMessagePerRead 默认 16
</span></span></span><span class=line><span class=cl><span class=c1></span>           <span class=n>totalMessages</span> <span class=o>&lt;</span> <span class=n>maxMessagePerRead</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>           <span class=c1>// 实际读到了数据
</span></span></span><span class=line><span class=cl><span class=c1></span>           <span class=n>totalBytesRead</span> <span class=o>&gt;</span> <span class=n>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div></article><hr><div class=page-end id=footer><div class=backlinks-container><h3>Backlinks</h3><ul class=backlinks><li>No backlinks found</li></ul></div><div><script src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>Interactive Graph</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://harbor.mffseal.top/js/graph.abd4bc2af3869a96524d7d23b76152c7.js></script></div></div><div id=contact_buttons><footer><p>Made by mffseal using <a href=https://github.com/jackyzha0/quartz>Quartz</a>, © 2022</p><ul><li><a href=https://harbor.mffseal.top/>Home</a></li><li><a href=https://github.com/mffseal>Github</a></li></ul></footer></div></div></body></html>