<!doctype html><html lang=cn><head><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8920808282451934" crossorigin=anonymous></script><div id=cursor-chat-layer><input type=text id=cursor-chat-box></div><script src=https://unpkg.com/cursor-chat></script>
<link rel=stylesheet type=text/css href=https://unpkg.com/cursor-chat/dist/style.css><meta charset=utf-8><meta name=description content="Nettyä¼˜åŒ–ä¸æºç  1. ä¼˜åŒ– 1.1 æ‰©å±•åºåˆ—åŒ–ç®—æ³• åºåˆ—åŒ–ï¼Œååºåˆ—åŒ–ä¸»è¦ç”¨åœ¨æ¶ˆæ¯æ­£æ–‡çš„è½¬æ¢ä¸Š
 åºåˆ—åŒ–æ—¶ï¼Œéœ€è¦å°† Java å¯¹è±¡å˜ä¸ºè¦ä¼ è¾“çš„æ•°æ®ï¼ˆå¯ä»¥æ˜¯ byte[]ï¼Œæˆ– json ç­‰ï¼Œæœ€ç»ˆéƒ½éœ€è¦å˜æˆ byte[]ï¼‰ ååºåˆ—åŒ–æ—¶ï¼Œéœ€è¦å°†ä¼ å…¥çš„æ­£æ–‡æ•°æ®è¿˜åŸæˆ Java å¯¹è±¡ï¼Œä¾¿äºå¤„ç†  ç›®å‰çš„ä»£ç ä»…æ”¯æŒ Java è‡ªå¸¦çš„åºåˆ—åŒ–ï¼Œååºåˆ—åŒ–æœºåˆ¶ï¼Œæ ¸å¿ƒä»£ç å¦‚ä¸‹"><title>Nettyä¼˜åŒ–ä¸æºç </title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://harbor.mffseal.top//icon.png><link href=https://harbor.mffseal.top/styles.73cf69c3fd63eaf27dde453f5aa109f7.min.css rel=stylesheet><link href=https://harbor.mffseal.top/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://harbor.mffseal.top/js/darkmode.9841b88d44c115f7419d485ee72d23a2.min.js></script>
<script src=https://harbor.mffseal.top/js/util.9825137f5e7825e8553c68ce39ac9e44.min.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js integrity=sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A crossorigin=anonymous></script>
<script src=https://unpkg.com/@floating-ui/core@0.7.3></script>
<script src=https://unpkg.com/@floating-ui/dom@0.5.4></script>
<script src=https://harbor.mffseal.top/js/popover.53ad9a087e3feeaaa12b63bfd02d923b.min.js></script>
<script src=https://harbor.mffseal.top/js/code-title.b35124ad8db0ba37162b886afb711cbc.min.js></script>
<script src=https://harbor.mffseal.top/js/clipboard.c20857734e53a3fb733b7443879efa61.min.js></script>
<script src=https://harbor.mffseal.top/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const BASE_URL="https://harbor.mffseal.top/",fetchData=Promise.all([fetch("https://harbor.mffseal.top/indices/linkIndex.8ef4d7748976075ee052aa5422aa5587.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://harbor.mffseal.top/indices/contentIndex.f68db80cadf9cbd376d995da3e65d8a1.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addTitleToCodeBlocks(),addCollapsibleCallouts(),initPopover("https://harbor.mffseal.top",!0,!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!0;drawGraph("https://harbor.mffseal.top",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],macros:{'â€™':"'"},throwOnError:!1})}</script><script type=module>
    import { attachSPARouting } from "https:\/\/harbor.mffseal.top\/js\/router.9d4974281069e9ebb189f642ae1e3ca2.min.js"
    attachSPARouting(init, render)
  </script></head><script async src="https://www.googletagmanager.com/gtag/js?id=G-NV58SYWRZD"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-NV58SYWRZD",{anonymize_ip:!1})}</script><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=æœç´¢ placeholder=æœä¸€æœ...><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://harbor.mffseal.top/js/full-text-search.24827f874defbbc6d529926cbfcfb493.min.js></script><div class=singlePage><header><h1 id=page-title><a href=https://harbor.mffseal.top/>ğŸ¦­ æ¸¯æ¹¾</a></h1><div class=spacer></div><div id=search-icon><p>æœç´¢</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">æœç´¢å›¾æ ‡</title><desc id="desc">æ‰“å¼€æœç´¢å›¾æ ‡</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>äº®è‰²</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>æš—è‰²</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><h1>Nettyä¼˜åŒ–ä¸æºç </h1><p class=meta>æœ€åæ›´æ–°
Sep 18, 2022
<a href="obsidian://open?vault=content&file=2_0_2-%e8%ae%a1%e7%ae%97%e6%9c%ba%e7%a7%91%e5%ad%a6%2f2_0_2_2_1_0-web%e5%90%8e%e7%ab%af%2fNetty%2fNetty%e4%bc%98%e5%8c%96%e4%b8%8e%e6%ba%90%e7%a0%81.md" rel=noopener>ç¼–è¾‘æº</a></p><ul class=tags><li><a href=https://harbor.mffseal.top/tags/article/>Article</a></li></ul><div class=toc-wrapper><div class=mainTOC id=mainTOC><aside><header><h3>Nettyä¼˜åŒ–ä¸æºç </h3></header><nav id=TableOfContents><ol><li><a href=#1-ä¼˜åŒ–>1. ä¼˜åŒ–</a><ol><li><a href=#11-æ‰©å±•åºåˆ—åŒ–ç®—æ³•>1.1 æ‰©å±•åºåˆ—åŒ–ç®—æ³•</a></li><li><a href=#12-å‚æ•°è°ƒä¼˜>1.2 å‚æ•°è°ƒä¼˜</a></li><li><a href=#13-rpc-æ¡†æ¶>1.3 RPC æ¡†æ¶</a></li></ol></li><li><a href=#2-æºç åˆ†æ>2. æºç åˆ†æ</a><ol><li><a href=#21-å¯åŠ¨å‰–æ>2.1 å¯åŠ¨å‰–æ</a></li><li><a href=#22-nioeventloop-å‰–æ>2.2 NioEventLoop å‰–æ</a></li><li><a href=#23-accept-å‰–æ>2.3 accept å‰–æ</a></li><li><a href=#24-read-å‰–æ>2.4 read å‰–æ</a></li></ol></li></ol></nav></aside><a href=# id=toc-toggle></a></div></div><a href=#nettyä¼˜åŒ–ä¸æºç ><h1 id=nettyä¼˜åŒ–ä¸æºç ><span class=hanchor arialabel=Anchor># </span>Nettyä¼˜åŒ–ä¸æºç </h1></a><a href=#1-ä¼˜åŒ–><h2 id=1-ä¼˜åŒ–><span class=hanchor arialabel=Anchor># </span>1. ä¼˜åŒ–</h2></a><a href=#11-æ‰©å±•åºåˆ—åŒ–ç®—æ³•><h3 id=11-æ‰©å±•åºåˆ—åŒ–ç®—æ³•><span class=hanchor arialabel=Anchor># </span>1.1 æ‰©å±•åºåˆ—åŒ–ç®—æ³•</h3></a><p>åºåˆ—åŒ–ï¼Œååºåˆ—åŒ–ä¸»è¦ç”¨åœ¨æ¶ˆæ¯æ­£æ–‡çš„è½¬æ¢ä¸Š</p><ul><li>åºåˆ—åŒ–æ—¶ï¼Œéœ€è¦å°† Java å¯¹è±¡å˜ä¸ºè¦ä¼ è¾“çš„æ•°æ®ï¼ˆå¯ä»¥æ˜¯ byte[]ï¼Œæˆ– json ç­‰ï¼Œ<strong>æœ€ç»ˆéƒ½éœ€è¦å˜æˆ byte[]</strong>ï¼‰</li><li>ååºåˆ—åŒ–æ—¶ï¼Œéœ€è¦å°†ä¼ å…¥çš„æ­£æ–‡æ•°æ®è¿˜åŸæˆ Java å¯¹è±¡ï¼Œä¾¿äºå¤„ç†</li></ul><p>ç›®å‰çš„ä»£ç ä»…æ”¯æŒ Java è‡ªå¸¦çš„åºåˆ—åŒ–ï¼Œååºåˆ—åŒ–æœºåˆ¶ï¼Œæ ¸å¿ƒä»£ç å¦‚ä¸‹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-0-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-1> 1</a>
</span><span class=lnt id=hl-0-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-2> 2</a>
</span><span class=lnt id=hl-0-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-3> 3</a>
</span><span class=lnt id=hl-0-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-4> 4</a>
</span><span class=lnt id=hl-0-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-5> 5</a>
</span><span class=lnt id=hl-0-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-6> 6</a>
</span><span class=lnt id=hl-0-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-7> 7</a>
</span><span class=lnt id=hl-0-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-8> 8</a>
</span><span class=lnt id=hl-0-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-9> 9</a>
</span><span class=lnt id=hl-0-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-10>10</a>
</span><span class=lnt id=hl-0-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-11>11</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// ååºåˆ—åŒ–
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>byte</span><span class=o>[]</span> <span class=n>body</span> <span class=o>=</span> <span class=k>new</span> <span class=kt>byte</span><span class=o>[</span><span class=n>bodyLength</span><span class=o>];</span>
</span></span><span class=line><span class=cl><span class=n>byteByf</span><span class=o>.</span><span class=na>readBytes</span><span class=o>(</span><span class=n>body</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>ObjectInputStream</span> <span class=n>in</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ObjectInputStream</span><span class=o>(</span><span class=k>new</span> <span class=n>ByteArrayInputStream</span><span class=o>(</span><span class=n>body</span><span class=o>));</span>
</span></span><span class=line><span class=cl><span class=n>Message</span> <span class=n>message</span> <span class=o>=</span> <span class=o>(</span><span class=n>Message</span><span class=o>)</span> <span class=n>in</span><span class=o>.</span><span class=na>readObject</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=n>message</span><span class=o>.</span><span class=na>setSequenceId</span><span class=o>(</span><span class=n>sequenceId</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// åºåˆ—åŒ–
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>ByteArrayOutputStream</span> <span class=n>out</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ByteArrayOutputStream</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=k>new</span> <span class=n>ObjectOutputStream</span><span class=o>(</span><span class=n>out</span><span class=o>).</span><span class=na>writeObject</span><span class=o>(</span><span class=n>message</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=kt>byte</span><span class=o>[]</span> <span class=n>bytes</span> <span class=o>=</span> <span class=n>out</span><span class=o>.</span><span class=na>toByteArray</span><span class=o>();</span>
</span></span></code></pre></td></tr></table></div></div><p>ä¸ºäº†æ”¯æŒæ›´å¤šåºåˆ—åŒ–ç®—æ³•ï¼ŒæŠ½è±¡ä¸€ä¸ª Serializer æ¥å£</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-1-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-1>1</a>
</span><span class=lnt id=hl-1-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-2>2</a>
</span><span class=lnt id=hl-1-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-3>3</a>
</span><span class=lnt id=hl-1-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-4>4</a>
</span><span class=lnt id=hl-1-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-5>5</a>
</span><span class=lnt id=hl-1-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-6>6</a>
</span><span class=lnt id=hl-1-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-7>7</a>
</span><span class=lnt id=hl-1-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-8>8</a>
</span><span class=lnt id=hl-1-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-9>9</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>interface</span> <span class=nc>Serializer</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// ååºåˆ—åŒ–æ–¹æ³•
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>T</span> <span class=nf>deserialize</span><span class=o>(</span><span class=n>Class</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>clazz</span><span class=o>,</span> <span class=kt>byte</span><span class=o>[]</span> <span class=n>bytes</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// åºåˆ—åŒ–æ–¹æ³•
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=kt>byte</span><span class=o>[]</span> <span class=nf>serialize</span><span class=o>(</span><span class=n>T</span> <span class=n>object</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>æä¾›ä¸¤ä¸ªå®ç°ï¼Œæˆ‘è¿™é‡Œç›´æ¥å°†å®ç°åŠ å…¥äº†æšä¸¾ç±» Serializer.Algorithm ä¸­</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-2-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-1> 1</a>
</span><span class=lnt id=hl-2-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-2> 2</a>
</span><span class=lnt id=hl-2-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-3> 3</a>
</span><span class=lnt id=hl-2-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-4> 4</a>
</span><span class=lnt id=hl-2-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-5> 5</a>
</span><span class=lnt id=hl-2-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-6> 6</a>
</span><span class=lnt id=hl-2-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-7> 7</a>
</span><span class=lnt id=hl-2-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-8> 8</a>
</span><span class=lnt id=hl-2-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-9> 9</a>
</span><span class=lnt id=hl-2-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-10>10</a>
</span><span class=lnt id=hl-2-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-11>11</a>
</span><span class=lnt id=hl-2-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-12>12</a>
</span><span class=lnt id=hl-2-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-13>13</a>
</span><span class=lnt id=hl-2-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-14>14</a>
</span><span class=lnt id=hl-2-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-15>15</a>
</span><span class=lnt id=hl-2-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-16>16</a>
</span><span class=lnt id=hl-2-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-17>17</a>
</span><span class=lnt id=hl-2-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-18>18</a>
</span><span class=lnt id=hl-2-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-19>19</a>
</span><span class=lnt id=hl-2-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-20>20</a>
</span><span class=lnt id=hl-2-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-21>21</a>
</span><span class=lnt id=hl-2-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-22>22</a>
</span><span class=lnt id=hl-2-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-23>23</a>
</span><span class=lnt id=hl-2-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-24>24</a>
</span><span class=lnt id=hl-2-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-25>25</a>
</span><span class=lnt id=hl-2-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-26>26</a>
</span><span class=lnt id=hl-2-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-27>27</a>
</span><span class=lnt id=hl-2-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-28>28</a>
</span><span class=lnt id=hl-2-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-29>29</a>
</span><span class=lnt id=hl-2-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-30>30</a>
</span><span class=lnt id=hl-2-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-31>31</a>
</span><span class=lnt id=hl-2-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-32>32</a>
</span><span class=lnt id=hl-2-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-33>33</a>
</span><span class=lnt id=hl-2-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-34>34</a>
</span><span class=lnt id=hl-2-35><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-35>35</a>
</span><span class=lnt id=hl-2-36><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-36>36</a>
</span><span class=lnt id=hl-2-37><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-37>37</a>
</span><span class=lnt id=hl-2-38><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-38>38</a>
</span><span class=lnt id=hl-2-39><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-39>39</a>
</span><span class=lnt id=hl-2-40><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-40>40</a>
</span><span class=lnt id=hl-2-41><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-41>41</a>
</span><span class=lnt id=hl-2-42><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-42>42</a>
</span><span class=lnt id=hl-2-43><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-43>43</a>
</span><span class=lnt id=hl-2-44><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-44>44</a>
</span><span class=lnt id=hl-2-45><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-45>45</a>
</span><span class=lnt id=hl-2-46><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-46>46</a>
</span><span class=lnt id=hl-2-47><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-47>47</a>
</span><span class=lnt id=hl-2-48><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-48>48</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>enum</span> <span class=n>SerializerAlgorithm</span> <span class=kd>implements</span> <span class=n>Serializer</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Java å®ç°
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>Java</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>T</span> <span class=nf>deserialize</span><span class=o>(</span><span class=n>Class</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>clazz</span><span class=o>,</span> <span class=kt>byte</span><span class=o>[]</span> <span class=n>bytes</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>ObjectInputStream</span> <span class=n>in</span> <span class=o>=</span> 
</span></span><span class=line><span class=cl>                    <span class=k>new</span> <span class=n>ObjectInputStream</span><span class=o>(</span><span class=k>new</span> <span class=n>ByteArrayInputStream</span><span class=o>(</span><span class=n>bytes</span><span class=o>));</span>
</span></span><span class=line><span class=cl>                <span class=n>Object</span> <span class=n>object</span> <span class=o>=</span> <span class=n>in</span><span class=o>.</span><span class=na>readObject</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=o>(</span><span class=n>T</span><span class=o>)</span> <span class=n>object</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=o>|</span> <span class=n>ClassNotFoundException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>throw</span> <span class=k>new</span> <span class=n>RuntimeException</span><span class=o>(</span><span class=s>&#34;SerializerAlgorithm.Java ååºåˆ—åŒ–é”™è¯¯&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=kt>byte</span><span class=o>[]</span> <span class=nf>serialize</span><span class=o>(</span><span class=n>T</span> <span class=n>object</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>ByteArrayOutputStream</span> <span class=n>out</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ByteArrayOutputStream</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=k>new</span> <span class=n>ObjectOutputStream</span><span class=o>(</span><span class=n>out</span><span class=o>).</span><span class=na>writeObject</span><span class=o>(</span><span class=n>object</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>out</span><span class=o>.</span><span class=na>toByteArray</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>throw</span> <span class=k>new</span> <span class=n>RuntimeException</span><span class=o>(</span><span class=s>&#34;SerializerAlgorithm.Java åºåˆ—åŒ–é”™è¯¯&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>},</span> 
</span></span><span class=line><span class=cl>    <span class=c1>// Json å®ç°(å¼•å…¥äº† Gson ä¾èµ–)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>Json</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>T</span> <span class=nf>deserialize</span><span class=o>(</span><span class=n>Class</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>clazz</span><span class=o>,</span> <span class=kt>byte</span><span class=o>[]</span> <span class=n>bytes</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=k>new</span> <span class=n>Gson</span><span class=o>().</span><span class=na>fromJson</span><span class=o>(</span><span class=k>new</span> <span class=n>String</span><span class=o>(</span><span class=n>bytes</span><span class=o>,</span> <span class=n>StandardCharsets</span><span class=o>.</span><span class=na>UTF_8</span><span class=o>),</span> <span class=n>clazz</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=kt>byte</span><span class=o>[]</span> <span class=nf>serialize</span><span class=o>(</span><span class=n>T</span> <span class=n>object</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=k>new</span> <span class=n>Gson</span><span class=o>().</span><span class=na>toJson</span><span class=o>(</span><span class=n>object</span><span class=o>).</span><span class=na>getBytes</span><span class=o>(</span><span class=n>StandardCharsets</span><span class=o>.</span><span class=na>UTF_8</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// éœ€è¦ä»åè®®çš„å­—èŠ‚ä¸­å¾—åˆ°æ˜¯å“ªç§åºåˆ—åŒ–ç®—æ³•
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>public</span> <span class=kd>static</span> <span class=n>SerializerAlgorithm</span> <span class=nf>getByInt</span><span class=o>(</span><span class=kt>int</span> <span class=n>type</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>SerializerAlgorithm</span><span class=o>[]</span> <span class=n>array</span> <span class=o>=</span> <span class=n>SerializerAlgorithm</span><span class=o>.</span><span class=na>values</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>type</span> <span class=o>&lt;</span> <span class=n>0</span> <span class=o>||</span> <span class=n>type</span> <span class=o>&gt;</span> <span class=n>array</span><span class=o>.</span><span class=na>length</span> <span class=o>-</span> <span class=n>1</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=o>(</span><span class=s>&#34;è¶…è¿‡ SerializerAlgorithm èŒƒå›´&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>array</span><span class=o>[</span><span class=n>type</span><span class=o>];</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å¢åŠ é…ç½®ç±»å’Œé…ç½®æ–‡ä»¶</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-3-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-1> 1</a>
</span><span class=lnt id=hl-3-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-2> 2</a>
</span><span class=lnt id=hl-3-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-3> 3</a>
</span><span class=lnt id=hl-3-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-4> 4</a>
</span><span class=lnt id=hl-3-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-5> 5</a>
</span><span class=lnt id=hl-3-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-6> 6</a>
</span><span class=lnt id=hl-3-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-7> 7</a>
</span><span class=lnt id=hl-3-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-8> 8</a>
</span><span class=lnt id=hl-3-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-9> 9</a>
</span><span class=lnt id=hl-3-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-10>10</a>
</span><span class=lnt id=hl-3-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-11>11</a>
</span><span class=lnt id=hl-3-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-12>12</a>
</span><span class=lnt id=hl-3-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-13>13</a>
</span><span class=lnt id=hl-3-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-14>14</a>
</span><span class=lnt id=hl-3-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-15>15</a>
</span><span class=lnt id=hl-3-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-16>16</a>
</span><span class=lnt id=hl-3-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-17>17</a>
</span><span class=lnt id=hl-3-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-18>18</a>
</span><span class=lnt id=hl-3-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-19>19</a>
</span><span class=lnt id=hl-3-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-20>20</a>
</span><span class=lnt id=hl-3-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-21>21</a>
</span><span class=lnt id=hl-3-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-22>22</a>
</span><span class=lnt id=hl-3-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-23>23</a>
</span><span class=lnt id=hl-3-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-24>24</a>
</span><span class=lnt id=hl-3-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-25>25</a>
</span><span class=lnt id=hl-3-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-26>26</a>
</span><span class=lnt id=hl-3-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-27>27</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>abstract</span> <span class=kd>class</span> <span class=nc>Config</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>static</span> <span class=n>Properties</span> <span class=n>properties</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>static</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>(</span><span class=n>InputStream</span> <span class=n>in</span> <span class=o>=</span> <span class=n>Config</span><span class=o>.</span><span class=na>class</span><span class=o>.</span><span class=na>getResourceAsStream</span><span class=o>(</span><span class=s>&#34;/application.properties&#34;</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>properties</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Properties</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>properties</span><span class=o>.</span><span class=na>load</span><span class=o>(</span><span class=n>in</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>ExceptionInInitializerError</span><span class=o>(</span><span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>int</span> <span class=nf>getServerPort</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>String</span> <span class=n>value</span> <span class=o>=</span> <span class=n>properties</span><span class=o>.</span><span class=na>getProperty</span><span class=o>(</span><span class=s>&#34;server.port&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=o>(</span><span class=n>value</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>8080</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>Integer</span><span class=o>.</span><span class=na>parseInt</span><span class=o>(</span><span class=n>value</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=n>Serializer</span><span class=o>.</span><span class=na>Algorithm</span> <span class=nf>getSerializerAlgorithm</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>String</span> <span class=n>value</span> <span class=o>=</span> <span class=n>properties</span><span class=o>.</span><span class=na>getProperty</span><span class=o>(</span><span class=s>&#34;serializer.algorithm&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=o>(</span><span class=n>value</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>Serializer</span><span class=o>.</span><span class=na>Algorithm</span><span class=o>.</span><span class=na>Java</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>Serializer</span><span class=o>.</span><span class=na>Algorithm</span><span class=o>.</span><span class=na>valueOf</span><span class=o>(</span><span class=n>value</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>é…ç½®æ–‡ä»¶</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-4-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>serializer.algorithm=Json
</span></span></code></pre></td></tr></table></div></div><p>ä¿®æ”¹ç¼–è§£ç å™¨</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-5-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-1> 1</a>
</span><span class=lnt id=hl-5-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-2> 2</a>
</span><span class=lnt id=hl-5-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-3> 3</a>
</span><span class=lnt id=hl-5-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-4> 4</a>
</span><span class=lnt id=hl-5-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-5> 5</a>
</span><span class=lnt id=hl-5-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-6> 6</a>
</span><span class=lnt id=hl-5-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-7> 7</a>
</span><span class=lnt id=hl-5-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-8> 8</a>
</span><span class=lnt id=hl-5-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-9> 9</a>
</span><span class=lnt id=hl-5-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-10>10</a>
</span><span class=lnt id=hl-5-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-11>11</a>
</span><span class=lnt id=hl-5-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-12>12</a>
</span><span class=lnt id=hl-5-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-13>13</a>
</span><span class=lnt id=hl-5-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-14>14</a>
</span><span class=lnt id=hl-5-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-15>15</a>
</span><span class=lnt id=hl-5-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-16>16</a>
</span><span class=lnt id=hl-5-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-17>17</a>
</span><span class=lnt id=hl-5-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-18>18</a>
</span><span class=lnt id=hl-5-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-19>19</a>
</span><span class=lnt id=hl-5-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-20>20</a>
</span><span class=lnt id=hl-5-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-21>21</a>
</span><span class=lnt id=hl-5-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-22>22</a>
</span><span class=lnt id=hl-5-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-23>23</a>
</span><span class=lnt id=hl-5-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-24>24</a>
</span><span class=lnt id=hl-5-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-25>25</a>
</span><span class=lnt id=hl-5-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-26>26</a>
</span><span class=lnt id=hl-5-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-27>27</a>
</span><span class=lnt id=hl-5-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-28>28</a>
</span><span class=lnt id=hl-5-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-29>29</a>
</span><span class=lnt id=hl-5-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-30>30</a>
</span><span class=lnt id=hl-5-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-31>31</a>
</span><span class=lnt id=hl-5-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-32>32</a>
</span><span class=lnt id=hl-5-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-33>33</a>
</span><span class=lnt id=hl-5-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-34>34</a>
</span><span class=lnt id=hl-5-35><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-35>35</a>
</span><span class=lnt id=hl-5-36><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-36>36</a>
</span><span class=lnt id=hl-5-37><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-37>37</a>
</span><span class=lnt id=hl-5-38><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-38>38</a>
</span><span class=lnt id=hl-5-39><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-39>39</a>
</span><span class=lnt id=hl-5-40><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-40>40</a>
</span><span class=lnt id=hl-5-41><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-41>41</a>
</span><span class=lnt id=hl-5-42><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-42>42</a>
</span><span class=lnt id=hl-5-43><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-43>43</a>
</span><span class=lnt id=hl-5-44><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-44>44</a>
</span><span class=lnt id=hl-5-45><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-45>45</a>
</span><span class=lnt id=hl-5-46><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-46>46</a>
</span><span class=lnt id=hl-5-47><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-47>47</a>
</span><span class=lnt id=hl-5-48><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-48>48</a>
</span><span class=lnt id=hl-5-49><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-49>49</a>
</span><span class=lnt id=hl-5-50><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-50>50</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * å¿…é¡»å’Œ LengthFieldBasedFrameDecoder ä¸€èµ·ä½¿ç”¨ï¼Œç¡®ä¿æ¥åˆ°çš„ ByteBuf æ¶ˆæ¯æ˜¯å®Œæ•´çš„
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>MessageCodecSharable</span> <span class=kd>extends</span> <span class=n>MessageToMessageCodec</span><span class=o>&lt;</span><span class=n>ByteBuf</span><span class=o>,</span> <span class=n>Message</span><span class=o>&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>encode</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>,</span> <span class=n>Message</span> <span class=n>msg</span><span class=o>,</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span> <span class=n>outList</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ByteBuf</span> <span class=n>out</span> <span class=o>=</span> <span class=n>ctx</span><span class=o>.</span><span class=na>alloc</span><span class=o>().</span><span class=na>buffer</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 1. 4 å­—èŠ‚çš„é­”æ•°
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>out</span><span class=o>.</span><span class=na>writeBytes</span><span class=o>(</span><span class=k>new</span> <span class=kt>byte</span><span class=o>[]{</span><span class=n>1</span><span class=o>,</span> <span class=n>2</span><span class=o>,</span> <span class=n>3</span><span class=o>,</span> <span class=n>4</span><span class=o>});</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 2. 1 å­—èŠ‚çš„ç‰ˆæœ¬,
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>out</span><span class=o>.</span><span class=na>writeByte</span><span class=o>(</span><span class=n>1</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 3. 1 å­—èŠ‚çš„åºåˆ—åŒ–æ–¹å¼ jdk 0 , json 1
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>out</span><span class=o>.</span><span class=na>writeByte</span><span class=o>(</span><span class=n>Config</span><span class=o>.</span><span class=na>getSerializerAlgorithm</span><span class=o>().</span><span class=na>ordinal</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 4. 1 å­—èŠ‚çš„æŒ‡ä»¤ç±»å‹
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>out</span><span class=o>.</span><span class=na>writeByte</span><span class=o>(</span><span class=n>msg</span><span class=o>.</span><span class=na>getMessageType</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 5. 4 ä¸ªå­—èŠ‚
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>out</span><span class=o>.</span><span class=na>writeInt</span><span class=o>(</span><span class=n>msg</span><span class=o>.</span><span class=na>getSequenceId</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=c1>// æ— æ„ä¹‰ï¼Œå¯¹é½å¡«å……
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>out</span><span class=o>.</span><span class=na>writeByte</span><span class=o>(</span><span class=n>0xff</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 6. è·å–å†…å®¹çš„å­—èŠ‚æ•°ç»„
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kt>byte</span><span class=o>[]</span> <span class=n>bytes</span> <span class=o>=</span> <span class=n>Config</span><span class=o>.</span><span class=na>getSerializerAlgorithm</span><span class=o>().</span><span class=na>serialize</span><span class=o>(</span><span class=n>msg</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 7. é•¿åº¦
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>out</span><span class=o>.</span><span class=na>writeInt</span><span class=o>(</span><span class=n>bytes</span><span class=o>.</span><span class=na>length</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 8. å†™å…¥å†…å®¹
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>out</span><span class=o>.</span><span class=na>writeBytes</span><span class=o>(</span><span class=n>bytes</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>outList</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>out</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>decode</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>,</span> <span class=n>ByteBuf</span> <span class=n>in</span><span class=o>,</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span> <span class=n>out</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>magicNum</span> <span class=o>=</span> <span class=n>in</span><span class=o>.</span><span class=na>readInt</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=kt>byte</span> <span class=n>version</span> <span class=o>=</span> <span class=n>in</span><span class=o>.</span><span class=na>readByte</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=kt>byte</span> <span class=n>serializerAlgorithm</span> <span class=o>=</span> <span class=n>in</span><span class=o>.</span><span class=na>readByte</span><span class=o>();</span> <span class=c1>// 0 æˆ– 1
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kt>byte</span> <span class=n>messageType</span> <span class=o>=</span> <span class=n>in</span><span class=o>.</span><span class=na>readByte</span><span class=o>();</span> <span class=c1>// 0,1,2...
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kt>int</span> <span class=n>sequenceId</span> <span class=o>=</span> <span class=n>in</span><span class=o>.</span><span class=na>readInt</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>in</span><span class=o>.</span><span class=na>readByte</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>length</span> <span class=o>=</span> <span class=n>in</span><span class=o>.</span><span class=na>readInt</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=kt>byte</span><span class=o>[]</span> <span class=n>bytes</span> <span class=o>=</span> <span class=k>new</span> <span class=kt>byte</span><span class=o>[</span><span class=n>length</span><span class=o>];</span>
</span></span><span class=line><span class=cl>        <span class=n>in</span><span class=o>.</span><span class=na>readBytes</span><span class=o>(</span><span class=n>bytes</span><span class=o>,</span> <span class=n>0</span><span class=o>,</span> <span class=n>length</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// æ‰¾åˆ°ååºåˆ—åŒ–ç®—æ³•
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>Serializer</span><span class=o>.</span><span class=na>Algorithm</span> <span class=n>algorithm</span> <span class=o>=</span> <span class=n>Serializer</span><span class=o>.</span><span class=na>Algorithm</span><span class=o>.</span><span class=na>values</span><span class=o>()[</span><span class=n>serializerAlgorithm</span><span class=o>];</span>
</span></span><span class=line><span class=cl>        <span class=c1>// ç¡®å®šå…·ä½“æ¶ˆæ¯ç±»å‹
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>Class</span><span class=o>&lt;?</span> <span class=kd>extends</span> <span class=n>Message</span><span class=o>&gt;</span> <span class=n>messageClass</span> <span class=o>=</span> <span class=n>Message</span><span class=o>.</span><span class=na>getMessageClass</span><span class=o>(</span><span class=n>messageType</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>Message</span> <span class=n>message</span> <span class=o>=</span> <span class=n>algorithm</span><span class=o>.</span><span class=na>deserialize</span><span class=o>(</span><span class=n>messageClass</span><span class=o>,</span> <span class=n>bytes</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=c1>//        log.debug(&#34;{}, {}, {}, {}, {}, {}&#34;, magicNum, version, serializerType, messageType, sequenceId, length);
</span></span></span><span class=line><span class=cl><span class=c1>//        log.debug(&#34;{}&#34;, message);
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>out</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>message</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å…¶ä¸­ç¡®å®šå…·ä½“æ¶ˆæ¯ç±»å‹ï¼Œå¯ä»¥æ ¹æ® <code>æ¶ˆæ¯ç±»å‹å­—èŠ‚</code> è·å–åˆ°å¯¹åº”çš„ <code>æ¶ˆæ¯ class</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-6-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-1> 1</a>
</span><span class=lnt id=hl-6-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-2> 2</a>
</span><span class=lnt id=hl-6-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-3> 3</a>
</span><span class=lnt id=hl-6-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-4> 4</a>
</span><span class=lnt id=hl-6-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-5> 5</a>
</span><span class=lnt id=hl-6-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-6> 6</a>
</span><span class=lnt id=hl-6-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-7> 7</a>
</span><span class=lnt id=hl-6-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-8> 8</a>
</span><span class=lnt id=hl-6-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-9> 9</a>
</span><span class=lnt id=hl-6-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-10>10</a>
</span><span class=lnt id=hl-6-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-11>11</a>
</span><span class=lnt id=hl-6-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-12>12</a>
</span><span class=lnt id=hl-6-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-13>13</a>
</span><span class=lnt id=hl-6-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-14>14</a>
</span><span class=lnt id=hl-6-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-15>15</a>
</span><span class=lnt id=hl-6-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-16>16</a>
</span><span class=lnt id=hl-6-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-17>17</a>
</span><span class=lnt id=hl-6-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-18>18</a>
</span><span class=lnt id=hl-6-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-19>19</a>
</span><span class=lnt id=hl-6-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-20>20</a>
</span><span class=lnt id=hl-6-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-21>21</a>
</span><span class=lnt id=hl-6-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-22>22</a>
</span><span class=lnt id=hl-6-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-23>23</a>
</span><span class=lnt id=hl-6-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-24>24</a>
</span><span class=lnt id=hl-6-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-25>25</a>
</span><span class=lnt id=hl-6-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-26>26</a>
</span><span class=lnt id=hl-6-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-27>27</a>
</span><span class=lnt id=hl-6-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-28>28</a>
</span><span class=lnt id=hl-6-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-29>29</a>
</span><span class=lnt id=hl-6-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-30>30</a>
</span><span class=lnt id=hl-6-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-31>31</a>
</span><span class=lnt id=hl-6-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-32>32</a>
</span><span class=lnt id=hl-6-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-33>33</a>
</span><span class=lnt id=hl-6-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-34>34</a>
</span><span class=lnt id=hl-6-35><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-35>35</a>
</span><span class=lnt id=hl-6-36><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-36>36</a>
</span><span class=lnt id=hl-6-37><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-37>37</a>
</span><span class=lnt id=hl-6-38><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-38>38</a>
</span><span class=lnt id=hl-6-39><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-39>39</a>
</span><span class=lnt id=hl-6-40><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-40>40</a>
</span><span class=lnt id=hl-6-41><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-41>41</a>
</span><span class=lnt id=hl-6-42><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-42>42</a>
</span><span class=lnt id=hl-6-43><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-43>43</a>
</span><span class=lnt id=hl-6-44><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-44>44</a>
</span><span class=lnt id=hl-6-45><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-45>45</a>
</span><span class=lnt id=hl-6-46><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-46>46</a>
</span><span class=lnt id=hl-6-47><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-47>47</a>
</span><span class=lnt id=hl-6-48><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-48>48</a>
</span><span class=lnt id=hl-6-49><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-49>49</a>
</span><span class=lnt id=hl-6-50><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-50>50</a>
</span><span class=lnt id=hl-6-51><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-51>51</a>
</span><span class=lnt id=hl-6-52><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-52>52</a>
</span><span class=lnt id=hl-6-53><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-53>53</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Data</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>abstract</span> <span class=kd>class</span> <span class=nc>Message</span> <span class=kd>implements</span> <span class=n>Serializable</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * æ ¹æ®æ¶ˆæ¯ç±»å‹å­—èŠ‚ï¼Œè·å¾—å¯¹åº”çš„æ¶ˆæ¯ class
</span></span></span><span class=line><span class=cl><span class=cm>     * @param messageType æ¶ˆæ¯ç±»å‹å­—èŠ‚
</span></span></span><span class=line><span class=cl><span class=cm>     * @return æ¶ˆæ¯ class
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=n>Class</span><span class=o>&lt;?</span> <span class=kd>extends</span> <span class=n>Message</span><span class=o>&gt;</span> <span class=nf>getMessageClass</span><span class=o>(</span><span class=kt>int</span> <span class=n>messageType</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>messageClasses</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>messageType</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kt>int</span> <span class=n>sequenceId</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kt>int</span> <span class=n>messageType</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>abstract</span> <span class=kt>int</span> <span class=nf>getMessageType</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>LoginRequestMessage</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>LoginResponseMessage</span> <span class=o>=</span> <span class=n>1</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>ChatRequestMessage</span> <span class=o>=</span> <span class=n>2</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>ChatResponseMessage</span> <span class=o>=</span> <span class=n>3</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>GroupCreateRequestMessage</span> <span class=o>=</span> <span class=n>4</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>GroupCreateResponseMessage</span> <span class=o>=</span> <span class=n>5</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>GroupJoinRequestMessage</span> <span class=o>=</span> <span class=n>6</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>GroupJoinResponseMessage</span> <span class=o>=</span> <span class=n>7</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>GroupQuitRequestMessage</span> <span class=o>=</span> <span class=n>8</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>GroupQuitResponseMessage</span> <span class=o>=</span> <span class=n>9</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>GroupChatRequestMessage</span> <span class=o>=</span> <span class=n>10</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>GroupChatResponseMessage</span> <span class=o>=</span> <span class=n>11</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>GroupMembersRequestMessage</span> <span class=o>=</span> <span class=n>12</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>GroupMembersResponseMessage</span> <span class=o>=</span> <span class=n>13</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>PingMessage</span> <span class=o>=</span> <span class=n>14</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>PongMessage</span> <span class=o>=</span> <span class=n>15</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>,</span> <span class=n>Class</span><span class=o>&lt;?</span> <span class=kd>extends</span> <span class=n>Message</span><span class=o>&gt;&gt;</span> <span class=n>messageClasses</span> <span class=o>=</span> <span class=k>new</span> <span class=n>HashMap</span><span class=o>&lt;&gt;();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>static</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>messageClasses</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>LoginRequestMessage</span><span class=o>,</span> <span class=n>LoginRequestMessage</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>messageClasses</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>LoginResponseMessage</span><span class=o>,</span> <span class=n>LoginResponseMessage</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>messageClasses</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>ChatRequestMessage</span><span class=o>,</span> <span class=n>ChatRequestMessage</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>messageClasses</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>ChatResponseMessage</span><span class=o>,</span> <span class=n>ChatResponseMessage</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>messageClasses</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>GroupCreateRequestMessage</span><span class=o>,</span> <span class=n>GroupCreateRequestMessage</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>messageClasses</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>GroupCreateResponseMessage</span><span class=o>,</span> <span class=n>GroupCreateResponseMessage</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>messageClasses</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>GroupJoinRequestMessage</span><span class=o>,</span> <span class=n>GroupJoinRequestMessage</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>messageClasses</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>GroupJoinResponseMessage</span><span class=o>,</span> <span class=n>GroupJoinResponseMessage</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>messageClasses</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>GroupQuitRequestMessage</span><span class=o>,</span> <span class=n>GroupQuitRequestMessage</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>messageClasses</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>GroupQuitResponseMessage</span><span class=o>,</span> <span class=n>GroupQuitResponseMessage</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>messageClasses</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>GroupChatRequestMessage</span><span class=o>,</span> <span class=n>GroupChatRequestMessage</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>messageClasses</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>GroupChatResponseMessage</span><span class=o>,</span> <span class=n>GroupChatResponseMessage</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>messageClasses</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>GroupMembersRequestMessage</span><span class=o>,</span> <span class=n>GroupMembersRequestMessage</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>messageClasses</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>GroupMembersResponseMessage</span><span class=o>,</span> <span class=n>GroupMembersResponseMessage</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#12-å‚æ•°è°ƒä¼˜><h3 id=12-å‚æ•°è°ƒä¼˜><span class=hanchor arialabel=Anchor># </span>1.2 å‚æ•°è°ƒä¼˜</h3></a><p>å®¢æˆ·ç«¯ç›´æ¥è°ƒç”¨ Bootstrap().option(xxx)
æœåŠ¡å™¨ç«¯ï¼š
ServerBootstrap().option(xxx)æ˜¯ç»™ServerSocketChannelé…ç½®å‚æ•°
ServerBootstrap().childOption(xxx)æ˜¯ç»™SocketChannelé…ç½®å‚æ•°</p><a href=#1connect_timeout_millis><h4 id=1connect_timeout_millis><span class=hanchor arialabel=Anchor># </span>1ï¼‰CONNECT_TIMEOUT_MILLIS</h4></a><ul><li><p>å±äº SocketChannal å‚æ•°</p></li><li><p>ç”¨åœ¨å®¢æˆ·ç«¯å»ºç«‹è¿æ¥æ—¶ï¼Œå¦‚æœåœ¨æŒ‡å®šæ¯«ç§’å†…æ— æ³•è¿æ¥ï¼Œä¼šæŠ›å‡º timeout å¼‚å¸¸</p></li><li><p>SO_TIMEOUT ä¸»è¦ç”¨åœ¨é˜»å¡ IOï¼Œé˜»å¡ IO ä¸­ acceptï¼Œread ç­‰éƒ½æ˜¯æ— é™ç­‰å¾…çš„ï¼Œå¦‚æœä¸å¸Œæœ›æ°¸è¿œé˜»å¡ï¼Œä½¿ç”¨å®ƒè°ƒæ•´è¶…æ—¶æ—¶é—´</p></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-7-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-1> 1</a>
</span><span class=lnt id=hl-7-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-2> 2</a>
</span><span class=lnt id=hl-7-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-3> 3</a>
</span><span class=lnt id=hl-7-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-4> 4</a>
</span><span class=lnt id=hl-7-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-5> 5</a>
</span><span class=lnt id=hl-7-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-6> 6</a>
</span><span class=lnt id=hl-7-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-7> 7</a>
</span><span class=lnt id=hl-7-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-8> 8</a>
</span><span class=lnt id=hl-7-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-9> 9</a>
</span><span class=lnt id=hl-7-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-10>10</a>
</span><span class=lnt id=hl-7-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-11>11</a>
</span><span class=lnt id=hl-7-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-12>12</a>
</span><span class=lnt id=hl-7-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-13>13</a>
</span><span class=lnt id=hl-7-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-14>14</a>
</span><span class=lnt id=hl-7-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-15>15</a>
</span><span class=lnt id=hl-7-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-16>16</a>
</span><span class=lnt id=hl-7-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-17>17</a>
</span><span class=lnt id=hl-7-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-18>18</a>
</span><span class=lnt id=hl-7-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-19>19</a>
</span><span class=lnt id=hl-7-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-20>20</a>
</span><span class=lnt id=hl-7-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-21>21</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>TestConnectionTimeout</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>NioEventLoopGroup</span> <span class=n>group</span> <span class=o>=</span> <span class=k>new</span> <span class=n>NioEventLoopGroup</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Bootstrap</span> <span class=n>bootstrap</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Bootstrap</span><span class=o>()</span>
</span></span><span class=line><span class=cl>                    <span class=o>.</span><span class=na>group</span><span class=o>(</span><span class=n>group</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                    <span class=c1>// é…ç½®å‚æ•°
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=o>.</span><span class=na>option</span><span class=o>(</span><span class=n>ChannelOption</span><span class=o>.</span><span class=na>CONNECT_TIMEOUT_MILLIS</span><span class=o>,</span> <span class=n>300</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                    <span class=o>.</span><span class=na>channel</span><span class=o>(</span><span class=n>NioSocketChannel</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                    <span class=o>.</span><span class=na>handler</span><span class=o>(</span><span class=k>new</span> <span class=n>LoggingHandler</span><span class=o>());</span>
</span></span><span class=line><span class=cl>            <span class=n>ChannelFuture</span> <span class=n>future</span> <span class=o>=</span> <span class=n>bootstrap</span><span class=o>.</span><span class=na>connect</span><span class=o>(</span><span class=s>&#34;127.0.0.1&#34;</span><span class=o>,</span> <span class=n>8080</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>future</span><span class=o>.</span><span class=na>sync</span><span class=o>().</span><span class=na>channel</span><span class=o>().</span><span class=na>closeFuture</span><span class=o>().</span><span class=na>sync</span><span class=o>();</span> <span class=c1>// æ–­ç‚¹1
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Exception</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;timeout&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>group</span><span class=o>.</span><span class=na>shutdownGracefully</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å¦å¤–æºç éƒ¨åˆ† <code>io.netty.channel.nio.AbstractNioChannel.AbstractNioUnsafe#connect</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-8-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-1> 1</a>
</span><span class=lnt id=hl-8-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-2> 2</a>
</span><span class=lnt id=hl-8-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-3> 3</a>
</span><span class=lnt id=hl-8-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-4> 4</a>
</span><span class=lnt id=hl-8-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-5> 5</a>
</span><span class=lnt id=hl-8-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-6> 6</a>
</span><span class=lnt id=hl-8-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-7> 7</a>
</span><span class=lnt id=hl-8-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-8> 8</a>
</span><span class=lnt id=hl-8-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-9> 9</a>
</span><span class=lnt id=hl-8-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-10>10</a>
</span><span class=lnt id=hl-8-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-11>11</a>
</span><span class=lnt id=hl-8-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-12>12</a>
</span><span class=lnt id=hl-8-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-13>13</a>
</span><span class=lnt id=hl-8-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-14>14</a>
</span><span class=lnt id=hl-8-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-15>15</a>
</span><span class=lnt id=hl-8-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-16>16</a>
</span><span class=lnt id=hl-8-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-17>17</a>
</span><span class=lnt id=hl-8-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-18>18</a>
</span><span class=lnt id=hl-8-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-19>19</a>
</span><span class=lnt id=hl-8-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-20>20</a>
</span><span class=lnt id=hl-8-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-21>21</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>final</span> <span class=kt>void</span> <span class=nf>connect</span><span class=o>(</span>
</span></span><span class=line><span class=cl>        <span class=kd>final</span> <span class=n>SocketAddress</span> <span class=n>remoteAddress</span><span class=o>,</span> <span class=kd>final</span> <span class=n>SocketAddress</span> <span class=n>localAddress</span><span class=o>,</span> <span class=kd>final</span> <span class=n>ChannelPromise</span> <span class=n>promise</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// Schedule connect timeout.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>int</span> <span class=n>connectTimeoutMillis</span> <span class=o>=</span> <span class=n>config</span><span class=o>().</span><span class=na>getConnectTimeoutMillis</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>connectTimeoutMillis</span> <span class=o>&gt;</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>connectTimeoutFuture</span> <span class=o>=</span> <span class=n>eventLoop</span><span class=o>().</span><span class=na>schedule</span><span class=o>(</span><span class=k>new</span> <span class=n>Runnable</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>            <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>                
</span></span><span class=line><span class=cl>                <span class=n>ChannelPromise</span> <span class=n>connectPromise</span> <span class=o>=</span> <span class=n>AbstractNioChannel</span><span class=o>.</span><span class=na>this</span><span class=o>.</span><span class=na>connectPromise</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=n>ConnectTimeoutException</span> <span class=n>cause</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>                    <span class=k>new</span> <span class=n>ConnectTimeoutException</span><span class=o>(</span><span class=s>&#34;connection timed out: &#34;</span> <span class=o>+</span> <span class=n>remoteAddress</span><span class=o>);</span> <span class=c1>// æ–­ç‚¹2
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=k>if</span> <span class=o>(</span><span class=n>connectPromise</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>connectPromise</span><span class=o>.</span><span class=na>tryFailure</span><span class=o>(</span><span class=n>cause</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>close</span><span class=o>(</span><span class=n>voidPromise</span><span class=o>());</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>},</span> <span class=n>connectTimeoutMillis</span><span class=o>,</span> <span class=n>TimeUnit</span><span class=o>.</span><span class=na>MILLISECONDS</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#2so_backlog><h4 id=2so_backlog><span class=hanchor arialabel=Anchor># </span>2ï¼‰SO_BACKLOG</h4></a><ul><li>å±äº ServerSocketChannal å‚æ•°</li></ul><p>ä¸‰æ¬¡æ¡æ‰‹çš„è¿‡ç¨‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-9-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-1> 1</a>
</span><span class=lnt id=hl-9-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-2> 2</a>
</span><span class=lnt id=hl-9-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-3> 3</a>
</span><span class=lnt id=hl-9-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-4> 4</a>
</span><span class=lnt id=hl-9-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-5> 5</a>
</span><span class=lnt id=hl-9-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-6> 6</a>
</span><span class=lnt id=hl-9-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-7> 7</a>
</span><span class=lnt id=hl-9-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-8> 8</a>
</span><span class=lnt id=hl-9-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-9> 9</a>
</span><span class=lnt id=hl-9-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-10>10</a>
</span><span class=lnt id=hl-9-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-11>11</a>
</span><span class=lnt id=hl-9-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-12>12</a>
</span><span class=lnt id=hl-9-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-13>13</a>
</span><span class=lnt id=hl-9-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-14>14</a>
</span><span class=lnt id=hl-9-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-15>15</a>
</span><span class=lnt id=hl-9-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-16>16</a>
</span><span class=lnt id=hl-9-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-17>17</a>
</span><span class=lnt id=hl-9-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-18>18</a>
</span><span class=lnt id=hl-9-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-19>19</a>
</span><span class=lnt id=hl-9-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-20>20</a>
</span><span class=lnt id=hl-9-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-21>21</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>sequenceDiagram
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>participant c as client
</span></span><span class=line><span class=cl>participant s as server
</span></span><span class=line><span class=cl>participant sq as syns queue
</span></span><span class=line><span class=cl>participant aq as accept queue
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>s -&gt;&gt; s : bind()
</span></span><span class=line><span class=cl>s -&gt;&gt; s : listen()
</span></span><span class=line><span class=cl>c -&gt;&gt; c : connect()
</span></span><span class=line><span class=cl>c -&gt;&gt; s : 1. SYN
</span></span><span class=line><span class=cl>Note left of c : SYN_SEND
</span></span><span class=line><span class=cl>s -&gt;&gt; sq : put
</span></span><span class=line><span class=cl>Note right of s : SYN_RCVD
</span></span><span class=line><span class=cl>s -&gt;&gt; c : 2. SYN + ACK
</span></span><span class=line><span class=cl>Note left of c : ESTABLISHED
</span></span><span class=line><span class=cl>c -&gt;&gt; s : 3. ACK
</span></span><span class=line><span class=cl>sq -&gt;&gt; aq : put
</span></span><span class=line><span class=cl>Note right of s : ESTABLISHED
</span></span><span class=line><span class=cl>aq --&gt;&gt; s : 
</span></span><span class=line><span class=cl>s -&gt;&gt; s : accept()
</span></span></code></pre></td></tr></table></div></div><blockquote><p>sync queueï¼šåŠè¿æ¥é˜Ÿåˆ—ï¼šè¿˜æœªå®Œæˆä¸‰æ¬¡æ¡æ‰‹çš„è¿æ¥æ”¾å…¥
accept queueï¼šå…¨è¿æ¥é˜Ÿåˆ—ï¼šå®Œæˆä¸‰æ¬¡æ¡æ‰‹çš„è¿æ¥æ”¾å…¥</p></blockquote><blockquote><p>æœåŠ¡å™¨å…ˆæ”¾å…¥accept queueçš„åŸå› æ˜¯ï¼šæœåŠ¡å™¨å¤„ç†accept()çš„èƒ½åŠ›æœ‰é™ï¼Œå¦‚æœå¤§é‡å®¢æˆ·ç«¯è¿æ¥å¯èƒ½é€ æˆè´Ÿè½½è¿‡é«˜ï¼Œæ‰€ä»¥å…ˆæ”¾å…¥é˜Ÿåˆ—ã€‚
ä¸‰æ¬¡æ¡æ‰‹å‘ç”Ÿåœ¨accept()ä¹‹å‰ã€‚</p></blockquote><ol><li>ç¬¬ä¸€æ¬¡æ¡æ‰‹ï¼Œclient å‘é€ SYN åˆ° serverï¼ŒçŠ¶æ€ä¿®æ”¹ä¸º SYN_SENDï¼Œserver æ”¶åˆ°ï¼ŒçŠ¶æ€æ”¹å˜ä¸º SYN_REVDï¼Œå¹¶å°†è¯¥è¯·æ±‚æ”¾å…¥ sync queue é˜Ÿåˆ—</li><li>ç¬¬äºŒæ¬¡æ¡æ‰‹ï¼Œserver å›å¤ SYN + ACK ç»™ clientï¼Œclient æ”¶åˆ°ï¼ŒçŠ¶æ€æ”¹å˜ä¸º ESTABLISHEDï¼Œå¹¶å‘é€ ACK ç»™ server</li><li>ç¬¬ä¸‰æ¬¡æ¡æ‰‹ï¼Œserver æ”¶åˆ° ACKï¼ŒçŠ¶æ€æ”¹å˜ä¸º ESTABLISHEDï¼Œå°†è¯¥è¯·æ±‚ä» sync queue æ”¾å…¥ accept queue</li></ol><p>å…¶ä¸­</p><ul><li><p>åœ¨ linux 2.2 ä¹‹å‰ï¼Œbacklog å¤§å°åŒ…æ‹¬äº†ä¸¤ä¸ªé˜Ÿåˆ—çš„å¤§å°ï¼Œåœ¨ 2.2 ä¹‹åï¼Œåˆ†åˆ«ç”¨ä¸‹é¢ä¸¤ä¸ªå‚æ•°æ¥æ§åˆ¶</p></li><li><p>sync queue - åŠè¿æ¥é˜Ÿåˆ—</p><ul><li>å¤§å°é€šè¿‡ /proc/sys/net/ipv4/tcp_max_syn_backlog æŒ‡å®šï¼Œåœ¨ <code>syncookies</code> å¯ç”¨çš„æƒ…å†µä¸‹ï¼Œé€»è¾‘ä¸Šæ²¡æœ‰æœ€å¤§å€¼é™åˆ¶ï¼Œè¿™ä¸ªè®¾ç½®ä¾¿è¢«å¿½ç•¥</li></ul></li><li><p>accept queue - å…¨è¿æ¥é˜Ÿåˆ—</p><ul><li>å…¶å¤§å°é€šè¿‡ /proc/sys/net/core/somaxconn æŒ‡å®šï¼Œåœ¨ä½¿ç”¨ listen å‡½æ•°æ—¶ï¼Œå†…æ ¸ä¼šæ ¹æ®ä¼ å…¥çš„ backlog å‚æ•°ä¸ç³»ç»Ÿå‚æ•°ï¼Œå–<strong>äºŒè€…çš„è¾ƒå°å€¼</strong></li><li><strong>å¦‚æœ accpet queue é˜Ÿåˆ—æ»¡äº†ï¼Œserver å°†å‘é€ä¸€ä¸ªæ‹’ç»è¿æ¥çš„é”™è¯¯ä¿¡æ¯åˆ° client</strong></li></ul></li></ul><p>netty ä¸­</p><p>å¯ä»¥é€šè¿‡ option(ChannelOption.SO_BACKLOG, å€¼) æ¥è®¾ç½®å…¨è¿æ¥é˜Ÿåˆ—å¤§å°</p><p>å¯ä»¥é€šè¿‡ä¸‹é¢æºç æŸ¥çœ‹é»˜è®¤å¤§å°</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-10-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-1>1</a>
</span><span class=lnt id=hl-10-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-2>2</a>
</span><span class=lnt id=hl-10-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-3>3</a>
</span><span class=lnt id=hl-10-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-4>4</a>
</span><span class=lnt id=hl-10-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-5>5</a>
</span><span class=lnt id=hl-10-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>DefaultServerSocketChannelConfig</span> <span class=kd>extends</span> <span class=n>DefaultChannelConfig</span>
</span></span><span class=line><span class=cl>                                              <span class=kd>implements</span> <span class=n>ServerSocketChannelConfig</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>volatile</span> <span class=kt>int</span> <span class=n>backlog</span> <span class=o>=</span> <span class=n>NetUtil</span><span class=o>.</span><span class=na>SOMAXCONN</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>è¯¾å ‚è°ƒè¯•å…³é”®æ–­ç‚¹ä¸ºï¼š<code>io.netty.channel.nio.NioEventLoop#processSelectedKey</code></p><p>oio ä¸­æ›´å®¹æ˜“è¯´æ˜ï¼Œä¸ç”¨ debug æ¨¡å¼</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-11-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-1>1</a>
</span><span class=lnt id=hl-11-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-2>2</a>
</span><span class=lnt id=hl-11-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-3>3</a>
</span><span class=lnt id=hl-11-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-4>4</a>
</span><span class=lnt id=hl-11-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-5>5</a>
</span><span class=lnt id=hl-11-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-6>6</a>
</span><span class=lnt id=hl-11-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-7>7</a>
</span><span class=lnt id=hl-11-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-8>8</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>Server</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ServerSocket</span> <span class=n>ss</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ServerSocket</span><span class=o>(</span><span class=n>8888</span><span class=o>,</span> <span class=n>2</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>Socket</span> <span class=n>accept</span> <span class=o>=</span> <span class=n>ss</span><span class=o>.</span><span class=na>accept</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>accept</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>in</span><span class=o>.</span><span class=na>read</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å®¢æˆ·ç«¯å¯åŠ¨ 4 ä¸ª</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-12-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-1> 1</a>
</span><span class=lnt id=hl-12-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-2> 2</a>
</span><span class=lnt id=hl-12-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-3> 3</a>
</span><span class=lnt id=hl-12-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-4> 4</a>
</span><span class=lnt id=hl-12-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-5> 5</a>
</span><span class=lnt id=hl-12-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-6> 6</a>
</span><span class=lnt id=hl-12-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-7> 7</a>
</span><span class=lnt id=hl-12-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-8> 8</a>
</span><span class=lnt id=hl-12-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-9> 9</a>
</span><span class=lnt id=hl-12-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-10>10</a>
</span><span class=lnt id=hl-12-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-11>11</a>
</span><span class=lnt id=hl-12-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-12>12</a>
</span><span class=lnt id=hl-12-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-13>13</a>
</span><span class=lnt id=hl-12-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-14>14</a>
</span><span class=lnt id=hl-12-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-15>15</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>Client</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Socket</span> <span class=n>s</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Socket</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=k>new</span> <span class=n>Date</span><span class=o>()+</span><span class=s>&#34; connecting...&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>s</span><span class=o>.</span><span class=na>connect</span><span class=o>(</span><span class=k>new</span> <span class=n>InetSocketAddress</span><span class=o>(</span><span class=s>&#34;localhost&#34;</span><span class=o>,</span> <span class=n>8888</span><span class=o>),</span><span class=n>1000</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=k>new</span> <span class=n>Date</span><span class=o>()+</span><span class=s>&#34; connected...&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>s</span><span class=o>.</span><span class=na>getOutputStream</span><span class=o>().</span><span class=na>write</span><span class=o>(</span><span class=n>1</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>System</span><span class=o>.</span><span class=na>in</span><span class=o>.</span><span class=na>read</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=k>new</span> <span class=n>Date</span><span class=o>()+</span><span class=s>&#34; connecting timeout...&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>ç¬¬ 1ï¼Œ2ï¼Œ3 ä¸ªå®¢æˆ·ç«¯éƒ½æ‰“å°ï¼Œä½†é™¤äº†ç¬¬ä¸€ä¸ªå¤„äº accpet å¤–ï¼Œå…¶å®ƒä¸¤ä¸ªéƒ½å¤„äº accept queue ä¸­</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-13-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-1>1</a>
</span><span class=lnt id=hl-13-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-2>2</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Tue</span> <span class=n>Apr</span> <span class=n>21</span> <span class=n>20</span><span class=o>:</span><span class=n>30</span><span class=o>:</span><span class=n>28</span> <span class=n>CST</span> <span class=n>2020</span> <span class=n>connecting</span><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=n>Tue</span> <span class=n>Apr</span> <span class=n>21</span> <span class=n>20</span><span class=o>:</span><span class=n>30</span><span class=o>:</span><span class=n>28</span> <span class=n>CST</span> <span class=n>2020</span> <span class=n>connected</span><span class=o>...</span>
</span></span></code></pre></td></tr></table></div></div><p>ç¬¬ 4 ä¸ªå®¢æˆ·ç«¯è¿æ¥æ—¶</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-14-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-1>1</a>
</span><span class=lnt id=hl-14-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-2>2</a>
</span><span class=lnt id=hl-14-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Tue Apr 21 20:53:58 CST 2020 connecting...
</span></span><span class=line><span class=cl>Tue Apr 21 20:53:59 CST 2020 connecting timeout...
</span></span><span class=line><span class=cl>java.net.SocketTimeoutException: connect timed out
</span></span></code></pre></td></tr></table></div></div><a href=#3ulimit--n><h4 id=3ulimit--n><span class=hanchor arialabel=Anchor># </span>3ï¼‰ulimit -n</h4></a><ul><li>å±äºæ“ä½œç³»ç»Ÿå‚æ•°</li></ul><p>é™åˆ¶è¿›ç¨‹èƒ½åŒæ—¶æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦æ•°é‡ã€‚</p><blockquote><p>Linux çš„æ™®é€šæ–‡ä»¶å’Œsocketéƒ½æ˜¯ç”¨æ–‡ä»¶æè¿°ç¬¦æ¥ä»£è¡¨ã€‚
å±äºç³»ç»Ÿçš„ä¸´æ—¶è°ƒæ•´ï¼Œå»ºè®®æ”¾åœ¨å¯åŠ¨è„šæœ¬ã€‚</p></blockquote><a href=#4tcp_nodelay><h4 id=4tcp_nodelay><span class=hanchor arialabel=Anchor># </span>4ï¼‰TCP_NODELAY</h4></a><ul><li>å±äº SocketChannal å‚æ•°ï¼Œéœ€è¦childOptionè®¾ç½®ã€‚</li></ul><blockquote><p>é»˜è®¤å€¼æ˜¯falseï¼Œä»£è¡¨å¼€å¯nagleç®—æ³•ã€‚
è®¾ä¸ºtrueå…³é—­nagleç®—æ³•ã€‚</p></blockquote><a href=#5so_sndbuf--so_rcvbuf><h4 id=5so_sndbuf--so_rcvbuf><span class=hanchor arialabel=Anchor># </span>5ï¼‰SO_SNDBUF & SO_RCVBUF</h4></a><ul><li>SO_SNDBUF å±äº SocketChannal å‚æ•°</li><li>SO_RCVBUF æ—¢å¯ç”¨äº SocketChannal å‚æ•°ï¼Œä¹Ÿå¯ä»¥ç”¨äº ServerSocketChannal å‚æ•°ï¼ˆå»ºè®®è®¾ç½®åˆ° ServerSocketChannal ä¸Šï¼‰</li></ul><blockquote><p>ä¸å»ºè®®è°ƒæ•´è¯¥å‚æ•°ï¼Œæ“ä½œç³»ç»Ÿæ‹¥å¡æ§åˆ¶ä¼šè‡ªåŠ¨è°ƒæ•´ã€‚</p></blockquote><a href=#6allocator><h4 id=6allocator><span class=hanchor arialabel=Anchor># </span>6ï¼‰ALLOCATOR</h4></a><ul><li>å±äº SocketChannal å‚æ•°</li><li>ç”¨æ¥åˆ†é… ByteBufï¼Œ ctx.alloc()</li><li>æ§åˆ¶åˆ†é…å‡ºæ¥çš„ByteBufæ˜¯æ± åŒ–/éæ± åŒ–ï¼Œç›´æ¥å†…å­˜/å †å†…å­˜<ul><li>é»˜è®¤æ˜¯æ± åŒ– ç›´æ¥å†…å­˜</li></ul></li></ul><blockquote><p>è°ƒç”¨ctx.alloc()æ‹¿åˆ°çš„å°±æ˜¯è¯¥åˆ†é…å™¨å¯¹è±¡ã€‚</p></blockquote><a href=#7rcvbuf_allocator><h4 id=7rcvbuf_allocator><span class=hanchor arialabel=Anchor># </span>7ï¼‰RCVBUF_ALLOCATOR</h4></a><ul><li>å±äº SocketChannal å‚æ•°</li><li>æ§åˆ¶ netty <strong>æ¥æ”¶</strong>ç¼“å†²åŒºå¤§å°</li><li>è´Ÿè´£å…¥ç«™æ•°æ®çš„åˆ†é…ï¼Œå†³å®šå…¥ç«™ç¼“å†²åŒºçš„å¤§å°ï¼ˆå¹¶å¯åŠ¨æ€è°ƒæ•´ï¼‰ï¼Œ<strong>ç»Ÿä¸€é‡‡ç”¨ direct ç›´æ¥å†…å­˜</strong>ï¼Œå…·ä½“æ± åŒ–è¿˜æ˜¯éæ± åŒ–ç”± allocator å†³å®š</li></ul><blockquote><p>ALLOCATOR å’Œ RCVBUF_ALLOCATOR å…±åŒåä½œå®ŒæˆByteBufçš„åˆå§‹åˆ†é…ã€‚</p></blockquote><a href=#13-rpc-æ¡†æ¶><h3 id=13-rpc-æ¡†æ¶><span class=hanchor arialabel=Anchor># </span>1.3 RPC æ¡†æ¶</h3></a><a href=#1å‡†å¤‡å·¥ä½œ><h4 id=1å‡†å¤‡å·¥ä½œ><span class=hanchor arialabel=Anchor># </span>1ï¼‰å‡†å¤‡å·¥ä½œ</h4></a><p>è¿™äº›ä»£ç å¯ä»¥è®¤ä¸ºæ˜¯ç°æˆçš„ï¼Œæ— éœ€ä»å¤´ç¼–å†™ç»ƒä¹ </p><p>ä¸ºäº†ç®€åŒ–èµ·è§ï¼Œåœ¨åŸæ¥èŠå¤©é¡¹ç›®çš„åŸºç¡€ä¸Šæ–°å¢ Rpc è¯·æ±‚å’Œå“åº”æ¶ˆæ¯</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-15-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-1> 1</a>
</span><span class=lnt id=hl-15-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-2> 2</a>
</span><span class=lnt id=hl-15-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-3> 3</a>
</span><span class=lnt id=hl-15-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-4> 4</a>
</span><span class=lnt id=hl-15-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-5> 5</a>
</span><span class=lnt id=hl-15-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-6> 6</a>
</span><span class=lnt id=hl-15-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-7> 7</a>
</span><span class=lnt id=hl-15-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-8> 8</a>
</span><span class=lnt id=hl-15-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-9> 9</a>
</span><span class=lnt id=hl-15-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-10>10</a>
</span><span class=lnt id=hl-15-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-11>11</a>
</span><span class=lnt id=hl-15-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-12>12</a>
</span><span class=lnt id=hl-15-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-13>13</a>
</span><span class=lnt id=hl-15-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-14>14</a>
</span><span class=lnt id=hl-15-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-15>15</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Data</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>abstract</span> <span class=kd>class</span> <span class=nc>Message</span> <span class=kd>implements</span> <span class=n>Serializable</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// çœç•¥æ—§çš„ä»£ç 
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>RPC_MESSAGE_TYPE_REQUEST</span> <span class=o>=</span> <span class=n>101</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span>  <span class=n>RPC_MESSAGE_TYPE_RESPONSE</span> <span class=o>=</span> <span class=n>102</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>static</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>messageClasses</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>RPC_MESSAGE_TYPE_REQUEST</span><span class=o>,</span> <span class=n>RpcRequestMessage</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>messageClasses</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>RPC_MESSAGE_TYPE_RESPONSE</span><span class=o>,</span> <span class=n>RpcResponseMessage</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>è¯·æ±‚æ¶ˆæ¯</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-16-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-1> 1</a>
</span><span class=lnt id=hl-16-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-2> 2</a>
</span><span class=lnt id=hl-16-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-3> 3</a>
</span><span class=lnt id=hl-16-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-4> 4</a>
</span><span class=lnt id=hl-16-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-5> 5</a>
</span><span class=lnt id=hl-16-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-6> 6</a>
</span><span class=lnt id=hl-16-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-7> 7</a>
</span><span class=lnt id=hl-16-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-8> 8</a>
</span><span class=lnt id=hl-16-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-9> 9</a>
</span><span class=lnt id=hl-16-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-10>10</a>
</span><span class=lnt id=hl-16-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-11>11</a>
</span><span class=lnt id=hl-16-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-12>12</a>
</span><span class=lnt id=hl-16-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-13>13</a>
</span><span class=lnt id=hl-16-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-14>14</a>
</span><span class=lnt id=hl-16-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-15>15</a>
</span><span class=lnt id=hl-16-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-16>16</a>
</span><span class=lnt id=hl-16-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-17>17</a>
</span><span class=lnt id=hl-16-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-18>18</a>
</span><span class=lnt id=hl-16-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-19>19</a>
</span><span class=lnt id=hl-16-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-20>20</a>
</span><span class=lnt id=hl-16-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-21>21</a>
</span><span class=lnt id=hl-16-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-22>22</a>
</span><span class=lnt id=hl-16-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-23>23</a>
</span><span class=lnt id=hl-16-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-24>24</a>
</span><span class=lnt id=hl-16-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-25>25</a>
</span><span class=lnt id=hl-16-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-26>26</a>
</span><span class=lnt id=hl-16-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-27>27</a>
</span><span class=lnt id=hl-16-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-28>28</a>
</span><span class=lnt id=hl-16-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-29>29</a>
</span><span class=lnt id=hl-16-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-30>30</a>
</span><span class=lnt id=hl-16-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-31>31</a>
</span><span class=lnt id=hl-16-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-32>32</a>
</span><span class=lnt id=hl-16-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-33>33</a>
</span><span class=lnt id=hl-16-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-34>34</a>
</span><span class=lnt id=hl-16-35><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-35>35</a>
</span><span class=lnt id=hl-16-36><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-36>36</a>
</span><span class=lnt id=hl-16-37><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-37>37</a>
</span><span class=lnt id=hl-16-38><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-38>38</a>
</span><span class=lnt id=hl-16-39><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-39>39</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Getter</span>
</span></span><span class=line><span class=cl><span class=nd>@ToString</span><span class=o>(</span><span class=n>callSuper</span> <span class=o>=</span> <span class=kc>true</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>RpcRequestMessage</span> <span class=kd>extends</span> <span class=n>Message</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * è°ƒç”¨çš„æ¥å£å…¨é™å®šåï¼ŒæœåŠ¡ç«¯æ ¹æ®å®ƒæ‰¾åˆ°å®ç°
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>String</span> <span class=n>interfaceName</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * è°ƒç”¨æ¥å£ä¸­çš„æ–¹æ³•å
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>String</span> <span class=n>methodName</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * æ–¹æ³•è¿”å›ç±»å‹
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>returnType</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * æ–¹æ³•å‚æ•°ç±»å‹æ•°ç»„
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>Class</span><span class=o>[]</span> <span class=n>parameterTypes</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * æ–¹æ³•å‚æ•°å€¼æ•°ç»„
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>Object</span><span class=o>[]</span> <span class=n>parameterValue</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=nf>RpcRequestMessage</span><span class=o>(</span><span class=kt>int</span> <span class=n>sequenceId</span><span class=o>,</span> <span class=n>String</span> <span class=n>interfaceName</span><span class=o>,</span> <span class=n>String</span> <span class=n>methodName</span><span class=o>,</span> <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>returnType</span><span class=o>,</span> <span class=n>Class</span><span class=o>[]</span> <span class=n>parameterTypes</span><span class=o>,</span> <span class=n>Object</span><span class=o>[]</span> <span class=n>parameterValue</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>super</span><span class=o>.</span><span class=na>setSequenceId</span><span class=o>(</span><span class=n>sequenceId</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>interfaceName</span> <span class=o>=</span> <span class=n>interfaceName</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>methodName</span> <span class=o>=</span> <span class=n>methodName</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>returnType</span> <span class=o>=</span> <span class=n>returnType</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>parameterTypes</span> <span class=o>=</span> <span class=n>parameterTypes</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>parameterValue</span> <span class=o>=</span> <span class=n>parameterValue</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>int</span> <span class=nf>getMessageType</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>RPC_MESSAGE_TYPE_REQUEST</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å“åº”æ¶ˆæ¯</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-17-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-1> 1</a>
</span><span class=lnt id=hl-17-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-2> 2</a>
</span><span class=lnt id=hl-17-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-3> 3</a>
</span><span class=lnt id=hl-17-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-4> 4</a>
</span><span class=lnt id=hl-17-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-5> 5</a>
</span><span class=lnt id=hl-17-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-6> 6</a>
</span><span class=lnt id=hl-17-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-7> 7</a>
</span><span class=lnt id=hl-17-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-8> 8</a>
</span><span class=lnt id=hl-17-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-9> 9</a>
</span><span class=lnt id=hl-17-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-10>10</a>
</span><span class=lnt id=hl-17-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-11>11</a>
</span><span class=lnt id=hl-17-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-12>12</a>
</span><span class=lnt id=hl-17-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-13>13</a>
</span><span class=lnt id=hl-17-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-14>14</a>
</span><span class=lnt id=hl-17-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-15>15</a>
</span><span class=lnt id=hl-17-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-16>16</a>
</span><span class=lnt id=hl-17-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-17>17</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Data</span>
</span></span><span class=line><span class=cl><span class=nd>@ToString</span><span class=o>(</span><span class=n>callSuper</span> <span class=o>=</span> <span class=kc>true</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>RpcResponseMessage</span> <span class=kd>extends</span> <span class=n>Message</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * è¿”å›å€¼
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>Object</span> <span class=n>returnValue</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * å¼‚å¸¸å€¼
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>Exception</span> <span class=n>exceptionValue</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>int</span> <span class=nf>getMessageType</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>RPC_MESSAGE_TYPE_RESPONSE</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>æœåŠ¡å™¨æ¶å­</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-18-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-1> 1</a>
</span><span class=lnt id=hl-18-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-2> 2</a>
</span><span class=lnt id=hl-18-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-3> 3</a>
</span><span class=lnt id=hl-18-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-4> 4</a>
</span><span class=lnt id=hl-18-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-5> 5</a>
</span><span class=lnt id=hl-18-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-6> 6</a>
</span><span class=lnt id=hl-18-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-7> 7</a>
</span><span class=lnt id=hl-18-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-8> 8</a>
</span><span class=lnt id=hl-18-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-9> 9</a>
</span><span class=lnt id=hl-18-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-10>10</a>
</span><span class=lnt id=hl-18-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-11>11</a>
</span><span class=lnt id=hl-18-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-12>12</a>
</span><span class=lnt id=hl-18-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-13>13</a>
</span><span class=lnt id=hl-18-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-14>14</a>
</span><span class=lnt id=hl-18-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-15>15</a>
</span><span class=lnt id=hl-18-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-16>16</a>
</span><span class=lnt id=hl-18-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-17>17</a>
</span><span class=lnt id=hl-18-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-18>18</a>
</span><span class=lnt id=hl-18-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-19>19</a>
</span><span class=lnt id=hl-18-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-20>20</a>
</span><span class=lnt id=hl-18-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-21>21</a>
</span><span class=lnt id=hl-18-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-22>22</a>
</span><span class=lnt id=hl-18-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-23>23</a>
</span><span class=lnt id=hl-18-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-24>24</a>
</span><span class=lnt id=hl-18-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-25>25</a>
</span><span class=lnt id=hl-18-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-26>26</a>
</span><span class=lnt id=hl-18-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-27>27</a>
</span><span class=lnt id=hl-18-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-28>28</a>
</span><span class=lnt id=hl-18-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-29>29</a>
</span><span class=lnt id=hl-18-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-30>30</a>
</span><span class=lnt id=hl-18-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-31>31</a>
</span><span class=lnt id=hl-18-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-32>32</a>
</span><span class=lnt id=hl-18-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-33>33</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>RpcServer</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>NioEventLoopGroup</span> <span class=n>boss</span> <span class=o>=</span> <span class=k>new</span> <span class=n>NioEventLoopGroup</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>NioEventLoopGroup</span> <span class=n>worker</span> <span class=o>=</span> <span class=k>new</span> <span class=n>NioEventLoopGroup</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>LoggingHandler</span> <span class=n>LOGGING_HANDLER</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LoggingHandler</span><span class=o>(</span><span class=n>LogLevel</span><span class=o>.</span><span class=na>DEBUG</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>MessageCodecSharable</span> <span class=n>MESSAGE_CODEC</span> <span class=o>=</span> <span class=k>new</span> <span class=n>MessageCodecSharable</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1>// rpc è¯·æ±‚æ¶ˆæ¯å¤„ç†å™¨ï¼Œå¾…å®ç°
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>RpcRequestMessageHandler</span> <span class=n>RPC_HANDLER</span> <span class=o>=</span> <span class=k>new</span> <span class=n>RpcRequestMessageHandler</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>ServerBootstrap</span> <span class=n>serverBootstrap</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ServerBootstrap</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>serverBootstrap</span><span class=o>.</span><span class=na>channel</span><span class=o>(</span><span class=n>NioServerSocketChannel</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>serverBootstrap</span><span class=o>.</span><span class=na>group</span><span class=o>(</span><span class=n>boss</span><span class=o>,</span> <span class=n>worker</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>serverBootstrap</span><span class=o>.</span><span class=na>childHandler</span><span class=o>(</span><span class=k>new</span> <span class=n>ChannelInitializer</span><span class=o>&lt;</span><span class=n>SocketChannel</span><span class=o>&gt;()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>                <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>initChannel</span><span class=o>(</span><span class=n>SocketChannel</span> <span class=n>ch</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>ProcotolFrameDecoder</span><span class=o>());</span>
</span></span><span class=line><span class=cl>                    <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=n>LOGGING_HANDLER</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=n>MESSAGE_CODEC</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=n>RPC_HANDLER</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>});</span>
</span></span><span class=line><span class=cl>            <span class=n>Channel</span> <span class=n>channel</span> <span class=o>=</span> <span class=n>serverBootstrap</span><span class=o>.</span><span class=na>bind</span><span class=o>(</span><span class=n>8080</span><span class=o>).</span><span class=na>sync</span><span class=o>().</span><span class=na>channel</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>channel</span><span class=o>.</span><span class=na>closeFuture</span><span class=o>().</span><span class=na>sync</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=o>.</span><span class=na>error</span><span class=o>(</span><span class=s>&#34;server error&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>boss</span><span class=o>.</span><span class=na>shutdownGracefully</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>worker</span><span class=o>.</span><span class=na>shutdownGracefully</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å®¢æˆ·ç«¯æ¶å­</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-19-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-1> 1</a>
</span><span class=lnt id=hl-19-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-2> 2</a>
</span><span class=lnt id=hl-19-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-3> 3</a>
</span><span class=lnt id=hl-19-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-4> 4</a>
</span><span class=lnt id=hl-19-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-5> 5</a>
</span><span class=lnt id=hl-19-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-6> 6</a>
</span><span class=lnt id=hl-19-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-7> 7</a>
</span><span class=lnt id=hl-19-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-8> 8</a>
</span><span class=lnt id=hl-19-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-9> 9</a>
</span><span class=lnt id=hl-19-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-10>10</a>
</span><span class=lnt id=hl-19-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-11>11</a>
</span><span class=lnt id=hl-19-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-12>12</a>
</span><span class=lnt id=hl-19-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-13>13</a>
</span><span class=lnt id=hl-19-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-14>14</a>
</span><span class=lnt id=hl-19-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-15>15</a>
</span><span class=lnt id=hl-19-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-16>16</a>
</span><span class=lnt id=hl-19-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-17>17</a>
</span><span class=lnt id=hl-19-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-18>18</a>
</span><span class=lnt id=hl-19-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-19>19</a>
</span><span class=lnt id=hl-19-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-20>20</a>
</span><span class=lnt id=hl-19-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-21>21</a>
</span><span class=lnt id=hl-19-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-22>22</a>
</span><span class=lnt id=hl-19-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-23>23</a>
</span><span class=lnt id=hl-19-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-24>24</a>
</span><span class=lnt id=hl-19-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-25>25</a>
</span><span class=lnt id=hl-19-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-26>26</a>
</span><span class=lnt id=hl-19-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-27>27</a>
</span><span class=lnt id=hl-19-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-28>28</a>
</span><span class=lnt id=hl-19-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-29>29</a>
</span><span class=lnt id=hl-19-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-30>30</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>RpcClient</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>NioEventLoopGroup</span> <span class=n>group</span> <span class=o>=</span> <span class=k>new</span> <span class=n>NioEventLoopGroup</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>LoggingHandler</span> <span class=n>LOGGING_HANDLER</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LoggingHandler</span><span class=o>(</span><span class=n>LogLevel</span><span class=o>.</span><span class=na>DEBUG</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>MessageCodecSharable</span> <span class=n>MESSAGE_CODEC</span> <span class=o>=</span> <span class=k>new</span> <span class=n>MessageCodecSharable</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1>// rpc å“åº”æ¶ˆæ¯å¤„ç†å™¨ï¼Œå¾…å®ç°
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>RpcResponseMessageHandler</span> <span class=n>RPC_HANDLER</span> <span class=o>=</span> <span class=k>new</span> <span class=n>RpcResponseMessageHandler</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Bootstrap</span> <span class=n>bootstrap</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Bootstrap</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>bootstrap</span><span class=o>.</span><span class=na>channel</span><span class=o>(</span><span class=n>NioSocketChannel</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>bootstrap</span><span class=o>.</span><span class=na>group</span><span class=o>(</span><span class=n>group</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>bootstrap</span><span class=o>.</span><span class=na>handler</span><span class=o>(</span><span class=k>new</span> <span class=n>ChannelInitializer</span><span class=o>&lt;</span><span class=n>SocketChannel</span><span class=o>&gt;()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>                <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>initChannel</span><span class=o>(</span><span class=n>SocketChannel</span> <span class=n>ch</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>ProcotolFrameDecoder</span><span class=o>());</span>
</span></span><span class=line><span class=cl>                    <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=n>LOGGING_HANDLER</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=n>MESSAGE_CODEC</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=n>RPC_HANDLER</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>});</span>
</span></span><span class=line><span class=cl>            <span class=n>Channel</span> <span class=n>channel</span> <span class=o>=</span> <span class=n>bootstrap</span><span class=o>.</span><span class=na>connect</span><span class=o>(</span><span class=s>&#34;localhost&#34;</span><span class=o>,</span> <span class=n>8080</span><span class=o>).</span><span class=na>sync</span><span class=o>().</span><span class=na>channel</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>channel</span><span class=o>.</span><span class=na>closeFuture</span><span class=o>().</span><span class=na>sync</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Exception</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=o>.</span><span class=na>error</span><span class=o>(</span><span class=s>&#34;client error&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>group</span><span class=o>.</span><span class=na>shutdownGracefully</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>æœåŠ¡å™¨ç«¯çš„ service è·å–</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-20-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-20-1> 1</a>
</span><span class=lnt id=hl-20-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-20-2> 2</a>
</span><span class=lnt id=hl-20-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-20-3> 3</a>
</span><span class=lnt id=hl-20-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-20-4> 4</a>
</span><span class=lnt id=hl-20-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-20-5> 5</a>
</span><span class=lnt id=hl-20-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-20-6> 6</a>
</span><span class=lnt id=hl-20-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-20-7> 7</a>
</span><span class=lnt id=hl-20-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-20-8> 8</a>
</span><span class=lnt id=hl-20-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-20-9> 9</a>
</span><span class=lnt id=hl-20-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-20-10>10</a>
</span><span class=lnt id=hl-20-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-20-11>11</a>
</span><span class=lnt id=hl-20-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-20-12>12</a>
</span><span class=lnt id=hl-20-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-20-13>13</a>
</span><span class=lnt id=hl-20-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-20-14>14</a>
</span><span class=lnt id=hl-20-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-20-15>15</a>
</span><span class=lnt id=hl-20-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-20-16>16</a>
</span><span class=lnt id=hl-20-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-20-17>17</a>
</span><span class=lnt id=hl-20-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-20-18>18</a>
</span><span class=lnt id=hl-20-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-20-19>19</a>
</span><span class=lnt id=hl-20-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-20-20>20</a>
</span><span class=lnt id=hl-20-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-20-21>21</a>
</span><span class=lnt id=hl-20-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-20-22>22</a>
</span><span class=lnt id=hl-20-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-20-23>23</a>
</span><span class=lnt id=hl-20-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-20-24>24</a>
</span><span class=lnt id=hl-20-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-20-25>25</a>
</span><span class=lnt id=hl-20-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-20-26>26</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>ServicesFactory</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>static</span> <span class=n>Properties</span> <span class=n>properties</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>static</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;?&gt;,</span> <span class=n>Object</span><span class=o>&gt;</span> <span class=n>map</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ConcurrentHashMap</span><span class=o>&lt;&gt;();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>static</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>(</span><span class=n>InputStream</span> <span class=n>in</span> <span class=o>=</span> <span class=n>Config</span><span class=o>.</span><span class=na>class</span><span class=o>.</span><span class=na>getResourceAsStream</span><span class=o>(</span><span class=s>&#34;/application.properties&#34;</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>properties</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Properties</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>properties</span><span class=o>.</span><span class=na>load</span><span class=o>(</span><span class=n>in</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>Set</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>names</span> <span class=o>=</span> <span class=n>properties</span><span class=o>.</span><span class=na>stringPropertyNames</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=o>(</span><span class=n>String</span> <span class=n>name</span> <span class=o>:</span> <span class=n>names</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>name</span><span class=o>.</span><span class=na>endsWith</span><span class=o>(</span><span class=s>&#34;Service&#34;</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>interfaceClass</span> <span class=o>=</span> <span class=n>Class</span><span class=o>.</span><span class=na>forName</span><span class=o>(</span><span class=n>name</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>instanceClass</span> <span class=o>=</span> <span class=n>Class</span><span class=o>.</span><span class=na>forName</span><span class=o>(</span><span class=n>properties</span><span class=o>.</span><span class=na>getProperty</span><span class=o>(</span><span class=n>name</span><span class=o>));</span>
</span></span><span class=line><span class=cl>                    <span class=n>map</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>interfaceClass</span><span class=o>,</span> <span class=n>instanceClass</span><span class=o>.</span><span class=na>newInstance</span><span class=o>());</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=o>|</span> <span class=n>ClassNotFoundException</span> <span class=o>|</span> <span class=n>InstantiationException</span> <span class=o>|</span> <span class=n>IllegalAccessException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>ExceptionInInitializerError</span><span class=o>(</span><span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>T</span> <span class=nf>getService</span><span class=o>(</span><span class=n>Class</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>interfaceClass</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=o>(</span><span class=n>T</span><span class=o>)</span> <span class=n>map</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>interfaceClass</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>ç›¸å…³é…ç½® application.properties</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-21-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-21-1>1</a>
</span><span class=lnt id=hl-21-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-21-2>2</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>serializer.algorithm=Json
</span></span><span class=line><span class=cl>cn.itcast.server.service.HelloService=cn.itcast.server.service.HelloServiceImpl
</span></span></code></pre></td></tr></table></div></div><a href=#2æœåŠ¡å™¨-handler><h4 id=2æœåŠ¡å™¨-handler><span class=hanchor arialabel=Anchor># </span>2ï¼‰æœåŠ¡å™¨ handler</h4></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-22-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-22-1> 1</a>
</span><span class=lnt id=hl-22-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-22-2> 2</a>
</span><span class=lnt id=hl-22-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-22-3> 3</a>
</span><span class=lnt id=hl-22-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-22-4> 4</a>
</span><span class=lnt id=hl-22-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-22-5> 5</a>
</span><span class=lnt id=hl-22-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-22-6> 6</a>
</span><span class=lnt id=hl-22-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-22-7> 7</a>
</span><span class=lnt id=hl-22-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-22-8> 8</a>
</span><span class=lnt id=hl-22-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-22-9> 9</a>
</span><span class=lnt id=hl-22-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-22-10>10</a>
</span><span class=lnt id=hl-22-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-22-11>11</a>
</span><span class=lnt id=hl-22-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-22-12>12</a>
</span><span class=lnt id=hl-22-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-22-13>13</a>
</span><span class=lnt id=hl-22-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-22-14>14</a>
</span><span class=lnt id=hl-22-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-22-15>15</a>
</span><span class=lnt id=hl-22-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-22-16>16</a>
</span><span class=lnt id=hl-22-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-22-17>17</a>
</span><span class=lnt id=hl-22-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-22-18>18</a>
</span><span class=lnt id=hl-22-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-22-19>19</a>
</span><span class=lnt id=hl-22-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-22-20>20</a>
</span><span class=lnt id=hl-22-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-22-21>21</a>
</span><span class=lnt id=hl-22-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-22-22>22</a>
</span><span class=lnt id=hl-22-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-22-23>23</a>
</span><span class=lnt id=hl-22-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-22-24>24</a>
</span><span class=lnt id=hl-22-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-22-25>25</a>
</span><span class=lnt id=hl-22-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-22-26>26</a>
</span><span class=lnt id=hl-22-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-22-27>27</a>
</span><span class=lnt id=hl-22-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-22-28>28</a>
</span><span class=lnt id=hl-22-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-22-29>29</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span>
</span></span><span class=line><span class=cl><span class=nd>@ChannelHandler.Sharable</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>RpcRequestMessageHandler</span> <span class=kd>extends</span> <span class=n>SimpleChannelInboundHandler</span><span class=o>&lt;</span><span class=n>RpcRequestMessage</span><span class=o>&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>channelRead0</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>,</span> <span class=n>RpcRequestMessage</span> <span class=n>message</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>RpcResponseMessage</span> <span class=n>response</span> <span class=o>=</span> <span class=k>new</span> <span class=n>RpcResponseMessage</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span><span class=o>.</span><span class=na>setSequenceId</span><span class=o>(</span><span class=n>message</span><span class=o>.</span><span class=na>getSequenceId</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// è·å–çœŸæ­£çš„å®ç°å¯¹è±¡
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>HelloService</span> <span class=n>service</span> <span class=o>=</span> <span class=o>(</span><span class=n>HelloService</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                    <span class=n>ServicesFactory</span><span class=o>.</span><span class=na>getService</span><span class=o>(</span><span class=n>Class</span><span class=o>.</span><span class=na>forName</span><span class=o>(</span><span class=n>message</span><span class=o>.</span><span class=na>getInterfaceName</span><span class=o>()));</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1>// è·å–è¦è°ƒç”¨çš„æ–¹æ³•
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>Method</span> <span class=n>method</span> <span class=o>=</span> <span class=n>service</span><span class=o>.</span><span class=na>getClass</span><span class=o>().</span><span class=na>getMethod</span><span class=o>(</span><span class=n>message</span><span class=o>.</span><span class=na>getMethodName</span><span class=o>(),</span> <span class=n>message</span><span class=o>.</span><span class=na>getParameterTypes</span><span class=o>());</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1>// è°ƒç”¨æ–¹æ³•
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>Object</span> <span class=n>invoke</span> <span class=o>=</span> <span class=n>method</span><span class=o>.</span><span class=na>invoke</span><span class=o>(</span><span class=n>service</span><span class=o>,</span> <span class=n>message</span><span class=o>.</span><span class=na>getParameterValue</span><span class=o>());</span>
</span></span><span class=line><span class=cl>            <span class=c1>// è°ƒç”¨æˆåŠŸ
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>response</span><span class=o>.</span><span class=na>setReturnValue</span><span class=o>(</span><span class=n>invoke</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Exception</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=c1>// è°ƒç”¨å¼‚å¸¸
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>response</span><span class=o>.</span><span class=na>setExceptionValue</span><span class=o>(</span><span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>// è¿”å›ç»“æœ
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>ctx</span><span class=o>.</span><span class=na>writeAndFlush</span><span class=o>(</span><span class=n>response</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#3å®¢æˆ·ç«¯ä»£ç ç¬¬ä¸€ç‰ˆ><h4 id=3å®¢æˆ·ç«¯ä»£ç ç¬¬ä¸€ç‰ˆ><span class=hanchor arialabel=Anchor># </span>3ï¼‰å®¢æˆ·ç«¯ä»£ç ç¬¬ä¸€ç‰ˆ</h4></a><p>åªå‘æ¶ˆæ¯</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-23-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-1> 1</a>
</span><span class=lnt id=hl-23-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-2> 2</a>
</span><span class=lnt id=hl-23-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-3> 3</a>
</span><span class=lnt id=hl-23-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-4> 4</a>
</span><span class=lnt id=hl-23-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-5> 5</a>
</span><span class=lnt id=hl-23-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-6> 6</a>
</span><span class=lnt id=hl-23-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-7> 7</a>
</span><span class=lnt id=hl-23-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-8> 8</a>
</span><span class=lnt id=hl-23-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-9> 9</a>
</span><span class=lnt id=hl-23-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-10>10</a>
</span><span class=lnt id=hl-23-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-11>11</a>
</span><span class=lnt id=hl-23-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-12>12</a>
</span><span class=lnt id=hl-23-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-13>13</a>
</span><span class=lnt id=hl-23-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-14>14</a>
</span><span class=lnt id=hl-23-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-15>15</a>
</span><span class=lnt id=hl-23-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-16>16</a>
</span><span class=lnt id=hl-23-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-17>17</a>
</span><span class=lnt id=hl-23-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-18>18</a>
</span><span class=lnt id=hl-23-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-19>19</a>
</span><span class=lnt id=hl-23-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-20>20</a>
</span><span class=lnt id=hl-23-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-21>21</a>
</span><span class=lnt id=hl-23-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-22>22</a>
</span><span class=lnt id=hl-23-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-23>23</a>
</span><span class=lnt id=hl-23-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-24>24</a>
</span><span class=lnt id=hl-23-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-25>25</a>
</span><span class=lnt id=hl-23-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-26>26</a>
</span><span class=lnt id=hl-23-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-27>27</a>
</span><span class=lnt id=hl-23-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-28>28</a>
</span><span class=lnt id=hl-23-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-29>29</a>
</span><span class=lnt id=hl-23-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-30>30</a>
</span><span class=lnt id=hl-23-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-31>31</a>
</span><span class=lnt id=hl-23-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-32>32</a>
</span><span class=lnt id=hl-23-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-33>33</a>
</span><span class=lnt id=hl-23-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-34>34</a>
</span><span class=lnt id=hl-23-35><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-35>35</a>
</span><span class=lnt id=hl-23-36><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-36>36</a>
</span><span class=lnt id=hl-23-37><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-37>37</a>
</span><span class=lnt id=hl-23-38><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-38>38</a>
</span><span class=lnt id=hl-23-39><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-39>39</a>
</span><span class=lnt id=hl-23-40><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-40>40</a>
</span><span class=lnt id=hl-23-41><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-41>41</a>
</span><span class=lnt id=hl-23-42><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-42>42</a>
</span><span class=lnt id=hl-23-43><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-43>43</a>
</span><span class=lnt id=hl-23-44><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-44>44</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>RpcClient</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>NioEventLoopGroup</span> <span class=n>group</span> <span class=o>=</span> <span class=k>new</span> <span class=n>NioEventLoopGroup</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>LoggingHandler</span> <span class=n>LOGGING_HANDLER</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LoggingHandler</span><span class=o>(</span><span class=n>LogLevel</span><span class=o>.</span><span class=na>DEBUG</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>MessageCodecSharable</span> <span class=n>MESSAGE_CODEC</span> <span class=o>=</span> <span class=k>new</span> <span class=n>MessageCodecSharable</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>RpcResponseMessageHandler</span> <span class=n>RPC_HANDLER</span> <span class=o>=</span> <span class=k>new</span> <span class=n>RpcResponseMessageHandler</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Bootstrap</span> <span class=n>bootstrap</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Bootstrap</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>bootstrap</span><span class=o>.</span><span class=na>channel</span><span class=o>(</span><span class=n>NioSocketChannel</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>bootstrap</span><span class=o>.</span><span class=na>group</span><span class=o>(</span><span class=n>group</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>bootstrap</span><span class=o>.</span><span class=na>handler</span><span class=o>(</span><span class=k>new</span> <span class=n>ChannelInitializer</span><span class=o>&lt;</span><span class=n>SocketChannel</span><span class=o>&gt;()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>                <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>initChannel</span><span class=o>(</span><span class=n>SocketChannel</span> <span class=n>ch</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>ProcotolFrameDecoder</span><span class=o>());</span>
</span></span><span class=line><span class=cl>                    <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=n>LOGGING_HANDLER</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=n>MESSAGE_CODEC</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=n>RPC_HANDLER</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>});</span>
</span></span><span class=line><span class=cl>            <span class=n>Channel</span> <span class=n>channel</span> <span class=o>=</span> <span class=n>bootstrap</span><span class=o>.</span><span class=na>connect</span><span class=o>(</span><span class=s>&#34;localhost&#34;</span><span class=o>,</span> <span class=n>8080</span><span class=o>).</span><span class=na>sync</span><span class=o>().</span><span class=na>channel</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>ChannelFuture</span> <span class=n>future</span> <span class=o>=</span> <span class=n>channel</span><span class=o>.</span><span class=na>writeAndFlush</span><span class=o>(</span><span class=k>new</span> <span class=n>RpcRequestMessage</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                    <span class=n>1</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                    <span class=s>&#34;cn.itcast.server.service.HelloService&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                    <span class=s>&#34;sayHello&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>String</span><span class=o>.</span><span class=na>class</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                    <span class=k>new</span> <span class=n>Class</span><span class=o>[]{</span><span class=n>String</span><span class=o>.</span><span class=na>class</span><span class=o>},</span>
</span></span><span class=line><span class=cl>                    <span class=k>new</span> <span class=n>Object</span><span class=o>[]{</span><span class=s>&#34;å¼ ä¸‰&#34;</span><span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>)).</span><span class=na>addListener</span><span class=o>(</span><span class=n>promise</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(!</span><span class=n>promise</span><span class=o>.</span><span class=na>isSuccess</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>Throwable</span> <span class=n>cause</span> <span class=o>=</span> <span class=n>promise</span><span class=o>.</span><span class=na>cause</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                    <span class=n>log</span><span class=o>.</span><span class=na>error</span><span class=o>(</span><span class=s>&#34;error&#34;</span><span class=o>,</span> <span class=n>cause</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>channel</span><span class=o>.</span><span class=na>closeFuture</span><span class=o>().</span><span class=na>sync</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Exception</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=o>.</span><span class=na>error</span><span class=o>(</span><span class=s>&#34;client error&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>group</span><span class=o>.</span><span class=na>shutdownGracefully</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#4å®¢æˆ·ç«¯-handler-ç¬¬ä¸€ç‰ˆ><h4 id=4å®¢æˆ·ç«¯-handler-ç¬¬ä¸€ç‰ˆ><span class=hanchor arialabel=Anchor># </span>4ï¼‰å®¢æˆ·ç«¯ handler ç¬¬ä¸€ç‰ˆ</h4></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-24-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-1>1</a>
</span><span class=lnt id=hl-24-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-2>2</a>
</span><span class=lnt id=hl-24-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-3>3</a>
</span><span class=lnt id=hl-24-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-4>4</a>
</span><span class=lnt id=hl-24-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-5>5</a>
</span><span class=lnt id=hl-24-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-6>6</a>
</span><span class=lnt id=hl-24-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-7>7</a>
</span><span class=lnt id=hl-24-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-8>8</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span>
</span></span><span class=line><span class=cl><span class=nd>@ChannelHandler.Sharable</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>RpcResponseMessageHandler</span> <span class=kd>extends</span> <span class=n>SimpleChannelInboundHandler</span><span class=o>&lt;</span><span class=n>RpcResponseMessage</span><span class=o>&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>channelRead0</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>,</span> <span class=n>RpcResponseMessage</span> <span class=n>msg</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;{}&#34;</span><span class=o>,</span> <span class=n>msg</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#5å®¢æˆ·ç«¯ä»£ç -ç¬¬äºŒç‰ˆ><h4 id=5å®¢æˆ·ç«¯ä»£ç -ç¬¬äºŒç‰ˆ><span class=hanchor arialabel=Anchor># </span>5ï¼‰å®¢æˆ·ç«¯ä»£ç  ç¬¬äºŒç‰ˆ</h4></a><p>åŒ…æ‹¬ channel ç®¡ç†ï¼Œä»£ç†ï¼Œæ¥æ”¶ç»“æœ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-25-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-1> 1</a>
</span><span class=lnt id=hl-25-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-2> 2</a>
</span><span class=lnt id=hl-25-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-3> 3</a>
</span><span class=lnt id=hl-25-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-4> 4</a>
</span><span class=lnt id=hl-25-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-5> 5</a>
</span><span class=lnt id=hl-25-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-6> 6</a>
</span><span class=lnt id=hl-25-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-7> 7</a>
</span><span class=lnt id=hl-25-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-8> 8</a>
</span><span class=lnt id=hl-25-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-9> 9</a>
</span><span class=lnt id=hl-25-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-10>10</a>
</span><span class=lnt id=hl-25-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-11>11</a>
</span><span class=lnt id=hl-25-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-12>12</a>
</span><span class=lnt id=hl-25-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-13>13</a>
</span><span class=lnt id=hl-25-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-14>14</a>
</span><span class=lnt id=hl-25-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-15>15</a>
</span><span class=lnt id=hl-25-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-16>16</a>
</span><span class=lnt id=hl-25-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-17>17</a>
</span><span class=lnt id=hl-25-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-18>18</a>
</span><span class=lnt id=hl-25-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-19>19</a>
</span><span class=lnt id=hl-25-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-20>20</a>
</span><span class=lnt id=hl-25-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-21>21</a>
</span><span class=lnt id=hl-25-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-22>22</a>
</span><span class=lnt id=hl-25-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-23>23</a>
</span><span class=lnt id=hl-25-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-24>24</a>
</span><span class=lnt id=hl-25-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-25>25</a>
</span><span class=lnt id=hl-25-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-26>26</a>
</span><span class=lnt id=hl-25-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-27>27</a>
</span><span class=lnt id=hl-25-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-28>28</a>
</span><span class=lnt id=hl-25-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-29>29</a>
</span><span class=lnt id=hl-25-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-30>30</a>
</span><span class=lnt id=hl-25-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-31>31</a>
</span><span class=lnt id=hl-25-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-32>32</a>
</span><span class=lnt id=hl-25-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-33>33</a>
</span><span class=lnt id=hl-25-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-34>34</a>
</span><span class=lnt id=hl-25-35><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-35>35</a>
</span><span class=lnt id=hl-25-36><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-36>36</a>
</span><span class=lnt id=hl-25-37><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-37>37</a>
</span><span class=lnt id=hl-25-38><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-38>38</a>
</span><span class=lnt id=hl-25-39><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-39>39</a>
</span><span class=lnt id=hl-25-40><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-40>40</a>
</span><span class=lnt id=hl-25-41><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-41>41</a>
</span><span class=lnt id=hl-25-42><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-42>42</a>
</span><span class=lnt id=hl-25-43><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-43>43</a>
</span><span class=lnt id=hl-25-44><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-44>44</a>
</span><span class=lnt id=hl-25-45><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-45>45</a>
</span><span class=lnt id=hl-25-46><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-46>46</a>
</span><span class=lnt id=hl-25-47><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-47>47</a>
</span><span class=lnt id=hl-25-48><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-48>48</a>
</span><span class=lnt id=hl-25-49><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-49>49</a>
</span><span class=lnt id=hl-25-50><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-50>50</a>
</span><span class=lnt id=hl-25-51><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-51>51</a>
</span><span class=lnt id=hl-25-52><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-52>52</a>
</span><span class=lnt id=hl-25-53><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-53>53</a>
</span><span class=lnt id=hl-25-54><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-54>54</a>
</span><span class=lnt id=hl-25-55><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-55>55</a>
</span><span class=lnt id=hl-25-56><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-56>56</a>
</span><span class=lnt id=hl-25-57><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-57>57</a>
</span><span class=lnt id=hl-25-58><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-58>58</a>
</span><span class=lnt id=hl-25-59><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-59>59</a>
</span><span class=lnt id=hl-25-60><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-60>60</a>
</span><span class=lnt id=hl-25-61><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-61>61</a>
</span><span class=lnt id=hl-25-62><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-62>62</a>
</span><span class=lnt id=hl-25-63><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-63>63</a>
</span><span class=lnt id=hl-25-64><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-64>64</a>
</span><span class=lnt id=hl-25-65><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-65>65</a>
</span><span class=lnt id=hl-25-66><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-66>66</a>
</span><span class=lnt id=hl-25-67><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-67>67</a>
</span><span class=lnt id=hl-25-68><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-68>68</a>
</span><span class=lnt id=hl-25-69><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-69>69</a>
</span><span class=lnt id=hl-25-70><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-70>70</a>
</span><span class=lnt id=hl-25-71><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-71>71</a>
</span><span class=lnt id=hl-25-72><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-72>72</a>
</span><span class=lnt id=hl-25-73><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-73>73</a>
</span><span class=lnt id=hl-25-74><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-74>74</a>
</span><span class=lnt id=hl-25-75><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-75>75</a>
</span><span class=lnt id=hl-25-76><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-76>76</a>
</span><span class=lnt id=hl-25-77><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-77>77</a>
</span><span class=lnt id=hl-25-78><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-78>78</a>
</span><span class=lnt id=hl-25-79><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-79>79</a>
</span><span class=lnt id=hl-25-80><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-80>80</a>
</span><span class=lnt id=hl-25-81><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-81>81</a>
</span><span class=lnt id=hl-25-82><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-82>82</a>
</span><span class=lnt id=hl-25-83><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-83>83</a>
</span><span class=lnt id=hl-25-84><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-84>84</a>
</span><span class=lnt id=hl-25-85><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-85>85</a>
</span><span class=lnt id=hl-25-86><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-86>86</a>
</span><span class=lnt id=hl-25-87><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-87>87</a>
</span><span class=lnt id=hl-25-88><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-88>88</a>
</span><span class=lnt id=hl-25-89><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-89>89</a>
</span><span class=lnt id=hl-25-90><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-90>90</a>
</span><span class=lnt id=hl-25-91><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-91>91</a>
</span><span class=lnt id=hl-25-92><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-92>92</a>
</span><span class=lnt id=hl-25-93><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-93>93</a>
</span><span class=lnt id=hl-25-94><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-94>94</a>
</span><span class=lnt id=hl-25-95><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-95>95</a>
</span><span class=lnt id=hl-25-96><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-96>96</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>RpcClientManager</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>HelloService</span> <span class=n>service</span> <span class=o>=</span> <span class=n>getProxyService</span><span class=o>(</span><span class=n>HelloService</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>service</span><span class=o>.</span><span class=na>sayHello</span><span class=o>(</span><span class=s>&#34;zhangsan&#34;</span><span class=o>));</span>
</span></span><span class=line><span class=cl><span class=c1>//        System.out.println(service.sayHello(&#34;lisi&#34;));
</span></span></span><span class=line><span class=cl><span class=c1>//        System.out.println(service.sayHello(&#34;wangwu&#34;));
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// åˆ›å»ºä»£ç†ç±»
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>public</span> <span class=kd>static</span> <span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>T</span> <span class=nf>getProxyService</span><span class=o>(</span><span class=n>Class</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>serviceClass</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ClassLoader</span> <span class=n>loader</span> <span class=o>=</span> <span class=n>serviceClass</span><span class=o>.</span><span class=na>getClassLoader</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>Class</span><span class=o>&lt;?&gt;[]</span> <span class=n>interfaces</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Class</span><span class=o>[]{</span><span class=n>serviceClass</span><span class=o>};</span>
</span></span><span class=line><span class=cl>        <span class=c1>//                                                            sayHello  &#34;å¼ ä¸‰&#34;
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>Object</span> <span class=n>o</span> <span class=o>=</span> <span class=n>Proxy</span><span class=o>.</span><span class=na>newProxyInstance</span><span class=o>(</span><span class=n>loader</span><span class=o>,</span> <span class=n>interfaces</span><span class=o>,</span> <span class=o>(</span><span class=n>proxy</span><span class=o>,</span> <span class=n>method</span><span class=o>,</span> <span class=n>args</span><span class=o>)</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 1. å°†æ–¹æ³•è°ƒç”¨è½¬æ¢ä¸º æ¶ˆæ¯å¯¹è±¡
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=kt>int</span> <span class=n>sequenceId</span> <span class=o>=</span> <span class=n>SequenceIdGenerator</span><span class=o>.</span><span class=na>nextId</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>RpcRequestMessage</span> <span class=n>msg</span> <span class=o>=</span> <span class=k>new</span> <span class=n>RpcRequestMessage</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                    <span class=n>sequenceId</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>serviceClass</span><span class=o>.</span><span class=na>getName</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>                    <span class=n>method</span><span class=o>.</span><span class=na>getName</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>                    <span class=n>method</span><span class=o>.</span><span class=na>getReturnType</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>                    <span class=n>method</span><span class=o>.</span><span class=na>getParameterTypes</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>                    <span class=n>args</span>
</span></span><span class=line><span class=cl>            <span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 2. å°†æ¶ˆæ¯å¯¹è±¡å‘é€å‡ºå»
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>getChannel</span><span class=o>().</span><span class=na>writeAndFlush</span><span class=o>(</span><span class=n>msg</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1>// 3. å‡†å¤‡ä¸€ä¸ªç©º Promise å¯¹è±¡ï¼Œæ¥æ¥æ”¶ç»“æœ             æŒ‡å®š promise å¯¹è±¡å¼‚æ­¥æ¥æ”¶ç»“æœçº¿ç¨‹
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>DefaultPromise</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span> <span class=n>promise</span> <span class=o>=</span> <span class=k>new</span> <span class=n>DefaultPromise</span><span class=o>&lt;&gt;(</span><span class=n>getChannel</span><span class=o>().</span><span class=na>eventLoop</span><span class=o>());</span>
</span></span><span class=line><span class=cl>            <span class=n>RpcResponseMessageHandler</span><span class=o>.</span><span class=na>PROMISES</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>sequenceId</span><span class=o>,</span> <span class=n>promise</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//            promise.addListener(future -&gt; {
</span></span></span><span class=line><span class=cl><span class=c1>//                // çº¿ç¨‹
</span></span></span><span class=line><span class=cl><span class=c1>//            });
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>            <span class=c1>// 4. ç­‰å¾… promise ç»“æœ
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>promise</span><span class=o>.</span><span class=na>await</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span><span class=o>(</span><span class=n>promise</span><span class=o>.</span><span class=na>isSuccess</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// è°ƒç”¨æ­£å¸¸
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=k>return</span> <span class=n>promise</span><span class=o>.</span><span class=na>getNow</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// è°ƒç”¨å¤±è´¥
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=k>throw</span> <span class=k>new</span> <span class=n>RuntimeException</span><span class=o>(</span><span class=n>promise</span><span class=o>.</span><span class=na>cause</span><span class=o>());</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>});</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=o>(</span><span class=n>T</span><span class=o>)</span> <span class=n>o</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=n>Channel</span> <span class=n>channel</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>Object</span> <span class=n>LOCK</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Object</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// è·å–å”¯ä¸€çš„ channel å¯¹è±¡
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>public</span> <span class=kd>static</span> <span class=n>Channel</span> <span class=nf>getChannel</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>channel</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>channel</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=kd>synchronized</span> <span class=o>(</span><span class=n>LOCK</span><span class=o>)</span> <span class=o>{</span> <span class=c1>//  t2
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>if</span> <span class=o>(</span><span class=n>channel</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span> <span class=c1>// t1
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=k>return</span> <span class=n>channel</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=n>initChannel</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>channel</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// åˆå§‹åŒ– channel æ–¹æ³•
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>private</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>initChannel</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>NioEventLoopGroup</span> <span class=n>group</span> <span class=o>=</span> <span class=k>new</span> <span class=n>NioEventLoopGroup</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>LoggingHandler</span> <span class=n>LOGGING_HANDLER</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LoggingHandler</span><span class=o>(</span><span class=n>LogLevel</span><span class=o>.</span><span class=na>DEBUG</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>MessageCodecSharable</span> <span class=n>MESSAGE_CODEC</span> <span class=o>=</span> <span class=k>new</span> <span class=n>MessageCodecSharable</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>RpcResponseMessageHandler</span> <span class=n>RPC_HANDLER</span> <span class=o>=</span> <span class=k>new</span> <span class=n>RpcResponseMessageHandler</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>Bootstrap</span> <span class=n>bootstrap</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Bootstrap</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>bootstrap</span><span class=o>.</span><span class=na>channel</span><span class=o>(</span><span class=n>NioSocketChannel</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>bootstrap</span><span class=o>.</span><span class=na>group</span><span class=o>(</span><span class=n>group</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>bootstrap</span><span class=o>.</span><span class=na>handler</span><span class=o>(</span><span class=k>new</span> <span class=n>ChannelInitializer</span><span class=o>&lt;</span><span class=n>SocketChannel</span><span class=o>&gt;()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>            <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>initChannel</span><span class=o>(</span><span class=n>SocketChannel</span> <span class=n>ch</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>ProcotolFrameDecoder</span><span class=o>());</span>
</span></span><span class=line><span class=cl>                <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=n>LOGGING_HANDLER</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=n>MESSAGE_CODEC</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=n>RPC_HANDLER</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>});</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>channel</span> <span class=o>=</span> <span class=n>bootstrap</span><span class=o>.</span><span class=na>connect</span><span class=o>(</span><span class=s>&#34;localhost&#34;</span><span class=o>,</span> <span class=n>8080</span><span class=o>).</span><span class=na>sync</span><span class=o>().</span><span class=na>channel</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>channel</span><span class=o>.</span><span class=na>closeFuture</span><span class=o>().</span><span class=na>addListener</span><span class=o>(</span><span class=n>future</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>group</span><span class=o>.</span><span class=na>shutdownGracefully</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>});</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Exception</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=o>.</span><span class=na>error</span><span class=o>(</span><span class=s>&#34;client error&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#6å®¢æˆ·ç«¯-handler-ç¬¬äºŒç‰ˆ><h4 id=6å®¢æˆ·ç«¯-handler-ç¬¬äºŒç‰ˆ><span class=hanchor arialabel=Anchor># </span>6ï¼‰å®¢æˆ·ç«¯ handler ç¬¬äºŒç‰ˆ</h4></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-26-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-1> 1</a>
</span><span class=lnt id=hl-26-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-2> 2</a>
</span><span class=lnt id=hl-26-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-3> 3</a>
</span><span class=lnt id=hl-26-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-4> 4</a>
</span><span class=lnt id=hl-26-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-5> 5</a>
</span><span class=lnt id=hl-26-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-6> 6</a>
</span><span class=lnt id=hl-26-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-7> 7</a>
</span><span class=lnt id=hl-26-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-8> 8</a>
</span><span class=lnt id=hl-26-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-9> 9</a>
</span><span class=lnt id=hl-26-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-10>10</a>
</span><span class=lnt id=hl-26-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-11>11</a>
</span><span class=lnt id=hl-26-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-12>12</a>
</span><span class=lnt id=hl-26-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-13>13</a>
</span><span class=lnt id=hl-26-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-14>14</a>
</span><span class=lnt id=hl-26-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-15>15</a>
</span><span class=lnt id=hl-26-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-16>16</a>
</span><span class=lnt id=hl-26-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-17>17</a>
</span><span class=lnt id=hl-26-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-18>18</a>
</span><span class=lnt id=hl-26-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-19>19</a>
</span><span class=lnt id=hl-26-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-20>20</a>
</span><span class=lnt id=hl-26-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-21>21</a>
</span><span class=lnt id=hl-26-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-22>22</a>
</span><span class=lnt id=hl-26-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-23>23</a>
</span><span class=lnt id=hl-26-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-24>24</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span>
</span></span><span class=line><span class=cl><span class=nd>@ChannelHandler.Sharable</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>RpcResponseMessageHandler</span> <span class=kd>extends</span> <span class=n>SimpleChannelInboundHandler</span><span class=o>&lt;</span><span class=n>RpcResponseMessage</span><span class=o>&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//                       åºå·      ç”¨æ¥æ¥æ”¶ç»“æœçš„ promise å¯¹è±¡
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>,</span> <span class=n>Promise</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;&gt;</span> <span class=n>PROMISES</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ConcurrentHashMap</span><span class=o>&lt;&gt;();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>channelRead0</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>,</span> <span class=n>RpcResponseMessage</span> <span class=n>msg</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;{}&#34;</span><span class=o>,</span> <span class=n>msg</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// æ‹¿åˆ°ç©ºçš„ promise
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>Promise</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span> <span class=n>promise</span> <span class=o>=</span> <span class=n>PROMISES</span><span class=o>.</span><span class=na>remove</span><span class=o>(</span><span class=n>msg</span><span class=o>.</span><span class=na>getSequenceId</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>promise</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Object</span> <span class=n>returnValue</span> <span class=o>=</span> <span class=n>msg</span><span class=o>.</span><span class=na>getReturnValue</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>Exception</span> <span class=n>exceptionValue</span> <span class=o>=</span> <span class=n>msg</span><span class=o>.</span><span class=na>getExceptionValue</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span><span class=o>(</span><span class=n>exceptionValue</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>promise</span><span class=o>.</span><span class=na>setFailure</span><span class=o>(</span><span class=n>exceptionValue</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>promise</span><span class=o>.</span><span class=na>setSuccess</span><span class=o>(</span><span class=n>returnValue</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p><img src="/z-oblib/z2-attachments/Pasted image 20220624192123.png" width=auto></p><a href=#2-æºç åˆ†æ><h2 id=2-æºç åˆ†æ><span class=hanchor arialabel=Anchor># </span>2. æºç åˆ†æ</h2></a><a href=#21-å¯åŠ¨å‰–æ><h3 id=21-å¯åŠ¨å‰–æ><span class=hanchor arialabel=Anchor># </span>2.1 å¯åŠ¨å‰–æ</h3></a><p>ä¸»è¦æ­¥éª¤ï¼š</p><ol><li>æ‰“å¼€select</li><li>æ‰“å¼€ssc</li><li>channelç»‘å®šåˆ°selectä¸Š</li><li>é€šè¿‡selectionKeyå…³æ³¨acceptäº‹ä»¶</li></ol><p><img src="/z-oblib/z2-attachments/Pasted image 20220624213014.png" width=auto></p><p>æˆ‘ä»¬å°±æ¥çœ‹çœ‹ netty ä¸­å¯¹ä¸‹é¢çš„ä»£ç æ˜¯æ€æ ·è¿›è¡Œå¤„ç†çš„</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-27-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-27-1> 1</a>
</span><span class=lnt id=hl-27-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-27-2> 2</a>
</span><span class=lnt id=hl-27-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-27-3> 3</a>
</span><span class=lnt id=hl-27-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-27-4> 4</a>
</span><span class=lnt id=hl-27-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-27-5> 5</a>
</span><span class=lnt id=hl-27-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-27-6> 6</a>
</span><span class=lnt id=hl-27-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-27-7> 7</a>
</span><span class=lnt id=hl-27-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-27-8> 8</a>
</span><span class=lnt id=hl-27-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-27-9> 9</a>
</span><span class=lnt id=hl-27-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-27-10>10</a>
</span><span class=lnt id=hl-27-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-27-11>11</a>
</span><span class=lnt id=hl-27-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-27-12>12</a>
</span><span class=lnt id=hl-27-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-27-13>13</a>
</span><span class=lnt id=hl-27-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-27-14>14</a>
</span><span class=lnt id=hl-27-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-27-15>15</a>
</span><span class=lnt id=hl-27-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-27-16>16</a>
</span><span class=lnt id=hl-27-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-27-17>17</a>
</span><span class=lnt id=hl-27-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-27-18>18</a>
</span><span class=lnt id=hl-27-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-27-19>19</a>
</span><span class=lnt id=hl-27-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-27-20>20</a>
</span><span class=lnt id=hl-27-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-27-21>21</a>
</span><span class=lnt id=hl-27-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-27-22>22</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>//1 netty ä¸­ä½¿ç”¨ NioEventLoopGroup ï¼ˆç®€ç§° nio boss çº¿ç¨‹ï¼‰æ¥å°è£…çº¿ç¨‹å’Œ selector
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>Selector</span> <span class=n>selector</span> <span class=o>=</span> <span class=n>Selector</span><span class=o>.</span><span class=na>open</span><span class=o>();</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//2 åˆ›å»º NioServerSocketChannelï¼ŒåŒæ—¶ä¼šåˆå§‹åŒ–å®ƒå…³è”çš„ handlerï¼Œä»¥åŠä¸ºåŸç”Ÿ ssc å­˜å‚¨ config
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>NioServerSocketChannel</span> <span class=n>attachment</span> <span class=o>=</span> <span class=k>new</span> <span class=n>NioServerSocketChannel</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//3 åˆ›å»º NioServerSocketChannel æ—¶ï¼Œåˆ›å»ºäº† java åŸç”Ÿçš„ ServerSocketChannel
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>ServerSocketChannel</span> <span class=n>serverSocketChannel</span> <span class=o>=</span> <span class=n>ServerSocketChannel</span><span class=o>.</span><span class=na>open</span><span class=o>();</span> 
</span></span><span class=line><span class=cl><span class=n>serverSocketChannel</span><span class=o>.</span><span class=na>configureBlocking</span><span class=o>(</span><span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//4 å¯åŠ¨ nio boss çº¿ç¨‹æ‰§è¡Œæ¥ä¸‹æ¥çš„æ“ä½œ
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>//5 æ³¨å†Œï¼ˆä»…å…³è” selector å’Œ NioServerSocketChannelï¼‰ï¼Œæœªå…³æ³¨äº‹ä»¶
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>SelectionKey</span> <span class=n>selectionKey</span> <span class=o>=</span> <span class=n>serverSocketChannel</span><span class=o>.</span><span class=na>register</span><span class=o>(</span><span class=n>selector</span><span class=o>,</span> <span class=n>0</span><span class=o>,</span> <span class=n>attachment</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//6 head -&gt; åˆå§‹åŒ–å™¨ -&gt; ServerBootstrapAcceptor -&gt; tailï¼Œåˆå§‹åŒ–å™¨æ˜¯ä¸€æ¬¡æ€§çš„ï¼Œåªä¸ºæ·»åŠ  acceptor
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>//7 ç»‘å®šç«¯å£
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>serverSocketChannel</span><span class=o>.</span><span class=na>bind</span><span class=o>(</span><span class=k>new</span> <span class=n>InetSocketAddress</span><span class=o>(</span><span class=n>8080</span><span class=o>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//8 è§¦å‘ channel active äº‹ä»¶ï¼Œåœ¨ head ä¸­å…³æ³¨ op_accept äº‹ä»¶
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>selectionKey</span><span class=o>.</span><span class=na>interestOps</span><span class=o>(</span><span class=n>SelectionKey</span><span class=o>.</span><span class=na>OP_ACCEPT</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><p>å…¥å£ <code>io.netty.bootstrap.ServerBootstrap#bind</code></p><p>å…³é”®ä»£ç  <code>io.netty.bootstrap.AbstractBootstrap#doBind</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-28-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-1> 1</a>
</span><span class=lnt id=hl-28-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-2> 2</a>
</span><span class=lnt id=hl-28-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-3> 3</a>
</span><span class=lnt id=hl-28-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-4> 4</a>
</span><span class=lnt id=hl-28-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-5> 5</a>
</span><span class=lnt id=hl-28-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-6> 6</a>
</span><span class=lnt id=hl-28-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-7> 7</a>
</span><span class=lnt id=hl-28-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-8> 8</a>
</span><span class=lnt id=hl-28-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-9> 9</a>
</span><span class=lnt id=hl-28-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-10>10</a>
</span><span class=lnt id=hl-28-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-11>11</a>
</span><span class=lnt id=hl-28-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-12>12</a>
</span><span class=lnt id=hl-28-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-13>13</a>
</span><span class=lnt id=hl-28-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-14>14</a>
</span><span class=lnt id=hl-28-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-15>15</a>
</span><span class=lnt id=hl-28-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-16>16</a>
</span><span class=lnt id=hl-28-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-17>17</a>
</span><span class=lnt id=hl-28-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-18>18</a>
</span><span class=lnt id=hl-28-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-19>19</a>
</span><span class=lnt id=hl-28-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-20>20</a>
</span><span class=lnt id=hl-28-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-21>21</a>
</span><span class=lnt id=hl-28-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-22>22</a>
</span><span class=lnt id=hl-28-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-23>23</a>
</span><span class=lnt id=hl-28-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-24>24</a>
</span><span class=lnt id=hl-28-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-25>25</a>
</span><span class=lnt id=hl-28-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-26>26</a>
</span><span class=lnt id=hl-28-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-27>27</a>
</span><span class=lnt id=hl-28-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-28>28</a>
</span><span class=lnt id=hl-28-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-29>29</a>
</span><span class=lnt id=hl-28-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-30>30</a>
</span><span class=lnt id=hl-28-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-31>31</a>
</span><span class=lnt id=hl-28-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-32>32</a>
</span><span class=lnt id=hl-28-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-33>33</a>
</span><span class=lnt id=hl-28-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-34>34</a>
</span><span class=lnt id=hl-28-35><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-35>35</a>
</span><span class=lnt id=hl-28-36><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-36>36</a>
</span><span class=lnt id=hl-28-37><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-37>37</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=n>ChannelFuture</span> <span class=nf>doBind</span><span class=o>(</span><span class=kd>final</span> <span class=n>SocketAddress</span> <span class=n>localAddress</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 1. æ‰§è¡Œåˆå§‹åŒ–å’Œæ³¨å†Œ regFuture ä¼šç”± initAndRegister è®¾ç½®å…¶æ˜¯å¦å®Œæˆï¼Œä»è€Œå›è°ƒ 3.2 å¤„ä»£ç 
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>final</span> <span class=n>ChannelFuture</span> <span class=n>regFuture</span> <span class=o>=</span> <span class=n>initAndRegister</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=n>Channel</span> <span class=n>channel</span> <span class=o>=</span> <span class=n>regFuture</span><span class=o>.</span><span class=na>channel</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>regFuture</span><span class=o>.</span><span class=na>cause</span><span class=o>()</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>regFuture</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 2. å› ä¸ºæ˜¯ initAndRegister å¼‚æ­¥æ‰§è¡Œï¼Œéœ€è¦åˆ†ä¸¤ç§æƒ…å†µæ¥çœ‹ï¼Œè°ƒè¯•æ—¶ä¹Ÿéœ€è¦é€šè¿‡ suspend æ–­ç‚¹ç±»å‹åŠ ä»¥åŒºåˆ†
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 2.1 å¦‚æœå·²ç»å®Œæˆ
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>(</span><span class=n>regFuture</span><span class=o>.</span><span class=na>isDone</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ChannelPromise</span> <span class=n>promise</span> <span class=o>=</span> <span class=n>channel</span><span class=o>.</span><span class=na>newPromise</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 3.1 ç«‹åˆ»è°ƒç”¨ doBind0
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>doBind0</span><span class=o>(</span><span class=n>regFuture</span><span class=o>,</span> <span class=n>channel</span><span class=o>,</span> <span class=n>localAddress</span><span class=o>,</span> <span class=n>promise</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>promise</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> 
</span></span><span class=line><span class=cl>    <span class=c1>// 2.2 è¿˜æ²¡æœ‰å®Œæˆ
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>final</span> <span class=n>PendingRegistrationPromise</span> <span class=n>promise</span> <span class=o>=</span> <span class=k>new</span> <span class=n>PendingRegistrationPromise</span><span class=o>(</span><span class=n>channel</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 3.2 å›è°ƒ doBind0
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>regFuture</span><span class=o>.</span><span class=na>addListener</span><span class=o>(</span><span class=k>new</span> <span class=n>ChannelFutureListener</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>            <span class=kd>public</span> <span class=kt>void</span> <span class=nf>operationComplete</span><span class=o>(</span><span class=n>ChannelFuture</span> <span class=n>future</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>Throwable</span> <span class=n>cause</span> <span class=o>=</span> <span class=n>future</span><span class=o>.</span><span class=na>cause</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>cause</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=c1>// å¤„ç†å¼‚å¸¸...
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=n>promise</span><span class=o>.</span><span class=na>setFailure</span><span class=o>(</span><span class=n>cause</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>promise</span><span class=o>.</span><span class=na>registered</span><span class=o>();</span>
</span></span><span class=line><span class=cl>					<span class=c1>// 3. ç”±æ³¨å†Œçº¿ç¨‹å»æ‰§è¡Œ doBind0
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=n>doBind0</span><span class=o>(</span><span class=n>regFuture</span><span class=o>,</span> <span class=n>channel</span><span class=o>,</span> <span class=n>localAddress</span><span class=o>,</span> <span class=n>promise</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>});</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>promise</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å…³é”®ä»£ç  <code>io.netty.bootstrap.AbstractBootstrap#initAndRegister</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-29-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-29-1> 1</a>
</span><span class=lnt id=hl-29-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-29-2> 2</a>
</span><span class=lnt id=hl-29-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-29-3> 3</a>
</span><span class=lnt id=hl-29-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-29-4> 4</a>
</span><span class=lnt id=hl-29-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-29-5> 5</a>
</span><span class=lnt id=hl-29-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-29-6> 6</a>
</span><span class=lnt id=hl-29-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-29-7> 7</a>
</span><span class=lnt id=hl-29-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-29-8> 8</a>
</span><span class=lnt id=hl-29-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-29-9> 9</a>
</span><span class=lnt id=hl-29-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-29-10>10</a>
</span><span class=lnt id=hl-29-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-29-11>11</a>
</span><span class=lnt id=hl-29-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-29-12>12</a>
</span><span class=lnt id=hl-29-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-29-13>13</a>
</span><span class=lnt id=hl-29-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-29-14>14</a>
</span><span class=lnt id=hl-29-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-29-15>15</a>
</span><span class=lnt id=hl-29-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-29-16>16</a>
</span><span class=lnt id=hl-29-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-29-17>17</a>
</span><span class=lnt id=hl-29-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-29-18>18</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>final</span> <span class=n>ChannelFuture</span> <span class=nf>initAndRegister</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Channel</span> <span class=n>channel</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>channel</span> <span class=o>=</span> <span class=n>channelFactory</span><span class=o>.</span><span class=na>newChannel</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 1.1 åˆå§‹åŒ– - åšçš„äº‹å°±æ˜¯æ·»åŠ ä¸€ä¸ªåˆå§‹åŒ–å™¨ ChannelInitializer
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>init</span><span class=o>(</span><span class=n>channel</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Throwable</span> <span class=n>t</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// å¤„ç†å¼‚å¸¸...
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>return</span> <span class=k>new</span> <span class=n>DefaultChannelPromise</span><span class=o>(</span><span class=k>new</span> <span class=n>FailedChannel</span><span class=o>(),</span> <span class=n>GlobalEventExecutor</span><span class=o>.</span><span class=na>INSTANCE</span><span class=o>).</span><span class=na>setFailure</span><span class=o>(</span><span class=n>t</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 1.2 æ³¨å†Œ - åšçš„äº‹å°±æ˜¯å°†åŸç”Ÿ channel æ³¨å†Œåˆ° selector ä¸Š
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>ChannelFuture</span> <span class=n>regFuture</span> <span class=o>=</span> <span class=n>config</span><span class=o>().</span><span class=na>group</span><span class=o>().</span><span class=na>register</span><span class=o>(</span><span class=n>channel</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>regFuture</span><span class=o>.</span><span class=na>cause</span><span class=o>()</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// å¤„ç†å¼‚å¸¸...
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>regFuture</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å…³é”®ä»£ç  <code>io.netty.bootstrap.ServerBootstrap#init</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-30-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-1> 1</a>
</span><span class=lnt id=hl-30-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-2> 2</a>
</span><span class=lnt id=hl-30-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-3> 3</a>
</span><span class=lnt id=hl-30-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-4> 4</a>
</span><span class=lnt id=hl-30-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-5> 5</a>
</span><span class=lnt id=hl-30-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-6> 6</a>
</span><span class=lnt id=hl-30-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-7> 7</a>
</span><span class=lnt id=hl-30-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-8> 8</a>
</span><span class=lnt id=hl-30-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-9> 9</a>
</span><span class=lnt id=hl-30-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-10>10</a>
</span><span class=lnt id=hl-30-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-11>11</a>
</span><span class=lnt id=hl-30-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-12>12</a>
</span><span class=lnt id=hl-30-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-13>13</a>
</span><span class=lnt id=hl-30-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-14>14</a>
</span><span class=lnt id=hl-30-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-15>15</a>
</span><span class=lnt id=hl-30-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-16>16</a>
</span><span class=lnt id=hl-30-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-17>17</a>
</span><span class=lnt id=hl-30-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-18>18</a>
</span><span class=lnt id=hl-30-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-19>19</a>
</span><span class=lnt id=hl-30-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-20>20</a>
</span><span class=lnt id=hl-30-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-21>21</a>
</span><span class=lnt id=hl-30-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-22>22</a>
</span><span class=lnt id=hl-30-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-23>23</a>
</span><span class=lnt id=hl-30-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-24>24</a>
</span><span class=lnt id=hl-30-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-25>25</a>
</span><span class=lnt id=hl-30-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-26>26</a>
</span><span class=lnt id=hl-30-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-27>27</a>
</span><span class=lnt id=hl-30-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-28>28</a>
</span><span class=lnt id=hl-30-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-29>29</a>
</span><span class=lnt id=hl-30-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-30>30</a>
</span><span class=lnt id=hl-30-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-31>31</a>
</span><span class=lnt id=hl-30-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-32>32</a>
</span><span class=lnt id=hl-30-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-33>33</a>
</span><span class=lnt id=hl-30-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-34>34</a>
</span><span class=lnt id=hl-30-35><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-35>35</a>
</span><span class=lnt id=hl-30-36><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-36>36</a>
</span><span class=lnt id=hl-30-37><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-37>37</a>
</span><span class=lnt id=hl-30-38><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-38>38</a>
</span><span class=lnt id=hl-30-39><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-39>39</a>
</span><span class=lnt id=hl-30-40><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-40>40</a>
</span><span class=lnt id=hl-30-41><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-41>41</a>
</span><span class=lnt id=hl-30-42><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-42>42</a>
</span><span class=lnt id=hl-30-43><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-43>43</a>
</span><span class=lnt id=hl-30-44><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-44>44</a>
</span><span class=lnt id=hl-30-45><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-45>45</a>
</span><span class=lnt id=hl-30-46><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-46>46</a>
</span><span class=lnt id=hl-30-47><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-47>47</a>
</span><span class=lnt id=hl-30-48><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-48>48</a>
</span><span class=lnt id=hl-30-49><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-49>49</a>
</span><span class=lnt id=hl-30-50><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-50>50</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// è¿™é‡Œ channel å®é™…ä¸Šæ˜¯ NioServerSocketChannel
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span> <span class=nf>init</span><span class=o>(</span><span class=n>Channel</span> <span class=n>channel</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>ChannelOption</span><span class=o>&lt;?&gt;,</span> <span class=n>Object</span><span class=o>&gt;</span> <span class=n>options</span> <span class=o>=</span> <span class=n>options0</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=kd>synchronized</span> <span class=o>(</span><span class=n>options</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>setChannelOptions</span><span class=o>(</span><span class=n>channel</span><span class=o>,</span> <span class=n>options</span><span class=o>,</span> <span class=n>logger</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>AttributeKey</span><span class=o>&lt;?&gt;,</span> <span class=n>Object</span><span class=o>&gt;</span> <span class=n>attrs</span> <span class=o>=</span> <span class=n>attrs0</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=kd>synchronized</span> <span class=o>(</span><span class=n>attrs</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=o>(</span><span class=n>Entry</span><span class=o>&lt;</span><span class=n>AttributeKey</span><span class=o>&lt;?&gt;,</span> <span class=n>Object</span><span class=o>&gt;</span> <span class=n>e</span><span class=o>:</span> <span class=n>attrs</span><span class=o>.</span><span class=na>entrySet</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=nd>@SuppressWarnings</span><span class=o>(</span><span class=s>&#34;unchecked&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>            <span class=n>AttributeKey</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span> <span class=n>key</span> <span class=o>=</span> <span class=o>(</span><span class=n>AttributeKey</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;)</span> <span class=n>e</span><span class=o>.</span><span class=na>getKey</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>channel</span><span class=o>.</span><span class=na>attr</span><span class=o>(</span><span class=n>key</span><span class=o>).</span><span class=na>set</span><span class=o>(</span><span class=n>e</span><span class=o>.</span><span class=na>getValue</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>ChannelPipeline</span> <span class=n>p</span> <span class=o>=</span> <span class=n>channel</span><span class=o>.</span><span class=na>pipeline</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=n>EventLoopGroup</span> <span class=n>currentChildGroup</span> <span class=o>=</span> <span class=n>childGroup</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=n>ChannelHandler</span> <span class=n>currentChildHandler</span> <span class=o>=</span> <span class=n>childHandler</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=n>Entry</span><span class=o>&lt;</span><span class=n>ChannelOption</span><span class=o>&lt;?&gt;,</span> <span class=n>Object</span><span class=o>&gt;[]</span> <span class=n>currentChildOptions</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=n>Entry</span><span class=o>&lt;</span><span class=n>AttributeKey</span><span class=o>&lt;?&gt;,</span> <span class=n>Object</span><span class=o>&gt;[]</span> <span class=n>currentChildAttrs</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>synchronized</span> <span class=o>(</span><span class=n>childOptions</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>currentChildOptions</span> <span class=o>=</span> <span class=n>childOptions</span><span class=o>.</span><span class=na>entrySet</span><span class=o>().</span><span class=na>toArray</span><span class=o>(</span><span class=n>newOptionArray</span><span class=o>(</span><span class=n>0</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=kd>synchronized</span> <span class=o>(</span><span class=n>childAttrs</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>currentChildAttrs</span> <span class=o>=</span> <span class=n>childAttrs</span><span class=o>.</span><span class=na>entrySet</span><span class=o>().</span><span class=na>toArray</span><span class=o>(</span><span class=n>newAttrArray</span><span class=o>(</span><span class=n>0</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>    <span class=c1>// ä¸º NioServerSocketChannel æ·»åŠ åˆå§‹åŒ–å™¨
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>p</span><span class=o>.</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>ChannelInitializer</span><span class=o>&lt;</span><span class=n>Channel</span><span class=o>&gt;()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>initChannel</span><span class=o>(</span><span class=kd>final</span> <span class=n>Channel</span> <span class=n>ch</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=kd>final</span> <span class=n>ChannelPipeline</span> <span class=n>pipeline</span> <span class=o>=</span> <span class=n>ch</span><span class=o>.</span><span class=na>pipeline</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>ChannelHandler</span> <span class=n>handler</span> <span class=o>=</span> <span class=n>config</span><span class=o>.</span><span class=na>handler</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>handler</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>pipeline</span><span class=o>.</span><span class=na>addLast</span><span class=o>(</span><span class=n>handler</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1>// åˆå§‹åŒ–å™¨çš„èŒè´£æ˜¯å°† ServerBootstrapAcceptor åŠ å…¥è‡³ NioServerSocketChannel
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>ch</span><span class=o>.</span><span class=na>eventLoop</span><span class=o>().</span><span class=na>execute</span><span class=o>(</span><span class=k>new</span> <span class=n>Runnable</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>                <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>pipeline</span><span class=o>.</span><span class=na>addLast</span><span class=o>(</span><span class=k>new</span> <span class=n>ServerBootstrapAcceptor</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                            <span class=n>ch</span><span class=o>,</span> <span class=n>currentChildGroup</span><span class=o>,</span> <span class=n>currentChildHandler</span><span class=o>,</span> <span class=n>currentChildOptions</span><span class=o>,</span> <span class=n>currentChildAttrs</span><span class=o>));</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>});</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>});</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å…³é”®ä»£ç  <code>io.netty.channel.AbstractChannel.AbstractUnsafe#register</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-31-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-31-1> 1</a>
</span><span class=lnt id=hl-31-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-31-2> 2</a>
</span><span class=lnt id=hl-31-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-31-3> 3</a>
</span><span class=lnt id=hl-31-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-31-4> 4</a>
</span><span class=lnt id=hl-31-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-31-5> 5</a>
</span><span class=lnt id=hl-31-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-31-6> 6</a>
</span><span class=lnt id=hl-31-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-31-7> 7</a>
</span><span class=lnt id=hl-31-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-31-8> 8</a>
</span><span class=lnt id=hl-31-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-31-9> 9</a>
</span><span class=lnt id=hl-31-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-31-10>10</a>
</span><span class=lnt id=hl-31-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-31-11>11</a>
</span><span class=lnt id=hl-31-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-31-12>12</a>
</span><span class=lnt id=hl-31-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-31-13>13</a>
</span><span class=lnt id=hl-31-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-31-14>14</a>
</span><span class=lnt id=hl-31-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-31-15>15</a>
</span><span class=lnt id=hl-31-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-31-16>16</a>
</span><span class=lnt id=hl-31-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-31-17>17</a>
</span><span class=lnt id=hl-31-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-31-18>18</a>
</span><span class=lnt id=hl-31-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-31-19>19</a>
</span><span class=lnt id=hl-31-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-31-20>20</a>
</span><span class=lnt id=hl-31-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-31-21>21</a>
</span><span class=lnt id=hl-31-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-31-22>22</a>
</span><span class=lnt id=hl-31-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-31-23>23</a>
</span><span class=lnt id=hl-31-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-31-24>24</a>
</span><span class=lnt id=hl-31-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-31-25>25</a>
</span><span class=lnt id=hl-31-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-31-26>26</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>final</span> <span class=kt>void</span> <span class=nf>register</span><span class=o>(</span><span class=n>EventLoop</span> <span class=n>eventLoop</span><span class=o>,</span> <span class=kd>final</span> <span class=n>ChannelPromise</span> <span class=n>promise</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ä¸€äº›æ£€æŸ¥ï¼Œç•¥...
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=n>AbstractChannel</span><span class=o>.</span><span class=na>this</span><span class=o>.</span><span class=na>eventLoop</span> <span class=o>=</span> <span class=n>eventLoop</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>eventLoop</span><span class=o>.</span><span class=na>inEventLoop</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>register0</span><span class=o>(</span><span class=n>promise</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// é¦–æ¬¡æ‰§è¡Œ execute æ–¹æ³•æ—¶ï¼Œä¼šå¯åŠ¨ nio çº¿ç¨‹ï¼Œä¹‹åæ³¨å†Œç­‰æ“ä½œåœ¨ nio çº¿ç¨‹ä¸Šæ‰§è¡Œ
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// å› ä¸ºåªæœ‰ä¸€ä¸ª NioServerSocketChannel å› æ­¤ï¼Œä¹Ÿåªä¼šæœ‰ä¸€ä¸ª boss nio çº¿ç¨‹
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// è¿™è¡Œä»£ç å®Œæˆçš„äº‹å®æ˜¯ main -&gt; nio boss çº¿ç¨‹çš„åˆ‡æ¢
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>eventLoop</span><span class=o>.</span><span class=na>execute</span><span class=o>(</span><span class=k>new</span> <span class=n>Runnable</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>                <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>register0</span><span class=o>(</span><span class=n>promise</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>});</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Throwable</span> <span class=n>t</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// æ—¥å¿—è®°å½•...
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>closeForcibly</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>closeFuture</span><span class=o>.</span><span class=na>setClosed</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>safeSetFailure</span><span class=o>(</span><span class=n>promise</span><span class=o>,</span> <span class=n>t</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>io.netty.channel.AbstractChannel.AbstractUnsafe#register0</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-32-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-32-1> 1</a>
</span><span class=lnt id=hl-32-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-32-2> 2</a>
</span><span class=lnt id=hl-32-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-32-3> 3</a>
</span><span class=lnt id=hl-32-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-32-4> 4</a>
</span><span class=lnt id=hl-32-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-32-5> 5</a>
</span><span class=lnt id=hl-32-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-32-6> 6</a>
</span><span class=lnt id=hl-32-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-32-7> 7</a>
</span><span class=lnt id=hl-32-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-32-8> 8</a>
</span><span class=lnt id=hl-32-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-32-9> 9</a>
</span><span class=lnt id=hl-32-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-32-10>10</a>
</span><span class=lnt id=hl-32-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-32-11>11</a>
</span><span class=lnt id=hl-32-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-32-12>12</a>
</span><span class=lnt id=hl-32-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-32-13>13</a>
</span><span class=lnt id=hl-32-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-32-14>14</a>
</span><span class=lnt id=hl-32-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-32-15>15</a>
</span><span class=lnt id=hl-32-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-32-16>16</a>
</span><span class=lnt id=hl-32-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-32-17>17</a>
</span><span class=lnt id=hl-32-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-32-18>18</a>
</span><span class=lnt id=hl-32-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-32-19>19</a>
</span><span class=lnt id=hl-32-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-32-20>20</a>
</span><span class=lnt id=hl-32-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-32-21>21</a>
</span><span class=lnt id=hl-32-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-32-22>22</a>
</span><span class=lnt id=hl-32-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-32-23>23</a>
</span><span class=lnt id=hl-32-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-32-24>24</a>
</span><span class=lnt id=hl-32-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-32-25>25</a>
</span><span class=lnt id=hl-32-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-32-26>26</a>
</span><span class=lnt id=hl-32-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-32-27>27</a>
</span><span class=lnt id=hl-32-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-32-28>28</a>
</span><span class=lnt id=hl-32-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-32-29>29</a>
</span><span class=lnt id=hl-32-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-32-30>30</a>
</span><span class=lnt id=hl-32-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-32-31>31</a>
</span><span class=lnt id=hl-32-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-32-32>32</a>
</span><span class=lnt id=hl-32-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-32-33>33</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kt>void</span> <span class=nf>register0</span><span class=o>(</span><span class=n>ChannelPromise</span> <span class=n>promise</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(!</span><span class=n>promise</span><span class=o>.</span><span class=na>setUncancellable</span><span class=o>()</span> <span class=o>||</span> <span class=o>!</span><span class=n>ensureOpen</span><span class=o>(</span><span class=n>promise</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=kt>boolean</span> <span class=n>firstRegistration</span> <span class=o>=</span> <span class=n>neverRegistered</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 1.2.1 åŸç”Ÿçš„ nio channel ç»‘å®šåˆ° selector ä¸Šï¼Œæ³¨æ„æ­¤æ—¶æ²¡æœ‰æ³¨å†Œ selector å…³æ³¨äº‹ä»¶ï¼Œé™„ä»¶ä¸º NioServerSocketChannel
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>doRegister</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>neverRegistered</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>registered</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// 1.2.2 æ‰§è¡Œ NioServerSocketChannel åˆå§‹åŒ–å™¨çš„ initChannel
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>pipeline</span><span class=o>.</span><span class=na>invokeHandlerAddedIfNeeded</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// å›è°ƒ 3.2 io.netty.bootstrap.AbstractBootstrap#doBind0
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>safeSetSuccess</span><span class=o>(</span><span class=n>promise</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>pipeline</span><span class=o>.</span><span class=na>fireChannelRegistered</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1>// å¯¹åº” server socket channel è¿˜æœªç»‘å®šï¼ŒisActive ä¸º false
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=o>(</span><span class=n>isActive</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>firstRegistration</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>pipeline</span><span class=o>.</span><span class=na>fireChannelActive</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>config</span><span class=o>().</span><span class=na>isAutoRead</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>beginRead</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Throwable</span> <span class=n>t</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Close the channel directly to avoid FD leak.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>closeForcibly</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>closeFuture</span><span class=o>.</span><span class=na>setClosed</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>safeSetFailure</span><span class=o>(</span><span class=n>promise</span><span class=o>,</span> <span class=n>t</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å…³é”®ä»£ç  <code>io.netty.channel.ChannelInitializer#initChannel</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-33-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-1> 1</a>
</span><span class=lnt id=hl-33-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-2> 2</a>
</span><span class=lnt id=hl-33-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-3> 3</a>
</span><span class=lnt id=hl-33-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-4> 4</a>
</span><span class=lnt id=hl-33-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-5> 5</a>
</span><span class=lnt id=hl-33-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-6> 6</a>
</span><span class=lnt id=hl-33-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-7> 7</a>
</span><span class=lnt id=hl-33-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-8> 8</a>
</span><span class=lnt id=hl-33-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-9> 9</a>
</span><span class=lnt id=hl-33-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-10>10</a>
</span><span class=lnt id=hl-33-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-11>11</a>
</span><span class=lnt id=hl-33-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-12>12</a>
</span><span class=lnt id=hl-33-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-13>13</a>
</span><span class=lnt id=hl-33-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-14>14</a>
</span><span class=lnt id=hl-33-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-15>15</a>
</span><span class=lnt id=hl-33-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-16>16</a>
</span><span class=lnt id=hl-33-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-17>17</a>
</span><span class=lnt id=hl-33-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-18>18</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kt>boolean</span> <span class=nf>initChannel</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>initMap</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>ctx</span><span class=o>))</span> <span class=o>{</span> <span class=c1>// Guard against re-entrance.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 1.2.2.1 æ‰§è¡Œåˆå§‹åŒ–
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>initChannel</span><span class=o>((</span><span class=n>C</span><span class=o>)</span> <span class=n>ctx</span><span class=o>.</span><span class=na>channel</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Throwable</span> <span class=n>cause</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>exceptionCaught</span><span class=o>(</span><span class=n>ctx</span><span class=o>,</span> <span class=n>cause</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 1.2.2.2 ç§»é™¤åˆå§‹åŒ–å™¨
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>ChannelPipeline</span> <span class=n>pipeline</span> <span class=o>=</span> <span class=n>ctx</span><span class=o>.</span><span class=na>pipeline</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>pipeline</span><span class=o>.</span><span class=na>context</span><span class=o>(</span><span class=k>this</span><span class=o>)</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>pipeline</span><span class=o>.</span><span class=na>remove</span><span class=o>(</span><span class=k>this</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å…³é”®ä»£ç  <code>io.netty.bootstrap.AbstractBootstrap#doBind0</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-34-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-34-1> 1</a>
</span><span class=lnt id=hl-34-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-34-2> 2</a>
</span><span class=lnt id=hl-34-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-34-3> 3</a>
</span><span class=lnt id=hl-34-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-34-4> 4</a>
</span><span class=lnt id=hl-34-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-34-5> 5</a>
</span><span class=lnt id=hl-34-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-34-6> 6</a>
</span><span class=lnt id=hl-34-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-34-7> 7</a>
</span><span class=lnt id=hl-34-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-34-8> 8</a>
</span><span class=lnt id=hl-34-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-34-9> 9</a>
</span><span class=lnt id=hl-34-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-34-10>10</a>
</span><span class=lnt id=hl-34-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-34-11>11</a>
</span><span class=lnt id=hl-34-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-34-12>12</a>
</span><span class=lnt id=hl-34-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-34-13>13</a>
</span><span class=lnt id=hl-34-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-34-14>14</a>
</span><span class=lnt id=hl-34-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-34-15>15</a>
</span><span class=lnt id=hl-34-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-34-16>16</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 3.1 æˆ– 3.2 æ‰§è¡Œ doBind0
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>private</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>doBind0</span><span class=o>(</span>
</span></span><span class=line><span class=cl>        <span class=kd>final</span> <span class=n>ChannelFuture</span> <span class=n>regFuture</span><span class=o>,</span> <span class=kd>final</span> <span class=n>Channel</span> <span class=n>channel</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=kd>final</span> <span class=n>SocketAddress</span> <span class=n>localAddress</span><span class=o>,</span> <span class=kd>final</span> <span class=n>ChannelPromise</span> <span class=n>promise</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>channel</span><span class=o>.</span><span class=na>eventLoop</span><span class=o>().</span><span class=na>execute</span><span class=o>(</span><span class=k>new</span> <span class=n>Runnable</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>regFuture</span><span class=o>.</span><span class=na>isSuccess</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>channel</span><span class=o>.</span><span class=na>bind</span><span class=o>(</span><span class=n>localAddress</span><span class=o>,</span> <span class=n>promise</span><span class=o>).</span><span class=na>addListener</span><span class=o>(</span><span class=n>ChannelFutureListener</span><span class=o>.</span><span class=na>CLOSE_ON_FAILURE</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>promise</span><span class=o>.</span><span class=na>setFailure</span><span class=o>(</span><span class=n>regFuture</span><span class=o>.</span><span class=na>cause</span><span class=o>());</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>});</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å…³é”®ä»£ç  <code>io.netty.channel.AbstractChannel.AbstractUnsafe#bind</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-35-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-35-1> 1</a>
</span><span class=lnt id=hl-35-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-35-2> 2</a>
</span><span class=lnt id=hl-35-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-35-3> 3</a>
</span><span class=lnt id=hl-35-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-35-4> 4</a>
</span><span class=lnt id=hl-35-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-35-5> 5</a>
</span><span class=lnt id=hl-35-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-35-6> 6</a>
</span><span class=lnt id=hl-35-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-35-7> 7</a>
</span><span class=lnt id=hl-35-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-35-8> 8</a>
</span><span class=lnt id=hl-35-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-35-9> 9</a>
</span><span class=lnt id=hl-35-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-35-10>10</a>
</span><span class=lnt id=hl-35-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-35-11>11</a>
</span><span class=lnt id=hl-35-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-35-12>12</a>
</span><span class=lnt id=hl-35-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-35-13>13</a>
</span><span class=lnt id=hl-35-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-35-14>14</a>
</span><span class=lnt id=hl-35-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-35-15>15</a>
</span><span class=lnt id=hl-35-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-35-16>16</a>
</span><span class=lnt id=hl-35-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-35-17>17</a>
</span><span class=lnt id=hl-35-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-35-18>18</a>
</span><span class=lnt id=hl-35-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-35-19>19</a>
</span><span class=lnt id=hl-35-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-35-20>20</a>
</span><span class=lnt id=hl-35-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-35-21>21</a>
</span><span class=lnt id=hl-35-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-35-22>22</a>
</span><span class=lnt id=hl-35-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-35-23>23</a>
</span><span class=lnt id=hl-35-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-35-24>24</a>
</span><span class=lnt id=hl-35-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-35-25>25</a>
</span><span class=lnt id=hl-35-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-35-26>26</a>
</span><span class=lnt id=hl-35-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-35-27>27</a>
</span><span class=lnt id=hl-35-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-35-28>28</a>
</span><span class=lnt id=hl-35-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-35-29>29</a>
</span><span class=lnt id=hl-35-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-35-30>30</a>
</span><span class=lnt id=hl-35-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-35-31>31</a>
</span><span class=lnt id=hl-35-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-35-32>32</a>
</span><span class=lnt id=hl-35-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-35-33>33</a>
</span><span class=lnt id=hl-35-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-35-34>34</a>
</span><span class=lnt id=hl-35-35><a style=outline:none;text-decoration:none;color:inherit href=#hl-35-35>35</a>
</span><span class=lnt id=hl-35-36><a style=outline:none;text-decoration:none;color:inherit href=#hl-35-36>36</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>final</span> <span class=kt>void</span> <span class=nf>bind</span><span class=o>(</span><span class=kd>final</span> <span class=n>SocketAddress</span> <span class=n>localAddress</span><span class=o>,</span> <span class=kd>final</span> <span class=n>ChannelPromise</span> <span class=n>promise</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>assertEventLoop</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(!</span><span class=n>promise</span><span class=o>.</span><span class=na>setUncancellable</span><span class=o>()</span> <span class=o>||</span> <span class=o>!</span><span class=n>ensureOpen</span><span class=o>(</span><span class=n>promise</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>Boolean</span><span class=o>.</span><span class=na>TRUE</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>config</span><span class=o>().</span><span class=na>getOption</span><span class=o>(</span><span class=n>ChannelOption</span><span class=o>.</span><span class=na>SO_BROADCAST</span><span class=o>))</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>        <span class=n>localAddress</span> <span class=k>instanceof</span> <span class=n>InetSocketAddress</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>        <span class=o>!((</span><span class=n>InetSocketAddress</span><span class=o>)</span> <span class=n>localAddress</span><span class=o>).</span><span class=na>getAddress</span><span class=o>().</span><span class=na>isAnyLocalAddress</span><span class=o>()</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>        <span class=o>!</span><span class=n>PlatformDependent</span><span class=o>.</span><span class=na>isWindows</span><span class=o>()</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>PlatformDependent</span><span class=o>.</span><span class=na>maybeSuperUser</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// è®°å½•æ—¥å¿—...
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>boolean</span> <span class=n>wasActive</span> <span class=o>=</span> <span class=n>isActive</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 3.3 æ‰§è¡Œç«¯å£ç»‘å®š
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>doBind</span><span class=o>(</span><span class=n>localAddress</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Throwable</span> <span class=n>t</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>safeSetFailure</span><span class=o>(</span><span class=n>promise</span><span class=o>,</span> <span class=n>t</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>closeIfClosed</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(!</span><span class=n>wasActive</span> <span class=o>&amp;&amp;</span> <span class=n>isActive</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>invokeLater</span><span class=o>(</span><span class=k>new</span> <span class=n>Runnable</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>            <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 3.4 è§¦å‘ active äº‹ä»¶
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>pipeline</span><span class=o>.</span><span class=na>fireChannelActive</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>});</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>safeSetSuccess</span><span class=o>(</span><span class=n>promise</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>3.3 å…³é”®ä»£ç  <code>io.netty.channel.socket.nio.NioServerSocketChannel#doBind</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-36-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-36-1>1</a>
</span><span class=lnt id=hl-36-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-36-2>2</a>
</span><span class=lnt id=hl-36-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-36-3>3</a>
</span><span class=lnt id=hl-36-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-36-4>4</a>
</span><span class=lnt id=hl-36-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-36-5>5</a>
</span><span class=lnt id=hl-36-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-36-6>6</a>
</span><span class=lnt id=hl-36-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-36-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>protected</span> <span class=kt>void</span> <span class=nf>doBind</span><span class=o>(</span><span class=n>SocketAddress</span> <span class=n>localAddress</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>PlatformDependent</span><span class=o>.</span><span class=na>javaVersion</span><span class=o>()</span> <span class=o>&gt;=</span> <span class=n>7</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>javaChannel</span><span class=o>().</span><span class=na>bind</span><span class=o>(</span><span class=n>localAddress</span><span class=o>,</span> <span class=n>config</span><span class=o>.</span><span class=na>getBacklog</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>javaChannel</span><span class=o>().</span><span class=na>socket</span><span class=o>().</span><span class=na>bind</span><span class=o>(</span><span class=n>localAddress</span><span class=o>,</span> <span class=n>config</span><span class=o>.</span><span class=na>getBacklog</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>3.4 å…³é”®ä»£ç  <code>io.netty.channel.DefaultChannelPipeline.HeadContext#channelActive</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-37-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-37-1>1</a>
</span><span class=lnt id=hl-37-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-37-2>2</a>
</span><span class=lnt id=hl-37-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-37-3>3</a>
</span><span class=lnt id=hl-37-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-37-4>4</a>
</span><span class=lnt id=hl-37-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-37-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>channelActive</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ctx</span><span class=o>.</span><span class=na>fireChannelActive</span><span class=o>();</span>
</span></span><span class=line><span class=cl>	<span class=c1>// è§¦å‘ read (NioServerSocketChannel ä¸Šçš„ read ä¸æ˜¯è¯»å–æ•°æ®ï¼Œåªæ˜¯ä¸ºäº†è§¦å‘ channel çš„äº‹ä»¶æ³¨å†Œ)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>readIfIsAutoRead</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å…³é”®ä»£ç  <code>io.netty.channel.nio.AbstractNioChannel#doBeginRead</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-38-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-38-1> 1</a>
</span><span class=lnt id=hl-38-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-38-2> 2</a>
</span><span class=lnt id=hl-38-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-38-3> 3</a>
</span><span class=lnt id=hl-38-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-38-4> 4</a>
</span><span class=lnt id=hl-38-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-38-5> 5</a>
</span><span class=lnt id=hl-38-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-38-6> 6</a>
</span><span class=lnt id=hl-38-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-38-7> 7</a>
</span><span class=lnt id=hl-38-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-38-8> 8</a>
</span><span class=lnt id=hl-38-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-38-9> 9</a>
</span><span class=lnt id=hl-38-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-38-10>10</a>
</span><span class=lnt id=hl-38-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-38-11>11</a>
</span><span class=lnt id=hl-38-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-38-12>12</a>
</span><span class=lnt id=hl-38-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-38-13>13</a>
</span><span class=lnt id=hl-38-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-38-14>14</a>
</span><span class=lnt id=hl-38-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-38-15>15</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>protected</span> <span class=kt>void</span> <span class=nf>doBeginRead</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Channel.read() or ChannelHandlerContext.read() was called
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>final</span> <span class=n>SelectionKey</span> <span class=n>selectionKey</span> <span class=o>=</span> <span class=k>this</span><span class=o>.</span><span class=na>selectionKey</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(!</span><span class=n>selectionKey</span><span class=o>.</span><span class=na>isValid</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>readPending</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=kt>int</span> <span class=n>interestOps</span> <span class=o>=</span> <span class=n>selectionKey</span><span class=o>.</span><span class=na>interestOps</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=c1>// readInterestOp å–å€¼æ˜¯ 16ï¼Œåœ¨ NioServerSocketChannel åˆ›å»ºæ—¶åˆå§‹åŒ–å¥½ï¼Œä»£è¡¨å…³æ³¨ accept äº‹ä»¶
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>((</span><span class=n>interestOps</span> <span class=o>&amp;</span> <span class=n>readInterestOp</span><span class=o>)</span> <span class=o>==</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>selectionKey</span><span class=o>.</span><span class=na>interestOps</span><span class=o>(</span><span class=n>interestOps</span> <span class=o>|</span> <span class=n>readInterestOp</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#22-nioeventloop-å‰–æ><h3 id=22-nioeventloop-å‰–æ><span class=hanchor arialabel=Anchor># </span>2.2 NioEventLoop å‰–æ</h3></a><p><img src="/z-oblib/z2-attachments/Pasted image 20220624231611.png" width=auto></p><p>NioEventLoop çº¿ç¨‹ä¸ä»…è¦å¤„ç† IO äº‹ä»¶ï¼Œè¿˜è¦å¤„ç† Taskï¼ˆåŒ…æ‹¬æ™®é€šä»»åŠ¡å’Œå®šæ—¶ä»»åŠ¡ï¼‰ï¼Œ</p><p>æäº¤ä»»åŠ¡ä»£ç  <code>io.netty.util.concurrent.SingleThreadEventExecutor#execute</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-39-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-39-1> 1</a>
</span><span class=lnt id=hl-39-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-39-2> 2</a>
</span><span class=lnt id=hl-39-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-39-3> 3</a>
</span><span class=lnt id=hl-39-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-39-4> 4</a>
</span><span class=lnt id=hl-39-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-39-5> 5</a>
</span><span class=lnt id=hl-39-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-39-6> 6</a>
</span><span class=lnt id=hl-39-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-39-7> 7</a>
</span><span class=lnt id=hl-39-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-39-8> 8</a>
</span><span class=lnt id=hl-39-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-39-9> 9</a>
</span><span class=lnt id=hl-39-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-39-10>10</a>
</span><span class=lnt id=hl-39-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-39-11>11</a>
</span><span class=lnt id=hl-39-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-39-12>12</a>
</span><span class=lnt id=hl-39-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-39-13>13</a>
</span><span class=lnt id=hl-39-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-39-14>14</a>
</span><span class=lnt id=hl-39-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-39-15>15</a>
</span><span class=lnt id=hl-39-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-39-16>16</a>
</span><span class=lnt id=hl-39-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-39-17>17</a>
</span><span class=lnt id=hl-39-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-39-18>18</a>
</span><span class=lnt id=hl-39-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-39-19>19</a>
</span><span class=lnt id=hl-39-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-39-20>20</a>
</span><span class=lnt id=hl-39-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-39-21>21</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>execute</span><span class=o>(</span><span class=n>Runnable</span> <span class=n>task</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>task</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=k>new</span> <span class=n>NullPointerException</span><span class=o>(</span><span class=s>&#34;task&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>boolean</span> <span class=n>inEventLoop</span> <span class=o>=</span> <span class=n>inEventLoop</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=c1>// æ·»åŠ ä»»åŠ¡ï¼Œå…¶ä¸­é˜Ÿåˆ—ä½¿ç”¨äº† jctools æä¾›çš„ mpsc æ— é”é˜Ÿåˆ—
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>addTask</span><span class=o>(</span><span class=n>task</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(!</span><span class=n>inEventLoop</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// inEventLoop å¦‚æœä¸º false è¡¨ç¤ºç”±å…¶å®ƒçº¿ç¨‹æ¥è°ƒç”¨ executeï¼Œå³é¦–æ¬¡è°ƒç”¨ï¼Œè¿™æ—¶éœ€è¦å‘ eventLoop æäº¤é¦–ä¸ªä»»åŠ¡ï¼Œå¯åŠ¨æ­»å¾ªç¯ï¼Œä¼šæ‰§è¡Œåˆ°ä¸‹é¢çš„ doStartThread
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>startThread</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>isShutdown</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// å¦‚æœå·²ç» shutdownï¼Œåšæ‹’ç»é€»è¾‘ï¼Œä»£ç ç•¥...
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(!</span><span class=n>addTaskWakesUp</span> <span class=o>&amp;&amp;</span> <span class=n>wakesUpForTask</span><span class=o>(</span><span class=n>task</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// å¦‚æœçº¿ç¨‹ç”±äº IO select é˜»å¡äº†ï¼Œæ·»åŠ çš„ä»»åŠ¡çš„çº¿ç¨‹éœ€è¦è´Ÿè´£å”¤é†’ NioEventLoop çº¿ç¨‹
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>wakeup</span><span class=o>(</span><span class=n>inEventLoop</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å”¤é†’ select é˜»å¡çº¿ç¨‹<code>io.netty.channel.nio.NioEventLoop#wakeup</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-40-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-40-1>1</a>
</span><span class=lnt id=hl-40-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-40-2>2</a>
</span><span class=lnt id=hl-40-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-40-3>3</a>
</span><span class=lnt id=hl-40-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-40-4>4</a>
</span><span class=lnt id=hl-40-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-40-5>5</a>
</span><span class=lnt id=hl-40-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-40-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>protected</span> <span class=kt>void</span> <span class=nf>wakeup</span><span class=o>(</span><span class=kt>boolean</span> <span class=n>inEventLoop</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(!</span><span class=n>inEventLoop</span> <span class=o>&amp;&amp;</span> <span class=n>wakenUp</span><span class=o>.</span><span class=na>compareAndSet</span><span class=o>(</span><span class=kc>false</span><span class=o>,</span> <span class=kc>true</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>selector</span><span class=o>.</span><span class=na>wakeup</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å¯åŠ¨ EventLoop ä¸»å¾ªç¯ <code>io.netty.util.concurrent.SingleThreadEventExecutor#doStartThread</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-41-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-41-1> 1</a>
</span><span class=lnt id=hl-41-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-41-2> 2</a>
</span><span class=lnt id=hl-41-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-41-3> 3</a>
</span><span class=lnt id=hl-41-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-41-4> 4</a>
</span><span class=lnt id=hl-41-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-41-5> 5</a>
</span><span class=lnt id=hl-41-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-41-6> 6</a>
</span><span class=lnt id=hl-41-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-41-7> 7</a>
</span><span class=lnt id=hl-41-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-41-8> 8</a>
</span><span class=lnt id=hl-41-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-41-9> 9</a>
</span><span class=lnt id=hl-41-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-41-10>10</a>
</span><span class=lnt id=hl-41-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-41-11>11</a>
</span><span class=lnt id=hl-41-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-41-12>12</a>
</span><span class=lnt id=hl-41-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-41-13>13</a>
</span><span class=lnt id=hl-41-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-41-14>14</a>
</span><span class=lnt id=hl-41-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-41-15>15</a>
</span><span class=lnt id=hl-41-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-41-16>16</a>
</span><span class=lnt id=hl-41-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-41-17>17</a>
</span><span class=lnt id=hl-41-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-41-18>18</a>
</span><span class=lnt id=hl-41-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-41-19>19</a>
</span><span class=lnt id=hl-41-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-41-20>20</a>
</span><span class=lnt id=hl-41-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-41-21>21</a>
</span><span class=lnt id=hl-41-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-41-22>22</a>
</span><span class=lnt id=hl-41-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-41-23>23</a>
</span><span class=lnt id=hl-41-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-41-24>24</a>
</span><span class=lnt id=hl-41-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-41-25>25</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kt>void</span> <span class=nf>doStartThread</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>thread</span> <span class=o>==</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>executor</span><span class=o>.</span><span class=na>execute</span><span class=o>(</span><span class=k>new</span> <span class=n>Runnable</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// å°†çº¿ç¨‹æ± çš„å½“å‰çº¿ç¨‹ä¿å­˜åœ¨æˆå‘˜å˜é‡ä¸­ï¼Œä»¥ä¾¿åç»­ä½¿ç”¨
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>thread</span> <span class=o>=</span> <span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>interrupted</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>thread</span><span class=o>.</span><span class=na>interrupt</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=kt>boolean</span> <span class=n>success</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>updateLastExecutionTime</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// è°ƒç”¨å¤–éƒ¨ç±» SingleThreadEventExecutor çš„ run æ–¹æ³•ï¼Œè¿›å…¥æ­»å¾ªç¯ï¼Œrun æ–¹æ³•è§ä¸‹
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>SingleThreadEventExecutor</span><span class=o>.</span><span class=na>this</span><span class=o>.</span><span class=na>run</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=n>success</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Throwable</span> <span class=n>t</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>logger</span><span class=o>.</span><span class=na>warn</span><span class=o>(</span><span class=s>&#34;Unexpected exception from an event executor: &#34;</span><span class=o>,</span> <span class=n>t</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>				<span class=c1>// æ¸…ç†å·¥ä½œï¼Œä»£ç ç•¥...
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>});</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>io.netty.channel.nio.NioEventLoop#run</code> ä¸»è¦ä»»åŠ¡æ˜¯æ‰§è¡Œæ­»å¾ªç¯ï¼Œä¸æ–­çœ‹æœ‰æ²¡æœ‰æ–°ä»»åŠ¡ï¼Œæœ‰æ²¡æœ‰ IO äº‹ä»¶</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-42-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-1> 1</a>
</span><span class=lnt id=hl-42-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-2> 2</a>
</span><span class=lnt id=hl-42-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-3> 3</a>
</span><span class=lnt id=hl-42-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-4> 4</a>
</span><span class=lnt id=hl-42-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-5> 5</a>
</span><span class=lnt id=hl-42-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-6> 6</a>
</span><span class=lnt id=hl-42-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-7> 7</a>
</span><span class=lnt id=hl-42-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-8> 8</a>
</span><span class=lnt id=hl-42-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-9> 9</a>
</span><span class=lnt id=hl-42-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-10>10</a>
</span><span class=lnt id=hl-42-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-11>11</a>
</span><span class=lnt id=hl-42-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-12>12</a>
</span><span class=lnt id=hl-42-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-13>13</a>
</span><span class=lnt id=hl-42-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-14>14</a>
</span><span class=lnt id=hl-42-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-15>15</a>
</span><span class=lnt id=hl-42-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-16>16</a>
</span><span class=lnt id=hl-42-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-17>17</a>
</span><span class=lnt id=hl-42-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-18>18</a>
</span><span class=lnt id=hl-42-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-19>19</a>
</span><span class=lnt id=hl-42-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-20>20</a>
</span><span class=lnt id=hl-42-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-21>21</a>
</span><span class=lnt id=hl-42-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-22>22</a>
</span><span class=lnt id=hl-42-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-23>23</a>
</span><span class=lnt id=hl-42-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-24>24</a>
</span><span class=lnt id=hl-42-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-25>25</a>
</span><span class=lnt id=hl-42-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-26>26</a>
</span><span class=lnt id=hl-42-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-27>27</a>
</span><span class=lnt id=hl-42-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-28>28</a>
</span><span class=lnt id=hl-42-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-29>29</a>
</span><span class=lnt id=hl-42-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-30>30</a>
</span><span class=lnt id=hl-42-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-31>31</a>
</span><span class=lnt id=hl-42-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-32>32</a>
</span><span class=lnt id=hl-42-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-33>33</a>
</span><span class=lnt id=hl-42-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-34>34</a>
</span><span class=lnt id=hl-42-35><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-35>35</a>
</span><span class=lnt id=hl-42-36><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-36>36</a>
</span><span class=lnt id=hl-42-37><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-37>37</a>
</span><span class=lnt id=hl-42-38><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-38>38</a>
</span><span class=lnt id=hl-42-39><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-39>39</a>
</span><span class=lnt id=hl-42-40><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-40>40</a>
</span><span class=lnt id=hl-42-41><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-41>41</a>
</span><span class=lnt id=hl-42-42><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-42>42</a>
</span><span class=lnt id=hl-42-43><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-43>43</a>
</span><span class=lnt id=hl-42-44><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-44>44</a>
</span><span class=lnt id=hl-42-45><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-45>45</a>
</span><span class=lnt id=hl-42-46><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-46>46</a>
</span><span class=lnt id=hl-42-47><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-47>47</a>
</span><span class=lnt id=hl-42-48><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-48>48</a>
</span><span class=lnt id=hl-42-49><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-49>49</a>
</span><span class=lnt id=hl-42-50><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-50>50</a>
</span><span class=lnt id=hl-42-51><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-51>51</a>
</span><span class=lnt id=hl-42-52><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-52>52</a>
</span><span class=lnt id=hl-42-53><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-53>53</a>
</span><span class=lnt id=hl-42-54><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-54>54</a>
</span><span class=lnt id=hl-42-55><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-55>55</a>
</span><span class=lnt id=hl-42-56><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-56>56</a>
</span><span class=lnt id=hl-42-57><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-57>57</a>
</span><span class=lnt id=hl-42-58><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-58>58</a>
</span><span class=lnt id=hl-42-59><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-59>59</a>
</span><span class=lnt id=hl-42-60><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-60>60</a>
</span><span class=lnt id=hl-42-61><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-61>61</a>
</span><span class=lnt id=hl-42-62><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-62>62</a>
</span><span class=lnt id=hl-42-63><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-63>63</a>
</span><span class=lnt id=hl-42-64><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-64>64</a>
</span><span class=lnt id=hl-42-65><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-65>65</a>
</span><span class=lnt id=hl-42-66><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-66>66</a>
</span><span class=lnt id=hl-42-67><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-67>67</a>
</span><span class=lnt id=hl-42-68><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-68>68</a>
</span><span class=lnt id=hl-42-69><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-69>69</a>
</span><span class=lnt id=hl-42-70><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-70>70</a>
</span><span class=lnt id=hl-42-71><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-71>71</a>
</span><span class=lnt id=hl-42-72><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-72>72</a>
</span><span class=lnt id=hl-42-73><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-73>73</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>protected</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=o>(;;)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// calculateStrategy çš„é€»è¾‘å¦‚ä¸‹ï¼š
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=c1>// æœ‰ä»»åŠ¡ï¼Œä¼šæ‰§è¡Œä¸€æ¬¡ selectNowï¼Œæ¸…é™¤ä¸Šä¸€æ¬¡çš„ wakeup ç»“æœï¼Œæ— è®ºæœ‰æ²¡æœ‰ IO äº‹ä»¶ï¼Œéƒ½ä¼šè·³è¿‡ switch
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=c1>// æ²¡æœ‰ä»»åŠ¡ï¼Œä¼šåŒ¹é… SelectStrategy.SELECTï¼Œçœ‹æ˜¯å¦åº”å½“é˜»å¡
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=k>switch</span> <span class=o>(</span><span class=n>selectStrategy</span><span class=o>.</span><span class=na>calculateStrategy</span><span class=o>(</span><span class=n>selectNowSupplier</span><span class=o>,</span> <span class=n>hasTasks</span><span class=o>()))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>case</span> <span class=n>SelectStrategy</span><span class=o>.</span><span class=na>CONTINUE</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                        <span class=k>continue</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                    <span class=k>case</span> <span class=n>SelectStrategy</span><span class=o>.</span><span class=na>BUSY_WAIT</span><span class=o>:</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                    <span class=k>case</span> <span class=n>SelectStrategy</span><span class=o>.</span><span class=na>SELECT</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                        <span class=c1>// å› ä¸º IO çº¿ç¨‹å’Œæäº¤ä»»åŠ¡çº¿ç¨‹éƒ½æœ‰å¯èƒ½æ‰§è¡Œ wakeupï¼Œè€Œ wakeup å±äºæ¯”è¾ƒæ˜‚è´µçš„æ“ä½œï¼Œå› æ­¤ä½¿ç”¨äº†ä¸€ä¸ªåŸå­å¸ƒå°”å¯¹è±¡ wakenUpï¼Œå®ƒå–å€¼ä¸º true æ—¶ï¼Œè¡¨ç¤ºè¯¥ç”±å½“å‰çº¿ç¨‹å”¤é†’
</span></span></span><span class=line><span class=cl><span class=c1></span>                        <span class=c1>// è¿›è¡Œ select é˜»å¡ï¼Œå¹¶è®¾ç½®å”¤é†’çŠ¶æ€ä¸º false
</span></span></span><span class=line><span class=cl><span class=c1></span>                        <span class=kt>boolean</span> <span class=n>oldWakenUp</span> <span class=o>=</span> <span class=n>wakenUp</span><span class=o>.</span><span class=na>getAndSet</span><span class=o>(</span><span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                        
</span></span><span class=line><span class=cl>                        <span class=c1>// å¦‚æœåœ¨è¿™ä¸ªä½ç½®ï¼Œé EventLoop çº¿ç¨‹æŠ¢å…ˆå°† wakenUp ç½®ä¸º trueï¼Œå¹¶ wakeup
</span></span></span><span class=line><span class=cl><span class=c1></span>                        <span class=c1>// ä¸‹é¢çš„ select æ–¹æ³•ä¸ä¼šé˜»å¡
</span></span></span><span class=line><span class=cl><span class=c1></span>                        <span class=c1>// ç­‰ runAllTasks å¤„ç†å®Œæˆåï¼Œåˆ°å†å¾ªç¯è¿›æ¥è¿™ä¸ªé˜¶æ®µæ–°å¢çš„ä»»åŠ¡ä¼šä¸ä¼šåŠæ—¶æ‰§è¡Œå‘¢?
</span></span></span><span class=line><span class=cl><span class=c1></span>                        <span class=c1>// å› ä¸º oldWakenUp ä¸º trueï¼Œå› æ­¤ä¸‹é¢çš„ select æ–¹æ³•å°±ä¼šé˜»å¡ï¼Œç›´åˆ°è¶…æ—¶
</span></span></span><span class=line><span class=cl><span class=c1></span>                        <span class=c1>// æ‰èƒ½æ‰§è¡Œï¼Œè®© select æ–¹æ³•æ— è°“é˜»å¡
</span></span></span><span class=line><span class=cl><span class=c1></span>                        <span class=n>select</span><span class=o>(</span><span class=n>oldWakenUp</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                        <span class=k>if</span> <span class=o>(</span><span class=n>wakenUp</span><span class=o>.</span><span class=na>get</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                            <span class=n>selector</span><span class=o>.</span><span class=na>wakeup</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                        <span class=o>}</span>
</span></span><span class=line><span class=cl>                    <span class=k>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>rebuildSelector0</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=n>handleLoopException</span><span class=o>(</span><span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=k>continue</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>cancelledKeys</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>needsToSelectAgain</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=c1>// ioRatio é»˜è®¤æ˜¯ 50
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=kd>final</span> <span class=kt>int</span> <span class=n>ioRatio</span> <span class=o>=</span> <span class=k>this</span><span class=o>.</span><span class=na>ioRatio</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>ioRatio</span> <span class=o>==</span> <span class=n>100</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>processSelectedKeys</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=c1>// ioRatio ä¸º 100 æ—¶ï¼Œæ€»æ˜¯è¿è¡Œå®Œæ‰€æœ‰é IO ä»»åŠ¡
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=n>runAllTasks</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>                
</span></span><span class=line><span class=cl>                <span class=kd>final</span> <span class=kt>long</span> <span class=n>ioStartTime</span> <span class=o>=</span> <span class=n>System</span><span class=o>.</span><span class=na>nanoTime</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>processSelectedKeys</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=c1>// è®°å½• io äº‹ä»¶å¤„ç†è€—æ—¶
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=kd>final</span> <span class=kt>long</span> <span class=n>ioTime</span> <span class=o>=</span> <span class=n>System</span><span class=o>.</span><span class=na>nanoTime</span><span class=o>()</span> <span class=o>-</span> <span class=n>ioStartTime</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                    <span class=c1>// è¿è¡Œé IO ä»»åŠ¡ï¼Œä¸€æ—¦è¶…æ—¶ä¼šé€€å‡º runAllTasks
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=n>runAllTasks</span><span class=o>(</span><span class=n>ioTime</span> <span class=o>*</span> <span class=o>(</span><span class=n>100</span> <span class=o>-</span> <span class=n>ioRatio</span><span class=o>)</span> <span class=o>/</span> <span class=n>ioRatio</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Throwable</span> <span class=n>t</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>handleLoopException</span><span class=o>(</span><span class=n>t</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>isShuttingDown</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>closeAll</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>confirmShutdown</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Throwable</span> <span class=n>t</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>handleLoopException</span><span class=o>(</span><span class=n>t</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#-æ³¨æ„><h4 id=-æ³¨æ„><span class=hanchor arialabel=Anchor># </span>âš ï¸ æ³¨æ„</h4></a><blockquote><p>è¿™é‡Œæœ‰ä¸ªè´¹è§£çš„åœ°æ–¹å°±æ˜¯ wakeupï¼Œå®ƒæ—¢å¯ä»¥ç”±æäº¤ä»»åŠ¡çš„çº¿ç¨‹æ¥è°ƒç”¨ï¼ˆæ¯”è¾ƒå¥½ç†è§£ï¼‰ï¼Œä¹Ÿå¯ä»¥ç”± EventLoop çº¿ç¨‹æ¥è°ƒç”¨ï¼ˆæ¯”è¾ƒè´¹è§£ï¼‰ï¼Œè¿™é‡Œè¦çŸ¥é“ wakeup æ–¹æ³•çš„æ•ˆæœï¼š</p><ul><li>ç”±é EventLoop çº¿ç¨‹è°ƒç”¨ï¼Œä¼šå”¤é†’å½“å‰åœ¨æ‰§è¡Œ select é˜»å¡çš„ EventLoop çº¿ç¨‹</li><li>ç”± EventLoop è‡ªå·±è°ƒç”¨ï¼Œä¼šæœ¬æ¬¡çš„ wakeup ä¼šå–æ¶ˆä¸‹ä¸€æ¬¡çš„ select æ“ä½œ</li></ul></blockquote><p>å‚è€ƒä¸‹å›¾</p><p><img src=/z-oblib/z2-attachments/0032.png width=auto></p><p><code>io.netty.channel.nio.NioEventLoop#select</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-43-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-1> 1</a>
</span><span class=lnt id=hl-43-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-2> 2</a>
</span><span class=lnt id=hl-43-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-3> 3</a>
</span><span class=lnt id=hl-43-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-4> 4</a>
</span><span class=lnt id=hl-43-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-5> 5</a>
</span><span class=lnt id=hl-43-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-6> 6</a>
</span><span class=lnt id=hl-43-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-7> 7</a>
</span><span class=lnt id=hl-43-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-8> 8</a>
</span><span class=lnt id=hl-43-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-9> 9</a>
</span><span class=lnt id=hl-43-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-10>10</a>
</span><span class=lnt id=hl-43-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-11>11</a>
</span><span class=lnt id=hl-43-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-12>12</a>
</span><span class=lnt id=hl-43-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-13>13</a>
</span><span class=lnt id=hl-43-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-14>14</a>
</span><span class=lnt id=hl-43-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-15>15</a>
</span><span class=lnt id=hl-43-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-16>16</a>
</span><span class=lnt id=hl-43-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-17>17</a>
</span><span class=lnt id=hl-43-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-18>18</a>
</span><span class=lnt id=hl-43-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-19>19</a>
</span><span class=lnt id=hl-43-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-20>20</a>
</span><span class=lnt id=hl-43-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-21>21</a>
</span><span class=lnt id=hl-43-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-22>22</a>
</span><span class=lnt id=hl-43-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-23>23</a>
</span><span class=lnt id=hl-43-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-24>24</a>
</span><span class=lnt id=hl-43-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-25>25</a>
</span><span class=lnt id=hl-43-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-26>26</a>
</span><span class=lnt id=hl-43-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-27>27</a>
</span><span class=lnt id=hl-43-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-28>28</a>
</span><span class=lnt id=hl-43-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-29>29</a>
</span><span class=lnt id=hl-43-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-30>30</a>
</span><span class=lnt id=hl-43-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-31>31</a>
</span><span class=lnt id=hl-43-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-32>32</a>
</span><span class=lnt id=hl-43-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-33>33</a>
</span><span class=lnt id=hl-43-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-34>34</a>
</span><span class=lnt id=hl-43-35><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-35>35</a>
</span><span class=lnt id=hl-43-36><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-36>36</a>
</span><span class=lnt id=hl-43-37><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-37>37</a>
</span><span class=lnt id=hl-43-38><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-38>38</a>
</span><span class=lnt id=hl-43-39><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-39>39</a>
</span><span class=lnt id=hl-43-40><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-40>40</a>
</span><span class=lnt id=hl-43-41><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-41>41</a>
</span><span class=lnt id=hl-43-42><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-42>42</a>
</span><span class=lnt id=hl-43-43><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-43>43</a>
</span><span class=lnt id=hl-43-44><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-44>44</a>
</span><span class=lnt id=hl-43-45><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-45>45</a>
</span><span class=lnt id=hl-43-46><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-46>46</a>
</span><span class=lnt id=hl-43-47><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-47>47</a>
</span><span class=lnt id=hl-43-48><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-48>48</a>
</span><span class=lnt id=hl-43-49><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-49>49</a>
</span><span class=lnt id=hl-43-50><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-50>50</a>
</span><span class=lnt id=hl-43-51><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-51>51</a>
</span><span class=lnt id=hl-43-52><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-52>52</a>
</span><span class=lnt id=hl-43-53><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-53>53</a>
</span><span class=lnt id=hl-43-54><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-54>54</a>
</span><span class=lnt id=hl-43-55><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-55>55</a>
</span><span class=lnt id=hl-43-56><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-56>56</a>
</span><span class=lnt id=hl-43-57><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-57>57</a>
</span><span class=lnt id=hl-43-58><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-58>58</a>
</span><span class=lnt id=hl-43-59><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-59>59</a>
</span><span class=lnt id=hl-43-60><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-60>60</a>
</span><span class=lnt id=hl-43-61><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-61>61</a>
</span><span class=lnt id=hl-43-62><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-62>62</a>
</span><span class=lnt id=hl-43-63><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-63>63</a>
</span><span class=lnt id=hl-43-64><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-64>64</a>
</span><span class=lnt id=hl-43-65><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-65>65</a>
</span><span class=lnt id=hl-43-66><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-66>66</a>
</span><span class=lnt id=hl-43-67><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-67>67</a>
</span><span class=lnt id=hl-43-68><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-68>68</a>
</span><span class=lnt id=hl-43-69><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-69>69</a>
</span><span class=lnt id=hl-43-70><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-70>70</a>
</span><span class=lnt id=hl-43-71><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-71>71</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kt>void</span> <span class=nf>select</span><span class=o>(</span><span class=kt>boolean</span> <span class=n>oldWakenUp</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Selector</span> <span class=n>selector</span> <span class=o>=</span> <span class=k>this</span><span class=o>.</span><span class=na>selector</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>selectCnt</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=kt>long</span> <span class=n>currentTimeNanos</span> <span class=o>=</span> <span class=n>System</span><span class=o>.</span><span class=na>nanoTime</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=c1>// è®¡ç®—ç­‰å¾…æ—¶é—´
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// * æ²¡æœ‰ scheduledTaskï¼Œè¶…æ—¶æ—¶é—´ä¸º 1s
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// * æœ‰ scheduledTaskï¼Œè¶…æ—¶æ—¶é—´ä¸º `ä¸‹ä¸€ä¸ªå®šæ—¶ä»»åŠ¡æ‰§è¡Œæ—¶é—´ - å½“å‰æ—¶é—´`
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kt>long</span> <span class=n>selectDeadLineNanos</span> <span class=o>=</span> <span class=n>currentTimeNanos</span> <span class=o>+</span> <span class=n>delayNanos</span><span class=o>(</span><span class=n>currentTimeNanos</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=o>(;;)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=kt>long</span> <span class=n>timeoutMillis</span> <span class=o>=</span> <span class=o>(</span><span class=n>selectDeadLineNanos</span> <span class=o>-</span> <span class=n>currentTimeNanos</span> <span class=o>+</span> <span class=n>500000L</span><span class=o>)</span> <span class=o>/</span> <span class=n>1000000L</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=c1>// å¦‚æœè¶…æ—¶ï¼Œé€€å‡ºå¾ªç¯
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>if</span> <span class=o>(</span><span class=n>timeoutMillis</span> <span class=o>&lt;=</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>selectCnt</span> <span class=o>==</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>selector</span><span class=o>.</span><span class=na>selectNow</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                    <span class=n>selectCnt</span> <span class=o>=</span> <span class=n>1</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1>// å¦‚æœæœŸé—´åˆæœ‰ task é€€å‡ºå¾ªç¯ï¼Œå¦‚æœæ²¡è¿™ä¸ªåˆ¤æ–­ï¼Œé‚£ä¹ˆä»»åŠ¡å°±ä¼šç­‰åˆ°ä¸‹æ¬¡ select è¶…æ—¶æ—¶æ‰èƒ½è¢«æ‰§è¡Œ
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// wakenUp.compareAndSet(false, true) æ˜¯è®©é NioEventLoop ä¸å¿…å†æ‰§è¡Œ wakeup
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>if</span> <span class=o>(</span><span class=n>hasTasks</span><span class=o>()</span> <span class=o>&amp;&amp;</span> <span class=n>wakenUp</span><span class=o>.</span><span class=na>compareAndSet</span><span class=o>(</span><span class=kc>false</span><span class=o>,</span> <span class=kc>true</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>selector</span><span class=o>.</span><span class=na>selectNow</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=n>selectCnt</span> <span class=o>=</span> <span class=n>1</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1>// select æœ‰é™æ—¶é˜»å¡
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// æ³¨æ„ nio æœ‰ bugï¼Œå½“ bug å‡ºç°æ—¶ï¼Œselect æ–¹æ³•å³ä½¿æ²¡æœ‰æ—¶é—´å‘ç”Ÿï¼Œä¹Ÿä¸ä¼šé˜»å¡ä½ï¼Œå¯¼è‡´ä¸æ–­ç©ºè½®è¯¢ï¼Œcpu å ç”¨ 100%
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=kt>int</span> <span class=n>selectedKeys</span> <span class=o>=</span> <span class=n>selector</span><span class=o>.</span><span class=na>select</span><span class=o>(</span><span class=n>timeoutMillis</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=c1>// è®¡æ•°åŠ  1
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>selectCnt</span> <span class=o>++;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1>// é†’æ¥åï¼Œå¦‚æœæœ‰ IO äº‹ä»¶ã€æˆ–æ˜¯ç”±é EventLoop çº¿ç¨‹å”¤é†’ï¼Œæˆ–è€…æœ‰ä»»åŠ¡ï¼Œé€€å‡ºå¾ªç¯
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>if</span> <span class=o>(</span><span class=n>selectedKeys</span> <span class=o>!=</span> <span class=n>0</span> <span class=o>||</span> <span class=n>oldWakenUp</span> <span class=o>||</span> <span class=n>wakenUp</span><span class=o>.</span><span class=na>get</span><span class=o>()</span> <span class=o>||</span> <span class=n>hasTasks</span><span class=o>()</span> <span class=o>||</span> <span class=n>hasScheduledTasks</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>Thread</span><span class=o>.</span><span class=na>interrupted</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>               	<span class=c1>// çº¿ç¨‹è¢«æ‰“æ–­ï¼Œé€€å‡ºå¾ªç¯
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=c1>// è®°å½•æ—¥å¿—
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>selectCnt</span> <span class=o>=</span> <span class=n>1</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=kt>long</span> <span class=n>time</span> <span class=o>=</span> <span class=n>System</span><span class=o>.</span><span class=na>nanoTime</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>time</span> <span class=o>-</span> <span class=n>TimeUnit</span><span class=o>.</span><span class=na>MILLISECONDS</span><span class=o>.</span><span class=na>toNanos</span><span class=o>(</span><span class=n>timeoutMillis</span><span class=o>)</span> <span class=o>&gt;=</span> <span class=n>currentTimeNanos</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// å¦‚æœè¶…æ—¶ï¼Œè®¡æ•°é‡ç½®ä¸º 1ï¼Œä¸‹æ¬¡å¾ªç¯å°±ä¼š break
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>selectCnt</span> <span class=o>=</span> <span class=n>1</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> 
</span></span><span class=line><span class=cl>            <span class=c1>// è®¡æ•°è¶…è¿‡é˜ˆå€¼ï¼Œç”± io.netty.selectorAutoRebuildThreshold æŒ‡å®šï¼Œé»˜è®¤ 512
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// è¿™æ˜¯ä¸ºäº†è§£å†³ nio ç©ºè½®è¯¢ bug
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>SELECTOR_AUTO_REBUILD_THRESHOLD</span> <span class=o>&gt;</span> <span class=n>0</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>                    <span class=n>selectCnt</span> <span class=o>&gt;=</span> <span class=n>SELECTOR_AUTO_REBUILD_THRESHOLD</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// é‡å»º selector
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>selector</span> <span class=o>=</span> <span class=n>selectRebuildSelector</span><span class=o>(</span><span class=n>selectCnt</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=n>selectCnt</span> <span class=o>=</span> <span class=n>1</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>currentTimeNanos</span> <span class=o>=</span> <span class=n>time</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>selectCnt</span> <span class=o>&gt;</span> <span class=n>MIN_PREMATURE_SELECTOR_RETURNS</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// è®°å½•æ—¥å¿—
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>CancelledKeyException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// è®°å½•æ—¥å¿—
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å¤„ç† keys <code>io.netty.channel.nio.NioEventLoop#processSelectedKeys</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-44-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-44-1>1</a>
</span><span class=lnt id=hl-44-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-44-2>2</a>
</span><span class=lnt id=hl-44-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-44-3>3</a>
</span><span class=lnt id=hl-44-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-44-4>4</a>
</span><span class=lnt id=hl-44-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-44-5>5</a>
</span><span class=lnt id=hl-44-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-44-6>6</a>
</span><span class=lnt id=hl-44-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-44-7>7</a>
</span><span class=lnt id=hl-44-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-44-8>8</a>
</span><span class=lnt id=hl-44-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-44-9>9</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kt>void</span> <span class=nf>processSelectedKeys</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>selectedKeys</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// é€šè¿‡åå°„å°† Selector å®ç°ç±»ä¸­çš„å°±ç»ªäº‹ä»¶é›†åˆæ›¿æ¢ä¸º SelectedSelectionKeySet 
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// SelectedSelectionKeySet åº•å±‚ä¸ºæ•°ç»„å®ç°ï¼Œå¯ä»¥æé«˜éå†æ€§èƒ½ï¼ˆåŸæœ¬ä¸º HashSetï¼‰
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>processSelectedKeysOptimized</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>processSelectedKeysPlain</span><span class=o>(</span><span class=n>selector</span><span class=o>.</span><span class=na>selectedKeys</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>io.netty.channel.nio.NioEventLoop#processSelectedKey</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-45-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-45-1> 1</a>
</span><span class=lnt id=hl-45-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-45-2> 2</a>
</span><span class=lnt id=hl-45-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-45-3> 3</a>
</span><span class=lnt id=hl-45-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-45-4> 4</a>
</span><span class=lnt id=hl-45-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-45-5> 5</a>
</span><span class=lnt id=hl-45-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-45-6> 6</a>
</span><span class=lnt id=hl-45-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-45-7> 7</a>
</span><span class=lnt id=hl-45-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-45-8> 8</a>
</span><span class=lnt id=hl-45-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-45-9> 9</a>
</span><span class=lnt id=hl-45-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-45-10>10</a>
</span><span class=lnt id=hl-45-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-45-11>11</a>
</span><span class=lnt id=hl-45-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-45-12>12</a>
</span><span class=lnt id=hl-45-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-45-13>13</a>
</span><span class=lnt id=hl-45-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-45-14>14</a>
</span><span class=lnt id=hl-45-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-45-15>15</a>
</span><span class=lnt id=hl-45-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-45-16>16</a>
</span><span class=lnt id=hl-45-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-45-17>17</a>
</span><span class=lnt id=hl-45-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-45-18>18</a>
</span><span class=lnt id=hl-45-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-45-19>19</a>
</span><span class=lnt id=hl-45-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-45-20>20</a>
</span><span class=lnt id=hl-45-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-45-21>21</a>
</span><span class=lnt id=hl-45-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-45-22>22</a>
</span><span class=lnt id=hl-45-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-45-23>23</a>
</span><span class=lnt id=hl-45-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-45-24>24</a>
</span><span class=lnt id=hl-45-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-45-25>25</a>
</span><span class=lnt id=hl-45-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-45-26>26</a>
</span><span class=lnt id=hl-45-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-45-27>27</a>
</span><span class=lnt id=hl-45-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-45-28>28</a>
</span><span class=lnt id=hl-45-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-45-29>29</a>
</span><span class=lnt id=hl-45-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-45-30>30</a>
</span><span class=lnt id=hl-45-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-45-31>31</a>
</span><span class=lnt id=hl-45-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-45-32>32</a>
</span><span class=lnt id=hl-45-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-45-33>33</a>
</span><span class=lnt id=hl-45-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-45-34>34</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kt>void</span> <span class=nf>processSelectedKey</span><span class=o>(</span><span class=n>SelectionKey</span> <span class=n>k</span><span class=o>,</span> <span class=n>AbstractNioChannel</span> <span class=n>ch</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=n>AbstractNioChannel</span><span class=o>.</span><span class=na>NioUnsafe</span> <span class=n>unsafe</span> <span class=o>=</span> <span class=n>ch</span><span class=o>.</span><span class=na>unsafe</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=c1>// å½“ key å–æ¶ˆæˆ–å…³é—­æ—¶ä¼šå¯¼è‡´è¿™ä¸ª key æ— æ•ˆ
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>(!</span><span class=n>k</span><span class=o>.</span><span class=na>isValid</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// æ— æ•ˆæ—¶å¤„ç†...
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>readyOps</span> <span class=o>=</span> <span class=n>k</span><span class=o>.</span><span class=na>readyOps</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=c1>// è¿æ¥äº‹ä»¶
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=o>((</span><span class=n>readyOps</span> <span class=o>&amp;</span> <span class=n>SelectionKey</span><span class=o>.</span><span class=na>OP_CONNECT</span><span class=o>)</span> <span class=o>!=</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=kt>int</span> <span class=n>ops</span> <span class=o>=</span> <span class=n>k</span><span class=o>.</span><span class=na>interestOps</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>ops</span> <span class=o>&amp;=</span> <span class=o>~</span><span class=n>SelectionKey</span><span class=o>.</span><span class=na>OP_CONNECT</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>k</span><span class=o>.</span><span class=na>interestOps</span><span class=o>(</span><span class=n>ops</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>unsafe</span><span class=o>.</span><span class=na>finishConnect</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// å¯å†™äº‹ä»¶
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=o>((</span><span class=n>readyOps</span> <span class=o>&amp;</span> <span class=n>SelectionKey</span><span class=o>.</span><span class=na>OP_WRITE</span><span class=o>)</span> <span class=o>!=</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>ch</span><span class=o>.</span><span class=na>unsafe</span><span class=o>().</span><span class=na>forceFlush</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// å¯è¯»æˆ–å¯æ¥å…¥äº‹ä»¶
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=o>((</span><span class=n>readyOps</span> <span class=o>&amp;</span> <span class=o>(</span><span class=n>SelectionKey</span><span class=o>.</span><span class=na>OP_READ</span> <span class=o>|</span> <span class=n>SelectionKey</span><span class=o>.</span><span class=na>OP_ACCEPT</span><span class=o>))</span> <span class=o>!=</span> <span class=n>0</span> <span class=o>||</span> <span class=n>readyOps</span> <span class=o>==</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// å¦‚æœæ˜¯å¯æ¥å…¥ io.netty.channel.nio.AbstractNioMessageChannel.NioMessageUnsafe#read
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// å¦‚æœæ˜¯å¯è¯» io.netty.channel.nio.AbstractNioByteChannel.NioByteUnsafe#read
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>unsafe</span><span class=o>.</span><span class=na>read</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>CancelledKeyException</span> <span class=n>ignored</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>unsafe</span><span class=o>.</span><span class=na>close</span><span class=o>(</span><span class=n>unsafe</span><span class=o>.</span><span class=na>voidPromise</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#23-accept-å‰–æ><h3 id=23-accept-å‰–æ><span class=hanchor arialabel=Anchor># </span>2.3 accept å‰–æ</h3></a><p>nio ä¸­å¦‚ä¸‹ä»£ç ï¼Œåœ¨ netty ä¸­çš„æµç¨‹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-46-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-46-1> 1</a>
</span><span class=lnt id=hl-46-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-46-2> 2</a>
</span><span class=lnt id=hl-46-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-46-3> 3</a>
</span><span class=lnt id=hl-46-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-46-4> 4</a>
</span><span class=lnt id=hl-46-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-46-5> 5</a>
</span><span class=lnt id=hl-46-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-46-6> 6</a>
</span><span class=lnt id=hl-46-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-46-7> 7</a>
</span><span class=lnt id=hl-46-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-46-8> 8</a>
</span><span class=lnt id=hl-46-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-46-9> 9</a>
</span><span class=lnt id=hl-46-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-46-10>10</a>
</span><span class=lnt id=hl-46-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-46-11>11</a>
</span><span class=lnt id=hl-46-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-46-12>12</a>
</span><span class=lnt id=hl-46-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-46-13>13</a>
</span><span class=lnt id=hl-46-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-46-14>14</a>
</span><span class=lnt id=hl-46-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-46-15>15</a>
</span><span class=lnt id=hl-46-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-46-16>16</a>
</span><span class=lnt id=hl-46-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-46-17>17</a>
</span><span class=lnt id=hl-46-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-46-18>18</a>
</span><span class=lnt id=hl-46-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-46-19>19</a>
</span><span class=lnt id=hl-46-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-46-20>20</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>//1 é˜»å¡ç›´åˆ°äº‹ä»¶å‘ç”Ÿ
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>selector</span><span class=o>.</span><span class=na>select</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Iterator</span><span class=o>&lt;</span><span class=n>SelectionKey</span><span class=o>&gt;</span> <span class=n>iter</span> <span class=o>=</span> <span class=n>selector</span><span class=o>.</span><span class=na>selectedKeys</span><span class=o>().</span><span class=na>iterator</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=k>while</span> <span class=o>(</span><span class=n>iter</span><span class=o>.</span><span class=na>hasNext</span><span class=o>())</span> <span class=o>{</span>    
</span></span><span class=line><span class=cl>    <span class=c1>//2 æ‹¿åˆ°ä¸€ä¸ªäº‹ä»¶
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>SelectionKey</span> <span class=n>key</span> <span class=o>=</span> <span class=n>iter</span><span class=o>.</span><span class=na>next</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>//3 å¦‚æœæ˜¯ accept äº‹ä»¶
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>(</span><span class=n>key</span><span class=o>.</span><span class=na>isAcceptable</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1>//4 æ‰§è¡Œ accept
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>SocketChannel</span> <span class=n>channel</span> <span class=o>=</span> <span class=n>serverSocketChannel</span><span class=o>.</span><span class=na>accept</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>channel</span><span class=o>.</span><span class=na>configureBlocking</span><span class=o>(</span><span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1>//5 å…³æ³¨ read äº‹ä»¶
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>channel</span><span class=o>.</span><span class=na>register</span><span class=o>(</span><span class=n>selector</span><span class=o>,</span> <span class=n>SelectionKey</span><span class=o>.</span><span class=na>OP_READ</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å…ˆæ¥çœ‹å¯æ¥å…¥äº‹ä»¶å¤„ç†ï¼ˆacceptï¼‰</p><p><code>io.netty.channel.nio.AbstractNioMessageChannel.NioMessageUnsafe#read</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-47-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-47-1> 1</a>
</span><span class=lnt id=hl-47-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-47-2> 2</a>
</span><span class=lnt id=hl-47-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-47-3> 3</a>
</span><span class=lnt id=hl-47-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-47-4> 4</a>
</span><span class=lnt id=hl-47-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-47-5> 5</a>
</span><span class=lnt id=hl-47-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-47-6> 6</a>
</span><span class=lnt id=hl-47-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-47-7> 7</a>
</span><span class=lnt id=hl-47-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-47-8> 8</a>
</span><span class=lnt id=hl-47-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-47-9> 9</a>
</span><span class=lnt id=hl-47-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-47-10>10</a>
</span><span class=lnt id=hl-47-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-47-11>11</a>
</span><span class=lnt id=hl-47-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-47-12>12</a>
</span><span class=lnt id=hl-47-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-47-13>13</a>
</span><span class=lnt id=hl-47-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-47-14>14</a>
</span><span class=lnt id=hl-47-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-47-15>15</a>
</span><span class=lnt id=hl-47-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-47-16>16</a>
</span><span class=lnt id=hl-47-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-47-17>17</a>
</span><span class=lnt id=hl-47-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-47-18>18</a>
</span><span class=lnt id=hl-47-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-47-19>19</a>
</span><span class=lnt id=hl-47-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-47-20>20</a>
</span><span class=lnt id=hl-47-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-47-21>21</a>
</span><span class=lnt id=hl-47-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-47-22>22</a>
</span><span class=lnt id=hl-47-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-47-23>23</a>
</span><span class=lnt id=hl-47-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-47-24>24</a>
</span><span class=lnt id=hl-47-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-47-25>25</a>
</span><span class=lnt id=hl-47-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-47-26>26</a>
</span><span class=lnt id=hl-47-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-47-27>27</a>
</span><span class=lnt id=hl-47-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-47-28>28</a>
</span><span class=lnt id=hl-47-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-47-29>29</a>
</span><span class=lnt id=hl-47-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-47-30>30</a>
</span><span class=lnt id=hl-47-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-47-31>31</a>
</span><span class=lnt id=hl-47-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-47-32>32</a>
</span><span class=lnt id=hl-47-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-47-33>33</a>
</span><span class=lnt id=hl-47-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-47-34>34</a>
</span><span class=lnt id=hl-47-35><a style=outline:none;text-decoration:none;color:inherit href=#hl-47-35>35</a>
</span><span class=lnt id=hl-47-36><a style=outline:none;text-decoration:none;color:inherit href=#hl-47-36>36</a>
</span><span class=lnt id=hl-47-37><a style=outline:none;text-decoration:none;color:inherit href=#hl-47-37>37</a>
</span><span class=lnt id=hl-47-38><a style=outline:none;text-decoration:none;color:inherit href=#hl-47-38>38</a>
</span><span class=lnt id=hl-47-39><a style=outline:none;text-decoration:none;color:inherit href=#hl-47-39>39</a>
</span><span class=lnt id=hl-47-40><a style=outline:none;text-decoration:none;color:inherit href=#hl-47-40>40</a>
</span><span class=lnt id=hl-47-41><a style=outline:none;text-decoration:none;color:inherit href=#hl-47-41>41</a>
</span><span class=lnt id=hl-47-42><a style=outline:none;text-decoration:none;color:inherit href=#hl-47-42>42</a>
</span><span class=lnt id=hl-47-43><a style=outline:none;text-decoration:none;color:inherit href=#hl-47-43>43</a>
</span><span class=lnt id=hl-47-44><a style=outline:none;text-decoration:none;color:inherit href=#hl-47-44>44</a>
</span><span class=lnt id=hl-47-45><a style=outline:none;text-decoration:none;color:inherit href=#hl-47-45>45</a>
</span><span class=lnt id=hl-47-46><a style=outline:none;text-decoration:none;color:inherit href=#hl-47-46>46</a>
</span><span class=lnt id=hl-47-47><a style=outline:none;text-decoration:none;color:inherit href=#hl-47-47>47</a>
</span><span class=lnt id=hl-47-48><a style=outline:none;text-decoration:none;color:inherit href=#hl-47-48>48</a>
</span><span class=lnt id=hl-47-49><a style=outline:none;text-decoration:none;color:inherit href=#hl-47-49>49</a>
</span><span class=lnt id=hl-47-50><a style=outline:none;text-decoration:none;color:inherit href=#hl-47-50>50</a>
</span><span class=lnt id=hl-47-51><a style=outline:none;text-decoration:none;color:inherit href=#hl-47-51>51</a>
</span><span class=lnt id=hl-47-52><a style=outline:none;text-decoration:none;color:inherit href=#hl-47-52>52</a>
</span><span class=lnt id=hl-47-53><a style=outline:none;text-decoration:none;color:inherit href=#hl-47-53>53</a>
</span><span class=lnt id=hl-47-54><a style=outline:none;text-decoration:none;color:inherit href=#hl-47-54>54</a>
</span><span class=lnt id=hl-47-55><a style=outline:none;text-decoration:none;color:inherit href=#hl-47-55>55</a>
</span><span class=lnt id=hl-47-56><a style=outline:none;text-decoration:none;color:inherit href=#hl-47-56>56</a>
</span><span class=lnt id=hl-47-57><a style=outline:none;text-decoration:none;color:inherit href=#hl-47-57>57</a>
</span><span class=lnt id=hl-47-58><a style=outline:none;text-decoration:none;color:inherit href=#hl-47-58>58</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>read</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>eventLoop</span><span class=o>().</span><span class=na>inEventLoop</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=n>ChannelConfig</span> <span class=n>config</span> <span class=o>=</span> <span class=n>config</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=n>ChannelPipeline</span> <span class=n>pipeline</span> <span class=o>=</span> <span class=n>pipeline</span><span class=o>();</span>    
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=n>RecvByteBufAllocator</span><span class=o>.</span><span class=na>Handle</span> <span class=n>allocHandle</span> <span class=o>=</span> <span class=n>unsafe</span><span class=o>().</span><span class=na>recvBufAllocHandle</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>allocHandle</span><span class=o>.</span><span class=na>reset</span><span class=o>(</span><span class=n>config</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>boolean</span> <span class=n>closed</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>Throwable</span> <span class=n>exception</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>do</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>				<span class=c1>// doReadMessages ä¸­æ‰§è¡Œäº† accept å¹¶åˆ›å»º NioSocketChannel ä½œä¸ºæ¶ˆæ¯æ”¾å…¥ readBuf
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=c1>// readBuf æ˜¯ä¸€ä¸ª ArrayList ç”¨æ¥ç¼“å­˜æ¶ˆæ¯
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=kt>int</span> <span class=n>localRead</span> <span class=o>=</span> <span class=n>doReadMessages</span><span class=o>(</span><span class=n>readBuf</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>localRead</span> <span class=o>==</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>localRead</span> <span class=o>&lt;</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>closed</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                    <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>				<span class=c1>// localRead ä¸º 1ï¼Œå°±ä¸€æ¡æ¶ˆæ¯ï¼Œå³æ¥æ”¶ä¸€ä¸ªå®¢æˆ·ç«¯è¿æ¥
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>allocHandle</span><span class=o>.</span><span class=na>incMessagesRead</span><span class=o>(</span><span class=n>localRead</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>while</span> <span class=o>(</span><span class=n>allocHandle</span><span class=o>.</span><span class=na>continueReading</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Throwable</span> <span class=n>t</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>exception</span> <span class=o>=</span> <span class=n>t</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>size</span> <span class=o>=</span> <span class=n>readBuf</span><span class=o>.</span><span class=na>size</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>size</span><span class=o>;</span> <span class=n>i</span> <span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>readPending</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=c1>// è§¦å‘ read äº‹ä»¶ï¼Œè®© pipeline ä¸Šçš„ handler å¤„ç†ï¼Œè¿™æ—¶æ˜¯å¤„ç†
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// io.netty.bootstrap.ServerBootstrap.ServerBootstrapAcceptor#channelRead
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>pipeline</span><span class=o>.</span><span class=na>fireChannelRead</span><span class=o>(</span><span class=n>readBuf</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>i</span><span class=o>));</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=n>readBuf</span><span class=o>.</span><span class=na>clear</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>allocHandle</span><span class=o>.</span><span class=na>readComplete</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>pipeline</span><span class=o>.</span><span class=na>fireChannelReadComplete</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>exception</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>closed</span> <span class=o>=</span> <span class=n>closeOnReadError</span><span class=o>(</span><span class=n>exception</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>pipeline</span><span class=o>.</span><span class=na>fireExceptionCaught</span><span class=o>(</span><span class=n>exception</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>closed</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>inputShutdown</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>isOpen</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>close</span><span class=o>(</span><span class=n>voidPromise</span><span class=o>());</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(!</span><span class=n>readPending</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>config</span><span class=o>.</span><span class=na>isAutoRead</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>removeReadOp</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å…³é”®ä»£ç  <code>io.netty.bootstrap.ServerBootstrap.ServerBootstrapAcceptor#channelRead</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-48-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-48-1> 1</a>
</span><span class=lnt id=hl-48-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-48-2> 2</a>
</span><span class=lnt id=hl-48-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-48-3> 3</a>
</span><span class=lnt id=hl-48-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-48-4> 4</a>
</span><span class=lnt id=hl-48-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-48-5> 5</a>
</span><span class=lnt id=hl-48-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-48-6> 6</a>
</span><span class=lnt id=hl-48-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-48-7> 7</a>
</span><span class=lnt id=hl-48-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-48-8> 8</a>
</span><span class=lnt id=hl-48-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-48-9> 9</a>
</span><span class=lnt id=hl-48-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-48-10>10</a>
</span><span class=lnt id=hl-48-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-48-11>11</a>
</span><span class=lnt id=hl-48-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-48-12>12</a>
</span><span class=lnt id=hl-48-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-48-13>13</a>
</span><span class=lnt id=hl-48-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-48-14>14</a>
</span><span class=lnt id=hl-48-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-48-15>15</a>
</span><span class=lnt id=hl-48-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-48-16>16</a>
</span><span class=lnt id=hl-48-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-48-17>17</a>
</span><span class=lnt id=hl-48-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-48-18>18</a>
</span><span class=lnt id=hl-48-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-48-19>19</a>
</span><span class=lnt id=hl-48-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-48-20>20</a>
</span><span class=lnt id=hl-48-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-48-21>21</a>
</span><span class=lnt id=hl-48-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-48-22>22</a>
</span><span class=lnt id=hl-48-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-48-23>23</a>
</span><span class=lnt id=hl-48-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-48-24>24</a>
</span><span class=lnt id=hl-48-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-48-25>25</a>
</span><span class=lnt id=hl-48-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-48-26>26</a>
</span><span class=lnt id=hl-48-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-48-27>27</a>
</span><span class=lnt id=hl-48-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-48-28>28</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>channelRead</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>,</span> <span class=n>Object</span> <span class=n>msg</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// è¿™æ—¶çš„ msg æ˜¯ NioSocketChannel
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>final</span> <span class=n>Channel</span> <span class=n>child</span> <span class=o>=</span> <span class=o>(</span><span class=n>Channel</span><span class=o>)</span> <span class=n>msg</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// NioSocketChannel æ·»åŠ   childHandler å³åˆå§‹åŒ–å™¨
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>child</span><span class=o>.</span><span class=na>pipeline</span><span class=o>().</span><span class=na>addLast</span><span class=o>(</span><span class=n>childHandler</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// è®¾ç½®é€‰é¡¹
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>setChannelOptions</span><span class=o>(</span><span class=n>child</span><span class=o>,</span> <span class=n>childOptions</span><span class=o>,</span> <span class=n>logger</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=o>(</span><span class=n>Entry</span><span class=o>&lt;</span><span class=n>AttributeKey</span><span class=o>&lt;?&gt;,</span> <span class=n>Object</span><span class=o>&gt;</span> <span class=n>e</span><span class=o>:</span> <span class=n>childAttrs</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>child</span><span class=o>.</span><span class=na>attr</span><span class=o>((</span><span class=n>AttributeKey</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;)</span> <span class=n>e</span><span class=o>.</span><span class=na>getKey</span><span class=o>()).</span><span class=na>set</span><span class=o>(</span><span class=n>e</span><span class=o>.</span><span class=na>getValue</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// æ³¨å†Œ NioSocketChannel åˆ° nio worker çº¿ç¨‹ï¼Œæ¥ä¸‹æ¥çš„å¤„ç†ä¹Ÿç§»äº¤è‡³ nio worker çº¿ç¨‹
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>childGroup</span><span class=o>.</span><span class=na>register</span><span class=o>(</span><span class=n>child</span><span class=o>).</span><span class=na>addListener</span><span class=o>(</span><span class=k>new</span> <span class=n>ChannelFutureListener</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>            <span class=kd>public</span> <span class=kt>void</span> <span class=nf>operationComplete</span><span class=o>(</span><span class=n>ChannelFuture</span> <span class=n>future</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(!</span><span class=n>future</span><span class=o>.</span><span class=na>isSuccess</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>forceClose</span><span class=o>(</span><span class=n>child</span><span class=o>,</span> <span class=n>future</span><span class=o>.</span><span class=na>cause</span><span class=o>());</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>});</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Throwable</span> <span class=n>t</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>forceClose</span><span class=o>(</span><span class=n>child</span><span class=o>,</span> <span class=n>t</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>åˆå›åˆ°äº†ç†Ÿæ‚‰çš„ <code>io.netty.channel.AbstractChannel.AbstractUnsafe#register</code> æ–¹æ³•</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-49-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-49-1> 1</a>
</span><span class=lnt id=hl-49-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-49-2> 2</a>
</span><span class=lnt id=hl-49-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-49-3> 3</a>
</span><span class=lnt id=hl-49-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-49-4> 4</a>
</span><span class=lnt id=hl-49-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-49-5> 5</a>
</span><span class=lnt id=hl-49-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-49-6> 6</a>
</span><span class=lnt id=hl-49-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-49-7> 7</a>
</span><span class=lnt id=hl-49-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-49-8> 8</a>
</span><span class=lnt id=hl-49-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-49-9> 9</a>
</span><span class=lnt id=hl-49-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-49-10>10</a>
</span><span class=lnt id=hl-49-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-49-11>11</a>
</span><span class=lnt id=hl-49-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-49-12>12</a>
</span><span class=lnt id=hl-49-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-49-13>13</a>
</span><span class=lnt id=hl-49-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-49-14>14</a>
</span><span class=lnt id=hl-49-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-49-15>15</a>
</span><span class=lnt id=hl-49-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-49-16>16</a>
</span><span class=lnt id=hl-49-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-49-17>17</a>
</span><span class=lnt id=hl-49-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-49-18>18</a>
</span><span class=lnt id=hl-49-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-49-19>19</a>
</span><span class=lnt id=hl-49-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-49-20>20</a>
</span><span class=lnt id=hl-49-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-49-21>21</a>
</span><span class=lnt id=hl-49-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-49-22>22</a>
</span><span class=lnt id=hl-49-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-49-23>23</a>
</span><span class=lnt id=hl-49-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-49-24>24</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>final</span> <span class=kt>void</span> <span class=nf>register</span><span class=o>(</span><span class=n>EventLoop</span> <span class=n>eventLoop</span><span class=o>,</span> <span class=kd>final</span> <span class=n>ChannelPromise</span> <span class=n>promise</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ä¸€äº›æ£€æŸ¥ï¼Œç•¥...
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=n>AbstractChannel</span><span class=o>.</span><span class=na>this</span><span class=o>.</span><span class=na>eventLoop</span> <span class=o>=</span> <span class=n>eventLoop</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>eventLoop</span><span class=o>.</span><span class=na>inEventLoop</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>register0</span><span class=o>(</span><span class=n>promise</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// è¿™è¡Œä»£ç å®Œæˆçš„äº‹å®æ˜¯ nio boss -&gt; nio worker çº¿ç¨‹çš„åˆ‡æ¢
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>eventLoop</span><span class=o>.</span><span class=na>execute</span><span class=o>(</span><span class=k>new</span> <span class=n>Runnable</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>                <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>register0</span><span class=o>(</span><span class=n>promise</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>});</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Throwable</span> <span class=n>t</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// æ—¥å¿—è®°å½•...
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>closeForcibly</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>closeFuture</span><span class=o>.</span><span class=na>setClosed</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>safeSetFailure</span><span class=o>(</span><span class=n>promise</span><span class=o>,</span> <span class=n>t</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>io.netty.channel.AbstractChannel.AbstractUnsafe#register0</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-50-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-50-1> 1</a>
</span><span class=lnt id=hl-50-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-50-2> 2</a>
</span><span class=lnt id=hl-50-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-50-3> 3</a>
</span><span class=lnt id=hl-50-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-50-4> 4</a>
</span><span class=lnt id=hl-50-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-50-5> 5</a>
</span><span class=lnt id=hl-50-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-50-6> 6</a>
</span><span class=lnt id=hl-50-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-50-7> 7</a>
</span><span class=lnt id=hl-50-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-50-8> 8</a>
</span><span class=lnt id=hl-50-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-50-9> 9</a>
</span><span class=lnt id=hl-50-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-50-10>10</a>
</span><span class=lnt id=hl-50-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-50-11>11</a>
</span><span class=lnt id=hl-50-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-50-12>12</a>
</span><span class=lnt id=hl-50-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-50-13>13</a>
</span><span class=lnt id=hl-50-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-50-14>14</a>
</span><span class=lnt id=hl-50-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-50-15>15</a>
</span><span class=lnt id=hl-50-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-50-16>16</a>
</span><span class=lnt id=hl-50-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-50-17>17</a>
</span><span class=lnt id=hl-50-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-50-18>18</a>
</span><span class=lnt id=hl-50-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-50-19>19</a>
</span><span class=lnt id=hl-50-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-50-20>20</a>
</span><span class=lnt id=hl-50-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-50-21>21</a>
</span><span class=lnt id=hl-50-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-50-22>22</a>
</span><span class=lnt id=hl-50-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-50-23>23</a>
</span><span class=lnt id=hl-50-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-50-24>24</a>
</span><span class=lnt id=hl-50-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-50-25>25</a>
</span><span class=lnt id=hl-50-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-50-26>26</a>
</span><span class=lnt id=hl-50-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-50-27>27</a>
</span><span class=lnt id=hl-50-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-50-28>28</a>
</span><span class=lnt id=hl-50-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-50-29>29</a>
</span><span class=lnt id=hl-50-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-50-30>30</a>
</span><span class=lnt id=hl-50-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-50-31>31</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kt>void</span> <span class=nf>register0</span><span class=o>(</span><span class=n>ChannelPromise</span> <span class=n>promise</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(!</span><span class=n>promise</span><span class=o>.</span><span class=na>setUncancellable</span><span class=o>()</span> <span class=o>||</span> <span class=o>!</span><span class=n>ensureOpen</span><span class=o>(</span><span class=n>promise</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=kt>boolean</span> <span class=n>firstRegistration</span> <span class=o>=</span> <span class=n>neverRegistered</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>doRegister</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>neverRegistered</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>registered</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>		
</span></span><span class=line><span class=cl>        <span class=c1>// æ‰§è¡Œåˆå§‹åŒ–å™¨ï¼Œæ‰§è¡Œå‰ pipeline ä¸­åªæœ‰ head -&gt; åˆå§‹åŒ–å™¨ -&gt; tail
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>pipeline</span><span class=o>.</span><span class=na>invokeHandlerAddedIfNeeded</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=c1>// æ‰§è¡Œåå°±æ˜¯ head -&gt; logging handler -&gt; my handler -&gt; tail
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>        <span class=n>safeSetSuccess</span><span class=o>(</span><span class=n>promise</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>pipeline</span><span class=o>.</span><span class=na>fireChannelRegistered</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>isActive</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>firstRegistration</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// è§¦å‘ pipeline ä¸Š active äº‹ä»¶
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>pipeline</span><span class=o>.</span><span class=na>fireChannelActive</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>config</span><span class=o>().</span><span class=na>isAutoRead</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>beginRead</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Throwable</span> <span class=n>t</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>closeForcibly</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>closeFuture</span><span class=o>.</span><span class=na>setClosed</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>safeSetFailure</span><span class=o>(</span><span class=n>promise</span><span class=o>,</span> <span class=n>t</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å›åˆ°äº†ç†Ÿæ‚‰çš„ä»£ç  <code>io.netty.channel.DefaultChannelPipeline.HeadContext#channelActive</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-51-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-51-1>1</a>
</span><span class=lnt id=hl-51-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-51-2>2</a>
</span><span class=lnt id=hl-51-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-51-3>3</a>
</span><span class=lnt id=hl-51-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-51-4>4</a>
</span><span class=lnt id=hl-51-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-51-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>channelActive</span><span class=o>(</span><span class=n>ChannelHandlerContext</span> <span class=n>ctx</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ctx</span><span class=o>.</span><span class=na>fireChannelActive</span><span class=o>();</span>
</span></span><span class=line><span class=cl>	<span class=c1>// è§¦å‘ read (NioSocketChannel è¿™é‡Œ readï¼Œåªæ˜¯ä¸ºäº†è§¦å‘ channel çš„äº‹ä»¶æ³¨å†Œï¼Œè¿˜æœªæ¶‰åŠæ•°æ®è¯»å–)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>readIfIsAutoRead</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>io.netty.channel.nio.AbstractNioChannel#doBeginRead</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-52-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-52-1> 1</a>
</span><span class=lnt id=hl-52-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-52-2> 2</a>
</span><span class=lnt id=hl-52-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-52-3> 3</a>
</span><span class=lnt id=hl-52-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-52-4> 4</a>
</span><span class=lnt id=hl-52-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-52-5> 5</a>
</span><span class=lnt id=hl-52-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-52-6> 6</a>
</span><span class=lnt id=hl-52-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-52-7> 7</a>
</span><span class=lnt id=hl-52-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-52-8> 8</a>
</span><span class=lnt id=hl-52-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-52-9> 9</a>
</span><span class=lnt id=hl-52-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-52-10>10</a>
</span><span class=lnt id=hl-52-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-52-11>11</a>
</span><span class=lnt id=hl-52-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-52-12>12</a>
</span><span class=lnt id=hl-52-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-52-13>13</a>
</span><span class=lnt id=hl-52-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-52-14>14</a>
</span><span class=lnt id=hl-52-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-52-15>15</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>protected</span> <span class=kt>void</span> <span class=nf>doBeginRead</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Channel.read() or ChannelHandlerContext.read() was called
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>final</span> <span class=n>SelectionKey</span> <span class=n>selectionKey</span> <span class=o>=</span> <span class=k>this</span><span class=o>.</span><span class=na>selectionKey</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(!</span><span class=n>selectionKey</span><span class=o>.</span><span class=na>isValid</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>readPending</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>	<span class=c1>// è¿™æ—¶å€™ interestOps æ˜¯ 0
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>final</span> <span class=kt>int</span> <span class=n>interestOps</span> <span class=o>=</span> <span class=n>selectionKey</span><span class=o>.</span><span class=na>interestOps</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>((</span><span class=n>interestOps</span> <span class=o>&amp;</span> <span class=n>readInterestOp</span><span class=o>)</span> <span class=o>==</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// å…³æ³¨ read äº‹ä»¶
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>selectionKey</span><span class=o>.</span><span class=na>interestOps</span><span class=o>(</span><span class=n>interestOps</span> <span class=o>|</span> <span class=n>readInterestOp</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#24-read-å‰–æ><h3 id=24-read-å‰–æ><span class=hanchor arialabel=Anchor># </span>2.4 read å‰–æ</h3></a><p>å†æ¥çœ‹å¯è¯»äº‹ä»¶ <code>io.netty.channel.nio.AbstractNioByteChannel.NioByteUnsafe#read</code>ï¼Œæ³¨æ„å‘é€çš„æ•°æ®æœªå¿…èƒ½å¤Ÿä¸€æ¬¡è¯»å®Œï¼Œå› æ­¤ä¼šè§¦å‘å¤šæ¬¡ nio read äº‹ä»¶ï¼Œä¸€æ¬¡äº‹ä»¶å†…ä¼šè§¦å‘å¤šæ¬¡ pipeline readï¼Œä¸€æ¬¡äº‹ä»¶ä¼šè§¦å‘ä¸€æ¬¡ pipeline read complete</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-53-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-53-1> 1</a>
</span><span class=lnt id=hl-53-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-53-2> 2</a>
</span><span class=lnt id=hl-53-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-53-3> 3</a>
</span><span class=lnt id=hl-53-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-53-4> 4</a>
</span><span class=lnt id=hl-53-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-53-5> 5</a>
</span><span class=lnt id=hl-53-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-53-6> 6</a>
</span><span class=lnt id=hl-53-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-53-7> 7</a>
</span><span class=lnt id=hl-53-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-53-8> 8</a>
</span><span class=lnt id=hl-53-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-53-9> 9</a>
</span><span class=lnt id=hl-53-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-53-10>10</a>
</span><span class=lnt id=hl-53-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-53-11>11</a>
</span><span class=lnt id=hl-53-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-53-12>12</a>
</span><span class=lnt id=hl-53-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-53-13>13</a>
</span><span class=lnt id=hl-53-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-53-14>14</a>
</span><span class=lnt id=hl-53-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-53-15>15</a>
</span><span class=lnt id=hl-53-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-53-16>16</a>
</span><span class=lnt id=hl-53-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-53-17>17</a>
</span><span class=lnt id=hl-53-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-53-18>18</a>
</span><span class=lnt id=hl-53-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-53-19>19</a>
</span><span class=lnt id=hl-53-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-53-20>20</a>
</span><span class=lnt id=hl-53-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-53-21>21</a>
</span><span class=lnt id=hl-53-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-53-22>22</a>
</span><span class=lnt id=hl-53-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-53-23>23</a>
</span><span class=lnt id=hl-53-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-53-24>24</a>
</span><span class=lnt id=hl-53-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-53-25>25</a>
</span><span class=lnt id=hl-53-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-53-26>26</a>
</span><span class=lnt id=hl-53-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-53-27>27</a>
</span><span class=lnt id=hl-53-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-53-28>28</a>
</span><span class=lnt id=hl-53-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-53-29>29</a>
</span><span class=lnt id=hl-53-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-53-30>30</a>
</span><span class=lnt id=hl-53-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-53-31>31</a>
</span><span class=lnt id=hl-53-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-53-32>32</a>
</span><span class=lnt id=hl-53-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-53-33>33</a>
</span><span class=lnt id=hl-53-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-53-34>34</a>
</span><span class=lnt id=hl-53-35><a style=outline:none;text-decoration:none;color:inherit href=#hl-53-35>35</a>
</span><span class=lnt id=hl-53-36><a style=outline:none;text-decoration:none;color:inherit href=#hl-53-36>36</a>
</span><span class=lnt id=hl-53-37><a style=outline:none;text-decoration:none;color:inherit href=#hl-53-37>37</a>
</span><span class=lnt id=hl-53-38><a style=outline:none;text-decoration:none;color:inherit href=#hl-53-38>38</a>
</span><span class=lnt id=hl-53-39><a style=outline:none;text-decoration:none;color:inherit href=#hl-53-39>39</a>
</span><span class=lnt id=hl-53-40><a style=outline:none;text-decoration:none;color:inherit href=#hl-53-40>40</a>
</span><span class=lnt id=hl-53-41><a style=outline:none;text-decoration:none;color:inherit href=#hl-53-41>41</a>
</span><span class=lnt id=hl-53-42><a style=outline:none;text-decoration:none;color:inherit href=#hl-53-42>42</a>
</span><span class=lnt id=hl-53-43><a style=outline:none;text-decoration:none;color:inherit href=#hl-53-43>43</a>
</span><span class=lnt id=hl-53-44><a style=outline:none;text-decoration:none;color:inherit href=#hl-53-44>44</a>
</span><span class=lnt id=hl-53-45><a style=outline:none;text-decoration:none;color:inherit href=#hl-53-45>45</a>
</span><span class=lnt id=hl-53-46><a style=outline:none;text-decoration:none;color:inherit href=#hl-53-46>46</a>
</span><span class=lnt id=hl-53-47><a style=outline:none;text-decoration:none;color:inherit href=#hl-53-47>47</a>
</span><span class=lnt id=hl-53-48><a style=outline:none;text-decoration:none;color:inherit href=#hl-53-48>48</a>
</span><span class=lnt id=hl-53-49><a style=outline:none;text-decoration:none;color:inherit href=#hl-53-49>49</a>
</span><span class=lnt id=hl-53-50><a style=outline:none;text-decoration:none;color:inherit href=#hl-53-50>50</a>
</span><span class=lnt id=hl-53-51><a style=outline:none;text-decoration:none;color:inherit href=#hl-53-51>51</a>
</span><span class=lnt id=hl-53-52><a style=outline:none;text-decoration:none;color:inherit href=#hl-53-52>52</a>
</span><span class=lnt id=hl-53-53><a style=outline:none;text-decoration:none;color:inherit href=#hl-53-53>53</a>
</span><span class=lnt id=hl-53-54><a style=outline:none;text-decoration:none;color:inherit href=#hl-53-54>54</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>final</span> <span class=kt>void</span> <span class=nf>read</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=n>ChannelConfig</span> <span class=n>config</span> <span class=o>=</span> <span class=n>config</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>shouldBreakReadReady</span><span class=o>(</span><span class=n>config</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>clearReadPending</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=n>ChannelPipeline</span> <span class=n>pipeline</span> <span class=o>=</span> <span class=n>pipeline</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=c1>// io.netty.allocator.type å†³å®š allocator çš„å®ç°
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>final</span> <span class=n>ByteBufAllocator</span> <span class=n>allocator</span> <span class=o>=</span> <span class=n>config</span><span class=o>.</span><span class=na>getAllocator</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ç”¨æ¥åˆ†é… byteBufï¼Œç¡®å®šå•æ¬¡è¯»å–å¤§å°
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>final</span> <span class=n>RecvByteBufAllocator</span><span class=o>.</span><span class=na>Handle</span> <span class=n>allocHandle</span> <span class=o>=</span> <span class=n>recvBufAllocHandle</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>allocHandle</span><span class=o>.</span><span class=na>reset</span><span class=o>(</span><span class=n>config</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>ByteBuf</span> <span class=n>byteBuf</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>boolean</span> <span class=n>close</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>do</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>byteBuf</span> <span class=o>=</span> <span class=n>allocHandle</span><span class=o>.</span><span class=na>allocate</span><span class=o>(</span><span class=n>allocator</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=c1>// è¯»å–
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>allocHandle</span><span class=o>.</span><span class=na>lastBytesRead</span><span class=o>(</span><span class=n>doReadBytes</span><span class=o>(</span><span class=n>byteBuf</span><span class=o>));</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>allocHandle</span><span class=o>.</span><span class=na>lastBytesRead</span><span class=o>()</span> <span class=o>&lt;=</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>byteBuf</span><span class=o>.</span><span class=na>release</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=n>byteBuf</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=n>close</span> <span class=o>=</span> <span class=n>allocHandle</span><span class=o>.</span><span class=na>lastBytesRead</span><span class=o>()</span> <span class=o>&lt;</span> <span class=n>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>close</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>readPending</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>allocHandle</span><span class=o>.</span><span class=na>incMessagesRead</span><span class=o>(</span><span class=n>1</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>readPending</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=c1>// è§¦å‘ read äº‹ä»¶ï¼Œè®© pipeline ä¸Šçš„ handler å¤„ç†ï¼Œè¿™æ—¶æ˜¯å¤„ç† NioSocketChannel ä¸Šçš„ handler
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>pipeline</span><span class=o>.</span><span class=na>fireChannelRead</span><span class=o>(</span><span class=n>byteBuf</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>byteBuf</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> 
</span></span><span class=line><span class=cl>        <span class=c1>// æ˜¯å¦è¦ç»§ç»­å¾ªç¯
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>while</span> <span class=o>(</span><span class=n>allocHandle</span><span class=o>.</span><span class=na>continueReading</span><span class=o>());</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>allocHandle</span><span class=o>.</span><span class=na>readComplete</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=c1>// è§¦å‘ read complete äº‹ä»¶
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>pipeline</span><span class=o>.</span><span class=na>fireChannelReadComplete</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>close</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>closeOnRead</span><span class=o>(</span><span class=n>pipeline</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Throwable</span> <span class=n>t</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>handleReadException</span><span class=o>(</span><span class=n>pipeline</span><span class=o>,</span> <span class=n>byteBuf</span><span class=o>,</span> <span class=n>t</span><span class=o>,</span> <span class=n>close</span><span class=o>,</span> <span class=n>allocHandle</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(!</span><span class=n>readPending</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>config</span><span class=o>.</span><span class=na>isAutoRead</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>removeReadOp</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>io.netty.channel.DefaultMaxMessagesRecvByteBufAllocator.MaxMessageHandle#continueReading(io.netty.util.UncheckedBooleanSupplier)</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-54-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-54-1> 1</a>
</span><span class=lnt id=hl-54-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-54-2> 2</a>
</span><span class=lnt id=hl-54-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-54-3> 3</a>
</span><span class=lnt id=hl-54-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-54-4> 4</a>
</span><span class=lnt id=hl-54-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-54-5> 5</a>
</span><span class=lnt id=hl-54-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-54-6> 6</a>
</span><span class=lnt id=hl-54-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-54-7> 7</a>
</span><span class=lnt id=hl-54-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-54-8> 8</a>
</span><span class=lnt id=hl-54-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-54-9> 9</a>
</span><span class=lnt id=hl-54-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-54-10>10</a>
</span><span class=lnt id=hl-54-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-54-11>11</a>
</span><span class=lnt id=hl-54-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-54-12>12</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>continueReading</span><span class=o>(</span><span class=n>UncheckedBooleanSupplier</span> <span class=n>maybeMoreDataSupplier</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> 
</span></span><span class=line><span class=cl>           <span class=c1>// ä¸€èˆ¬ä¸º true
</span></span></span><span class=line><span class=cl><span class=c1></span>           <span class=n>config</span><span class=o>.</span><span class=na>isAutoRead</span><span class=o>()</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>           <span class=c1>// respectMaybeMoreData é»˜è®¤ä¸º true
</span></span></span><span class=line><span class=cl><span class=c1></span>           <span class=c1>// maybeMoreDataSupplier çš„é€»è¾‘æ˜¯å¦‚æœé¢„æœŸè¯»å–å­—èŠ‚ä¸å®é™…è¯»å–å­—èŠ‚ç›¸ç­‰ï¼Œè¿”å› true
</span></span></span><span class=line><span class=cl><span class=c1></span>           <span class=o>(!</span><span class=n>respectMaybeMoreData</span> <span class=o>||</span> <span class=n>maybeMoreDataSupplier</span><span class=o>.</span><span class=na>get</span><span class=o>())</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>           <span class=c1>// å°äºæœ€å¤§æ¬¡æ•°ï¼ŒmaxMessagePerRead é»˜è®¤ 16
</span></span></span><span class=line><span class=cl><span class=c1></span>           <span class=n>totalMessages</span> <span class=o>&lt;</span> <span class=n>maxMessagePerRead</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>           <span class=c1>// å®é™…è¯»åˆ°äº†æ•°æ®
</span></span></span><span class=line><span class=cl><span class=c1></span>           <span class=n>totalBytesRead</span> <span class=o>&gt;</span> <span class=n>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div></article><hr><div class=page-end id=footer><div class=backlinks-container><h3>åå‘é“¾æ¥</h3><ul class=backlinks><li>æ— åå‘é“¾æ¥</li></ul></div><div><script src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>æ¹¾åŒºåœ°å›¾</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://harbor.mffseal.top/js/graph.abd4bc2af3869a96524d7d23b76152c7.js></script></div></div><div id=contact_buttons><footer><p><a rel=license href=http://creativecommons.org/licenses/by-nc/4.0/><img alt="Creative Commons Licence" style=border-width:0 src=https://i.creativecommons.org/l/by-nc/4.0/88x31.png></a><br>æœ¬åšå®¢çš„åšä¸»åŸåˆ›æ–‡ç« å‡éµå¾ª <a rel=license href=http://creativecommons.org/licenses/by-nc/4.0/>CC BY-NC(ç½²å-éå•†ä¸šæ€§ä½¿ç”¨) 4.0 å›½é™…åè®®</a><br>è½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜</p><p>ç”± mffseal ä½¿ç”¨ <a href=https://github.com/jackyzha0/quartz>Quartz</a> å¼€å‘, Â© 2022</p><ul><li><a href=https://harbor.mffseal.top/>æ¸¯å£</a></li><li><a href=https://github.com/mffseal>Github</a></li></ul></footer></div></div></body></html>