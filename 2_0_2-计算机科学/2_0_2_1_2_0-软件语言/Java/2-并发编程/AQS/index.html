<!doctype html><html lang=cn><head><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8920808282451934" crossorigin=anonymous></script><div id=cursor-chat-layer><input type=text id=cursor-chat-box></div><script src=https://unpkg.com/cursor-chat></script>
<link rel=stylesheet type=text/css href=https://unpkg.com/cursor-chat/dist/style.css><meta charset=utf-8><meta name=description content="AQS 全称是 AbstractQueuedSynchronizer，是阻塞式锁（类似[[2_0_2-计算机科学/2_0_2_1_2_0-软件语言/Java/2-并发编程/synchronized|synchronized]]）和相关的同步器工具的框架。
特点  用 state 属性来表示资源的状态（分独占模式和共享模式），子类需要定义如何维护这个状态，控制如何获取锁和释放锁  getState - 获取 state 状态 setState - 设置 state 状态 compareAndSetState - cas 机制设置 state 状态 独占模式是只有一个线程能够访问资源，而共享模式可以允许多个线程访问资源   提供了基于 FIFO 的等待队列，类似于 Monitor 的 EntryList 条件变量来实现等待、唤醒机制，支持多个条件变量，类似于 Monitor 的 WaitSet  子类主要实现这样一些方法（默认抛出 UnsupportedOperationException）"><title>AQS</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://harbor.mffseal.top//icon.png><link href=https://harbor.mffseal.top/styles.73cf69c3fd63eaf27dde453f5aa109f7.min.css rel=stylesheet><link href=https://harbor.mffseal.top/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://harbor.mffseal.top/js/darkmode.9841b88d44c115f7419d485ee72d23a2.min.js></script>
<script src=https://harbor.mffseal.top/js/util.9825137f5e7825e8553c68ce39ac9e44.min.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js integrity=sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A crossorigin=anonymous></script>
<script src=https://unpkg.com/@floating-ui/core@0.7.3></script>
<script src=https://unpkg.com/@floating-ui/dom@0.5.4></script>
<script src=https://harbor.mffseal.top/js/popover.53ad9a087e3feeaaa12b63bfd02d923b.min.js></script>
<script src=https://harbor.mffseal.top/js/code-title.b35124ad8db0ba37162b886afb711cbc.min.js></script>
<script src=https://harbor.mffseal.top/js/clipboard.c20857734e53a3fb733b7443879efa61.min.js></script>
<script src=https://harbor.mffseal.top/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const BASE_URL="https://harbor.mffseal.top/",fetchData=Promise.all([fetch("https://harbor.mffseal.top/indices/linkIndex.48aa3f407bd7eeb4e3946e68f7a6b286.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://harbor.mffseal.top/indices/contentIndex.4fe5f6968c4bb323a63d9e5ae8cce0d3.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addTitleToCodeBlocks(),addCollapsibleCallouts(),initPopover("https://harbor.mffseal.top",!0,!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!0;drawGraph("https://harbor.mffseal.top",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],macros:{'’':"'"},throwOnError:!1})}</script><script type=module>
    import { attachSPARouting } from "https:\/\/harbor.mffseal.top\/js\/router.9d4974281069e9ebb189f642ae1e3ca2.min.js"
    attachSPARouting(init, render)
  </script></head><script async src="https://www.googletagmanager.com/gtag/js?id=G-NV58SYWRZD"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-NV58SYWRZD",{anonymize_ip:!1})}</script><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=搜索 placeholder=搜一搜...><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://harbor.mffseal.top/js/full-text-search.24827f874defbbc6d529926cbfcfb493.min.js></script><div class=singlePage><header><h1 id=page-title><a href=https://harbor.mffseal.top/>🦭 港湾</a></h1><div class=spacer></div><div id=search-icon><p>搜索</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">搜索图标</title><desc id="desc">打开搜索图标</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>亮色</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>暗色</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><h1>AQS</h1><p class=meta>最后更新
Jun 9, 2022
<a href="obsidian://open?vault=content&file=2_0_2-%e8%ae%a1%e7%ae%97%e6%9c%ba%e7%a7%91%e5%ad%a6%2f2_0_2_1_2_0-%e8%bd%af%e4%bb%b6%e8%af%ad%e8%a8%80%2fJava%2f2-%e5%b9%b6%e5%8f%91%e7%bc%96%e7%a8%8b%2fAQS.md" rel=noopener>编辑源</a></p><ul class=tags><li><a href=https://harbor.mffseal.top/tags/atom/>Atom</a></li></ul><div class=toc-wrapper><div class=mainTOC id=mainTOC><aside><header><h3>AQS</h3></header><nav id=TableOfContents><ol><li><a href=#特点>特点</a><ol><li><a href=#获取锁>获取锁</a></li><li><a href=#释放锁>释放锁</a></li></ol></li><li><a href=#自己实现不可重入锁>自己实现不可重入锁</a></li><li><a href=#简介>简介</a></li><li><a href=#aqs的数据结构>AQS的数据结构</a><ol><li><a href=#资源共享模式>资源共享模式</a></li><li><a href=#node结构>Node结构</a></li></ol></li><li><a href=#aqs的主要方法源码解析>AQS的主要方法源码解析</a><ol><li><a href=#线程排队>线程排队</a></li><li><a href=#获取资源>获取资源</a></li><li><a href=#释放资源>释放资源</a></li></ol></li></ol></nav></aside><a href=# id=toc-toggle></a></div></div><a href=#aqs><h1 id=aqs><span class=hanchor arialabel=Anchor># </span>AQS</h1></a><p>全称是 AbstractQueuedSynchronizer，是<strong>阻塞</strong>式锁（类似<a href=/2_0_2-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/2_0_2_1_2_0-%E8%BD%AF%E4%BB%B6%E8%AF%AD%E8%A8%80/Java/2-%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/synchronized rel=noopener class=internal-link data-src=/2_0_2-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/2_0_2_1_2_0-%E8%BD%AF%E4%BB%B6%E8%AF%AD%E8%A8%80/Java/2-%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/synchronized>synchronized</a>）和相关的同步器工具的框架。</p><a href=#特点><h2 id=特点><span class=hanchor arialabel=Anchor># </span>特点</h2></a><ul><li>用 <strong>state</strong> 属性来表示资源的状态（分独占模式和共享模式），子类需要定义如何维护这个状态，控制如何获取锁和释放锁<ul><li>getState - 获取 state 状态</li><li>setState - 设置 state 状态</li><li>compareAndSetState - cas 机制设置 state 状态</li><li>独占模式是只有一个线程能够访问资源，而共享模式可以允许多个线程访问资源</li></ul></li><li>提供了基于 FIFO 的等待队列，类似于 Monitor 的 EntryList</li><li>条件变量来实现等待、唤醒机制，支持多个条件变量，类似于 Monitor 的 WaitSet</li></ul><p>子类主要实现这样一些方法（默认抛出 UnsupportedOperationException）</p><ul><li>tryAcquire</li><li>tryRelease</li><li>tryAcquireShared</li><li>tryReleaseShared</li><li>isHeldExclusively</li></ul><blockquote><p>这里不使用抽象方法的目的是：避免强迫子类中把所有的抽象方法都实现一遍，减少无用功，这样子类只需要实现自己关心的抽象方法即可，比如 Semaphore 只需要实现 tryAcquire 方法而不用实现其余不需要用到的模版方法。</p></blockquote><a href=#获取锁><h3 id=获取锁><span class=hanchor arialabel=Anchor># </span>获取锁</h3></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-0-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-1>1</a>
</span><span class=lnt id=hl-0-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-2>2</a>
</span><span class=lnt id=hl-0-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-3>3</a>
</span><span class=lnt id=hl-0-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 如果获取锁失败
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>if</span> <span class=o>(!</span><span class=n>tryAcquire</span><span class=o>(</span><span class=n>arg</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 入队, 可以选择阻塞当前线程  park unpark
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>AQS使用park&unpark来阻塞和恢复线程</p></blockquote><a href=#释放锁><h3 id=释放锁><span class=hanchor arialabel=Anchor># </span>释放锁</h3></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-1-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-1>1</a>
</span><span class=lnt id=hl-1-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-2>2</a>
</span><span class=lnt id=hl-1-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-3>3</a>
</span><span class=lnt id=hl-1-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 如果释放锁成功
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>if</span> <span class=o>(</span><span class=n>tryRelease</span><span class=o>(</span><span class=n>arg</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 让阻塞线程恢复运行
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#自己实现不可重入锁><h2 id=自己实现不可重入锁><span class=hanchor arialabel=Anchor># </span>自己实现不可重入锁</h2></a><p>实现Lock+AQS：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-2-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-1>  1</a>
</span><span class=lnt id=hl-2-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-2>  2</a>
</span><span class=lnt id=hl-2-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-3>  3</a>
</span><span class=lnt id=hl-2-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-4>  4</a>
</span><span class=lnt id=hl-2-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-5>  5</a>
</span><span class=lnt id=hl-2-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-6>  6</a>
</span><span class=lnt id=hl-2-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-7>  7</a>
</span><span class=lnt id=hl-2-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-8>  8</a>
</span><span class=lnt id=hl-2-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-9>  9</a>
</span><span class=lnt id=hl-2-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-10> 10</a>
</span><span class=lnt id=hl-2-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-11> 11</a>
</span><span class=lnt id=hl-2-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-12> 12</a>
</span><span class=lnt id=hl-2-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-13> 13</a>
</span><span class=lnt id=hl-2-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-14> 14</a>
</span><span class=lnt id=hl-2-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-15> 15</a>
</span><span class=lnt id=hl-2-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-16> 16</a>
</span><span class=lnt id=hl-2-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-17> 17</a>
</span><span class=lnt id=hl-2-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-18> 18</a>
</span><span class=lnt id=hl-2-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-19> 19</a>
</span><span class=lnt id=hl-2-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-20> 20</a>
</span><span class=lnt id=hl-2-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-21> 21</a>
</span><span class=lnt id=hl-2-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-22> 22</a>
</span><span class=lnt id=hl-2-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-23> 23</a>
</span><span class=lnt id=hl-2-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-24> 24</a>
</span><span class=lnt id=hl-2-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-25> 25</a>
</span><span class=lnt id=hl-2-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-26> 26</a>
</span><span class=lnt id=hl-2-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-27> 27</a>
</span><span class=lnt id=hl-2-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-28> 28</a>
</span><span class=lnt id=hl-2-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-29> 29</a>
</span><span class=lnt id=hl-2-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-30> 30</a>
</span><span class=lnt id=hl-2-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-31> 31</a>
</span><span class=lnt id=hl-2-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-32> 32</a>
</span><span class=lnt id=hl-2-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-33> 33</a>
</span><span class=lnt id=hl-2-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-34> 34</a>
</span><span class=lnt id=hl-2-35><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-35> 35</a>
</span><span class=lnt id=hl-2-36><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-36> 36</a>
</span><span class=lnt id=hl-2-37><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-37> 37</a>
</span><span class=lnt id=hl-2-38><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-38> 38</a>
</span><span class=lnt id=hl-2-39><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-39> 39</a>
</span><span class=lnt id=hl-2-40><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-40> 40</a>
</span><span class=lnt id=hl-2-41><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-41> 41</a>
</span><span class=lnt id=hl-2-42><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-42> 42</a>
</span><span class=lnt id=hl-2-43><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-43> 43</a>
</span><span class=lnt id=hl-2-44><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-44> 44</a>
</span><span class=lnt id=hl-2-45><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-45> 45</a>
</span><span class=lnt id=hl-2-46><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-46> 46</a>
</span><span class=lnt id=hl-2-47><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-47> 47</a>
</span><span class=lnt id=hl-2-48><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-48> 48</a>
</span><span class=lnt id=hl-2-49><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-49> 49</a>
</span><span class=lnt id=hl-2-50><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-50> 50</a>
</span><span class=lnt id=hl-2-51><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-51> 51</a>
</span><span class=lnt id=hl-2-52><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-52> 52</a>
</span><span class=lnt id=hl-2-53><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-53> 53</a>
</span><span class=lnt id=hl-2-54><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-54> 54</a>
</span><span class=lnt id=hl-2-55><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-55> 55</a>
</span><span class=lnt id=hl-2-56><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-56> 56</a>
</span><span class=lnt id=hl-2-57><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-57> 57</a>
</span><span class=lnt id=hl-2-58><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-58> 58</a>
</span><span class=lnt id=hl-2-59><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-59> 59</a>
</span><span class=lnt id=hl-2-60><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-60> 60</a>
</span><span class=lnt id=hl-2-61><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-61> 61</a>
</span><span class=lnt id=hl-2-62><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-62> 62</a>
</span><span class=lnt id=hl-2-63><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-63> 63</a>
</span><span class=lnt id=hl-2-64><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-64> 64</a>
</span><span class=lnt id=hl-2-65><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-65> 65</a>
</span><span class=lnt id=hl-2-66><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-66> 66</a>
</span><span class=lnt id=hl-2-67><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-67> 67</a>
</span><span class=lnt id=hl-2-68><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-68> 68</a>
</span><span class=lnt id=hl-2-69><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-69> 69</a>
</span><span class=lnt id=hl-2-70><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-70> 70</a>
</span><span class=lnt id=hl-2-71><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-71> 71</a>
</span><span class=lnt id=hl-2-72><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-72> 72</a>
</span><span class=lnt id=hl-2-73><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-73> 73</a>
</span><span class=lnt id=hl-2-74><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-74> 74</a>
</span><span class=lnt id=hl-2-75><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-75> 75</a>
</span><span class=lnt id=hl-2-76><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-76> 76</a>
</span><span class=lnt id=hl-2-77><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-77> 77</a>
</span><span class=lnt id=hl-2-78><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-78> 78</a>
</span><span class=lnt id=hl-2-79><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-79> 79</a>
</span><span class=lnt id=hl-2-80><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-80> 80</a>
</span><span class=lnt id=hl-2-81><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-81> 81</a>
</span><span class=lnt id=hl-2-82><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-82> 82</a>
</span><span class=lnt id=hl-2-83><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-83> 83</a>
</span><span class=lnt id=hl-2-84><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-84> 84</a>
</span><span class=lnt id=hl-2-85><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-85> 85</a>
</span><span class=lnt id=hl-2-86><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-86> 86</a>
</span><span class=lnt id=hl-2-87><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-87> 87</a>
</span><span class=lnt id=hl-2-88><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-88> 88</a>
</span><span class=lnt id=hl-2-89><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-89> 89</a>
</span><span class=lnt id=hl-2-90><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-90> 90</a>
</span><span class=lnt id=hl-2-91><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-91> 91</a>
</span><span class=lnt id=hl-2-92><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-92> 92</a>
</span><span class=lnt id=hl-2-93><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-93> 93</a>
</span><span class=lnt id=hl-2-94><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-94> 94</a>
</span><span class=lnt id=hl-2-95><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-95> 95</a>
</span><span class=lnt id=hl-2-96><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-96> 96</a>
</span><span class=lnt id=hl-2-97><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-97> 97</a>
</span><span class=lnt id=hl-2-98><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-98> 98</a>
</span><span class=lnt id=hl-2-99><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-99> 99</a>
</span><span class=lnt id=hl-2-100><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-100>100</a>
</span><span class=lnt id=hl-2-101><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-101>101</a>
</span><span class=lnt id=hl-2-102><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-102>102</a>
</span><span class=lnt id=hl-2-103><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-103>103</a>
</span><span class=lnt id=hl-2-104><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-104>104</a>
</span><span class=lnt id=hl-2-105><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-105>105</a>
</span><span class=lnt id=hl-2-106><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-106>106</a>
</span><span class=lnt id=hl-2-107><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-107>107</a>
</span><span class=lnt id=hl-2-108><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-108>108</a>
</span><span class=lnt id=hl-2-109><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-109>109</a>
</span><span class=lnt id=hl-2-110><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-110>110</a>
</span><span class=lnt id=hl-2-111><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-111>111</a>
</span><span class=lnt id=hl-2-112><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-112>112</a>
</span><span class=lnt id=hl-2-113><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-113>113</a>
</span><span class=lnt id=hl-2-114><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-114>114</a>
</span><span class=lnt id=hl-2-115><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-115>115</a>
</span><span class=lnt id=hl-2-116><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-116>116</a>
</span><span class=lnt id=hl-2-117><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-117>117</a>
</span><span class=lnt id=hl-2-118><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-118>118</a>
</span><span class=lnt id=hl-2-119><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-119>119</a>
</span><span class=lnt id=hl-2-120><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-120>120</a>
</span><span class=lnt id=hl-2-121><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-121>121</a>
</span><span class=lnt id=hl-2-122><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-122>122</a>
</span><span class=lnt id=hl-2-123><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-123>123</a>
</span><span class=lnt id=hl-2-124><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-124>124</a>
</span><span class=lnt id=hl-2-125><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-125>125</a>
</span><span class=lnt id=hl-2-126><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-126>126</a>
</span><span class=lnt id=hl-2-127><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-127>127</a>
</span><span class=lnt id=hl-2-128><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-128>128</a>
</span><span class=lnt id=hl-2-129><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-129>129</a>
</span><span class=lnt id=hl-2-130><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-130>130</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>package</span> <span class=nn>test</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>lombok.extern.slf4j.Slf4j</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>java.util.concurrent.TimeUnit</span><span class=o>;</span>  
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>java.util.concurrent.locks.AbstractQueuedSynchronizer</span><span class=o>;</span>  
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>java.util.concurrent.locks.Condition</span><span class=o>;</span>  
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>java.util.concurrent.locks.Lock</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl><span class=nd>@Slf4j</span>  
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>Test23Aqs</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>        <span class=n>MyLock</span> <span class=n>lock</span> <span class=o>=</span> <span class=k>new</span> <span class=n>MyLock</span><span class=o>();</span>  
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=n>Thread</span><span class=o>(()-&gt;{</span>  
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;尝试加锁&#34;</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>            <span class=n>lock</span><span class=o>.</span><span class=na>lock</span><span class=o>();</span>  
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;加锁成功&#34;</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>            <span class=k>try</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>                <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;加锁&#34;</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>                <span class=k>try</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>                    <span class=n>Thread</span><span class=o>.</span><span class=na>sleep</span><span class=o>(</span><span class=n>3000</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>                <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>                    <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>  
</span></span><span class=line><span class=cl>                <span class=o>}</span>  
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>                <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;解锁&#34;</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>                <span class=n>lock</span><span class=o>.</span><span class=na>unlock</span><span class=o>();</span>  
</span></span><span class=line><span class=cl>            <span class=o>}</span>  
</span></span><span class=line><span class=cl>        <span class=o>}).</span><span class=na>start</span><span class=o>();</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=n>Thread</span><span class=o>(()-&gt;{</span>  
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;尝试加锁&#34;</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>            <span class=n>lock</span><span class=o>.</span><span class=na>lock</span><span class=o>();</span>  
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;加锁成功&#34;</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>            <span class=k>try</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>                <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;加锁&#34;</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>                <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;解锁&#34;</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>                <span class=n>lock</span><span class=o>.</span><span class=na>unlock</span><span class=o>();</span>  
</span></span><span class=line><span class=cl>            <span class=o>}</span>  
</span></span><span class=line><span class=cl>        <span class=o>}).</span><span class=na>start</span><span class=o>();</span>  
</span></span><span class=line><span class=cl>    <span class=o>}</span>  
</span></span><span class=line><span class=cl><span class=o>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl><span class=c1>// 不可重入锁：  
</span></span></span><span class=line><span class=cl><span class=c1>// 仿ReentrantLock实现  
</span></span></span><span class=line><span class=cl><span class=c1>// 1. 实现Lock接口  
</span></span></span><span class=line><span class=cl><span class=c1>// 2. 使用AQS同步器类  
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>class</span> <span class=nc>MyLock</span> <span class=kd>implements</span> <span class=n>Lock</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=c1>// 同步器类  
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 锁的大部分功能是由该同步器类完成的  
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 实现一个独占锁：  
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>class</span> <span class=nc>MySync</span> <span class=kd>extends</span> <span class=n>AbstractQueuedSynchronizer</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>        <span class=c1>// 尝试获取锁  
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nd>@Override</span>  
</span></span><span class=line><span class=cl>        <span class=kd>protected</span> <span class=kt>boolean</span> <span class=nf>tryAcquire</span><span class=o>(</span><span class=kt>int</span> <span class=n>arg</span><span class=o>)</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>            <span class=c1>// 可能有其它线程同时尝试加锁，所以要用cas  
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>if</span> <span class=o>(</span><span class=n>compareAndSetState</span><span class=o>(</span><span class=n>0</span><span class=o>,</span> <span class=n>1</span><span class=o>))</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>                <span class=c1>// 加上锁了，设置owner为当前线程  
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>setExclusiveOwnerThread</span><span class=o>(</span><span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>());</span>  
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>            <span class=o>}</span>  
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>false</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>        <span class=o>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>        <span class=c1>// 尝试释放锁  
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nd>@Override</span>  
</span></span><span class=line><span class=cl>        <span class=kd>protected</span> <span class=kt>boolean</span> <span class=nf>tryRelease</span><span class=o>(</span><span class=kt>int</span> <span class=n>arg</span><span class=o>)</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>            <span class=c1>// 获取了锁，不用再和其它线程竞争  
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>setExclusiveOwnerThread</span><span class=o>(</span><span class=kc>null</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>            <span class=c1>// state是volatile的，所以这里放在最后，让写屏障能影响前面所有操作，保证之前的设置对所有线程可见  
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>setState</span><span class=o>(</span><span class=n>0</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>        <span class=o>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>        <span class=c1>// 是否持有独占锁  
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nd>@Override</span>  
</span></span><span class=line><span class=cl>        <span class=kd>protected</span> <span class=kt>boolean</span> <span class=nf>isHeldExclusively</span><span class=o>()</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>getState</span><span class=o>()</span> <span class=o>==</span> <span class=n>1</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>        <span class=o>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>        <span class=c1>// 返回一个条件变量  
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kd>public</span> <span class=n>Condition</span> <span class=nf>newCondition</span><span class=o>()</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>            <span class=c1>// AQS提供的一个内部类，可以直接使用  
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>return</span> <span class=k>new</span> <span class=n>ConditionObject</span><span class=o>();</span>  
</span></span><span class=line><span class=cl>        <span class=o>}</span>  
</span></span><span class=line><span class=cl>    <span class=o>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>MySync</span> <span class=n>sync</span> <span class=o>=</span> <span class=k>new</span> <span class=n>MySync</span><span class=o>();</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=c1>// 下面的抽象方法自己实现比较繁琐  
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 就可以利用同步器类，AQS实现了大部分方法  
</span></span></span><span class=line><span class=cl><span class=c1></span>  
</span></span><span class=line><span class=cl>    <span class=c1>// 加锁（尝试加锁，失败会进入队列等待）  
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nd>@Override</span>  
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>lock</span><span class=o>()</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>        <span class=n>sync</span><span class=o>.</span><span class=na>acquire</span><span class=o>(</span><span class=n>1</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>    <span class=o>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=c1>// 可打断加锁（加锁过程可打断）  
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nd>@Override</span>  
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>lockInterruptibly</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>InterruptedException</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>        <span class=n>sync</span><span class=o>.</span><span class=na>acquireInterruptibly</span><span class=o>(</span><span class=n>1</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>    <span class=o>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=c1>// 尝试加锁（尝试一次，失败直接返回false）  
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nd>@Override</span>  
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>tryLock</span><span class=o>()</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>sync</span><span class=o>.</span><span class=na>tryAcquire</span><span class=o>(</span><span class=n>1</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>    <span class=o>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=c1>// 带超时加锁  
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nd>@Override</span>  
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>tryLock</span><span class=o>(</span><span class=kt>long</span> <span class=n>time</span><span class=o>,</span> <span class=n>TimeUnit</span> <span class=n>unit</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>InterruptedException</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>sync</span><span class=o>.</span><span class=na>tryAcquireNanos</span><span class=o>(</span><span class=n>1</span><span class=o>,</span> <span class=n>unit</span><span class=o>.</span><span class=na>toNanos</span><span class=o>(</span><span class=n>time</span><span class=o>));</span>  
</span></span><span class=line><span class=cl>    <span class=o>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=c1>// 解锁  
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nd>@Override</span>  
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>unlock</span><span class=o>()</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>        <span class=c1>// 调用了tryRelease并唤醒正在阻塞的线程  
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>sync</span><span class=o>.</span><span class=na>release</span><span class=o>(</span><span class=n>1</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>    <span class=o>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=c1>// 创建条件变量  
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nd>@Override</span>  
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>Condition</span> <span class=nf>newCondition</span><span class=o>()</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>sync</span><span class=o>.</span><span class=na>newCondition</span><span class=o>();</span>  
</span></span><span class=line><span class=cl>    <span class=o>}</span>  
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#简介><h2 id=简介><span class=hanchor arialabel=Anchor># </span>简介</h2></a><p>AQS就是一个支持多个<a href=/2_0_2-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/2_0_2_1_2_3-%E8%BD%AF%E4%BB%B6%E7%B3%BB%E7%BB%9F/2_0_2_1_2_3_1-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E7%BA%BF%E7%A8%8B rel=noopener class=internal-link data-src=/2_0_2-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/2_0_2_1_2_3-%E8%BD%AF%E4%BB%B6%E7%B3%BB%E7%BB%9F/2_0_2_1_2_3_1-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E7%BA%BF%E7%A8%8B>线程</a>进来排队的先进先出（FIFO）的双端队列，通过自身设计来实现多个线程到达总能按一定顺序进入队列，不会因为同时入队抢占发生问题。同时在头部保证有序的向目标资源进行访问（线程获取资源权限）。</p><p><strong>AQS</strong>是<code>AbstractQueuedSynchronizer</code>的简称，即<code>抽象队列同步器</code>，从字面意思上理解:</p><ul><li>抽象：抽象类，只实现一些主要逻辑，有些方法由子类实现；</li><li>队列：使用先进先出（FIFO）队列存储数据；</li><li>同步：实现了同步的功能。</li></ul><p>AQS是一个用来构建锁和同步器的框架，使用AQS能简单且高效地构造出应用广泛的同步器，比如我们提到的ReentrantLock，Semaphore，ReentrantReadWriteLock，SynchronousQueue，FutureTask等等皆是基于AQS的。</p><p>当然，我们自己也能利用AQS非常轻松容易地构造出符合我们自己需求的同步器，只要子类实现它的几个<code>protected</code>方法就可以。</p><a href=#aqs的数据结构><h2 id=aqs的数据结构><span class=hanchor arialabel=Anchor># </span>AQS的数据结构</h2></a><p>AQS内部使用了一个<a href=/2_0_2-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/2_0_2_1_2_0-%E8%BD%AF%E4%BB%B6%E8%AF%AD%E8%A8%80/Java/1-%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/volatile rel=noopener class=internal-link data-src=/2_0_2-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/2_0_2_1_2_0-%E8%BD%AF%E4%BB%B6%E8%AF%AD%E8%A8%80/Java/1-%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/volatile>volatile</a>的变量state来作为资源的标识。同时定义了几个获取和改变state的protected方法，子类可以覆盖这些方法来实现自己的逻辑：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-3-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-1>1</a>
</span><span class=lnt id=hl-3-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-2>2</a>
</span><span class=lnt id=hl-3-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>getState</span><span class=o>()</span>
</span></span><span class=line><span class=cl><span class=n>setState</span><span class=o>()</span>
</span></span><span class=line><span class=cl><span class=n>compareAndSetState</span><span class=o>()</span>
</span></span></code></pre></td></tr></table></div></div><p>这三种操作均是原子操作，其中compareAndSetState的实现依赖于Unsafe的compareAndSwapInt()方法。</p><p>而AQS类本身实现的是<strong>一些排队和阻塞的机制</strong>，比如具体线程等待队列的维护（如获取资源失败入队/唤醒出队等）。</p><ol><li><p>内部可以是一个先进先出（FIFO）的双端队列（CLH队列，（Craig, Landin, and Hagersten 队列）），并使用了两个指针head和tail用于标识队列的头部和尾部。其数据结构如图：
<img src=/z-oblib/z2-attachments/AQS数据结构.png width=auto>
但它并不是直接储存线程，而是<strong>储存拥有线程的Node节点</strong>，因为是一个双向链表的结构，所以最小单元是Node，Node会包含前后节点的地址，还包括一个线程。</p></li><li><p>也可以是一个借助nextWaiter（见后续章节）实现的单向队列。</p></li></ol><a href=#资源共享模式><h3 id=资源共享模式><span class=hanchor arialabel=Anchor># </span>资源共享模式</h3></a><blockquote><p>一堆线程在排队等待资源，但资源可以同时只给一个线程用，或者支持多个线程同时用。</p></blockquote><p>资源有两种共享模式，或者说两种同步方式：</p><ul><li>独占模式（Exclusive）：资源是独占的，一次只能一个线程获取。如ReentrantLock。</li><li>共享模式（Share）：同时可以被多个线程获取，具体的资源个数可以通过参数指定。如Semaphore/CountDownLatch。</li></ul><p>一般情况下，子类只需要根据需求实现其中一种模式，当然也有同时实现两种模式的同步类，如<code>ReadWriteLock</code>。</p><a href=#node结构><h3 id=node结构><span class=hanchor arialabel=Anchor># </span>Node结构</h3></a><p>AQS中关于这两种资源共享模式的定义源码（均在内部类Node中）。我们来看看<strong>Node的结构</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-4-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-1> 1</a>
</span><span class=lnt id=hl-4-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-2> 2</a>
</span><span class=lnt id=hl-4-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-3> 3</a>
</span><span class=lnt id=hl-4-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-4> 4</a>
</span><span class=lnt id=hl-4-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-5> 5</a>
</span><span class=lnt id=hl-4-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-6> 6</a>
</span><span class=lnt id=hl-4-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-7> 7</a>
</span><span class=lnt id=hl-4-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-8> 8</a>
</span><span class=lnt id=hl-4-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-9> 9</a>
</span><span class=lnt id=hl-4-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-10>10</a>
</span><span class=lnt id=hl-4-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-11>11</a>
</span><span class=lnt id=hl-4-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-12>12</a>
</span><span class=lnt id=hl-4-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-13>13</a>
</span><span class=lnt id=hl-4-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-14>14</a>
</span><span class=lnt id=hl-4-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-15>15</a>
</span><span class=lnt id=hl-4-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-16>16</a>
</span><span class=lnt id=hl-4-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-17>17</a>
</span><span class=lnt id=hl-4-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-18>18</a>
</span><span class=lnt id=hl-4-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-19>19</a>
</span><span class=lnt id=hl-4-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-20>20</a>
</span><span class=lnt id=hl-4-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-21>21</a>
</span><span class=lnt id=hl-4-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-22>22</a>
</span><span class=lnt id=hl-4-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-23>23</a>
</span><span class=lnt id=hl-4-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-24>24</a>
</span><span class=lnt id=hl-4-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-25>25</a>
</span><span class=lnt id=hl-4-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-26>26</a>
</span><span class=lnt id=hl-4-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-27>27</a>
</span><span class=lnt id=hl-4-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-28>28</a>
</span><span class=lnt id=hl-4-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-29>29</a>
</span><span class=lnt id=hl-4-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-30>30</a>
</span><span class=lnt id=hl-4-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-31>31</a>
</span><span class=lnt id=hl-4-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-32>32</a>
</span><span class=lnt id=hl-4-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-33>33</a>
</span><span class=lnt id=hl-4-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-34>34</a>
</span><span class=lnt id=hl-4-35><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-35>35</a>
</span><span class=lnt id=hl-4-36><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-36>36</a>
</span><span class=lnt id=hl-4-37><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-37>37</a>
</span><span class=lnt id=hl-4-38><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-38>38</a>
</span><span class=lnt id=hl-4-39><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-39>39</a>
</span><span class=lnt id=hl-4-40><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-40>40</a>
</span><span class=lnt id=hl-4-41><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-41>41</a>
</span><span class=lnt id=hl-4-42><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-42>42</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span> <span class=kd>final</span> <span class=kd>class</span> <span class=nc>Node</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 标记一个结点（对应的线程）在共享模式下等待
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>static</span> <span class=kd>final</span> <span class=n>Node</span> <span class=n>SHARED</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Node</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 标记一个结点（对应的线程）在独占模式下等待
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>static</span> <span class=kd>final</span> <span class=n>Node</span> <span class=n>EXCLUSIVE</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// waitStatus的值，表示该结点（对应的线程）已被取消
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>CANCELLED</span> <span class=o>=</span> <span class=n>1</span><span class=o>;</span> 
</span></span><span class=line><span class=cl>    <span class=c1>// waitStatus的值，表示后继结点（对应的线程）需要被唤醒
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>SIGNAL</span> <span class=o>=</span> <span class=o>-</span><span class=n>1</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// waitStatus的值，表示该结点（对应的线程）在等待某一条件
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>CONDITION</span> <span class=o>=</span> <span class=o>-</span><span class=n>2</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=cm>/*waitStatus的值，表示有资源可用，新head结点需要继续唤醒后继结点（共享模式下，多线程并发释放资源，而head唤醒其后继结点后，需要把多出来的资源留给后面的结点；设置新的head结点时，会继续唤醒其后继结点）*/</span>
</span></span><span class=line><span class=cl>    <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>PROPAGATE</span> <span class=o>=</span> <span class=o>-</span><span class=n>3</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 等待状态，取值范围，-3，-2，-1，0，1
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>volatile</span> <span class=kt>int</span> <span class=n>waitStatus</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>volatile</span> <span class=n>Node</span> <span class=n>prev</span><span class=o>;</span> <span class=c1>// 前驱结点
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>volatile</span> <span class=n>Node</span> <span class=n>next</span><span class=o>;</span> <span class=c1>// 后继结点
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>volatile</span> <span class=n>Thread</span> <span class=n>thread</span><span class=o>;</span> <span class=c1>// 结点对应的线程
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>Node</span> <span class=n>nextWaiter</span><span class=o>;</span> <span class=c1>// 在CLH队列时，表示共享式或独占式标记，在条件队列时，表示下一个Node节点
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 判断共享模式的方法
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>final</span> <span class=kt>boolean</span> <span class=nf>isShared</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>nextWaiter</span> <span class=o>==</span> <span class=n>SHARED</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>Node</span><span class=o>(</span><span class=n>Thread</span> <span class=n>thread</span><span class=o>,</span> <span class=n>Node</span> <span class=n>mode</span><span class=o>)</span> <span class=o>{</span>     <span class=c1>// Used by addWaiter
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>this</span><span class=o>.</span><span class=na>nextWaiter</span> <span class=o>=</span> <span class=n>mode</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>thread</span> <span class=o>=</span> <span class=n>thread</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 其它方法忽略，可以参考具体的源码
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// AQS里面的addWaiter私有方法
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>private</span> <span class=n>Node</span> <span class=nf>addWaiter</span><span class=o>(</span><span class=n>Node</span> <span class=n>mode</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 使用了Node的这个构造函数
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>Node</span> <span class=n>node</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Node</span><span class=o>(</span><span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>(),</span> <span class=n>mode</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 其它代码省略
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>注意：通过Node我们可以实现两个队列，一是通过prev和next实现CLH队列(线程同步队列,双向队列)，二是nextWaiter实现Condition条件上的等待线程队列(单向队列)，这个Condition主要用在ReentrantLock类中。</p><p>waitStatus等待状态如下：
<img src=/z-oblib/z2-attachments/103e67d0d59543c4acfd4d0345dabfec.png width=auto></p><p> <strong>nextWaiter特殊标记</strong>：</p><ul><li>Node在CLH队列时，nextWaiter表示共享式或独占式标记；</li><li>Node在条件队列时，nextWaiter表示下个Node节点指针；</li></ul><a href=#aqs的主要方法源码解析><h2 id=aqs的主要方法源码解析><span class=hanchor arialabel=Anchor># </span>AQS的主要方法源码解析</h2></a><p>AQS的设计是基于<a href=/2_0_2-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/2_0_2_1_2_1-%E8%BD%AF%E4%BB%B6%E6%96%B9%E6%B3%95%E5%AD%A6/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E6%A8%A1%E6%9D%BF%E6%A8%A1%E5%BC%8F rel=noopener class=internal-link data-src=/2_0_2-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/2_0_2_1_2_1-%E8%BD%AF%E4%BB%B6%E6%96%B9%E6%B3%95%E5%AD%A6/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E6%A8%A1%E6%9D%BF%E6%A8%A1%E5%BC%8F>模板模式</a>的，它有一些方法必须要子类去实现的，它们主要有：</p><ul><li>isHeldExclusively()：该线程是否正在独占资源。只有用到condition才需要去实现它。</li><li>tryAcquire(int)：独占方式。尝试获取资源，成功则返回true，失败则返回false。</li><li>tryRelease(int)：独占方式。尝试释放资源，成功则返回true，失败则返回false。</li><li>tryAcquireShared(int)：共享方式。尝试获取资源。负数表示失败；0表示成功，但没有剩余可用资源；正数表示成功，且有剩余资源。</li><li>tryReleaseShared(int)：共享方式。尝试释放资源，如果释放后允许唤醒后续等待结点返回true，否则返回false。</li></ul><blockquote><p>子类需要实现在独占/共享模式下对资源的获取和释放的有针对性地逻辑部分。</p></blockquote><p>这些方法虽然都是<a href=/2_0_2-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/2_0_2_1_2_0-%E8%BD%AF%E4%BB%B6%E8%AF%AD%E8%A8%80/Java/0-%E8%AF%AD%E6%B3%95%E5%9F%BA%E7%A1%80/%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6%E7%AC%A6#protected rel=noopener class=internal-link data-src=/2_0_2-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/2_0_2_1_2_0-%E8%BD%AF%E4%BB%B6%E8%AF%AD%E8%A8%80/Java/0-%E8%AF%AD%E6%B3%95%E5%9F%BA%E7%A1%80/%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6%E7%AC%A6>protected</a>方法，但是它们并没有在AQS具体实现，而是直接抛出异常（这里不使用抽象方法的目的是：避免强迫子类中把所有的抽象方法都实现一遍，减少无用功，这样子类只需要实现自己关心的抽象方法即可，比如 Semaphore 只需要实现 tryAcquire 方法而不用实现其余不需要用到的模版方法）：</p><blockquote><p>而AQS实现了一系列（包括资源/释放）主要的逻辑。</p></blockquote><a href=#线程排队><h3 id=线程排队><span class=hanchor arialabel=Anchor># </span>线程排队</h3></a><p>获取资源的入口是acquire(int arg)方法。arg是要获取的资源的个数，在独占模式下始终为1。我们先来看看这个方法的逻辑：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-5-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-1>1</a>
</span><span class=lnt id=hl-5-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-2>2</a>
</span><span class=lnt id=hl-5-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-3>3</a>
</span><span class=lnt id=hl-5-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-4>4</a>
</span><span class=lnt id=hl-5-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>final</span> <span class=kt>void</span> <span class=nf>acquire</span><span class=o>(</span><span class=kt>int</span> <span class=n>arg</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(!</span><span class=n>tryAcquire</span><span class=o>(</span><span class=n>arg</span><span class=o>)</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>        <span class=n>acquireQueued</span><span class=o>(</span><span class=n>addWaiter</span><span class=o>(</span><span class=n>Node</span><span class=o>.</span><span class=na>EXCLUSIVE</span><span class=o>),</span> <span class=n>arg</span><span class=o>))</span>
</span></span><span class=line><span class=cl>        <span class=n>selfInterrupt</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>首先调用tryAcquire(arg)尝试去获取资源。前面提到了这个方法是在子类具体实现的。</p><p>如果获取资源失败，就通过addWaiter(Node.EXCLUSIVE)方法把这个线程插入到等待队列中。其中传入的参数代表要插入的Node是独占式的。这个方法的具体实现：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-6-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-1> 1</a>
</span><span class=lnt id=hl-6-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-2> 2</a>
</span><span class=lnt id=hl-6-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-3> 3</a>
</span><span class=lnt id=hl-6-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-4> 4</a>
</span><span class=lnt id=hl-6-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-5> 5</a>
</span><span class=lnt id=hl-6-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-6> 6</a>
</span><span class=lnt id=hl-6-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-7> 7</a>
</span><span class=lnt id=hl-6-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-8> 8</a>
</span><span class=lnt id=hl-6-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-9> 9</a>
</span><span class=lnt id=hl-6-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-10>10</a>
</span><span class=lnt id=hl-6-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-11>11</a>
</span><span class=lnt id=hl-6-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-12>12</a>
</span><span class=lnt id=hl-6-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-13>13</a>
</span><span class=lnt id=hl-6-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-14>14</a>
</span><span class=lnt id=hl-6-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-15>15</a>
</span><span class=lnt id=hl-6-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-16>16</a>
</span><span class=lnt id=hl-6-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-17>17</a>
</span><span class=lnt id=hl-6-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-18>18</a>
</span><span class=lnt id=hl-6-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-19>19</a>
</span><span class=lnt id=hl-6-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-20>20</a>
</span><span class=lnt id=hl-6-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-21>21</a>
</span><span class=lnt id=hl-6-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-22>22</a>
</span><span class=lnt id=hl-6-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-23>23</a>
</span><span class=lnt id=hl-6-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-24>24</a>
</span><span class=lnt id=hl-6-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-25>25</a>
</span><span class=lnt id=hl-6-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-26>26</a>
</span><span class=lnt id=hl-6-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-27>27</a>
</span><span class=lnt id=hl-6-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-28>28</a>
</span><span class=lnt id=hl-6-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-29>29</a>
</span><span class=lnt id=hl-6-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-30>30</a>
</span><span class=lnt id=hl-6-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-31>31</a>
</span><span class=lnt id=hl-6-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-32>32</a>
</span><span class=lnt id=hl-6-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-33>33</a>
</span><span class=lnt id=hl-6-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-34>34</a>
</span><span class=lnt id=hl-6-35><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-35>35</a>
</span><span class=lnt id=hl-6-36><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-36>36</a>
</span><span class=lnt id=hl-6-37><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-37>37</a>
</span><span class=lnt id=hl-6-38><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-38>38</a>
</span><span class=lnt id=hl-6-39><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-39>39</a>
</span><span class=lnt id=hl-6-40><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-40>40</a>
</span><span class=lnt id=hl-6-41><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-41>41</a>
</span><span class=lnt id=hl-6-42><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-42>42</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=n>Node</span> <span class=nf>addWaiter</span><span class=o>(</span><span class=n>Node</span> <span class=n>mode</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 生成该线程对应的Node节点
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>Node</span> <span class=n>node</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Node</span><span class=o>(</span><span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>(),</span> <span class=n>mode</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 获取尾节点
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>Node</span> <span class=n>pred</span> <span class=o>=</span> <span class=n>tail</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 如果前面还有其它节点
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>(</span><span class=n>pred</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>	    <span class=c1>// 将当前节点地前驱节点设置为队尾节点
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>node</span><span class=o>.</span><span class=na>prev</span> <span class=o>=</span> <span class=n>pred</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 使用CAS尝试将后继节点信息写入队尾节点，如果成功就返回
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// 使用CAS是为了处理多个线程同时想排队的情况
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=o>(</span><span class=n>compareAndSetTail</span><span class=o>(</span><span class=n>pred</span><span class=o>,</span> <span class=n>node</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>pred</span><span class=o>.</span><span class=na>next</span> <span class=o>=</span> <span class=n>node</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>node</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 如果等待队列为空或者上述CAS失败，再自旋CAS插入
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>enq</span><span class=o>(</span><span class=n>node</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>node</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 自旋CAS插入等待队列
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>private</span> <span class=n>Node</span> <span class=nf>enq</span><span class=o>(</span><span class=kd>final</span> <span class=n>Node</span> <span class=n>node</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=o>(;;)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Node</span> <span class=n>t</span> <span class=o>=</span> <span class=n>tail</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 如果等待队列为空
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=o>(</span><span class=n>t</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span> <span class=c1>// Must initialize
</span></span></span><span class=line><span class=cl><span class=c1></span>	        <span class=c1>// 创建一个空节点作为头节点（哨兵节点）
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>if</span> <span class=o>(</span><span class=n>compareAndSetHead</span><span class=o>(</span><span class=k>new</span> <span class=n>Node</span><span class=o>()))</span>
</span></span><span class=line><span class=cl>	            <span class=c1>// 并把队尾指向队首，及队伍中现在只有一个空节点，队首队尾都指向这个节点
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>tail</span> <span class=o>=</span> <span class=n>head</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 等待队列不为空
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>	        <span class=c1>// 使用CAS尝试将后继节点信息写入队尾节点，和之前函数一样，不过这里是在循环里一直去尝试
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>node</span><span class=o>.</span><span class=na>prev</span> <span class=o>=</span> <span class=n>t</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>compareAndSetTail</span><span class=o>(</span><span class=n>t</span><span class=o>,</span> <span class=n>node</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>t</span><span class=o>.</span><span class=na>next</span> <span class=o>=</span> <span class=n>node</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>t</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>上面的两个函数比较好理解，就是在队列的尾部插入新的Node节点，但是需要注意的是由于AQS中会存在多个线程同时争夺资源的情况，因此肯定会出现多个线程同时插入节点的操作，在这里是通过CAS自旋的方式保证了操作的线程安全性。</p></blockquote><a href=#获取资源><h3 id=获取资源><span class=hanchor arialabel=Anchor># </span>获取资源</h3></a><p>OK，现在回到最开始的aquire(int arg)方法。现在通过addWaiter方法，已经把一个Node放到等待队列尾部了。而等待队列的头节点获取资源，而队列中节点会依次成为头节点。具体的实现我们来看看acquireQueued方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-7-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-1> 1</a>
</span><span class=lnt id=hl-7-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-2> 2</a>
</span><span class=lnt id=hl-7-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-3> 3</a>
</span><span class=lnt id=hl-7-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-4> 4</a>
</span><span class=lnt id=hl-7-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-5> 5</a>
</span><span class=lnt id=hl-7-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-6> 6</a>
</span><span class=lnt id=hl-7-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-7> 7</a>
</span><span class=lnt id=hl-7-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-8> 8</a>
</span><span class=lnt id=hl-7-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-9> 9</a>
</span><span class=lnt id=hl-7-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-10>10</a>
</span><span class=lnt id=hl-7-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-11>11</a>
</span><span class=lnt id=hl-7-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-12>12</a>
</span><span class=lnt id=hl-7-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-13>13</a>
</span><span class=lnt id=hl-7-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-14>14</a>
</span><span class=lnt id=hl-7-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-15>15</a>
</span><span class=lnt id=hl-7-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-16>16</a>
</span><span class=lnt id=hl-7-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-17>17</a>
</span><span class=lnt id=hl-7-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-18>18</a>
</span><span class=lnt id=hl-7-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-19>19</a>
</span><span class=lnt id=hl-7-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-20>20</a>
</span><span class=lnt id=hl-7-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-21>21</a>
</span><span class=lnt id=hl-7-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-22>22</a>
</span><span class=lnt id=hl-7-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-23>23</a>
</span><span class=lnt id=hl-7-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-24>24</a>
</span><span class=lnt id=hl-7-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-25>25</a>
</span><span class=lnt id=hl-7-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-26>26</a>
</span><span class=lnt id=hl-7-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-27>27</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>final</span> <span class=kt>boolean</span> <span class=nf>acquireQueued</span><span class=o>(</span><span class=kd>final</span> <span class=n>Node</span> <span class=n>node</span><span class=o>,</span> <span class=kt>int</span> <span class=n>arg</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>boolean</span> <span class=n>failed</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>	    <span class=c1>// 设置中断状态为非中断
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kt>boolean</span> <span class=n>interrupted</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 自旋
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>for</span> <span class=o>(;;)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=kd>final</span> <span class=n>Node</span> <span class=n>p</span> <span class=o>=</span> <span class=n>node</span><span class=o>.</span><span class=na>predecessor</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 队首节点是当前已经获取到资源的结点或null，那么排在第二个位置的节点会循环尝试获取资源
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// 如果node的前驱结点p是head，表示node是第二个结点，就可以尝试去获取资源了
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>if</span> <span class=o>(</span><span class=n>p</span> <span class=o>==</span> <span class=n>head</span> <span class=o>&amp;&amp;</span> <span class=n>tryAcquire</span><span class=o>(</span><span class=n>arg</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 拿到资源后，说明之前的头节点释放资源了，将head指向当前节点，把前任队首踢出队伍。
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>setHead</span><span class=o>(</span><span class=n>node</span><span class=o>);</span> 
</span></span><span class=line><span class=cl>                <span class=n>p</span><span class=o>.</span><span class=na>next</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span> <span class=c1>// 清空上一任头节点的后继节点信息，帮助JVM回收垃圾
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>failed</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>interrupted</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 多次没获取到锁，可以休息了，就进入waiting状态，直到被unpark()
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>if</span> <span class=o>(</span><span class=n>shouldParkAfterFailedAcquire</span><span class=o>(</span><span class=n>p</span><span class=o>,</span> <span class=n>node</span><span class=o>)</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>                <span class=n>parkAndCheckInterrupt</span><span class=o>())</span>
</span></span><span class=line><span class=cl>                <span class=n>interrupted</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>failed</span><span class=o>)</span>
</span></span><span class=line><span class=cl>            <span class=n>cancelAcquire</span><span class=o>(</span><span class=n>node</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>这里parkAndCheckInterrupt方法内部使用到了LockSupport.park(this)，顺便简单介绍一下park。</p><p>LockSupport类是Java 6 引入的一个类，提供了基本的线程同步原语。LockSupport实际上是调用了Unsafe类里的函数，归结到Unsafe里，只有两个函数：</p><ul><li>park(boolean isAbsolute, long time)：阻塞当前线程</li><li>unpark(Thread jthread)：使给定的线程停止阻塞</li></ul></blockquote><p>所以<strong>结点进入等待队列后，是调用park使它进入阻塞状态的。只有头结点的线程是处于活跃状态的</strong>。</p><p>当然，获取资源的方法除了acquire外，还有以下三个：</p><ul><li>acquireInterruptibly：申请可中断的资源（独占模式）</li><li>acquireShared：申请共享模式的资源</li><li>acquireSharedInterruptibly：申请可中断的资源（共享模式）</li></ul><blockquote><p>可中断的意思是，在线程中断时可能会抛出<code>InterruptedException</code>。</p></blockquote><p><img src=/z-oblib/z2-attachments/acquire流程.png width=auto></p><a href=#释放资源><h3 id=释放资源><span class=hanchor arialabel=Anchor># </span>释放资源</h3></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-8-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-1> 1</a>
</span><span class=lnt id=hl-8-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-2> 2</a>
</span><span class=lnt id=hl-8-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-3> 3</a>
</span><span class=lnt id=hl-8-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-4> 4</a>
</span><span class=lnt id=hl-8-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-5> 5</a>
</span><span class=lnt id=hl-8-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-6> 6</a>
</span><span class=lnt id=hl-8-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-7> 7</a>
</span><span class=lnt id=hl-8-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-8> 8</a>
</span><span class=lnt id=hl-8-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-9> 9</a>
</span><span class=lnt id=hl-8-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-10>10</a>
</span><span class=lnt id=hl-8-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-11>11</a>
</span><span class=lnt id=hl-8-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-12>12</a>
</span><span class=lnt id=hl-8-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-13>13</a>
</span><span class=lnt id=hl-8-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-14>14</a>
</span><span class=lnt id=hl-8-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-15>15</a>
</span><span class=lnt id=hl-8-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-16>16</a>
</span><span class=lnt id=hl-8-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-17>17</a>
</span><span class=lnt id=hl-8-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-18>18</a>
</span><span class=lnt id=hl-8-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-19>19</a>
</span><span class=lnt id=hl-8-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-20>20</a>
</span><span class=lnt id=hl-8-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-21>21</a>
</span><span class=lnt id=hl-8-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-22>22</a>
</span><span class=lnt id=hl-8-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-23>23</a>
</span><span class=lnt id=hl-8-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-24>24</a>
</span><span class=lnt id=hl-8-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-25>25</a>
</span><span class=lnt id=hl-8-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-26>26</a>
</span><span class=lnt id=hl-8-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-27>27</a>
</span><span class=lnt id=hl-8-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-28>28</a>
</span><span class=lnt id=hl-8-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-29>29</a>
</span><span class=lnt id=hl-8-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-30>30</a>
</span><span class=lnt id=hl-8-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-31>31</a>
</span><span class=lnt id=hl-8-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-32>32</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>final</span> <span class=kt>boolean</span> <span class=nf>release</span><span class=o>(</span><span class=kt>int</span> <span class=n>arg</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>tryRelease</span><span class=o>(</span><span class=n>arg</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Node</span> <span class=n>h</span> <span class=o>=</span> <span class=n>head</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>h</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>h</span><span class=o>.</span><span class=na>waitStatus</span> <span class=o>!=</span> <span class=n>0</span><span class=o>)</span>
</span></span><span class=line><span class=cl>            <span class=n>unparkSuccessor</span><span class=o>(</span><span class=n>h</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 传入的参数是头节点
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>private</span> <span class=kt>void</span> <span class=nf>unparkSuccessor</span><span class=o>(</span><span class=n>Node</span> <span class=n>node</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 如果状态是负数，尝试把它设置为0
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>int</span> <span class=n>ws</span> <span class=o>=</span> <span class=n>node</span><span class=o>.</span><span class=na>waitStatus</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>ws</span> <span class=o>&lt;</span> <span class=n>0</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=n>compareAndSetWaitStatus</span><span class=o>(</span><span class=n>node</span><span class=o>,</span> <span class=n>ws</span><span class=o>,</span> <span class=n>0</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 得到头结点的后继结点head.next
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>Node</span> <span class=n>s</span> <span class=o>=</span> <span class=n>node</span><span class=o>.</span><span class=na>next</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 如果这个后继结点为空或者状态大于0
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 通过前面的定义我们知道，大于0只有一种可能，就是这个结点已被取消
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>(</span><span class=n>s</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span> <span class=n>s</span><span class=o>.</span><span class=na>waitStatus</span> <span class=o>&gt;</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>s</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>  <span class=c1>// 节点被取消则把节点删掉
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// 等待队列中所有还有用的结点，都向前移动
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// 从队尾向前遍历，取最靠近队首的未取消节点
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>for</span> <span class=o>(</span><span class=n>Node</span> <span class=n>t</span> <span class=o>=</span> <span class=n>tail</span><span class=o>;</span> <span class=n>t</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>t</span> <span class=o>!=</span> <span class=n>node</span><span class=o>;</span> <span class=n>t</span> <span class=o>=</span> <span class=n>t</span><span class=o>.</span><span class=na>prev</span><span class=o>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>t</span><span class=o>.</span><span class=na>waitStatus</span> <span class=o>&lt;=</span> <span class=n>0</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=n>s</span> <span class=o>=</span> <span class=n>t</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 如果后继结点不为空，
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>(</span><span class=n>s</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=n>LockSupport</span><span class=o>.</span><span class=na>unpark</span><span class=o>(</span><span class=n>s</span><span class=o>.</span><span class=na>thread</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div></article><hr><div class=page-end id=footer><div class=backlinks-container><h3>反向链接</h3><ul class=backlinks><li><a href=/2_0_2-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/2_0_2_1_2_0-%E8%BD%AF%E4%BB%B6%E8%AF%AD%E8%A8%80/Java/2-%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/%E9%94%81%E6%8E%A5%E5%8F%A3%E5%92%8C%E7%B1%BB/ data-ctx=AQS data-src=/2_0_2-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/2_0_2_1_2_0-%E8%BD%AF%E4%BB%B6%E8%AF%AD%E8%A8%80/Java/2-%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/%E9%94%81%E6%8E%A5%E5%8F%A3%E5%92%8C%E7%B1%BB class=internal-link>锁接口和类</a></li><li><a href=/2_0_2-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/2_0_2_1_2_0-%E8%BD%AF%E4%BB%B6%E8%AF%AD%E8%A8%80/Java/2-%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/CountdownLatch/ data-ctx=AQS data-src=/2_0_2-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/2_0_2_1_2_0-%E8%BD%AF%E4%BB%B6%E8%AF%AD%E8%A8%80/Java/2-%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/CountdownLatch class=internal-link>CountdownLatch</a></li><li><a href=/2_0_2-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/2_0_2_1_2_0-%E8%BD%AF%E4%BB%B6%E8%AF%AD%E8%A8%80/Java/2-%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/LinkedBlockingQueue/ data-ctx=AQS data-src=/2_0_2-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/2_0_2_1_2_0-%E8%BD%AF%E4%BB%B6%E8%AF%AD%E8%A8%80/Java/2-%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/LinkedBlockingQueue class=internal-link>LinkedBlockingQueue</a></li></ul></div><div><script src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>湾区地图</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://harbor.mffseal.top/js/graph.abd4bc2af3869a96524d7d23b76152c7.js></script></div></div><div id=contact_buttons><footer><p><a rel=license href=http://creativecommons.org/licenses/by-nc/4.0/><img alt="Creative Commons Licence" style=border-width:0 src=https://i.creativecommons.org/l/by-nc/4.0/88x31.png></a><br>本博客的博主原创文章均遵循 <a rel=license href=http://creativecommons.org/licenses/by-nc/4.0/>CC BY-NC(署名-非商业性使用) 4.0 国际协议</a><br>转载请附上原文出处链接及本声明</p><p>由 mffseal 使用 <a href=https://github.com/jackyzha0/quartz>Quartz</a> 开发, © 2022</p><ul><li><a href=https://harbor.mffseal.top/>港口</a></li><li><a href=https://github.com/mffseal>Github</a></li></ul></footer></div></div></body></html>