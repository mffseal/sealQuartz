<!doctype html><html lang=cn><head><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8920808282451934" crossorigin=anonymous></script><meta charset=utf-8><meta name=description content="一. NIO 基础 non-blocking io 非阻塞 IO
1. 三大组件 1.1 Channel & Buffer channel 有一点类似于 stream，它就是读写数据的双向通道，可以从 channel 将数据读入 buffer，也可以将 buffer 的数据写入 channel，而之前的 stream 要么是输入，要么是输出，channel 比 stream 更为底层"><title>一. NIO 基础</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://harbor.mffseal.top//icon.png><link href=https://harbor.mffseal.top/styles.7153093e4d1bbb584a28469cadfa3f88.min.css rel=stylesheet><link href=https://harbor.mffseal.top/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://harbor.mffseal.top/js/darkmode.9841b88d44c115f7419d485ee72d23a2.min.js></script>
<script src=https://harbor.mffseal.top/js/util.9825137f5e7825e8553c68ce39ac9e44.min.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js integrity=sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A crossorigin=anonymous></script>
<script src=https://unpkg.com/@floating-ui/core@0.7.3></script>
<script src=https://unpkg.com/@floating-ui/dom@0.5.4></script>
<script src=https://harbor.mffseal.top/js/popover.53ad9a087e3feeaaa12b63bfd02d923b.min.js></script>
<script src=https://harbor.mffseal.top/js/code-title.b35124ad8db0ba37162b886afb711cbc.min.js></script>
<script src=https://harbor.mffseal.top/js/clipboard.c20857734e53a3fb733b7443879efa61.min.js></script>
<script src=https://harbor.mffseal.top/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const BASE_URL="https://harbor.mffseal.top/",fetchData=Promise.all([fetch("https://harbor.mffseal.top/indices/linkIndex.5da375bc9ca1d813eb68255e2c0afb35.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://harbor.mffseal.top/indices/contentIndex.6ca0d16235aec98652b5c1d82e7af95e.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addTitleToCodeBlocks(),addCollapsibleCallouts(),initPopover("https://harbor.mffseal.top",!0,!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!0;drawGraph("https://harbor.mffseal.top",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],macros:{'’':"'"},throwOnError:!1})}</script><script type=module>
    import { attachSPARouting } from "https:\/\/harbor.mffseal.top\/js\/router.9d4974281069e9ebb189f642ae1e3ca2.min.js"
    attachSPARouting(init, render)
  </script></head><script async src="https://www.googletagmanager.com/gtag/js?id=G-NV58SYWRZD"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-NV58SYWRZD",{anonymize_ip:!1})}</script><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=搜索 placeholder=搜一搜...><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://harbor.mffseal.top/js/full-text-search.24827f874defbbc6d529926cbfcfb493.min.js></script><div class=singlePage><header><h1 id=page-title><a href=https://harbor.mffseal.top/>🦭 港湾</a></h1><div class=spacer></div><div id=search-icon><p>搜索</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">搜索图标</title><desc id="desc">打开搜索图标</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>亮色</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>暗色</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><h1>一. NIO 基础</h1><p class=meta>最后更新
Jun 20, 2022
<a href=https://github.com/mffseal/2_0_2-%e8%ae%a1%e7%ae%97%e6%9c%ba%e7%a7%91%e5%ad%a6/2_0_2_1_2_0-%e8%bd%af%e4%bb%b6%e8%af%ad%e8%a8%80/Java/NIO/NIO%e5%9f%ba%e7%a1%80.md rel=noopener>编辑源</a></p><ul class=tags></ul><aside class=mainTOC><details><summary>导航</summary><nav id=TableOfContents><ol><li><a href=#1-三大组件>1. 三大组件</a><ol><li><a href=#11-channel--buffer>1.1 Channel & Buffer</a></li><li><a href=#12-selector>1.2 Selector</a></li></ol></li><li><a href=#2-bytebuffer>2. ByteBuffer</a><ol><li><a href=#21-bytebuffer-正确使用姿势>2.1 ByteBuffer 正确使用姿势</a></li><li><a href=#22-bytebuffer-结构>2.2 ByteBuffer 结构</a></li><li><a href=#23-bytebuffer-常见方法>2.3 ByteBuffer 常见方法</a></li><li><a href=#24-scattering-reads>2.4 Scattering Reads</a></li><li><a href=#25-gathering-writes>2.5 Gathering Writes</a></li><li><a href=#26-练习>2.6 练习</a></li></ol></li><li><a href=#3-文件编程>3. 文件编程</a><ol><li><a href=#31-filechannel>3.1 FileChannel</a></li><li><a href=#32-两个-channel-传输数据>3.2 两个 Channel 传输数据</a></li><li><a href=#33-path>3.3 Path</a></li><li><a href=#34-files>3.4 Files</a></li></ol></li><li><a href=#4-网络编程>4. 网络编程</a><ol><li><a href=#41-非阻塞-vs-阻塞>4.1 非阻塞 vs 阻塞</a></li><li><a href=#42-selector>4.2 Selector</a></li><li><a href=#43-处理-accept-事件>4.3 处理 accept 事件</a></li><li><a href=#44-处理-read-事件>4.4 处理 read 事件</a></li><li><a href=#45-处理-write-事件>4.5 处理 write 事件</a></li><li><a href=#46-更进一步>4.6 更进一步</a></li><li><a href=#47-udp>4.7 UDP</a></li></ol></li><li><a href=#5-nio-vs-bio>5. NIO vs BIO</a><ol><li><a href=#51-stream-vs-channel>5.1 stream vs channel</a></li><li><a href=#-52-io-模型>💡 5.2 IO 模型</a></li><li><a href=#53-零拷贝>5.3 零拷贝</a></li><li><a href=#53-aio>5.3 AIO</a></li></ol></li></ol></nav></details></aside><a href=#一-nio-基础><h1 id=一-nio-基础><span class=hanchor arialabel=Anchor># </span>一. NIO 基础</h1></a><p>non-blocking io 非阻塞 IO</p><a href=#1-三大组件><h2 id=1-三大组件><span class=hanchor arialabel=Anchor># </span>1. 三大组件</h2></a><a href=#11-channel--buffer><h3 id=11-channel--buffer><span class=hanchor arialabel=Anchor># </span>1.1 Channel & Buffer</h3></a><p>channel 有一点类似于 stream，它就是读写数据的<strong>双向通道</strong>，可以从 channel 将数据读入 buffer，也可以将 buffer 的数据写入 channel，而之前的 stream 要么是输入，要么是输出，channel 比 stream 更为底层</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-0-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-1>1</a>
</span><span class=lnt id=hl-0-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-2>2</a>
</span><span class=lnt id=hl-0-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>graph LR
</span></span><span class=line><span class=cl>channel --&gt; buffer
</span></span><span class=line><span class=cl>buffer --&gt; channel
</span></span></code></pre></td></tr></table></div></div><p>常见的 Channel 有</p><ul><li>FileChannel</li><li>DatagramChannel</li><li>SocketChannel</li><li>ServerSocketChannel</li></ul><p>buffer 则用来缓冲读写数据，常见的 buffer 有</p><ul><li>ByteBuffer<ul><li>MappedByteBuffer</li><li>DirectByteBuffer</li><li>HeapByteBuffer</li></ul></li><li>ShortBuffer</li><li>IntBuffer</li><li>LongBuffer</li><li>FloatBuffer</li><li>DoubleBuffer</li><li>CharBuffer</li></ul><a href=#12-selector><h3 id=12-selector><span class=hanchor arialabel=Anchor># </span>1.2 Selector</h3></a><p>selector 单从字面意思不好理解，需要结合服务器的设计演化来理解它的用途</p><a href=#多线程版设计><h4 id=多线程版设计><span class=hanchor arialabel=Anchor># </span>多线程版设计</h4></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-1-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-1>1</a>
</span><span class=lnt id=hl-1-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-2>2</a>
</span><span class=lnt id=hl-1-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-3>3</a>
</span><span class=lnt id=hl-1-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-4>4</a>
</span><span class=lnt id=hl-1-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-5>5</a>
</span><span class=lnt id=hl-1-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>graph TD
</span></span><span class=line><span class=cl>subgraph 多线程版
</span></span><span class=line><span class=cl>t1(thread) --&gt; s1(socket1)
</span></span><span class=line><span class=cl>t2(thread) --&gt; s2(socket2)
</span></span><span class=line><span class=cl>t3(thread) --&gt; s3(socket3)
</span></span><span class=line><span class=cl>end
</span></span></code></pre></td></tr></table></div></div><a href=#-多线程版缺点><h4 id=-多线程版缺点><span class=hanchor arialabel=Anchor># </span>⚠️ 多线程版缺点</h4></a><ul><li>内存占用高</li><li>线程上下文切换成本高</li><li>只适合连接数少的场景</li></ul><a href=#线程池版设计><h4 id=线程池版设计><span class=hanchor arialabel=Anchor># </span>线程池版设计</h4></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-2-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-1>1</a>
</span><span class=lnt id=hl-2-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-2>2</a>
</span><span class=lnt id=hl-2-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-3>3</a>
</span><span class=lnt id=hl-2-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-4>4</a>
</span><span class=lnt id=hl-2-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-5>5</a>
</span><span class=lnt id=hl-2-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-6>6</a>
</span><span class=lnt id=hl-2-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>graph TD
</span></span><span class=line><span class=cl>subgraph 线程池版
</span></span><span class=line><span class=cl>t4(thread) --&gt; s4(socket1)
</span></span><span class=line><span class=cl>t5(thread) --&gt; s5(socket2)
</span></span><span class=line><span class=cl>t4(thread) -.-&gt; s6(socket3)
</span></span><span class=line><span class=cl>t5(thread) -.-&gt; s7(socket4)
</span></span><span class=line><span class=cl>end
</span></span></code></pre></td></tr></table></div></div><a href=#-线程池版缺点><h4 id=-线程池版缺点><span class=hanchor arialabel=Anchor># </span>⚠️ 线程池版缺点</h4></a><ul><li>阻塞模式下，线程仅能处理一个 socket 连接</li><li>仅适合短连接场景</li></ul><blockquote><p>Socket API 工作在阻塞模式下：一个线程同时只能处理一个socket连接，直到socket断开。
早期Tomcat用此设计思路来处理HTTP等短连接较多的场景，适合HTTP1.0短链接，不适合HTTP1.1长连接。</p></blockquote><a href=#selector-版设计><h4 id=selector-版设计><span class=hanchor arialabel=Anchor># </span>selector 版设计</h4></a><blockquote><p>底层是调用了操作系统的 select&poll&epoll 接口。</p></blockquote><p>selector 的作用就是配合一个线程来管理多个 channel，获取这些 channel 上发生的事件，这些 channel 工作在<strong>非阻塞</strong>模式下，不会让线程吊死在一个 channel 上。适合连接数特别多，但流量低的场景（low traffic）。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-3-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-1>1</a>
</span><span class=lnt id=hl-3-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-2>2</a>
</span><span class=lnt id=hl-3-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-3>3</a>
</span><span class=lnt id=hl-3-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-4>4</a>
</span><span class=lnt id=hl-3-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-5>5</a>
</span><span class=lnt id=hl-3-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-6>6</a>
</span><span class=lnt id=hl-3-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>graph TD
</span></span><span class=line><span class=cl>subgraph selector 版
</span></span><span class=line><span class=cl>thread --&gt; selector
</span></span><span class=line><span class=cl>selector --&gt; c1(channel)
</span></span><span class=line><span class=cl>selector --&gt; c2(channel)
</span></span><span class=line><span class=cl>selector --&gt; c3(channel)
</span></span><span class=line><span class=cl>end
</span></span></code></pre></td></tr></table></div></div><p>调用 selector 的 select() 会阻塞直到 channel 发生了读写就绪事件，这些事件发生，select 方法就会返回这些事件交给 thread 来处理</p><a href=#2-bytebuffer><h2 id=2-bytebuffer><span class=hanchor arialabel=Anchor># </span>2. ByteBuffer</h2></a><p>有一普通文本文件 data.txt，内容为</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-4-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>1234567890abcd
</span></span></code></pre></td></tr></table></div></div><p>使用 FileChannel 来读取文件内容</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-5-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-1> 1</a>
</span><span class=lnt id=hl-5-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-2> 2</a>
</span><span class=lnt id=hl-5-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-3> 3</a>
</span><span class=lnt id=hl-5-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-4> 4</a>
</span><span class=lnt id=hl-5-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-5> 5</a>
</span><span class=lnt id=hl-5-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-6> 6</a>
</span><span class=lnt id=hl-5-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-7> 7</a>
</span><span class=lnt id=hl-5-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-8> 8</a>
</span><span class=lnt id=hl-5-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-9> 9</a>
</span><span class=lnt id=hl-5-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-10>10</a>
</span><span class=lnt id=hl-5-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-11>11</a>
</span><span class=lnt id=hl-5-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-12>12</a>
</span><span class=lnt id=hl-5-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-13>13</a>
</span><span class=lnt id=hl-5-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-14>14</a>
</span><span class=lnt id=hl-5-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-15>15</a>
</span><span class=lnt id=hl-5-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-16>16</a>
</span><span class=lnt id=hl-5-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-17>17</a>
</span><span class=lnt id=hl-5-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-18>18</a>
</span><span class=lnt id=hl-5-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-19>19</a>
</span><span class=lnt id=hl-5-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-20>20</a>
</span><span class=lnt id=hl-5-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-21>21</a>
</span><span class=lnt id=hl-5-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-22>22</a>
</span><span class=lnt id=hl-5-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-23>23</a>
</span><span class=lnt id=hl-5-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-24>24</a>
</span><span class=lnt id=hl-5-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-25>25</a>
</span><span class=lnt id=hl-5-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-26>26</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>ChannelDemo1</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>(</span><span class=n>RandomAccessFile</span> <span class=n>file</span> <span class=o>=</span> <span class=k>new</span> <span class=n>RandomAccessFile</span><span class=o>(</span><span class=s>&#34;helloword/data.txt&#34;</span><span class=o>,</span> <span class=s>&#34;rw&#34;</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>FileChannel</span> <span class=n>channel</span> <span class=o>=</span> <span class=n>file</span><span class=o>.</span><span class=na>getChannel</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>ByteBuffer</span> <span class=n>buffer</span> <span class=o>=</span> <span class=n>ByteBuffer</span><span class=o>.</span><span class=na>allocate</span><span class=o>(</span><span class=n>10</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=k>do</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 向 buffer 写入
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=kt>int</span> <span class=n>len</span> <span class=o>=</span> <span class=n>channel</span><span class=o>.</span><span class=na>read</span><span class=o>(</span><span class=n>buffer</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;读到字节数：{}&#34;</span><span class=o>,</span> <span class=n>len</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>len</span> <span class=o>==</span> <span class=o>-</span><span class=n>1</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 切换 buffer 读模式
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>buffer</span><span class=o>.</span><span class=na>flip</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=k>while</span><span class=o>(</span><span class=n>buffer</span><span class=o>.</span><span class=na>hasRemaining</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;{}&#34;</span><span class=o>,</span> <span class=o>(</span><span class=kt>char</span><span class=o>)</span><span class=n>buffer</span><span class=o>.</span><span class=na>get</span><span class=o>());</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 切换 buffer 写模式
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>buffer</span><span class=o>.</span><span class=na>clear</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>while</span> <span class=o>(</span><span class=kc>true</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-6-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-1> 1</a>
</span><span class=lnt id=hl-6-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-2> 2</a>
</span><span class=lnt id=hl-6-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-3> 3</a>
</span><span class=lnt id=hl-6-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-4> 4</a>
</span><span class=lnt id=hl-6-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-5> 5</a>
</span><span class=lnt id=hl-6-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-6> 6</a>
</span><span class=lnt id=hl-6-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-7> 7</a>
</span><span class=lnt id=hl-6-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-8> 8</a>
</span><span class=lnt id=hl-6-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-9> 9</a>
</span><span class=lnt id=hl-6-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-10>10</a>
</span><span class=lnt id=hl-6-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-11>11</a>
</span><span class=lnt id=hl-6-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-12>12</a>
</span><span class=lnt id=hl-6-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-13>13</a>
</span><span class=lnt id=hl-6-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-14>14</a>
</span><span class=lnt id=hl-6-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-15>15</a>
</span><span class=lnt id=hl-6-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-16>16</a>
</span><span class=lnt id=hl-6-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-17>17</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 读到字节数：10
</span></span><span class=line><span class=cl>10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 1
</span></span><span class=line><span class=cl>10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 2
</span></span><span class=line><span class=cl>10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 3
</span></span><span class=line><span class=cl>10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 4
</span></span><span class=line><span class=cl>10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 5
</span></span><span class=line><span class=cl>10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 6
</span></span><span class=line><span class=cl>10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 7
</span></span><span class=line><span class=cl>10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 8
</span></span><span class=line><span class=cl>10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 9
</span></span><span class=line><span class=cl>10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 0
</span></span><span class=line><span class=cl>10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 读到字节数：4
</span></span><span class=line><span class=cl>10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - a
</span></span><span class=line><span class=cl>10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - b
</span></span><span class=line><span class=cl>10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - c
</span></span><span class=line><span class=cl>10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - d
</span></span><span class=line><span class=cl>10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 读到字节数：-1
</span></span></code></pre></td></tr></table></div></div><a href=#21-bytebuffer-正确使用姿势><h3 id=21-bytebuffer-正确使用姿势><span class=hanchor arialabel=Anchor># </span>2.1 ByteBuffer 正确使用姿势</h3></a><ol><li>向 buffer 写入数据，例如调用 channel.read(buffer) (从channel读，并写入到buffer)</li><li>调用 <code>flip()</code> 切换至<strong>读模式</strong></li><li>从 buffer 读取数据，例如调用 buffer.get()</li><li>调用 <code>clear()</code> 或 <code>compact()</code> 切换至<strong>写模式</strong></li><li>重复 1~4 步骤</li></ol><a href=#22-bytebuffer-结构><h3 id=22-bytebuffer-结构><span class=hanchor arialabel=Anchor># </span>2.2 ByteBuffer 结构</h3></a><p>ByteBuffer 有以下重要属性</p><ul><li>capacity 容量</li><li>position 读写指针下标</li><li>limit 读写量限制</li></ul><p>一开始</p><p><img src=/z-oblib/z2-attachments/c8a78053293105a1ce22334ebe26853f.png width=auto></p><p>写模式下，position 是写入位置，limit 等于容量，下图表示写入了 4 个字节后的状态</p><p><img src=/z-oblib/z2-attachments/86a06b91acb74a9c2ff00a10004bdc3d.png width=auto></p><p>flip 动作发生后，position 切换为读取位置，limit 切换为读取限制</p><p><img src=/z-oblib/z2-attachments/c3197ff6217affbbcc20ab865ae58ee1.png width=auto></p><p>读取 4 个字节后，状态</p><p><img src=/z-oblib/z2-attachments/8202e9da57d2a913d86d057dc5140226.png width=auto></p><p>clear 动作发生后，状态</p><p><img src=/z-oblib/z2-attachments/c8a78053293105a1ce22334ebe26853f.png width=auto></p><p>compact 方法，是把未读完的部分向前压缩，然后切换至写模式</p><p><img src=/z-oblib/z2-attachments/a46df9c4e66a8e545792dbedfc4650fd.png width=auto></p><a href=#-调试工具类><h4 id=-调试工具类><span class=hanchor arialabel=Anchor># </span>💡 调试工具类</h4></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-7-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-1>  1</a>
</span><span class=lnt id=hl-7-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-2>  2</a>
</span><span class=lnt id=hl-7-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-3>  3</a>
</span><span class=lnt id=hl-7-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-4>  4</a>
</span><span class=lnt id=hl-7-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-5>  5</a>
</span><span class=lnt id=hl-7-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-6>  6</a>
</span><span class=lnt id=hl-7-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-7>  7</a>
</span><span class=lnt id=hl-7-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-8>  8</a>
</span><span class=lnt id=hl-7-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-9>  9</a>
</span><span class=lnt id=hl-7-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-10> 10</a>
</span><span class=lnt id=hl-7-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-11> 11</a>
</span><span class=lnt id=hl-7-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-12> 12</a>
</span><span class=lnt id=hl-7-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-13> 13</a>
</span><span class=lnt id=hl-7-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-14> 14</a>
</span><span class=lnt id=hl-7-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-15> 15</a>
</span><span class=lnt id=hl-7-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-16> 16</a>
</span><span class=lnt id=hl-7-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-17> 17</a>
</span><span class=lnt id=hl-7-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-18> 18</a>
</span><span class=lnt id=hl-7-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-19> 19</a>
</span><span class=lnt id=hl-7-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-20> 20</a>
</span><span class=lnt id=hl-7-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-21> 21</a>
</span><span class=lnt id=hl-7-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-22> 22</a>
</span><span class=lnt id=hl-7-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-23> 23</a>
</span><span class=lnt id=hl-7-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-24> 24</a>
</span><span class=lnt id=hl-7-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-25> 25</a>
</span><span class=lnt id=hl-7-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-26> 26</a>
</span><span class=lnt id=hl-7-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-27> 27</a>
</span><span class=lnt id=hl-7-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-28> 28</a>
</span><span class=lnt id=hl-7-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-29> 29</a>
</span><span class=lnt id=hl-7-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-30> 30</a>
</span><span class=lnt id=hl-7-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-31> 31</a>
</span><span class=lnt id=hl-7-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-32> 32</a>
</span><span class=lnt id=hl-7-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-33> 33</a>
</span><span class=lnt id=hl-7-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-34> 34</a>
</span><span class=lnt id=hl-7-35><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-35> 35</a>
</span><span class=lnt id=hl-7-36><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-36> 36</a>
</span><span class=lnt id=hl-7-37><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-37> 37</a>
</span><span class=lnt id=hl-7-38><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-38> 38</a>
</span><span class=lnt id=hl-7-39><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-39> 39</a>
</span><span class=lnt id=hl-7-40><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-40> 40</a>
</span><span class=lnt id=hl-7-41><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-41> 41</a>
</span><span class=lnt id=hl-7-42><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-42> 42</a>
</span><span class=lnt id=hl-7-43><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-43> 43</a>
</span><span class=lnt id=hl-7-44><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-44> 44</a>
</span><span class=lnt id=hl-7-45><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-45> 45</a>
</span><span class=lnt id=hl-7-46><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-46> 46</a>
</span><span class=lnt id=hl-7-47><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-47> 47</a>
</span><span class=lnt id=hl-7-48><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-48> 48</a>
</span><span class=lnt id=hl-7-49><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-49> 49</a>
</span><span class=lnt id=hl-7-50><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-50> 50</a>
</span><span class=lnt id=hl-7-51><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-51> 51</a>
</span><span class=lnt id=hl-7-52><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-52> 52</a>
</span><span class=lnt id=hl-7-53><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-53> 53</a>
</span><span class=lnt id=hl-7-54><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-54> 54</a>
</span><span class=lnt id=hl-7-55><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-55> 55</a>
</span><span class=lnt id=hl-7-56><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-56> 56</a>
</span><span class=lnt id=hl-7-57><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-57> 57</a>
</span><span class=lnt id=hl-7-58><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-58> 58</a>
</span><span class=lnt id=hl-7-59><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-59> 59</a>
</span><span class=lnt id=hl-7-60><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-60> 60</a>
</span><span class=lnt id=hl-7-61><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-61> 61</a>
</span><span class=lnt id=hl-7-62><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-62> 62</a>
</span><span class=lnt id=hl-7-63><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-63> 63</a>
</span><span class=lnt id=hl-7-64><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-64> 64</a>
</span><span class=lnt id=hl-7-65><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-65> 65</a>
</span><span class=lnt id=hl-7-66><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-66> 66</a>
</span><span class=lnt id=hl-7-67><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-67> 67</a>
</span><span class=lnt id=hl-7-68><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-68> 68</a>
</span><span class=lnt id=hl-7-69><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-69> 69</a>
</span><span class=lnt id=hl-7-70><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-70> 70</a>
</span><span class=lnt id=hl-7-71><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-71> 71</a>
</span><span class=lnt id=hl-7-72><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-72> 72</a>
</span><span class=lnt id=hl-7-73><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-73> 73</a>
</span><span class=lnt id=hl-7-74><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-74> 74</a>
</span><span class=lnt id=hl-7-75><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-75> 75</a>
</span><span class=lnt id=hl-7-76><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-76> 76</a>
</span><span class=lnt id=hl-7-77><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-77> 77</a>
</span><span class=lnt id=hl-7-78><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-78> 78</a>
</span><span class=lnt id=hl-7-79><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-79> 79</a>
</span><span class=lnt id=hl-7-80><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-80> 80</a>
</span><span class=lnt id=hl-7-81><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-81> 81</a>
</span><span class=lnt id=hl-7-82><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-82> 82</a>
</span><span class=lnt id=hl-7-83><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-83> 83</a>
</span><span class=lnt id=hl-7-84><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-84> 84</a>
</span><span class=lnt id=hl-7-85><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-85> 85</a>
</span><span class=lnt id=hl-7-86><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-86> 86</a>
</span><span class=lnt id=hl-7-87><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-87> 87</a>
</span><span class=lnt id=hl-7-88><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-88> 88</a>
</span><span class=lnt id=hl-7-89><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-89> 89</a>
</span><span class=lnt id=hl-7-90><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-90> 90</a>
</span><span class=lnt id=hl-7-91><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-91> 91</a>
</span><span class=lnt id=hl-7-92><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-92> 92</a>
</span><span class=lnt id=hl-7-93><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-93> 93</a>
</span><span class=lnt id=hl-7-94><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-94> 94</a>
</span><span class=lnt id=hl-7-95><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-95> 95</a>
</span><span class=lnt id=hl-7-96><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-96> 96</a>
</span><span class=lnt id=hl-7-97><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-97> 97</a>
</span><span class=lnt id=hl-7-98><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-98> 98</a>
</span><span class=lnt id=hl-7-99><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-99> 99</a>
</span><span class=lnt id=hl-7-100><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-100>100</a>
</span><span class=lnt id=hl-7-101><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-101>101</a>
</span><span class=lnt id=hl-7-102><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-102>102</a>
</span><span class=lnt id=hl-7-103><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-103>103</a>
</span><span class=lnt id=hl-7-104><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-104>104</a>
</span><span class=lnt id=hl-7-105><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-105>105</a>
</span><span class=lnt id=hl-7-106><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-106>106</a>
</span><span class=lnt id=hl-7-107><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-107>107</a>
</span><span class=lnt id=hl-7-108><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-108>108</a>
</span><span class=lnt id=hl-7-109><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-109>109</a>
</span><span class=lnt id=hl-7-110><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-110>110</a>
</span><span class=lnt id=hl-7-111><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-111>111</a>
</span><span class=lnt id=hl-7-112><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-112>112</a>
</span><span class=lnt id=hl-7-113><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-113>113</a>
</span><span class=lnt id=hl-7-114><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-114>114</a>
</span><span class=lnt id=hl-7-115><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-115>115</a>
</span><span class=lnt id=hl-7-116><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-116>116</a>
</span><span class=lnt id=hl-7-117><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-117>117</a>
</span><span class=lnt id=hl-7-118><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-118>118</a>
</span><span class=lnt id=hl-7-119><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-119>119</a>
</span><span class=lnt id=hl-7-120><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-120>120</a>
</span><span class=lnt id=hl-7-121><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-121>121</a>
</span><span class=lnt id=hl-7-122><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-122>122</a>
</span><span class=lnt id=hl-7-123><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-123>123</a>
</span><span class=lnt id=hl-7-124><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-124>124</a>
</span><span class=lnt id=hl-7-125><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-125>125</a>
</span><span class=lnt id=hl-7-126><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-126>126</a>
</span><span class=lnt id=hl-7-127><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-127>127</a>
</span><span class=lnt id=hl-7-128><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-128>128</a>
</span><span class=lnt id=hl-7-129><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-129>129</a>
</span><span class=lnt id=hl-7-130><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-130>130</a>
</span><span class=lnt id=hl-7-131><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-131>131</a>
</span><span class=lnt id=hl-7-132><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-132>132</a>
</span><span class=lnt id=hl-7-133><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-133>133</a>
</span><span class=lnt id=hl-7-134><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-134>134</a>
</span><span class=lnt id=hl-7-135><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-135>135</a>
</span><span class=lnt id=hl-7-136><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-136>136</a>
</span><span class=lnt id=hl-7-137><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-137>137</a>
</span><span class=lnt id=hl-7-138><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-138>138</a>
</span><span class=lnt id=hl-7-139><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-139>139</a>
</span><span class=lnt id=hl-7-140><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-140>140</a>
</span><span class=lnt id=hl-7-141><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-141>141</a>
</span><span class=lnt id=hl-7-142><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-142>142</a>
</span><span class=lnt id=hl-7-143><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-143>143</a>
</span><span class=lnt id=hl-7-144><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-144>144</a>
</span><span class=lnt id=hl-7-145><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-145>145</a>
</span><span class=lnt id=hl-7-146><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-146>146</a>
</span><span class=lnt id=hl-7-147><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-147>147</a>
</span><span class=lnt id=hl-7-148><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-148>148</a>
</span><span class=lnt id=hl-7-149><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-149>149</a>
</span><span class=lnt id=hl-7-150><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-150>150</a>
</span><span class=lnt id=hl-7-151><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-151>151</a>
</span><span class=lnt id=hl-7-152><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-152>152</a>
</span><span class=lnt id=hl-7-153><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-153>153</a>
</span><span class=lnt id=hl-7-154><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-154>154</a>
</span><span class=lnt id=hl-7-155><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-155>155</a>
</span><span class=lnt id=hl-7-156><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-156>156</a>
</span><span class=lnt id=hl-7-157><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-157>157</a>
</span><span class=lnt id=hl-7-158><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-158>158</a>
</span><span class=lnt id=hl-7-159><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-159>159</a>
</span><span class=lnt id=hl-7-160><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-160>160</a>
</span><span class=lnt id=hl-7-161><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-161>161</a>
</span><span class=lnt id=hl-7-162><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-162>162</a>
</span><span class=lnt id=hl-7-163><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-163>163</a>
</span><span class=lnt id=hl-7-164><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-164>164</a>
</span><span class=lnt id=hl-7-165><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-165>165</a>
</span><span class=lnt id=hl-7-166><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-166>166</a>
</span><span class=lnt id=hl-7-167><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-167>167</a>
</span><span class=lnt id=hl-7-168><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-168>168</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>ByteBufferUtil</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>char</span><span class=o>[]</span> <span class=n>BYTE2CHAR</span> <span class=o>=</span> <span class=k>new</span> <span class=kt>char</span><span class=o>[</span><span class=n>256</span><span class=o>];</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>char</span><span class=o>[]</span> <span class=n>HEXDUMP_TABLE</span> <span class=o>=</span> <span class=k>new</span> <span class=kt>char</span><span class=o>[</span><span class=n>256</span> <span class=o>*</span> <span class=n>4</span><span class=o>];</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span><span class=o>[]</span> <span class=n>HEXPADDING</span> <span class=o>=</span> <span class=k>new</span> <span class=n>String</span><span class=o>[</span><span class=n>16</span><span class=o>];</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span><span class=o>[]</span> <span class=n>HEXDUMP_ROWPREFIXES</span> <span class=o>=</span> <span class=k>new</span> <span class=n>String</span><span class=o>[</span><span class=n>65536</span> <span class=o>&gt;&gt;&gt;</span> <span class=n>4</span><span class=o>];</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span><span class=o>[]</span> <span class=n>BYTE2HEX</span> <span class=o>=</span> <span class=k>new</span> <span class=n>String</span><span class=o>[</span><span class=n>256</span><span class=o>];</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span><span class=o>[]</span> <span class=n>BYTEPADDING</span> <span class=o>=</span> <span class=k>new</span> <span class=n>String</span><span class=o>[</span><span class=n>16</span><span class=o>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>static</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>final</span> <span class=kt>char</span><span class=o>[]</span> <span class=n>DIGITS</span> <span class=o>=</span> <span class=s>&#34;0123456789abcdef&#34;</span><span class=o>.</span><span class=na>toCharArray</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>256</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>HEXDUMP_TABLE</span><span class=o>[</span><span class=n>i</span> <span class=o>&lt;&lt;</span> <span class=n>1</span><span class=o>]</span> <span class=o>=</span> <span class=n>DIGITS</span><span class=o>[</span><span class=n>i</span> <span class=o>&gt;&gt;&gt;</span> <span class=n>4</span> <span class=o>&amp;</span> <span class=n>0x0F</span><span class=o>];</span>
</span></span><span class=line><span class=cl>            <span class=n>HEXDUMP_TABLE</span><span class=o>[(</span><span class=n>i</span> <span class=o>&lt;&lt;</span> <span class=n>1</span><span class=o>)</span> <span class=o>+</span> <span class=n>1</span><span class=o>]</span> <span class=o>=</span> <span class=n>DIGITS</span><span class=o>[</span><span class=n>i</span> <span class=o>&amp;</span> <span class=n>0x0F</span><span class=o>];</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>i</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// Generate the lookup table for hex dump paddings
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>for</span> <span class=o>(</span><span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>HEXPADDING</span><span class=o>.</span><span class=na>length</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=kt>int</span> <span class=n>padding</span> <span class=o>=</span> <span class=n>HEXPADDING</span><span class=o>.</span><span class=na>length</span> <span class=o>-</span> <span class=n>i</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>StringBuilder</span> <span class=n>buf</span> <span class=o>=</span> <span class=k>new</span> <span class=n>StringBuilder</span><span class=o>(</span><span class=n>padding</span> <span class=o>*</span> <span class=n>3</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>j</span> <span class=o>&lt;</span> <span class=n>padding</span><span class=o>;</span> <span class=n>j</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>buf</span><span class=o>.</span><span class=na>append</span><span class=o>(</span><span class=s>&#34;   &#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=n>HEXPADDING</span><span class=o>[</span><span class=n>i</span><span class=o>]</span> <span class=o>=</span> <span class=n>buf</span><span class=o>.</span><span class=na>toString</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// Generate the lookup table for the start-offset header in each row (up to 64KiB).
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>for</span> <span class=o>(</span><span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>HEXDUMP_ROWPREFIXES</span><span class=o>.</span><span class=na>length</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>StringBuilder</span> <span class=n>buf</span> <span class=o>=</span> <span class=k>new</span> <span class=n>StringBuilder</span><span class=o>(</span><span class=n>12</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>buf</span><span class=o>.</span><span class=na>append</span><span class=o>(</span><span class=n>NEWLINE</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>buf</span><span class=o>.</span><span class=na>append</span><span class=o>(</span><span class=n>Long</span><span class=o>.</span><span class=na>toHexString</span><span class=o>(</span><span class=n>i</span> <span class=o>&lt;&lt;</span> <span class=n>4</span> <span class=o>&amp;</span> <span class=n>0xFFFFFFFFL</span> <span class=o>|</span> <span class=n>0x100000000L</span><span class=o>));</span>
</span></span><span class=line><span class=cl>            <span class=n>buf</span><span class=o>.</span><span class=na>setCharAt</span><span class=o>(</span><span class=n>buf</span><span class=o>.</span><span class=na>length</span><span class=o>()</span> <span class=o>-</span> <span class=n>9</span><span class=o>,</span> <span class=sc>&#39;|&#39;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>buf</span><span class=o>.</span><span class=na>append</span><span class=o>(</span><span class=sc>&#39;|&#39;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>HEXDUMP_ROWPREFIXES</span><span class=o>[</span><span class=n>i</span><span class=o>]</span> <span class=o>=</span> <span class=n>buf</span><span class=o>.</span><span class=na>toString</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// Generate the lookup table for byte-to-hex-dump conversion
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>for</span> <span class=o>(</span><span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>BYTE2HEX</span><span class=o>.</span><span class=na>length</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>BYTE2HEX</span><span class=o>[</span><span class=n>i</span><span class=o>]</span> <span class=o>=</span> <span class=sc>&#39; &#39;</span> <span class=o>+</span> <span class=n>StringUtil</span><span class=o>.</span><span class=na>byteToHexStringPadded</span><span class=o>(</span><span class=n>i</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// Generate the lookup table for byte dump paddings
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>for</span> <span class=o>(</span><span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>BYTEPADDING</span><span class=o>.</span><span class=na>length</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=kt>int</span> <span class=n>padding</span> <span class=o>=</span> <span class=n>BYTEPADDING</span><span class=o>.</span><span class=na>length</span> <span class=o>-</span> <span class=n>i</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>StringBuilder</span> <span class=n>buf</span> <span class=o>=</span> <span class=k>new</span> <span class=n>StringBuilder</span><span class=o>(</span><span class=n>padding</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>j</span> <span class=o>&lt;</span> <span class=n>padding</span><span class=o>;</span> <span class=n>j</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>buf</span><span class=o>.</span><span class=na>append</span><span class=o>(</span><span class=sc>&#39; &#39;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=n>BYTEPADDING</span><span class=o>[</span><span class=n>i</span><span class=o>]</span> <span class=o>=</span> <span class=n>buf</span><span class=o>.</span><span class=na>toString</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// Generate the lookup table for byte-to-char conversion
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>for</span> <span class=o>(</span><span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>BYTE2CHAR</span><span class=o>.</span><span class=na>length</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>i</span> <span class=o>&lt;=</span> <span class=n>0x1f</span> <span class=o>||</span> <span class=n>i</span> <span class=o>&gt;=</span> <span class=n>0x7f</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>BYTE2CHAR</span><span class=o>[</span><span class=n>i</span><span class=o>]</span> <span class=o>=</span> <span class=sc>&#39;.&#39;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>BYTE2CHAR</span><span class=o>[</span><span class=n>i</span><span class=o>]</span> <span class=o>=</span> <span class=o>(</span><span class=kt>char</span><span class=o>)</span> <span class=n>i</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 打印所有内容
</span></span></span><span class=line><span class=cl><span class=cm>     * @param buffer
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>debugAll</span><span class=o>(</span><span class=n>ByteBuffer</span> <span class=n>buffer</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>oldlimit</span> <span class=o>=</span> <span class=n>buffer</span><span class=o>.</span><span class=na>limit</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>buffer</span><span class=o>.</span><span class=na>limit</span><span class=o>(</span><span class=n>buffer</span><span class=o>.</span><span class=na>capacity</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=n>StringBuilder</span> <span class=n>origin</span> <span class=o>=</span> <span class=k>new</span> <span class=n>StringBuilder</span><span class=o>(</span><span class=n>256</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>appendPrettyHexDump</span><span class=o>(</span><span class=n>origin</span><span class=o>,</span> <span class=n>buffer</span><span class=o>,</span> <span class=n>0</span><span class=o>,</span> <span class=n>buffer</span><span class=o>.</span><span class=na>capacity</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;+--------+-------------------- all ------------------------+----------------+&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>printf</span><span class=o>(</span><span class=s>&#34;position: [%d], limit: [%d]\n&#34;</span><span class=o>,</span> <span class=n>buffer</span><span class=o>.</span><span class=na>position</span><span class=o>(),</span> <span class=n>oldlimit</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>origin</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>buffer</span><span class=o>.</span><span class=na>limit</span><span class=o>(</span><span class=n>oldlimit</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 打印可读取内容
</span></span></span><span class=line><span class=cl><span class=cm>     * @param buffer
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>debugRead</span><span class=o>(</span><span class=n>ByteBuffer</span> <span class=n>buffer</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>StringBuilder</span> <span class=n>builder</span> <span class=o>=</span> <span class=k>new</span> <span class=n>StringBuilder</span><span class=o>(</span><span class=n>256</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>appendPrettyHexDump</span><span class=o>(</span><span class=n>builder</span><span class=o>,</span> <span class=n>buffer</span><span class=o>,</span> <span class=n>buffer</span><span class=o>.</span><span class=na>position</span><span class=o>(),</span> <span class=n>buffer</span><span class=o>.</span><span class=na>limit</span><span class=o>()</span> <span class=o>-</span> <span class=n>buffer</span><span class=o>.</span><span class=na>position</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;+--------+-------------------- read -----------------------+----------------+&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>printf</span><span class=o>(</span><span class=s>&#34;position: [%d], limit: [%d]\n&#34;</span><span class=o>,</span> <span class=n>buffer</span><span class=o>.</span><span class=na>position</span><span class=o>(),</span> <span class=n>buffer</span><span class=o>.</span><span class=na>limit</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>builder</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>appendPrettyHexDump</span><span class=o>(</span><span class=n>StringBuilder</span> <span class=n>dump</span><span class=o>,</span> <span class=n>ByteBuffer</span> <span class=n>buf</span><span class=o>,</span> <span class=kt>int</span> <span class=n>offset</span><span class=o>,</span> <span class=kt>int</span> <span class=n>length</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>isOutOfBounds</span><span class=o>(</span><span class=n>offset</span><span class=o>,</span> <span class=n>length</span><span class=o>,</span> <span class=n>buf</span><span class=o>.</span><span class=na>capacity</span><span class=o>()))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>IndexOutOfBoundsException</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                    <span class=s>&#34;expected: &#34;</span> <span class=o>+</span> <span class=s>&#34;0 &lt;= offset(&#34;</span> <span class=o>+</span> <span class=n>offset</span> <span class=o>+</span> <span class=s>&#34;) &lt;= offset + length(&#34;</span> <span class=o>+</span> <span class=n>length</span>
</span></span><span class=line><span class=cl>                            <span class=o>+</span> <span class=s>&#34;) &lt;= &#34;</span> <span class=o>+</span> <span class=s>&#34;buf.capacity(&#34;</span> <span class=o>+</span> <span class=n>buf</span><span class=o>.</span><span class=na>capacity</span><span class=o>()</span> <span class=o>+</span> <span class=sc>&#39;)&#39;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>length</span> <span class=o>==</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=n>dump</span><span class=o>.</span><span class=na>append</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                <span class=s>&#34;         +-------------------------------------------------+&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                        <span class=n>NEWLINE</span> <span class=o>+</span> <span class=s>&#34;         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                        <span class=n>NEWLINE</span> <span class=o>+</span> <span class=s>&#34;+--------+-------------------------------------------------+----------------+&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kd>final</span> <span class=kt>int</span> <span class=n>startIndex</span> <span class=o>=</span> <span class=n>offset</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=kd>final</span> <span class=kt>int</span> <span class=n>fullRows</span> <span class=o>=</span> <span class=n>length</span> <span class=o>&gt;&gt;&gt;</span> <span class=n>4</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=kd>final</span> <span class=kt>int</span> <span class=n>remainder</span> <span class=o>=</span> <span class=n>length</span> <span class=o>&amp;</span> <span class=n>0xF</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// Dump the rows which have 16 bytes.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>row</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>row</span> <span class=o>&lt;</span> <span class=n>fullRows</span><span class=o>;</span> <span class=n>row</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=kt>int</span> <span class=n>rowStartIndex</span> <span class=o>=</span> <span class=o>(</span><span class=n>row</span> <span class=o>&lt;&lt;</span> <span class=n>4</span><span class=o>)</span> <span class=o>+</span> <span class=n>startIndex</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1>// Per-row prefix.
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>appendHexDumpRowPrefix</span><span class=o>(</span><span class=n>dump</span><span class=o>,</span> <span class=n>row</span><span class=o>,</span> <span class=n>rowStartIndex</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1>// Hex dump
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=kt>int</span> <span class=n>rowEndIndex</span> <span class=o>=</span> <span class=n>rowStartIndex</span> <span class=o>+</span> <span class=n>16</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=n>rowStartIndex</span><span class=o>;</span> <span class=n>j</span> <span class=o>&lt;</span> <span class=n>rowEndIndex</span><span class=o>;</span> <span class=n>j</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>dump</span><span class=o>.</span><span class=na>append</span><span class=o>(</span><span class=n>BYTE2HEX</span><span class=o>[</span><span class=n>getUnsignedByte</span><span class=o>(</span><span class=n>buf</span><span class=o>,</span> <span class=n>j</span><span class=o>)]);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=n>dump</span><span class=o>.</span><span class=na>append</span><span class=o>(</span><span class=s>&#34; |&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1>// ASCII dump
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=n>rowStartIndex</span><span class=o>;</span> <span class=n>j</span> <span class=o>&lt;</span> <span class=n>rowEndIndex</span><span class=o>;</span> <span class=n>j</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>dump</span><span class=o>.</span><span class=na>append</span><span class=o>(</span><span class=n>BYTE2CHAR</span><span class=o>[</span><span class=n>getUnsignedByte</span><span class=o>(</span><span class=n>buf</span><span class=o>,</span> <span class=n>j</span><span class=o>)]);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=n>dump</span><span class=o>.</span><span class=na>append</span><span class=o>(</span><span class=sc>&#39;|&#39;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// Dump the last row which has less than 16 bytes.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=o>(</span><span class=n>remainder</span> <span class=o>!=</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=kt>int</span> <span class=n>rowStartIndex</span> <span class=o>=</span> <span class=o>(</span><span class=n>fullRows</span> <span class=o>&lt;&lt;</span> <span class=n>4</span><span class=o>)</span> <span class=o>+</span> <span class=n>startIndex</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>appendHexDumpRowPrefix</span><span class=o>(</span><span class=n>dump</span><span class=o>,</span> <span class=n>fullRows</span><span class=o>,</span> <span class=n>rowStartIndex</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1>// Hex dump
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=kt>int</span> <span class=n>rowEndIndex</span> <span class=o>=</span> <span class=n>rowStartIndex</span> <span class=o>+</span> <span class=n>remainder</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=n>rowStartIndex</span><span class=o>;</span> <span class=n>j</span> <span class=o>&lt;</span> <span class=n>rowEndIndex</span><span class=o>;</span> <span class=n>j</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>dump</span><span class=o>.</span><span class=na>append</span><span class=o>(</span><span class=n>BYTE2HEX</span><span class=o>[</span><span class=n>getUnsignedByte</span><span class=o>(</span><span class=n>buf</span><span class=o>,</span> <span class=n>j</span><span class=o>)]);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=n>dump</span><span class=o>.</span><span class=na>append</span><span class=o>(</span><span class=n>HEXPADDING</span><span class=o>[</span><span class=n>remainder</span><span class=o>]);</span>
</span></span><span class=line><span class=cl>            <span class=n>dump</span><span class=o>.</span><span class=na>append</span><span class=o>(</span><span class=s>&#34; |&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1>// Ascii dump
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=n>rowStartIndex</span><span class=o>;</span> <span class=n>j</span> <span class=o>&lt;</span> <span class=n>rowEndIndex</span><span class=o>;</span> <span class=n>j</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>dump</span><span class=o>.</span><span class=na>append</span><span class=o>(</span><span class=n>BYTE2CHAR</span><span class=o>[</span><span class=n>getUnsignedByte</span><span class=o>(</span><span class=n>buf</span><span class=o>,</span> <span class=n>j</span><span class=o>)]);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=n>dump</span><span class=o>.</span><span class=na>append</span><span class=o>(</span><span class=n>BYTEPADDING</span><span class=o>[</span><span class=n>remainder</span><span class=o>]);</span>
</span></span><span class=line><span class=cl>            <span class=n>dump</span><span class=o>.</span><span class=na>append</span><span class=o>(</span><span class=sc>&#39;|&#39;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>dump</span><span class=o>.</span><span class=na>append</span><span class=o>(</span><span class=n>NEWLINE</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                <span class=s>&#34;+--------+-------------------------------------------------+----------------+&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>appendHexDumpRowPrefix</span><span class=o>(</span><span class=n>StringBuilder</span> <span class=n>dump</span><span class=o>,</span> <span class=kt>int</span> <span class=n>row</span><span class=o>,</span> <span class=kt>int</span> <span class=n>rowStartIndex</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>row</span> <span class=o>&lt;</span> <span class=n>HEXDUMP_ROWPREFIXES</span><span class=o>.</span><span class=na>length</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>dump</span><span class=o>.</span><span class=na>append</span><span class=o>(</span><span class=n>HEXDUMP_ROWPREFIXES</span><span class=o>[</span><span class=n>row</span><span class=o>]);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>dump</span><span class=o>.</span><span class=na>append</span><span class=o>(</span><span class=n>NEWLINE</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>dump</span><span class=o>.</span><span class=na>append</span><span class=o>(</span><span class=n>Long</span><span class=o>.</span><span class=na>toHexString</span><span class=o>(</span><span class=n>rowStartIndex</span> <span class=o>&amp;</span> <span class=n>0xFFFFFFFFL</span> <span class=o>|</span> <span class=n>0x100000000L</span><span class=o>));</span>
</span></span><span class=line><span class=cl>            <span class=n>dump</span><span class=o>.</span><span class=na>setCharAt</span><span class=o>(</span><span class=n>dump</span><span class=o>.</span><span class=na>length</span><span class=o>()</span> <span class=o>-</span> <span class=n>9</span><span class=o>,</span> <span class=sc>&#39;|&#39;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>dump</span><span class=o>.</span><span class=na>append</span><span class=o>(</span><span class=sc>&#39;|&#39;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>short</span> <span class=nf>getUnsignedByte</span><span class=o>(</span><span class=n>ByteBuffer</span> <span class=n>buffer</span><span class=o>,</span> <span class=kt>int</span> <span class=n>index</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=o>(</span><span class=kt>short</span><span class=o>)</span> <span class=o>(</span><span class=n>buffer</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>index</span><span class=o>)</span> <span class=o>&amp;</span> <span class=n>0xFF</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#23-bytebuffer-常见方法><h3 id=23-bytebuffer-常见方法><span class=hanchor arialabel=Anchor># </span>2.3 ByteBuffer 常见方法</h3></a><a href=#分配空间><h4 id=分配空间><span class=hanchor arialabel=Anchor># </span>分配空间</h4></a><p>可以使用 allocate 方法为 ByteBuffer 分配空间，其它 buffer 类也有该方法</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-8-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Bytebuffer</span> <span class=n>buf</span> <span class=o>=</span> <span class=n>ByteBuffer</span><span class=o>.</span><span class=na>allocate</span><span class=o>(</span><span class=n>16</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><a href=#向-buffer-写入数据><h4 id=向-buffer-写入数据><span class=hanchor arialabel=Anchor># </span>向 buffer 写入数据</h4></a><p>有两种办法</p><ul><li>调用 channel 的 read 方法 (从channel读，向buffer写)</li><li>调用 buffer 自己的 put 方法</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-9-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kt>int</span> <span class=n>readBytes</span> <span class=o>=</span> <span class=n>channel</span><span class=o>.</span><span class=na>read</span><span class=o>(</span><span class=n>buf</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><p>和</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-10-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>buf</span><span class=o>.</span><span class=na>put</span><span class=o>((</span><span class=kt>byte</span><span class=o>)</span><span class=n>127</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><a href=#从-buffer-读取数据><h4 id=从-buffer-读取数据><span class=hanchor arialabel=Anchor># </span>从 buffer 读取数据</h4></a><p>同样有两种办法</p><ul><li>调用 channel 的 write 方法（从buffer读，向channel写）</li><li>调用 buffer 自己的 get 方法</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-11-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kt>int</span> <span class=n>writeBytes</span> <span class=o>=</span> <span class=n>channel</span><span class=o>.</span><span class=na>write</span><span class=o>(</span><span class=n>buf</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><p>和</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-12-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kt>byte</span> <span class=n>b</span> <span class=o>=</span> <span class=n>buf</span><span class=o>.</span><span class=na>get</span><span class=o>();</span>
</span></span></code></pre></td></tr></table></div></div><p>get 方法会让 position 读指针向后走，如果想重复读取数据</p><ul><li>可以调用 rewind 方法将 position 重新置为 0（从头重新读）</li><li>或者调用 get(int i) 方法获取索引 i 的内容，它<strong>不会</strong>移动读指针</li></ul><a href=#mark-和-reset><h4 id=mark-和-reset><span class=hanchor arialabel=Anchor># </span>mark 和 reset</h4></a><blockquote><p>对rewind的增强，可以回溯到指定位置而不只是起点。</p></blockquote><p>mark 是在读取时，做一个标记，即使 position 改变，只要调用 reset 就能回到 mark 的位置</p><blockquote><p><strong>注意</strong>
rewind 和 flip 都会清除 mark 位置。</p></blockquote><a href=#字符串与-bytebuffer-互转><h4 id=字符串与-bytebuffer-互转><span class=hanchor arialabel=Anchor># </span>字符串与 ByteBuffer 互转</h4></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-13-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-1>1</a>
</span><span class=lnt id=hl-13-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-2>2</a>
</span><span class=lnt id=hl-13-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-3>3</a>
</span><span class=lnt id=hl-13-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-4>4</a>
</span><span class=lnt id=hl-13-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-5>5</a>
</span><span class=lnt id=hl-13-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-6>6</a>
</span><span class=lnt id=hl-13-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-7>7</a>
</span><span class=lnt id=hl-13-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-8>8</a>
</span><span class=lnt id=hl-13-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-9>9</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>ByteBuffer</span> <span class=n>buffer1</span> <span class=o>=</span> <span class=n>StandardCharsets</span><span class=o>.</span><span class=na>UTF_8</span><span class=o>.</span><span class=na>encode</span><span class=o>(</span><span class=s>&#34;你好&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>ByteBuffer</span> <span class=n>buffer2</span> <span class=o>=</span> <span class=n>Charset</span><span class=o>.</span><span class=na>forName</span><span class=o>(</span><span class=s>&#34;utf-8&#34;</span><span class=o>).</span><span class=na>encode</span><span class=o>(</span><span class=s>&#34;你好&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>debug</span><span class=o>(</span><span class=n>buffer1</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>debug</span><span class=o>(</span><span class=n>buffer2</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>CharBuffer</span> <span class=n>buffer3</span> <span class=o>=</span> <span class=n>StandardCharsets</span><span class=o>.</span><span class=na>UTF_8</span><span class=o>.</span><span class=na>decode</span><span class=o>(</span><span class=n>buffer1</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>buffer3</span><span class=o>.</span><span class=na>getClass</span><span class=o>());</span>
</span></span><span class=line><span class=cl><span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>buffer3</span><span class=o>.</span><span class=na>toString</span><span class=o>());</span>
</span></span></code></pre></td></tr></table></div></div><p>输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-14-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-1> 1</a>
</span><span class=lnt id=hl-14-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-2> 2</a>
</span><span class=lnt id=hl-14-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-3> 3</a>
</span><span class=lnt id=hl-14-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-4> 4</a>
</span><span class=lnt id=hl-14-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-5> 5</a>
</span><span class=lnt id=hl-14-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-6> 6</a>
</span><span class=lnt id=hl-14-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-7> 7</a>
</span><span class=lnt id=hl-14-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-8> 8</a>
</span><span class=lnt id=hl-14-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-9> 9</a>
</span><span class=lnt id=hl-14-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-10>10</a>
</span><span class=lnt id=hl-14-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-11>11</a>
</span><span class=lnt id=hl-14-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-12>12</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| e4 bd a0 e5 a5 bd                               |......          |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| e4 bd a0 e5 a5 bd                               |......          |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>class java.nio.HeapCharBuffer
</span></span><span class=line><span class=cl>你好
</span></span></code></pre></td></tr></table></div></div><a href=#-buffer-的线程安全><h4 id=-buffer-的线程安全><span class=hanchor arialabel=Anchor># </span>⚠️ Buffer 的线程安全</h4></a><blockquote><p>Buffer 是<strong>非线程安全的</strong></p></blockquote><a href=#24-scattering-reads><h3 id=24-scattering-reads><span class=hanchor arialabel=Anchor># </span>2.4 Scattering Reads</h3></a><p>分散读取，有一个文本文件 3parts.txt</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-15-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>onetwothree
</span></span></code></pre></td></tr></table></div></div><p>使用如下方式读取，可以将数据填充至多个 buffer</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-16-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-1> 1</a>
</span><span class=lnt id=hl-16-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-2> 2</a>
</span><span class=lnt id=hl-16-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-3> 3</a>
</span><span class=lnt id=hl-16-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-4> 4</a>
</span><span class=lnt id=hl-16-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-5> 5</a>
</span><span class=lnt id=hl-16-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-6> 6</a>
</span><span class=lnt id=hl-16-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-7> 7</a>
</span><span class=lnt id=hl-16-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-8> 8</a>
</span><span class=lnt id=hl-16-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-9> 9</a>
</span><span class=lnt id=hl-16-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-10>10</a>
</span><span class=lnt id=hl-16-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-11>11</a>
</span><span class=lnt id=hl-16-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-12>12</a>
</span><span class=lnt id=hl-16-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-13>13</a>
</span><span class=lnt id=hl-16-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-14>14</a>
</span><span class=lnt id=hl-16-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-15>15</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>try</span> <span class=o>(</span><span class=n>RandomAccessFile</span> <span class=n>file</span> <span class=o>=</span> <span class=k>new</span> <span class=n>RandomAccessFile</span><span class=o>(</span><span class=s>&#34;helloword/3parts.txt&#34;</span><span class=o>,</span> <span class=s>&#34;rw&#34;</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>FileChannel</span> <span class=n>channel</span> <span class=o>=</span> <span class=n>file</span><span class=o>.</span><span class=na>getChannel</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>ByteBuffer</span> <span class=n>a</span> <span class=o>=</span> <span class=n>ByteBuffer</span><span class=o>.</span><span class=na>allocate</span><span class=o>(</span><span class=n>3</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>ByteBuffer</span> <span class=n>b</span> <span class=o>=</span> <span class=n>ByteBuffer</span><span class=o>.</span><span class=na>allocate</span><span class=o>(</span><span class=n>3</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>ByteBuffer</span> <span class=n>c</span> <span class=o>=</span> <span class=n>ByteBuffer</span><span class=o>.</span><span class=na>allocate</span><span class=o>(</span><span class=n>5</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>channel</span><span class=o>.</span><span class=na>read</span><span class=o>(</span><span class=k>new</span> <span class=n>ByteBuffer</span><span class=o>[]{</span><span class=n>a</span><span class=o>,</span> <span class=n>b</span><span class=o>,</span> <span class=n>c</span><span class=o>});</span>
</span></span><span class=line><span class=cl>    <span class=n>a</span><span class=o>.</span><span class=na>flip</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>b</span><span class=o>.</span><span class=na>flip</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>c</span><span class=o>.</span><span class=na>flip</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>debug</span><span class=o>(</span><span class=n>a</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>debug</span><span class=o>(</span><span class=n>b</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>debug</span><span class=o>(</span><span class=n>c</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>结果</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-17-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-1> 1</a>
</span><span class=lnt id=hl-17-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-2> 2</a>
</span><span class=lnt id=hl-17-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-3> 3</a>
</span><span class=lnt id=hl-17-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-4> 4</a>
</span><span class=lnt id=hl-17-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-5> 5</a>
</span><span class=lnt id=hl-17-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-6> 6</a>
</span><span class=lnt id=hl-17-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-7> 7</a>
</span><span class=lnt id=hl-17-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-8> 8</a>
</span><span class=lnt id=hl-17-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-9> 9</a>
</span><span class=lnt id=hl-17-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-10>10</a>
</span><span class=lnt id=hl-17-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-11>11</a>
</span><span class=lnt id=hl-17-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-12>12</a>
</span><span class=lnt id=hl-17-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-13>13</a>
</span><span class=lnt id=hl-17-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-14>14</a>
</span><span class=lnt id=hl-17-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-15>15</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 6f 6e 65                                        |one             |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 74 77 6f                                        |two             |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 74 68 72 65 65                                  |three           |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span></code></pre></td></tr></table></div></div><a href=#25-gathering-writes><h3 id=25-gathering-writes><span class=hanchor arialabel=Anchor># </span>2.5 Gathering Writes</h3></a><p>使用如下方式写入，可以将多个 buffer 的数据填充至 channel</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-18-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-1> 1</a>
</span><span class=lnt id=hl-18-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-2> 2</a>
</span><span class=lnt id=hl-18-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-3> 3</a>
</span><span class=lnt id=hl-18-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-4> 4</a>
</span><span class=lnt id=hl-18-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-5> 5</a>
</span><span class=lnt id=hl-18-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-6> 6</a>
</span><span class=lnt id=hl-18-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-7> 7</a>
</span><span class=lnt id=hl-18-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-8> 8</a>
</span><span class=lnt id=hl-18-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-9> 9</a>
</span><span class=lnt id=hl-18-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-10>10</a>
</span><span class=lnt id=hl-18-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-11>11</a>
</span><span class=lnt id=hl-18-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-12>12</a>
</span><span class=lnt id=hl-18-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-13>13</a>
</span><span class=lnt id=hl-18-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-14>14</a>
</span><span class=lnt id=hl-18-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-15>15</a>
</span><span class=lnt id=hl-18-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-16>16</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>try</span> <span class=o>(</span><span class=n>RandomAccessFile</span> <span class=n>file</span> <span class=o>=</span> <span class=k>new</span> <span class=n>RandomAccessFile</span><span class=o>(</span><span class=s>&#34;helloword/3parts.txt&#34;</span><span class=o>,</span> <span class=s>&#34;rw&#34;</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>FileChannel</span> <span class=n>channel</span> <span class=o>=</span> <span class=n>file</span><span class=o>.</span><span class=na>getChannel</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>ByteBuffer</span> <span class=n>d</span> <span class=o>=</span> <span class=n>ByteBuffer</span><span class=o>.</span><span class=na>allocate</span><span class=o>(</span><span class=n>4</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>ByteBuffer</span> <span class=n>e</span> <span class=o>=</span> <span class=n>ByteBuffer</span><span class=o>.</span><span class=na>allocate</span><span class=o>(</span><span class=n>4</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>channel</span><span class=o>.</span><span class=na>position</span><span class=o>(</span><span class=n>11</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>d</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=k>new</span> <span class=kt>byte</span><span class=o>[]{</span><span class=sc>&#39;f&#39;</span><span class=o>,</span> <span class=sc>&#39;o&#39;</span><span class=o>,</span> <span class=sc>&#39;u&#39;</span><span class=o>,</span> <span class=sc>&#39;r&#39;</span><span class=o>});</span>
</span></span><span class=line><span class=cl>    <span class=n>e</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=k>new</span> <span class=kt>byte</span><span class=o>[]{</span><span class=sc>&#39;f&#39;</span><span class=o>,</span> <span class=sc>&#39;i&#39;</span><span class=o>,</span> <span class=sc>&#39;v&#39;</span><span class=o>,</span> <span class=sc>&#39;e&#39;</span><span class=o>});</span>
</span></span><span class=line><span class=cl>    <span class=n>d</span><span class=o>.</span><span class=na>flip</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>e</span><span class=o>.</span><span class=na>flip</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>debug</span><span class=o>(</span><span class=n>d</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>debug</span><span class=o>(</span><span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>channel</span><span class=o>.</span><span class=na>write</span><span class=o>(</span><span class=k>new</span> <span class=n>ByteBuffer</span><span class=o>[]{</span><span class=n>d</span><span class=o>,</span> <span class=n>e</span><span class=o>});</span>
</span></span><span class=line><span class=cl><span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-19-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-1> 1</a>
</span><span class=lnt id=hl-19-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-2> 2</a>
</span><span class=lnt id=hl-19-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-3> 3</a>
</span><span class=lnt id=hl-19-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-4> 4</a>
</span><span class=lnt id=hl-19-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-5> 5</a>
</span><span class=lnt id=hl-19-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-6> 6</a>
</span><span class=lnt id=hl-19-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-7> 7</a>
</span><span class=lnt id=hl-19-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-8> 8</a>
</span><span class=lnt id=hl-19-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-9> 9</a>
</span><span class=lnt id=hl-19-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-10>10</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 66 6f 75 72                                     |four            |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 66 69 76 65                                     |five            |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span></code></pre></td></tr></table></div></div><p>文件内容</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-20-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-20-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>onetwothreefourfive
</span></span></code></pre></td></tr></table></div></div><a href=#26-练习><h3 id=26-练习><span class=hanchor arialabel=Anchor># </span>2.6 练习</h3></a><p>网络上有多条数据发送给服务端，数据之间使用 \n 进行分隔 但由于某种原因这些数据在接收时，被进行了重新组合，例如原始数据有3条为</p><ul><li>Hello,world\n</li><li>I&rsquo;m zhangsan\n</li><li>How are you?\n</li></ul><p>变成了下面的两个 byteBuffer (黏包，半包)</p><ul><li>Hello,world\nI&rsquo;m zhangsan\nHo</li><li>w are you?\n</li></ul><p>现在要求你编写程序，将错乱的数据恢复成原始的按 \n 分隔的数据</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-21-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-21-1> 1</a>
</span><span class=lnt id=hl-21-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-21-2> 2</a>
</span><span class=lnt id=hl-21-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-21-3> 3</a>
</span><span class=lnt id=hl-21-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-21-4> 4</a>
</span><span class=lnt id=hl-21-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-21-5> 5</a>
</span><span class=lnt id=hl-21-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-21-6> 6</a>
</span><span class=lnt id=hl-21-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-21-7> 7</a>
</span><span class=lnt id=hl-21-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-21-8> 8</a>
</span><span class=lnt id=hl-21-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-21-9> 9</a>
</span><span class=lnt id=hl-21-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-21-10>10</a>
</span><span class=lnt id=hl-21-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-21-11>11</a>
</span><span class=lnt id=hl-21-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-21-12>12</a>
</span><span class=lnt id=hl-21-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-21-13>13</a>
</span><span class=lnt id=hl-21-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-21-14>14</a>
</span><span class=lnt id=hl-21-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-21-15>15</a>
</span><span class=lnt id=hl-21-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-21-16>16</a>
</span><span class=lnt id=hl-21-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-21-17>17</a>
</span><span class=lnt id=hl-21-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-21-18>18</a>
</span><span class=lnt id=hl-21-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-21-19>19</a>
</span><span class=lnt id=hl-21-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-21-20>20</a>
</span><span class=lnt id=hl-21-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-21-21>21</a>
</span><span class=lnt id=hl-21-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-21-22>22</a>
</span><span class=lnt id=hl-21-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-21-23>23</a>
</span><span class=lnt id=hl-21-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-21-24>24</a>
</span><span class=lnt id=hl-21-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-21-25>25</a>
</span><span class=lnt id=hl-21-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-21-26>26</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ByteBuffer</span> <span class=n>source</span> <span class=o>=</span> <span class=n>ByteBuffer</span><span class=o>.</span><span class=na>allocate</span><span class=o>(</span><span class=n>32</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>//                     11            24
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>source</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=s>&#34;Hello,world\nI&#39;m zhangsan\nHo&#34;</span><span class=o>.</span><span class=na>getBytes</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=n>split</span><span class=o>(</span><span class=n>source</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>source</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=s>&#34;w are you?\nhaha!\n&#34;</span><span class=o>.</span><span class=na>getBytes</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=n>split</span><span class=o>(</span><span class=n>source</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>split</span><span class=o>(</span><span class=n>ByteBuffer</span> <span class=n>source</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>source</span><span class=o>.</span><span class=na>flip</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>oldLimit</span> <span class=o>=</span> <span class=n>source</span><span class=o>.</span><span class=na>limit</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>oldLimit</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>source</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>i</span><span class=o>)</span> <span class=o>==</span> <span class=sc>&#39;\n&#39;</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>i</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>ByteBuffer</span> <span class=n>target</span> <span class=o>=</span> <span class=n>ByteBuffer</span><span class=o>.</span><span class=na>allocate</span><span class=o>(</span><span class=n>i</span> <span class=o>+</span> <span class=n>1</span> <span class=o>-</span> <span class=n>source</span><span class=o>.</span><span class=na>position</span><span class=o>());</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 0 ~ limit
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>source</span><span class=o>.</span><span class=na>limit</span><span class=o>(</span><span class=n>i</span> <span class=o>+</span> <span class=n>1</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>target</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>source</span><span class=o>);</span> <span class=c1>// 从source 读，向 target 写
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>debugAll</span><span class=o>(</span><span class=n>target</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>source</span><span class=o>.</span><span class=na>limit</span><span class=o>(</span><span class=n>oldLimit</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=n>source</span><span class=o>.</span><span class=na>compact</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#3-文件编程><h2 id=3-文件编程><span class=hanchor arialabel=Anchor># </span>3. 文件编程</h2></a><a href=#31-filechannel><h3 id=31-filechannel><span class=hanchor arialabel=Anchor># </span>3.1 FileChannel</h3></a><a href=#-filechannel-工作模式><h4 id=-filechannel-工作模式><span class=hanchor arialabel=Anchor># </span>⚠️ FileChannel 工作模式</h4></a><blockquote><p>FileChannel 只能工作在阻塞模式下</p></blockquote><a href=#获取><h4 id=获取><span class=hanchor arialabel=Anchor># </span>获取</h4></a><p>不能直接打开 FileChannel，必须通过 FileInputStream、FileOutputStream 或者 RandomAccessFile 来获取 FileChannel，它们都有 getChannel 方法</p><ul><li>通过 FileInputStream 获取的 channel 只能读</li><li>通过 FileOutputStream 获取的 channel 只能写</li><li>通过 RandomAccessFile 是否能读写根据构造 RandomAccessFile 时的读写模式决定</li></ul><a href=#读取><h4 id=读取><span class=hanchor arialabel=Anchor># </span>读取</h4></a><p>会从 channel 读取数据填充 ByteBuffer，返回值表示读到了多少字节，-1 表示到达了文件的末尾</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-22-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-22-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kt>int</span> <span class=n>readBytes</span> <span class=o>=</span> <span class=n>channel</span><span class=o>.</span><span class=na>read</span><span class=o>(</span><span class=n>buffer</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><a href=#写入><h4 id=写入><span class=hanchor arialabel=Anchor># </span>写入</h4></a><p>写入的正确姿势如下， SocketChannel</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-23-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-1>1</a>
</span><span class=lnt id=hl-23-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-2>2</a>
</span><span class=lnt id=hl-23-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-3>3</a>
</span><span class=lnt id=hl-23-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-4>4</a>
</span><span class=lnt id=hl-23-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-5>5</a>
</span><span class=lnt id=hl-23-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-6>6</a>
</span><span class=lnt id=hl-23-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>ByteBuffer</span> <span class=n>buffer</span> <span class=o>=</span> <span class=o>...;</span>
</span></span><span class=line><span class=cl><span class=n>buffer</span><span class=o>.</span><span class=na>put</span><span class=o>(...);</span> <span class=c1>// 存入数据
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>buffer</span><span class=o>.</span><span class=na>flip</span><span class=o>();</span>   <span class=c1>// 切换读模式
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=k>while</span><span class=o>(</span><span class=n>buffer</span><span class=o>.</span><span class=na>hasRemaining</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>channel</span><span class=o>.</span><span class=na>write</span><span class=o>(</span><span class=n>buffer</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>在 while 中调用 channel.write 是因为 write 方法并不能保证一次将 buffer 中的内容全部写入 channel</p><a href=#关闭><h4 id=关闭><span class=hanchor arialabel=Anchor># </span>关闭</h4></a><p>channel 必须关闭，不过调用了 FileInputStream、FileOutputStream 或者 RandomAccessFile 的 close 方法会间接地调用 channel 的 close 方法</p><a href=#位置><h4 id=位置><span class=hanchor arialabel=Anchor># </span>位置</h4></a><p>获取当前位置</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-24-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kt>long</span> <span class=n>pos</span> <span class=o>=</span> <span class=n>channel</span><span class=o>.</span><span class=na>position</span><span class=o>();</span>
</span></span></code></pre></td></tr></table></div></div><p>设置当前位置</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-25-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-1>1</a>
</span><span class=lnt id=hl-25-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-2>2</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kt>long</span> <span class=n>newPos</span> <span class=o>=</span> <span class=o>...;</span>
</span></span><span class=line><span class=cl><span class=n>channel</span><span class=o>.</span><span class=na>position</span><span class=o>(</span><span class=n>newPos</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><p>设置当前位置时，如果设置为文件的末尾</p><ul><li>这时读取会返回 -1</li><li>这时写入，会追加内容，但要注意如果 position 超过了文件末尾，再写入时在新内容和原末尾之间会有空洞（00）</li></ul><a href=#大小><h4 id=大小><span class=hanchor arialabel=Anchor># </span>大小</h4></a><p>使用 size 方法获取文件的大小</p><a href=#强制写入><h4 id=强制写入><span class=hanchor arialabel=Anchor># </span>强制写入</h4></a><p>操作系统出于性能的考虑，会将数据缓存，不是立刻写入磁盘。可以调用 force(true) 方法将文件内容和元数据（文件的权限等信息）立刻写入磁盘</p><a href=#32-两个-channel-传输数据><h3 id=32-两个-channel-传输数据><span class=hanchor arialabel=Anchor># </span>3.2 两个 Channel 传输数据</h3></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-26-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-1> 1</a>
</span><span class=lnt id=hl-26-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-2> 2</a>
</span><span class=lnt id=hl-26-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-3> 3</a>
</span><span class=lnt id=hl-26-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-4> 4</a>
</span><span class=lnt id=hl-26-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-5> 5</a>
</span><span class=lnt id=hl-26-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-6> 6</a>
</span><span class=lnt id=hl-26-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-7> 7</a>
</span><span class=lnt id=hl-26-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-8> 8</a>
</span><span class=lnt id=hl-26-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-9> 9</a>
</span><span class=lnt id=hl-26-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-10>10</a>
</span><span class=lnt id=hl-26-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-11>11</a>
</span><span class=lnt id=hl-26-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-12>12</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>String</span> <span class=n>FROM</span> <span class=o>=</span> <span class=s>&#34;helloword/data.txt&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=n>String</span> <span class=n>TO</span> <span class=o>=</span> <span class=s>&#34;helloword/to.txt&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kt>long</span> <span class=n>start</span> <span class=o>=</span> <span class=n>System</span><span class=o>.</span><span class=na>nanoTime</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=k>try</span> <span class=o>(</span><span class=n>FileChannel</span> <span class=n>from</span> <span class=o>=</span> <span class=k>new</span> <span class=n>FileInputStream</span><span class=o>(</span><span class=n>FROM</span><span class=o>).</span><span class=na>getChannel</span><span class=o>();</span>
</span></span><span class=line><span class=cl>     <span class=n>FileChannel</span> <span class=n>to</span> <span class=o>=</span> <span class=k>new</span> <span class=n>FileOutputStream</span><span class=o>(</span><span class=n>TO</span><span class=o>).</span><span class=na>getChannel</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>from</span><span class=o>.</span><span class=na>transferTo</span><span class=o>(</span><span class=n>0</span><span class=o>,</span> <span class=n>from</span><span class=o>.</span><span class=na>size</span><span class=o>(),</span> <span class=n>to</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl><span class=kt>long</span> <span class=n>end</span> <span class=o>=</span> <span class=n>System</span><span class=o>.</span><span class=na>nanoTime</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;transferTo 用时：&#34;</span> <span class=o>+</span> <span class=o>(</span><span class=n>end</span> <span class=o>-</span> <span class=n>start</span><span class=o>)</span> <span class=o>/</span> <span class=n>1000_000</span><span class=o>.</span><span class=na>0</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><p>输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-27-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-27-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>transferTo 用时：8.2011
</span></span></code></pre></td></tr></table></div></div><p>超过 2g 大小的文件传输</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-28-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-1> 1</a>
</span><span class=lnt id=hl-28-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-2> 2</a>
</span><span class=lnt id=hl-28-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-3> 3</a>
</span><span class=lnt id=hl-28-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-4> 4</a>
</span><span class=lnt id=hl-28-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-5> 5</a>
</span><span class=lnt id=hl-28-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-6> 6</a>
</span><span class=lnt id=hl-28-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-7> 7</a>
</span><span class=lnt id=hl-28-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-8> 8</a>
</span><span class=lnt id=hl-28-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-9> 9</a>
</span><span class=lnt id=hl-28-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-10>10</a>
</span><span class=lnt id=hl-28-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-11>11</a>
</span><span class=lnt id=hl-28-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-12>12</a>
</span><span class=lnt id=hl-28-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-13>13</a>
</span><span class=lnt id=hl-28-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-14>14</a>
</span><span class=lnt id=hl-28-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-15>15</a>
</span><span class=lnt id=hl-28-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-16>16</a>
</span><span class=lnt id=hl-28-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-17>17</a>
</span><span class=lnt id=hl-28-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-18>18</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>TestFileChannelTransferTo</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>(</span>
</span></span><span class=line><span class=cl>                <span class=n>FileChannel</span> <span class=n>from</span> <span class=o>=</span> <span class=k>new</span> <span class=n>FileInputStream</span><span class=o>(</span><span class=s>&#34;data.txt&#34;</span><span class=o>).</span><span class=na>getChannel</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=n>FileChannel</span> <span class=n>to</span> <span class=o>=</span> <span class=k>new</span> <span class=n>FileOutputStream</span><span class=o>(</span><span class=s>&#34;to.txt&#34;</span><span class=o>).</span><span class=na>getChannel</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 效率高，底层会利用操作系统的零拷贝进行优化
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=kt>long</span> <span class=n>size</span> <span class=o>=</span> <span class=n>from</span><span class=o>.</span><span class=na>size</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=c1>// left 变量代表还剩余多少字节
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>for</span> <span class=o>(</span><span class=kt>long</span> <span class=n>left</span> <span class=o>=</span> <span class=n>size</span><span class=o>;</span> <span class=n>left</span> <span class=o>&gt;</span> <span class=n>0</span><span class=o>;</span> <span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;position:&#34;</span> <span class=o>+</span> <span class=o>(</span><span class=n>size</span> <span class=o>-</span> <span class=n>left</span><span class=o>)</span> <span class=o>+</span> <span class=s>&#34; left:&#34;</span> <span class=o>+</span> <span class=n>left</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=n>left</span> <span class=o>-=</span> <span class=n>from</span><span class=o>.</span><span class=na>transferTo</span><span class=o>((</span><span class=n>size</span> <span class=o>-</span> <span class=n>left</span><span class=o>),</span> <span class=n>left</span><span class=o>,</span> <span class=n>to</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>实际传输一个超大文件</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-29-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-29-1>1</a>
</span><span class=lnt id=hl-29-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-29-2>2</a>
</span><span class=lnt id=hl-29-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-29-3>3</a>
</span><span class=lnt id=hl-29-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-29-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>position:0 left:7769948160
</span></span><span class=line><span class=cl>position:2147483647 left:5622464513
</span></span><span class=line><span class=cl>position:4294967294 left:3474980866
</span></span><span class=line><span class=cl>position:6442450941 left:1327497219
</span></span></code></pre></td></tr></table></div></div><a href=#33-path><h3 id=33-path><span class=hanchor arialabel=Anchor># </span>3.3 Path</h3></a><p>jdk7 引入了 Path 和 Paths 类</p><ul><li>Path 用来表示文件路径</li><li>Paths 是工具类，用来获取 Path 实例</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-30-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-1>1</a>
</span><span class=lnt id=hl-30-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-2>2</a>
</span><span class=lnt id=hl-30-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-3>3</a>
</span><span class=lnt id=hl-30-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-4>4</a>
</span><span class=lnt id=hl-30-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-5>5</a>
</span><span class=lnt id=hl-30-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-6>6</a>
</span><span class=lnt id=hl-30-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Path</span> <span class=n>source</span> <span class=o>=</span> <span class=n>Paths</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=s>&#34;1.txt&#34;</span><span class=o>);</span> <span class=c1>// 相对路径 使用 user.dir 环境变量来定位 1.txt
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=n>Path</span> <span class=n>source</span> <span class=o>=</span> <span class=n>Paths</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=s>&#34;d:\\1.txt&#34;</span><span class=o>);</span> <span class=c1>// 绝对路径 代表了  d:\1.txt
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=n>Path</span> <span class=n>source</span> <span class=o>=</span> <span class=n>Paths</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=s>&#34;d:/1.txt&#34;</span><span class=o>);</span> <span class=c1>// 绝对路径 同样代表了  d:\1.txt
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=n>Path</span> <span class=n>projects</span> <span class=o>=</span> <span class=n>Paths</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=s>&#34;d:\\data&#34;</span><span class=o>,</span> <span class=s>&#34;projects&#34;</span><span class=o>);</span> <span class=c1>// 代表了  d:\data\projects
</span></span></span></code></pre></td></tr></table></div></div><ul><li><code>.</code> 代表了当前路径</li><li><code>..</code> 代表了上一级路径</li></ul><p>例如目录结构如下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-31-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-31-1>1</a>
</span><span class=lnt id=hl-31-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-31-2>2</a>
</span><span class=lnt id=hl-31-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-31-3>3</a>
</span><span class=lnt id=hl-31-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-31-4>4</a>
</span><span class=lnt id=hl-31-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-31-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>d:
</span></span><span class=line><span class=cl>    |- data
</span></span><span class=line><span class=cl>        |- projects
</span></span><span class=line><span class=cl>            |- a
</span></span><span class=line><span class=cl>            |- b
</span></span></code></pre></td></tr></table></div></div><p>代码</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-32-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-32-1>1</a>
</span><span class=lnt id=hl-32-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-32-2>2</a>
</span><span class=lnt id=hl-32-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-32-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Path</span> <span class=n>path</span> <span class=o>=</span> <span class=n>Paths</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=s>&#34;d:\\data\\projects\\a\\..\\b&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>path</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>path</span><span class=o>.</span><span class=na>normalize</span><span class=o>());</span> <span class=c1>// 正常化路径
</span></span></span></code></pre></td></tr></table></div></div><p>会输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-33-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-1>1</a>
</span><span class=lnt id=hl-33-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-33-2>2</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>d:\data\projects\a\..\b
</span></span><span class=line><span class=cl>d:\data\projects\b
</span></span></code></pre></td></tr></table></div></div><a href=#34-files><h3 id=34-files><span class=hanchor arialabel=Anchor># </span>3.4 Files</h3></a><p>检查文件是否存在</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-34-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-34-1>1</a>
</span><span class=lnt id=hl-34-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-34-2>2</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Path</span> <span class=n>path</span> <span class=o>=</span> <span class=n>Paths</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=s>&#34;helloword/data.txt&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>Files</span><span class=o>.</span><span class=na>exists</span><span class=o>(</span><span class=n>path</span><span class=o>));</span>
</span></span></code></pre></td></tr></table></div></div><p>创建一级目录</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-35-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-35-1>1</a>
</span><span class=lnt id=hl-35-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-35-2>2</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Path</span> <span class=n>path</span> <span class=o>=</span> <span class=n>Paths</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=s>&#34;helloword/d1&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>Files</span><span class=o>.</span><span class=na>createDirectory</span><span class=o>(</span><span class=n>path</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>如果目录已存在，会抛异常 FileAlreadyExistsException</li><li>不能一次创建多级目录，否则会抛异常 NoSuchFileException</li></ul><p>创建多级目录用</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-36-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-36-1>1</a>
</span><span class=lnt id=hl-36-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-36-2>2</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Path</span> <span class=n>path</span> <span class=o>=</span> <span class=n>Paths</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=s>&#34;helloword/d1/d2&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>Files</span><span class=o>.</span><span class=na>createDirectories</span><span class=o>(</span><span class=n>path</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><p>拷贝文件</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-37-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-37-1>1</a>
</span><span class=lnt id=hl-37-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-37-2>2</a>
</span><span class=lnt id=hl-37-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-37-3>3</a>
</span><span class=lnt id=hl-37-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-37-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Path</span> <span class=n>source</span> <span class=o>=</span> <span class=n>Paths</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=s>&#34;helloword/data.txt&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>Path</span> <span class=n>target</span> <span class=o>=</span> <span class=n>Paths</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=s>&#34;helloword/target.txt&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Files</span><span class=o>.</span><span class=na>copy</span><span class=o>(</span><span class=n>source</span><span class=o>,</span> <span class=n>target</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>如果文件已存在，会抛异常 FileAlreadyExistsException</li></ul><p>如果希望用 source 覆盖掉 target，需要用 StandardCopyOption 来控制</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-38-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-38-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Files</span><span class=o>.</span><span class=na>copy</span><span class=o>(</span><span class=n>source</span><span class=o>,</span> <span class=n>target</span><span class=o>,</span> <span class=n>StandardCopyOption</span><span class=o>.</span><span class=na>REPLACE_EXISTING</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><p>移动文件</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-39-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-39-1>1</a>
</span><span class=lnt id=hl-39-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-39-2>2</a>
</span><span class=lnt id=hl-39-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-39-3>3</a>
</span><span class=lnt id=hl-39-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-39-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Path</span> <span class=n>source</span> <span class=o>=</span> <span class=n>Paths</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=s>&#34;helloword/data.txt&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>Path</span> <span class=n>target</span> <span class=o>=</span> <span class=n>Paths</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=s>&#34;helloword/data.txt&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Files</span><span class=o>.</span><span class=na>move</span><span class=o>(</span><span class=n>source</span><span class=o>,</span> <span class=n>target</span><span class=o>,</span> <span class=n>StandardCopyOption</span><span class=o>.</span><span class=na>ATOMIC_MOVE</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>StandardCopyOption.ATOMIC_MOVE 保证文件移动的原子性</li></ul><p>删除文件</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-40-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-40-1>1</a>
</span><span class=lnt id=hl-40-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-40-2>2</a>
</span><span class=lnt id=hl-40-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-40-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Path</span> <span class=n>target</span> <span class=o>=</span> <span class=n>Paths</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=s>&#34;helloword/target.txt&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Files</span><span class=o>.</span><span class=na>delete</span><span class=o>(</span><span class=n>target</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>如果文件不存在，会抛异常 NoSuchFileException</li></ul><p>删除目录</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-41-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-41-1>1</a>
</span><span class=lnt id=hl-41-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-41-2>2</a>
</span><span class=lnt id=hl-41-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-41-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Path</span> <span class=n>target</span> <span class=o>=</span> <span class=n>Paths</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=s>&#34;helloword/d1&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Files</span><span class=o>.</span><span class=na>delete</span><span class=o>(</span><span class=n>target</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>如果目录还有内容，会抛异常 DirectoryNotEmptyException</li></ul><p>遍历目录文件</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-42-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-1> 1</a>
</span><span class=lnt id=hl-42-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-2> 2</a>
</span><span class=lnt id=hl-42-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-3> 3</a>
</span><span class=lnt id=hl-42-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-4> 4</a>
</span><span class=lnt id=hl-42-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-5> 5</a>
</span><span class=lnt id=hl-42-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-6> 6</a>
</span><span class=lnt id=hl-42-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-7> 7</a>
</span><span class=lnt id=hl-42-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-8> 8</a>
</span><span class=lnt id=hl-42-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-9> 9</a>
</span><span class=lnt id=hl-42-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-10>10</a>
</span><span class=lnt id=hl-42-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-11>11</a>
</span><span class=lnt id=hl-42-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-12>12</a>
</span><span class=lnt id=hl-42-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-13>13</a>
</span><span class=lnt id=hl-42-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-14>14</a>
</span><span class=lnt id=hl-42-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-15>15</a>
</span><span class=lnt id=hl-42-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-16>16</a>
</span><span class=lnt id=hl-42-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-17>17</a>
</span><span class=lnt id=hl-42-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-18>18</a>
</span><span class=lnt id=hl-42-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-19>19</a>
</span><span class=lnt id=hl-42-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-20>20</a>
</span><span class=lnt id=hl-42-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-21>21</a>
</span><span class=lnt id=hl-42-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-22>22</a>
</span><span class=lnt id=hl-42-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-23>23</a>
</span><span class=lnt id=hl-42-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-42-24>24</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Path</span> <span class=n>path</span> <span class=o>=</span> <span class=n>Paths</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=s>&#34;C:\\Program Files\\Java\\jdk1.8.0_91&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>AtomicInteger</span> <span class=n>dirCount</span> <span class=o>=</span> <span class=k>new</span> <span class=n>AtomicInteger</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>AtomicInteger</span> <span class=n>fileCount</span> <span class=o>=</span> <span class=k>new</span> <span class=n>AtomicInteger</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>Files</span><span class=o>.</span><span class=na>walkFileTree</span><span class=o>(</span><span class=n>path</span><span class=o>,</span> <span class=k>new</span> <span class=n>SimpleFileVisitor</span><span class=o>&lt;</span><span class=n>Path</span><span class=o>&gt;(){</span>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=n>FileVisitResult</span> <span class=nf>preVisitDirectory</span><span class=o>(</span><span class=n>Path</span> <span class=n>dir</span><span class=o>,</span> <span class=n>BasicFileAttributes</span> <span class=n>attrs</span><span class=o>)</span> 
</span></span><span class=line><span class=cl>            <span class=kd>throws</span> <span class=n>IOException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>dir</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>dirCount</span><span class=o>.</span><span class=na>incrementAndGet</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kd>super</span><span class=o>.</span><span class=na>preVisitDirectory</span><span class=o>(</span><span class=n>dir</span><span class=o>,</span> <span class=n>attrs</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=n>FileVisitResult</span> <span class=nf>visitFile</span><span class=o>(</span><span class=n>Path</span> <span class=n>file</span><span class=o>,</span> <span class=n>BasicFileAttributes</span> <span class=n>attrs</span><span class=o>)</span> 
</span></span><span class=line><span class=cl>            <span class=kd>throws</span> <span class=n>IOException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>file</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>fileCount</span><span class=o>.</span><span class=na>incrementAndGet</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kd>super</span><span class=o>.</span><span class=na>visitFile</span><span class=o>(</span><span class=n>file</span><span class=o>,</span> <span class=n>attrs</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>});</span>
</span></span><span class=line><span class=cl>    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>dirCount</span><span class=o>);</span> <span class=c1>// 133
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>fileCount</span><span class=o>);</span> <span class=c1>// 1479
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>统计 jar 的数目</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-43-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-1> 1</a>
</span><span class=lnt id=hl-43-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-2> 2</a>
</span><span class=lnt id=hl-43-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-3> 3</a>
</span><span class=lnt id=hl-43-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-4> 4</a>
</span><span class=lnt id=hl-43-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-5> 5</a>
</span><span class=lnt id=hl-43-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-6> 6</a>
</span><span class=lnt id=hl-43-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-7> 7</a>
</span><span class=lnt id=hl-43-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-8> 8</a>
</span><span class=lnt id=hl-43-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-9> 9</a>
</span><span class=lnt id=hl-43-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-10>10</a>
</span><span class=lnt id=hl-43-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-11>11</a>
</span><span class=lnt id=hl-43-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-12>12</a>
</span><span class=lnt id=hl-43-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-43-13>13</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Path</span> <span class=n>path</span> <span class=o>=</span> <span class=n>Paths</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=s>&#34;C:\\Program Files\\Java\\jdk1.8.0_91&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>AtomicInteger</span> <span class=n>fileCount</span> <span class=o>=</span> <span class=k>new</span> <span class=n>AtomicInteger</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=n>Files</span><span class=o>.</span><span class=na>walkFileTree</span><span class=o>(</span><span class=n>path</span><span class=o>,</span> <span class=k>new</span> <span class=n>SimpleFileVisitor</span><span class=o>&lt;</span><span class=n>Path</span><span class=o>&gt;(){</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>FileVisitResult</span> <span class=nf>visitFile</span><span class=o>(</span><span class=n>Path</span> <span class=n>file</span><span class=o>,</span> <span class=n>BasicFileAttributes</span> <span class=n>attrs</span><span class=o>)</span> 
</span></span><span class=line><span class=cl>        <span class=kd>throws</span> <span class=n>IOException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>file</span><span class=o>.</span><span class=na>toFile</span><span class=o>().</span><span class=na>getName</span><span class=o>().</span><span class=na>endsWith</span><span class=o>(</span><span class=s>&#34;.jar&#34;</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>fileCount</span><span class=o>.</span><span class=na>incrementAndGet</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kd>super</span><span class=o>.</span><span class=na>visitFile</span><span class=o>(</span><span class=n>file</span><span class=o>,</span> <span class=n>attrs</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>});</span>
</span></span><span class=line><span class=cl><span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>fileCount</span><span class=o>);</span> <span class=c1>// 724
</span></span></span></code></pre></td></tr></table></div></div><p>删除多级目录</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-44-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-44-1> 1</a>
</span><span class=lnt id=hl-44-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-44-2> 2</a>
</span><span class=lnt id=hl-44-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-44-3> 3</a>
</span><span class=lnt id=hl-44-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-44-4> 4</a>
</span><span class=lnt id=hl-44-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-44-5> 5</a>
</span><span class=lnt id=hl-44-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-44-6> 6</a>
</span><span class=lnt id=hl-44-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-44-7> 7</a>
</span><span class=lnt id=hl-44-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-44-8> 8</a>
</span><span class=lnt id=hl-44-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-44-9> 9</a>
</span><span class=lnt id=hl-44-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-44-10>10</a>
</span><span class=lnt id=hl-44-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-44-11>11</a>
</span><span class=lnt id=hl-44-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-44-12>12</a>
</span><span class=lnt id=hl-44-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-44-13>13</a>
</span><span class=lnt id=hl-44-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-44-14>14</a>
</span><span class=lnt id=hl-44-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-44-15>15</a>
</span><span class=lnt id=hl-44-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-44-16>16</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Path</span> <span class=n>path</span> <span class=o>=</span> <span class=n>Paths</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=s>&#34;d:\\a&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>Files</span><span class=o>.</span><span class=na>walkFileTree</span><span class=o>(</span><span class=n>path</span><span class=o>,</span> <span class=k>new</span> <span class=n>SimpleFileVisitor</span><span class=o>&lt;</span><span class=n>Path</span><span class=o>&gt;(){</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>FileVisitResult</span> <span class=nf>visitFile</span><span class=o>(</span><span class=n>Path</span> <span class=n>file</span><span class=o>,</span> <span class=n>BasicFileAttributes</span> <span class=n>attrs</span><span class=o>)</span> 
</span></span><span class=line><span class=cl>        <span class=kd>throws</span> <span class=n>IOException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Files</span><span class=o>.</span><span class=na>delete</span><span class=o>(</span><span class=n>file</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kd>super</span><span class=o>.</span><span class=na>visitFile</span><span class=o>(</span><span class=n>file</span><span class=o>,</span> <span class=n>attrs</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>FileVisitResult</span> <span class=nf>postVisitDirectory</span><span class=o>(</span><span class=n>Path</span> <span class=n>dir</span><span class=o>,</span> <span class=n>IOException</span> <span class=n>exc</span><span class=o>)</span> 
</span></span><span class=line><span class=cl>        <span class=kd>throws</span> <span class=n>IOException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Files</span><span class=o>.</span><span class=na>delete</span><span class=o>(</span><span class=n>dir</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kd>super</span><span class=o>.</span><span class=na>postVisitDirectory</span><span class=o>(</span><span class=n>dir</span><span class=o>,</span> <span class=n>exc</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>});</span>
</span></span></code></pre></td></tr></table></div></div><a href=#-删除很危险><h4 id=-删除很危险><span class=hanchor arialabel=Anchor># </span>⚠️ 删除很危险</h4></a><blockquote><p>删除是危险操作，确保要递归删除的文件夹没有重要内容</p></blockquote><p>拷贝多级目录</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-45-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-45-1> 1</a>
</span><span class=lnt id=hl-45-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-45-2> 2</a>
</span><span class=lnt id=hl-45-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-45-3> 3</a>
</span><span class=lnt id=hl-45-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-45-4> 4</a>
</span><span class=lnt id=hl-45-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-45-5> 5</a>
</span><span class=lnt id=hl-45-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-45-6> 6</a>
</span><span class=lnt id=hl-45-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-45-7> 7</a>
</span><span class=lnt id=hl-45-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-45-8> 8</a>
</span><span class=lnt id=hl-45-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-45-9> 9</a>
</span><span class=lnt id=hl-45-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-45-10>10</a>
</span><span class=lnt id=hl-45-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-45-11>11</a>
</span><span class=lnt id=hl-45-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-45-12>12</a>
</span><span class=lnt id=hl-45-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-45-13>13</a>
</span><span class=lnt id=hl-45-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-45-14>14</a>
</span><span class=lnt id=hl-45-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-45-15>15</a>
</span><span class=lnt id=hl-45-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-45-16>16</a>
</span><span class=lnt id=hl-45-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-45-17>17</a>
</span><span class=lnt id=hl-45-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-45-18>18</a>
</span><span class=lnt id=hl-45-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-45-19>19</a>
</span><span class=lnt id=hl-45-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-45-20>20</a>
</span><span class=lnt id=hl-45-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-45-21>21</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kt>long</span> <span class=n>start</span> <span class=o>=</span> <span class=n>System</span><span class=o>.</span><span class=na>currentTimeMillis</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=n>String</span> <span class=n>source</span> <span class=o>=</span> <span class=s>&#34;D:\\Snipaste-1.16.2-x64&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=n>String</span> <span class=n>target</span> <span class=o>=</span> <span class=s>&#34;D:\\Snipaste-1.16.2-x64aaa&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Files</span><span class=o>.</span><span class=na>walk</span><span class=o>(</span><span class=n>Paths</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>source</span><span class=o>)).</span><span class=na>forEach</span><span class=o>(</span><span class=n>path</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>String</span> <span class=n>targetName</span> <span class=o>=</span> <span class=n>path</span><span class=o>.</span><span class=na>toString</span><span class=o>().</span><span class=na>replace</span><span class=o>(</span><span class=n>source</span><span class=o>,</span> <span class=n>target</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 是目录
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=o>(</span><span class=n>Files</span><span class=o>.</span><span class=na>isDirectory</span><span class=o>(</span><span class=n>path</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Files</span><span class=o>.</span><span class=na>createDirectory</span><span class=o>(</span><span class=n>Paths</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>targetName</span><span class=o>));</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 是普通文件
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>Files</span><span class=o>.</span><span class=na>isRegularFile</span><span class=o>(</span><span class=n>path</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Files</span><span class=o>.</span><span class=na>copy</span><span class=o>(</span><span class=n>path</span><span class=o>,</span> <span class=n>Paths</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>targetName</span><span class=o>));</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>});</span>
</span></span><span class=line><span class=cl><span class=kt>long</span> <span class=n>end</span> <span class=o>=</span> <span class=n>System</span><span class=o>.</span><span class=na>currentTimeMillis</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>end</span> <span class=o>-</span> <span class=n>start</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><a href=#4-网络编程><h2 id=4-网络编程><span class=hanchor arialabel=Anchor># </span>4. 网络编程</h2></a><a href=#41-非阻塞-vs-阻塞><h3 id=41-非阻塞-vs-阻塞><span class=hanchor arialabel=Anchor># </span>4.1 非阻塞 vs 阻塞</h3></a><a href=#阻塞><h4 id=阻塞><span class=hanchor arialabel=Anchor># </span>阻塞</h4></a><ul><li>阻塞模式下，相关方法都会导致线程暂停<ul><li>ServerSocketChannel.accept 会在没有连接建立时让线程暂停</li><li>SocketChannel.read 会在没有数据可读时让线程暂停</li><li>阻塞的表现其实就是线程暂停了，暂停期间不会占用 cpu，但线程相当于闲置</li></ul></li><li>单线程下，阻塞方法之间相互影响，几乎不能正常工作，需要多线程支持</li><li>但多线程下，有新的问题，体现在以下方面<ul><li>32 位 jvm 一个线程 320k，64 位 jvm 一个线程 1024k，如果连接数过多，必然导致 OOM，并且线程太多，反而会因为频繁上下文切换导致性能降低</li><li>可以采用线程池技术来减少线程数和线程上下文切换，但治标不治本，如果有很多连接建立，但长时间 inactive，会阻塞线程池中所有线程，因此不适合长连接，只适合短连接</li></ul></li></ul><p>服务器端</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-46-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-46-1> 1</a>
</span><span class=lnt id=hl-46-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-46-2> 2</a>
</span><span class=lnt id=hl-46-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-46-3> 3</a>
</span><span class=lnt id=hl-46-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-46-4> 4</a>
</span><span class=lnt id=hl-46-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-46-5> 5</a>
</span><span class=lnt id=hl-46-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-46-6> 6</a>
</span><span class=lnt id=hl-46-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-46-7> 7</a>
</span><span class=lnt id=hl-46-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-46-8> 8</a>
</span><span class=lnt id=hl-46-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-46-9> 9</a>
</span><span class=lnt id=hl-46-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-46-10>10</a>
</span><span class=lnt id=hl-46-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-46-11>11</a>
</span><span class=lnt id=hl-46-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-46-12>12</a>
</span><span class=lnt id=hl-46-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-46-13>13</a>
</span><span class=lnt id=hl-46-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-46-14>14</a>
</span><span class=lnt id=hl-46-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-46-15>15</a>
</span><span class=lnt id=hl-46-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-46-16>16</a>
</span><span class=lnt id=hl-46-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-46-17>17</a>
</span><span class=lnt id=hl-46-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-46-18>18</a>
</span><span class=lnt id=hl-46-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-46-19>19</a>
</span><span class=lnt id=hl-46-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-46-20>20</a>
</span><span class=lnt id=hl-46-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-46-21>21</a>
</span><span class=lnt id=hl-46-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-46-22>22</a>
</span><span class=lnt id=hl-46-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-46-23>23</a>
</span><span class=lnt id=hl-46-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-46-24>24</a>
</span><span class=lnt id=hl-46-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-46-25>25</a>
</span><span class=lnt id=hl-46-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-46-26>26</a>
</span><span class=lnt id=hl-46-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-46-27>27</a>
</span><span class=lnt id=hl-46-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-46-28>28</a>
</span><span class=lnt id=hl-46-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-46-29>29</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 使用 nio 来理解阻塞模式, 单线程
</span></span></span><span class=line><span class=cl><span class=c1>// 0. ByteBuffer
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>ByteBuffer</span> <span class=n>buffer</span> <span class=o>=</span> <span class=n>ByteBuffer</span><span class=o>.</span><span class=na>allocate</span><span class=o>(</span><span class=n>16</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=c1>// 1. 创建了服务器
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>ServerSocketChannel</span> <span class=n>ssc</span> <span class=o>=</span> <span class=n>ServerSocketChannel</span><span class=o>.</span><span class=na>open</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 2. 绑定监听端口
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>ssc</span><span class=o>.</span><span class=na>bind</span><span class=o>(</span><span class=k>new</span> <span class=n>InetSocketAddress</span><span class=o>(</span><span class=n>8080</span><span class=o>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 3. 连接集合
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>List</span><span class=o>&lt;</span><span class=n>SocketChannel</span><span class=o>&gt;</span> <span class=n>channels</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;();</span>
</span></span><span class=line><span class=cl><span class=k>while</span> <span class=o>(</span><span class=kc>true</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 4. accept 建立与客户端连接， SocketChannel 用来与客户端之间通信
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;connecting...&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// 
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>SocketChannel</span> <span class=n>sc</span> <span class=o>=</span> <span class=n>ssc</span><span class=o>.</span><span class=na>accept</span><span class=o>();</span>  <span class=c1>// 阻塞方法，线程停止运行
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;connected... {}&#34;</span><span class=o>,</span> <span class=n>sc</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>channels</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>sc</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=o>(</span><span class=n>SocketChannel</span> <span class=n>channel</span> <span class=o>:</span> <span class=n>channels</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 5. 接收客户端发送的数据
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;before read... {}&#34;</span><span class=o>,</span> <span class=n>channel</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>channel</span><span class=o>.</span><span class=na>read</span><span class=o>(</span><span class=n>buffer</span><span class=o>);</span> <span class=c1>// 阻塞方法，线程停止运行
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>buffer</span><span class=o>.</span><span class=na>flip</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>debugRead</span><span class=o>(</span><span class=n>buffer</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>buffer</span><span class=o>.</span><span class=na>clear</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;after read...{}&#34;</span><span class=o>,</span> <span class=n>channel</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>客户端</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-47-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-47-1>1</a>
</span><span class=lnt id=hl-47-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-47-2>2</a>
</span><span class=lnt id=hl-47-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-47-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>SocketChannel</span> <span class=n>sc</span> <span class=o>=</span> <span class=n>SocketChannel</span><span class=o>.</span><span class=na>open</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=n>sc</span><span class=o>.</span><span class=na>connect</span><span class=o>(</span><span class=k>new</span> <span class=n>InetSocketAddress</span><span class=o>(</span><span class=s>&#34;localhost&#34;</span><span class=o>,</span> <span class=n>8080</span><span class=o>));</span>
</span></span><span class=line><span class=cl><span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;waiting...&#34;</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><a href=#非阻塞><h4 id=非阻塞><span class=hanchor arialabel=Anchor># </span>非阻塞</h4></a><ul><li>非阻塞模式下，相关方法都会不会让线程暂停<ul><li>在 ServerSocketChannel.accept 在没有连接建立时，会返回 null，继续运行</li><li>SocketChannel.read 在没有数据可读时，会返回 0，但线程不必阻塞，可以去执行其它 SocketChannel 的 read 或是去执行 ServerSocketChannel.accept</li><li>写数据时，线程只是等待数据写入 Channel 即可，无需等 Channel 通过网络把数据发送出去</li></ul></li><li>但非阻塞模式下，即使没有连接建立，和可读数据，线程仍然在不断<strong>自旋</strong>运行，白白浪费了 cpu</li><li>数据复制过程中，线程实际还是阻塞的（AIO 改进的地方）</li></ul><p>服务器端，客户端代码不变</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-48-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-48-1> 1</a>
</span><span class=lnt id=hl-48-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-48-2> 2</a>
</span><span class=lnt id=hl-48-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-48-3> 3</a>
</span><span class=lnt id=hl-48-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-48-4> 4</a>
</span><span class=lnt id=hl-48-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-48-5> 5</a>
</span><span class=lnt id=hl-48-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-48-6> 6</a>
</span><span class=lnt id=hl-48-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-48-7> 7</a>
</span><span class=lnt id=hl-48-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-48-8> 8</a>
</span><span class=lnt id=hl-48-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-48-9> 9</a>
</span><span class=lnt id=hl-48-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-48-10>10</a>
</span><span class=lnt id=hl-48-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-48-11>11</a>
</span><span class=lnt id=hl-48-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-48-12>12</a>
</span><span class=lnt id=hl-48-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-48-13>13</a>
</span><span class=lnt id=hl-48-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-48-14>14</a>
</span><span class=lnt id=hl-48-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-48-15>15</a>
</span><span class=lnt id=hl-48-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-48-16>16</a>
</span><span class=lnt id=hl-48-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-48-17>17</a>
</span><span class=lnt id=hl-48-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-48-18>18</a>
</span><span class=lnt id=hl-48-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-48-19>19</a>
</span><span class=lnt id=hl-48-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-48-20>20</a>
</span><span class=lnt id=hl-48-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-48-21>21</a>
</span><span class=lnt id=hl-48-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-48-22>22</a>
</span><span class=lnt id=hl-48-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-48-23>23</a>
</span><span class=lnt id=hl-48-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-48-24>24</a>
</span><span class=lnt id=hl-48-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-48-25>25</a>
</span><span class=lnt id=hl-48-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-48-26>26</a>
</span><span class=lnt id=hl-48-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-48-27>27</a>
</span><span class=lnt id=hl-48-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-48-28>28</a>
</span><span class=lnt id=hl-48-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-48-29>29</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 使用 nio 来理解非阻塞模式, 单线程
</span></span></span><span class=line><span class=cl><span class=c1>// 0. ByteBuffer
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>ByteBuffer</span> <span class=n>buffer</span> <span class=o>=</span> <span class=n>ByteBuffer</span><span class=o>.</span><span class=na>allocate</span><span class=o>(</span><span class=n>16</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=c1>// 1. 创建了服务器
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>ServerSocketChannel</span> <span class=n>ssc</span> <span class=o>=</span> <span class=n>ServerSocketChannel</span><span class=o>.</span><span class=na>open</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=n>ssc</span><span class=o>.</span><span class=na>configureBlocking</span><span class=o>(</span><span class=kc>false</span><span class=o>);</span> <span class=c1>// 非阻塞模式
</span></span></span><span class=line><span class=cl><span class=c1>// 2. 绑定监听端口
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>ssc</span><span class=o>.</span><span class=na>bind</span><span class=o>(</span><span class=k>new</span> <span class=n>InetSocketAddress</span><span class=o>(</span><span class=n>8080</span><span class=o>));</span>
</span></span><span class=line><span class=cl><span class=c1>// 3. 连接集合
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>List</span><span class=o>&lt;</span><span class=n>SocketChannel</span><span class=o>&gt;</span> <span class=n>channels</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;();</span>
</span></span><span class=line><span class=cl><span class=k>while</span> <span class=o>(</span><span class=kc>true</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 4. accept 建立与客户端连接， SocketChannel 用来与客户端之间通信
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>SocketChannel</span> <span class=n>sc</span> <span class=o>=</span> <span class=n>ssc</span><span class=o>.</span><span class=na>accept</span><span class=o>();</span> <span class=c1>// 非阻塞，线程还会继续运行，如果没有连接建立，但sc是 null
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>(</span><span class=n>sc</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;connected... {}&#34;</span><span class=o>,</span> <span class=n>sc</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>sc</span><span class=o>.</span><span class=na>configureBlocking</span><span class=o>(</span><span class=kc>false</span><span class=o>);</span> <span class=c1>// 非阻塞模式
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>channels</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>sc</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=o>(</span><span class=n>SocketChannel</span> <span class=n>channel</span> <span class=o>:</span> <span class=n>channels</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 5. 接收客户端发送的数据
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kt>int</span> <span class=n>read</span> <span class=o>=</span> <span class=n>channel</span><span class=o>.</span><span class=na>read</span><span class=o>(</span><span class=n>buffer</span><span class=o>);</span><span class=c1>// 非阻塞，线程仍然会继续运行，如果没有读到数据，read 返回 0
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=o>(</span><span class=n>read</span> <span class=o>&gt;</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>buffer</span><span class=o>.</span><span class=na>flip</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>debugRead</span><span class=o>(</span><span class=n>buffer</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>buffer</span><span class=o>.</span><span class=na>clear</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;after read...{}&#34;</span><span class=o>,</span> <span class=n>channel</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>sc非阻塞模式下一个客户端连续发送多个包就会观测到粘包现象。</p></blockquote><a href=#多路复用><h4 id=多路复用><span class=hanchor arialabel=Anchor># </span>多路复用</h4></a><p><strong>单线程可以配合 Selector 完成对多个 Channel 可读写事件的监控，这称之为多路复用</strong></p><ul><li>多路复用<strong>仅</strong>针对网络 IO、普通文件 IO 没法利用多路复用</li><li>如果不用 Selector 的非阻塞模式，线程大部分时间都在做无用功，而 Selector 能够保证<ul><li>有可连接事件时才去连接</li><li>有可读事件才去读取</li><li>有可写事件才去写入<ul><li>限于网络传输能力，Channel 未必时时可写，一旦 Channel 可写，会触发 Selector 的可写事件</li></ul></li></ul></li></ul><a href=#42-selector><h3 id=42-selector><span class=hanchor arialabel=Anchor># </span>4.2 Selector</h3></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-49-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-49-1>1</a>
</span><span class=lnt id=hl-49-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-49-2>2</a>
</span><span class=lnt id=hl-49-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-49-3>3</a>
</span><span class=lnt id=hl-49-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-49-4>4</a>
</span><span class=lnt id=hl-49-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-49-5>5</a>
</span><span class=lnt id=hl-49-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-49-6>6</a>
</span><span class=lnt id=hl-49-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-49-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>graph TD
</span></span><span class=line><span class=cl>subgraph selector 版
</span></span><span class=line><span class=cl>thread --&gt; selector
</span></span><span class=line><span class=cl>selector --&gt; c1(channel)
</span></span><span class=line><span class=cl>selector --&gt; c2(channel)
</span></span><span class=line><span class=cl>selector --&gt; c3(channel)
</span></span><span class=line><span class=cl>end
</span></span></code></pre></td></tr></table></div></div><p>好处</p><ul><li>一个线程配合 selector 就可以监控多个 channel 的事件，事件发生线程才去处理。避免非阻塞模式下所做无用功</li><li>让这个线程能够被充分利用</li><li>节约了线程的数量</li><li>减少了线程上下文切换</li></ul><a href=#创建><h4 id=创建><span class=hanchor arialabel=Anchor># </span>创建</h4></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-50-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-50-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Selector</span> <span class=n>selector</span> <span class=o>=</span> <span class=n>Selector</span><span class=o>.</span><span class=na>open</span><span class=o>();</span>
</span></span></code></pre></td></tr></table></div></div><a href=#绑定-channel-事件><h4 id=绑定-channel-事件><span class=hanchor arialabel=Anchor># </span>绑定 Channel 事件</h4></a><p>也称之为注册事件，绑定的事件 selector 才会关心</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-51-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-51-1>1</a>
</span><span class=lnt id=hl-51-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-51-2>2</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>channel</span><span class=o>.</span><span class=na>configureBlocking</span><span class=o>(</span><span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>SelectionKey</span> <span class=n>key</span> <span class=o>=</span> <span class=n>channel</span><span class=o>.</span><span class=na>register</span><span class=o>(</span><span class=n>selector</span><span class=o>,</span> <span class=n>绑定事件</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>channel 必须工作在<strong>非</strong>阻塞模式</li><li>FileChannel <strong>没有</strong>非阻塞模式，因此不能配合 selector 一起使用</li><li>绑定的事件类型可以有<ul><li>connect - 客户端连接成功时触发</li><li>accept - 服务器端成功接受连接时触发</li><li>read - 数据可读入时触发，有因为接收能力弱，数据暂不能读入的情况</li><li>write - 数据可写出时触发，有因为发送能力弱，数据暂不能写出的情况</li></ul></li></ul><a href=#监听-channel-事件><h4 id=监听-channel-事件><span class=hanchor arialabel=Anchor># </span>监听 Channel 事件</h4></a><p>可以通过下面三种方法来监听是否有事件发生，方法的返回值代表有多少 channel 发生了事件</p><p>方法1，阻塞直到绑定事件发生</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-52-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-52-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kt>int</span> <span class=n>count</span> <span class=o>=</span> <span class=n>selector</span><span class=o>.</span><span class=na>select</span><span class=o>();</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>select方法底层调用的是操作系统的<a href=/2_0_2-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/2_0_2_1_2_3-%E8%BD%AF%E4%BB%B6%E7%B3%BB%E7%BB%9F/2_0_2_1_2_3_1-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/epoll rel=noopener class=internal-link data-src=/2_0_2-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/2_0_2_1_2_3-%E8%BD%AF%E4%BB%B6%E7%B3%BB%E7%BB%9F/2_0_2_1_2_3_1-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/epoll>epoll</a> 中epoll_wait接口，读取有状态的IO的阻塞方法，可设置超时。</p></blockquote><p>方法2，阻塞直到绑定事件发生，或是超时（时间单位为 ms）</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-53-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-53-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kt>int</span> <span class=n>count</span> <span class=o>=</span> <span class=n>selector</span><span class=o>.</span><span class=na>select</span><span class=o>(</span><span class=kt>long</span> <span class=n>timeout</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><p>方法3，不会阻塞，也就是不管有没有事件，立刻返回，自己根据返回值检查是否有事件</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-54-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-54-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kt>int</span> <span class=n>count</span> <span class=o>=</span> <span class=n>selector</span><span class=o>.</span><span class=na>selectNow</span><span class=o>();</span>
</span></span></code></pre></td></tr></table></div></div><a href=#-select-何时不阻塞><h4 id=-select-何时不阻塞><span class=hanchor arialabel=Anchor># </span>💡 select 何时不阻塞</h4></a><blockquote><ul><li>事件发生时<ul><li>客户端发起连接请求，会触发 accept 事件</li><li>客户端发送数据过来，客户端正常、异常关闭时，都会触发 read 事件，另外如果发送的数据大于 buffer 缓冲区，会触发多次读取事件</li><li>channel 可写，会触发 write 事件</li><li>在 linux 下 nio bug 发生时</li></ul></li><li>调用 selector.wakeup()</li><li>调用 selector.close()</li><li>selector 所在线程 interrupt</li></ul></blockquote><a href=#43-处理-accept-事件><h3 id=43-处理-accept-事件><span class=hanchor arialabel=Anchor># </span>4.3 处理 accept 事件</h3></a><p>客户端代码为</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-55-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-55-1> 1</a>
</span><span class=lnt id=hl-55-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-55-2> 2</a>
</span><span class=lnt id=hl-55-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-55-3> 3</a>
</span><span class=lnt id=hl-55-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-55-4> 4</a>
</span><span class=lnt id=hl-55-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-55-5> 5</a>
</span><span class=lnt id=hl-55-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-55-6> 6</a>
</span><span class=lnt id=hl-55-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-55-7> 7</a>
</span><span class=lnt id=hl-55-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-55-8> 8</a>
</span><span class=lnt id=hl-55-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-55-9> 9</a>
</span><span class=lnt id=hl-55-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-55-10>10</a>
</span><span class=lnt id=hl-55-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-55-11>11</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>Client</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>(</span><span class=n>Socket</span> <span class=n>socket</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Socket</span><span class=o>(</span><span class=s>&#34;localhost&#34;</span><span class=o>,</span> <span class=n>8080</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>socket</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>socket</span><span class=o>.</span><span class=na>getOutputStream</span><span class=o>().</span><span class=na>write</span><span class=o>(</span><span class=s>&#34;world&#34;</span><span class=o>.</span><span class=na>getBytes</span><span class=o>());</span>
</span></span><span class=line><span class=cl>            <span class=n>System</span><span class=o>.</span><span class=na>in</span><span class=o>.</span><span class=na>read</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>服务器端代码为</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-56-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-56-1> 1</a>
</span><span class=lnt id=hl-56-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-56-2> 2</a>
</span><span class=lnt id=hl-56-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-56-3> 3</a>
</span><span class=lnt id=hl-56-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-56-4> 4</a>
</span><span class=lnt id=hl-56-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-56-5> 5</a>
</span><span class=lnt id=hl-56-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-56-6> 6</a>
</span><span class=lnt id=hl-56-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-56-7> 7</a>
</span><span class=lnt id=hl-56-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-56-8> 8</a>
</span><span class=lnt id=hl-56-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-56-9> 9</a>
</span><span class=lnt id=hl-56-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-56-10>10</a>
</span><span class=lnt id=hl-56-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-56-11>11</a>
</span><span class=lnt id=hl-56-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-56-12>12</a>
</span><span class=lnt id=hl-56-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-56-13>13</a>
</span><span class=lnt id=hl-56-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-56-14>14</a>
</span><span class=lnt id=hl-56-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-56-15>15</a>
</span><span class=lnt id=hl-56-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-56-16>16</a>
</span><span class=lnt id=hl-56-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-56-17>17</a>
</span><span class=lnt id=hl-56-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-56-18>18</a>
</span><span class=lnt id=hl-56-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-56-19>19</a>
</span><span class=lnt id=hl-56-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-56-20>20</a>
</span><span class=lnt id=hl-56-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-56-21>21</a>
</span><span class=lnt id=hl-56-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-56-22>22</a>
</span><span class=lnt id=hl-56-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-56-23>23</a>
</span><span class=lnt id=hl-56-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-56-24>24</a>
</span><span class=lnt id=hl-56-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-56-25>25</a>
</span><span class=lnt id=hl-56-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-56-26>26</a>
</span><span class=lnt id=hl-56-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-56-27>27</a>
</span><span class=lnt id=hl-56-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-56-28>28</a>
</span><span class=lnt id=hl-56-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-56-29>29</a>
</span><span class=lnt id=hl-56-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-56-30>30</a>
</span><span class=lnt id=hl-56-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-56-31>31</a>
</span><span class=lnt id=hl-56-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-56-32>32</a>
</span><span class=lnt id=hl-56-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-56-33>33</a>
</span><span class=lnt id=hl-56-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-56-34>34</a>
</span><span class=lnt id=hl-56-35><a style=outline:none;text-decoration:none;color:inherit href=#hl-56-35>35</a>
</span><span class=lnt id=hl-56-36><a style=outline:none;text-decoration:none;color:inherit href=#hl-56-36>36</a>
</span><span class=lnt id=hl-56-37><a style=outline:none;text-decoration:none;color:inherit href=#hl-56-37>37</a>
</span><span class=lnt id=hl-56-38><a style=outline:none;text-decoration:none;color:inherit href=#hl-56-38>38</a>
</span><span class=lnt id=hl-56-39><a style=outline:none;text-decoration:none;color:inherit href=#hl-56-39>39</a>
</span><span class=lnt id=hl-56-40><a style=outline:none;text-decoration:none;color:inherit href=#hl-56-40>40</a>
</span><span class=lnt id=hl-56-41><a style=outline:none;text-decoration:none;color:inherit href=#hl-56-41>41</a>
</span><span class=lnt id=hl-56-42><a style=outline:none;text-decoration:none;color:inherit href=#hl-56-42>42</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>ChannelDemo6</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>(</span><span class=n>ServerSocketChannel</span> <span class=n>channel</span> <span class=o>=</span> <span class=n>ServerSocketChannel</span><span class=o>.</span><span class=na>open</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>channel</span><span class=o>.</span><span class=na>bind</span><span class=o>(</span><span class=k>new</span> <span class=n>InetSocketAddress</span><span class=o>(</span><span class=n>8080</span><span class=o>));</span>
</span></span><span class=line><span class=cl>            <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>channel</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>Selector</span> <span class=n>selector</span> <span class=o>=</span> <span class=n>Selector</span><span class=o>.</span><span class=na>open</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>channel</span><span class=o>.</span><span class=na>configureBlocking</span><span class=o>(</span><span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>channel</span><span class=o>.</span><span class=na>register</span><span class=o>(</span><span class=n>selector</span><span class=o>,</span> <span class=n>SelectionKey</span><span class=o>.</span><span class=na>OP_ACCEPT</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>while</span> <span class=o>(</span><span class=kc>true</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=kt>int</span> <span class=n>count</span> <span class=o>=</span> <span class=n>selector</span><span class=o>.</span><span class=na>select</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=c1>//                int count = selector.selectNow();
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;select count: {}&#34;</span><span class=o>,</span> <span class=n>count</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=c1>//                if(count &lt;= 0) {
</span></span></span><span class=line><span class=cl><span class=c1>//                    continue;
</span></span></span><span class=line><span class=cl><span class=c1>//                }
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>                <span class=c1>// 获取所有事件
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=c1>// 拿到所有可读可写可连接的事件集合
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>Set</span><span class=o>&lt;</span><span class=n>SelectionKey</span><span class=o>&gt;</span> <span class=n>keys</span> <span class=o>=</span> <span class=n>selector</span><span class=o>.</span><span class=na>selectedKeys</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=c1>// 遍历所有事件，逐一处理
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>Iterator</span><span class=o>&lt;</span><span class=n>SelectionKey</span><span class=o>&gt;</span> <span class=n>iter</span> <span class=o>=</span> <span class=n>keys</span><span class=o>.</span><span class=na>iterator</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=k>while</span> <span class=o>(</span><span class=n>iter</span><span class=o>.</span><span class=na>hasNext</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>SelectionKey</span> <span class=n>key</span> <span class=o>=</span> <span class=n>iter</span><span class=o>.</span><span class=na>next</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                    <span class=c1>// 判断事件类型
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=k>if</span> <span class=o>(</span><span class=n>key</span><span class=o>.</span><span class=na>isAcceptable</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=n>ServerSocketChannel</span> <span class=n>c</span> <span class=o>=</span> <span class=o>(</span><span class=n>ServerSocketChannel</span><span class=o>)</span> <span class=n>key</span><span class=o>.</span><span class=na>channel</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                        <span class=c1>// 必须处理
</span></span></span><span class=line><span class=cl><span class=c1></span>                        <span class=n>SocketChannel</span> <span class=n>sc</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=na>accept</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                        <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;{}&#34;</span><span class=o>,</span> <span class=n>sc</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=o>}</span>
</span></span><span class=line><span class=cl>                    <span class=c1>// 处理完毕，必须将事件移除
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=n>iter</span><span class=o>.</span><span class=na>remove</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#-事件发生后能否不处理><h4 id=-事件发生后能否不处理><span class=hanchor arialabel=Anchor># </span>💡 事件发生后能否不处理</h4></a><blockquote><p>事件发生后，要么处理，要么取消（cancel），不能什么都不做，否则下次该事件仍会触发，这是因为 nio 底层使用的是<a href=/2_0_2-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/2_0_2_1_2_3-%E8%BD%AF%E4%BB%B6%E7%B3%BB%E7%BB%9F/2_0_2_1_2_3_1-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/epoll#%e6%b0%b4%e5%b9%b3%e8%a7%a6%e5%8f%91 rel=noopener class=internal-link data-src=/2_0_2-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/2_0_2_1_2_3-%E8%BD%AF%E4%BB%B6%E7%B3%BB%E7%BB%9F/2_0_2_1_2_3_1-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/epoll>水平触发</a></p></blockquote><a href=#44-处理-read-事件><h3 id=44-处理-read-事件><span class=hanchor arialabel=Anchor># </span>4.4 处理 read 事件</h3></a><blockquote><p>下面的代码<code>int count = selector.select();</code>处的阻塞会同时被连接建立和客户端写入给唤醒。因为此时selector注册了两个事件类型。</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-57-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-57-1> 1</a>
</span><span class=lnt id=hl-57-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-57-2> 2</a>
</span><span class=lnt id=hl-57-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-57-3> 3</a>
</span><span class=lnt id=hl-57-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-57-4> 4</a>
</span><span class=lnt id=hl-57-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-57-5> 5</a>
</span><span class=lnt id=hl-57-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-57-6> 6</a>
</span><span class=lnt id=hl-57-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-57-7> 7</a>
</span><span class=lnt id=hl-57-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-57-8> 8</a>
</span><span class=lnt id=hl-57-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-57-9> 9</a>
</span><span class=lnt id=hl-57-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-57-10>10</a>
</span><span class=lnt id=hl-57-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-57-11>11</a>
</span><span class=lnt id=hl-57-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-57-12>12</a>
</span><span class=lnt id=hl-57-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-57-13>13</a>
</span><span class=lnt id=hl-57-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-57-14>14</a>
</span><span class=lnt id=hl-57-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-57-15>15</a>
</span><span class=lnt id=hl-57-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-57-16>16</a>
</span><span class=lnt id=hl-57-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-57-17>17</a>
</span><span class=lnt id=hl-57-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-57-18>18</a>
</span><span class=lnt id=hl-57-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-57-19>19</a>
</span><span class=lnt id=hl-57-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-57-20>20</a>
</span><span class=lnt id=hl-57-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-57-21>21</a>
</span><span class=lnt id=hl-57-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-57-22>22</a>
</span><span class=lnt id=hl-57-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-57-23>23</a>
</span><span class=lnt id=hl-57-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-57-24>24</a>
</span><span class=lnt id=hl-57-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-57-25>25</a>
</span><span class=lnt id=hl-57-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-57-26>26</a>
</span><span class=lnt id=hl-57-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-57-27>27</a>
</span><span class=lnt id=hl-57-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-57-28>28</a>
</span><span class=lnt id=hl-57-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-57-29>29</a>
</span><span class=lnt id=hl-57-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-57-30>30</a>
</span><span class=lnt id=hl-57-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-57-31>31</a>
</span><span class=lnt id=hl-57-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-57-32>32</a>
</span><span class=lnt id=hl-57-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-57-33>33</a>
</span><span class=lnt id=hl-57-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-57-34>34</a>
</span><span class=lnt id=hl-57-35><a style=outline:none;text-decoration:none;color:inherit href=#hl-57-35>35</a>
</span><span class=lnt id=hl-57-36><a style=outline:none;text-decoration:none;color:inherit href=#hl-57-36>36</a>
</span><span class=lnt id=hl-57-37><a style=outline:none;text-decoration:none;color:inherit href=#hl-57-37>37</a>
</span><span class=lnt id=hl-57-38><a style=outline:none;text-decoration:none;color:inherit href=#hl-57-38>38</a>
</span><span class=lnt id=hl-57-39><a style=outline:none;text-decoration:none;color:inherit href=#hl-57-39>39</a>
</span><span class=lnt id=hl-57-40><a style=outline:none;text-decoration:none;color:inherit href=#hl-57-40>40</a>
</span><span class=lnt id=hl-57-41><a style=outline:none;text-decoration:none;color:inherit href=#hl-57-41>41</a>
</span><span class=lnt id=hl-57-42><a style=outline:none;text-decoration:none;color:inherit href=#hl-57-42>42</a>
</span><span class=lnt id=hl-57-43><a style=outline:none;text-decoration:none;color:inherit href=#hl-57-43>43</a>
</span><span class=lnt id=hl-57-44><a style=outline:none;text-decoration:none;color:inherit href=#hl-57-44>44</a>
</span><span class=lnt id=hl-57-45><a style=outline:none;text-decoration:none;color:inherit href=#hl-57-45>45</a>
</span><span class=lnt id=hl-57-46><a style=outline:none;text-decoration:none;color:inherit href=#hl-57-46>46</a>
</span><span class=lnt id=hl-57-47><a style=outline:none;text-decoration:none;color:inherit href=#hl-57-47>47</a>
</span><span class=lnt id=hl-57-48><a style=outline:none;text-decoration:none;color:inherit href=#hl-57-48>48</a>
</span><span class=lnt id=hl-57-49><a style=outline:none;text-decoration:none;color:inherit href=#hl-57-49>49</a>
</span><span class=lnt id=hl-57-50><a style=outline:none;text-decoration:none;color:inherit href=#hl-57-50>50</a>
</span><span class=lnt id=hl-57-51><a style=outline:none;text-decoration:none;color:inherit href=#hl-57-51>51</a>
</span><span class=lnt id=hl-57-52><a style=outline:none;text-decoration:none;color:inherit href=#hl-57-52>52</a>
</span><span class=lnt id=hl-57-53><a style=outline:none;text-decoration:none;color:inherit href=#hl-57-53>53</a>
</span><span class=lnt id=hl-57-54><a style=outline:none;text-decoration:none;color:inherit href=#hl-57-54>54</a>
</span><span class=lnt id=hl-57-55><a style=outline:none;text-decoration:none;color:inherit href=#hl-57-55>55</a>
</span><span class=lnt id=hl-57-56><a style=outline:none;text-decoration:none;color:inherit href=#hl-57-56>56</a>
</span><span class=lnt id=hl-57-57><a style=outline:none;text-decoration:none;color:inherit href=#hl-57-57>57</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>ChannelDemo6</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>(</span><span class=n>ServerSocketChannel</span> <span class=n>channel</span> <span class=o>=</span> <span class=n>ServerSocketChannel</span><span class=o>.</span><span class=na>open</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>channel</span><span class=o>.</span><span class=na>bind</span><span class=o>(</span><span class=k>new</span> <span class=n>InetSocketAddress</span><span class=o>(</span><span class=n>8080</span><span class=o>));</span>
</span></span><span class=line><span class=cl>            <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>channel</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>Selector</span> <span class=n>sele</span> <span class=n>ctor</span> <span class=o>=</span> <span class=n>Selector</span><span class=o>.</span><span class=na>open</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>channel</span><span class=o>.</span><span class=na>configureBlocking</span><span class=o>(</span><span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>channel</span><span class=o>.</span><span class=na>register</span><span class=o>(</span><span class=n>selector</span><span class=o>,</span> <span class=n>SelectionKey</span><span class=o>.</span><span class=na>OP_ACCEPT</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>while</span> <span class=o>(</span><span class=kc>true</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=kt>int</span> <span class=n>count</span> <span class=o>=</span> <span class=n>selector</span><span class=o>.</span><span class=na>select</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=c1>//                int count = selector.selectNow();
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;select count: {}&#34;</span><span class=o>,</span> <span class=n>count</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=c1>//                if(count &lt;= 0) {
</span></span></span><span class=line><span class=cl><span class=c1>//                    continue;
</span></span></span><span class=line><span class=cl><span class=c1>//                }
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>                <span class=c1>// 获取所有事件
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=c1>// 这里读写sc和连接建立的ssc公用了同一个selectedKeys集合
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>Set</span><span class=o>&lt;</span><span class=n>SelectionKey</span><span class=o>&gt;</span> <span class=n>keys</span> <span class=o>=</span> <span class=n>selector</span><span class=o>.</span><span class=na>selectedKeys</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=c1>// 遍历所有事件，逐一处理
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>Iterator</span><span class=o>&lt;</span><span class=n>SelectionKey</span><span class=o>&gt;</span> <span class=n>iter</span> <span class=o>=</span> <span class=n>keys</span><span class=o>.</span><span class=na>iterator</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=k>while</span> <span class=o>(</span><span class=n>iter</span><span class=o>.</span><span class=na>hasNext</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>SelectionKey</span> <span class=n>key</span> <span class=o>=</span> <span class=n>iter</span><span class=o>.</span><span class=na>next</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                    <span class=c1>// 判断事件类型
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=k>if</span> <span class=o>(</span><span class=n>key</span><span class=o>.</span><span class=na>isAcceptable</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=n>ServerSocketChannel</span> <span class=n>c</span> <span class=o>=</span> <span class=o>(</span><span class=n>ServerSocketChannel</span><span class=o>)</span> <span class=n>key</span><span class=o>.</span><span class=na>channel</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                        <span class=c1>// 必须处理
</span></span></span><span class=line><span class=cl><span class=c1></span>                        <span class=n>SocketChannel</span> <span class=n>sc</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=na>accept</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                        <span class=n>sc</span><span class=o>.</span><span class=na>configureBlocking</span><span class=o>(</span><span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                        <span class=c1>// 和连接建立部分共用同一个selector
</span></span></span><span class=line><span class=cl><span class=c1></span>                        <span class=c1>// 现在selector会同时被 OP_ACCEPT和OP_READ触发
</span></span></span><span class=line><span class=cl><span class=c1></span>                        <span class=n>sc</span><span class=o>.</span><span class=na>register</span><span class=o>(</span><span class=n>selector</span><span class=o>,</span> <span class=n>SelectionKey</span><span class=o>.</span><span class=na>OP_READ</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                        <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;连接已建立: {}&#34;</span><span class=o>,</span> <span class=n>sc</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>key</span><span class=o>.</span><span class=na>isReadable</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=n>SocketChannel</span> <span class=n>sc</span> <span class=o>=</span> <span class=o>(</span><span class=n>SocketChannel</span><span class=o>)</span> <span class=n>key</span><span class=o>.</span><span class=na>channel</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                        <span class=n>ByteBuffer</span> <span class=n>buffer</span> <span class=o>=</span> <span class=n>ByteBuffer</span><span class=o>.</span><span class=na>allocate</span><span class=o>(</span><span class=n>128</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                        <span class=kt>int</span> <span class=n>read</span> <span class=o>=</span> <span class=n>sc</span><span class=o>.</span><span class=na>read</span><span class=o>(</span><span class=n>buffer</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                        <span class=k>if</span><span class=o>(</span><span class=n>read</span> <span class=o>==</span> <span class=o>-</span><span class=n>1</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                            <span class=n>key</span><span class=o>.</span><span class=na>cancel</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                            <span class=n>sc</span><span class=o>.</span><span class=na>close</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                        <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                            <span class=n>buffer</span><span class=o>.</span><span class=na>flip</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                            <span class=n>debug</span><span class=o>(</span><span class=n>buffer</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                        <span class=o>}</span>
</span></span><span class=line><span class=cl>                    <span class=o>}</span>
</span></span><span class=line><span class=cl>                    <span class=c1>// 处理完毕，必须将事件移除
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=n>iter</span><span class=o>.</span><span class=na>remove</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>开启两个客户端，修改一下发送文字，输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-58-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-58-1> 1</a>
</span><span class=lnt id=hl-58-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-58-2> 2</a>
</span><span class=lnt id=hl-58-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-58-3> 3</a>
</span><span class=lnt id=hl-58-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-58-4> 4</a>
</span><span class=lnt id=hl-58-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-58-5> 5</a>
</span><span class=lnt id=hl-58-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-58-6> 6</a>
</span><span class=lnt id=hl-58-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-58-7> 7</a>
</span><span class=lnt id=hl-58-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-58-8> 8</a>
</span><span class=lnt id=hl-58-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-58-9> 9</a>
</span><span class=lnt id=hl-58-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-58-10>10</a>
</span><span class=lnt id=hl-58-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-58-11>11</a>
</span><span class=lnt id=hl-58-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-58-12>12</a>
</span><span class=lnt id=hl-58-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-58-13>13</a>
</span><span class=lnt id=hl-58-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-58-14>14</a>
</span><span class=lnt id=hl-58-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-58-15>15</a>
</span><span class=lnt id=hl-58-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-58-16>16</a>
</span><span class=lnt id=hl-58-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-58-17>17</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>sun.nio.ch.ServerSocketChannelImpl[/0:0:0:0:0:0:0:0:8080]
</span></span><span class=line><span class=cl>21:16:39 [DEBUG] [main] c.i.n.ChannelDemo6 - select count: 1
</span></span><span class=line><span class=cl>21:16:39 [DEBUG] [main] c.i.n.ChannelDemo6 - 连接已建立: java.nio.channels.SocketChannel[connected local=/127.0.0.1:8080 remote=/127.0.0.1:60367]
</span></span><span class=line><span class=cl>21:16:39 [DEBUG] [main] c.i.n.ChannelDemo6 - select count: 1
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 68 65 6c 6c 6f                                  |hello           |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>21:16:59 [DEBUG] [main] c.i.n.ChannelDemo6 - select count: 1
</span></span><span class=line><span class=cl>21:16:59 [DEBUG] [main] c.i.n.ChannelDemo6 - 连接已建立: java.nio.channels.SocketChannel[connected local=/127.0.0.1:8080 remote=/127.0.0.1:60378]
</span></span><span class=line><span class=cl>21:16:59 [DEBUG] [main] c.i.n.ChannelDemo6 - select count: 1
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 77 6f 72 6c 64                                  |world           |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span></code></pre></td></tr></table></div></div><a href=#-为何要-iterremove><h4 id=-为何要-iterremove><span class=hanchor arialabel=Anchor># </span>💡 为何要 iter.remove()</h4></a><blockquote><p>客户端断开连接会触发一次read事件。</p></blockquote><blockquote><p>因为 select 在事件发生后，就会将相关的 key 放入 selectedKeys 集合，但不会在处理完后从 selectedKeys 集合中移除，需要我们自己编码删除。例如</p><ul><li>第一次触发了 ssckey 上的 accept 事件，没有移除 ssckey</li><li>第二次触发了 sckey 上的 read 事件，但这时 selectedKeys 中还有上次的 ssckey ，在处理时因为没有真正的 serverSocket 连上了，就会导致空指针异常</li></ul></blockquote><p><img src=/z-oblib/z2-attachments/59d24a4ab1f1de94f7fb23f9530238a1.png width=auto></p><p>selectedKeys 集合就是绿框，有新事件发生就会把对应的key放进去，事件处理了只会更新key状态，不会自动从集合中删除key。</p><a href=#-cancel-的作用><h4 id=-cancel-的作用><span class=hanchor arialabel=Anchor># </span>💡 cancel 的作用</h4></a><blockquote><p>cancel 会取消注册在 selector 上的 channel，并从 <strong>keys 集合</strong>中删除 key 后续不会再监听事件</p></blockquote><a href=#-不处理边界的问题><h4 id=-不处理边界的问题><span class=hanchor arialabel=Anchor># </span>⚠️ 不处理边界的问题</h4></a><p>以前有同学写过这样的代码，思考注释中两个问题，以 bio 为例，其实 nio 道理是一样的</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-59-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-59-1> 1</a>
</span><span class=lnt id=hl-59-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-59-2> 2</a>
</span><span class=lnt id=hl-59-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-59-3> 3</a>
</span><span class=lnt id=hl-59-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-59-4> 4</a>
</span><span class=lnt id=hl-59-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-59-5> 5</a>
</span><span class=lnt id=hl-59-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-59-6> 6</a>
</span><span class=lnt id=hl-59-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-59-7> 7</a>
</span><span class=lnt id=hl-59-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-59-8> 8</a>
</span><span class=lnt id=hl-59-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-59-9> 9</a>
</span><span class=lnt id=hl-59-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-59-10>10</a>
</span><span class=lnt id=hl-59-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-59-11>11</a>
</span><span class=lnt id=hl-59-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-59-12>12</a>
</span><span class=lnt id=hl-59-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-59-13>13</a>
</span><span class=lnt id=hl-59-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-59-14>14</a>
</span><span class=lnt id=hl-59-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-59-15>15</a>
</span><span class=lnt id=hl-59-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-59-16>16</a>
</span><span class=lnt id=hl-59-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-59-17>17</a>
</span><span class=lnt id=hl-59-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-59-18>18</a>
</span><span class=lnt id=hl-59-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-59-19>19</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>Server</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ServerSocket</span> <span class=n>ss</span><span class=o>=</span><span class=k>new</span> <span class=n>ServerSocket</span><span class=o>(</span><span class=n>9000</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=o>(</span><span class=kc>true</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Socket</span> <span class=n>s</span> <span class=o>=</span> <span class=n>ss</span><span class=o>.</span><span class=na>accept</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>InputStream</span> <span class=n>in</span> <span class=o>=</span> <span class=n>s</span><span class=o>.</span><span class=na>getInputStream</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 这里这么写，有没有问题
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=kt>byte</span><span class=o>[]</span> <span class=n>arr</span> <span class=o>=</span> <span class=k>new</span> <span class=kt>byte</span><span class=o>[</span><span class=n>4</span><span class=o>];</span>
</span></span><span class=line><span class=cl>            <span class=k>while</span><span class=o>(</span><span class=kc>true</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=kt>int</span> <span class=n>read</span> <span class=o>=</span> <span class=n>in</span><span class=o>.</span><span class=na>read</span><span class=o>(</span><span class=n>arr</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 这里这么写，有没有问题
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=k>if</span><span class=o>(</span><span class=n>read</span> <span class=o>==</span> <span class=o>-</span><span class=n>1</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=k>new</span> <span class=n>String</span><span class=o>(</span><span class=n>arr</span><span class=o>,</span> <span class=n>0</span><span class=o>,</span> <span class=n>read</span><span class=o>));</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>客户端</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-60-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-60-1> 1</a>
</span><span class=lnt id=hl-60-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-60-2> 2</a>
</span><span class=lnt id=hl-60-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-60-3> 3</a>
</span><span class=lnt id=hl-60-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-60-4> 4</a>
</span><span class=lnt id=hl-60-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-60-5> 5</a>
</span><span class=lnt id=hl-60-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-60-6> 6</a>
</span><span class=lnt id=hl-60-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-60-7> 7</a>
</span><span class=lnt id=hl-60-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-60-8> 8</a>
</span><span class=lnt id=hl-60-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-60-9> 9</a>
</span><span class=lnt id=hl-60-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-60-10>10</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>Client</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Socket</span> <span class=n>max</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Socket</span><span class=o>(</span><span class=s>&#34;localhost&#34;</span><span class=o>,</span> <span class=n>9000</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>OutputStream</span> <span class=n>out</span> <span class=o>=</span> <span class=n>max</span><span class=o>.</span><span class=na>getOutputStream</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>out</span><span class=o>.</span><span class=na>write</span><span class=o>(</span><span class=s>&#34;hello&#34;</span><span class=o>.</span><span class=na>getBytes</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=n>out</span><span class=o>.</span><span class=na>write</span><span class=o>(</span><span class=s>&#34;world&#34;</span><span class=o>.</span><span class=na>getBytes</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=n>out</span><span class=o>.</span><span class=na>write</span><span class=o>(</span><span class=s>&#34;你好&#34;</span><span class=o>.</span><span class=na>getBytes</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=n>max</span><span class=o>.</span><span class=na>close</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-61-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-61-1>1</a>
</span><span class=lnt id=hl-61-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-61-2>2</a>
</span><span class=lnt id=hl-61-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-61-3>3</a>
</span><span class=lnt id=hl-61-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-61-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>hell
</span></span><span class=line><span class=cl>owor
</span></span><span class=line><span class=cl>ld�
</span></span><span class=line><span class=cl>�好
</span></span></code></pre></td></tr></table></div></div><p>为什么？</p><blockquote><p>一个字符会有多个字节，边界的字符可能不完整。</p></blockquote><a href=#处理消息的边界><h4 id=处理消息的边界><span class=hanchor arialabel=Anchor># </span>处理消息的边界</h4></a><p><img src=/z-oblib/z2-attachments/3b9638a1e23e235165906d2db3fdc238.png width=auto></p><ul><li>一种思路是固定消息长度，数据包大小一样，服务器按预定长度读取，缺点是浪费带宽</li><li>另一种思路是按分隔符拆分，缺点是效率低</li><li>TLV 格式，即 Type 类型、Length 长度、Value 数据，类型和长度已知的情况下，就可以方便获取消息大小，分配合适的 buffer，缺点是 buffer 需要提前分配，如果内容过大，则影响 server 吞吐量<ul><li>Http 1.1 是 TLV 格式</li><li>Http 2.0 是 LTV 格式</li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-62-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-62-1> 1</a>
</span><span class=lnt id=hl-62-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-62-2> 2</a>
</span><span class=lnt id=hl-62-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-62-3> 3</a>
</span><span class=lnt id=hl-62-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-62-4> 4</a>
</span><span class=lnt id=hl-62-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-62-5> 5</a>
</span><span class=lnt id=hl-62-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-62-6> 6</a>
</span><span class=lnt id=hl-62-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-62-7> 7</a>
</span><span class=lnt id=hl-62-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-62-8> 8</a>
</span><span class=lnt id=hl-62-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-62-9> 9</a>
</span><span class=lnt id=hl-62-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-62-10>10</a>
</span><span class=lnt id=hl-62-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-62-11>11</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>sequenceDiagram 
</span></span><span class=line><span class=cl>participant c1 as 客户端1
</span></span><span class=line><span class=cl>participant s as 服务器
</span></span><span class=line><span class=cl>participant b1 as ByteBuffer1
</span></span><span class=line><span class=cl>participant b2 as ByteBuffer2
</span></span><span class=line><span class=cl>c1 -&gt;&gt; s: 发送 01234567890abcdef3333\r
</span></span><span class=line><span class=cl>s -&gt;&gt; b1: 第一次 read 存入 01234567890abcdef
</span></span><span class=line><span class=cl>s -&gt;&gt; b2: 扩容
</span></span><span class=line><span class=cl>b1 -&gt;&gt; b2: 拷贝 01234567890abcdef
</span></span><span class=line><span class=cl>s -&gt;&gt; b2: 第二次 read 存入 3333\r
</span></span><span class=line><span class=cl>b2 -&gt;&gt; b2: 01234567890abcdef3333\r
</span></span></code></pre></td></tr></table></div></div><a href=#服务器端><h5 id=服务器端><span class=hanchor arialabel=Anchor># </span>服务器端</h5></a><p>之前存在的问题：
原来的buffer是try块中的本地变量，虽然buffer不够大不会报错，但是第一次没有读到终止符就不会输出内容，并且本地变量的原因第一次读取的内容也丢失了。</p><p>水平触发保证了buffer不读完不会结束，所以会输出最后的<code>3333\r</code>，但是前面的字符丢失了。</p><p>但是也不能把buffer提到最外面，这样会存在多个channel的并发访问同一个buffer的问题了。</p><p>可以将buffer作为附件关联到selector上。</p><p>判断是否要扩容的方法：
compact会将未读取数据移到buffer开头，将状态转回写模式，并且position会放在剩余数据结尾。
如果position 1== limit 说明compact之前的读未消耗掉任何数据。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-63-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-1> 1</a>
</span><span class=lnt id=hl-63-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-2> 2</a>
</span><span class=lnt id=hl-63-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-3> 3</a>
</span><span class=lnt id=hl-63-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-4> 4</a>
</span><span class=lnt id=hl-63-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-5> 5</a>
</span><span class=lnt id=hl-63-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-6> 6</a>
</span><span class=lnt id=hl-63-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-7> 7</a>
</span><span class=lnt id=hl-63-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-8> 8</a>
</span><span class=lnt id=hl-63-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-9> 9</a>
</span><span class=lnt id=hl-63-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-10>10</a>
</span><span class=lnt id=hl-63-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-11>11</a>
</span><span class=lnt id=hl-63-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-12>12</a>
</span><span class=lnt id=hl-63-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-13>13</a>
</span><span class=lnt id=hl-63-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-14>14</a>
</span><span class=lnt id=hl-63-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-15>15</a>
</span><span class=lnt id=hl-63-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-16>16</a>
</span><span class=lnt id=hl-63-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-17>17</a>
</span><span class=lnt id=hl-63-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-18>18</a>
</span><span class=lnt id=hl-63-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-19>19</a>
</span><span class=lnt id=hl-63-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-20>20</a>
</span><span class=lnt id=hl-63-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-21>21</a>
</span><span class=lnt id=hl-63-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-22>22</a>
</span><span class=lnt id=hl-63-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-23>23</a>
</span><span class=lnt id=hl-63-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-24>24</a>
</span><span class=lnt id=hl-63-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-25>25</a>
</span><span class=lnt id=hl-63-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-26>26</a>
</span><span class=lnt id=hl-63-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-27>27</a>
</span><span class=lnt id=hl-63-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-28>28</a>
</span><span class=lnt id=hl-63-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-29>29</a>
</span><span class=lnt id=hl-63-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-30>30</a>
</span><span class=lnt id=hl-63-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-31>31</a>
</span><span class=lnt id=hl-63-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-32>32</a>
</span><span class=lnt id=hl-63-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-33>33</a>
</span><span class=lnt id=hl-63-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-34>34</a>
</span><span class=lnt id=hl-63-35><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-35>35</a>
</span><span class=lnt id=hl-63-36><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-36>36</a>
</span><span class=lnt id=hl-63-37><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-37>37</a>
</span><span class=lnt id=hl-63-38><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-38>38</a>
</span><span class=lnt id=hl-63-39><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-39>39</a>
</span><span class=lnt id=hl-63-40><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-40>40</a>
</span><span class=lnt id=hl-63-41><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-41>41</a>
</span><span class=lnt id=hl-63-42><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-42>42</a>
</span><span class=lnt id=hl-63-43><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-43>43</a>
</span><span class=lnt id=hl-63-44><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-44>44</a>
</span><span class=lnt id=hl-63-45><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-45>45</a>
</span><span class=lnt id=hl-63-46><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-46>46</a>
</span><span class=lnt id=hl-63-47><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-47>47</a>
</span><span class=lnt id=hl-63-48><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-48>48</a>
</span><span class=lnt id=hl-63-49><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-49>49</a>
</span><span class=lnt id=hl-63-50><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-50>50</a>
</span><span class=lnt id=hl-63-51><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-51>51</a>
</span><span class=lnt id=hl-63-52><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-52>52</a>
</span><span class=lnt id=hl-63-53><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-53>53</a>
</span><span class=lnt id=hl-63-54><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-54>54</a>
</span><span class=lnt id=hl-63-55><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-55>55</a>
</span><span class=lnt id=hl-63-56><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-56>56</a>
</span><span class=lnt id=hl-63-57><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-57>57</a>
</span><span class=lnt id=hl-63-58><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-58>58</a>
</span><span class=lnt id=hl-63-59><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-59>59</a>
</span><span class=lnt id=hl-63-60><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-60>60</a>
</span><span class=lnt id=hl-63-61><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-61>61</a>
</span><span class=lnt id=hl-63-62><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-62>62</a>
</span><span class=lnt id=hl-63-63><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-63>63</a>
</span><span class=lnt id=hl-63-64><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-64>64</a>
</span><span class=lnt id=hl-63-65><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-65>65</a>
</span><span class=lnt id=hl-63-66><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-66>66</a>
</span><span class=lnt id=hl-63-67><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-67>67</a>
</span><span class=lnt id=hl-63-68><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-68>68</a>
</span><span class=lnt id=hl-63-69><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-69>69</a>
</span><span class=lnt id=hl-63-70><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-70>70</a>
</span><span class=lnt id=hl-63-71><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-71>71</a>
</span><span class=lnt id=hl-63-72><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-72>72</a>
</span><span class=lnt id=hl-63-73><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-73>73</a>
</span><span class=lnt id=hl-63-74><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-74>74</a>
</span><span class=lnt id=hl-63-75><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-75>75</a>
</span><span class=lnt id=hl-63-76><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-76>76</a>
</span><span class=lnt id=hl-63-77><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-77>77</a>
</span><span class=lnt id=hl-63-78><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-78>78</a>
</span><span class=lnt id=hl-63-79><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-79>79</a>
</span><span class=lnt id=hl-63-80><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-80>80</a>
</span><span class=lnt id=hl-63-81><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-81>81</a>
</span><span class=lnt id=hl-63-82><a style=outline:none;text-decoration:none;color:inherit href=#hl-63-82>82</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>split</span><span class=o>(</span><span class=n>ByteBuffer</span> <span class=n>source</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>source</span><span class=o>.</span><span class=na>flip</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>source</span><span class=o>.</span><span class=na>limit</span><span class=o>();</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 找到一条完整消息
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=o>(</span><span class=n>source</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>i</span><span class=o>)</span> <span class=o>==</span> <span class=sc>&#39;\n&#39;</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=kt>int</span> <span class=n>length</span> <span class=o>=</span> <span class=n>i</span> <span class=o>+</span> <span class=n>1</span> <span class=o>-</span> <span class=n>source</span><span class=o>.</span><span class=na>position</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 把这条完整消息存入新的 ByteBuffer
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>ByteBuffer</span> <span class=n>target</span> <span class=o>=</span> <span class=n>ByteBuffer</span><span class=o>.</span><span class=na>allocate</span><span class=o>(</span><span class=n>length</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 从 source 读，向 target 写
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>j</span> <span class=o>&lt;</span> <span class=n>length</span><span class=o>;</span> <span class=n>j</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>target</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>source</span><span class=o>.</span><span class=na>get</span><span class=o>());</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=n>debugAll</span><span class=o>(</span><span class=n>target</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=n>source</span><span class=o>.</span><span class=na>compact</span><span class=o>();</span> <span class=c1>// 0123456789abcdef  position 16 limit 16
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 1. 创建 selector, 管理多个 channel
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>Selector</span> <span class=n>selector</span> <span class=o>=</span> <span class=n>Selector</span><span class=o>.</span><span class=na>open</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>ServerSocketChannel</span> <span class=n>ssc</span> <span class=o>=</span> <span class=n>ServerSocketChannel</span><span class=o>.</span><span class=na>open</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>ssc</span><span class=o>.</span><span class=na>configureBlocking</span><span class=o>(</span><span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 2. 建立 selector 和 channel 的联系（注册）
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// SelectionKey 就是将来事件发生后，通过它可以知道事件和哪个channel的事件
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>SelectionKey</span> <span class=n>sscKey</span> <span class=o>=</span> <span class=n>ssc</span><span class=o>.</span><span class=na>register</span><span class=o>(</span><span class=n>selector</span><span class=o>,</span> <span class=n>0</span><span class=o>,</span> <span class=kc>null</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// key 只关注 accept 事件
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>sscKey</span><span class=o>.</span><span class=na>interestOps</span><span class=o>(</span><span class=n>SelectionKey</span><span class=o>.</span><span class=na>OP_ACCEPT</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;sscKey:{}&#34;</span><span class=o>,</span> <span class=n>sscKey</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>ssc</span><span class=o>.</span><span class=na>bind</span><span class=o>(</span><span class=k>new</span> <span class=n>InetSocketAddress</span><span class=o>(</span><span class=n>8080</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=o>(</span><span class=kc>true</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 3. select 方法, 没有事件发生，线程阻塞，有事件，线程才会恢复运行
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// select 在事件未处理时，它不会阻塞, 事件发生后要么处理，要么取消，不能置之不理
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>selector</span><span class=o>.</span><span class=na>select</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 4. 处理事件, selectedKeys 内部包含了所有发生的事件
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>Iterator</span><span class=o>&lt;</span><span class=n>SelectionKey</span><span class=o>&gt;</span> <span class=n>iter</span> <span class=o>=</span> <span class=n>selector</span><span class=o>.</span><span class=na>selectedKeys</span><span class=o>().</span><span class=na>iterator</span><span class=o>();</span> <span class=c1>// accept, read
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>while</span> <span class=o>(</span><span class=n>iter</span><span class=o>.</span><span class=na>hasNext</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>SelectionKey</span> <span class=n>key</span> <span class=o>=</span> <span class=n>iter</span><span class=o>.</span><span class=na>next</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 处理key 时，要从 selectedKeys 集合中删除，否则下次处理就会有问题
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>iter</span><span class=o>.</span><span class=na>remove</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;key: {}&#34;</span><span class=o>,</span> <span class=n>key</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 5. 区分事件类型
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>if</span> <span class=o>(</span><span class=n>key</span><span class=o>.</span><span class=na>isAcceptable</span><span class=o>())</span> <span class=o>{</span> <span class=c1>// 如果是 accept
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>ServerSocketChannel</span> <span class=n>channel</span> <span class=o>=</span> <span class=o>(</span><span class=n>ServerSocketChannel</span><span class=o>)</span> <span class=n>key</span><span class=o>.</span><span class=na>channel</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=n>SocketChannel</span> <span class=n>sc</span> <span class=o>=</span> <span class=n>channel</span><span class=o>.</span><span class=na>accept</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=n>sc</span><span class=o>.</span><span class=na>configureBlocking</span><span class=o>(</span><span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 一个服务端--客户端连接对应一个buffer
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=c1>// 用户这个连接接下来发生的若干次读写
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>ByteBuffer</span> <span class=n>buffer</span> <span class=o>=</span> <span class=n>ByteBuffer</span><span class=o>.</span><span class=na>allocate</span><span class=o>(</span><span class=n>16</span><span class=o>);</span> <span class=c1>// attachment
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=c1>// 将一个 byteBuffer 作为附件关联到 selectionKey 上
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>SelectionKey</span> <span class=n>scKey</span> <span class=o>=</span> <span class=n>sc</span><span class=o>.</span><span class=na>register</span><span class=o>(</span><span class=n>selector</span><span class=o>,</span> <span class=n>0</span><span class=o>,</span> <span class=n>buffer</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=n>scKey</span><span class=o>.</span><span class=na>interestOps</span><span class=o>(</span><span class=n>SelectionKey</span><span class=o>.</span><span class=na>OP_READ</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;{}&#34;</span><span class=o>,</span> <span class=n>sc</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;scKey:{}&#34;</span><span class=o>,</span> <span class=n>scKey</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>key</span><span class=o>.</span><span class=na>isReadable</span><span class=o>())</span> <span class=o>{</span> <span class=c1>// 如果是 read
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>SocketChannel</span> <span class=n>channel</span> <span class=o>=</span> <span class=o>(</span><span class=n>SocketChannel</span><span class=o>)</span> <span class=n>key</span><span class=o>.</span><span class=na>channel</span><span class=o>();</span> <span class=c1>// 拿到触发事件的channel
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=c1>// 获取 selectionKey 上关联的附件
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=c1>// 注意类型转换
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=n>ByteBuffer</span> <span class=n>buffer</span> <span class=o>=</span> <span class=o>(</span><span class=n>ByteBuffer</span><span class=o>)</span> <span class=n>key</span><span class=o>.</span><span class=na>attachment</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                    <span class=kt>int</span> <span class=n>read</span> <span class=o>=</span> <span class=n>channel</span><span class=o>.</span><span class=na>read</span><span class=o>(</span><span class=n>buffer</span><span class=o>);</span> <span class=c1>// 如果是正常断开，read 的方法的返回值是 -1
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=k>if</span><span class=o>(</span><span class=n>read</span> <span class=o>==</span> <span class=o>-</span><span class=n>1</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=n>key</span><span class=o>.</span><span class=na>cancel</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=n>split</span><span class=o>(</span><span class=n>buffer</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                        <span class=c1>// 需要扩容
</span></span></span><span class=line><span class=cl><span class=c1></span>                        <span class=k>if</span> <span class=o>(</span><span class=n>buffer</span><span class=o>.</span><span class=na>position</span><span class=o>()</span> <span class=o>==</span> <span class=n>buffer</span><span class=o>.</span><span class=na>limit</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                            <span class=n>ByteBuffer</span> <span class=n>newBuffer</span> <span class=o>=</span> <span class=n>ByteBuffer</span><span class=o>.</span><span class=na>allocate</span><span class=o>(</span><span class=n>buffer</span><span class=o>.</span><span class=na>capacity</span><span class=o>()</span> <span class=o>*</span> <span class=n>2</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                            <span class=n>buffer</span><span class=o>.</span><span class=na>flip</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                            <span class=n>newBuffer</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>buffer</span><span class=o>);</span> <span class=c1>// 0123456789abcdef3333\n
</span></span></span><span class=line><span class=cl><span class=c1></span>                            <span class=n>key</span><span class=o>.</span><span class=na>attach</span><span class=o>(</span><span class=n>newBuffer</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                        <span class=o>}</span>
</span></span><span class=line><span class=cl>                    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                    <span class=n>key</span><span class=o>.</span><span class=na>cancel</span><span class=o>();</span>  <span class=c1>// 因为客户端断开了,因此需要将 key 取消（从 selector 的 keys 集合中真正删除 key）
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#客户端><h5 id=客户端><span class=hanchor arialabel=Anchor># </span>客户端</h5></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-64-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-64-1>1</a>
</span><span class=lnt id=hl-64-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-64-2>2</a>
</span><span class=lnt id=hl-64-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-64-3>3</a>
</span><span class=lnt id=hl-64-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-64-4>4</a>
</span><span class=lnt id=hl-64-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-64-5>5</a>
</span><span class=lnt id=hl-64-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-64-6>6</a>
</span><span class=lnt id=hl-64-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-64-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>SocketChannel</span> <span class=n>sc</span> <span class=o>=</span> <span class=n>SocketChannel</span><span class=o>.</span><span class=na>open</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=n>sc</span><span class=o>.</span><span class=na>connect</span><span class=o>(</span><span class=k>new</span> <span class=n>InetSocketAddress</span><span class=o>(</span><span class=s>&#34;localhost&#34;</span><span class=o>,</span> <span class=n>8080</span><span class=o>));</span>
</span></span><span class=line><span class=cl><span class=n>SocketAddress</span> <span class=n>address</span> <span class=o>=</span> <span class=n>sc</span><span class=o>.</span><span class=na>getLocalAddress</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=c1>// sc.write(Charset.defaultCharset().encode(&#34;hello\nworld\n&#34;));
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>sc</span><span class=o>.</span><span class=na>write</span><span class=o>(</span><span class=n>Charset</span><span class=o>.</span><span class=na>defaultCharset</span><span class=o>().</span><span class=na>encode</span><span class=o>(</span><span class=s>&#34;0123\n456789abcdef&#34;</span><span class=o>));</span>
</span></span><span class=line><span class=cl><span class=n>sc</span><span class=o>.</span><span class=na>write</span><span class=o>(</span><span class=n>Charset</span><span class=o>.</span><span class=na>defaultCharset</span><span class=o>().</span><span class=na>encode</span><span class=o>(</span><span class=s>&#34;0123456789abcdef3333\n&#34;</span><span class=o>));</span>
</span></span><span class=line><span class=cl><span class=n>System</span><span class=o>.</span><span class=na>in</span><span class=o>.</span><span class=na>read</span><span class=o>();</span>
</span></span></code></pre></td></tr></table></div></div><a href=#bytebuffer-大小分配><h4 id=bytebuffer-大小分配><span class=hanchor arialabel=Anchor># </span>ByteBuffer 大小分配</h4></a><ul><li>每个 channel 都需要记录可能被切分的消息，因为 ByteBuffer <strong>不能</strong>被多个 channel 共同使用，因此需要为每个 channel 维护一个独立的 ByteBuffer</li><li>ByteBuffer <strong>不能</strong>太大，比如一个 ByteBuffer 1Mb 的话，要支持百万连接就要 1Tb 内存，因此需要设计大小可变的 ByteBuffer<ul><li>一种思路是首先分配一个较小的 buffer，例如 4k，如果发现数据不够，再分配 8k 的 buffer，将 4k buffer 内容拷贝至 8k buffer，优点是消息连续容易处理，缺点是<strong>数据拷贝</strong>耗费性能，参考实现
<a href=http://tutorials.jenkov.com/java-performance/resizable-array.html rel=noopener>http://tutorials.jenkov.com/java-performance/resizable-array.html</a></li><li>另一种思路是用多个数组组成 buffer，一个数组不够，把多出来的内容写入新的数组，与前面的区别是消息存储不连续<strong>解析复杂</strong>，优点是避免了拷贝引起的性能损耗</li></ul></li></ul><a href=#45-处理-write-事件><h3 id=45-处理-write-事件><span class=hanchor arialabel=Anchor># </span>4.5 处理 write 事件</h3></a><a href=#一次无法写完例子><h4 id=一次无法写完例子><span class=hanchor arialabel=Anchor># </span>一次无法写完例子</h4></a><ul><li>非阻塞模式下，无法保证把 buffer 中所有数据都写入 channel，因此需要追踪 write 方法的返回值（代表实际写入字节数）</li><li>用 selector 监听所有 channel 的可写事件，每个 channel 都需要一个 key 来跟踪 buffer，但这样又会导致占用内存过多，就有两阶段策略<ul><li>当消息处理器第一次写入消息时，才将 channel 注册到 selector 上</li><li>selector 检查 channel 上的可写事件，如果所有的数据写完了，就取消 channel 的注册</li><li>如果不取消，会每次可写均会触发 write 事件</li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-65-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-65-1> 1</a>
</span><span class=lnt id=hl-65-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-65-2> 2</a>
</span><span class=lnt id=hl-65-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-65-3> 3</a>
</span><span class=lnt id=hl-65-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-65-4> 4</a>
</span><span class=lnt id=hl-65-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-65-5> 5</a>
</span><span class=lnt id=hl-65-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-65-6> 6</a>
</span><span class=lnt id=hl-65-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-65-7> 7</a>
</span><span class=lnt id=hl-65-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-65-8> 8</a>
</span><span class=lnt id=hl-65-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-65-9> 9</a>
</span><span class=lnt id=hl-65-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-65-10>10</a>
</span><span class=lnt id=hl-65-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-65-11>11</a>
</span><span class=lnt id=hl-65-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-65-12>12</a>
</span><span class=lnt id=hl-65-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-65-13>13</a>
</span><span class=lnt id=hl-65-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-65-14>14</a>
</span><span class=lnt id=hl-65-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-65-15>15</a>
</span><span class=lnt id=hl-65-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-65-16>16</a>
</span><span class=lnt id=hl-65-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-65-17>17</a>
</span><span class=lnt id=hl-65-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-65-18>18</a>
</span><span class=lnt id=hl-65-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-65-19>19</a>
</span><span class=lnt id=hl-65-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-65-20>20</a>
</span><span class=lnt id=hl-65-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-65-21>21</a>
</span><span class=lnt id=hl-65-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-65-22>22</a>
</span><span class=lnt id=hl-65-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-65-23>23</a>
</span><span class=lnt id=hl-65-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-65-24>24</a>
</span><span class=lnt id=hl-65-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-65-25>25</a>
</span><span class=lnt id=hl-65-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-65-26>26</a>
</span><span class=lnt id=hl-65-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-65-27>27</a>
</span><span class=lnt id=hl-65-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-65-28>28</a>
</span><span class=lnt id=hl-65-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-65-29>29</a>
</span><span class=lnt id=hl-65-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-65-30>30</a>
</span><span class=lnt id=hl-65-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-65-31>31</a>
</span><span class=lnt id=hl-65-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-65-32>32</a>
</span><span class=lnt id=hl-65-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-65-33>33</a>
</span><span class=lnt id=hl-65-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-65-34>34</a>
</span><span class=lnt id=hl-65-35><a style=outline:none;text-decoration:none;color:inherit href=#hl-65-35>35</a>
</span><span class=lnt id=hl-65-36><a style=outline:none;text-decoration:none;color:inherit href=#hl-65-36>36</a>
</span><span class=lnt id=hl-65-37><a style=outline:none;text-decoration:none;color:inherit href=#hl-65-37>37</a>
</span><span class=lnt id=hl-65-38><a style=outline:none;text-decoration:none;color:inherit href=#hl-65-38>38</a>
</span><span class=lnt id=hl-65-39><a style=outline:none;text-decoration:none;color:inherit href=#hl-65-39>39</a>
</span><span class=lnt id=hl-65-40><a style=outline:none;text-decoration:none;color:inherit href=#hl-65-40>40</a>
</span><span class=lnt id=hl-65-41><a style=outline:none;text-decoration:none;color:inherit href=#hl-65-41>41</a>
</span><span class=lnt id=hl-65-42><a style=outline:none;text-decoration:none;color:inherit href=#hl-65-42>42</a>
</span><span class=lnt id=hl-65-43><a style=outline:none;text-decoration:none;color:inherit href=#hl-65-43>43</a>
</span><span class=lnt id=hl-65-44><a style=outline:none;text-decoration:none;color:inherit href=#hl-65-44>44</a>
</span><span class=lnt id=hl-65-45><a style=outline:none;text-decoration:none;color:inherit href=#hl-65-45>45</a>
</span><span class=lnt id=hl-65-46><a style=outline:none;text-decoration:none;color:inherit href=#hl-65-46>46</a>
</span><span class=lnt id=hl-65-47><a style=outline:none;text-decoration:none;color:inherit href=#hl-65-47>47</a>
</span><span class=lnt id=hl-65-48><a style=outline:none;text-decoration:none;color:inherit href=#hl-65-48>48</a>
</span><span class=lnt id=hl-65-49><a style=outline:none;text-decoration:none;color:inherit href=#hl-65-49>49</a>
</span><span class=lnt id=hl-65-50><a style=outline:none;text-decoration:none;color:inherit href=#hl-65-50>50</a>
</span><span class=lnt id=hl-65-51><a style=outline:none;text-decoration:none;color:inherit href=#hl-65-51>51</a>
</span><span class=lnt id=hl-65-52><a style=outline:none;text-decoration:none;color:inherit href=#hl-65-52>52</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>WriteServer</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ServerSocketChannel</span> <span class=n>ssc</span> <span class=o>=</span> <span class=n>ServerSocketChannel</span><span class=o>.</span><span class=na>open</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>ssc</span><span class=o>.</span><span class=na>configureBlocking</span><span class=o>(</span><span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>ssc</span><span class=o>.</span><span class=na>bind</span><span class=o>(</span><span class=k>new</span> <span class=n>InetSocketAddress</span><span class=o>(</span><span class=n>8080</span><span class=o>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>Selector</span> <span class=n>selector</span> <span class=o>=</span> <span class=n>Selector</span><span class=o>.</span><span class=na>open</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>ssc</span><span class=o>.</span><span class=na>register</span><span class=o>(</span><span class=n>selector</span><span class=o>,</span> <span class=n>SelectionKey</span><span class=o>.</span><span class=na>OP_ACCEPT</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>while</span><span class=o>(</span><span class=kc>true</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>selector</span><span class=o>.</span><span class=na>select</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>Iterator</span><span class=o>&lt;</span><span class=n>SelectionKey</span><span class=o>&gt;</span> <span class=n>iter</span> <span class=o>=</span> <span class=n>selector</span><span class=o>.</span><span class=na>selectedKeys</span><span class=o>().</span><span class=na>iterator</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=k>while</span> <span class=o>(</span><span class=n>iter</span><span class=o>.</span><span class=na>hasNext</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>SelectionKey</span> <span class=n>key</span> <span class=o>=</span> <span class=n>iter</span><span class=o>.</span><span class=na>next</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=n>iter</span><span class=o>.</span><span class=na>remove</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>key</span><span class=o>.</span><span class=na>isAcceptable</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>SocketChannel</span> <span class=n>sc</span> <span class=o>=</span> <span class=n>ssc</span><span class=o>.</span><span class=na>accept</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                    <span class=n>sc</span><span class=o>.</span><span class=na>configureBlocking</span><span class=o>(</span><span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>SelectionKey</span> <span class=n>sckey</span> <span class=o>=</span> <span class=n>sc</span><span class=o>.</span><span class=na>register</span><span class=o>(</span><span class=n>selector</span><span class=o>,</span> <span class=n>SelectionKey</span><span class=o>.</span><span class=na>OP_READ</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=c1>// 1. 向客户端发送内容
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=n>StringBuilder</span> <span class=n>sb</span> <span class=o>=</span> <span class=k>new</span> <span class=n>StringBuilder</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                    <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>3000000</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=n>sb</span><span class=o>.</span><span class=na>append</span><span class=o>(</span><span class=s>&#34;a&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=o>}</span>
</span></span><span class=line><span class=cl>                    <span class=n>ByteBuffer</span> <span class=n>buffer</span> <span class=o>=</span> <span class=n>Charset</span><span class=o>.</span><span class=na>defaultCharset</span><span class=o>().</span><span class=na>encode</span><span class=o>(</span><span class=n>sb</span><span class=o>.</span><span class=na>toString</span><span class=o>());</span>
</span></span><span class=line><span class=cl>                    <span class=kt>int</span> <span class=n>write</span> <span class=o>=</span> <span class=n>sc</span><span class=o>.</span><span class=na>write</span><span class=o>(</span><span class=n>buffer</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=c1>// 3. write 表示实际写了多少字节
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;实际写入字节:&#34;</span> <span class=o>+</span> <span class=n>write</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=c1>// 4. 如果有剩余未读字节，才需要关注写事件
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=k>if</span> <span class=o>(</span><span class=n>buffer</span><span class=o>.</span><span class=na>hasRemaining</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=c1>// read 1  write 4
</span></span></span><span class=line><span class=cl><span class=c1></span>                        <span class=c1>// 在原有关注事件的基础上，多关注 写事件
</span></span></span><span class=line><span class=cl><span class=c1></span>                        <span class=n>sckey</span><span class=o>.</span><span class=na>interestOps</span><span class=o>(</span><span class=n>sckey</span><span class=o>.</span><span class=na>interestOps</span><span class=o>()</span> <span class=o>+</span> <span class=n>SelectionKey</span><span class=o>.</span><span class=na>OP_WRITE</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                        <span class=c1>// 把 buffer 作为附件加入 sckey
</span></span></span><span class=line><span class=cl><span class=c1></span>                        <span class=n>sckey</span><span class=o>.</span><span class=na>attach</span><span class=o>(</span><span class=n>buffer</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>key</span><span class=o>.</span><span class=na>isWritable</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>ByteBuffer</span> <span class=n>buffer</span> <span class=o>=</span> <span class=o>(</span><span class=n>ByteBuffer</span><span class=o>)</span> <span class=n>key</span><span class=o>.</span><span class=na>attachment</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                    <span class=n>SocketChannel</span> <span class=n>sc</span> <span class=o>=</span> <span class=o>(</span><span class=n>SocketChannel</span><span class=o>)</span> <span class=n>key</span><span class=o>.</span><span class=na>channel</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                    <span class=kt>int</span> <span class=n>write</span> <span class=o>=</span> <span class=n>sc</span><span class=o>.</span><span class=na>write</span><span class=o>(</span><span class=n>buffer</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;实际写入字节:&#34;</span> <span class=o>+</span> <span class=n>write</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=o>(!</span><span class=n>buffer</span><span class=o>.</span><span class=na>hasRemaining</span><span class=o>())</span> <span class=o>{</span> <span class=c1>// 写完了
</span></span></span><span class=line><span class=cl><span class=c1></span>                        <span class=n>key</span><span class=o>.</span><span class=na>interestOps</span><span class=o>(</span><span class=n>key</span><span class=o>.</span><span class=na>interestOps</span><span class=o>()</span> <span class=o>-</span> <span class=n>SelectionKey</span><span class=o>.</span><span class=na>OP_WRITE</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                        <span class=n>key</span><span class=o>.</span><span class=na>attach</span><span class=o>(</span><span class=kc>null</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>客户端</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-66-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-66-1> 1</a>
</span><span class=lnt id=hl-66-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-66-2> 2</a>
</span><span class=lnt id=hl-66-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-66-3> 3</a>
</span><span class=lnt id=hl-66-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-66-4> 4</a>
</span><span class=lnt id=hl-66-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-66-5> 5</a>
</span><span class=lnt id=hl-66-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-66-6> 6</a>
</span><span class=lnt id=hl-66-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-66-7> 7</a>
</span><span class=lnt id=hl-66-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-66-8> 8</a>
</span><span class=lnt id=hl-66-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-66-9> 9</a>
</span><span class=lnt id=hl-66-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-66-10>10</a>
</span><span class=lnt id=hl-66-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-66-11>11</a>
</span><span class=lnt id=hl-66-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-66-12>12</a>
</span><span class=lnt id=hl-66-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-66-13>13</a>
</span><span class=lnt id=hl-66-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-66-14>14</a>
</span><span class=lnt id=hl-66-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-66-15>15</a>
</span><span class=lnt id=hl-66-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-66-16>16</a>
</span><span class=lnt id=hl-66-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-66-17>17</a>
</span><span class=lnt id=hl-66-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-66-18>18</a>
</span><span class=lnt id=hl-66-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-66-19>19</a>
</span><span class=lnt id=hl-66-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-66-20>20</a>
</span><span class=lnt id=hl-66-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-66-21>21</a>
</span><span class=lnt id=hl-66-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-66-22>22</a>
</span><span class=lnt id=hl-66-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-66-23>23</a>
</span><span class=lnt id=hl-66-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-66-24>24</a>
</span><span class=lnt id=hl-66-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-66-25>25</a>
</span><span class=lnt id=hl-66-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-66-26>26</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>WriteClient</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Selector</span> <span class=n>selector</span> <span class=o>=</span> <span class=n>Selector</span><span class=o>.</span><span class=na>open</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>SocketChannel</span> <span class=n>sc</span> <span class=o>=</span> <span class=n>SocketChannel</span><span class=o>.</span><span class=na>open</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>sc</span><span class=o>.</span><span class=na>configureBlocking</span><span class=o>(</span><span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>sc</span><span class=o>.</span><span class=na>register</span><span class=o>(</span><span class=n>selector</span><span class=o>,</span> <span class=n>SelectionKey</span><span class=o>.</span><span class=na>OP_CONNECT</span> <span class=o>|</span> <span class=n>SelectionKey</span><span class=o>.</span><span class=na>OP_READ</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>sc</span><span class=o>.</span><span class=na>connect</span><span class=o>(</span><span class=k>new</span> <span class=n>InetSocketAddress</span><span class=o>(</span><span class=s>&#34;localhost&#34;</span><span class=o>,</span> <span class=n>8080</span><span class=o>));</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>count</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=o>(</span><span class=kc>true</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>selector</span><span class=o>.</span><span class=na>select</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>Iterator</span><span class=o>&lt;</span><span class=n>SelectionKey</span><span class=o>&gt;</span> <span class=n>iter</span> <span class=o>=</span> <span class=n>selector</span><span class=o>.</span><span class=na>selectedKeys</span><span class=o>().</span><span class=na>iterator</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=k>while</span> <span class=o>(</span><span class=n>iter</span><span class=o>.</span><span class=na>hasNext</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>SelectionKey</span> <span class=n>key</span> <span class=o>=</span> <span class=n>iter</span><span class=o>.</span><span class=na>next</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=n>iter</span><span class=o>.</span><span class=na>remove</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>key</span><span class=o>.</span><span class=na>isConnectable</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>sc</span><span class=o>.</span><span class=na>finishConnect</span><span class=o>());</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>key</span><span class=o>.</span><span class=na>isReadable</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>ByteBuffer</span> <span class=n>buffer</span> <span class=o>=</span> <span class=n>ByteBuffer</span><span class=o>.</span><span class=na>allocate</span><span class=o>(</span><span class=n>1024</span> <span class=o>*</span> <span class=n>1024</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>count</span> <span class=o>+=</span> <span class=n>sc</span><span class=o>.</span><span class=na>read</span><span class=o>(</span><span class=n>buffer</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>buffer</span><span class=o>.</span><span class=na>clear</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>count</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>系统有一块网络数据的缓冲区，如果缓冲区满了，就不能继续写入。如果缓冲区可以继续接入，就会发送一个可写信号。</p></blockquote><a href=#-write-为何要取消><h4 id=-write-为何要取消><span class=hanchor arialabel=Anchor># </span>💡 write 为何要取消</h4></a><p>只要向 channel 发送数据时，socket 缓冲可写，这个事件会频繁触发，因此应当只在 socket 缓冲区写不下时再关注可写事件，数据写完之后再取消关注</p><blockquote><p>可写事件是由本机网络缓冲区触发的，所以要确保自己确实有东西要写入时才响应触发。</p></blockquote><a href=#46-更进一步><h3 id=46-更进一步><span class=hanchor arialabel=Anchor># </span>4.6 更进一步</h3></a><a href=#-利用多线程优化><h4 id=-利用多线程优化><span class=hanchor arialabel=Anchor># </span>💡 利用多线程优化</h4></a><blockquote><p>现在都是多核 cpu，设计时要充分考虑别让 cpu 的力量被白白浪费</p></blockquote><p>前面的代码只有一个选择器，没有充分利用多核 cpu，如何改进呢？</p><p>分两组选择器</p><ul><li>单线程配一个选择器，专门处理 accept 事件</li><li>创建 cpu 核心数的线程，<strong>每个线程配一个选择器</strong>，轮流处理 read 事件</li></ul><p><img src=/z-oblib/z2-attachments/707034e47cc2c8f588567de17b7b86a3.png width=auto></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-67-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-1>  1</a>
</span><span class=lnt id=hl-67-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-2>  2</a>
</span><span class=lnt id=hl-67-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-3>  3</a>
</span><span class=lnt id=hl-67-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-4>  4</a>
</span><span class=lnt id=hl-67-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-5>  5</a>
</span><span class=lnt id=hl-67-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-6>  6</a>
</span><span class=lnt id=hl-67-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-7>  7</a>
</span><span class=lnt id=hl-67-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-8>  8</a>
</span><span class=lnt id=hl-67-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-9>  9</a>
</span><span class=lnt id=hl-67-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-10> 10</a>
</span><span class=lnt id=hl-67-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-11> 11</a>
</span><span class=lnt id=hl-67-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-12> 12</a>
</span><span class=lnt id=hl-67-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-13> 13</a>
</span><span class=lnt id=hl-67-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-14> 14</a>
</span><span class=lnt id=hl-67-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-15> 15</a>
</span><span class=lnt id=hl-67-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-16> 16</a>
</span><span class=lnt id=hl-67-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-17> 17</a>
</span><span class=lnt id=hl-67-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-18> 18</a>
</span><span class=lnt id=hl-67-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-19> 19</a>
</span><span class=lnt id=hl-67-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-20> 20</a>
</span><span class=lnt id=hl-67-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-21> 21</a>
</span><span class=lnt id=hl-67-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-22> 22</a>
</span><span class=lnt id=hl-67-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-23> 23</a>
</span><span class=lnt id=hl-67-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-24> 24</a>
</span><span class=lnt id=hl-67-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-25> 25</a>
</span><span class=lnt id=hl-67-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-26> 26</a>
</span><span class=lnt id=hl-67-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-27> 27</a>
</span><span class=lnt id=hl-67-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-28> 28</a>
</span><span class=lnt id=hl-67-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-29> 29</a>
</span><span class=lnt id=hl-67-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-30> 30</a>
</span><span class=lnt id=hl-67-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-31> 31</a>
</span><span class=lnt id=hl-67-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-32> 32</a>
</span><span class=lnt id=hl-67-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-33> 33</a>
</span><span class=lnt id=hl-67-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-34> 34</a>
</span><span class=lnt id=hl-67-35><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-35> 35</a>
</span><span class=lnt id=hl-67-36><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-36> 36</a>
</span><span class=lnt id=hl-67-37><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-37> 37</a>
</span><span class=lnt id=hl-67-38><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-38> 38</a>
</span><span class=lnt id=hl-67-39><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-39> 39</a>
</span><span class=lnt id=hl-67-40><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-40> 40</a>
</span><span class=lnt id=hl-67-41><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-41> 41</a>
</span><span class=lnt id=hl-67-42><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-42> 42</a>
</span><span class=lnt id=hl-67-43><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-43> 43</a>
</span><span class=lnt id=hl-67-44><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-44> 44</a>
</span><span class=lnt id=hl-67-45><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-45> 45</a>
</span><span class=lnt id=hl-67-46><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-46> 46</a>
</span><span class=lnt id=hl-67-47><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-47> 47</a>
</span><span class=lnt id=hl-67-48><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-48> 48</a>
</span><span class=lnt id=hl-67-49><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-49> 49</a>
</span><span class=lnt id=hl-67-50><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-50> 50</a>
</span><span class=lnt id=hl-67-51><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-51> 51</a>
</span><span class=lnt id=hl-67-52><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-52> 52</a>
</span><span class=lnt id=hl-67-53><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-53> 53</a>
</span><span class=lnt id=hl-67-54><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-54> 54</a>
</span><span class=lnt id=hl-67-55><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-55> 55</a>
</span><span class=lnt id=hl-67-56><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-56> 56</a>
</span><span class=lnt id=hl-67-57><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-57> 57</a>
</span><span class=lnt id=hl-67-58><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-58> 58</a>
</span><span class=lnt id=hl-67-59><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-59> 59</a>
</span><span class=lnt id=hl-67-60><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-60> 60</a>
</span><span class=lnt id=hl-67-61><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-61> 61</a>
</span><span class=lnt id=hl-67-62><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-62> 62</a>
</span><span class=lnt id=hl-67-63><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-63> 63</a>
</span><span class=lnt id=hl-67-64><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-64> 64</a>
</span><span class=lnt id=hl-67-65><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-65> 65</a>
</span><span class=lnt id=hl-67-66><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-66> 66</a>
</span><span class=lnt id=hl-67-67><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-67> 67</a>
</span><span class=lnt id=hl-67-68><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-68> 68</a>
</span><span class=lnt id=hl-67-69><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-69> 69</a>
</span><span class=lnt id=hl-67-70><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-70> 70</a>
</span><span class=lnt id=hl-67-71><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-71> 71</a>
</span><span class=lnt id=hl-67-72><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-72> 72</a>
</span><span class=lnt id=hl-67-73><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-73> 73</a>
</span><span class=lnt id=hl-67-74><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-74> 74</a>
</span><span class=lnt id=hl-67-75><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-75> 75</a>
</span><span class=lnt id=hl-67-76><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-76> 76</a>
</span><span class=lnt id=hl-67-77><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-77> 77</a>
</span><span class=lnt id=hl-67-78><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-78> 78</a>
</span><span class=lnt id=hl-67-79><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-79> 79</a>
</span><span class=lnt id=hl-67-80><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-80> 80</a>
</span><span class=lnt id=hl-67-81><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-81> 81</a>
</span><span class=lnt id=hl-67-82><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-82> 82</a>
</span><span class=lnt id=hl-67-83><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-83> 83</a>
</span><span class=lnt id=hl-67-84><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-84> 84</a>
</span><span class=lnt id=hl-67-85><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-85> 85</a>
</span><span class=lnt id=hl-67-86><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-86> 86</a>
</span><span class=lnt id=hl-67-87><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-87> 87</a>
</span><span class=lnt id=hl-67-88><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-88> 88</a>
</span><span class=lnt id=hl-67-89><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-89> 89</a>
</span><span class=lnt id=hl-67-90><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-90> 90</a>
</span><span class=lnt id=hl-67-91><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-91> 91</a>
</span><span class=lnt id=hl-67-92><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-92> 92</a>
</span><span class=lnt id=hl-67-93><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-93> 93</a>
</span><span class=lnt id=hl-67-94><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-94> 94</a>
</span><span class=lnt id=hl-67-95><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-95> 95</a>
</span><span class=lnt id=hl-67-96><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-96> 96</a>
</span><span class=lnt id=hl-67-97><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-97> 97</a>
</span><span class=lnt id=hl-67-98><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-98> 98</a>
</span><span class=lnt id=hl-67-99><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-99> 99</a>
</span><span class=lnt id=hl-67-100><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-100>100</a>
</span><span class=lnt id=hl-67-101><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-101>101</a>
</span><span class=lnt id=hl-67-102><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-102>102</a>
</span><span class=lnt id=hl-67-103><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-103>103</a>
</span><span class=lnt id=hl-67-104><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-104>104</a>
</span><span class=lnt id=hl-67-105><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-105>105</a>
</span><span class=lnt id=hl-67-106><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-106>106</a>
</span><span class=lnt id=hl-67-107><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-107>107</a>
</span><span class=lnt id=hl-67-108><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-108>108</a>
</span><span class=lnt id=hl-67-109><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-109>109</a>
</span><span class=lnt id=hl-67-110><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-110>110</a>
</span><span class=lnt id=hl-67-111><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-111>111</a>
</span><span class=lnt id=hl-67-112><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-112>112</a>
</span><span class=lnt id=hl-67-113><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-113>113</a>
</span><span class=lnt id=hl-67-114><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-114>114</a>
</span><span class=lnt id=hl-67-115><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-115>115</a>
</span><span class=lnt id=hl-67-116><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-116>116</a>
</span><span class=lnt id=hl-67-117><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-117>117</a>
</span><span class=lnt id=hl-67-118><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-118>118</a>
</span><span class=lnt id=hl-67-119><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-119>119</a>
</span><span class=lnt id=hl-67-120><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-120>120</a>
</span><span class=lnt id=hl-67-121><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-121>121</a>
</span><span class=lnt id=hl-67-122><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-122>122</a>
</span><span class=lnt id=hl-67-123><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-123>123</a>
</span><span class=lnt id=hl-67-124><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-124>124</a>
</span><span class=lnt id=hl-67-125><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-125>125</a>
</span><span class=lnt id=hl-67-126><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-126>126</a>
</span><span class=lnt id=hl-67-127><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-127>127</a>
</span><span class=lnt id=hl-67-128><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-128>128</a>
</span><span class=lnt id=hl-67-129><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-129>129</a>
</span><span class=lnt id=hl-67-130><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-130>130</a>
</span><span class=lnt id=hl-67-131><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-131>131</a>
</span><span class=lnt id=hl-67-132><a style=outline:none;text-decoration:none;color:inherit href=#hl-67-132>132</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>ChannelDemo7</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=n>BossEventLoop</span><span class=o>().</span><span class=na>register</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Slf4j</span>
</span></span><span class=line><span class=cl>    <span class=kd>static</span> <span class=kd>class</span> <span class=nc>BossEventLoop</span> <span class=kd>implements</span> <span class=n>Runnable</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>private</span> <span class=n>Selector</span> <span class=n>boss</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=kd>private</span> <span class=n>WorkerEventLoop</span><span class=o>[]</span> <span class=n>workers</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=kd>private</span> <span class=kd>volatile</span> <span class=kt>boolean</span> <span class=n>start</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>AtomicInteger</span> <span class=n>index</span> <span class=o>=</span> <span class=k>new</span> <span class=n>AtomicInteger</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>register</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(!</span><span class=n>start</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>ServerSocketChannel</span> <span class=n>ssc</span> <span class=o>=</span> <span class=n>ServerSocketChannel</span><span class=o>.</span><span class=na>open</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=n>ssc</span><span class=o>.</span><span class=na>bind</span><span class=o>(</span><span class=k>new</span> <span class=n>InetSocketAddress</span><span class=o>(</span><span class=n>8080</span><span class=o>));</span>
</span></span><span class=line><span class=cl>                <span class=n>ssc</span><span class=o>.</span><span class=na>configureBlocking</span><span class=o>(</span><span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=n>boss</span> <span class=o>=</span> <span class=n>Selector</span><span class=o>.</span><span class=na>open</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=n>SelectionKey</span> <span class=n>ssckey</span> <span class=o>=</span> <span class=n>ssc</span><span class=o>.</span><span class=na>register</span><span class=o>(</span><span class=n>boss</span><span class=o>,</span> <span class=n>0</span><span class=o>,</span> <span class=kc>null</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=n>ssckey</span><span class=o>.</span><span class=na>interestOps</span><span class=o>(</span><span class=n>SelectionKey</span><span class=o>.</span><span class=na>OP_ACCEPT</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=n>workers</span> <span class=o>=</span> <span class=n>initEventLoops</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=k>new</span> <span class=n>Thread</span><span class=o>(</span><span class=k>this</span><span class=o>,</span> <span class=s>&#34;boss&#34;</span><span class=o>).</span><span class=na>start</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;boss start...&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=n>start</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=n>WorkerEventLoop</span><span class=o>[]</span> <span class=nf>initEventLoops</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl><span class=c1>//        EventLoop[] eventLoops = new EventLoop[Runtime.getRuntime().availableProcessors()];
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>WorkerEventLoop</span><span class=o>[]</span> <span class=n>workerEventLoops</span> <span class=o>=</span> <span class=k>new</span> <span class=n>WorkerEventLoop</span><span class=o>[</span><span class=n>2</span><span class=o>];</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>workerEventLoops</span><span class=o>.</span><span class=na>length</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>workerEventLoops</span><span class=o>[</span><span class=n>i</span><span class=o>]</span> <span class=o>=</span> <span class=k>new</span> <span class=n>WorkerEventLoop</span><span class=o>(</span><span class=n>i</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>workerEventLoops</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>while</span> <span class=o>(</span><span class=kc>true</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>boss</span><span class=o>.</span><span class=na>select</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                    <span class=n>Iterator</span><span class=o>&lt;</span><span class=n>SelectionKey</span><span class=o>&gt;</span> <span class=n>iter</span> <span class=o>=</span> <span class=n>boss</span><span class=o>.</span><span class=na>selectedKeys</span><span class=o>().</span><span class=na>iterator</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                    <span class=k>while</span> <span class=o>(</span><span class=n>iter</span><span class=o>.</span><span class=na>hasNext</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=n>SelectionKey</span> <span class=n>key</span> <span class=o>=</span> <span class=n>iter</span><span class=o>.</span><span class=na>next</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                        <span class=n>iter</span><span class=o>.</span><span class=na>remove</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                        <span class=k>if</span> <span class=o>(</span><span class=n>key</span><span class=o>.</span><span class=na>isAcceptable</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                            <span class=n>ServerSocketChannel</span> <span class=n>c</span> <span class=o>=</span> <span class=o>(</span><span class=n>ServerSocketChannel</span><span class=o>)</span> <span class=n>key</span><span class=o>.</span><span class=na>channel</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                            <span class=n>SocketChannel</span> <span class=n>sc</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=na>accept</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                            <span class=n>sc</span><span class=o>.</span><span class=na>configureBlocking</span><span class=o>(</span><span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                            <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;{} connected&#34;</span><span class=o>,</span> <span class=n>sc</span><span class=o>.</span><span class=na>getRemoteAddress</span><span class=o>());</span>
</span></span><span class=line><span class=cl>                            <span class=n>workers</span><span class=o>[</span><span class=n>index</span><span class=o>.</span><span class=na>getAndIncrement</span><span class=o>()</span> <span class=o>%</span> <span class=n>workers</span><span class=o>.</span><span class=na>length</span><span class=o>].</span><span class=na>register</span><span class=o>(</span><span class=n>sc</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                        <span class=o>}</span>
</span></span><span class=line><span class=cl>                    <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Slf4j</span>
</span></span><span class=line><span class=cl>    <span class=kd>static</span> <span class=kd>class</span> <span class=nc>WorkerEventLoop</span> <span class=kd>implements</span> <span class=n>Runnable</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>private</span> <span class=n>Selector</span> <span class=n>worker</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=kd>private</span> <span class=kd>volatile</span> <span class=kt>boolean</span> <span class=n>start</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=kd>private</span> <span class=kt>int</span> <span class=n>index</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kd>private</span> <span class=kd>final</span> <span class=n>ConcurrentLinkedQueue</span><span class=o>&lt;</span><span class=n>Runnable</span><span class=o>&gt;</span> <span class=n>tasks</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ConcurrentLinkedQueue</span><span class=o>&lt;&gt;();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=nf>WorkerEventLoop</span><span class=o>(</span><span class=kt>int</span> <span class=n>index</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>this</span><span class=o>.</span><span class=na>index</span> <span class=o>=</span> <span class=n>index</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>register</span><span class=o>(</span><span class=n>SocketChannel</span> <span class=n>sc</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(!</span><span class=n>start</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>worker</span> <span class=o>=</span> <span class=n>Selector</span><span class=o>.</span><span class=na>open</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=k>new</span> <span class=n>Thread</span><span class=o>(</span><span class=k>this</span><span class=o>,</span> <span class=s>&#34;worker-&#34;</span> <span class=o>+</span> <span class=n>index</span><span class=o>).</span><span class=na>start</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=n>start</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=n>tasks</span><span class=o>.</span><span class=na>add</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>SelectionKey</span> <span class=n>sckey</span> <span class=o>=</span> <span class=n>sc</span><span class=o>.</span><span class=na>register</span><span class=o>(</span><span class=n>worker</span><span class=o>,</span> <span class=n>0</span><span class=o>,</span> <span class=kc>null</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>sckey</span><span class=o>.</span><span class=na>interestOps</span><span class=o>(</span><span class=n>SelectionKey</span><span class=o>.</span><span class=na>OP_READ</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>worker</span><span class=o>.</span><span class=na>selectNow</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>});</span>
</span></span><span class=line><span class=cl>            <span class=n>worker</span><span class=o>.</span><span class=na>wakeup</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>while</span> <span class=o>(</span><span class=kc>true</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>worker</span><span class=o>.</span><span class=na>select</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                    <span class=n>Runnable</span> <span class=n>task</span> <span class=o>=</span> <span class=n>tasks</span><span class=o>.</span><span class=na>poll</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=o>(</span><span class=n>task</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=n>task</span><span class=o>.</span><span class=na>run</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                    <span class=o>}</span>
</span></span><span class=line><span class=cl>                    <span class=n>Set</span><span class=o>&lt;</span><span class=n>SelectionKey</span><span class=o>&gt;</span> <span class=n>keys</span> <span class=o>=</span> <span class=n>worker</span><span class=o>.</span><span class=na>selectedKeys</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                    <span class=n>Iterator</span><span class=o>&lt;</span><span class=n>SelectionKey</span><span class=o>&gt;</span> <span class=n>iter</span> <span class=o>=</span> <span class=n>keys</span><span class=o>.</span><span class=na>iterator</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                    <span class=k>while</span> <span class=o>(</span><span class=n>iter</span><span class=o>.</span><span class=na>hasNext</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=n>SelectionKey</span> <span class=n>key</span> <span class=o>=</span> <span class=n>iter</span><span class=o>.</span><span class=na>next</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                        <span class=k>if</span> <span class=o>(</span><span class=n>key</span><span class=o>.</span><span class=na>isReadable</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                            <span class=n>SocketChannel</span> <span class=n>sc</span> <span class=o>=</span> <span class=o>(</span><span class=n>SocketChannel</span><span class=o>)</span> <span class=n>key</span><span class=o>.</span><span class=na>channel</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                            <span class=n>ByteBuffer</span> <span class=n>buffer</span> <span class=o>=</span> <span class=n>ByteBuffer</span><span class=o>.</span><span class=na>allocate</span><span class=o>(</span><span class=n>128</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                            <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                                <span class=kt>int</span> <span class=n>read</span> <span class=o>=</span> <span class=n>sc</span><span class=o>.</span><span class=na>read</span><span class=o>(</span><span class=n>buffer</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                                <span class=k>if</span> <span class=o>(</span><span class=n>read</span> <span class=o>==</span> <span class=o>-</span><span class=n>1</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                                    <span class=n>key</span><span class=o>.</span><span class=na>cancel</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                                    <span class=n>sc</span><span class=o>.</span><span class=na>close</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                                <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                                    <span class=n>buffer</span><span class=o>.</span><span class=na>flip</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                                    <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;{} message:&#34;</span><span class=o>,</span> <span class=n>sc</span><span class=o>.</span><span class=na>getRemoteAddress</span><span class=o>());</span>
</span></span><span class=line><span class=cl>                                    <span class=n>debugAll</span><span class=o>(</span><span class=n>buffer</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                                <span class=o>}</span>
</span></span><span class=line><span class=cl>                            <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                                <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                                <span class=n>key</span><span class=o>.</span><span class=na>cancel</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                                <span class=n>sc</span><span class=o>.</span><span class=na>close</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                            <span class=o>}</span>
</span></span><span class=line><span class=cl>                        <span class=o>}</span>
</span></span><span class=line><span class=cl>                        <span class=n>iter</span><span class=o>.</span><span class=na>remove</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                    <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#改造成多线程时遇到的问题><h4 id=改造成多线程时遇到的问题><span class=hanchor arialabel=Anchor># </span>改造成多线程时遇到的问题</h4></a><p>worker的选择器注册时机需要注意：
在worker的register代码是这样的：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-68-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-68-1>1</a>
</span><span class=lnt id=hl-68-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-68-2>2</a>
</span><span class=lnt id=hl-68-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-68-3>3</a>
</span><span class=lnt id=hl-68-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-68-4>4</a>
</span><span class=lnt id=hl-68-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-68-5>5</a>
</span><span class=lnt id=hl-68-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-68-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>if</span> <span class=o>(!</span><span class=n>start</span><span class=o>)</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>    <span class=n>selector</span> <span class=o>=</span> <span class=n>Selector</span><span class=o>.</span><span class=na>open</span><span class=o>();</span>  
</span></span><span class=line><span class=cl>    <span class=n>thread</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Thread</span><span class=o>(</span><span class=k>this</span><span class=o>,</span> <span class=n>name</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>    <span class=n>thread</span><span class=o>.</span><span class=na>start</span><span class=o>();</span>  
</span></span><span class=line><span class=cl>    <span class=n>start</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>  
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>而父线程接收到新的连接建立事件后，向worker注册一个选择器，选择器的注册应该发生在<code>selector = Selector.open();</code>之后<code>thread.start();</code>之前。
否则会发生空指针异常或者子线程先行启动阻塞死在run()中的<code>worker.select();</code>上导致选择器永远无法注册成功。</p><p>worker一旦调用了register就会创建一个线程执行run方法，这时线程会阻塞在run中的selector.select方法中，并且此处还在连接建立阶段，没有读写事件发生。
这会导致新的连接建立时，在管理连接建立的线程中无法正常调用<code>sc.register(selector, SelectionKey.OP_READ);</code>绑定sc的选择器，因为此时worker中的选择器已经是阻塞状态。</p><p>解决方法：
让register和select在同一个线程中执行方便控制先后顺序 &ndash;> 将选择器注册动作交给子线程执行 &ndash;> 需要将动作传递给子线程 &ndash;> 用<a href=/2_0_2-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/2_0_2_1_2_0-%E8%BD%AF%E4%BB%B6%E8%AF%AD%E8%A8%80/Java/2-%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/%E7%BA%BF%E7%A8%8B%E9%80%9A%E8%AE%AF rel=noopener class=internal-link data-src=/2_0_2-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/2_0_2_1_2_0-%E8%BD%AF%E4%BB%B6%E8%AF%AD%E8%A8%80/Java/2-%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/%E7%BA%BF%E7%A8%8B%E9%80%9A%E8%AE%AF>线程通讯</a>：
将sc的选择器注册动作包装成任务，通过消息队列传递给worker线程去执行。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-69-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-69-1> 1</a>
</span><span class=lnt id=hl-69-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-69-2> 2</a>
</span><span class=lnt id=hl-69-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-69-3> 3</a>
</span><span class=lnt id=hl-69-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-69-4> 4</a>
</span><span class=lnt id=hl-69-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-69-5> 5</a>
</span><span class=lnt id=hl-69-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-69-6> 6</a>
</span><span class=lnt id=hl-69-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-69-7> 7</a>
</span><span class=lnt id=hl-69-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-69-8> 8</a>
</span><span class=lnt id=hl-69-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-69-9> 9</a>
</span><span class=lnt id=hl-69-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-69-10>10</a>
</span><span class=lnt id=hl-69-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-69-11>11</a>
</span><span class=lnt id=hl-69-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-69-12>12</a>
</span><span class=lnt id=hl-69-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-69-13>13</a>
</span><span class=lnt id=hl-69-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-69-14>14</a>
</span><span class=lnt id=hl-69-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-69-15>15</a>
</span><span class=lnt id=hl-69-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-69-16>16</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>register</span> <span class=o>(</span><span class=n>SocketChannel</span> <span class=n>sc</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(!</span><span class=n>start</span><span class=o>)</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>        <span class=n>selector</span> <span class=o>=</span> <span class=n>Selector</span><span class=o>.</span><span class=na>open</span><span class=o>();</span>  
</span></span><span class=line><span class=cl>        <span class=n>thread</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Thread</span><span class=o>(</span><span class=k>this</span><span class=o>,</span> <span class=n>name</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>        <span class=n>thread</span><span class=o>.</span><span class=na>start</span><span class=o>();</span>  
</span></span><span class=line><span class=cl>        <span class=n>start</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>  
</span></span><span class=line><span class=cl>    <span class=o>}</span>  
</span></span><span class=line><span class=cl>    <span class=n>queue</span><span class=o>.</span><span class=na>add</span><span class=o>(()-&gt;{</span>  
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>            <span class=n>sc</span><span class=o>.</span><span class=na>register</span><span class=o>(</span><span class=n>selector</span><span class=o>,</span> <span class=n>SelectionKey</span><span class=o>.</span><span class=na>OP_READ</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>ClosedChannelException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>  
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>RuntimeException</span><span class=o>(</span><span class=n>e</span><span class=o>);</span>  
</span></span><span class=line><span class=cl>        <span class=o>}</span>  
</span></span><span class=line><span class=cl>    <span class=o>});</span>  
</span></span><span class=line><span class=cl>    <span class=n>selector</span><span class=o>.</span><span class=na>wakeup</span><span class=o>();</span>  
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>上述代码虽然thread实际可能会后于<code>selector.wakeup();</code>启动，但是wakeup有类似park&unpark的提前释放的特性：</p><blockquote><p>wakeup使尚未返回的第一个选择操作立即返回。 如果另一个线程当前在调用select时被阻塞，那么调用将立即返回。如果当前没有进行选择操作，那么这些方法中的一个的<strong>下一次</strong>调用将立即返回</p></blockquote><a href=#-如何拿到-cpu-个数><h4 id=-如何拿到-cpu-个数><span class=hanchor arialabel=Anchor># </span>💡 如何拿到 cpu 个数</h4></a><blockquote><ul><li>Runtime.getRuntime().availableProcessors() 如果工作在 docker 容器下，因为容器不是物理隔离的，会拿到物理 cpu 个数，而不是容器申请时的个数</li><li>这个问题直到 jdk 10 才修复，使用 jvm 参数 UseContainerSupport 配置， 默认开启</li></ul></blockquote><a href=#47-udp><h3 id=47-udp><span class=hanchor arialabel=Anchor># </span>4.7 UDP</h3></a><ul><li>UDP 是无连接的，client 发送数据不会管 server 是否开启</li><li>server 这边的 receive 方法会将接收到的数据存入 byte buffer，但如果数据报文超过 buffer 大小，多出来的数据会被默默<strong>抛弃</strong></li></ul><p>首先启动服务器端</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-70-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-70-1> 1</a>
</span><span class=lnt id=hl-70-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-70-2> 2</a>
</span><span class=lnt id=hl-70-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-70-3> 3</a>
</span><span class=lnt id=hl-70-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-70-4> 4</a>
</span><span class=lnt id=hl-70-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-70-5> 5</a>
</span><span class=lnt id=hl-70-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-70-6> 6</a>
</span><span class=lnt id=hl-70-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-70-7> 7</a>
</span><span class=lnt id=hl-70-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-70-8> 8</a>
</span><span class=lnt id=hl-70-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-70-9> 9</a>
</span><span class=lnt id=hl-70-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-70-10>10</a>
</span><span class=lnt id=hl-70-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-70-11>11</a>
</span><span class=lnt id=hl-70-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-70-12>12</a>
</span><span class=lnt id=hl-70-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-70-13>13</a>
</span><span class=lnt id=hl-70-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-70-14>14</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>UdpServer</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>(</span><span class=n>DatagramChannel</span> <span class=n>channel</span> <span class=o>=</span> <span class=n>DatagramChannel</span><span class=o>.</span><span class=na>open</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>channel</span><span class=o>.</span><span class=na>socket</span><span class=o>().</span><span class=na>bind</span><span class=o>(</span><span class=k>new</span> <span class=n>InetSocketAddress</span><span class=o>(</span><span class=n>9999</span><span class=o>));</span>
</span></span><span class=line><span class=cl>            <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;waiting...&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>ByteBuffer</span> <span class=n>buffer</span> <span class=o>=</span> <span class=n>ByteBuffer</span><span class=o>.</span><span class=na>allocate</span><span class=o>(</span><span class=n>32</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>channel</span><span class=o>.</span><span class=na>receive</span><span class=o>(</span><span class=n>buffer</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>buffer</span><span class=o>.</span><span class=na>flip</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>debug</span><span class=o>(</span><span class=n>buffer</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-71-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-71-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>waiting...
</span></span></code></pre></td></tr></table></div></div><p>运行客户端</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-72-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-72-1> 1</a>
</span><span class=lnt id=hl-72-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-72-2> 2</a>
</span><span class=lnt id=hl-72-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-72-3> 3</a>
</span><span class=lnt id=hl-72-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-72-4> 4</a>
</span><span class=lnt id=hl-72-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-72-5> 5</a>
</span><span class=lnt id=hl-72-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-72-6> 6</a>
</span><span class=lnt id=hl-72-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-72-7> 7</a>
</span><span class=lnt id=hl-72-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-72-8> 8</a>
</span><span class=lnt id=hl-72-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-72-9> 9</a>
</span><span class=lnt id=hl-72-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-72-10>10</a>
</span><span class=lnt id=hl-72-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-72-11>11</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>UdpClient</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>(</span><span class=n>DatagramChannel</span> <span class=n>channel</span> <span class=o>=</span> <span class=n>DatagramChannel</span><span class=o>.</span><span class=na>open</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>ByteBuffer</span> <span class=n>buffer</span> <span class=o>=</span> <span class=n>StandardCharsets</span><span class=o>.</span><span class=na>UTF_8</span><span class=o>.</span><span class=na>encode</span><span class=o>(</span><span class=s>&#34;hello&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>InetSocketAddress</span> <span class=n>address</span> <span class=o>=</span> <span class=k>new</span> <span class=n>InetSocketAddress</span><span class=o>(</span><span class=s>&#34;localhost&#34;</span><span class=o>,</span> <span class=n>9999</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>channel</span><span class=o>.</span><span class=na>send</span><span class=o>(</span><span class=n>buffer</span><span class=o>,</span> <span class=n>address</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Exception</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>接下来服务器端输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-73-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-73-1>1</a>
</span><span class=lnt id=hl-73-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-73-2>2</a>
</span><span class=lnt id=hl-73-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-73-3>3</a>
</span><span class=lnt id=hl-73-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-73-4>4</a>
</span><span class=lnt id=hl-73-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-73-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 68 65 6c 6c 6f                                  |hello           |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span></code></pre></td></tr></table></div></div><a href=#5-nio-vs-bio><h2 id=5-nio-vs-bio><span class=hanchor arialabel=Anchor># </span>5. NIO vs BIO</h2></a><a href=#51-stream-vs-channel><h3 id=51-stream-vs-channel><span class=hanchor arialabel=Anchor># </span>5.1 stream vs channel</h3></a><blockquote><p>stream是更高层抽象的接口，不会去关心系统对IO操作提供的一些缓冲区。</p></blockquote><ul><li>stream 不会自动缓冲数据，channel 会利用系统提供的发送缓冲区、接收缓冲区（更为底层）</li><li>stream 仅支持阻塞 API，channel 同时支持阻塞、非阻塞 API，网络 channel 可配合 selector 实现多路复用</li><li>二者均为<strong>全双工</strong>，即读写可以同时进行</li></ul><a href=#-52-io-模型><h3 id=-52-io-模型><span class=hanchor arialabel=Anchor># </span>💡 5.2 IO 模型</h3></a><p>同步阻塞、同步非阻塞、同步多路复用、异步阻塞（错的没有此情况）、异步非阻塞</p><blockquote><p>异步一定是非阻塞的。</p></blockquote><ul><li>同步：线程<strong>自己</strong>去获取结果（一个线程）</li><li>异步：线程自己不去获取结果，而是由<strong>其它线程</strong>送结果（至少两个线程）</li></ul><p>当调用一次 channel.read 或 stream.read 后，会切换至操作系统内核态来完成真正数据读取，而读取又分为两个阶段，分别为：</p><ul><li>等待数据阶段</li><li>复制数据阶段</li></ul><p><img src=/z-oblib/z2-attachments/9beda40e996875e42ae18f1a4010cb0e.png width=auto></p><a href=#阻塞-io><h4 id=阻塞-io><span class=hanchor arialabel=Anchor># </span>阻塞 IO</h4></a><p><img src=/z-oblib/z2-attachments/d6140fbe21ad3029c901c39fc656c80f.png width=auto></p><a href=#非阻塞-io><h4 id=非阻塞-io><span class=hanchor arialabel=Anchor># </span>非阻塞 IO</h4></a><blockquote><p>只有等待数据阶段是非阻塞的，复制数据阶段还是阻塞的。
等待数据时频繁的用户态内核态切换开销较大。</p></blockquote><p><img src=/z-oblib/z2-attachments/bee47ff0353597736841cb77f39de290.png width=auto></p><a href=#多路复用-1><h4 id=多路复用-1><span class=hanchor arialabel=Anchor># </span>多路复用</h4></a><p><img src=/z-oblib/z2-attachments/92295a6cadbef7f318b447c195cfdaaf.png width=auto></p><a href=#信号驱动><h4 id=信号驱动><span class=hanchor arialabel=Anchor># </span>信号驱动</h4></a><p>不常用。</p><a href=#异步-io><h4 id=异步-io><span class=hanchor arialabel=Anchor># </span>异步 IO</h4></a><p><img src=/z-oblib/z2-attachments/d24fd0f79f08ba57c427e8105d1b723b.png width=auto></p><a href=#阻塞-io-vs-多路复用><h4 id=阻塞-io-vs-多路复用><span class=hanchor arialabel=Anchor># </span>阻塞 IO vs 多路复用</h4></a><p><img src=/z-oblib/z2-attachments/b14515879b743602954685e6403970ad.png width=auto></p><p><img src=/z-oblib/z2-attachments/fe68785fc885d9bbfa4e9fa6a973dbe3.png width=auto></p><blockquote><p>多路复用可以一次返回多个事件：相当于给事件本身加了个缓冲区。
但操作的时候只能线性一个个处理。</p></blockquote><a href=#-参考><h4 id=-参考><span class=hanchor arialabel=Anchor># </span>🔖 参考</h4></a><p>UNIX 网络编程 - 卷 I</p><a href=#53-零拷贝><h3 id=53-零拷贝><span class=hanchor arialabel=Anchor># </span>5.3 零拷贝</h3></a><blockquote><p>0拷贝是指不用拷贝到用户态的java内存，而直接在内核态的操作系统内存之间拷贝。</p></blockquote><a href=#传统-io-问题><h4 id=传统-io-问题><span class=hanchor arialabel=Anchor># </span>传统 IO 问题</h4></a><p>传统的 IO 将一个文件 通过 socket 写出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-74-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-74-1>1</a>
</span><span class=lnt id=hl-74-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-74-2>2</a>
</span><span class=lnt id=hl-74-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-74-3>3</a>
</span><span class=lnt id=hl-74-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-74-4>4</a>
</span><span class=lnt id=hl-74-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-74-5>5</a>
</span><span class=lnt id=hl-74-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-74-6>6</a>
</span><span class=lnt id=hl-74-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-74-7>7</a>
</span><span class=lnt id=hl-74-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-74-8>8</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>File</span> <span class=n>f</span> <span class=o>=</span> <span class=k>new</span> <span class=n>File</span><span class=o>(</span><span class=s>&#34;helloword/data.txt&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>RandomAccessFile</span> <span class=n>file</span> <span class=o>=</span> <span class=k>new</span> <span class=n>RandomAccessFile</span><span class=o>(</span><span class=n>file</span><span class=o>,</span> <span class=s>&#34;r&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>byte</span><span class=o>[]</span> <span class=n>buf</span> <span class=o>=</span> <span class=k>new</span> <span class=kt>byte</span><span class=o>[(</span><span class=kt>int</span><span class=o>)</span><span class=n>f</span><span class=o>.</span><span class=na>length</span><span class=o>()];</span>
</span></span><span class=line><span class=cl><span class=n>file</span><span class=o>.</span><span class=na>read</span><span class=o>(</span><span class=n>buf</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Socket</span> <span class=n>socket</span> <span class=o>=</span> <span class=o>...;</span>
</span></span><span class=line><span class=cl><span class=n>socket</span><span class=o>.</span><span class=na>getOutputStream</span><span class=o>().</span><span class=na>write</span><span class=o>(</span><span class=n>buf</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><p>内部工作流程是这样的：</p><p><img src=/z-oblib/z2-attachments/f89991c08c85fc0760ce56280440b6b6.png width=auto></p><ol><li><p>java 本身并不具备 IO 读写能力，因此 read 方法调用后，要从 java 程序的<strong>用户态</strong>切换至<strong>内核态</strong>，去调用操作系统（Kernel）的读能力，将数据读入<strong>内核缓冲区</strong>。这期间用户线程阻塞，操作系统使用 DMA（Direct Memory Access）来实现文件读，其间也不会使用 cpu</p><blockquote><p>DMA 也可以理解为硬件单元，用来解放 cpu 完成文件 IO</p></blockquote></li><li><p>从<strong>内核态</strong>切换回<strong>用户态</strong>，将数据从<strong>内核缓冲区</strong>读入<strong>用户缓冲区</strong>（即 byte[] buf），这期间 cpu 会参与拷贝，无法利用 DMA</p></li><li><p>调用 write 方法，这时将数据从<strong>用户缓冲区</strong>（byte[] buf）写入 <strong>socket 缓冲区</strong>，cpu 会参与拷贝</p></li><li><p>接下来要向网卡写数据，这项能力 java 又不具备，因此又得从<strong>用户态</strong>切换至<strong>内核态</strong>，调用操作系统的写能力，使用 DMA 将 <strong>socket 缓冲区</strong>的数据写入网卡，不会使用 cpu</p></li></ol><p>可以看到中间环节较多，java 的 IO 实际不是物理设备级别的读写，而是缓存的复制，底层的真正读写是操作系统来完成的</p><ul><li>用户态与内核态的切换发生了 <strong>3</strong> 次，这个操作比较重量级</li><li>数据拷贝了共 <strong>4</strong> 次</li></ul><a href=#nio-优化><h4 id=nio-优化><span class=hanchor arialabel=Anchor># </span>NIO 优化</h4></a><p>通过 DirectByteBuf</p><ul><li>ByteBuffer.allocate(10) HeapByteBuffer 使用的还是 java 内存</li><li>ByteBuffer.allocateDirect(10) DirectByteBuffer 使用的是操作系统内存</li></ul><p><img src=/z-oblib/z2-attachments/c3dd38c405a8e36fc37c50dde0478ed8.png width=auto></p><p>大部分步骤与优化前相同，不再赘述。唯有一点：java 可以<strong>使用 DirectByteBuf 将堆外内存映射到 jvm 内存中来直接访问使用</strong></p><ul><li>这块内存不受 jvm 垃圾回收的影响，因此内存地址固定，有助于 IO 读写</li><li>java 中的 DirectByteBuf 对象仅维护了此内存的虚引用，内存回收分成两步<ul><li>DirectByteBuf 对象被垃圾回收，将虚引用加入引用队列</li><li>通过专门线程访问引用队列，根据虚引用释放堆外内存</li></ul></li><li>减少了一次数据拷贝，用户态与内核态的切换次数没有减少</li></ul><p>进一步优化（底层采用了 linux 2.1 后提供的 sendFile 方法），java 中对应着两个 channel 调用 transferTo/transferFrom 方法拷贝数据</p><p><img src=/z-oblib/z2-attachments/ded2b7613a6a8c4981724457f2157b22.png width=auto></p><ol><li>java 调用 transferTo 方法后，要从 java 程序的<strong>用户态</strong>切换至<strong>内核态</strong>，使用 DMA将数据读入<strong>内核缓冲区</strong>，不会使用 cpu</li><li>数据从<strong>内核缓冲区</strong>传输到 <strong>socket 缓冲区</strong>，cpu 会参与拷贝</li><li>最后使用 DMA 将 <strong>socket 缓冲区</strong>的数据写入网卡，不会使用 cpu</li></ol><p>可以看到</p><ul><li>只发生了一次用户态与内核态的切换</li><li>数据拷贝了 3 次</li></ul><p>进一步优化（linux 2.4）</p><p><img src=/z-oblib/z2-attachments/f6c24eee6470e9511e439a78cbf37a99.png width=auto></p><ol><li>java 调用 transferTo 方法后，要从 java 程序的<strong>用户态</strong>切换至<strong>内核态</strong>，使用 DMA将数据读入<strong>内核缓冲区</strong>，不会使用 cpu</li><li>只会将一些 offset 和 length 信息拷入 <strong>socket 缓冲区</strong>，几乎无消耗</li><li>使用 DMA 将 <strong>内核缓冲区</strong>的数据写入网卡，不会使用 cpu</li></ol><p>整个过程仅只发生了一次用户态与内核态的切换，数据拷贝了 2 次。所谓的【零拷贝】，并不是真正无拷贝，而是在不会拷贝重复数据到 jvm 内存中，零拷贝的优点有</p><a href=#优点><h5 id=优点><span class=hanchor arialabel=Anchor># </span>优点</h5></a><ul><li>更少的用户态与内核态的切换</li><li>不利用 cpu 计算，减少 cpu 缓存伪共享 （使用DMA硬件进行数据传输）</li><li>零拷贝适合<strong>小</strong>文件传输<ul><li>典型的传输例如网卡，发送的数据可能只被读取一次，但是占用了缓冲区的空间。</li></ul></li></ul><a href=#53-aio><h3 id=53-aio><span class=hanchor arialabel=Anchor># </span>5.3 AIO</h3></a><p>AIO（异步IO） 用来解决数据复制阶段的阻塞问题</p><ul><li>同步意味着，在进行读写操作时，线程需要等待结果，还是相当于闲置</li><li>异步意味着，在进行读写操作时，线程不必等待结果，而是将来由操作系统来通过回调方式由另外的线程来获得结果</li></ul><blockquote><p>异步模型需要底层操作系统（Kernel）提供支持</p><ul><li>Windows 系统通过 IOCP 实现了真正的异步 IO</li><li>Linux 系统异步 IO 在 2.6 版本引入，但其底层实现还是用多路复用模拟了异步 IO，性能没有优势</li></ul></blockquote><a href=#文件-aio><h4 id=文件-aio><span class=hanchor arialabel=Anchor># </span>文件 AIO</h4></a><p>先来看看 AsynchronousFileChannel</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-75-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-75-1> 1</a>
</span><span class=lnt id=hl-75-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-75-2> 2</a>
</span><span class=lnt id=hl-75-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-75-3> 3</a>
</span><span class=lnt id=hl-75-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-75-4> 4</a>
</span><span class=lnt id=hl-75-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-75-5> 5</a>
</span><span class=lnt id=hl-75-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-75-6> 6</a>
</span><span class=lnt id=hl-75-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-75-7> 7</a>
</span><span class=lnt id=hl-75-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-75-8> 8</a>
</span><span class=lnt id=hl-75-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-75-9> 9</a>
</span><span class=lnt id=hl-75-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-75-10>10</a>
</span><span class=lnt id=hl-75-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-75-11>11</a>
</span><span class=lnt id=hl-75-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-75-12>12</a>
</span><span class=lnt id=hl-75-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-75-13>13</a>
</span><span class=lnt id=hl-75-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-75-14>14</a>
</span><span class=lnt id=hl-75-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-75-15>15</a>
</span><span class=lnt id=hl-75-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-75-16>16</a>
</span><span class=lnt id=hl-75-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-75-17>17</a>
</span><span class=lnt id=hl-75-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-75-18>18</a>
</span><span class=lnt id=hl-75-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-75-19>19</a>
</span><span class=lnt id=hl-75-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-75-20>20</a>
</span><span class=lnt id=hl-75-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-75-21>21</a>
</span><span class=lnt id=hl-75-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-75-22>22</a>
</span><span class=lnt id=hl-75-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-75-23>23</a>
</span><span class=lnt id=hl-75-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-75-24>24</a>
</span><span class=lnt id=hl-75-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-75-25>25</a>
</span><span class=lnt id=hl-75-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-75-26>26</a>
</span><span class=lnt id=hl-75-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-75-27>27</a>
</span><span class=lnt id=hl-75-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-75-28>28</a>
</span><span class=lnt id=hl-75-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-75-29>29</a>
</span><span class=lnt id=hl-75-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-75-30>30</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>AioDemo1</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>AsynchronousFileChannel</span> <span class=n>s</span> <span class=o>=</span> 
</span></span><span class=line><span class=cl>                <span class=n>AsynchronousFileChannel</span><span class=o>.</span><span class=na>open</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                    <span class=n>Paths</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=s>&#34;1.txt&#34;</span><span class=o>),</span> <span class=n>StandardOpenOption</span><span class=o>.</span><span class=na>READ</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>ByteBuffer</span> <span class=n>buffer</span> <span class=o>=</span> <span class=n>ByteBuffer</span><span class=o>.</span><span class=na>allocate</span><span class=o>(</span><span class=n>2</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;begin...&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>s</span><span class=o>.</span><span class=na>read</span><span class=o>(</span><span class=n>buffer</span><span class=o>,</span> <span class=n>0</span><span class=o>,</span> <span class=kc>null</span><span class=o>,</span> <span class=k>new</span> <span class=n>CompletionHandler</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>,</span> <span class=n>ByteBuffer</span><span class=o>&gt;()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>                <span class=kd>public</span> <span class=kt>void</span> <span class=nf>completed</span><span class=o>(</span><span class=n>Integer</span> <span class=n>result</span><span class=o>,</span> <span class=n>ByteBuffer</span> <span class=n>attachment</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;read completed...{}&#34;</span><span class=o>,</span> <span class=n>result</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>buffer</span><span class=o>.</span><span class=na>flip</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                    <span class=n>debug</span><span class=o>(</span><span class=n>buffer</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>                <span class=kd>public</span> <span class=kt>void</span> <span class=nf>failed</span><span class=o>(</span><span class=n>Throwable</span> <span class=n>exc</span><span class=o>,</span> <span class=n>ByteBuffer</span> <span class=n>attachment</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;read failed...&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;do other things...&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>in</span><span class=o>.</span><span class=na>read</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-76-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-76-1>1</a>
</span><span class=lnt id=hl-76-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-76-2>2</a>
</span><span class=lnt id=hl-76-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-76-3>3</a>
</span><span class=lnt id=hl-76-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-76-4>4</a>
</span><span class=lnt id=hl-76-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-76-5>5</a>
</span><span class=lnt id=hl-76-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-76-6>6</a>
</span><span class=lnt id=hl-76-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-76-7>7</a>
</span><span class=lnt id=hl-76-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-76-8>8</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>13:44:56 [DEBUG] [main] c.i.aio.AioDemo1 - begin...
</span></span><span class=line><span class=cl>13:44:56 [DEBUG] [main] c.i.aio.AioDemo1 - do other things...
</span></span><span class=line><span class=cl>13:44:56 [DEBUG] [Thread-5] c.i.aio.AioDemo1 - read completed...2
</span></span><span class=line><span class=cl>         +-------------------------------------------------+
</span></span><span class=line><span class=cl>         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span><span class=line><span class=cl>|00000000| 61 0d                                           |a.              |
</span></span><span class=line><span class=cl>+--------+-------------------------------------------------+----------------+
</span></span></code></pre></td></tr></table></div></div><p>可以看到</p><ul><li>响应文件读取成功的是另一个线程 Thread-5</li><li>主线程并没有 IO 操作阻塞</li></ul><a href=#-守护线程><h4 id=-守护线程><span class=hanchor arialabel=Anchor># </span>💡 守护线程</h4></a><p>默认文件 AIO 使用的线程都是守护线程，所以最后要执行 <code>System.in.read()</code> 以避免守护线程意外结束</p><a href=#网络-aio><h4 id=网络-aio><span class=hanchor arialabel=Anchor># </span>网络 AIO</h4></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-77-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-1>  1</a>
</span><span class=lnt id=hl-77-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-2>  2</a>
</span><span class=lnt id=hl-77-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-3>  3</a>
</span><span class=lnt id=hl-77-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-4>  4</a>
</span><span class=lnt id=hl-77-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-5>  5</a>
</span><span class=lnt id=hl-77-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-6>  6</a>
</span><span class=lnt id=hl-77-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-7>  7</a>
</span><span class=lnt id=hl-77-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-8>  8</a>
</span><span class=lnt id=hl-77-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-9>  9</a>
</span><span class=lnt id=hl-77-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-10> 10</a>
</span><span class=lnt id=hl-77-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-11> 11</a>
</span><span class=lnt id=hl-77-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-12> 12</a>
</span><span class=lnt id=hl-77-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-13> 13</a>
</span><span class=lnt id=hl-77-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-14> 14</a>
</span><span class=lnt id=hl-77-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-15> 15</a>
</span><span class=lnt id=hl-77-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-16> 16</a>
</span><span class=lnt id=hl-77-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-17> 17</a>
</span><span class=lnt id=hl-77-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-18> 18</a>
</span><span class=lnt id=hl-77-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-19> 19</a>
</span><span class=lnt id=hl-77-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-20> 20</a>
</span><span class=lnt id=hl-77-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-21> 21</a>
</span><span class=lnt id=hl-77-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-22> 22</a>
</span><span class=lnt id=hl-77-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-23> 23</a>
</span><span class=lnt id=hl-77-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-24> 24</a>
</span><span class=lnt id=hl-77-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-25> 25</a>
</span><span class=lnt id=hl-77-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-26> 26</a>
</span><span class=lnt id=hl-77-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-27> 27</a>
</span><span class=lnt id=hl-77-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-28> 28</a>
</span><span class=lnt id=hl-77-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-29> 29</a>
</span><span class=lnt id=hl-77-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-30> 30</a>
</span><span class=lnt id=hl-77-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-31> 31</a>
</span><span class=lnt id=hl-77-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-32> 32</a>
</span><span class=lnt id=hl-77-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-33> 33</a>
</span><span class=lnt id=hl-77-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-34> 34</a>
</span><span class=lnt id=hl-77-35><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-35> 35</a>
</span><span class=lnt id=hl-77-36><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-36> 36</a>
</span><span class=lnt id=hl-77-37><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-37> 37</a>
</span><span class=lnt id=hl-77-38><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-38> 38</a>
</span><span class=lnt id=hl-77-39><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-39> 39</a>
</span><span class=lnt id=hl-77-40><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-40> 40</a>
</span><span class=lnt id=hl-77-41><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-41> 41</a>
</span><span class=lnt id=hl-77-42><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-42> 42</a>
</span><span class=lnt id=hl-77-43><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-43> 43</a>
</span><span class=lnt id=hl-77-44><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-44> 44</a>
</span><span class=lnt id=hl-77-45><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-45> 45</a>
</span><span class=lnt id=hl-77-46><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-46> 46</a>
</span><span class=lnt id=hl-77-47><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-47> 47</a>
</span><span class=lnt id=hl-77-48><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-48> 48</a>
</span><span class=lnt id=hl-77-49><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-49> 49</a>
</span><span class=lnt id=hl-77-50><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-50> 50</a>
</span><span class=lnt id=hl-77-51><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-51> 51</a>
</span><span class=lnt id=hl-77-52><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-52> 52</a>
</span><span class=lnt id=hl-77-53><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-53> 53</a>
</span><span class=lnt id=hl-77-54><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-54> 54</a>
</span><span class=lnt id=hl-77-55><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-55> 55</a>
</span><span class=lnt id=hl-77-56><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-56> 56</a>
</span><span class=lnt id=hl-77-57><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-57> 57</a>
</span><span class=lnt id=hl-77-58><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-58> 58</a>
</span><span class=lnt id=hl-77-59><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-59> 59</a>
</span><span class=lnt id=hl-77-60><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-60> 60</a>
</span><span class=lnt id=hl-77-61><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-61> 61</a>
</span><span class=lnt id=hl-77-62><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-62> 62</a>
</span><span class=lnt id=hl-77-63><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-63> 63</a>
</span><span class=lnt id=hl-77-64><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-64> 64</a>
</span><span class=lnt id=hl-77-65><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-65> 65</a>
</span><span class=lnt id=hl-77-66><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-66> 66</a>
</span><span class=lnt id=hl-77-67><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-67> 67</a>
</span><span class=lnt id=hl-77-68><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-68> 68</a>
</span><span class=lnt id=hl-77-69><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-69> 69</a>
</span><span class=lnt id=hl-77-70><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-70> 70</a>
</span><span class=lnt id=hl-77-71><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-71> 71</a>
</span><span class=lnt id=hl-77-72><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-72> 72</a>
</span><span class=lnt id=hl-77-73><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-73> 73</a>
</span><span class=lnt id=hl-77-74><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-74> 74</a>
</span><span class=lnt id=hl-77-75><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-75> 75</a>
</span><span class=lnt id=hl-77-76><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-76> 76</a>
</span><span class=lnt id=hl-77-77><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-77> 77</a>
</span><span class=lnt id=hl-77-78><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-78> 78</a>
</span><span class=lnt id=hl-77-79><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-79> 79</a>
</span><span class=lnt id=hl-77-80><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-80> 80</a>
</span><span class=lnt id=hl-77-81><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-81> 81</a>
</span><span class=lnt id=hl-77-82><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-82> 82</a>
</span><span class=lnt id=hl-77-83><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-83> 83</a>
</span><span class=lnt id=hl-77-84><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-84> 84</a>
</span><span class=lnt id=hl-77-85><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-85> 85</a>
</span><span class=lnt id=hl-77-86><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-86> 86</a>
</span><span class=lnt id=hl-77-87><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-87> 87</a>
</span><span class=lnt id=hl-77-88><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-88> 88</a>
</span><span class=lnt id=hl-77-89><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-89> 89</a>
</span><span class=lnt id=hl-77-90><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-90> 90</a>
</span><span class=lnt id=hl-77-91><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-91> 91</a>
</span><span class=lnt id=hl-77-92><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-92> 92</a>
</span><span class=lnt id=hl-77-93><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-93> 93</a>
</span><span class=lnt id=hl-77-94><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-94> 94</a>
</span><span class=lnt id=hl-77-95><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-95> 95</a>
</span><span class=lnt id=hl-77-96><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-96> 96</a>
</span><span class=lnt id=hl-77-97><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-97> 97</a>
</span><span class=lnt id=hl-77-98><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-98> 98</a>
</span><span class=lnt id=hl-77-99><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-99> 99</a>
</span><span class=lnt id=hl-77-100><a style=outline:none;text-decoration:none;color:inherit href=#hl-77-100>100</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>AioServer</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>AsynchronousServerSocketChannel</span> <span class=n>ssc</span> <span class=o>=</span> <span class=n>AsynchronousServerSocketChannel</span><span class=o>.</span><span class=na>open</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>ssc</span><span class=o>.</span><span class=na>bind</span><span class=o>(</span><span class=k>new</span> <span class=n>InetSocketAddress</span><span class=o>(</span><span class=n>8080</span><span class=o>));</span>
</span></span><span class=line><span class=cl>        <span class=n>ssc</span><span class=o>.</span><span class=na>accept</span><span class=o>(</span><span class=kc>null</span><span class=o>,</span> <span class=k>new</span> <span class=n>AcceptHandler</span><span class=o>(</span><span class=n>ssc</span><span class=o>));</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>in</span><span class=o>.</span><span class=na>read</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>closeChannel</span><span class=o>(</span><span class=n>AsynchronousSocketChannel</span> <span class=n>sc</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>printf</span><span class=o>(</span><span class=s>&#34;[%s] %s close\n&#34;</span><span class=o>,</span> <span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>getName</span><span class=o>(),</span> <span class=n>sc</span><span class=o>.</span><span class=na>getRemoteAddress</span><span class=o>());</span>
</span></span><span class=line><span class=cl>            <span class=n>sc</span><span class=o>.</span><span class=na>close</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>class</span> <span class=nc>ReadHandler</span> <span class=kd>implements</span> <span class=n>CompletionHandler</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>,</span> <span class=n>ByteBuffer</span><span class=o>&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>private</span> <span class=kd>final</span> <span class=n>AsynchronousSocketChannel</span> <span class=n>sc</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=nf>ReadHandler</span><span class=o>(</span><span class=n>AsynchronousSocketChannel</span> <span class=n>sc</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>this</span><span class=o>.</span><span class=na>sc</span> <span class=o>=</span> <span class=n>sc</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>completed</span><span class=o>(</span><span class=n>Integer</span> <span class=n>result</span><span class=o>,</span> <span class=n>ByteBuffer</span> <span class=n>attachment</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>result</span> <span class=o>==</span> <span class=o>-</span><span class=n>1</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>closeChannel</span><span class=o>(</span><span class=n>sc</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>printf</span><span class=o>(</span><span class=s>&#34;[%s] %s read\n&#34;</span><span class=o>,</span> <span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>getName</span><span class=o>(),</span> <span class=n>sc</span><span class=o>.</span><span class=na>getRemoteAddress</span><span class=o>());</span>
</span></span><span class=line><span class=cl>                <span class=n>attachment</span><span class=o>.</span><span class=na>flip</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>Charset</span><span class=o>.</span><span class=na>defaultCharset</span><span class=o>().</span><span class=na>decode</span><span class=o>(</span><span class=n>attachment</span><span class=o>));</span>
</span></span><span class=line><span class=cl>                <span class=n>attachment</span><span class=o>.</span><span class=na>clear</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 处理完第一个 read 时，需要再次调用 read 方法来处理下一个 read 事件
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>sc</span><span class=o>.</span><span class=na>read</span><span class=o>(</span><span class=n>attachment</span><span class=o>,</span> <span class=n>attachment</span><span class=o>,</span> <span class=k>this</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>failed</span><span class=o>(</span><span class=n>Throwable</span> <span class=n>exc</span><span class=o>,</span> <span class=n>ByteBuffer</span> <span class=n>attachment</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>closeChannel</span><span class=o>(</span><span class=n>sc</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>exc</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>class</span> <span class=nc>WriteHandler</span> <span class=kd>implements</span> <span class=n>CompletionHandler</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>,</span> <span class=n>ByteBuffer</span><span class=o>&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>private</span> <span class=kd>final</span> <span class=n>AsynchronousSocketChannel</span> <span class=n>sc</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kd>private</span> <span class=nf>WriteHandler</span><span class=o>(</span><span class=n>AsynchronousSocketChannel</span> <span class=n>sc</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>this</span><span class=o>.</span><span class=na>sc</span> <span class=o>=</span> <span class=n>sc</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>completed</span><span class=o>(</span><span class=n>Integer</span> <span class=n>result</span><span class=o>,</span> <span class=n>ByteBuffer</span> <span class=n>attachment</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 如果作为附件的 buffer 还有内容，需要再次 write 写出剩余内容
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>if</span> <span class=o>(</span><span class=n>attachment</span><span class=o>.</span><span class=na>hasRemaining</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>sc</span><span class=o>.</span><span class=na>write</span><span class=o>(</span><span class=n>attachment</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>failed</span><span class=o>(</span><span class=n>Throwable</span> <span class=n>exc</span><span class=o>,</span> <span class=n>ByteBuffer</span> <span class=n>attachment</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>exc</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>closeChannel</span><span class=o>(</span><span class=n>sc</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>class</span> <span class=nc>AcceptHandler</span> <span class=kd>implements</span> <span class=n>CompletionHandler</span><span class=o>&lt;</span><span class=n>AsynchronousSocketChannel</span><span class=o>,</span> <span class=n>Object</span><span class=o>&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>private</span> <span class=kd>final</span> <span class=n>AsynchronousServerSocketChannel</span> <span class=n>ssc</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=nf>AcceptHandler</span><span class=o>(</span><span class=n>AsynchronousServerSocketChannel</span> <span class=n>ssc</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>this</span><span class=o>.</span><span class=na>ssc</span> <span class=o>=</span> <span class=n>ssc</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>completed</span><span class=o>(</span><span class=n>AsynchronousSocketChannel</span> <span class=n>sc</span><span class=o>,</span> <span class=n>Object</span> <span class=n>attachment</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>printf</span><span class=o>(</span><span class=s>&#34;[%s] %s connected\n&#34;</span><span class=o>,</span> <span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>getName</span><span class=o>(),</span> <span class=n>sc</span><span class=o>.</span><span class=na>getRemoteAddress</span><span class=o>());</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=n>ByteBuffer</span> <span class=n>buffer</span> <span class=o>=</span> <span class=n>ByteBuffer</span><span class=o>.</span><span class=na>allocate</span><span class=o>(</span><span class=n>16</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 读事件由 ReadHandler 处理
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>sc</span><span class=o>.</span><span class=na>read</span><span class=o>(</span><span class=n>buffer</span><span class=o>,</span> <span class=n>buffer</span><span class=o>,</span> <span class=k>new</span> <span class=n>ReadHandler</span><span class=o>(</span><span class=n>sc</span><span class=o>));</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 写事件由 WriteHandler 处理
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>sc</span><span class=o>.</span><span class=na>write</span><span class=o>(</span><span class=n>Charset</span><span class=o>.</span><span class=na>defaultCharset</span><span class=o>().</span><span class=na>encode</span><span class=o>(</span><span class=s>&#34;server hello!&#34;</span><span class=o>),</span> <span class=n>ByteBuffer</span><span class=o>.</span><span class=na>allocate</span><span class=o>(</span><span class=n>16</span><span class=o>),</span> <span class=k>new</span> <span class=n>WriteHandler</span><span class=o>(</span><span class=n>sc</span><span class=o>));</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 处理完第一个 accpet 时，需要再次调用 accept 方法来处理下一个 accept 事件
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>ssc</span><span class=o>.</span><span class=na>accept</span><span class=o>(</span><span class=kc>null</span><span class=o>,</span> <span class=k>this</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>failed</span><span class=o>(</span><span class=n>Throwable</span> <span class=n>exc</span><span class=o>,</span> <span class=n>Object</span> <span class=n>attachment</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>exc</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div></article><hr><div class=page-end id=footer><div class=backlinks-container><h3>反向链接</h3><ul class=backlinks><li><a href=/2_0_2-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/2_0_2_2_1_0-web%E5%90%8E%E7%AB%AF/Netty/Netty%E5%85%A5%E9%97%A8/ data-ctx=NIO data-src=/2_0_2-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/2_0_2_2_1_0-web%E5%90%8E%E7%AB%AF/Netty/Netty%E5%85%A5%E9%97%A8 class=internal-link>Netty入门</a></li></ul></div><div><script src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>湾区地图</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://harbor.mffseal.top/js/graph.abd4bc2af3869a96524d7d23b76152c7.js></script></div></div><div id=contact_buttons><footer><p>由 mffseal 使用 <a href=https://github.com/jackyzha0/quartz>Quartz</a> 开发, © 2022</p><ul><li><a href=https://harbor.mffseal.top/>港口</a></li><li><a href=https://github.com/mffseal>Github</a></li></ul></footer></div></div></body></html>